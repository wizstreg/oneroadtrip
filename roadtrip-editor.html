<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet de Voyage ‚Äî OneRoadTrip</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            color: #333;
            background: #f5f5f5;
        }

        /* ===========================================
           STYLES √âCRAN (mode √©dition)
           =========================================== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
        }

        /* Toolbar fixe */
        .toolbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #113f7a;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .toolbar-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }
        .toolbar-logo img { height: 36px; }
        .toolbar-title {
            font-weight: 700;
            font-size: 1rem;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .toolbar-spacer { flex: 1; }
        .toolbar-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .toolbar-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .toolbar-btn.primary {
            background: white;
            color: #113f7a;
            border-color: white;
        }
        .toolbar-btn.primary:hover {
            background: #f0f0f0;
        }
        
        /* ===== MOBILE RESPONSIVE ===== */
        
        /* Bouton flottant mobile (cach√© par d√©faut) */
        .mobile-fab {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #113f7a;
            color: white;
            border: none;
            box-shadow: 0 4px 16px rgba(17,63,122,0.4);
            font-size: 1.4rem;
            cursor: pointer;
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .mobile-fab:active {
            transform: scale(0.95);
        }
        
        /* Menu mobile (cach√© par d√©faut) */
        .mobile-menu {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            overflow: hidden;
            z-index: 100;
            min-width: 180px;
        }
        .mobile-menu.open {
            display: block;
            animation: slideUp 0.2s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .mobile-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            border: none;
            background: white;
            color: #113f7a;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .mobile-menu-item:last-child {
            border-bottom: none;
        }
        .mobile-menu-item:active {
            background: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            /* Cacher la toolbar desktop */
            .toolbar {
                display: none !important;
            }
            
            /* Afficher le FAB mobile */
            .mobile-fab {
                display: flex;
            }
            
            /* Container pleine largeur */
            .container {
                padding: 0;
                max-width: 100%;
            }
            
            /* Pages responsive */
            .page {
                border-radius: 0;
                margin: 0 0 8px 0;
                box-shadow: none;
                border-bottom: 1px solid #e5e7eb;
            }
            
            /* Cover page mobile */
            .cover-page {
                min-height: auto;
            }
            .cover-hero {
                height: 50vh;
                min-height: 280px;
            }
            .cover-title {
                font-size: 1.6rem !important;
                padding: 0 16px;
            }
            .cover-stats {
                padding: 16px;
                gap: 20px;
            }
            .stat-number {
                font-size: 2rem;
            }
            
            /* Summary page mobile */
            .summary-page {
                padding: 20px 16px;
            }
            .steps-list {
                columns: 1;
            }
            
            /* Boutons carrousel adapt√©s mobile */
            .carousel-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            /* Cacher les boutons d'ajout sur mobile */
            .add-item-btn {
                display: none;
            }
        }
        
        /* ===== MOBILE PORTRAIT : Layout vertical ===== */
        @media (max-width: 768px) and (orientation: portrait) {
            .step-page {
                flex-direction: column;
                min-height: auto;
            }
            .step-photo {
                width: 100% !important;
                height: 35vh;
                min-height: 200px;
            }
            .step-content {
                width: 100% !important;
                padding: 16px;
            }
            .step-title {
                font-size: 1.4rem;
            }
            .day-badge {
                font-size: 12px;
            }
            .section-title {
                font-size: 1rem;
            }
            .section-items li {
                font-size: 0.95rem;
            }
        }
        
        /* ===== MOBILE PAYSAGE : Layout horizontal ===== */
        @media (max-width: 900px) and (orientation: landscape) {
            .step-page {
                flex-direction: row;
                min-height: auto;
            }
            .step-photo {
                width: 40%;
                min-width: 150px;
                height: auto;
                min-height: 180px;
            }
            .step-content {
                width: 60%;
                padding: 14px;
            }
            .step-title {
                font-size: 1.1rem;
            }
            .day-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
            .section-title {
                font-size: 0.85rem;
            }
            .section-items li {
                font-size: 0.85rem;
                padding: 3px 0;
            }
            .next-step-info {
                font-size: 0.8rem;
                padding: 8px;
            }
            
            /* Cover en paysage */
            .cover-hero {
                height: 60vh;
            }
            .cover-stats {
                padding: 12px;
            }
            .stat-number {
                font-size: 1.8rem;
            }
        }
        
        /* ===== TR√àS PETIT √âCRAN (portrait) ===== */
        @media (max-width: 400px) and (orientation: portrait) {
            .cover-hero {
                height: 35vh;
                min-height: 180px;
            }
            .cover-title {
                font-size: 1.2rem !important;
            }
            .step-photo {
                height: 30vh;
                min-height: 150px;
            }
            .step-content {
                padding: 12px;
            }
            .step-title {
                font-size: 1.1rem;
            }
            .section-items li {
                font-size: 0.8rem;
            }
            .stat-number {
                font-size: 1.5rem;
            }
        }

        /* Boutons d'√©dition */
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .carousel-btn:hover { background: white; }
        .carousel-btn.prev { left: 12px; }
        .carousel-btn.next { right: 12px; }
        
        .photo-counter {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 10;
        }

        .add-item-btn {
            border: 1px dashed #ccc;
            background: transparent;
            color: #666;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 8px;
            width: 100%;
            transition: all 0.2s;
        }
        .add-item-btn:hover {
            border-color: #113f7a;
            color: #113f7a;
            background: rgba(17,63,122,0.05);
        }

        /* Structure des pages pour l'√©cran */
        .page {
            background: white;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* Page de couverture */
        .cover-page {
            text-align: center;
            position: relative;
        }

        .cover-hero {
            position: relative;
            height: 400px;
            overflow: hidden;
            background: #1a1a2e;
        }
        .cover-hero img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .cover-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        }
        .cover-title-box {
            position: absolute;
            bottom: 30px;
            left: 30px;
            right: 30px;
            text-align: left;
            color: white;
        }
        .cover-title {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .cover-subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .cover-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            padding: 25px;
            background: #f8f9fa;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #113f7a;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        /* Page r√©sum√© */
        .summary-page {
            padding: 30px;
        }

        .summary-title {
            font-size: 1.6em;
            font-weight: bold;
            color: #113f7a;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #113f7a;
        }

        .steps-list {
            list-style: none;
            columns: 2;
            column-gap: 30px;
        }

        .steps-list li {
            margin-bottom: 12px;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .step-summary {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-marker {
            width: 36px;
            height: 36px;
            background: #113f7a;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .step-summary-content {
            flex: 1;
        }

        .step-name {
            font-weight: 600;
            color: #333;
        }

        .step-nights {
            font-size: 0.85em;
            color: #666;
        }

        .step-distance {
            font-size: 0.8em;
            color: #888;
        }

        /* Page r√©servations */
        .bookings-page {
            padding: 30px;
        }
        .bookings-title {
            font-size: 1.6em;
            font-weight: bold;
            color: #113f7a;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #113f7a;
        }
        .bookings-section {
            margin-bottom: 24px;
        }
        .bookings-section-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #113f7a;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .booking-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
        }
        .booking-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .booking-icon {
            font-size: 1.5rem;
        }
        .booking-name {
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }
        .booking-price {
            font-weight: 700;
            color: #16a34a;
        }
        .booking-details {
            font-size: 0.85rem;
            color: #6b7280;
            margin-left: 36px;
        }
        .booking-details div {
            margin-bottom: 2px;
        }
        .flight-segment {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .flight-segment-header {
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 6px;
        }
        .flight-segment-header.return {
            color: #dc2626;
        }
        .flight-route {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        .flight-times {
            font-size: 0.8rem;
            color: #6b7280;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .car-rental-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .car-rental-location {
            background: #fff;
            border-radius: 8px;
            padding: 10px;
        }
        .car-rental-location.pickup {
            border: 2px solid #16a34a;
        }
        .car-rental-location.dropoff {
            border: 2px solid #dc2626;
        }
        .car-rental-label {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .car-rental-label.pickup { color: #16a34a; }
        .car-rental-label.dropoff { color: #dc2626; }
        .budget-total {
            background: linear-gradient(135deg, #113f7a 0%, #1e5090 100%);
            color: white;
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            margin-top: 20px;
        }
        .budget-total-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .budget-total-amount {
            font-size: 1.8rem;
            font-weight: 700;
        }
        /* R√©sa dans √©tape */
        .step-booking {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 10px;
            margin-top: 12px;
            font-size: 0.85rem;
        }
        .step-booking-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
        }

        /* Pages √©tapes */
        .step-page {
            display: flex;
            min-height: 500px;
        }

        .step-photo {
            width: 50%;
            min-height: 500px;
            position: relative;
            overflow: hidden;
            background: #eee;
        }

        .step-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .step-no-photo {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #ccc;
            background: #f0f0f0;
        }

        .step-content {
            width: 50%;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .day-badge {
            display: inline-block;
            background: #113f7a;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 15px;
        }

        .step-title {
            font-size: 1.6em;
            font-weight: bold;
            color: #113f7a;
            margin-bottom: 20px;
        }

        .section-block {
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: 600;
            color: #113f7a;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .section-items {
            list-style: none;
            padding: 0;
        }

        .section-items li {
            padding: 6px 0 6px 20px;
            position: relative;
            font-size: 0.95em;
        }

        .section-items li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 5px;
            color: #113f7a;
        }

        .next-step-info {
            margin-top: auto;
            padding: 12px 15px;
            background: #f8f9fa;
            border-left: 4px solid #113f7a;
            font-size: 0.9em;
        }

        /* ===== PAGINATION MULTI-PAGES PAR √âTAPE ===== */
        .page-number-badge {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(17,63,122,0.85);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            z-index: 10;
        }
        
        /* Page de continuation (suite du contenu) */
        .step-page.continuation-page {
            flex-direction: column;
        }
        
        .continuation-page .step-photo {
            width: 100%;
            height: 80px;
            min-height: 80px;
        }
        
        .continuation-page .step-content {
            width: 100%;
            flex: 1;
            padding: 20px 30px;
        }
        
        .continuation-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #113f7a;
        }
        
        .continuation-header .day-badge {
            margin-bottom: 0;
        }
        
        .continuation-header .step-title {
            margin-bottom: 0;
            font-size: 1.3em;
        }
        
        /* Sections en colonnes sur les pages de continuation */
        .continuation-page .sections-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .continuation-page .section-block {
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        .loading-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Modal de partage */
        .share-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .share-modal {
            background: linear-gradient(135deg, #113f7a 0%, #1a5298 100%);
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .share-modal-header {
            background: url('/assets/image_index.webp') center/cover;
            padding: 30px 25px;
            position: relative;
        }
        .share-modal-header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(17,63,122,0.85), rgba(17,63,122,0.7));
        }
        .share-modal-header h3 {
            position: relative;
            color: white;
            margin: 0;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .share-modal-body {
            padding: 25px;
            background: white;
        }
        .share-link-box {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        .share-link-input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 13px;
            color: #334155;
            background: #f8fafc;
        }
        .share-link-input:focus {
            outline: none;
            border-color: #113f7a;
        }
        .share-copy-btn {
            padding: 12px 20px;
            background: #113f7a;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .share-copy-btn:hover {
            background: #0d2f5c;
        }
        .share-copy-btn.copied {
            background: #16a34a;
        }
        .share-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 10px;
            padding: 14px;
            font-size: 13px;
            color: #92400e;
            line-height: 1.5;
        }
        .share-modal-footer {
            padding: 16px 25px;
            background: #f8fafc;
            text-align: right;
        }
        .share-close-btn {
            padding: 10px 24px;
            background: transparent;
            color: #64748b;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .share-close-btn:hover {
            background: #f1f5f9;
            color: #334155;
        }

        /* ===========================================
           STYLES IMPRESSION (A4 paysage)
           =========================================== */
        @page {
            size: A4 landscape;
            margin: 0;
        }

        @media print {
            /* Masquer √©l√©ments non imprimables */
            .toolbar,
            .carousel-btn,
            .photo-counter,
            .add-item-btn,
            .share-modal-overlay,
            .no-print {
                display: none !important;
            }

            /* Reset body */
            html, body {
                width: 297mm;
                height: 210mm;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .container {
                max-width: none !important;
                width: 297mm !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            /* ===========================================
               CHAQUE PAGE = UNE FEUILLE A4 PAYSAGE
               =========================================== */
            .page {
                width: 297mm !important;
                height: 210mm !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                page-break-after: always !important;
                page-break-inside: avoid !important;
            }
            .page:last-child {
                page-break-after: auto !important;
            }

            /* ===========================================
               PAGE COUVERTURE
               =========================================== */
            .cover-page {
                display: flex !important;
                flex-direction: column !important;
                width: 297mm !important;
                height: 210mm !important;
            }

            .cover-hero {
                flex: 1 !important;
                width: 100% !important;
                min-height: 0 !important;
                position: relative !important;
            }

            .cover-hero img {
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
            }

            .cover-title-box {
                position: absolute !important;
                bottom: 20px !important;
                left: 25px !important;
                right: 25px !important;
            }

            .cover-title {
                font-size: 28pt !important;
                line-height: 1.2 !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 100% !important;
            }

            .cover-subtitle {
                font-size: 14pt !important;
            }

            .cover-stats {
                flex-shrink: 0 !important;
                height: 25mm !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                gap: 50px !important;
                background: #f8f9fa !important;
                padding: 0 !important;
            }

            .stat-item {
                text-align: center !important;
            }

            .stat-number {
                font-size: 24pt !important;
                font-weight: bold !important;
                color: #113f7a !important;
            }

            .stat-label {
                font-size: 10pt !important;
                color: #666 !important;
            }

            /* ===========================================
               PAGE R√âSUM√â
               =========================================== */
            .summary-page {
                width: 297mm !important;
                height: 210mm !important;
                padding: 15mm 20mm !important;
            }

            .summary-title {
                font-size: 18pt !important;
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
            }

            .steps-list {
                columns: 2 !important;
                column-gap: 20mm !important;
            }

            .steps-list li {
                margin-bottom: 8px !important;
                font-size: 10pt !important;
            }

            .step-marker {
                width: 28px !important;
                height: 28px !important;
                font-size: 9pt !important;
                background: #113f7a !important;
                color: white !important;
            }

            .step-name {
                font-size: 12pt !important;
            }

            .step-nights {
                font-size: 10pt !important;
            }

            .step-distance {
                font-size: 10pt !important;
            }

            /* ===========================================
               PAGE R√âSERVATIONS
               =========================================== */
            .bookings-page {
                width: 297mm !important;
                height: 210mm !important;
                padding: 12mm 15mm !important;
                overflow: hidden !important;
            }
            
            .bookings-title {
                font-size: 16pt !important;
                margin-bottom: 10px !important;
                padding-bottom: 8px !important;
            }
            
            .bookings-section {
                margin-bottom: 12px !important;
            }
            
            .bookings-section-title {
                font-size: 11pt !important;
                margin-bottom: 6px !important;
            }
            
            .booking-card {
                padding: 8px !important;
                margin-bottom: 6px !important;
                page-break-inside: avoid !important;
            }
            
            .booking-card-header {
                margin-bottom: 4px !important;
            }
            
            .booking-icon {
                font-size: 1.2rem !important;
            }
            
            .booking-name {
                font-size: 10pt !important;
            }
            
            .booking-price {
                font-size: 10pt !important;
            }
            
            .flight-segment {
                padding: 6px !important;
                margin-bottom: 4px !important;
            }
            
            .flight-route {
                font-size: 9pt !important;
            }
            
            .flight-times {
                font-size: 8pt !important;
            }
            
            .car-rental-box {
                gap: 8px !important;
            }
            
            .car-rental-location {
                padding: 6px !important;
                font-size: 9pt !important;
            }
            
            .budget-total {
                padding: 10px !important;
                margin-top: 12px !important;
            }
            
            .budget-total-label {
                font-size: 9pt !important;
            }
            
            .budget-total-amount {
                font-size: 14pt !important;
            }
            
            .step-booking {
                padding: 6px !important;
                margin-top: 8px !important;
                font-size: 9pt !important;
            }

            /* ===========================================
               PAGES √âTAPES - PHOTO GAUCHE / TEXTE DROITE
               =========================================== */
            .step-page {
                width: 297mm !important;
                height: 210mm !important;
                display: flex !important;
                flex-direction: row !important;
                overflow: hidden !important;
            }

            .step-photo {
                width: 148.5mm !important;
                height: 210mm !important;
                flex: none !important;
                overflow: hidden !important;
            }

            .step-photo img {
                width: 148.5mm !important;
                height: 210mm !important;
                object-fit: cover !important;
            }

            .step-no-photo {
                width: 148.5mm !important;
                height: 210mm !important;
            }

            .step-content {
                width: 148.5mm !important;
                height: 210mm !important;
                flex: none !important;
                padding: 12mm 15mm !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
            }

            .day-badge {
                font-size: 10pt !important;
                padding: 4px 10px !important;
                margin-bottom: 8px !important;
                background: rgba(17,63,122,0.1) !important;
                color: #113f7a !important;
            }

            .step-title {
                font-size: 18pt !important;
                margin-bottom: 12px !important;
                color: #113f7a !important;
                line-height: 1.2 !important;
            }

            .section-block {
                margin-bottom: 10px !important;
                flex-shrink: 0 !important;
            }

            .section-title {
                font-size: 10pt !important;
                margin-bottom: 6px !important;
                color: #113f7a !important;
            }

            .section-items {
                margin: 0 !important;
                padding: 0 !important;
            }

            .section-items li {
                font-size: 9pt !important;
                line-height: 1.35 !important;
                padding: 2px 0 2px 14px !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: block !important;
            }

            .section-items li:before {
                font-size: 9pt !important;
            }

            .next-step-info {
                margin-top: auto !important;
                padding: 8px 12px !important;
                font-size: 9pt !important;
                background: #f8f9fa !important;
                border-left: 3px solid #113f7a !important;
                flex-shrink: 0 !important;
            }

            /* ===========================================
               PAGINATION MULTI-PAGES PAR √âTAPE
               =========================================== */
            .page-number-badge {
                position: absolute !important;
                bottom: 8mm !important;
                right: 10mm !important;
                background: rgba(17,63,122,0.9) !important;
                color: white !important;
                padding: 3px 10px !important;
                border-radius: 15px !important;
                font-size: 9pt !important;
                font-weight: 600 !important;
                z-index: 100 !important;
            }
            
            /* Page de continuation */
            .step-page.continuation-page {
                flex-direction: column !important;
            }
            
            .continuation-page .step-photo {
                width: 297mm !important;
                height: 35mm !important;
                min-height: 35mm !important;
                flex: none !important;
            }
            
            .continuation-page .step-photo img {
                width: 297mm !important;
                height: 35mm !important;
                object-fit: cover !important;
                object-position: center 30% !important;
            }
            
            .continuation-page .step-content {
                width: 297mm !important;
                height: 175mm !important;
                flex: none !important;
                padding: 10mm 15mm !important;
            }
            
            .continuation-header {
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                margin-bottom: 10px !important;
                padding-bottom: 8px !important;
                border-bottom: 2px solid #113f7a !important;
            }
            
            .continuation-header .day-badge {
                margin-bottom: 0 !important;
            }
            
            .continuation-header .step-title {
                margin-bottom: 0 !important;
                font-size: 14pt !important;
            }
            
            .continuation-page .sections-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 15mm !important;
            }
            
            .continuation-page .section-block {
                margin-bottom: 8px !important;
            }
            
            .continuation-page .section-items li {
                font-size: 9pt !important;
                line-height: 1.4 !important;
                padding: 3px 0 3px 14px !important;
            }

            /* Emp√™cher coupures */
            * {
                page-break-inside: avoid !important;
            }
        }
        
        /* ===========================================
           STYLES INFOS PRATIQUES (format enrichi)
           =========================================== */
        
        /* Encart infos pratiques en page r√©sum√© */
        .practical-context-box {
            background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
            border: 1px solid #b8d4f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
        }
        .practical-context-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #0d3a6e;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #b8d4f0;
            padding-bottom: 10px;
        }
        .practical-context-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .practical-context-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .practical-context-label {
            font-size: 0.8em;
            color: #5a7a9a;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .practical-context-value {
            font-size: 0.95em;
            color: #333;
        }
        .highlights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .highlights-list li {
            padding: 4px 0 4px 20px;
            position: relative;
            font-size: 0.9em;
        }
        .highlights-list li:before {
            content: "‚ú®";
            position: absolute;
            left: 0;
        }
        
        /* Practical info sous les activit√©s */
        .activity-practical-info {
            background: #f8f9fa;
            border-left: 3px solid #113f7a;
            padding: 6px 10px;
            margin-top: 4px;
            font-size: 0.8em;
            color: #555;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .activity-practical-info span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Road type badge dans les trajets */
        .road-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            color: #495057;
            margin-left: 6px;
        }
        .road-type-badge.gravel {
            background: #fff3cd;
            color: #856404;
        }
        .road-type-badge.track {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Mobile responsive infos pratiques */
        @media (max-width: 768px) {
            .practical-context-grid {
                grid-template-columns: 1fr;
            }
            .practical-context-box {
                padding: 15px;
            }
            .activity-practical-info {
                font-size: 0.75em;
            }
        }
        
        /* Print styles infos pratiques */
        @media print {
            .practical-context-box {
                padding: 10mm !important;
                margin-top: 15px !important;
                page-break-inside: avoid !important;
            }
            .practical-context-title {
                font-size: 12pt !important;
            }
            .practical-context-grid {
                gap: 10px !important;
            }
            .practical-context-value,
            .highlights-list li {
                font-size: 9pt !important;
            }
            .activity-practical-info {
                font-size: 8pt !important;
                padding: 4px 8px !important;
                margin-top: 2px !important;
            }
            .road-type-badge {
                font-size: 8pt !important;
                padding: 1px 6px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Toolbar (cach√©e √† l'impression) -->
    <div class="toolbar no-print">
        <a href="/" class="toolbar-logo">
            <img src="/assets/symbol.webp" alt="ORT">
        </a>
        <span class="toolbar-title" id="toolbarTitle">Mon carnet de voyage</span>
        <div class="toolbar-spacer"></div>
        <button class="toolbar-btn" id="btnClose">‚úï Fermer</button>
        <button class="toolbar-btn" id="btnCopyLink">üîó Copier le lien</button>
        <button class="toolbar-btn" id="btnModify">‚úèÔ∏è Modifier</button>
        <button class="toolbar-btn primary" id="btnPrint">üñ®Ô∏è Imprimer / PDF</button>
    </div>
    
    <!-- Mobile FAB et menu -->
    <button class="mobile-fab" id="mobileFab">‚ò∞</button>
    <div class="mobile-menu" id="mobileMenu">
        <button class="mobile-menu-item" id="mobileModify">‚úèÔ∏è <span data-mobile-i18n="modify">Modifier</span></button>
        <button class="mobile-menu-item" id="mobileCopyLink">üîó <span data-mobile-i18n="copyLink">Copier le lien</span></button>
        <button class="mobile-menu-item" id="mobilePrint">üñ®Ô∏è <span data-mobile-i18n="printPdf">Imprimer / PDF</span></button>
        <button class="mobile-menu-item" id="mobileClose">‚úï <span data-mobile-i18n="close">Fermer</span></button>
    </div>

    <div class="container" id="container">
        <div class="loading">
            <div class="loading-icon">‚è≥</div>
            <div>Chargement du carnet...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="/js/ort-config.js"></script>
    <script src="/js/ort-tripid.js"></script>
    <script src="/js/ort-state-manager.js"></script>
    <script src="/js/ort-trip-data.js"></script>
    <script>
    // Init Firebase for PDF editor
    (function(){
      const host = location.hostname;
      const isPreprod = /oneroadtrip-preprod|localhost|127\.0\.0\.1|0\.0\.0\.0/.test(host);
      const cfg = isPreprod ? (window.ORT_CONFIG?.PREPROD || {}) : (window.ORT_CONFIG?.PROD || {});
      const safe = (cfg && cfg.apiKey) ? cfg : (window.ORT_CONFIG?.PREPROD || {});
      if (safe && safe.apiKey && !firebase.apps.length) {
        firebase.initializeApp(safe);
        console.log('[CARNET] Firebase initialis√©');
      }
    })();
    </script>
    <!-- Share module - DOIT √™tre charg√© t√¥t pour checkSharedAccess -->
    <script src="./js/ort-share.js"></script>
    <script>
    (function() {
        'use strict';
        
        let tripData = null;
        let tripId = null;
        let urlParams = null;
        let photosCache = {};
        let LANG = 'fr';
        
        // ===== TRADUCTIONS I18N (6 langues) =====
        const I18N = {
            fr: {
                myTravelBook: "Mon carnet de voyage",
                close: "Fermer",
                copyLink: "Copier le lien",
                linkCopied: "Lien copi√© !",
                modify: "Modifier",
                printPdf: "Imprimer / PDF",
                preparing: "Pr√©paration...",
                loading: "Chargement du carnet...",
                noData: "Aucune donn√©e de voyage trouv√©e.",
                backHome: "Retour √† l'accueil",
                days: "Jours",
                steps: "√âtapes",
                km: "km",
                itinerary: "Itin√©raire",
                night: "nuit",
                nights: "nuits",
                day: "Jour",
                toDiscover: "√Ä d√©couvrir",
                activities: "Activit√©s",
                addPlace: "+ Ajouter un lieu",
                addActivity: "+ Ajouter une activit√©",
                cannotShare: "Ce carnet ne peut pas √™tre partag√© via lien.",
                cannotModify: "Ce carnet ne peut pas √™tre modifi√©.",
                shareLink: "Partager ce carnet",
                copyToClipboard: "Copier",
                shareWarning: "‚ö†Ô∏è Si vous n'avez pas sauvegard√© votre voyage dans le dashboard, le destinataire ne verra pas vos modifications.",
                copied: "Copi√© !",
                // R√©servations
                bookings: "R√©servations",
                travelBookings: "R√©servations voyage",
                flights: "Vols",
                outbound: "ALLER",
                returnFlight: "RETOUR",
                carRental: "Location voiture",
                pickup: "Prise en charge",
                dropoff: "Restitution",
                insurance: "Assurance",
                totalBudget: "Budget total",
                hotel: "H√©bergement",
                duration: "Dur√©e",
                ref: "R√©f",
                continued: "suite",
                nextPage: "Suite page suivante...",
                // Infos pratiques (format enrichi)
                practicalInfo: "Infos pratiques",
                bestPeriod: "Meilleure p√©riode",
                highlights: "Points forts",
                piDistance: "Distance",
                piDuration: "Dur√©e",
                piDifficulty: "Difficult√©",
                piFacilities: "√âquipements",
                piType: "Type",
                piTip: "Conseil",
                roadType: "Route",
                roadTarmac: "Goudron",
                roadGravel: "Gravel",
                roadTrack: "Piste"
            },
            en: {
                myTravelBook: "My travel book",
                close: "Close",
                copyLink: "Copy link",
                linkCopied: "Link copied!",
                modify: "Modify",
                printPdf: "Print / PDF",
                preparing: "Preparing...",
                loading: "Loading travel book...",
                noData: "No travel data found.",
                backHome: "Back to home",
                days: "Days",
                steps: "Steps",
                km: "km",
                itinerary: "Itinerary",
                night: "night",
                nights: "nights",
                day: "Day",
                toDiscover: "To discover",
                activities: "Activities",
                addPlace: "+ Add a place",
                addActivity: "+ Add an activity",
                cannotShare: "This book cannot be shared via link.",
                cannotModify: "This book cannot be modified.",
                shareLink: "Share this travel book",
                copyToClipboard: "Copy",
                shareWarning: "‚ö†Ô∏è If you haven't saved your trip to the dashboard, the recipient won't see your changes.",
                copied: "Copied!",
                bookings: "Bookings",
                travelBookings: "Travel bookings",
                flights: "Flights",
                outbound: "OUTBOUND",
                returnFlight: "RETURN",
                carRental: "Car rental",
                pickup: "Pickup",
                dropoff: "Dropoff",
                insurance: "Insurance",
                totalBudget: "Total budget",
                hotel: "Accommodation",
                duration: "Duration",
                ref: "Ref",
                continued: "continued",
                nextPage: "Continued on next page...",
                // Practical info (enriched format)
                practicalInfo: "Practical info",
                bestPeriod: "Best time",
                highlights: "Highlights",
                piDistance: "Distance",
                piDuration: "Duration",
                piDifficulty: "Difficulty",
                piFacilities: "Facilities",
                piType: "Type",
                piTip: "Tip",
                roadType: "Road",
                roadTarmac: "Tarmac",
                roadGravel: "Gravel",
                roadTrack: "Track"
            },
            es: {
                myTravelBook: "Mi cuaderno de viaje",
                close: "Cerrar",
                copyLink: "Copiar enlace",
                linkCopied: "¬°Enlace copiado!",
                modify: "Modificar",
                printPdf: "Imprimir / PDF",
                preparing: "Preparando...",
                loading: "Cargando cuaderno de viaje...",
                noData: "No se encontraron datos del viaje.",
                backHome: "Volver al inicio",
                days: "D√≠as",
                steps: "Etapas",
                km: "km",
                itinerary: "Itinerario",
                night: "noche",
                nights: "noches",
                day: "D√≠a",
                toDiscover: "Por descubrir",
                activities: "Actividades",
                addPlace: "+ A√±adir un lugar",
                addActivity: "+ A√±adir una actividad",
                cannotShare: "Este cuaderno no se puede compartir por enlace.",
                cannotModify: "Este cuaderno no se puede modificar.",
                shareLink: "Compartir este cuaderno",
                copyToClipboard: "Copiar",
                shareWarning: "‚ö†Ô∏è Si no has guardado tu viaje en el dashboard, el destinatario no ver√° tus cambios.",
                copied: "¬°Copiado!",
                bookings: "Reservas",
                travelBookings: "Reservas de viaje",
                flights: "Vuelos",
                outbound: "IDA",
                returnFlight: "VUELTA",
                carRental: "Alquiler de coche",
                pickup: "Recogida",
                dropoff: "Devoluci√≥n",
                insurance: "Seguro",
                totalBudget: "Presupuesto total",
                hotel: "Alojamiento",
                duration: "Duraci√≥n",
                ref: "Ref",
                continued: "continuaci√≥n",
                nextPage: "Contin√∫a en la siguiente p√°gina...",
                // Infos pr√°cticas (formato enriquecido)
                practicalInfo: "Info pr√°ctica",
                bestPeriod: "Mejor √©poca",
                highlights: "Puntos fuertes",
                piDistance: "Distancia",
                piDuration: "Duraci√≥n",
                piDifficulty: "Dificultad",
                piFacilities: "Instalaciones",
                piType: "Tipo",
                piTip: "Consejo",
                roadType: "Carretera",
                roadTarmac: "Asfalto",
                roadGravel: "Grava",
                roadTrack: "Pista"
            },
            it: {
                myTravelBook: "Il mio diario di viaggio",
                close: "Chiudi",
                copyLink: "Copia link",
                linkCopied: "Link copiato!",
                modify: "Modifica",
                printPdf: "Stampa / PDF",
                preparing: "Preparazione...",
                loading: "Caricamento diario di viaggio...",
                noData: "Nessun dato di viaggio trovato.",
                backHome: "Torna alla home",
                days: "Giorni",
                steps: "Tappe",
                km: "km",
                itinerary: "Itinerario",
                night: "notte",
                nights: "notti",
                day: "Giorno",
                toDiscover: "Da scoprire",
                activities: "Attivit√†",
                addPlace: "+ Aggiungi un luogo",
                addActivity: "+ Aggiungi un'attivit√†",
                cannotShare: "Questo diario non pu√≤ essere condiviso tramite link.",
                cannotModify: "Questo diario non pu√≤ essere modificato.",
                shareLink: "Condividi questo diario",
                copyToClipboard: "Copia",
                shareWarning: "‚ö†Ô∏è Se non hai salvato il viaggio nella dashboard, il destinatario non vedr√† le tue modifiche.",
                copied: "Copiato!",
                bookings: "Prenotazioni",
                travelBookings: "Prenotazioni viaggio",
                flights: "Voli",
                outbound: "ANDATA",
                returnFlight: "RITORNO",
                carRental: "Noleggio auto",
                pickup: "Ritiro",
                dropoff: "Riconsegna",
                insurance: "Assicurazione",
                totalBudget: "Budget totale",
                hotel: "Alloggio",
                duration: "Durata",
                ref: "Rif",
                continued: "continua",
                nextPage: "Continua nella pagina successiva...",
                // Info pratiche (formato arricchito)
                practicalInfo: "Info pratiche",
                bestPeriod: "Periodo migliore",
                highlights: "Punti forti",
                piDistance: "Distanza",
                piDuration: "Durata",
                piDifficulty: "Difficolt√†",
                piFacilities: "Servizi",
                piType: "Tipo",
                piTip: "Consiglio",
                roadType: "Strada",
                roadTarmac: "Asfalto",
                roadGravel: "Sterrato",
                roadTrack: "Pista"
            },
            pt: {
                myTravelBook: "Meu di√°rio de viagem",
                close: "Fechar",
                copyLink: "Copiar link",
                linkCopied: "Link copiado!",
                modify: "Modificar",
                printPdf: "Imprimir / PDF",
                preparing: "Preparando...",
                loading: "Carregando di√°rio de viagem...",
                noData: "Nenhum dado de viagem encontrado.",
                backHome: "Voltar ao in√≠cio",
                days: "Dias",
                steps: "Etapas",
                km: "km",
                itinerary: "Itiner√°rio",
                night: "noite",
                nights: "noites",
                day: "Dia",
                toDiscover: "Para descobrir",
                activities: "Atividades",
                addPlace: "+ Adicionar um lugar",
                addActivity: "+ Adicionar uma atividade",
                cannotShare: "Este di√°rio n√£o pode ser compartilhado por link.",
                cannotModify: "Este di√°rio n√£o pode ser modificado.",
                shareLink: "Compartilhar este di√°rio",
                copyToClipboard: "Copiar",
                shareWarning: "‚ö†Ô∏è Se voc√™ n√£o salvou sua viagem no dashboard, o destinat√°rio n√£o ver√° suas altera√ß√µes.",
                copied: "Copiado!",
                bookings: "Reservas",
                travelBookings: "Reservas de viagem",
                flights: "Voos",
                outbound: "IDA",
                returnFlight: "VOLTA",
                carRental: "Aluguel de carro",
                pickup: "Retirada",
                dropoff: "Devolu√ß√£o",
                insurance: "Seguro",
                totalBudget: "Or√ßamento total",
                hotel: "Hospedagem",
                duration: "Dura√ß√£o",
                ref: "Ref",
                continued: "continua√ß√£o",
                nextPage: "Continua na pr√≥xima p√°gina...",
                // Infos pr√°ticas (formato enriquecido)
                practicalInfo: "Info pr√°tica",
                bestPeriod: "Melhor √©poca",
                highlights: "Destaques",
                piDistance: "Dist√¢ncia",
                piDuration: "Dura√ß√£o",
                piDifficulty: "Dificuldade",
                piFacilities: "Instala√ß√µes",
                piType: "Tipo",
                piTip: "Dica",
                roadType: "Estrada",
                roadTarmac: "Asfalto",
                roadGravel: "Cascalho",
                roadTrack: "Trilha"
            },
            ar: {
                myTravelBook: "ÿØŸÅÿ™ÿ± ÿ≥ŸÅÿ±Ÿä",
                close: "ÿ•ÿ∫ŸÑÿßŸÇ",
                copyLink: "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
                linkCopied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑!",
                modify: "ÿ™ÿπÿØŸäŸÑ",
                printPdf: "ÿ∑ÿ®ÿßÿπÿ© / PDF",
                preparing: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±...",
                loading: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿØŸÅÿ™ÿ± ÿßŸÑÿ≥ŸÅÿ±...",
                noData: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ŸÅÿ±.",
                backHome: "ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
                days: "ÿ£ŸäÿßŸÖ",
                steps: "ŸÖÿ±ÿßÿ≠ŸÑ",
                km: "ŸÉŸÖ",
                itinerary: "ÿÆÿ∑ ÿßŸÑÿ≥Ÿäÿ±",
                night: "ŸÑŸäŸÑÿ©",
                nights: "ŸÑŸäÿßŸÑŸä",
                day: "ÿßŸÑŸäŸàŸÖ",
                toDiscover: "ŸÑŸÑÿßŸÉÿ™ÿ¥ÿßŸÅ",
                activities: "ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©",
                addPlace: "+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÉÿßŸÜ",
                addActivity: "+ ÿ•ÿ∂ÿßŸÅÿ© ŸÜÿ¥ÿßÿ∑",
                cannotShare: "ŸÑÿß ŸäŸÖŸÉŸÜ ŸÖÿ¥ÿßÿ±ŸÉÿ© Ÿáÿ∞ÿß ÿßŸÑÿØŸÅÿ™ÿ± ÿπÿ®ÿ± ÿßŸÑÿ±ÿßÿ®ÿ∑.",
                cannotModify: "ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿπÿØŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿØŸÅÿ™ÿ±.",
                shareLink: "ŸÖÿ¥ÿßÿ±ŸÉÿ© Ÿáÿ∞ÿß ÿßŸÑÿØŸÅÿ™ÿ±",
                copyToClipboard: "ŸÜÿ≥ÿÆ",
                shareWarning: "‚ö†Ô∏è ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ÿ≠ŸÅÿ∏ ÿ±ÿ≠ŸÑÿ™ŸÉ ŸÅŸä ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖÿå ŸÅŸÑŸÜ Ÿäÿ±Ÿâ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ ÿ™ÿπÿØŸäŸÑÿßÿ™ŸÉ.",
                copied: "ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!",
                bookings: "ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™",
                travelBookings: "ÿ≠ÿ¨Ÿàÿ≤ÿßÿ™ ÿßŸÑÿ≥ŸÅÿ±",
                flights: "ÿßŸÑÿ±ÿ≠ŸÑÿßÿ™",
                outbound: "ÿ∞Ÿáÿßÿ®",
                returnFlight: "ÿπŸàÿØÿ©",
                carRental: "ÿ™ÿ£ÿ¨Ÿäÿ± ÿ≥Ÿäÿßÿ±ÿ©",
                pickup: "ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ",
                dropoff: "ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ",
                insurance: "ÿßŸÑÿ™ÿ£ŸÖŸäŸÜ",
                totalBudget: "ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©",
                hotel: "ÿßŸÑÿ•ŸÇÿßŸÖÿ©",
                duration: "ÿßŸÑŸÖÿØÿ©",
                ref: "ÿßŸÑŸÖÿ±ÿ¨ÿπ",
                continued: "ÿ™ÿ™ŸÖÿ©",
                nextPage: "Ÿäÿ™ÿ®ÿπ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©...",
                // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπŸÖŸÑŸäÿ© (ÿ™ŸÜÿ≥ŸäŸÇ ŸÖÿ≠ÿ≥ŸëŸÜ)
                practicalInfo: "ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπŸÖŸÑŸäÿ©",
                bestPeriod: "ÿ£ŸÅÿ∂ŸÑ ŸàŸÇÿ™",
                highlights: "ÿ£ÿ®ÿ±ÿ≤ ÿßŸÑŸÖÿπÿßŸÑŸÖ",
                piDistance: "ÿßŸÑŸÖÿ≥ÿßŸÅÿ©",
                piDuration: "ÿßŸÑŸÖÿØÿ©",
                piDifficulty: "ÿßŸÑÿµÿπŸàÿ®ÿ©",
                piFacilities: "ÿßŸÑŸÖÿ±ÿßŸÅŸÇ",
                piType: "ÿßŸÑŸÜŸàÿπ",
                piTip: "ŸÜÿµŸäÿ≠ÿ©",
                roadType: "ÿßŸÑÿ∑ÿ±ŸäŸÇ",
                roadTarmac: "ÿ£ÿ≥ŸÅŸÑÿ™",
                roadGravel: "ÿ≠ÿµŸâ",
                roadTrack: "ŸÖÿ≥ÿßÿ±"
            }
        };
        
        // Fonction de traduction
        function t(key) {
            return I18N[LANG]?.[key] || I18N.fr[key] || key;
        }
        
        // Images de fallback pour les √©tapes sans photo
        const FALLBACK_IMAGES = [
            'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=800&q=80', // Van sur route
            'https://images.unsplash.com/photo-1527786356703-4b100091cd2c?w=800&q=80', // Campervan
            'https://images.unsplash.com/photo-1502920917128-1aa500764cbd?w=800&q=80', // Route scenic
            'https://images.unsplash.com/photo-1533105079780-92b9be482077?w=800&q=80', // Road trip
            'https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800&q=80'  // Voyage
        ];
        
        // ===== FONCTIONS GLOBALES (expos√©es pour onerror) =====
        
        // Optimisation d'image via proxy wsrv.nl
        window.optimizeImg = function(url, w = 1200) {
            if (!url) return '';
            // Images base64 - retourner tel quel (ne pas proxifier)
            if (url.startsWith('data:image')) return url;
            // D√©j√† optimis√©
            if (url.includes('wsrv.nl')) return url;
            // Wikimedia/Wikipedia - ne pas proxifier
            if (url.includes('wikimedia.org') || url.includes('wikipedia.org')) return url;
            // Unsplash - d√©j√† optimis√© avec param√®tres
            if (url.includes('unsplash.com') && url.includes('?')) return url;
            // Google Photos / googleusercontent - ne pas proxifier
            if (url.includes('googleusercontent.com') || url.includes('lh3.google')) return url;
            // URL locale - ne pas proxifier (wsrv.nl ne peut pas y acc√©der)
            if (url.startsWith('/') || url.startsWith('./') || url.includes('127.0.0.1') || url.includes('localhost')) {
                return url; // Retourner tel quel
            }
            // Proxifier les autres URLs
            return `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=${w}&q=85&output=webp`;
        };
        
        // Gestion erreurs images - bascule vers la suivante
        window.handleImageError = function(img, stepIdx) {
            const photos = img.dataset.photos ? JSON.parse(img.dataset.photos) : [];
            let currentIdx = parseInt(img.dataset.currentIdx || 0);
            currentIdx++;
            
            if (currentIdx < photos.length) {
                img.dataset.currentIdx = currentIdx;
                const nextPhoto = photos[currentIdx];
                img.src = window.optimizeImg(nextPhoto);
                console.log(`[IMG] Erreur sur image ${stepIdx}, essai photo ${currentIdx + 1}/${photos.length}`);
            } else {
                // Plus de photos valides, utiliser fallback
                const fallbackIdx = typeof stepIdx === 'number' ? stepIdx % FALLBACK_IMAGES.length : 0;
                img.src = FALLBACK_IMAGES[fallbackIdx];
                img.onerror = null; // √âviter boucle infinie
                console.log(`[IMG] Aucune image valide pour ${stepIdx}, fallback utilis√©`);
            }
        };
        
        // ===== CHARGEMENT DEPUIS URL (cc + itin) =====
        async function loadFromUrl() {
            urlParams = new URLSearchParams(location.search);
            const cc = urlParams.get('cc');
            const itin = urlParams.get('itin');
            const lang = urlParams.get('lang') || localStorage.getItem('lang') || 'fr';
            
            if (!cc || !itin) return null;
            
            console.log(`[CARNET] Chargement depuis URL: cc=${cc}, itin=${itin}, lang=${lang}`);
            
            // Charger le fichier itins.modules
            const basePath = `./data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc.toUpperCase()}.itins.modules`;
            let data = null;
            
            // Essayer avec la langue, puis sans
            for (const path of [`${basePath}-${lang}.json`, `${basePath}.json`]) {
                try {
                    const res = await fetch(path);
                    if (res.ok) {
                        data = await res.json();
                        console.log(`[CARNET] Fichier charg√©: ${path}`);
                        break;
                    }
                } catch(e) {}
            }
            
            if (!data) {
                console.error('[CARNET] Fichier itins.modules non trouv√©');
                return null;
            }
            
            // Trouver l'itin√©raire
            const itins = data.itineraries || data.modules || [];
            const it = itins.find(x => (x.itin_id || x.id || x.slug) === itin);
            
            if (!it) {
                console.error(`[CARNET] Itin√©raire "${itin}" non trouv√©`);
                return null;
            }
            
            // Charger le cache photos
            await loadPhotosCache();
            await loadCountryPhotos(cc);
            
            // Convertir en format tripData
            const steps = [];
            const daysPlan = it.days_plan || [];
            const places = it.places || [];
            
            if (daysPlan.length > 0) {
                for (const d of daysPlan) {
                    const pid = d.night?.place_id || '';
                    const coords = d.night?.coords || [];
                    let name = pid ? pid.split('::')[1]?.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '';
                    
                    steps.push({
                        place_id: pid,
                        name: name || d.night?.name || '√âtape',
                        lat: coords[0] || null,
                        lon: coords[1] || null,
                        nights: 1,
                        visits: Array.isArray(d.visits) ? d.visits : [],
                        activities: Array.isArray(d.activities) ? d.activities : [],
                        distanceKm: d.to_next_leg?.distance_km || 0,
                        driveMin: d.to_next_leg?.drive_min || 0,
                        photos: getPhotosForPlaceLocal(pid)
                    });
                }
            } else if (places.length > 0) {
                for (const p of places) {
                    const pid = p.place_id || p.id || '';
                    steps.push({
                        place_id: pid,
                        name: p.name || p.title || '√âtape',
                        lat: p.lat || null,
                        lon: p.lon || null,
                        nights: 1,
                        visits: p.visits || [],
                        activities: p.activities || [],
                        photos: getPhotosForPlaceLocal(pid)
                    });
                }
            }
            
            return {
                id: `${cc}::${itin}`,
                title: it.title || it.name || 'Mon roadtrip',
                country: cc.toUpperCase(),
                steps: steps,
                cc: cc.toUpperCase(),
                itin: itin
            };
        }
        
        // Photos locales (sans d√©pendance globale)
        let countryPhotosCache = {};
        
        async function loadCountryPhotos(cc) {
            try {
                const url = `./data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc.toLowerCase()}.photos.cache.json`;
                const res = await fetch(url);
                if (res.ok) {
                    countryPhotosCache = await res.json() || {};
                    console.log(`[CARNET] Photos pays charg√©es: ${Object.keys(countryPhotosCache).length} lieux`);
                }
            } catch(e) {}
        }
        
        function getPhotosForPlaceLocal(placeId, stepIndex = -1) {
            const photos = [];
            
            // 1. Priorit√© aux photos utilisateur si disponibles
            if (stepIndex >= 0 && window.ORT_TRIP_DATA) {
                const userPhotos = ORT_TRIP_DATA.getStepPhotos(stepIndex) || [];
                if (userPhotos.length > 0) {
                    photos.push(...userPhotos);
                    console.log(`[CARNET] Photos utilisateur √©tape ${stepIndex + 1}:`, userPhotos.length);
                }
            }
            
            // 2. Depuis photosCache global
            if (photosCache[placeId]?.photos) {
                photosCache[placeId].photos.forEach(p => {
                    if (p && !photos.includes(p)) photos.push(p);
                });
            }
            
            // 3. Depuis countryPhotosCache
            if (countryPhotosCache[placeId]?.photos) {
                countryPhotosCache[placeId].photos.forEach(p => {
                    if (p && !photos.includes(p)) photos.push(p);
                });
            }
            
            return photos.filter(p => p && typeof p === 'string');
        }
        
        // ===== MISE √Ä JOUR TOOLBAR I18N =====
        function updateToolbarLabels() {
            // Desktop toolbar
            document.getElementById('toolbarTitle').textContent = t('myTravelBook');
            document.getElementById('btnClose').innerHTML = `‚úï ${t('close')}`;
            document.getElementById('btnCopyLink').innerHTML = `üîó ${t('copyLink')}`;
            document.getElementById('btnModify').innerHTML = `‚úèÔ∏è ${t('modify')}`;
            document.getElementById('btnPrint').innerHTML = `üñ®Ô∏è ${t('printPdf')}`;
            
            // Mobile menu
            document.querySelectorAll('[data-mobile-i18n]').forEach(el => {
                const key = el.dataset.mobileI18n;
                if (key && t(key)) {
                    el.textContent = t(key);
                }
            });
            
            // Mettre √† jour le message de chargement
            const loadingDiv = document.querySelector('.loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="loading-icon">‚è≥</div>
                    <div>${t('loading')}</div>
                `;
            }
            
            // Direction RTL pour l'arabe
            if (LANG === 'ar') {
                document.documentElement.dir = 'rtl';
            }
        }
        
        // ===== INIT =====
        async function init() {
            console.log('[CARNET] Initialisation...');
            
            // D√©tecter la langue
            urlParams = new URLSearchParams(location.search);
            LANG = urlParams.get('lang') || localStorage.getItem('lang') || 'fr';
            if (!I18N[LANG]) LANG = 'fr';
            console.log(`[CARNET] Langue: ${LANG}`);
            
            // Mettre √† jour la toolbar avec les traductions
            updateToolbarLabels();
            
            // 0) V√âRIFIER SI C'EST UN LIEN PARTAG√â
            console.log('[CARNET] üîç V√©rification lien partag√©...');
            const sharedAccess = await ORT_SHARE.checkSharedAccess();
            if (sharedAccess && sharedAccess.data) {
                console.log('[CARNET] ‚úÖ Lien partag√© d√©tect√©!');
                tripData = sharedAccess.data;
                tripId = tripData.id;
                // Appliquer mode lecture seule
                document.body.classList.add('shared-view-only');
                console.log('[CARNET] Mode lecture seule activ√©');
            }
            // Sinon continuer avec sessionStorage/URL
            else {
            
            // 1) Essayer sessionStorage (depuis roadtrip_detail.html)
            const stored = sessionStorage.getItem('ort_editor_trip');
            if (stored) {
                tripData = JSON.parse(stored);
                // Priorit√©: tripId URL > _dashboardTripId > tripData.id
                const urlTripId = urlParams.get('tripId') || urlParams.get('id');
                tripId = urlTripId || tripData._dashboardTripId || tripData.id || generateId();
                tripData.id = tripId;
                console.log('[CARNET] Donn√©es depuis sessionStorage, tripId:', tripId);
                
                // Debug: afficher les nuits de chaque √©tape
                const nightsDebug = tripData.steps.map((s, i) => `${i}: ${s.name} = ${s.nights} nuit(s)`);
                console.log('[CARNET] Nuits par √©tape:', nightsDebug);
                const totalNights = tripData.steps.reduce((sum, s) => sum + (s.nights || 0), 0);
                console.log(`[CARNET] Total nuits: ${totalNights}`);
                
                // Debug: v√©rifier practical_context
                if (tripData.practical_context) {
                    console.log('[CARNET] ‚úÖ practical_context pr√©sent:', tripData.practical_context);
                } else {
                    console.log('[CARNET] ‚ö†Ô∏è practical_context ABSENT dans tripData');
                }
            }
            
            // 2) Sinon, charger depuis URL params (cc + itin)
            if (!tripData || !tripData.steps || tripData.steps.length === 0) {
                tripData = await loadFromUrl();
                if (tripData) {
                    tripId = tripData.id;
                    console.log('[CARNET] Donn√©es depuis URL params');
                }
            }
            
            } // Fin du else du lien partag√©
            
            // 3) Toujours pas de donn√©es ?
            if (!tripData || !tripData.steps || tripData.steps.length === 0) {
                document.getElementById('container').innerHTML = `
                    <div class="loading">
                        <div class="loading-icon">‚ùå</div>
                        <div>${t('noData')}</div>
                        <div style="margin-top:16px"><a href="/" style="color:#113f7a">${t('backHome')}</a></div>
                    </div>
                `;
                return;
            }
            
            // Charger cache photos
            await loadPhotosCache();
            
            // === CHARGER LES PHOTOS UTILISATEUR DEPUIS ORT_TRIP_DATA ===
            await loadUserPhotos();
            
            // G√©n√©rer le carnet
            renderBook();
            
            // Titre
            document.getElementById('toolbarTitle').textContent = tripData.title || 'Mon carnet';
            document.title = (tripData.title || 'Carnet') + ' ‚Äî OneRoadTrip';
            
            // Events
            setupEvents();
            
            console.log('[CARNET] ‚úÖ Pr√™t');
        }
        
        // ===== PHOTOS =====
        async function loadPhotosCache() {
            try {
                const r = await fetch('./data/photos-json/photos_lieux.json', { cache: 'no-store' });
                if (r.ok) photosCache = await r.json() || {};
            } catch(e) {}
        }
        
        // Charger les photos utilisateur depuis Firestore via ORT_TRIP_DATA
        async function loadUserPhotos() {
            if (!window.ORT_TRIP_DATA || !tripId) return;
            
            try {
                // Attendre que Firebase soit pr√™t
                const user = await new Promise(resolve => {
                    if (window.firebase?.auth) {
                        firebase.auth().onAuthStateChanged(u => resolve(u));
                    } else {
                        resolve(null);
                    }
                });
                
                if (!user) {
                    console.log('[CARNET] Pas connect√©, pas de photos utilisateur');
                    return;
                }
                
                // === CHARGEMENT DIRECT DEPUIS FIRESTORE (sans passer par ORT_STATE) ===
                console.log('[CARNET] Chargement photos utilisateur depuis Firestore...');
                const db = firebase.firestore();
                const tripRef = db.collection('users').doc(user.uid).collection('trips').doc(tripId);
                
                // Charger les userPhotos depuis la sous-collection
                const photosSnapshot = await tripRef.collection('userPhotos').get();
                
                if (photosSnapshot.empty) {
                    console.log('[CARNET] Aucune photo utilisateur trouv√©e dans Firestore');
                    return;
                }
                
                // Cr√©er un map stepIndex -> photos
                const userPhotosMap = {};
                photosSnapshot.forEach(doc => {
                    const photoData = doc.data();
                    if (typeof photoData.stepIndex === 'number') {
                        userPhotosMap[photoData.stepIndex] = photoData.photos || [];
                    }
                });
                
                console.log('[CARNET] Photos utilisateur charg√©es:', Object.keys(userPhotosMap).length, '√©tapes');
                
                // Injecter les userPhotos dans chaque step - √âCRASER les photos du sessionStorage
                if (tripData?.steps) {
                    let photosInjected = 0;
                    tripData.steps.forEach((step, i) => {
                        const userPhotos = userPhotosMap[i] || [];
                        if (userPhotos.length > 0) {
                            // IMPORTANT: Injecter dans userPhotos pour priorit√© dans getPhotos()
                            step.userPhotos = userPhotos;
                            
                            // Aussi mettre √† jour photo/photos/images pour coh√©rence
                            const catalogPhotos = (photosCache[step.place_id]?.photos || []);
                            const combined = [...userPhotos];
                            catalogPhotos.forEach(p => {
                                if (p && !combined.includes(p)) combined.push(p);
                            });
                            step.photos = combined;
                            step.images = combined;
                            step.photo = combined[0];
                            photosInjected += userPhotos.length;
                            console.log(`[CARNET] ‚úÖ √âtape ${i} (${step.name}): ${userPhotos.length} photos user inject√©es`, userPhotos);
                        }
                    });
                    
                    if (photosInjected > 0) {
                        console.log(`[CARNET] ‚úÖ ${photosInjected} photos utilisateur inject√©es au total`);
                        
                        // IMPORTANT: Re-render le carnet avec les nouvelles photos
                        console.log('[CARNET] Re-render avec photos utilisateur...');
                        renderBook();
                    } else {
                        console.log('[CARNET] Aucune photo √† injecter');
                    }
                }
            } catch (e) {
                console.warn('[CARNET] Erreur chargement photos utilisateur:', e);
            }
        }
        
        function getPhotos(step) {
            const seen = new Set();
            const photos = [];
            
            // Helper pour ajouter sans doublon
            const addPhoto = (url) => {
                if (url && typeof url === 'string' && !seen.has(url) && 
                    !url.includes('default-roadtrip')) {
                    // Accepter: http(s), data:image (base64), wikimedia, unsplash, googleusercontent
                    const isValid = url.startsWith('http') || 
                                    url.startsWith('data:image') || 
                                    url.includes('wikimedia') || 
                                    url.includes('unsplash') ||
                                    url.includes('googleusercontent');
                    if (isValid) {
                        seen.add(url);
                        photos.push(url);
                    }
                }
            };
            
            // 1. Photos utilisateur (userPhotos) - PRIORIT√â MAX
            if (step.userPhotos?.length) {
                step.userPhotos.forEach(p => addPhoto(p));
            }
            
            // 2. Photo principale de l'√©tape (peut √™tre une photo user inject√©e)
            addPhoto(step.photo);
            
            // 3. Photos de l'√©tape (step.photos / step.images - peuvent contenir photos user)
            if (step.photos?.length) {
                step.photos.forEach(p => addPhoto(p));
            }
            if (step.images?.length) {
                step.images.forEach(p => addPhoto(p));
            }
            
            // 4. Photos du catalogue (limit√© √† 5 max pour ne pas surcharger)
            if (step.place_id && photosCache[step.place_id]?.photos) {
                const catalogPhotos = photosCache[step.place_id].photos.slice(0, 5);
                catalogPhotos.forEach(p => addPhoto(p));
            }
            
            return photos;
        }
        
        // ===== G√âN√âRATION PAGE R√âSERVATIONS =====
        function generateBookingsPage(tripData, steps, t) {
            const travelBookings = tripData.travelBookings || [];
            const stepBookingsMap = tripData.stepBookingsMap || {};
            const totalBudget = tripData.totalBudget || 0;
            
            // V√©rifier s'il y a des r√©sas
            const hasTravel = travelBookings.length > 0;
            const hasStep = Object.keys(stepBookingsMap).length > 0;
            
            if (!hasTravel && !hasStep) {
                console.log('[CARNET] Pas de r√©servations √† afficher');
                return '';
            }
            
            console.log('[CARNET] G√©n√©ration page r√©servations:', travelBookings.length, 'voyage,', Object.keys(stepBookingsMap).length, '√©tapes');
            
            let html = `
            <!-- PAGE R√âSERVATIONS -->
            <div class="page bookings-page">
                <h2 class="bookings-title">üìã ${t('bookings')}</h2>
            `;
            
            // === SECTION VOLS ===
            const flights = travelBookings.filter(b => b.category === 'flight');
            if (flights.length > 0) {
                html += `<div class="bookings-section">
                    <div class="bookings-section-title">‚úàÔ∏è ${t('flights')}</div>`;
                
                flights.forEach(flight => {
                    const price = flight.price ? (typeof flight.price === 'object' ? flight.price.amount : flight.price) : null;
                    html += `<div class="booking-card">
                        <div class="booking-card-header">
                            <span class="booking-icon">‚úàÔ∏è</span>
                            <span class="booking-name">${esc(flight.name || 'Vol')}</span>
                            ${price ? `<span class="booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</span>` : ''}
                        </div>`;
                    
                    // Segments de vol
                    if (flight.flights && flight.flights.length > 0) {
                        flight.flights.forEach(seg => {
                            const isReturn = seg.type === 'return';
                            const headerClass = isReturn ? 'flight-segment-header return' : 'flight-segment-header';
                            const typeLabel = isReturn ? t('returnFlight') : t('outbound');
                            
                            html += `<div class="flight-segment">
                                <div class="${headerClass}">‚úàÔ∏è ${typeLabel}</div>
                                <div class="flight-route">
                                    ${esc(seg.departure_city || '')} ${seg.departure_airport ? `(${seg.departure_airport})` : ''} 
                                    ‚Üí ${esc(seg.arrival_city || '')} ${seg.arrival_airport ? `(${seg.arrival_airport})` : ''}
                                </div>
                                <div class="flight-times">
                                    ${seg.departure_date ? `<span>üìÖ ${seg.departure_date}</span>` : ''}
                                    ${seg.departure_time ? `<span>üõ´ ${seg.departure_time}</span>` : ''}
                                    ${seg.arrival_time ? `<span>üõ¨ ${seg.arrival_time}</span>` : ''}
                                    ${seg.duration_minutes ? `<span>‚è±Ô∏è ${formatDuration(seg.duration_minutes)}</span>` : ''}
                                </div>
                            </div>`;
                        });
                    }
                    
                    html += `</div>`; // booking-card
                });
                
                html += `</div>`; // bookings-section
            }
            
            // === SECTION LOCATION VOITURE ===
            const cars = travelBookings.filter(b => b.category === 'car_rental');
            if (cars.length > 0) {
                html += `<div class="bookings-section">
                    <div class="bookings-section-title">üöó ${t('carRental')}</div>`;
                
                cars.forEach(car => {
                    const price = car.price ? (typeof car.price === 'object' ? car.price.amount : car.price) : null;
                    const rental = car.car_rental || {};
                    
                    html += `<div class="booking-card">
                        <div class="booking-card-header">
                            <span class="booking-icon">üöó</span>
                            <span class="booking-name">${esc(car.name || rental.vehicle_model || 'Location')}</span>
                            ${price ? `<span class="booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</span>` : ''}
                        </div>
                        <div class="car-rental-box">
                            <div class="car-rental-location pickup">
                                <div class="car-rental-label pickup">üìç ${t('pickup')}</div>
                                <div>${esc(rental.pickup_location || car.address || '')}</div>
                                ${rental.pickup_date ? `<div>üìÖ ${rental.pickup_date} ${rental.pickup_time || ''}</div>` : ''}
                            </div>
                            <div class="car-rental-location dropoff">
                                <div class="car-rental-label dropoff">üìç ${t('dropoff')}</div>
                                <div>${esc(rental.dropoff_location || rental.pickup_location || '')}</div>
                                ${rental.dropoff_date ? `<div>üìÖ ${rental.dropoff_date} ${rental.dropoff_time || ''}</div>` : ''}
                            </div>
                        </div>
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            // === SECTION AUTRES (assurance, guide, etc.) ===
            const others = travelBookings.filter(b => !['flight', 'car_rental'].includes(b.category));
            if (others.length > 0) {
                html += `<div class="bookings-section">
                    <div class="bookings-section-title">üéØ ${t('travelBookings')}</div>`;
                
                others.forEach(b => {
                    const icon = { insurance: 'üõ°Ô∏è', activity: 'üéØ', visit: 'üèõÔ∏è', show: 'üé≠' }[b.category] || 'üìã';
                    const price = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : null;
                    
                    html += `<div class="booking-card">
                        <div class="booking-card-header">
                            <span class="booking-icon">${icon}</span>
                            <span class="booking-name">${esc(b.name || 'R√©servation')}</span>
                            ${price ? `<span class="booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</span>` : ''}
                        </div>
                        <div class="booking-details">
                            ${b.date_start ? `<div>üìÖ ${b.date_start}${b.date_end && b.date_end !== b.date_start ? ' ‚Üí ' + b.date_end : ''}</div>` : ''}
                            ${b.reference ? `<div>üîñ ${t('ref')}: ${esc(b.reference)}</div>` : ''}
                        </div>
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            // === BUDGET TOTAL ===
            if (totalBudget > 0) {
                html += `
                <div class="budget-total">
                    <div class="budget-total-label">üí∞ ${t('totalBudget')}</div>
                    <div class="budget-total-amount">${totalBudget.toFixed(2)} ‚Ç¨</div>
                </div>`;
            }
            
            html += `</div>`; // bookings-page
            
            return html;
        }
        
        // Helper: formater dur√©e
        function formatDuration(minutes) {
            if (!minutes) return '';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return m > 0 ? `${h}h${String(m).padStart(2, '0')}` : `${h}h`;
        }
        
        // G√©n√®re le HTML des h√©bergements pour une √©tape
        function generateStepBookingsHtml(stepBookingsMap, stepIdx, t) {
            if (!stepBookingsMap) return '';
            
            // Trouver les h√¥tels dont la premi√®re √©tape est celle-ci
            const hotels = [];
            Object.values(stepBookingsMap).forEach(data => {
                if (data.firstStepIndex === stepIdx && data.booking.category === 'hotel') {
                    hotels.push(data);
                }
            });
            
            if (hotels.length === 0) return '';
            
            let html = '';
            hotels.forEach(data => {
                const b = data.booking;
                const nights = data.steps.length;
                const price = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : null;
                
                html += `
                <div class="step-booking">
                    <div class="step-booking-title">üè® ${esc(b.name || t('hotel'))}</div>
                    <div style="font-size:0.8rem;color:#6b7280">
                        ${nights > 1 ? `${nights} ${t('nights')}` : `1 ${t('night')}`}
                        ${price ? ` ‚Ä¢ ${parseFloat(price).toFixed(0)} ‚Ç¨` : ''}
                        ${b.address ? ` ‚Ä¢ ${esc(b.address)}` : ''}
                    </div>
                </div>`;
            });
            
            return html;
        }
        
        // ===== G√âN√âRATION INFOS PRATIQUES (format enrichi) =====
        
        /**
         * G√©n√®re l'encart practical_context pour la page r√©sum√©
         */
        function generatePracticalContextHtml(tripData, t) {
            const pc = tripData.practical_context;
            if (!pc) return '';
            
            const hasBestMonths = pc.best_months && pc.best_months.length > 0;
            const hasHighlights = pc.highlights && pc.highlights.length > 0;
            
            if (!hasBestMonths && !hasHighlights) return '';
            
            let html = `
            <div class="practical-context-box">
                <div class="practical-context-title">üìã ${t('practicalInfo')}</div>
                <div class="practical-context-grid">
            `;
            
            // Meilleure p√©riode
            if (hasBestMonths) {
                const monthsStr = pc.best_months.join(', ');
                html += `
                    <div class="practical-context-item">
                        <div class="practical-context-label">üìÖ ${t('bestPeriod')}</div>
                        <div class="practical-context-value">${esc(monthsStr)}</div>
                    </div>
                `;
            }
            
            // Points forts
            if (hasHighlights) {
                html += `
                    <div class="practical-context-item">
                        <div class="practical-context-label">‚ú® ${t('highlights')}</div>
                        <ul class="highlights-list">
                            ${pc.highlights.slice(0, 5).map(h => `<li>${esc(h)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            html += `
                </div>
            </div>
            `;
            
            return html;
        }
        
        /**
         * G√©n√®re le HTML des infos pratiques pour une activit√©
         */
        function generateActivityPracticalInfoHtml(activity, t) {
            if (!activity || typeof activity !== 'object') return '';
            
            const pi = activity.practical_info;
            if (!pi) return '';
            
            const parts = [];
            
            if (pi.distance) {
                parts.push(`<span>üìè ${esc(pi.distance)}</span>`);
            }
            if (pi.duration) {
                parts.push(`<span>‚è±Ô∏è ${esc(pi.duration)}</span>`);
            }
            if (pi.difficulty) {
                parts.push(`<span>üí™ ${esc(pi.difficulty)}</span>`);
            }
            if (pi.type) {
                parts.push(`<span>üè∑Ô∏è ${esc(pi.type)}</span>`);
            }
            if (pi.facilities) {
                parts.push(`<span>üèïÔ∏è ${esc(pi.facilities)}</span>`);
            }
            if (pi.tip) {
                parts.push(`<span>üí° ${esc(pi.tip)}</span>`);
            }
            
            if (parts.length === 0) return '';
            
            return `<div class="activity-practical-info">${parts.join('')}</div>`;
        }
        
        /**
         * G√©n√®re le badge road_type pour un trajet
         */
        function generateRoadTypeBadge(roadType, t) {
            if (!roadType) return '';
            
            const roadTypeLower = roadType.toLowerCase();
            let badgeClass = '';
            let icon = 'üõ£Ô∏è';
            
            if (roadTypeLower.includes('gravel') || roadTypeLower.includes('grava') || roadTypeLower.includes('sterrato') || roadTypeLower.includes('cascalho')) {
                badgeClass = 'gravel';
                icon = 'ü™®';
            } else if (roadTypeLower.includes('piste') || roadTypeLower.includes('track') || roadTypeLower.includes('trilha') || roadTypeLower.includes('ŸÖÿ≥ÿßÿ±')) {
                badgeClass = 'track';
                icon = 'üèúÔ∏è';
            }
            
            return `<span class="road-type-badge ${badgeClass}">${icon} ${esc(roadType)}</span>`;
        }
        
        // ===== RENDER =====
        function renderBook() {
            const container = document.getElementById('container');
            const steps = tripData.steps;
            
            // Stats
            // totalDays = somme des nuits (pas nights || 1 qui ajoute 1 pour les √©tapes avec 0 nuits)
            const totalNights = steps.reduce((s, st) => s + (Number(st.nights) || 0), 0);
            // Jours = nuits + 1 (on arrive jour 1, on repart apr√®s les nuits)
            // Mais si totalNights vient de tripData, l'utiliser directement
            const totalDays = tripData.totalNights || totalNights || steps.length;
            const totalKm = Math.round(steps.reduce((s, st) => s + (st.to_next_leg?.distance_km || st.distanceKm || 0), 0));
            const country = tripData.country ? getCountryName(tripData.country) : '';
            
            // Compter les √©tapes uniques (lieux distincts, pas les jours)
            // Regrouper par place_id ou par nom si pas de place_id
            const uniquePlaces = new Set();
            steps.forEach(st => {
                const key = st.place_id || st.name || '';
                if (key) uniquePlaces.add(key);
            });
            const totalSteps = uniquePlaces.size || steps.length;
            
            console.log(`[CARNET] Stats: ${totalDays} jours, ${totalSteps} √©tapes, ${totalKm} km`);
            
            // Photo couverture
            let coverPhotos = getPhotos(steps[0]);
            if (coverPhotos.length === 0) {
                coverPhotos = [FALLBACK_IMAGES[0]];
            }
            const coverPhoto = coverPhotos[tripData.coverPhotoIdx || 0] || coverPhotos[0] || '';
            
            let html = `
            <!-- PAGE COUVERTURE -->
            <div class="page cover-page">
                <div class="cover-hero">
                    ${coverPhoto ? `
                        <img src="${window.optimizeImg(coverPhoto)}" alt="Couverture" id="coverImg" data-photos='${JSON.stringify(coverPhotos)}' data-current-idx="0" onerror="handleImageError(this, 'cover')">
                        ${coverPhotos.length > 1 ? `
                            <button class="carousel-btn prev no-print" onclick="changePhoto('cover',-1)">‚Äπ</button>
                            <button class="carousel-btn next no-print" onclick="changePhoto('cover',1)">‚Ä∫</button>
                            <div class="photo-counter no-print" id="coverCounter">1/${coverPhotos.length}</div>
                        ` : ''}
                    ` : '<div class="step-no-photo">üì∑</div>'}
                    <div class="cover-overlay"></div>
                    <div class="cover-title-box">
                        <h1 class="cover-title" contenteditable="true" data-field="title">${esc(tripData.title || t('myTravelBook'))}</h1>
                        <p class="cover-subtitle">${country ? 'üåç ' + country : ''}</p>
                    </div>
                </div>
                <div class="cover-stats">
                    <div class="stat-item">
                        <div class="stat-number">${totalDays}</div>
                        <div class="stat-label">${t('days')}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${totalSteps}</div>
                        <div class="stat-label">${t('steps')}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${totalKm}</div>
                        <div class="stat-label">${t('km')}</div>
                    </div>
                </div>
            </div>
            
            <!-- PAGE R√âSUM√â -->
            <div class="page summary-page">
                <h2 class="summary-title">üìç ${t('itinerary')}</h2>
                <ol class="steps-list">
                    ${steps.map((st, i) => {
                        const nights = st.nights || 1;
                        const dist = st.to_next_leg?.distance_km || st.distanceKm || 0;
                        const nightLabel = nights > 1 ? t('nights') : t('night');
                        return `
                        <li>
                            <div class="step-summary">
                                <div class="step-marker">${i + 1}</div>
                                <div class="step-summary-content">
                                    <div class="step-name">${esc(st.name)}</div>
                                    <div class="step-nights">${nights} ${nightLabel}</div>
                                    ${dist ? `<div class="step-distance">‚Üí ${Math.round(dist)} ${t('km')}</div>` : ''}
                                </div>
                            </div>
                        </li>
                        `;
                    }).join('')}
                </ol>
                ${generatePracticalContextHtml(tripData, t)}
            </div>
            `;
            
            // === PAGE R√âSERVATIONS (si pr√©sentes) ===
            const bookingsHtml = generateBookingsPage(tripData, steps, t);
            if (bookingsHtml) {
                html += bookingsHtml;
            }
            
            // Collecter TOUTES les photos du voyage pour les r√©partir
            let allPhotos = [];
            steps.forEach((st) => {
                const stepPhotos = getPhotos(st);
                stepPhotos.forEach(p => {
                    if (!allPhotos.includes(p)) allPhotos.push(p);
                });
            });
            // Ajouter les fallbacks si pas assez de photos
            if (allPhotos.length < steps.length) {
                FALLBACK_IMAGES.forEach(p => {
                    if (!allPhotos.includes(p)) allPhotos.push(p);
                });
            }
            
            // Pages √©tapes - AVEC PAGINATION AUTOMATIQUE SI CONTENU TROP LONG
            // Tracker combien de fois on a vu chaque lieu pour varier les photos
            const placeOccurrences = {};
            
            // Configuration pagination - bas√©e sur les CARACT√àRES, pas juste le nombre d'items
            const MAX_CHARS_PAGE1 = 1200;      // Caract√®res max sur page principale (photo + texte)
            const MAX_CHARS_CONTINUATION = 2800; // Caract√®res max sur page continuation (2 colonnes, plus d'espace)
            const MAX_ITEMS_PAGE1 = 6;          // Limite dure d'items sur page 1
            const MAX_ITEMS_CONTINUATION = 20;  // Limite dure d'items sur page continuation
            
            // Helper: calculer la longueur totale d'une liste d'items
            function getItemsLength(items) {
                return items.reduce((sum, item) => {
                    const text = typeof item === 'string' ? item : (item.name || item.text || '');
                    return sum + text.length;
                }, 0);
            }
            
            // Helper: d√©couper une liste en respectant une limite de caract√®res ET d'items
            function splitByCharsAndCount(items, maxChars, maxItems) {
                const result = [];
                let currentChars = 0;
                
                for (const item of items) {
                    if (result.length >= maxItems) break;
                    
                    const text = typeof item === 'string' ? item : (item.name || item.text || '');
                    const itemLen = text.length;
                    
                    // Si on d√©passe les chars ET qu'on a d√©j√† au moins 1 item, on arr√™te
                    if (currentChars + itemLen > maxChars && result.length > 0) break;
                    
                    result.push(item);
                    currentChars += itemLen;
                }
                
                return result;
            }
            
            steps.forEach((step, idx) => {
                // D'abord les photos sp√©cifiques √† cette √©tape (incluant photos utilisateur Firestore)
                let stepPhotos = getPhotos(step);
                
                // Compter les occurrences de ce lieu pour varier les photos
                const placeKey = step.place_id || step.name || idx;
                placeOccurrences[placeKey] = (placeOccurrences[placeKey] || 0);
                const occurrence = placeOccurrences[placeKey];
                placeOccurrences[placeKey]++;
                
                // DEBUG: Voir les photos de chaque √©tape
                console.log(`[CARNET] √âtape ${idx} (${step.name}): ${stepPhotos.length} photos, occurrence ${occurrence}`, stepPhotos.slice(0, 3));
                
                // Photo principale = varier selon l'occurrence du lieu
                let photo;
                let photoIndex = 0;
                if (stepPhotos.length > 0) {
                    // Si m√™me lieu appara√Æt plusieurs fois, prendre une photo diff√©rente
                    photoIndex = occurrence % stepPhotos.length;
                    photo = stepPhotos[photoIndex];
                } else {
                    // Fallback: photo du pool global (r√©parti par index)
                    photo = allPhotos[idx % allPhotos.length];
                    stepPhotos = [photo];
                    console.log(`[CARNET] √âtape ${idx}: pas de photo sp√©cifique, fallback utilis√©`);
                }
                
                const visits = step.visits || step.pois || [];
                const activities = step.activities || [];
                const nextStep = steps[idx + 1];
                const distKm = step.to_next_leg?.distance_km || step.distanceKm || 0;
                const driveMin = step.to_next_leg?.drive_min || step.driveMin || 0;
                
                // Calculer la longueur totale du contenu
                const totalChars = getItemsLength(visits) + getItemsLength(activities);
                const totalItems = visits.length + activities.length;
                
                // D√©terminer si on a besoin de plusieurs pages
                const needsMultiplePages = totalChars > MAX_CHARS_PAGE1 || totalItems > MAX_ITEMS_PAGE1;
                
                // Estimer le nombre de pages
                let estimatedPages = 1;
                if (needsMultiplePages) {
                    const remainingChars = Math.max(0, totalChars - MAX_CHARS_PAGE1);
                    estimatedPages = 1 + Math.ceil(remainingChars / MAX_CHARS_CONTINUATION);
                }
                const totalPages = Math.min(estimatedPages, 5); // Max 5 pages
                
                console.log(`[CARNET] √âtape ${idx}: ${totalItems} items, ${totalChars} chars, ${totalPages} page(s)`);
                
                // === PAGE 1 : Layout classique photo gauche / texte droite ===
                // D√©couper visits et activities pour la page 1
                const visitsPage1 = splitByCharsAndCount(visits, MAX_CHARS_PAGE1, MAX_ITEMS_PAGE1);
                const charsUsedByVisits = getItemsLength(visitsPage1);
                const remainingCharsForActivities = Math.max(0, MAX_CHARS_PAGE1 - charsUsedByVisits);
                const remainingItemsForActivities = Math.max(0, MAX_ITEMS_PAGE1 - visitsPage1.length);
                const activitiesPage1 = splitByCharsAndCount(activities, remainingCharsForActivities, remainingItemsForActivities);
                
                const pageNumberBadge = totalPages > 1 ? `<div class="page-number-badge">1/${totalPages}</div>` : '';
                
                html += `
                <div class="page step-page" data-step="${idx}" data-page="1">
                    <div class="step-photo">
                        ${photo ? `
                            <img src="${window.optimizeImg(photo)}" alt="${esc(step.name)}" id="stepImg${idx}" data-photos='${JSON.stringify(stepPhotos)}' data-current-idx="0" onerror="handleImageError(this, ${idx})">
                            ${stepPhotos.length > 1 ? `
                                <button class="carousel-btn prev no-print" onclick="changePhoto(${idx},-1)">‚Äπ</button>
                                <button class="carousel-btn next no-print" onclick="changePhoto(${idx},1)">‚Ä∫</button>
                                <div class="photo-counter no-print" id="stepCounter${idx}">1/${stepPhotos.length}</div>
                            ` : ''}
                        ` : '<div class="step-no-photo">üì∑</div>'}
                        ${pageNumberBadge}
                    </div>
                    <div class="step-content">
                        <span class="day-badge">${t('day')} ${idx + 1}</span>
                        <h2 class="step-title" contenteditable="true" data-step="${idx}" data-field="name">${esc(step.name)}</h2>
                        
                        <!-- Carousel h√¥tels (charg√© post-render) -->
                        <div id="hotels-step-${idx}" class="hotels-section-editor"
                             data-hotel-place-id="${esc(step.place_id || '')}"
                             data-hotel-name="${esc(step.name || '')}"
                             data-hotel-lat="${step.lat || ''}"
                             data-hotel-lon="${step.lon || ''}"
                             data-hotel-coords='${JSON.stringify(step.coords || null)}'></div>
                        
                        ${visitsPage1.length > 0 ? `
                            <div class="section-block">
                                <div class="section-title">üîç ${t('toDiscover')}</div>
                                <ul class="section-items" id="visits${idx}">
                                    ${visitsPage1.map((v, vi) => `
                                        <li contenteditable="true" data-step="${idx}" data-field="visits" data-idx="${vi}">${esc(typeof v === 'string' ? v : v.name || v.text || '')}</li>
                                    `).join('')}
                                </ul>
                                ${!needsMultiplePages ? `<button class="add-item-btn no-print" onclick="addItem(${idx},'visits')">${t('addPlace')}</button>` : ''}
                            </div>
                        ` : ''}
                        
                        ${activitiesPage1.length > 0 ? `
                            <div class="section-block">
                                <div class="section-title">üéØ ${t('activities')}</div>
                                <ul class="section-items" id="activities${idx}">
                                    ${activitiesPage1.map((a, ai) => {
                                        const actText = typeof a === 'string' ? a : (a.name || a.text || '');
                                        const piHtml = generateActivityPracticalInfoHtml(a, t);
                                        return `
                                        <li contenteditable="true" data-step="${idx}" data-field="activities" data-idx="${ai}">${esc(actText)}</li>
                                        ${piHtml}
                                        `;
                                    }).join('')}
                                </ul>
                                ${!needsMultiplePages ? `<button class="add-item-btn no-print" onclick="addItem(${idx},'activities')">${t('addActivity')}</button>` : ''}
                            </div>
                        ` : ''}
                        
                        ${!needsMultiplePages ? generateStepBookingsHtml(tripData.stepBookingsMap, idx, t) : ''}
                        
                        ${nextStep && !needsMultiplePages ? `
                            <div class="next-step-info">
                                <strong>‚û°Ô∏è ${esc(nextStep.name)}</strong>
                                ${distKm ? ` ‚Äî ${Math.round(distKm)} ${t('km')}` : ''}
                                ${driveMin ? ` ‚Ä¢ ${formatTime(driveMin)}` : ''}
                                ${step.roadType ? generateRoadTypeBadge(step.roadType, t) : ''}
                            </div>
                        ` : ''}
                        
                        ${needsMultiplePages ? `<div class="next-step-info"><em>‚Üí ${t('nextPage')}</em></div>` : ''}
                    </div>
                </div>
                `;
                
                // === PAGES DE CONTINUATION si n√©cessaire ===
                if (needsMultiplePages) {
                    // Items restants apr√®s page 1
                    let remainingVisits = visits.slice(visitsPage1.length);
                    let remainingActivities = activities.slice(activitiesPage1.length);
                    let currentPage = 2;
                    
                    while (remainingVisits.length > 0 || remainingActivities.length > 0) {
                        // D√©couper avec la limite de caract√®res pour les pages de continuation
                        const visitsThisPage = splitByCharsAndCount(remainingVisits, MAX_CHARS_CONTINUATION / 2, MAX_ITEMS_CONTINUATION / 2);
                        remainingVisits = remainingVisits.slice(visitsThisPage.length);
                        
                        const charsUsedByVisitsThisPage = getItemsLength(visitsThisPage);
                        const remainingCharsForAct = Math.max(0, MAX_CHARS_CONTINUATION - charsUsedByVisitsThisPage);
                        const remainingItemsForAct = Math.max(0, MAX_ITEMS_CONTINUATION - visitsThisPage.length);
                        const activitiesThisPage = splitByCharsAndCount(remainingActivities, remainingCharsForAct, remainingItemsForAct);
                        remainingActivities = remainingActivities.slice(activitiesThisPage.length);
                        
                        const isLastPage = remainingVisits.length === 0 && remainingActivities.length === 0;
                        
                        // Photo secondaire pour la page de continuation
                        const contPhoto = stepPhotos[(photoIndex + currentPage - 1) % stepPhotos.length] || photo;
                        
                        html += `
                        <div class="page step-page continuation-page" data-step="${idx}" data-page="${currentPage}">
                            <div class="step-photo">
                                <img src="${window.optimizeImg(contPhoto)}" alt="${esc(step.name)}" onerror="handleImageError(this, ${idx})">
                                <div class="page-number-badge">${currentPage}/${totalPages}</div>
                            </div>
                            <div class="step-content">
                                <div class="continuation-header">
                                    <span class="day-badge">${t('day')} ${idx + 1}</span>
                                    <h2 class="step-title">${esc(step.name)} <span style="font-weight:400;font-size:0.7em;opacity:0.7">(${t('continued')})</span></h2>
                                </div>
                                
                                <div class="sections-grid">
                                    ${visitsThisPage.length > 0 ? `
                                        <div class="section-block">
                                            <div class="section-title">üîç ${t('toDiscover')}</div>
                                            <ul class="section-items">
                                                ${visitsThisPage.map((v, vi) => `
                                                    <li>${esc(typeof v === 'string' ? v : v.name || v.text || '')}</li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : '<div></div>'}
                                    
                                    ${activitiesThisPage.length > 0 ? `
                                        <div class="section-block">
                                            <div class="section-title">üéØ ${t('activities')}</div>
                                            <ul class="section-items">
                                                ${activitiesThisPage.map((a, ai) => {
                                                    const actText = typeof a === 'string' ? a : (a.name || a.text || '');
                                                    const piHtml = generateActivityPracticalInfoHtml(a, t);
                                                    return `<li>${esc(actText)}</li>${piHtml}`;
                                                }).join('')}
                                            </ul>
                                        </div>
                                    ` : '<div></div>'}
                                </div>
                                
                                ${isLastPage ? generateStepBookingsHtml(tripData.stepBookingsMap, idx, t) : ''}
                                
                                ${isLastPage && nextStep ? `
                                    <div class="next-step-info" style="margin-top:auto;">
                                        <strong>‚û°Ô∏è ${esc(nextStep.name)}</strong>
                                        ${distKm ? ` ‚Äî ${Math.round(distKm)} ${t('km')}` : ''}
                                        ${driveMin ? ` ‚Ä¢ ${formatTime(driveMin)}` : ''}
                                        ${step.roadType ? generateRoadTypeBadge(step.roadType, t) : ''}
                                    </div>
                                ` : ''}
                                
                                ${!isLastPage ? `<div class="next-step-info" style="margin-top:auto;"><em>‚Üí ${t('nextPage')}</em></div>` : ''}
                            </div>
                        </div>
                        `;
                        
                        currentPage++;
                        
                        // S√©curit√©: max 5 pages par √©tape
                        if (currentPage > 5) {
                            console.warn(`[CARNET] √âtape ${idx}: trop de contenu, tronqu√© √† 5 pages`);
                            break;
                        }
                    }
                }
            });
            
            container.innerHTML = html;
            
            // === CHARGEMENT H√îTELS POST-RENDER ===
            if (typeof ORT_HOTELS !== 'undefined') {
                document.querySelectorAll('[data-hotel-place-id]').forEach(div => {
                    const placeId = div.dataset.hotelPlaceId;
                    const name = div.dataset.hotelName;
                    const lat = parseFloat(div.dataset.hotelLat) || null;
                    const lon = parseFloat(div.dataset.hotelLon) || null;
                    const coords = div.dataset.hotelCoords ? JSON.parse(div.dataset.hotelCoords) : null;
                    const containerId = div.id;
                    
                    if (!placeId) return;
                    
                    ORT_HOTELS.loadHotelsForPlace(placeId).then(placeData => {
                        if (placeData && placeData.hotels && placeData.hotels.length > 0) {
                            ORT_HOTELS.renderHotelsCarousel(placeData.hotels, name, coords || [lat, lon], containerId);
                        }
                    }).catch(err => console.log('[EDITOR-HOTELS] Erreur:', err));
                });
            }
            
            // Stocker photos pour carrousel
            window._photos = {
                cover: coverPhotos,
                cover_idx: tripData.coverPhotoIdx || 0
            };
            steps.forEach((st, i) => {
                let stepPhotos = getPhotos(st);
                if (stepPhotos.length === 0) {
                    stepPhotos = [allPhotos[i % allPhotos.length]];
                }
                window._photos[i] = stepPhotos;
                window._photos[i + '_idx'] = st.selectedPhotoIdx || 0;
            });
        }
        
        // ===== CARROUSEL =====
        window.changePhoto = function(key, dir) {
            const photos = window._photos[key];
            if (!photos || photos.length <= 1) return;
            
            const idxKey = key + '_idx';
            let idx = window._photos[idxKey] || 0;
            idx = (idx + dir + photos.length) % photos.length;
            window._photos[idxKey] = idx;
            
            const imgId = key === 'cover' ? 'coverImg' : `stepImg${key}`;
            const counterId = key === 'cover' ? 'coverCounter' : `stepCounter${key}`;
            
            const img = document.getElementById(imgId);
            const counter = document.getElementById(counterId);
            
            if (img) img.src = window.optimizeImg(photos[idx]);
            if (counter) counter.textContent = `${idx + 1}/${photos.length}`;
            
            // Sauvegarder s√©lection dans tripData (pour l'impression)
            if (key === 'cover') {
                tripData.coverPhotoIdx = idx;
            } else {
                tripData.steps[key].selectedPhotoIdx = idx;
                tripData.steps[key].photo = photos[idx];
            }
        };
        
        // ===== AJOUTER ITEM =====
        window.addItem = function(stepIdx, field) {
            const ul = document.getElementById(field + stepIdx);
            if (!ul) return;
            
            const li = document.createElement('li');
            li.contentEditable = 'true';
            li.dataset.step = stepIdx;
            li.dataset.field = field;
            li.dataset.idx = ul.children.length;
            li.textContent = field === 'visits' ? 'Nouveau lieu...' : 'Nouvelle activit√©...';
            
            li.addEventListener('input', handleInput);
            ul.appendChild(li);
            li.focus();
            document.execCommand('selectAll', false, null);
        };
        
        // ===== EVENTS =====
        function setupEvents() {
            document.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.addEventListener('input', handleInput);
            });
            
            // Handler fermer commun
            const handleClose = () => {
                const cc = tripData.cc || tripData.country || '';
                const itin = tripData.itin || tripData._originalItinId || '';
                const tid = tripId || tripData._dashboardTripId || tripData.id || '';
                
                // Mode Dashboard (avec tripId)
                if (tid && tid.startsWith('trip_')) {
                    const url = `roadtrip_detail.html?tripId=${encodeURIComponent(tid)}&lang=${LANG}`;
                    console.log('[CARNET] Retour mode Dashboard:', url);
                    window.location.href = url;
                }
                // Mode catalogue (avec cc/itin)
                else if (cc && itin) {
                    const url = `roadtrip_detail.html?cc=${cc}&itin=${encodeURIComponent(itin)}&lang=${LANG}`;
                    console.log('[CARNET] Retour mode catalogue:', url);
                    window.location.href = url;
                } else {
                    window.close();
                    setTimeout(() => { window.location.href = '/'; }, 100);
                }
            };
            
            // Desktop toolbar
            document.getElementById('btnClose').onclick = handleClose;
            document.getElementById('btnCopyLink').onclick = copyShareLink;
            document.getElementById('btnModify').onclick = openModifyPage;
            document.getElementById('btnPrint').onclick = printBook;
            
            // Mobile FAB et menu
            const fab = document.getElementById('mobileFab');
            const menu = document.getElementById('mobileMenu');
            
            fab.onclick = () => {
                menu.classList.toggle('open');
                fab.textContent = menu.classList.contains('open') ? '‚úï' : '‚ò∞';
            };
            
            // Fermer menu si clic ailleurs
            document.addEventListener('click', (e) => {
                if (!fab.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.remove('open');
                    fab.textContent = '‚ò∞';
                }
            });
            
            // Actions menu mobile
            document.getElementById('mobileModify').onclick = () => {
                menu.classList.remove('open');
                fab.textContent = '‚ò∞';
                openModifyPage();
            };
            document.getElementById('mobileCopyLink').onclick = () => {
                menu.classList.remove('open');
                fab.textContent = '‚ò∞';
                copyShareLink();
            };
            document.getElementById('mobilePrint').onclick = () => {
                menu.classList.remove('open');
                fab.textContent = '‚ò∞';
                printBook();
            };
            document.getElementById('mobileClose').onclick = () => {
                menu.classList.remove('open');
                handleClose();
            };
        }
        
        function handleInput(e) {
            const el = e.target;
            const field = el.dataset.field;
            const stepIdx = el.dataset.step;
            const idx = el.dataset.idx;
            const text = el.textContent.trim();
            
            if (field === 'title') {
                tripData.title = text;
                document.getElementById('toolbarTitle').textContent = text;
            } else if (stepIdx !== undefined) {
                const step = tripData.steps[parseInt(stepIdx)];
                if (field === 'name') {
                    step.name = text;
                } else if (field === 'visits' && idx !== undefined) {
                    if (!step.visits) step.visits = [];
                    step.visits[parseInt(idx)] = text;
                } else if (field === 'activities' && idx !== undefined) {
                    if (!step.activities) step.activities = [];
                    step.activities[parseInt(idx)] = text;
                }
            }
        }
        
        // ===== COPIER LE LIEN (avec modal) =====
        function copyShareLink() {
            // Utiliser ORT_SHARE pour cr√©er un lien vraiment partageable
            if (typeof ORT_SHARE === 'undefined') {
                alert('Module de partage non disponible');
                return;
            }

            // Cr√©er le partage avec les donn√©es actuelles
            ORT_SHARE.createShareLink(tripData, tripData.title || 'Voyage').then(result => {
                if (!result) {
                    alert('Erreur lors de la cr√©ation du lien');
                    return;
                }

                const shareUrl = result.shareUrl;

                // Cr√©er la modal de partage
                const overlay = document.createElement('div');
                overlay.className = 'share-modal-overlay';
                overlay.innerHTML = `
                    <div class="share-modal">
                        <div class="share-modal-header">
                            <h3>üîó ${t('shareLink')}</h3>
                        </div>
                        <div class="share-modal-body">
                            <p style="margin-bottom: 12px; color: #666; font-size: 0.9em;">
                                ‚úÖ Lien cr√©√© - Partagez-le avec vos amis!
                            </p>
                            <div class="share-link-box">
                                <input type="text" class="share-link-input" id="shareLinkInput" value="${shareUrl}" readonly>
                                <button class="share-copy-btn" id="shareCopyBtn">${t('copyToClipboard')}</button>
                            </div>
                            <div class="share-warning">
                                üëÅÔ∏è Mode lecture seule - Les personnes qui ouvrent ce lien pourront modifier leur propre copie.
                            </div>
                        </div>
                        <div class="share-modal-footer">
                            <button class="share-close-btn" id="shareCloseBtn">${t('close')}</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                // S√©lectionner le texte
                const input = document.getElementById('shareLinkInput');
                input.select();
                
                // Bouton copier
                document.getElementById('shareCopyBtn').onclick = () => {
                    const btn = document.getElementById('shareCopyBtn');
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        btn.textContent = `‚úÖ ${t('copied')}`;
                        btn.classList.add('copied');
                        input.select();
                    }).catch(() => {
                        // Fallback
                        input.select();
                        document.execCommand('copy');
                        btn.textContent = `‚úÖ ${t('copied')}`;
                        btn.classList.add('copied');
                    });
                };
                
                // Fermer la modal
                const closeModal = () => overlay.remove();
                document.getElementById('shareCloseBtn').onclick = closeModal;
                overlay.onclick = (e) => {
                    if (e.target === overlay) closeModal();
                };
                
                // Fermer avec Escape
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            }).catch(error => {
                console.error('[SHARE] Erreur:', error);
                alert('Erreur lors de la cr√©ation du lien');
            });
        }
        
        // ===== MODIFIER (ouvrir roadtrip_detail) =====
        function openModifyPage() {
            const cc = tripData.cc || tripData.country || '';
            const itin = tripData.itin || tripData._originalItinId || '';
            const lang = LANG;
            
            if (cc && itin) {
                // Utilise ORT_TRIPID pour pr√©server le tripId
                if (window.ORT_TRIPID && tripId) {
                    window.ORT_TRIPID.store(tripId);
                    window.ORT_TRIPID.navigateTo('roadtrip_detail.html', { cc, itin });
                } else {
                    const url = `roadtrip_detail.html?cc=${cc}&itin=${encodeURIComponent(itin)}&lang=${lang}`;
                    window.open(url, '_blank');
                }
            } else {
                alert(t('cannotModify'));
            }
        }
        
        // ===== PRINT =====
        async function printBook() {
            const btn = document.getElementById('btnPrint');
            btn.innerHTML = `‚è≥ ${t('preparing')}`;
            btn.disabled = true;
            
            try {
                // Attendre chargement images
                const imgs = [...document.images];
                console.log(`[CARNET] Attente de ${imgs.length} images...`);
                
                await Promise.all(imgs.map(img => {
                    if (img.complete && img.naturalHeight > 0) return Promise.resolve();
                    return new Promise(res => {
                        img.onload = () => {
                            console.log(`[CARNET] Image charg√©e: ${img.src.substring(0, 50)}...`);
                            res();
                        };
                        img.onerror = () => {
                            console.warn(`[CARNET] Erreur image: ${img.src.substring(0, 50)}...`);
                            res();
                        };
                        // Timeout de 5s par image
                        setTimeout(res, 5000);
                    });
                }));
                
                console.log('[CARNET] Images pr√™tes, lancement impression...');
                
                // Petit d√©lai pour le rendu final
                await new Promise(r => setTimeout(r, 300));
                
                window.print();
            } catch(e) {
                console.error('[CARNET] Erreur impression:', e);
            } finally {
                btn.innerHTML = `üñ®Ô∏è ${t('printPdf')}`;
                btn.disabled = false;
            }
        }
        
        // ===== UTILS =====
        function esc(s) {
            if (!s) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
        
        function formatTime(min) {
            if (!min) return '';
            const h = Math.floor(min / 60);
            const m = min % 60;
            return h > 0 ? (m > 0 ? `${h}h${String(m).padStart(2,'0')}` : `${h}h`) : `${m}min`;
        }
        
        function getCountryName(iso) {
            try {
                return new Intl.DisplayNames(['fr'], { type: 'region' }).of(iso.toUpperCase());
            } catch { return iso; }
        }
        
        function generateId() {
            return `trip_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
        }
        
        // ===== START =====
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>

<!-- SCRIPTS H√îTELS -->
<script src="/js/ort-hotels.js"></script>
<script src="js/ort-env-score.js"></script>
<link rel="stylesheet" href="/css/ort-hotels.css">

</body>
</html>