<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet de Voyage ‚Äî OneRoadTrip</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            color: #333;
            background: #f5f5f5;
        }

        /* ===========================================
           STYLES √âCRAN (mode √©dition)
           =========================================== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
        }

        /* Toolbar fixe */
        .toolbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #113f7a;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .toolbar-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }
        .toolbar-logo img { height: 36px; }
        .toolbar-title {
            font-weight: 700;
            font-size: 1rem;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .toolbar-spacer { flex: 1; }
        .toolbar-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .toolbar-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .toolbar-btn.primary {
            background: white;
            color: #113f7a;
            border-color: white;
        }
        .toolbar-btn.primary:hover {
            background: #f0f0f0;
        }
        
        /* ===== MOBILE RESPONSIVE ===== */
        
        /* Bouton flottant mobile (cach√© par d√©faut) */
        .mobile-fab {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #113f7a;
            color: white;
            border: none;
            box-shadow: 0 4px 16px rgba(17,63,122,0.4);
            font-size: 1.4rem;
            cursor: pointer;
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .mobile-fab:active {
            transform: scale(0.95);
        }
        
        /* Menu mobile (cach√© par d√©faut) */
        .mobile-menu {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            overflow: hidden;
            z-index: 100;
            min-width: 180px;
        }
        .mobile-menu.open {
            display: block;
            animation: slideUp 0.2s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .mobile-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            border: none;
            background: white;
            color: #113f7a;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .mobile-menu-item:last-child {
            border-bottom: none;
        }
        .mobile-menu-item:active {
            background: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            /* Cacher la toolbar desktop */
            .toolbar {
                display: none !important;
            }
            
            /* Afficher le FAB mobile */
            .mobile-fab {
                display: flex;
            }
            
            /* Container pleine largeur */
            .container {
                padding: 0;
                max-width: 100%;
            }
            
            /* Pages responsive */
            .page {
                border-radius: 0;
                margin: 0 0 8px 0;
                box-shadow: none;
                border-bottom: 1px solid #e5e7eb;
            }
            
            /* Cover page mobile */
            .cover-page {
                min-height: auto;
            }
            .cover-hero {
                height: 50vh;
                min-height: 280px;
            }
            .cover-title {
                font-size: 1.6rem !important;
                padding: 0 16px;
            }
            .cover-stats {
                padding: 16px;
                gap: 20px;
            }
            .stat-number {
                font-size: 2rem;
            }
            
            /* Summary page mobile */
            .summary-page {
                padding: 20px 16px;
            }
            .steps-list {
                columns: 1;
            }
            
            /* Boutons carrousel adapt√©s mobile */
            .carousel-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            /* Cacher les boutons d'ajout sur mobile */
            .add-item-btn {
                display: none;
            }
        }
        
        /* ===== MOBILE PORTRAIT : Layout vertical ===== */
        @media (max-width: 768px) and (orientation: portrait) {
            .step-page {
                flex-direction: column;
                min-height: auto;
            }
            .step-photo {
                width: 100% !important;
                height: 35vh;
                min-height: 200px;
            }
            .step-content {
                width: 100% !important;
                padding: 16px;
            }
            .step-title {
                font-size: 1.4rem;
            }
            .day-badge {
                font-size: 12px;
            }
            .section-title {
                font-size: 1rem;
            }
            .section-items li {
                font-size: 0.95rem;
            }
        }
        
        /* ===== MOBILE PAYSAGE : Layout horizontal ===== */
        @media (max-width: 900px) and (orientation: landscape) {
            .step-page {
                flex-direction: row;
                min-height: auto;
            }
            .step-photo {
                width: 40%;
                min-width: 150px;
                height: auto;
                min-height: 180px;
            }
            .step-content {
                width: 60%;
                padding: 14px;
            }
            .step-title {
                font-size: 1.1rem;
            }
            .day-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
            .section-title {
                font-size: 0.85rem;
            }
            .section-items li {
                font-size: 0.85rem;
                padding: 3px 0;
            }
            .next-step-info {
                font-size: 0.8rem;
                padding: 8px;
            }
            
            /* Cover en paysage */
            .cover-hero {
                height: 60vh;
            }
            .cover-stats {
                padding: 12px;
            }
            .stat-number {
                font-size: 1.8rem;
            }
        }
        
        /* ===== TR√àS PETIT √âCRAN (portrait) ===== */
        @media (max-width: 400px) and (orientation: portrait) {
            .cover-hero {
                height: 35vh;
                min-height: 180px;
            }
            .cover-title {
                font-size: 1.2rem !important;
            }
            .step-photo {
                height: 30vh;
                min-height: 150px;
            }
            .step-content {
                padding: 12px;
            }
            .step-title {
                font-size: 1.1rem;
            }
            .section-items li {
                font-size: 0.8rem;
            }
            .stat-number {
                font-size: 1.5rem;
            }
        }

        /* Boutons d'√©dition */
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .carousel-btn:hover { background: white; }
        .carousel-btn.prev { left: 12px; }
        .carousel-btn.next { right: 12px; }
        
        .photo-counter {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 10;
        }

        .add-item-btn {
            border: 1px dashed #ccc;
            background: transparent;
            color: #666;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 8px;
            width: 100%;
            transition: all 0.2s;
        }
        .add-item-btn:hover {
            border-color: #113f7a;
            color: #113f7a;
            background: rgba(17,63,122,0.05);
        }

        /* Structure des pages pour l'√©cran */
        .page {
            background: white;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* Page de couverture */
        .cover-page {
            text-align: center;
            position: relative;
        }

        .cover-hero {
            position: relative;
            height: 400px;
            overflow: hidden;
            background: #1a1a2e;
        }
        .cover-hero img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .cover-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        }
        .cover-title-box {
            position: absolute;
            bottom: 30px;
            left: 30px;
            right: 30px;
            text-align: left;
            color: white;
        }
        .cover-title {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .cover-subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .cover-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            padding: 25px;
            background: #f8f9fa;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #113f7a;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        /* Page r√©sum√© */
        .summary-page {
            padding: 30px;
        }

        .summary-title {
            font-size: 1.6em;
            font-weight: bold;
            color: #113f7a;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #113f7a;
        }

        .steps-list {
            list-style: none;
            columns: 2;
            column-gap: 30px;
        }

        .steps-list li {
            margin-bottom: 12px;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .step-summary {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-marker {
            width: 36px;
            height: 36px;
            background: #113f7a;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .step-summary-content {
            flex: 1;
        }

        .step-name {
            font-weight: 600;
            color: #333;
        }

        .step-nights {
            font-size: 0.85em;
            color: #666;
        }

        .step-distance {
            font-size: 0.8em;
            color: #888;
        }

        /* Pages √©tapes */
        .step-page {
            display: flex;
            min-height: 500px;
        }

        .step-photo {
            width: 50%;
            min-height: 500px;
            position: relative;
            overflow: hidden;
            background: #eee;
        }

        .step-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .step-no-photo {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #ccc;
            background: #f0f0f0;
        }

        .step-content {
            width: 50%;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .day-badge {
            display: inline-block;
            background: #113f7a;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 15px;
        }

        .step-title {
            font-size: 1.6em;
            font-weight: bold;
            color: #113f7a;
            margin-bottom: 20px;
        }

        .section-block {
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: 600;
            color: #113f7a;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .section-items {
            list-style: none;
            padding: 0;
        }

        .section-items li {
            padding: 6px 0 6px 20px;
            position: relative;
            font-size: 0.95em;
        }

        .section-items li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 5px;
            color: #113f7a;
        }

        .next-step-info {
            margin-top: auto;
            padding: 12px 15px;
            background: #f8f9fa;
            border-left: 4px solid #113f7a;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        .loading-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Modal de partage */
        .share-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .share-modal {
            background: linear-gradient(135deg, #113f7a 0%, #1a5298 100%);
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .share-modal-header {
            background: url('/assets/image_index.webp') center/cover;
            padding: 30px 25px;
            position: relative;
        }
        .share-modal-header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(17,63,122,0.85), rgba(17,63,122,0.7));
        }
        .share-modal-header h3 {
            position: relative;
            color: white;
            margin: 0;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .share-modal-body {
            padding: 25px;
            background: white;
        }
        .share-link-box {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        .share-link-input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 13px;
            color: #334155;
            background: #f8fafc;
        }
        .share-link-input:focus {
            outline: none;
            border-color: #113f7a;
        }
        .share-copy-btn {
            padding: 12px 20px;
            background: #113f7a;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .share-copy-btn:hover {
            background: #0d2f5c;
        }
        .share-copy-btn.copied {
            background: #16a34a;
        }
        .share-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 10px;
            padding: 14px;
            font-size: 13px;
            color: #92400e;
            line-height: 1.5;
        }
        .share-modal-footer {
            padding: 16px 25px;
            background: #f8fafc;
            text-align: right;
        }
        .share-close-btn {
            padding: 10px 24px;
            background: transparent;
            color: #64748b;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .share-close-btn:hover {
            background: #f1f5f9;
            color: #334155;
        }

        /* ===========================================
           STYLES IMPRESSION (A4 paysage)
           =========================================== */
        @page {
            size: A4 landscape;
            margin: 0;
        }

        @media print {
            /* Masquer √©l√©ments non imprimables */
            .toolbar,
            .carousel-btn,
            .photo-counter,
            .add-item-btn,
            .share-modal-overlay,
            .no-print {
                display: none !important;
            }

            /* Reset body */
            html, body {
                width: 297mm;
                height: 210mm;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .container {
                max-width: none !important;
                width: 297mm !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            /* ===========================================
               CHAQUE PAGE = UNE FEUILLE A4 PAYSAGE
               =========================================== */
            .page {
                width: 297mm !important;
                height: 210mm !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                page-break-after: always !important;
                page-break-inside: avoid !important;
            }
            .page:last-child {
                page-break-after: auto !important;
            }

            /* ===========================================
               PAGE COUVERTURE
               =========================================== */
            .cover-page {
                display: flex !important;
                flex-direction: column !important;
                width: 297mm !important;
                height: 210mm !important;
            }

            .cover-hero {
                flex: 1 !important;
                width: 100% !important;
                min-height: 0 !important;
                position: relative !important;
            }

            .cover-hero img {
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
            }

            .cover-title-box {
                position: absolute !important;
                bottom: 20px !important;
                left: 25px !important;
                right: 25px !important;
            }

            .cover-title {
                font-size: 28pt !important;
                line-height: 1.2 !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 100% !important;
            }

            .cover-subtitle {
                font-size: 14pt !important;
            }

            .cover-stats {
                flex-shrink: 0 !important;
                height: 25mm !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                gap: 50px !important;
                background: #f8f9fa !important;
                padding: 0 !important;
            }

            .stat-item {
                text-align: center !important;
            }

            .stat-number {
                font-size: 24pt !important;
                font-weight: bold !important;
                color: #113f7a !important;
            }

            .stat-label {
                font-size: 10pt !important;
                color: #666 !important;
            }

            /* ===========================================
               PAGE R√âSUM√â
               =========================================== */
            .summary-page {
                width: 297mm !important;
                height: 210mm !important;
                padding: 15mm 20mm !important;
            }

            .summary-title {
                font-size: 18pt !important;
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
            }

            .steps-list {
                columns: 2 !important;
                column-gap: 20mm !important;
            }

            .steps-list li {
                margin-bottom: 8px !important;
                font-size: 10pt !important;
            }

            .step-marker {
                width: 28px !important;
                height: 28px !important;
                font-size: 9pt !important;
                background: #113f7a !important;
                color: white !important;
            }

            .step-name {
                font-size: 12pt !important;
            }

            .step-nights {
                font-size: 10pt !important;
            }

            .step-distance {
                font-size: 10pt !important;
            }

            /* ===========================================
               PAGES √âTAPES - PHOTO GAUCHE / TEXTE DROITE
               =========================================== */
            .step-page {
                width: 297mm !important;
                height: 210mm !important;
                display: flex !important;
                flex-direction: row !important;
                overflow: hidden !important;
            }

            .step-photo {
                width: 148.5mm !important;
                height: 210mm !important;
                flex: none !important;
                overflow: hidden !important;
            }

            .step-photo img {
                width: 148.5mm !important;
                height: 210mm !important;
                object-fit: cover !important;
            }

            .step-no-photo {
                width: 148.5mm !important;
                height: 210mm !important;
            }

            .step-content {
                width: 148.5mm !important;
                height: 210mm !important;
                flex: none !important;
                padding: 12mm 15mm !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
            }

            .day-badge {
                font-size: 10pt !important;
                padding: 4px 10px !important;
                margin-bottom: 8px !important;
                background: rgba(17,63,122,0.1) !important;
                color: #113f7a !important;
            }

            .step-title {
                font-size: 18pt !important;
                margin-bottom: 12px !important;
                color: #113f7a !important;
                line-height: 1.2 !important;
            }

            .section-block {
                margin-bottom: 10px !important;
                flex-shrink: 0 !important;
            }

            .section-title {
                font-size: 10pt !important;
                margin-bottom: 6px !important;
                color: #113f7a !important;
            }

            .section-items {
                margin: 0 !important;
                padding: 0 !important;
            }

            .section-items li {
                font-size: 9pt !important;
                line-height: 1.35 !important;
                padding: 2px 0 2px 14px !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: block !important;
            }

            .section-items li:before {
                font-size: 9pt !important;
            }

            .next-step-info {
                margin-top: auto !important;
                padding: 8px 12px !important;
                font-size: 9pt !important;
                background: #f8f9fa !important;
                border-left: 3px solid #113f7a !important;
                flex-shrink: 0 !important;
            }

            /* Emp√™cher coupures */
            * {
                page-break-inside: avoid !important;
            }
        }
    </style>
</head>
<body>
    <!-- Toolbar (cach√©e √† l'impression) -->
    <div class="toolbar no-print">
        <a href="/" class="toolbar-logo">
            <img src="/assets/symbol.webp" alt="ORT">
        </a>
        <span class="toolbar-title" id="toolbarTitle">Mon carnet de voyage</span>
        <div class="toolbar-spacer"></div>
        <button class="toolbar-btn" id="btnClose">‚úï Fermer</button>
        <button class="toolbar-btn" id="btnCopyLink">üîó Copier le lien</button>
        <button class="toolbar-btn" id="btnModify">‚úèÔ∏è Modifier</button>
        <button class="toolbar-btn primary" id="btnPrint">üñ®Ô∏è Imprimer / PDF</button>
    </div>
    
    <!-- Mobile FAB et menu -->
    <button class="mobile-fab" id="mobileFab">‚ò∞</button>
    <div class="mobile-menu" id="mobileMenu">
        <button class="mobile-menu-item" id="mobileModify">‚úèÔ∏è <span data-mobile-i18n="modify">Modifier</span></button>
        <button class="mobile-menu-item" id="mobileCopyLink">üîó <span data-mobile-i18n="copyLink">Copier le lien</span></button>
        <button class="mobile-menu-item" id="mobilePrint">üñ®Ô∏è <span data-mobile-i18n="printPdf">Imprimer / PDF</span></button>
        <button class="mobile-menu-item" id="mobileClose">‚úï <span data-mobile-i18n="close">Fermer</span></button>
    </div>

    <div class="container" id="container">
        <div class="loading">
            <div class="loading-icon">‚è≥</div>
            <div>Chargement du carnet...</div>
        </div>
    </div>

    <script src="/js/ort-config.js"></script>
<script src="/js/ort-tripid.js"></script>
    <script src="/js/ort-state-manager.js"></script>
    <script>
    (function() {
        'use strict';
        
        let tripData = null;
        let tripId = null;
        let urlParams = null;
        let photosCache = {};
        let LANG = 'fr';
        
        // ===== TRADUCTIONS I18N (6 langues) =====
        const I18N = {
            fr: {
                myTravelBook: "Mon carnet de voyage",
                close: "Fermer",
                copyLink: "Copier le lien",
                linkCopied: "Lien copi√© !",
                modify: "Modifier",
                printPdf: "Imprimer / PDF",
                preparing: "Pr√©paration...",
                loading: "Chargement du carnet...",
                noData: "Aucune donn√©e de voyage trouv√©e.",
                backHome: "Retour √† l'accueil",
                days: "Jours",
                steps: "√âtapes",
                km: "km",
                itinerary: "Itin√©raire",
                night: "nuit",
                nights: "nuits",
                day: "Jour",
                toDiscover: "√Ä d√©couvrir",
                activities: "Activit√©s",
                addPlace: "+ Ajouter un lieu",
                addActivity: "+ Ajouter une activit√©",
                cannotShare: "Ce carnet ne peut pas √™tre partag√© via lien.",
                cannotModify: "Ce carnet ne peut pas √™tre modifi√©.",
                shareLink: "Partager ce carnet",
                copyToClipboard: "Copier",
                shareWarning: "‚ö†Ô∏è Si vous n'avez pas sauvegard√© votre voyage dans le dashboard, le destinataire ne verra pas vos modifications.",
                copied: "Copi√© !"
            },
            en: {
                myTravelBook: "My travel book",
                close: "Close",
                copyLink: "Copy link",
                linkCopied: "Link copied!",
                modify: "Modify",
                printPdf: "Print / PDF",
                preparing: "Preparing...",
                loading: "Loading travel book...",
                noData: "No travel data found.",
                backHome: "Back to home",
                days: "Days",
                steps: "Steps",
                km: "km",
                itinerary: "Itinerary",
                night: "night",
                nights: "nights",
                day: "Day",
                toDiscover: "To discover",
                activities: "Activities",
                addPlace: "+ Add a place",
                addActivity: "+ Add an activity",
                cannotShare: "This book cannot be shared via link.",
                cannotModify: "This book cannot be modified.",
                shareLink: "Share this travel book",
                copyToClipboard: "Copy",
                shareWarning: "‚ö†Ô∏è If you haven't saved your trip to the dashboard, the recipient won't see your changes.",
                copied: "Copied!"
            },
            es: {
                myTravelBook: "Mi cuaderno de viaje",
                close: "Cerrar",
                copyLink: "Copiar enlace",
                linkCopied: "¬°Enlace copiado!",
                modify: "Modificar",
                printPdf: "Imprimir / PDF",
                preparing: "Preparando...",
                loading: "Cargando cuaderno de viaje...",
                noData: "No se encontraron datos del viaje.",
                backHome: "Volver al inicio",
                days: "D√≠as",
                steps: "Etapas",
                km: "km",
                itinerary: "Itinerario",
                night: "noche",
                nights: "noches",
                day: "D√≠a",
                toDiscover: "Por descubrir",
                activities: "Actividades",
                addPlace: "+ A√±adir un lugar",
                addActivity: "+ A√±adir una actividad",
                cannotShare: "Este cuaderno no se puede compartir por enlace.",
                cannotModify: "Este cuaderno no se puede modificar.",
                shareLink: "Compartir este cuaderno",
                copyToClipboard: "Copiar",
                shareWarning: "‚ö†Ô∏è Si no has guardado tu viaje en el dashboard, el destinatario no ver√° tus cambios.",
                copied: "¬°Copiado!"
            },
            it: {
                myTravelBook: "Il mio diario di viaggio",
                close: "Chiudi",
                copyLink: "Copia link",
                linkCopied: "Link copiato!",
                modify: "Modifica",
                printPdf: "Stampa / PDF",
                preparing: "Preparazione...",
                loading: "Caricamento diario di viaggio...",
                noData: "Nessun dato di viaggio trovato.",
                backHome: "Torna alla home",
                days: "Giorni",
                steps: "Tappe",
                km: "km",
                itinerary: "Itinerario",
                night: "notte",
                nights: "notti",
                day: "Giorno",
                toDiscover: "Da scoprire",
                activities: "Attivit√†",
                addPlace: "+ Aggiungi un luogo",
                addActivity: "+ Aggiungi un'attivit√†",
                cannotShare: "Questo diario non pu√≤ essere condiviso tramite link.",
                cannotModify: "Questo diario non pu√≤ essere modificato.",
                shareLink: "Condividi questo diario",
                copyToClipboard: "Copia",
                shareWarning: "‚ö†Ô∏è Se non hai salvato il viaggio nella dashboard, il destinatario non vedr√† le tue modifiche.",
                copied: "Copiato!"
            },
            pt: {
                myTravelBook: "Meu di√°rio de viagem",
                close: "Fechar",
                copyLink: "Copiar link",
                linkCopied: "Link copiado!",
                modify: "Modificar",
                printPdf: "Imprimir / PDF",
                preparing: "Preparando...",
                loading: "Carregando di√°rio de viagem...",
                noData: "Nenhum dado de viagem encontrado.",
                backHome: "Voltar ao in√≠cio",
                days: "Dias",
                steps: "Etapas",
                km: "km",
                itinerary: "Itiner√°rio",
                night: "noite",
                nights: "noites",
                day: "Dia",
                toDiscover: "Para descobrir",
                activities: "Atividades",
                addPlace: "+ Adicionar um lugar",
                addActivity: "+ Adicionar uma atividade",
                cannotShare: "Este di√°rio n√£o pode ser compartilhado por link.",
                cannotModify: "Este di√°rio n√£o pode ser modificado.",
                shareLink: "Compartilhar este di√°rio",
                copyToClipboard: "Copiar",
                shareWarning: "‚ö†Ô∏è Se voc√™ n√£o salvou sua viagem no dashboard, o destinat√°rio n√£o ver√° suas altera√ß√µes.",
                copied: "Copiado!"
            },
            ar: {
                myTravelBook: "ÿØŸÅÿ™ÿ± ÿ≥ŸÅÿ±Ÿä",
                close: "ÿ•ÿ∫ŸÑÿßŸÇ",
                copyLink: "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
                linkCopied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑!",
                modify: "ÿ™ÿπÿØŸäŸÑ",
                printPdf: "ÿ∑ÿ®ÿßÿπÿ© / PDF",
                preparing: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±...",
                loading: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿØŸÅÿ™ÿ± ÿßŸÑÿ≥ŸÅÿ±...",
                noData: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ŸÅÿ±.",
                backHome: "ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
                days: "ÿ£ŸäÿßŸÖ",
                steps: "ŸÖÿ±ÿßÿ≠ŸÑ",
                km: "ŸÉŸÖ",
                itinerary: "ÿÆÿ∑ ÿßŸÑÿ≥Ÿäÿ±",
                night: "ŸÑŸäŸÑÿ©",
                nights: "ŸÑŸäÿßŸÑŸä",
                day: "ÿßŸÑŸäŸàŸÖ",
                toDiscover: "ŸÑŸÑÿßŸÉÿ™ÿ¥ÿßŸÅ",
                activities: "ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©",
                addPlace: "+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÉÿßŸÜ",
                addActivity: "+ ÿ•ÿ∂ÿßŸÅÿ© ŸÜÿ¥ÿßÿ∑",
                cannotShare: "ŸÑÿß ŸäŸÖŸÉŸÜ ŸÖÿ¥ÿßÿ±ŸÉÿ© Ÿáÿ∞ÿß ÿßŸÑÿØŸÅÿ™ÿ± ÿπÿ®ÿ± ÿßŸÑÿ±ÿßÿ®ÿ∑.",
                cannotModify: "ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿπÿØŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿØŸÅÿ™ÿ±.",
                shareLink: "ŸÖÿ¥ÿßÿ±ŸÉÿ© Ÿáÿ∞ÿß ÿßŸÑÿØŸÅÿ™ÿ±",
                copyToClipboard: "ŸÜÿ≥ÿÆ",
                shareWarning: "‚ö†Ô∏è ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ÿ≠ŸÅÿ∏ ÿ±ÿ≠ŸÑÿ™ŸÉ ŸÅŸä ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖÿå ŸÅŸÑŸÜ Ÿäÿ±Ÿâ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ ÿ™ÿπÿØŸäŸÑÿßÿ™ŸÉ.",
                copied: "ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!"
            }
        };
        
        // Fonction de traduction
        function t(key) {
            return I18N[LANG]?.[key] || I18N.fr[key] || key;
        }
        
        // Images de fallback pour les √©tapes sans photo
        const FALLBACK_IMAGES = [
            'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=800&q=80', // Van sur route
            'https://images.unsplash.com/photo-1527786356703-4b100091cd2c?w=800&q=80', // Campervan
            'https://images.unsplash.com/photo-1502920917128-1aa500764cbd?w=800&q=80', // Route scenic
            'https://images.unsplash.com/photo-1533105079780-92b9be482077?w=800&q=80', // Road trip
            'https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800&q=80'  // Voyage
        ];
        
        // ===== FONCTIONS GLOBALES (expos√©es pour onerror) =====
        
        // Optimisation d'image via proxy wsrv.nl
        window.optimizeImg = function(url, w = 1200) {
            if (!url) return '';
            // D√©j√† optimis√©
            if (url.includes('wsrv.nl')) return url;
            // Wikimedia/Wikipedia - ne pas proxifier
            if (url.includes('wikimedia.org') || url.includes('wikipedia.org')) return url;
            // Unsplash - d√©j√† optimis√© avec param√®tres
            if (url.includes('unsplash.com') && url.includes('?')) return url;
            // URL locale - ne pas proxifier (wsrv.nl ne peut pas y acc√©der)
            if (url.startsWith('/') || url.startsWith('./') || url.includes('127.0.0.1') || url.includes('localhost')) {
                return url; // Retourner tel quel
            }
            // Proxifier les autres URLs
            return `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=${w}&q=85&output=webp`;
        };
        
        // Gestion erreurs images - bascule vers la suivante
        window.handleImageError = function(img, stepIdx) {
            const photos = img.dataset.photos ? JSON.parse(img.dataset.photos) : [];
            let currentIdx = parseInt(img.dataset.currentIdx || 0);
            currentIdx++;
            
            if (currentIdx < photos.length) {
                img.dataset.currentIdx = currentIdx;
                const nextPhoto = photos[currentIdx];
                img.src = window.optimizeImg(nextPhoto);
                console.log(`[IMG] Erreur sur image ${stepIdx}, essai photo ${currentIdx + 1}/${photos.length}`);
            } else {
                // Plus de photos valides, utiliser fallback
                const fallbackIdx = typeof stepIdx === 'number' ? stepIdx % FALLBACK_IMAGES.length : 0;
                img.src = FALLBACK_IMAGES[fallbackIdx];
                img.onerror = null; // √âviter boucle infinie
                console.log(`[IMG] Aucune image valide pour ${stepIdx}, fallback utilis√©`);
            }
        };
        
        // ===== CHARGEMENT DEPUIS URL (cc + itin) =====
        async function loadFromUrl() {
            urlParams = new URLSearchParams(location.search);
            const cc = urlParams.get('cc');
            const itin = urlParams.get('itin');
            const lang = urlParams.get('lang') || localStorage.getItem('lang') || 'fr';
            
            if (!cc || !itin) return null;
            
            console.log(`[CARNET] Chargement depuis URL: cc=${cc}, itin=${itin}, lang=${lang}`);
            
            // Charger le fichier itins.modules
            const basePath = `./data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc.toUpperCase()}.itins.modules`;
            let data = null;
            
            // Essayer avec la langue, puis sans
            for (const path of [`${basePath}-${lang}.json`, `${basePath}.json`]) {
                try {
                    const res = await fetch(path);
                    if (res.ok) {
                        data = await res.json();
                        console.log(`[CARNET] Fichier charg√©: ${path}`);
                        break;
                    }
                } catch(e) {}
            }
            
            if (!data) {
                console.error('[CARNET] Fichier itins.modules non trouv√©');
                return null;
            }
            
            // Trouver l'itin√©raire
            const itins = data.itineraries || data.modules || [];
            const it = itins.find(x => (x.itin_id || x.id || x.slug) === itin);
            
            if (!it) {
                console.error(`[CARNET] Itin√©raire "${itin}" non trouv√©`);
                return null;
            }
            
            // Charger le cache photos
            await loadPhotosCache();
            await loadCountryPhotos(cc);
            
            // Convertir en format tripData
            const steps = [];
            const daysPlan = it.days_plan || [];
            const places = it.places || [];
            
            if (daysPlan.length > 0) {
                for (const d of daysPlan) {
                    const pid = d.night?.place_id || '';
                    const coords = d.night?.coords || [];
                    let name = pid ? pid.split('::')[1]?.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '';
                    
                    steps.push({
                        place_id: pid,
                        name: name || d.night?.name || '√âtape',
                        lat: coords[0] || null,
                        lon: coords[1] || null,
                        nights: 1,
                        visits: Array.isArray(d.visits) ? d.visits : [],
                        activities: Array.isArray(d.activities) ? d.activities : [],
                        distanceKm: d.to_next_leg?.distance_km || 0,
                        driveMin: d.to_next_leg?.drive_min || 0,
                        photos: getPhotosForPlaceLocal(pid)
                    });
                }
            } else if (places.length > 0) {
                for (const p of places) {
                    const pid = p.place_id || p.id || '';
                    steps.push({
                        place_id: pid,
                        name: p.name || p.title || '√âtape',
                        lat: p.lat || null,
                        lon: p.lon || null,
                        nights: 1,
                        visits: p.visits || [],
                        activities: p.activities || [],
                        photos: getPhotosForPlaceLocal(pid)
                    });
                }
            }
            
            return {
                id: `${cc}::${itin}`,
                title: it.title || it.name || 'Mon roadtrip',
                country: cc.toUpperCase(),
                steps: steps,
                cc: cc.toUpperCase(),
                itin: itin
            };
        }
        
        // Photos locales (sans d√©pendance globale)
        let countryPhotosCache = {};
        
        async function loadCountryPhotos(cc) {
            try {
                const url = `./data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc.toLowerCase()}.photos.cache.json`;
                const res = await fetch(url);
                if (res.ok) {
                    countryPhotosCache = await res.json() || {};
                    console.log(`[CARNET] Photos pays charg√©es: ${Object.keys(countryPhotosCache).length} lieux`);
                }
            } catch(e) {}
        }
        
        function getPhotosForPlaceLocal(placeId) {
            if (!placeId) return [];
            const photos = [];
            
            // Depuis photosCache global
            if (photosCache[placeId]?.photos) {
                photos.push(...photosCache[placeId].photos);
            }
            
            // Depuis countryPhotosCache
            if (countryPhotosCache[placeId]?.photos) {
                countryPhotosCache[placeId].photos.forEach(p => {
                    if (!photos.includes(p)) photos.push(p);
                });
            }
            
            return photos.filter(p => p && typeof p === 'string');
        }
        
        // ===== MISE √Ä JOUR TOOLBAR I18N =====
        function updateToolbarLabels() {
            // Desktop toolbar
            document.getElementById('toolbarTitle').textContent = t('myTravelBook');
            document.getElementById('btnClose').innerHTML = `‚úï ${t('close')}`;
            document.getElementById('btnCopyLink').innerHTML = `üîó ${t('copyLink')}`;
            document.getElementById('btnModify').innerHTML = `‚úèÔ∏è ${t('modify')}`;
            document.getElementById('btnPrint').innerHTML = `üñ®Ô∏è ${t('printPdf')}`;
            
            // Mobile menu
            document.querySelectorAll('[data-mobile-i18n]').forEach(el => {
                const key = el.dataset.mobileI18n;
                if (key && t(key)) {
                    el.textContent = t(key);
                }
            });
            
            // Mettre √† jour le message de chargement
            const loadingDiv = document.querySelector('.loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="loading-icon">‚è≥</div>
                    <div>${t('loading')}</div>
                `;
            }
            
            // Direction RTL pour l'arabe
            if (LANG === 'ar') {
                document.documentElement.dir = 'rtl';
            }
        }
        
        // ===== INIT =====
        async function init() {
            console.log('[CARNET] Initialisation...');
            
            // D√©tecter la langue
            urlParams = new URLSearchParams(location.search);
            LANG = urlParams.get('lang') || localStorage.getItem('lang') || 'fr';
            if (!I18N[LANG]) LANG = 'fr';
            console.log(`[CARNET] Langue: ${LANG}`);
            
            // Mettre √† jour la toolbar avec les traductions
            updateToolbarLabels();
            
            // 1) Essayer sessionStorage (depuis roadtrip_detail.html)
            const stored = sessionStorage.getItem('ort_editor_trip');
            if (stored) {
                tripData = JSON.parse(stored);
                tripId = tripData.id || generateId();
                tripData.id = tripId;
                console.log('[CARNET] Donn√©es depuis sessionStorage');
                
                // Debug: afficher les nuits de chaque √©tape
                const nightsDebug = tripData.steps.map((s, i) => `${i}: ${s.name} = ${s.nights} nuit(s)`);
                console.log('[CARNET] Nuits par √©tape:', nightsDebug);
                const totalNights = tripData.steps.reduce((sum, s) => sum + (s.nights || 0), 0);
                console.log(`[CARNET] Total nuits: ${totalNights}`);
            }
            
            // 2) Sinon, charger depuis URL params (cc + itin)
            if (!tripData || !tripData.steps || tripData.steps.length === 0) {
                tripData = await loadFromUrl();
                if (tripData) {
                    tripId = tripData.id;
                    console.log('[CARNET] Donn√©es depuis URL params');
                }
            }
            
            // 3) Toujours pas de donn√©es ?
            if (!tripData || !tripData.steps || tripData.steps.length === 0) {
                document.getElementById('container').innerHTML = `
                    <div class="loading">
                        <div class="loading-icon">‚ùå</div>
                        <div>${t('noData')}</div>
                        <div style="margin-top:16px"><a href="/" style="color:#113f7a">${t('backHome')}</a></div>
                    </div>
                `;
                return;
            }
            
            // Charger cache photos
            await loadPhotosCache();
            
            // G√©n√©rer le carnet
            renderBook();
            
            // Titre
            document.getElementById('toolbarTitle').textContent = tripData.title || 'Mon carnet';
            document.title = (tripData.title || 'Carnet') + ' ‚Äî OneRoadTrip';
            
            // Events
            setupEvents();
            
            console.log('[CARNET] ‚úÖ Pr√™t');
        }
        
        // ===== PHOTOS =====
        async function loadPhotosCache() {
            try {
                const r = await fetch('./data/photos-json/photos_lieux.json', { cache: 'no-store' });
                if (r.ok) photosCache = await r.json() || {};
            } catch(e) {}
        }
        
        function getPhotos(step) {
            const photos = [];
            if (step.photo) photos.push(step.photo);
            if (step.photos?.length) photos.push(...step.photos);
            if (step.images?.length) photos.push(...step.images);
            if (step.place_id && photosCache[step.place_id]?.photos) {
                photosCache[step.place_id].photos.forEach(p => {
                    if (!photos.includes(p)) photos.push(p);
                });
            }
            // Filtrer les URLs valides (exclure les chemins locaux type /img/default)
            const validPhotos = photos.filter(p => p && typeof p === 'string' && !p.includes('default-roadtrip') && (p.startsWith('http') || p.includes('wikimedia') || p.includes('unsplash')));
            return validPhotos;
        }
        
        // ===== RENDER =====
        function renderBook() {
            const container = document.getElementById('container');
            const steps = tripData.steps;
            
            // Stats
            // totalDays = somme des nuits (pas nights || 1 qui ajoute 1 pour les √©tapes avec 0 nuits)
            const totalNights = steps.reduce((s, st) => s + (Number(st.nights) || 0), 0);
            // Jours = nuits + 1 (on arrive jour 1, on repart apr√®s les nuits)
            // Mais si totalNights vient de tripData, l'utiliser directement
            const totalDays = tripData.totalNights || totalNights || steps.length;
            const totalKm = Math.round(steps.reduce((s, st) => s + (st.to_next_leg?.distance_km || st.distanceKm || 0), 0));
            const country = tripData.country ? getCountryName(tripData.country) : '';
            
            // Compter les √©tapes uniques (lieux distincts, pas les jours)
            // Regrouper par place_id ou par nom si pas de place_id
            const uniquePlaces = new Set();
            steps.forEach(st => {
                const key = st.place_id || st.name || '';
                if (key) uniquePlaces.add(key);
            });
            const totalSteps = uniquePlaces.size || steps.length;
            
            console.log(`[CARNET] Stats: ${totalDays} jours, ${totalSteps} √©tapes, ${totalKm} km`);
            
            // Photo couverture
            let coverPhotos = getPhotos(steps[0]);
            if (coverPhotos.length === 0) {
                coverPhotos = [FALLBACK_IMAGES[0]];
            }
            const coverPhoto = coverPhotos[tripData.coverPhotoIdx || 0] || coverPhotos[0] || '';
            
            let html = `
            <!-- PAGE COUVERTURE -->
            <div class="page cover-page">
                <div class="cover-hero">
                    ${coverPhoto ? `
                        <img src="${window.optimizeImg(coverPhoto)}" alt="Couverture" id="coverImg" data-photos='${JSON.stringify(coverPhotos)}' data-current-idx="0" onerror="handleImageError(this, 'cover')">
                        ${coverPhotos.length > 1 ? `
                            <button class="carousel-btn prev no-print" onclick="changePhoto('cover',-1)">‚Äπ</button>
                            <button class="carousel-btn next no-print" onclick="changePhoto('cover',1)">‚Ä∫</button>
                            <div class="photo-counter no-print" id="coverCounter">1/${coverPhotos.length}</div>
                        ` : ''}
                    ` : '<div class="step-no-photo">üì∑</div>'}
                    <div class="cover-overlay"></div>
                    <div class="cover-title-box">
                        <h1 class="cover-title" contenteditable="true" data-field="title">${esc(tripData.title || t('myTravelBook'))}</h1>
                        <p class="cover-subtitle">${country ? 'üåç ' + country : ''}</p>
                    </div>
                </div>
                <div class="cover-stats">
                    <div class="stat-item">
                        <div class="stat-number">${totalDays}</div>
                        <div class="stat-label">${t('days')}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${totalSteps}</div>
                        <div class="stat-label">${t('steps')}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${totalKm}</div>
                        <div class="stat-label">${t('km')}</div>
                    </div>
                </div>
            </div>
            
            <!-- PAGE R√âSUM√â -->
            <div class="page summary-page">
                <h2 class="summary-title">üìç ${t('itinerary')}</h2>
                <ol class="steps-list">
                    ${steps.map((st, i) => {
                        const nights = st.nights || 1;
                        const dist = st.to_next_leg?.distance_km || st.distanceKm || 0;
                        const nightLabel = nights > 1 ? t('nights') : t('night');
                        return `
                        <li>
                            <div class="step-summary">
                                <div class="step-marker">${i + 1}</div>
                                <div class="step-summary-content">
                                    <div class="step-name">${esc(st.name)}</div>
                                    <div class="step-nights">${nights} ${nightLabel}</div>
                                    ${dist ? `<div class="step-distance">‚Üí ${Math.round(dist)} ${t('km')}</div>` : ''}
                                </div>
                            </div>
                        </li>
                        `;
                    }).join('')}
                </ol>
            </div>
            `;
            
            // Collecter TOUTES les photos du voyage pour les r√©partir
            let allPhotos = [];
            steps.forEach((st) => {
                const stepPhotos = getPhotos(st);
                stepPhotos.forEach(p => {
                    if (!allPhotos.includes(p)) allPhotos.push(p);
                });
            });
            // Ajouter les fallbacks si pas assez de photos
            if (allPhotos.length < steps.length) {
                FALLBACK_IMAGES.forEach(p => {
                    if (!allPhotos.includes(p)) allPhotos.push(p);
                });
            }
            
            // Pages √©tapes - UNE PAGE PAR √âTAPE avec photo diff√©rente
            steps.forEach((step, idx) => {
                // Utiliser une photo diff√©rente pour chaque √©tape
                // Prendre la photo √† l'index correspondant dans le pool global
                const photo = allPhotos[idx % allPhotos.length];
                
                // Photos sp√©cifiques √† cette √©tape pour le carrousel
                let stepPhotos = getPhotos(step);
                if (stepPhotos.length === 0) {
                    stepPhotos = [photo]; // Au moins la photo attribu√©e
                }
                
                const visits = step.visits || step.pois || [];
                const activities = step.activities || [];
                const nextStep = steps[idx + 1];
                const distKm = step.to_next_leg?.distance_km || step.distanceKm || 0;
                const driveMin = step.to_next_leg?.drive_min || step.driveMin || 0;
                
                html += `
                <div class="page step-page">
                    <div class="step-photo">
                        ${photo ? `
                            <img src="${window.optimizeImg(photo)}" alt="${esc(step.name)}" id="stepImg${idx}" data-photos='${JSON.stringify(stepPhotos)}' data-current-idx="0" onerror="handleImageError(this, ${idx})">
                            ${stepPhotos.length > 1 ? `
                                <button class="carousel-btn prev no-print" onclick="changePhoto(${idx},-1)">‚Äπ</button>
                                <button class="carousel-btn next no-print" onclick="changePhoto(${idx},1)">‚Ä∫</button>
                                <div class="photo-counter no-print" id="stepCounter${idx}">1/${stepPhotos.length}</div>
                            ` : ''}
                        ` : '<div class="step-no-photo">üì∑</div>'}
                    </div>
                    <div class="step-content">
                        <span class="day-badge">${t('day')} ${idx + 1}</span>
                        <h2 class="step-title" contenteditable="true" data-step="${idx}" data-field="name">${esc(step.name)}</h2>
                        
                        ${visits.length > 0 ? `
                            <div class="section-block">
                                <div class="section-title">üîç ${t('toDiscover')}</div>
                                <ul class="section-items" id="visits${idx}">
                                    ${visits.map((v, vi) => `
                                        <li contenteditable="true" data-step="${idx}" data-field="visits" data-idx="${vi}">${esc(typeof v === 'string' ? v : v.name || v.text || '')}</li>
                                    `).join('')}
                                </ul>
                                <button class="add-item-btn no-print" onclick="addItem(${idx},'visits')">${t('addPlace')}</button>
                            </div>
                        ` : ''}
                        
                        ${activities.length > 0 ? `
                            <div class="section-block">
                                <div class="section-title">üéØ ${t('activities')}</div>
                                <ul class="section-items" id="activities${idx}">
                                    ${activities.map((a, ai) => `
                                        <li contenteditable="true" data-step="${idx}" data-field="activities" data-idx="${ai}">${esc(typeof a === 'string' ? a : a.name || a.text || '')}</li>
                                    `).join('')}
                                </ul>
                                <button class="add-item-btn no-print" onclick="addItem(${idx},'activities')">${t('addActivity')}</button>
                            </div>
                        ` : ''}
                        
                        ${nextStep ? `
                            <div class="next-step-info">
                                <strong>‚û°Ô∏è ${esc(nextStep.name)}</strong>
                                ${distKm ? ` ‚Äî ${Math.round(distKm)} ${t('km')}` : ''}
                                ${driveMin ? ` ‚Ä¢ ${formatTime(driveMin)}` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Stocker photos pour carrousel
            window._photos = {
                cover: coverPhotos,
                cover_idx: tripData.coverPhotoIdx || 0
            };
            steps.forEach((st, i) => {
                let stepPhotos = getPhotos(st);
                if (stepPhotos.length === 0) {
                    stepPhotos = [allPhotos[i % allPhotos.length]];
                }
                window._photos[i] = stepPhotos;
                window._photos[i + '_idx'] = st.selectedPhotoIdx || 0;
            });
        }
        
        // ===== CARROUSEL =====
        window.changePhoto = function(key, dir) {
            const photos = window._photos[key];
            if (!photos || photos.length <= 1) return;
            
            const idxKey = key + '_idx';
            let idx = window._photos[idxKey] || 0;
            idx = (idx + dir + photos.length) % photos.length;
            window._photos[idxKey] = idx;
            
            const imgId = key === 'cover' ? 'coverImg' : `stepImg${key}`;
            const counterId = key === 'cover' ? 'coverCounter' : `stepCounter${key}`;
            
            const img = document.getElementById(imgId);
            const counter = document.getElementById(counterId);
            
            if (img) img.src = window.optimizeImg(photos[idx]);
            if (counter) counter.textContent = `${idx + 1}/${photos.length}`;
            
            // Sauvegarder s√©lection dans tripData (pour l'impression)
            if (key === 'cover') {
                tripData.coverPhotoIdx = idx;
            } else {
                tripData.steps[key].selectedPhotoIdx = idx;
                tripData.steps[key].photo = photos[idx];
            }
        };
        
        // ===== AJOUTER ITEM =====
        window.addItem = function(stepIdx, field) {
            const ul = document.getElementById(field + stepIdx);
            if (!ul) return;
            
            const li = document.createElement('li');
            li.contentEditable = 'true';
            li.dataset.step = stepIdx;
            li.dataset.field = field;
            li.dataset.idx = ul.children.length;
            li.textContent = field === 'visits' ? 'Nouveau lieu...' : 'Nouvelle activit√©...';
            
            li.addEventListener('input', handleInput);
            ul.appendChild(li);
            li.focus();
            document.execCommand('selectAll', false, null);
        };
        
        // ===== EVENTS =====
        function setupEvents() {
            document.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.addEventListener('input', handleInput);
            });
            
            // Handler fermer commun
            const handleClose = () => {
                const cc = tripData.cc || tripData.country || '';
                const itin = tripData.itin || tripData._originalItinId || '';
                
                if (cc && itin) {
                    const url = `roadtrip_detail.html?cc=${cc}&itin=${encodeURIComponent(itin)}&lang=${LANG}`;
                    window.location.href = url;
                } else {
                    window.close();
                    setTimeout(() => { window.location.href = '/'; }, 100);
                }
            };
            
            // Desktop toolbar
            document.getElementById('btnClose').onclick = handleClose;
            document.getElementById('btnCopyLink').onclick = copyShareLink;
            document.getElementById('btnModify').onclick = openModifyPage;
            document.getElementById('btnPrint').onclick = printBook;
            
            // Mobile FAB et menu
            const fab = document.getElementById('mobileFab');
            const menu = document.getElementById('mobileMenu');
            
            fab.onclick = () => {
                menu.classList.toggle('open');
                fab.textContent = menu.classList.contains('open') ? '‚úï' : '‚ò∞';
            };
            
            // Fermer menu si clic ailleurs
            document.addEventListener('click', (e) => {
                if (!fab.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.remove('open');
                    fab.textContent = '‚ò∞';
                }
            });
            
            // Actions menu mobile
            document.getElementById('mobileModify').onclick = () => {
                menu.classList.remove('open');
                fab.textContent = '‚ò∞';
                openModifyPage();
            };
            document.getElementById('mobileCopyLink').onclick = () => {
                menu.classList.remove('open');
                fab.textContent = '‚ò∞';
                copyShareLink();
            };
            document.getElementById('mobilePrint').onclick = () => {
                menu.classList.remove('open');
                fab.textContent = '‚ò∞';
                printBook();
            };
            document.getElementById('mobileClose').onclick = () => {
                menu.classList.remove('open');
                handleClose();
            };
        }
        
        function handleInput(e) {
            const el = e.target;
            const field = el.dataset.field;
            const stepIdx = el.dataset.step;
            const idx = el.dataset.idx;
            const text = el.textContent.trim();
            
            if (field === 'title') {
                tripData.title = text;
                document.getElementById('toolbarTitle').textContent = text;
            } else if (stepIdx !== undefined) {
                const step = tripData.steps[parseInt(stepIdx)];
                if (field === 'name') {
                    step.name = text;
                } else if (field === 'visits' && idx !== undefined) {
                    if (!step.visits) step.visits = [];
                    step.visits[parseInt(idx)] = text;
                } else if (field === 'activities' && idx !== undefined) {
                    if (!step.activities) step.activities = [];
                    step.activities[parseInt(idx)] = text;
                }
            }
        }
        
        // ===== COPIER LE LIEN (avec modal) =====
        function copyShareLink() {
            // Construire le lien partageable
            const cc = tripData.cc || tripData.country || '';
            const itin = tripData.itin || tripData._originalItinId || '';
            const lang = LANG;
            
            if (!cc || !itin) {
                alert(t('cannotShare'));
                return;
            }
            
            const shareUrl = `${location.origin}/roadtrip-editor.html?cc=${cc}&itin=${encodeURIComponent(itin)}&lang=${lang}`;
            
            // Cr√©er la modal
            const overlay = document.createElement('div');
            overlay.className = 'share-modal-overlay';
            overlay.innerHTML = `
                <div class="share-modal">
                    <div class="share-modal-header">
                        <h3>üîó ${t('shareLink')}</h3>
                    </div>
                    <div class="share-modal-body">
                        <div class="share-link-box">
                            <input type="text" class="share-link-input" id="shareLinkInput" value="${shareUrl}" readonly>
                            <button class="share-copy-btn" id="shareCopyBtn">${t('copyToClipboard')}</button>
                        </div>
                        <div class="share-warning">
                            ${t('shareWarning')}
                        </div>
                    </div>
                    <div class="share-modal-footer">
                        <button class="share-close-btn" id="shareCloseBtn">${t('close')}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // S√©lectionner le texte
            const input = document.getElementById('shareLinkInput');
            input.select();
            
            // Bouton copier
            document.getElementById('shareCopyBtn').onclick = () => {
                const btn = document.getElementById('shareCopyBtn');
                navigator.clipboard.writeText(shareUrl).then(() => {
                    btn.textContent = `‚úÖ ${t('copied')}`;
                    btn.classList.add('copied');
                    input.select();
                }).catch(() => {
                    // Fallback pour anciens navigateurs
                    input.select();
                    document.execCommand('copy');
                    btn.textContent = `‚úÖ ${t('copied')}`;
                    btn.classList.add('copied');
                });
            };
            
            // Fermer la modal
            const closeModal = () => overlay.remove();
            document.getElementById('shareCloseBtn').onclick = closeModal;
            overlay.onclick = (e) => {
                if (e.target === overlay) closeModal();
            };
            
            // Fermer avec Escape
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // ===== MODIFIER (ouvrir roadtrip_detail) =====
        function openModifyPage() {
            const cc = tripData.cc || tripData.country || '';
            const itin = tripData.itin || tripData._originalItinId || '';
            const lang = LANG;
            
            if (cc && itin) {
                // Utilise ORT_TRIPID pour pr√©server le tripId
                if (window.ORT_TRIPID && tripId) {
                    window.ORT_TRIPID.store(tripId);
                    window.ORT_TRIPID.navigateTo('roadtrip_detail.html', { cc, itin });
                } else {
                    const url = `roadtrip_detail.html?cc=${cc}&itin=${encodeURIComponent(itin)}&lang=${lang}`;
                    window.open(url, '_blank');
                }
            } else {
                alert(t('cannotModify'));
            }
        }
        
        // ===== PRINT =====
        async function printBook() {
            const btn = document.getElementById('btnPrint');
            btn.innerHTML = `‚è≥ ${t('preparing')}`;
            btn.disabled = true;
            
            try {
                // Attendre chargement images
                const imgs = [...document.images];
                console.log(`[CARNET] Attente de ${imgs.length} images...`);
                
                await Promise.all(imgs.map(img => {
                    if (img.complete && img.naturalHeight > 0) return Promise.resolve();
                    return new Promise(res => {
                        img.onload = () => {
                            console.log(`[CARNET] Image charg√©e: ${img.src.substring(0, 50)}...`);
                            res();
                        };
                        img.onerror = () => {
                            console.warn(`[CARNET] Erreur image: ${img.src.substring(0, 50)}...`);
                            res();
                        };
                        // Timeout de 5s par image
                        setTimeout(res, 5000);
                    });
                }));
                
                console.log('[CARNET] Images pr√™tes, lancement impression...');
                
                // Petit d√©lai pour le rendu final
                await new Promise(r => setTimeout(r, 300));
                
                window.print();
            } catch(e) {
                console.error('[CARNET] Erreur impression:', e);
            } finally {
                btn.innerHTML = `üñ®Ô∏è ${t('printPdf')}`;
                btn.disabled = false;
            }
        }
        
        // ===== UTILS =====
        function esc(s) {
            if (!s) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
        
        function formatTime(min) {
            if (!min) return '';
            const h = Math.floor(min / 60);
            const m = min % 60;
            return h > 0 ? (m > 0 ? `${h}h${String(m).padStart(2,'0')}` : `${h}h`) : `${m}min`;
        }
        
        function getCountryName(iso) {
            try {
                return new Intl.DisplayNames(['fr'], { type: 'region' }).of(iso.toUpperCase());
            } catch { return iso; }
        }
        
        function generateId() {
            return `trip_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
        }
        
        // ===== START =====
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>