<!DOCTYPE html>
<html lang="fr">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JK3QGQGDDL"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-JK3QGQGDDL');gtag('config','GT-WF83FMCX');</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OneRoadTrip - Importer une rÃ©servation</title>
<style>
:root{--bg:#113f7a;--card:#fff;--ink:#113f7a;--bd:#c3d6b6;--mut:#6b7a99;--ok:#22c55e;--warn:#f59e0b}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(rgba(17,63,122,0.85),rgba(17,63,122,0.85)),url("/assets/image_index.webp") center/cover fixed;background-color:#113f7a;color:#fff;font-family:system-ui,sans-serif;min-height:100vh}
header{background:rgba(17,63,122,0.95);border-bottom:2px solid rgba(255,255,255,0.2);padding:8px 12px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:100}
.brandlink{display:flex;align-items:center;gap:8px;color:#fff;text-decoration:none}
.brandlink img{width:28px;height:28px}
.brand{font-weight:800;font-size:1rem}
header .sp{flex:1}
.hdr-btn{padding:6px 12px;border-radius:6px;border:1px solid #fff;background:transparent;color:#fff;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all .2s}
.hdr-btn:hover{background:rgba(255,255,255,0.15)}
.wrap{max-width:1400px;margin:0 auto;padding:10px 12px 60px}
h1{margin:0 0 4px;font-size:1.2rem;text-align:center}
.subtitle{text-align:center;opacity:0.8;margin-bottom:12px;font-size:0.9rem}

/* Card */
.card{background:var(--card);color:var(--ink);border-radius:16px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.2);margin-bottom:16px}
.card-title{font-size:1.1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* Type selector */
.type-selector{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.type-btn{padding:16px;border:2px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer;text-align:center;transition:all .2s}
.type-btn:hover{border-color:var(--bg);background:#eff6ff}
.type-btn.active{border-color:var(--bg);background:#dbeafe}
.type-btn .icon{font-size:2rem;margin-bottom:8px}
.type-btn .label{font-weight:600;font-size:0.95rem}
.type-btn .hint{font-size:0.75rem;color:var(--mut);margin-top:4px}

/* Step selector */
.step-selector{margin-bottom:20px}
.step-selector label{display:block;font-weight:600;margin-bottom:8px}
.step-selector select{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;background:#fff;cursor:pointer}
.step-selector select:focus{outline:none;border-color:var(--bg)}

/* Textarea */
.email-input{margin-bottom:20px}
.email-input label{display:block;font-weight:600;margin-bottom:8px}
.email-input textarea{width:100%;height:150px;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:0.9rem;font-family:inherit;resize:vertical}
.email-input textarea:focus{outline:none;border-color:var(--bg)}
.email-input .hint{font-size:0.8rem;color:var(--mut);margin-top:6px}

/* Buttons */
.btn-row{display:flex;gap:12px;flex-wrap:wrap}
.btn{padding:12px 24px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:1rem;transition:all .2s;display:flex;align-items:center;gap:8px}
.btn-primary{background:var(--bg);color:#fff}
.btn-primary:hover{background:#0d3166}
.btn-secondary{background:#e5e7eb;color:var(--ink)}
.btn-secondary:hover{background:#d1d5db}
.btn-success{background:var(--ok);color:#fff}
.btn-success:hover{background:#16a34a}
.btn:disabled{opacity:0.5;cursor:not-allowed}

/* Manual form */
.manual-form{display:none}
.manual-form.show{display:block}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-weight:600;margin-bottom:6px;font-size:0.9rem}
.form-group input, .form-group select{width:100%;padding:10px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:0.95rem}
.form-group input:focus, .form-group select:focus{outline:none;border-color:var(--bg)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Result preview */
.result-preview{display:none;background:#f0fdf4;border:2px solid #86efac;border-radius:12px;padding:16px;margin-bottom:16px}
.result-preview.show{display:block}
.result-preview.error{background:#fef2f2;border-color:#fca5a5}
.result-title{font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.result-field{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb}
.result-field:last-child{border-bottom:none}
.result-field .label{color:var(--mut);font-size:0.85rem}
.result-field .value{font-weight:600}

/* Category icons */
.category-selector{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.cat-btn{padding:12px 8px;border:2px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;text-align:center;transition:all .2s}
.cat-btn:hover{border-color:var(--bg)}
.cat-btn.active{border-color:var(--bg);background:#dbeafe}
.cat-btn .icon{font-size:1.5rem}
.cat-btn .label{font-size:0.7rem;margin-top:4px;display:block}

/* Footer actions */
.footer-actions{position:sticky;bottom:0;background:rgba(17,63,122,0.95);backdrop-filter:blur(8px);padding:16px;margin:20px -16px -20px;display:flex;gap:12px;justify-content:center;border-top:2px solid rgba(255,255,255,0.2)}
.btn-danger-outline{padding:12px 24px;background:transparent;color:#fca5a5;border:2px solid #fca5a5;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s}
.btn-danger-outline:hover{background:#dc2626;color:#fff;border-color:#dc2626}
.btn-back{padding:14px 24px;background:transparent;color:#fff;border:2px solid #fff;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer}
.btn-back:hover{background:rgba(255,255,255,0.1)}

/* Toast */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#22c55e;color:#fff;padding:12px 24px;border-radius:8px;font-weight:600;z-index:2000;display:none}
.toast.show{display:block}
.toast.error{background:#dc2626}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:rgba(17,63,122,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000}
.loading-spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;font-size:1.1rem}

/* Analyzing */
.analyzing{display:none;text-align:center;padding:20px}
.analyzing.show{display:block}
.analyzing .spinner{width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:var(--bg);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}

@media(max-width:500px){
  .form-row{grid-template-columns:1fr}
  .category-selector{grid-template-columns:repeat(3,1fr)}
}

/* === LAYOUT 3 COLONNES === */
.main-layout{display:grid;grid-template-columns:250px 1fr 220px;gap:12px;align-items:start}
@media(max-width:1000px){.main-layout{grid-template-columns:1fr 1fr}}
@media(max-width:700px){.main-layout{grid-template-columns:1fr}}

/* Colonnes latÃ©rales - RÃ©servations existantes */
.col-existing{display:flex;flex-direction:column;gap:8px;max-height:calc(100vh - 120px);position:sticky;top:70px}
.existing-section{background:var(--card);color:var(--ink);border-radius:10px;padding:10px;box-shadow:0 4px 16px rgba(0,0,0,0.15);display:flex;flex-direction:column;max-height:100%;overflow:hidden}
.existing-title{font-size:0.85rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:5px;padding-bottom:6px;border-bottom:2px solid #e5e7eb;flex-shrink:0}
.existing-title .icon{font-size:1rem}
.existing-empty{text-align:center;color:var(--mut);padding:12px;font-size:0.8rem}
.existing-section.travel-theme{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%)}
.existing-section.travel-theme .existing-title{color:#92400e;border-bottom-color:#fbbf24}
.steps-scroll{flex:1;overflow-y:auto;max-height:calc(100vh - 220px)}
.travel-scroll{flex:1;overflow-y:auto;max-height:calc(100vh - 220px)}

/* Liste des rÃ©servations */
.booking-list{display:flex;flex-direction:column;gap:6px}
.booking-item{background:#f8fafc;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;display:flex;align-items:center;gap:8px;transition:all .2s}
.booking-item:hover{background:#eff6ff;border-color:var(--bg)}
.booking-item .cat-icon{font-size:1.1rem;flex-shrink:0}
.booking-item .info{flex:1;min-width:0}
.booking-item .name{font-weight:600;font-size:0.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.booking-item .details{font-size:0.7rem;color:var(--mut);display:flex;gap:6px;flex-wrap:wrap}
.booking-item .price{font-weight:700;color:#16a34a;font-size:0.8rem;flex-shrink:0}
.booking-item .price-split{font-size:0.65rem;color:#64748b;font-weight:normal}
.booking-item .btn-delete{width:20px;height:20px;background:#fee2e2;color:#dc2626;border:none;border-radius:4px;cursor:pointer;font-size:10px;flex-shrink:0;opacity:0;transition:opacity .2s}
.booking-item:hover .btn-delete{opacity:1}
.booking-item .btn-edit{width:20px;height:20px;background:#dbeafe;color:#3b82f6;border:none;border-radius:4px;cursor:pointer;font-size:10px;flex-shrink:0;opacity:0;transition:opacity .2s;margin-right:2px}
.booking-item:hover .btn-edit{opacity:1}

/* Ã‰tapes accordion */
.step-group{margin-bottom:6px}
.step-header{background:#f1f5f9;border-radius:6px;padding:8px 10px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s}
.step-header:hover{background:#e2e8f0}
.step-header .step-num{width:20px;height:20px;background:var(--bg);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700}
.step-header .step-name{flex:1;font-weight:600;font-size:0.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.step-header .count{background:#dbeafe;color:var(--bg);padding:2px 6px;border-radius:10px;font-size:0.7rem;font-weight:600}
.step-header .arrow{transition:transform .2s;font-size:0.8rem}
.step-header.open .arrow{transform:rotate(90deg)}
.step-bookings{display:none;padding:6px 0 0 26px}
.step-bookings.open{display:block}

/* Colonne centrale - Formulaire */
.col-form{position:sticky;top:70px}

/* Multi-step selector */
.multi-step-selector{margin-bottom:16px}
.multi-step-selector label{display:block;font-weight:600;margin-bottom:8px;font-size:0.9rem}
.step-chips{display:flex;flex-wrap:wrap;gap:6px}
.step-chip{padding:6px 12px;border:2px solid #e5e7eb;border-radius:20px;background:#fff;cursor:pointer;font-size:0.85rem;font-weight:500;transition:all .2s;display:flex;align-items:center;gap:4px}
.step-chip:hover{border-color:var(--bg);background:#eff6ff}
.step-chip.selected{border-color:var(--bg);background:#dbeafe;color:var(--bg)}
.step-chip .chip-num{width:18px;height:18px;background:#e5e7eb;color:var(--ink);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700}
.step-chip.selected .chip-num{background:var(--bg);color:#fff}

/* Modal d'Ã©dition compacte */
.edit-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:2000;padding:10px}
.edit-modal.show{display:flex}
.edit-modal-content{background:#fff;border-radius:12px;width:100%;max-width:420px;max-height:95vh;overflow-y:auto;color:var(--ink)}
.edit-modal-header{background:var(--bg);color:#fff;padding:10px 14px;border-radius:12px 12px 0 0;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:1}
.edit-modal-header h2{margin:0;font-size:1rem;display:flex;align-items:center;gap:6px}
.edit-modal-close{background:none;border:none;color:#fff;font-size:1.3rem;cursor:pointer;padding:2px 6px;opacity:0.8}
.edit-modal-close:hover{opacity:1}
.edit-modal-body{padding:12px}
.edit-modal-footer{padding:10px 12px;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end;position:sticky;bottom:0;background:#fff;border-radius:0 0 12px 12px}

/* Modal parsing - preview */
.parse-preview{background:#f0fdf4;border:2px solid #86efac;border-radius:10px;padding:12px;margin-bottom:12px}
.parse-preview-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #bbf7d0}
.parse-preview-icon{font-size:2rem}
.parse-preview-title{font-weight:700;font-size:1.05rem}
.parse-preview-subtitle{color:#15803d;font-size:0.8rem}
.parse-preview-fields{display:flex;flex-direction:column;gap:4px}
.parse-preview-field{display:flex;align-items:center;gap:8px;font-size:0.85rem}
.parse-preview-field .icon{width:20px;text-align:center}
.parse-preview-field .value{color:#166534}

/* Type mini buttons */
.type-mini{padding:6px 14px;border:2px solid #e5e7eb;border-radius:16px;background:#fff;cursor:pointer;font-size:0.85rem;font-weight:600;transition:all .2s}
.type-mini:hover{border-color:var(--bg);background:#eff6ff}
.type-mini.active{border-color:var(--bg);background:#dbeafe;color:var(--bg)}

/* Category mini */
.cat-mini{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;font-size:1.1rem;transition:all .2s}
.cat-mini:hover{border-color:var(--bg);background:#eff6ff}
.cat-mini.active{border-color:var(--bg);background:#dbeafe}
</style>
</head>
<body>

<header>
  <a href="index.html" class="brandlink">
    <img src="/assets/symbol.webp" alt="Logo">
    <span class="brand">OneRoadTrip</span>
  </a>
  <span class="sp"></span>
  <button class="hdr-btn" id="btnBackToTrip">â† <span data-i18n="backToTrip">Retour</span></button>
</header>

<div class="wrap" style="max-width:1100px">
  <h1 data-i18n="bookingsPageTitle">ğŸ“‹ RÃ©servations du voyage</h1>
  <p class="subtitle" id="tripName"></p>
  
  <div class="main-layout">
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- COLONNE GAUCHE: RÃ©servations par Ã©tape -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="col-existing">
      <div class="existing-section">
        <div class="existing-title"><span class="icon">ğŸ“</span> <span data-i18n="stepBookingsTitle">RÃ©servations par Ã©tape</span></div>
        <div class="steps-scroll" id="stepBookingsList">
          <div class="existing-empty" data-i18n="loading">Chargement...</div>
        </div>
      </div>
    </div>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- COLONNE CENTRALE: Formulaire d'ajout -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="col-form">
  
  <!-- Step 1: Type selection -->
  <div class="card" id="cardType">
    <div class="card-title">1ï¸âƒ£ <span data-i18n="selectType">Type de rÃ©servation</span></div>
    <div class="type-selector">
      <div class="type-btn active" data-type="step">
        <div class="icon">ğŸ“</div>
        <div class="label" data-i18n="typeStep">Ã‰tape</div>
        <div class="hint" data-i18n="typeStepHint">HÃ´tel, activitÃ©, visite</div>
      </div>
      <div class="type-btn" data-type="travel">
        <div class="icon">ğŸŒ</div>
        <div class="label" data-i18n="typeTravel">Voyage</div>
        <div class="hint" data-i18n="typeTravelHint">Vol, voiture, assurance</div>
      </div>
    </div>
    
    <!-- Step selector (only for step type) -->
    <div class="step-selector" id="stepSelectorWrap">
      <label data-i18n="selectStep">SÃ©lectionner l'Ã©tape</label>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="stepSelector" style="flex:1">
          <option value="">-- Choisir --</option>
        </select>
      </div>
    </div>
  </div>
  
  <!-- Step 2: Import method -->
  <div class="card" id="cardImport">
    <div class="card-title">2ï¸âƒ£ <span data-i18n="importMethod">MÃ©thode d'import</span></div>
    
    <!-- Email paste -->
    <div class="email-input" id="emailInputWrap">
      <label data-i18n="pasteEmail">Collez l'email de confirmation</label>
      <textarea id="emailText" placeholder="Copiez-collez ici le contenu de votre email de confirmation de rÃ©servation..."></textarea>
      <div class="hint" data-i18n="emailHint">Nous analyserons automatiquement les informations</div>
    </div>
    
    <div class="btn-row">
      <button class="btn btn-primary" id="btnAnalyze">
        âœ¨ <span data-i18n="analyze">Analyser</span>
      </button>
      <button class="btn btn-secondary" id="btnManual">
        âœï¸ <span data-i18n="manualEntry">Saisie manuelle</span>
      </button>
    </div>
    
    <!-- Analyzing spinner -->
    <div class="analyzing" id="analyzing">
      <div class="spinner"></div>
      <div data-i18n="analyzing">Analyse en cours...</div>
    </div>
  </div>
  
  <!-- Step 3: Manual form / Result -->
  <div class="card" id="cardForm" style="display:none">
    <div class="card-title">3ï¸âƒ£ <span data-i18n="bookingDetails">DÃ©tails de la rÃ©servation</span></div>
    
    <!-- Result preview -->
    <div class="result-preview" id="resultPreview">
      <div class="result-title">âœ… <span data-i18n="extractedInfo">Informations extraites</span></div>
      <div id="resultFields"></div>
    </div>
    
    <!-- Category selector -->
    <div class="form-group">
      <label data-i18n="category">CatÃ©gorie</label>
      <div class="category-selector" id="categorySelector">
        <div class="cat-btn" data-cat="hotel"><div class="icon">ğŸ¨</div><div class="label" data-i18n="catHotel">HÃ´tel</div></div>
        <div class="cat-btn" data-cat="activity"><div class="icon">ğŸ¯</div><div class="label" data-i18n="catActivity">ActivitÃ©</div></div>
        <div class="cat-btn" data-cat="flight"><div class="icon">âœˆï¸</div><div class="label" data-i18n="catFlight">Vol</div></div>
        <div class="cat-btn" data-cat="car_rental"><div class="icon">ğŸš—</div><div class="label" data-i18n="catCar">Voiture</div></div>
        <div class="cat-btn" data-cat="insurance"><div class="icon">ğŸ›¡ï¸</div><div class="label" data-i18n="catInsurance">Assurance</div></div>
        <div class="cat-btn" data-cat="visit"><div class="icon">ğŸ›ï¸</div><div class="label" data-i18n="catVisit">Visite</div></div>
        <div class="cat-btn" data-cat="show"><div class="icon">ğŸ­</div><div class="label" data-i18n="catShow">Spectacle</div></div>
        <div class="cat-btn" data-cat="other"><div class="icon">ğŸ“‹</div><div class="label" data-i18n="catOther">Autre</div></div>
      </div>
    </div>
    
    <!-- Form fields -->
    <div class="form-group">
      <label data-i18n="bookingName">Nom de la rÃ©servation</label>
      <input type="text" id="fieldName" placeholder="Ex: HÃ´tel Marriott Paris">
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label data-i18n="dateStart">Date dÃ©but</label>
        <input type="date" id="fieldDateStart">
      </div>
      <div class="form-group">
        <label data-i18n="dateEnd">Date fin</label>
        <input type="date" id="fieldDateEnd">
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label data-i18n="reference">RÃ©fÃ©rence</label>
        <input type="text" id="fieldRef" placeholder="NÂ° de confirmation">
      </div>
      <div class="form-group">
        <label data-i18n="price">Prix (â‚¬)</label>
        <input type="number" id="fieldPrice" placeholder="0.00" step="0.01">
      </div>
    </div>
    
    <div class="form-group">
      <label data-i18n="address">Adresse / Lieu</label>
      <input type="text" id="fieldAddress" placeholder="Adresse ou lieu">
    </div>
    
    <div class="form-group">
      <label data-i18n="notes">Notes</label>
      <input type="text" id="fieldNotes" placeholder="Informations supplÃ©mentaires">
    </div>
    
    <div class="btn-row" style="margin-top:20px">
      <button class="btn btn-success" id="btnSaveBooking">
        âœ… <span data-i18n="saveBooking">Enregistrer la rÃ©servation</span>
      </button>
      <button class="btn btn-secondary" id="btnReset">
        ğŸ”„ <span data-i18n="reset">Recommencer</span>
      </button>
    </div>
  </div>
  
    </div><!-- fin col-form -->
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- COLONNE DROITE: RÃ©servations voyage -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="col-existing">
      <div class="existing-section travel-theme">
        <div class="existing-title"><span class="icon">ğŸŒ</span> <span data-i18n="travelBookingsTitle">RÃ©servations voyage</span></div>
        <div class="travel-scroll" id="travelBookingsList">
          <div class="existing-empty" data-i18n="loading">Chargement...</div>
        </div>
      </div>
    </div>
    
  </div><!-- fin main-layout -->
  
  <!-- Footer -->
  <div class="footer-actions">
    <button class="btn-danger-outline" id="btnResetAll">ğŸ—‘ï¸ <span data-i18n="resetAll">Tout rÃ©initialiser</span></button>
  </div>
</div>

<!-- Modal d'Ã©dition / parsing (rÃ©utilisÃ©e) -->
<div class="edit-modal" id="editModal">
  <div class="edit-modal-content">
    <div class="edit-modal-header" id="editModalHeader">
      <h2 id="editModalTitle">âœï¸ <span data-i18n="editBooking">Modifier la rÃ©servation</span></h2>
      <button class="edit-modal-close" onclick="closeEditModal()">Ã—</button>
    </div>
    <div class="edit-modal-body">
      <!-- Preview (affichÃ© seulement en mode parsing) -->
      <div class="parse-preview" id="editPreviewBox" style="display:none">
        <!-- Rempli dynamiquement -->
      </div>
      
      <!-- Type (compact) -->
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button type="button" class="type-mini" data-type="step" id="editTypeStep" data-i18n-title="typeStepHint" title="HÃ´tel, activitÃ©, visite">ğŸ“ <span data-i18n="typeStep">Ã‰tape</span></button>
        <button type="button" class="type-mini" data-type="travel" id="editTypeTravel" data-i18n-title="typeTravelHint" title="Vol, voiture, assurance">ğŸŒ <span data-i18n="typeTravel">Voyage</span></button>
      </div>
      
      <!-- SÃ©lecteur d'Ã©tapes -->
      <div id="editStepSelectorWrap" style="margin-bottom:12px">
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
          <select id="editStepSelector" style="flex:1;padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:0.9rem">
            <option value="">-- Ã‰tape --</option>
          </select>
          <button type="button" onclick="addStepToSelection()" style="padding:8px 12px;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:700">+</button>
        </div>
        <div id="selectedStepsList" style="display:flex;flex-wrap:wrap;gap:4px"></div>
        <div id="pricePerStepInfo" style="margin-top:4px;font-size:0.8rem;color:#3b82f6;font-weight:600"></div>
      </div>
      
      <!-- CatÃ©gorie (compact) -->
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px" id="editCategorySelector">
        <span class="cat-mini" data-cat="hotel" data-i18n-title="catHotel" title="HÃ´tel">ğŸ¨</span>
        <span class="cat-mini" data-cat="activity" data-i18n-title="catActivity" title="ActivitÃ©">ğŸ¯</span>
        <span class="cat-mini" data-cat="flight" data-i18n-title="catFlight" title="Vol">âœˆï¸</span>
        <span class="cat-mini" data-cat="car_rental" data-i18n-title="catCar" title="Voiture">ğŸš—</span>
        <span class="cat-mini" data-cat="insurance" data-i18n-title="catInsurance" title="Assurance">ğŸ›¡ï¸</span>
        <span class="cat-mini" data-cat="visit" data-i18n-title="catVisit" title="Visite">ğŸ›ï¸</span>
        <span class="cat-mini" data-cat="show" data-i18n-title="catShow" title="Spectacle">ğŸ­</span>
        <span class="cat-mini" data-cat="other" data-i18n-title="catOther" title="Autre">ğŸ“‹</span>
      </div>
      
      <!-- Nom -->
      <input type="text" id="editFieldName" placeholder="Nom de la rÃ©servation" style="width:100%;padding:8px 10px;border:2px solid #e5e7eb;border-radius:6px;margin-bottom:8px;font-size:0.9rem">
      
      <!-- Dates + Prix sur une ligne -->
      <div style="display:grid;grid-template-columns:1fr 1fr 100px;gap:6px;margin-bottom:8px">
        <input type="date" id="editFieldDateStart" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:0.85rem">
        <input type="date" id="editFieldDateEnd" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:0.85rem">
        <input type="number" id="editFieldPrice" placeholder="Prix â‚¬" step="0.01" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:0.85rem">
      </div>
      
      <!-- Ref + Adresse -->
      <div style="display:grid;grid-template-columns:120px 1fr;gap:6px;margin-bottom:8px">
        <input type="text" id="editFieldRef" placeholder="RÃ©f." style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:0.85rem">
        <input type="text" id="editFieldAddress" placeholder="Adresse" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:0.85rem">
      </div>
      
      <!-- Notes -->
      <input type="text" id="editFieldNotes" placeholder="Notes" style="width:100%;padding:8px 10px;border:2px solid #e5e7eb;border-radius:6px;font-size:0.85rem">
    </div>
    <div class="edit-modal-footer">
      <button class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
      <button class="btn btn-success" id="editModalSaveBtn" onclick="saveEditedBooking()">âœ… Enregistrer</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" data-i18n="loading">Chargement...</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="/js/ort-config.js"></script>
<script src="/js/ort-i18n.js"></script>
<script src="/js/ort-tripid.js"></script>
<script src="/js/ort-trip-data.js"></script>

<script>
// Init Firebase
(function(){
  const host = location.hostname;
  const isPreprod = /oneroadtrip-preprod|localhost|127\.0\.0\.1|0\.0\.0\.0/.test(host);
  const cfg = isPreprod ? (window.ORT_CONFIG?.PREPROD || {}) : (window.ORT_CONFIG?.PROD || {});
  const safe = (cfg && cfg.apiKey) ? cfg : (window.ORT_CONFIG?.PREPROD || {});
  if (safe && safe.apiKey && !firebase.apps.length) {
    firebase.initializeApp(safe);
    console.log('[RT-BOOKING-IMPORT] Firebase initialisÃ©');
  }
})();
</script>

<script>
(async function() {
  'use strict';
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // I18N
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const I18N_LOCAL = {
    importBookingTitle: { fr: 'â• Importer une rÃ©servation', en: 'â• Import a booking', es: 'â• Importar una reserva', it: 'â• Importa una prenotazione', pt: 'â• Importar uma reserva', ar: 'â• Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø­Ø¬Ø²' },
    selectType: { fr: 'Type de rÃ©servation', en: 'Booking type', es: 'Tipo de reserva', it: 'Tipo di prenotazione', pt: 'Tipo de reserva', ar: 'Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¬Ø²' },
    typeStep: { fr: 'Ã‰tape', en: 'Step', es: 'Etapa', it: 'Tappa', pt: 'Etapa', ar: 'Ù…Ø±Ø­Ù„Ø©' },
    typeStepHint: { fr: 'HÃ´tel, activitÃ©, visite', en: 'Hotel, activity, visit', es: 'Hotel, actividad, visita', it: 'Hotel, attivitÃ , visita', pt: 'Hotel, atividade, visita', ar: 'ÙÙ†Ø¯Ù‚ØŒ Ù†Ø´Ø§Ø·ØŒ Ø²ÙŠØ§Ø±Ø©' },
    typeTravel: { fr: 'Voyage', en: 'Travel', es: 'Viaje', it: 'Viaggio', pt: 'Viagem', ar: 'Ø³ÙØ±' },
    typeTravelHint: { fr: 'Vol, voiture, assurance', en: 'Flight, car, insurance', es: 'Vuelo, coche, seguro', it: 'Volo, auto, assicurazione', pt: 'Voo, carro, seguro', ar: 'Ø·ÙŠØ±Ø§Ù†ØŒ Ø³ÙŠØ§Ø±Ø©ØŒ ØªØ£Ù…ÙŠÙ†' },
    selectStep: { fr: 'SÃ©lectionner l\'Ã©tape', en: 'Select step', es: 'Seleccionar etapa', it: 'Seleziona tappa', pt: 'Selecionar etapa', ar: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©' },
    importMethod: { fr: 'MÃ©thode d\'import', en: 'Import method', es: 'MÃ©todo de importaciÃ³n', it: 'Metodo di importazione', pt: 'MÃ©todo de importaÃ§Ã£o', ar: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯' },
    pasteEmail: { fr: 'Collez l\'email de confirmation', en: 'Paste the confirmation email', es: 'Pegue el email de confirmaciÃ³n', it: 'Incolla l\'email di conferma', pt: 'Cole o email de confirmaÃ§Ã£o', ar: 'Ø§Ù„ØµÙ‚ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯' },
    emailHint: { fr: 'Nous analyserons automatiquement les informations', en: 'We will automatically analyze the information', es: 'Analizaremos automÃ¡ticamente la informaciÃ³n', it: 'Analizzeremo automaticamente le informazioni', pt: 'Analisaremos automaticamente as informaÃ§Ãµes', ar: 'Ø³Ù†Ø­Ù„Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹' },
    analyze: { fr: 'Analyser', en: 'Analyze', es: 'Analizar', it: 'Analizza', pt: 'Analisar', ar: 'ØªØ­Ù„ÙŠÙ„' },
    manualEntry: { fr: 'Saisie manuelle', en: 'Manual entry', es: 'Entrada manual', it: 'Inserimento manuale', pt: 'Entrada manual', ar: 'Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ' },
    analyzing: { fr: 'Analyse en cours...', en: 'Analyzing...', es: 'Analizando...', it: 'Analisi in corso...', pt: 'Analisando...', ar: 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„...' },
    bookingDetails: { fr: 'DÃ©tails de la rÃ©servation', en: 'Booking details', es: 'Detalles de la reserva', it: 'Dettagli prenotazione', pt: 'Detalhes da reserva', ar: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²' },
    extractedInfo: { fr: 'Informations extraites', en: 'Extracted information', es: 'InformaciÃ³n extraÃ­da', it: 'Informazioni estratte', pt: 'InformaÃ§Ãµes extraÃ­das', ar: 'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©' },
    category: { fr: 'CatÃ©gorie', en: 'Category', es: 'CategorÃ­a', it: 'Categoria', pt: 'Categoria', ar: 'Ø§Ù„ÙØ¦Ø©' },
    catHotel: { fr: 'HÃ´tel', en: 'Hotel', es: 'Hotel', it: 'Hotel', pt: 'Hotel', ar: 'ÙÙ†Ø¯Ù‚' },
    catActivity: { fr: 'ActivitÃ©', en: 'Activity', es: 'Actividad', it: 'AttivitÃ ', pt: 'Atividade', ar: 'Ù†Ø´Ø§Ø·' },
    catFlight: { fr: 'Vol', en: 'Flight', es: 'Vuelo', it: 'Volo', pt: 'Voo', ar: 'Ø·ÙŠØ±Ø§Ù†' },
    catCar: { fr: 'Voiture', en: 'Car', es: 'Coche', it: 'Auto', pt: 'Carro', ar: 'Ø³ÙŠØ§Ø±Ø©' },
    catInsurance: { fr: 'Assurance', en: 'Insurance', es: 'Seguro', it: 'Assicurazione', pt: 'Seguro', ar: 'ØªØ£Ù…ÙŠÙ†' },
    catVisit: { fr: 'Visite', en: 'Visit', es: 'Visita', it: 'Visita', pt: 'Visita', ar: 'Ø²ÙŠØ§Ø±Ø©' },
    catShow: { fr: 'Spectacle', en: 'Show', es: 'EspectÃ¡culo', it: 'Spettacolo', pt: 'EspetÃ¡culo', ar: 'Ø¹Ø±Ø¶' },
    catOther: { fr: 'Autre', en: 'Other', es: 'Otro', it: 'Altro', pt: 'Outro', ar: 'Ø¢Ø®Ø±' },
    bookingName: { fr: 'Nom de la rÃ©servation', en: 'Booking name', es: 'Nombre de la reserva', it: 'Nome prenotazione', pt: 'Nome da reserva', ar: 'Ø§Ø³Ù… Ø§Ù„Ø­Ø¬Ø²' },
    dateStart: { fr: 'Date dÃ©but', en: 'Start date', es: 'Fecha inicio', it: 'Data inizio', pt: 'Data inÃ­cio', ar: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡' },
    dateEnd: { fr: 'Date fin', en: 'End date', es: 'Fecha fin', it: 'Data fine', pt: 'Data fim', ar: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' },
    reference: { fr: 'RÃ©fÃ©rence', en: 'Reference', es: 'Referencia', it: 'Riferimento', pt: 'ReferÃªncia', ar: 'Ø§Ù„Ù…Ø±Ø¬Ø¹' },
    price: { fr: 'Prix (â‚¬)', en: 'Price (â‚¬)', es: 'Precio (â‚¬)', it: 'Prezzo (â‚¬)', pt: 'PreÃ§o (â‚¬)', ar: 'Ø§Ù„Ø³Ø¹Ø± (â‚¬)' },
    address: { fr: 'Adresse / Lieu', en: 'Address / Location', es: 'DirecciÃ³n / Lugar', it: 'Indirizzo / Luogo', pt: 'EndereÃ§o / Local', ar: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ù…ÙˆÙ‚Ø¹' },
    notes: { fr: 'Notes', en: 'Notes', es: 'Notas', it: 'Note', pt: 'Notas', ar: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª' },
    saveBooking: { fr: 'Enregistrer la rÃ©servation', en: 'Save booking', es: 'Guardar reserva', it: 'Salva prenotazione', pt: 'Salvar reserva', ar: 'Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø²' },
    reset: { fr: 'Recommencer', en: 'Reset', es: 'Reiniciar', it: 'Ricomincia', pt: 'RecomeÃ§ar', ar: 'Ø¥Ø¹Ø§Ø¯Ø©' },
    backToTrip: { fr: 'Retour', en: 'Back', es: 'Volver', it: 'Indietro', pt: 'Voltar', ar: 'Ø±Ø¬ÙˆØ¹' },
    cancelAndReturn: { fr: 'Annuler', en: 'Cancel', es: 'Cancelar', it: 'Annulla', pt: 'Cancelar', ar: 'Ø¥Ù„ØºØ§Ø¡' },
    loading: { fr: 'Chargement...', en: 'Loading...', es: 'Cargando...', it: 'Caricamento...', pt: 'Carregando...', ar: 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...' },
    saved: { fr: 'RÃ©servation enregistrÃ©e !', en: 'Booking saved!', es: 'Â¡Reserva guardada!', it: 'Prenotazione salvata!', pt: 'Reserva salva!', ar: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø²!' },
    errorSaving: { fr: 'Erreur lors de l\'enregistrement', en: 'Error saving', es: 'Error al guardar', it: 'Errore durante il salvataggio', pt: 'Erro ao salvar', ar: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸' },
    noTrip: { fr: 'Voyage non trouvÃ©', en: 'Trip not found', es: 'Viaje no encontrado', it: 'Viaggio non trovato', pt: 'Viagem nÃ£o encontrada', ar: 'Ø§Ù„Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' },
    selectStepFirst: { fr: 'SÃ©lectionnez une Ã©tape', en: 'Select a step first', es: 'Seleccione una etapa', it: 'Seleziona una tappa', pt: 'Selecione uma etapa', ar: 'Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹' },
    enterName: { fr: 'Entrez un nom', en: 'Enter a name', es: 'Ingrese un nombre', it: 'Inserisci un nome', pt: 'Digite um nome', ar: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ø§Ù‹' },
    pasteEmailFirst: { fr: 'Collez d\'abord un email', en: 'Paste an email first', es: 'Pegue un email primero', it: 'Incolla prima un\'email', pt: 'Cole um email primeiro', ar: 'Ø§Ù„ØµÙ‚ Ø¨Ø±ÙŠØ¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹' },
    analysisError: { fr: 'Erreur d\'analyse. Essayez la saisie manuelle.', en: 'Analysis error. Try manual entry.', es: 'Error de anÃ¡lisis. Pruebe la entrada manual.', it: 'Errore di analisi. Prova l\'inserimento manuale.', pt: 'Erro de anÃ¡lise. Tente entrada manual.', ar: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ø¬Ø±Ø¨ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ.' },
    // RÃ©servations existantes
    stepBookingsTitle: { fr: 'RÃ©servations par Ã©tape', en: 'Bookings by step', es: 'Reservas por etapa', it: 'Prenotazioni per tappa', pt: 'Reservas por etapa', ar: 'Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©' },
    travelBookingsTitle: { fr: 'RÃ©servations voyage', en: 'Travel bookings', es: 'Reservas de viaje', it: 'Prenotazioni viaggio', pt: 'Reservas de viagem', ar: 'Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø³ÙØ±' },
    noSteps: { fr: 'Aucune Ã©tape', en: 'No steps', es: 'Sin etapas', it: 'Nessuna tappa', pt: 'Nenhuma etapa', ar: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„' },
    noBookings: { fr: 'Aucune rÃ©servation', en: 'No bookings', es: 'Sin reservas', it: 'Nessuna prenotazione', pt: 'Nenhuma reserva', ar: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª' },
    noTravelBookings: { fr: 'Aucune rÃ©servation voyage', en: 'No travel bookings', es: 'Sin reservas de viaje', it: 'Nessuna prenotazione viaggio', pt: 'Nenhuma reserva de viagem', ar: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø³ÙØ±' },
    confirmDelete: { fr: 'Supprimer cette rÃ©servation ?', en: 'Delete this booking?', es: 'Â¿Eliminar esta reserva?', it: 'Eliminare questa prenotazione?', pt: 'Excluir esta reserva?', ar: 'Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ' },
    bookingDeleted: { fr: 'RÃ©servation supprimÃ©e', en: 'Booking deleted', es: 'Reserva eliminada', it: 'Prenotazione eliminata', pt: 'Reserva excluÃ­da', ar: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²' },
    deleteError: { fr: 'Erreur lors de la suppression', en: 'Error deleting', es: 'Error al eliminar', it: 'Errore durante l\'eliminazione', pt: 'Erro ao excluir', ar: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù' },
    editMode: { fr: 'Mode Ã©dition activÃ©', en: 'Edit mode enabled', es: 'Modo ediciÃ³n activado', it: 'ModalitÃ  modifica attivata', pt: 'Modo ediÃ§Ã£o ativado', ar: 'ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ±' },
    bookingUpdated: { fr: 'RÃ©servation mise Ã  jour !', en: 'Booking updated!', es: 'Â¡Reserva actualizada!', it: 'Prenotazione aggiornata!', pt: 'Reserva atualizada!', ar: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¬Ø²!' },
    updateBooking: { fr: 'Mettre Ã  jour', en: 'Update', es: 'Actualizar', it: 'Aggiorna', pt: 'Atualizar', ar: 'ØªØ­Ø¯ÙŠØ«' },
    bookingNotFound: { fr: 'RÃ©servation non trouvÃ©e', en: 'Booking not found', es: 'Reserva no encontrada', it: 'Prenotazione non trovata', pt: 'Reserva nÃ£o encontrada', ar: 'Ø§Ù„Ø­Ø¬Ø² ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' },
    noName: { fr: 'Sans nom', en: 'No name', es: 'Sin nombre', it: 'Senza nome', pt: 'Sem nome', ar: 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…' },
    bookingsPageTitle: { fr: 'ğŸ“‹ RÃ©servations du voyage', en: 'ğŸ“‹ Trip bookings', es: 'ğŸ“‹ Reservas del viaje', it: 'ğŸ“‹ Prenotazioni del viaggio', pt: 'ğŸ“‹ Reservas da viagem', ar: 'ğŸ“‹ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©' },
    resetAll: { fr: 'Tout rÃ©initialiser', en: 'Reset all', es: 'Restablecer todo', it: 'Reimposta tutto', pt: 'Redefinir tudo', ar: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„' },
    confirmResetAll: { fr: 'Supprimer TOUTES les rÃ©servations de ce voyage ? Cette action est irrÃ©versible.', en: 'Delete ALL bookings for this trip? This action cannot be undone.', es: 'Â¿Eliminar TODAS las reservas de este viaje? Esta acciÃ³n es irreversible.', it: 'Eliminare TUTTE le prenotazioni di questo viaggio? Questa azione Ã¨ irreversibile.', pt: 'Excluir TODAS as reservas desta viagem? Esta aÃ§Ã£o Ã© irreversÃ­vel.', ar: 'Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.' },
    allBookingsDeleted: { fr: 'Toutes les rÃ©servations ont Ã©tÃ© supprimÃ©es', en: 'All bookings have been deleted', es: 'Todas las reservas han sido eliminadas', it: 'Tutte le prenotazioni sono state eliminate', pt: 'Todas as reservas foram excluÃ­das', ar: 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª' },
    editBooking: { fr: 'Modifier la rÃ©servation', en: 'Edit booking', es: 'Editar reserva', it: 'Modifica prenotazione', pt: 'Editar reserva', ar: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²' },
    saveChanges: { fr: 'Enregistrer', en: 'Save', es: 'Guardar', it: 'Salva', pt: 'Salvar', ar: 'Ø­ÙØ¸' },
    bookingType: { fr: 'Type', en: 'Type', es: 'Tipo', it: 'Tipo', pt: 'Tipo', ar: 'Ø§Ù„Ù†ÙˆØ¹' },
    // Multi-step
    selectSteps: { fr: 'Affecter aux Ã©tapes', en: 'Assign to steps', es: 'Asignar a etapas', it: 'Assegna alle tappe', pt: 'Atribuir Ã s etapas', ar: 'ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ù…Ø±Ø§Ø­Ù„' },
    multiStepHint: { fr: 'Cliquez sur plusieurs Ã©tapes pour partager (ex: hÃ´tel 2 nuits)', en: 'Click multiple steps to share (e.g. hotel 2 nights)', es: 'Haga clic en varias etapas para compartir (ej: hotel 2 noches)', it: 'Clicca su piÃ¹ tappe per condividere (es: hotel 2 notti)', pt: 'Clique em vÃ¡rias etapas para compartilhar (ex: hotel 2 noites)', ar: 'Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ø¯Ø© Ù…Ø±Ø§Ø­Ù„ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Ù…Ø«Ø§Ù„: ÙÙ†Ø¯Ù‚ Ù„ÙŠÙ„ØªÙŠÙ†)' },
    selectAtLeastOneStep: { fr: 'SÃ©lectionnez au moins une Ã©tape', en: 'Select at least one step', es: 'Seleccione al menos una etapa', it: 'Seleziona almeno una tappa', pt: 'Selecione pelo menos uma etapa', ar: 'Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' },
    sharedOn: { fr: 'partagÃ© sur {n} Ã©tapes', en: 'shared on {n} steps', es: 'compartido en {n} etapas', it: 'condiviso su {n} tappe', pt: 'compartilhado em {n} etapas', ar: 'Ù…Ø´ØªØ±Ùƒ Ø¹Ù„Ù‰ {n} Ù…Ø±Ø§Ø­Ù„' },
    noStepSelected: { fr: 'Aucune Ã©tape sÃ©lectionnÃ©e', en: 'No step selected', es: 'Ninguna etapa seleccionada', it: 'Nessuna tappa selezionata', pt: 'Nenhuma etapa selecionada', ar: 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ù…Ø±Ø­Ù„Ø©' },
    // Parsing IA
    contentTooShort: { fr: 'Contenu trop court (min 50 caractÃ¨res)', en: 'Content too short (min 50 characters)', es: 'Contenido demasiado corto (mÃ­n 50 caracteres)', it: 'Contenuto troppo corto (min 50 caratteri)', pt: 'ConteÃºdo muito curto (mÃ­n 50 caracteres)', ar: 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ (50 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰)' },
    loginRequired: { fr: 'Connexion requise', en: 'Login required', es: 'Inicio de sesiÃ³n requerido', it: 'Accesso richiesto', pt: 'Login necessÃ¡rio', ar: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨' },
    quotaExceeded: { fr: 'Quota atteint ({n}/mois). RÃ©essayez le mois prochain.', en: 'Quota exceeded ({n}/month). Try again next month.', es: 'Cuota alcanzada ({n}/mes). Intente el prÃ³ximo mes.', it: 'Quota raggiunta ({n}/mese). Riprova il mese prossimo.', pt: 'Cota atingida ({n}/mÃªs). Tente novamente no prÃ³ximo mÃªs.', ar: 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­ØµØ© ({n}/Ø´Ù‡Ø±). Ø­Ø§ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ù‚Ø¨Ù„.' },
    analysisSuccess: { fr: 'Analyse rÃ©ussie ! ({n} analyses restantes ce mois)', en: 'Analysis successful! ({n} analyses left this month)', es: 'Â¡AnÃ¡lisis exitoso! ({n} anÃ¡lisis restantes este mes)', it: 'Analisi riuscita! ({n} analisi rimanenti questo mese)', pt: 'AnÃ¡lise bem-sucedida! ({n} anÃ¡lises restantes este mÃªs)', ar: 'ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ({n} ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)' },
    analysisErrorFallback: { fr: 'Erreur IA, analyse locale utilisÃ©e', en: 'AI error, using local analysis', es: 'Error IA, usando anÃ¡lisis local', it: 'Errore IA, usando analisi locale', pt: 'Erro IA, usando anÃ¡lise local', ar: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ' },
    aiUnavailable: { fr: 'L\'IA n\'est pas disponible. Nous utilisons des IA gratuites pour vous permettre d\'utiliser ce site gratuitement. Merci de rentrer manuellement la rÃ©servation ou de revenir plus tard.', en: 'AI is not available. We use free AI services to keep this site free. Please enter the booking manually or try again later.', es: 'La IA no estÃ¡ disponible. Usamos servicios de IA gratuitos para mantener este sitio gratuito. Por favor, ingrese la reserva manualmente o intente mÃ¡s tarde.', it: 'L\'IA non Ã¨ disponibile. Utilizziamo servizi IA gratuiti per mantenere questo sito gratuito. Inserisci la prenotazione manualmente o riprova piÃ¹ tardi.', pt: 'A IA nÃ£o estÃ¡ disponÃ­vel. Usamos serviÃ§os de IA gratuitos para manter este site gratuito. Por favor, insira a reserva manualmente ou tente novamente mais tarde.', ar: 'Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØºÙŠØ± Ù…ØªØ§Ø­. Ù†Ø³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø§Øª Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¬Ø§Ù†ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.' },
    // Disclaimer IA
    aiDisclaimer: { fr: 'âš ï¸ L\'IA peut faire des erreurs. VÃ©rifiez les informations avant d\'enregistrer. OneRoadTrip ne peut Ãªtre tenu responsable d\'Ã©ventuelles erreurs d\'extraction.', en: 'âš ï¸ AI may make mistakes. Please verify the information before saving. OneRoadTrip cannot be held responsible for any extraction errors.', es: 'âš ï¸ La IA puede cometer errores. Verifique la informaciÃ³n antes de guardar. OneRoadTrip no se responsabiliza de posibles errores de extracciÃ³n.', it: 'âš ï¸ L\'IA puÃ² commettere errori. Verificare le informazioni prima di salvare. OneRoadTrip non puÃ² essere ritenuto responsabile di eventuali errori di estrazione.', pt: 'âš ï¸ A IA pode cometer erros. Verifique as informaÃ§Ãµes antes de salvar. OneRoadTrip nÃ£o pode ser responsabilizado por erros de extraÃ§Ã£o.', ar: 'âš ï¸ Ù‚Ø¯ ÙŠØ®Ø·Ø¦ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ OneRoadTrip Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬.' },
    aiDisclaimerAccept: { fr: 'J\'ai compris, ne plus afficher', en: 'I understand, don\'t show again', es: 'Entendido, no mostrar de nuevo', it: 'Ho capito, non mostrare piÃ¹', pt: 'Entendi, nÃ£o mostrar novamente', ar: 'ÙÙ‡Ù…ØªØŒ Ù„Ø§ ØªØ¹Ø±Ø¶ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' },
    aiDisclaimerContinue: { fr: 'Continuer', en: 'Continue', es: 'Continuar', it: 'Continua', pt: 'Continuar', ar: 'Ù…ØªØ§Ø¨Ø¹Ø©' },
    // Vols Ã©ditables
    flightOutbound: { fr: 'ALLER', en: 'OUTBOUND', es: 'IDA', it: 'ANDATA', pt: 'IDA', ar: 'Ø°Ù‡Ø§Ø¨' },
    flightReturn: { fr: 'RETOUR', en: 'RETURN', es: 'VUELTA', it: 'RITORNO', pt: 'VOLTA', ar: 'Ø¹ÙˆØ¯Ø©' },
    flightSegment: { fr: 'Segment', en: 'Segment', es: 'Segmento', it: 'Segmento', pt: 'Segmento', ar: 'Ù…Ù‚Ø·Ø¹' },
    flightNumber: { fr: 'NÂ° vol', en: 'Flight #', es: 'NÂ° vuelo', it: 'NÂ° volo', pt: 'NÂ° voo', ar: 'Ø±Ù‚Ù… Ø§Ù„Ø±Ø­Ù„Ø©' },
    airline: { fr: 'Compagnie', en: 'Airline', es: 'AerolÃ­nea', it: 'Compagnia', pt: 'Companhia', ar: 'Ø´Ø±ÙƒØ© Ø§Ù„Ø·ÙŠØ±Ø§Ù†' },
    departure: { fr: 'DÃ©part', en: 'Departure', es: 'Salida', it: 'Partenza', pt: 'Partida', ar: 'Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©' },
    arrival: { fr: 'ArrivÃ©e', en: 'Arrival', es: 'Llegada', it: 'Arrivo', pt: 'Chegada', ar: 'Ø§Ù„ÙˆØµÙˆÙ„' },
    duration: { fr: 'DurÃ©e', en: 'Duration', es: 'DuraciÃ³n', it: 'Durata', pt: 'DuraÃ§Ã£o', ar: 'Ø§Ù„Ù…Ø¯Ø©' },
    durationHint: { fr: 'ex: 2h30', en: 'e.g. 2h30', es: 'ej: 2h30', it: 'es: 2h30', pt: 'ex: 2h30', ar: 'Ù…Ø«Ø§Ù„: 2h30' },
    airport: { fr: 'AÃ©roport', en: 'Airport', es: 'Aeropuerto', it: 'Aeroporto', pt: 'Aeroporto', ar: 'Ø§Ù„Ù…Ø·Ø§Ø±' },
    city: { fr: 'Ville', en: 'City', es: 'Ciudad', it: 'CittÃ ', pt: 'Cidade', ar: 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©' },
    addSegment: { fr: '+ Ajouter un segment', en: '+ Add segment', es: '+ AÃ±adir segmento', it: '+ Aggiungi segmento', pt: '+ Adicionar segmento', ar: '+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø·Ø¹' },
    removeSegment: { fr: 'Supprimer', en: 'Remove', es: 'Eliminar', it: 'Elimina', pt: 'Remover', ar: 'Ø¥Ø²Ø§Ù„Ø©' },
    // Location voiture
    carPickup: { fr: 'Prise en charge', en: 'Pickup', es: 'Recogida', it: 'Ritiro', pt: 'Retirada', ar: 'Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' },
    carDropoff: { fr: 'Restitution', en: 'Dropoff', es: 'DevoluciÃ³n', it: 'Riconsegna', pt: 'DevoluÃ§Ã£o', ar: 'Ø§Ù„ØªØ³Ù„ÙŠÙ…' },
    vehicleType: { fr: 'Type vÃ©hicule', en: 'Vehicle type', es: 'Tipo vehÃ­culo', it: 'Tipo veicolo', pt: 'Tipo veÃ­culo', ar: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©' },
    vehicleModel: { fr: 'ModÃ¨le', en: 'Model', es: 'Modelo', it: 'Modello', pt: 'Modelo', ar: 'Ø§Ù„Ø·Ø±Ø§Ø²' },
    mileage: { fr: 'KilomÃ©trage', en: 'Mileage', es: 'Kilometraje', it: 'Chilometraggio', pt: 'Quilometragem', ar: 'Ø§Ù„Ù…Ø³Ø§ÙØ©' },
    fuelPolicy: { fr: 'Carburant', en: 'Fuel policy', es: 'PolÃ­tica combustible', it: 'Politica carburante', pt: 'PolÃ­tica combustÃ­vel', ar: 'Ø³ÙŠØ§Ø³Ø© Ø§Ù„ÙˆÙ‚ÙˆØ¯' }
  };
  
  let lang = localStorage.getItem('ORT_LANG') || localStorage.getItem('lang')?.slice(0,2) || navigator.language?.slice(0,2) || 'fr';
  if (!['fr','en','es','it','pt','ar'].includes(lang)) lang = 'en';
  
  function t(key) {
    return window.ORT_I18N?.[key]?.[lang] || I18N_LOCAL[key]?.[lang] || I18N_LOCAL[key]?.fr || key;
  }
  
  function applyI18N() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const text = t(key);
      if (text && text !== key) el.textContent = text;
    });
    // Tooltips
    document.querySelectorAll('[data-i18n-title]').forEach(el => {
      const key = el.getAttribute('data-i18n-title');
      const text = t(key);
      if (text && text !== key) el.setAttribute('title', text);
    });
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const params = new URLSearchParams(location.search);
  let tripId = params.get('tripId') || params.get('id');
  const cc = params.get('cc') || '';
  const itin = params.get('itin') || '';
  
  let trip = null;
  let bookingType = 'step'; // 'step' or 'travel'
  let selectedCategory = 'hotel';
  
  const $ = id => document.getElementById(id);
  const loadingOverlay = $('loadingOverlay');
  const toast = $('toast');
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function init() {
    console.log('[RT-BOOKING-IMPORT] Init...', { tripId, cc, itin });
    applyI18N();
    
    if (window.ORT_TRIPID) {
      tripId = ORT_TRIPID.init();
    }
    
    if (!tripId) {
      showToast(t('noTrip'), 'error');
      loadingOverlay.style.display = 'none';
      return;
    }
    
    const user = await waitForAuth();
    if (!user) {
      showBlockingMessage('login');
      return;
    }
    
    const tripSaved = await checkTripSaved(user.uid, tripId);
    if (!tripSaved) {
      showBlockingMessage('tripNotSaved');
      return;
    }
    
    await loadTrip();
    if (!trip) {
      showToast(t('noTrip'), 'error');
      loadingOverlay.style.display = 'none';
      return;
    }
    
    if (window.ORT_TRIP_DATA) {
      await ORT_TRIP_DATA.loadTrip(tripId);
    }
    
    populateStepSelector();
    renderExistingBookings(); // Afficher les rÃ©servations existantes
    setupEventListeners();
    
    loadingOverlay.style.display = 'none';
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DISCLAIMER IA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let disclaimerAccepted = false;
  
  async function checkDisclaimerAccepted() {
    // VÃ©rifier dans Firestore si l'utilisateur a acceptÃ©
    const user = firebase.auth().currentUser;
    if (!user) return false;
    
    try {
      const doc = await firebase.firestore()
        .collection('users')
        .doc(user.uid)
        .get();
      
      if (doc.exists && doc.data()?.aiDisclaimerAccepted) {
        disclaimerAccepted = true;
        return true;
      }
    } catch (e) {
      console.warn('[DISCLAIMER] Erreur lecture:', e);
    }
    return false;
  }
  
  async function saveDisclaimerAccepted() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    try {
      await firebase.firestore()
        .collection('users')
        .doc(user.uid)
        .set({ aiDisclaimerAccepted: true, aiDisclaimerAcceptedAt: Date.now() }, { merge: true });
      disclaimerAccepted = true;
      console.log('[DISCLAIMER] âœ… Acceptation enregistrÃ©e');
    } catch (e) {
      console.error('[DISCLAIMER] Erreur sauvegarde:', e);
    }
  }
  
  function showDisclaimerModal(onAccept) {
    const modalId = 'aiDisclaimerModal';
    let modal = document.getElementById(modalId);
    if (modal) modal.remove();
    
    modal = document.createElement('div');
    modal.id = modalId;
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
    
    modal.innerHTML = `
      <div style="background:#fff;border-radius:16px;max-width:450px;width:100%;padding:24px;text-align:center">
        <div style="font-size:3rem;margin-bottom:16px">ğŸ¤–</div>
        <h2 style="margin:0 0 16px 0;color:#113f7a;font-size:1.2rem">${t('extractedInfo')}</h2>
        <p style="color:#666;font-size:0.95rem;line-height:1.5;margin-bottom:24px">${t('aiDisclaimer')}</p>
        <div style="display:flex;flex-direction:column;gap:10px">
          <button id="disclaimerAcceptBtn" style="padding:12px 24px;background:#16a34a;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.95rem">
            âœ… ${t('aiDisclaimerAccept')}
          </button>
          <button id="disclaimerContinueBtn" style="padding:10px 20px;background:#e5e7eb;color:#374151;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem">
            ${t('aiDisclaimerContinue')}
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Accepter et ne plus afficher
    document.getElementById('disclaimerAcceptBtn').addEventListener('click', async () => {
      await saveDisclaimerAccepted();
      modal.remove();
      if (onAccept) onAccept();
    });
    
    // Continuer sans accepter dÃ©finitivement
    document.getElementById('disclaimerContinueBtn').addEventListener('click', () => {
      modal.remove();
      if (onAccept) onAccept();
    });
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AFFICHAGE DES RÃ‰SERVATIONS EXISTANTES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const CATEGORY_ICONS = {
    hotel: 'ğŸ¨', activity: 'ğŸ¯', flight: 'âœˆï¸', car_rental: 'ğŸš—',
    insurance: 'ğŸ›¡ï¸', visit: 'ğŸ›ï¸', show: 'ğŸ­', transfer: 'ğŸš', other: 'ğŸ“‹'
  };
  
  function renderExistingBookings() {
    renderStepBookings();
    renderTravelBookings();
  }
  
  function renderStepBookings() {
    const container = $('stepBookingsList');
    
    if (!trip?.steps || trip.steps.length === 0) {
      container.innerHTML = `<div class="existing-empty">${t('noSteps')}</div>`;
      return;
    }
    
    // Collecter TOUTES les rÃ©sas de toutes les Ã©tapes
    const allStepBookings = [];
    trip.steps.forEach((step, idx) => {
      const bookings = window.ORT_TRIP_DATA ? ORT_TRIP_DATA.getStepBookings(idx) : (step.bookings || []);
      bookings.forEach(b => {
        if (!allStepBookings.find(ab => ab.id === b.id)) {
          allStepBookings.push({ ...b, _originalStepIdx: idx });
        }
      });
    });
    
    let html = '';
    let hasAnyBooking = false;
    
    trip.steps.forEach((step, idx) => {
      // RÃ©sas qui appartiennent Ã  cette Ã©tape (via stepIndexes ou _originalStepIdx)
      const bookingsForStep = allStepBookings.filter(b => {
        if (b.stepIndexes && b.stepIndexes.length > 0) {
          return b.stepIndexes.includes(idx);
        }
        return b._originalStepIdx === idx;
      });
      
      const count = bookingsForStep.length;
      if (count > 0) hasAnyBooking = true;
      
      html += `
        <div class="step-group">
          <div class="step-header ${count > 0 ? 'has-bookings' : ''}" onclick="toggleStepBookings(${idx})">
            <span class="step-num">${idx + 1}</span>
            <span class="step-name">${escHtml(step.name || t('step') + ' ' + (idx + 1))}</span>
            ${count > 0 ? `<span class="count">${count}</span>` : ''}
            <span class="arrow">â€º</span>
          </div>
          <div class="step-bookings" id="stepBookings${idx}">
            ${count > 0 ? renderBookingList(bookingsForStep, 'step', idx) : `<div class="existing-empty" style="padding:8px">${t('noBookings')}</div>`}
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html || `<div class="existing-empty">${t('noSteps')}</div>`;
  }
  
  function renderTravelBookings() {
    const container = $('travelBookingsList');
    const bookings = window.ORT_TRIP_DATA ? ORT_TRIP_DATA.getTravelBookings() : (trip?.travelBookings || []);
    
    if (!bookings || bookings.length === 0) {
      container.innerHTML = `<div class="existing-empty">${t('noTravelBookings')}</div>`;
      return;
    }
    
    container.innerHTML = `<div class="booking-list">${renderBookingList(bookings, 'travel')}</div>`;
  }
  
  function renderBookingList(bookings, type, stepIdx = -1) {
    // DÃ©doublonner par ID ou par nom+date
    const seen = new Set();
    const uniqueBookings = bookings.filter(b => {
      const key = b.id || `${b.name}-${b.date_start || ''}-${b.category}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
    
    return uniqueBookings.map((b, i) => {
      const icon = CATEGORY_ICONS[b.category] || 'ğŸ“‹';
      const totalPrice = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : null;
      const dateStr = b.date_start || b.dateStart || '';
      const bookingId = b.id || `idx_${i}`;
      
      // Calculer le prix divisÃ© si multi-step
      const stepCount = b.stepIndexes?.length || 1;
      const displayPrice = totalPrice ? (totalPrice / stepCount) : null;
      const isShared = stepCount > 1;
      
      // Utiliser _originalStepIdx pour les opÃ©rations (lÃ  oÃ¹ la rÃ©sa est vraiment stockÃ©e)
      const actualStepIdx = b._originalStepIdx !== undefined ? b._originalStepIdx : stepIdx;
      
      return `
        <div class="booking-item" data-id="${bookingId}">
          <span class="cat-icon">${icon}</span>
          <div class="info">
            <div class="name">${escHtml(b.name || t('noName'))}</div>
            <div class="details">
              ${dateStr ? `<span>ğŸ“… ${formatDate(dateStr)}</span>` : ''}
              ${b.reference ? `<span>ğŸ”– ${escHtml(b.reference)}</span>` : ''}
              ${isShared ? `<span style="color:#3b82f6">ğŸ”— ${stepCount}</span>` : ''}
            </div>
          </div>
          ${displayPrice ? `<span class="price">${Math.round(displayPrice)} â‚¬${isShared ? `<span class="price-split">/${stepCount}</span>` : ''}</span>` : ''}
          <button class="btn-edit" onclick="editBooking('${type}', ${actualStepIdx}, '${bookingId}')" title="${t('edit') || 'Modifier'}">âœï¸</button>
          <button class="btn-delete" onclick="deleteBooking('${type}', ${actualStepIdx}, '${bookingId}')" title="${t('delete') || 'Supprimer'}">Ã—</button>
        </div>
      `;
    }).join('');
  }
  
  // Variables pour l'Ã©dition
  let editingBooking = null;
  let editingType = null;
  let editingStepIdx = -1;
  let editingBookingId = null;
  let editNewType = 'step';
  let editNewCategory = 'hotel';
  
  window.editBooking = function(type, stepIdx, bookingId) {
    // Trouver la rÃ©servation
    let booking = null;
    if (type === 'travel') {
      const bookings = ORT_TRIP_DATA.getTravelBookings() || [];
      booking = bookings.find(b => b.id === bookingId) || bookings.find((b, i) => `idx_${i}` === bookingId);
    } else {
      const bookings = ORT_TRIP_DATA.getStepBookings(stepIdx) || [];
      booking = bookings.find(b => b.id === bookingId) || bookings.find((b, i) => `idx_${i}` === bookingId);
    }
    
    if (!booking) {
      showToast(t('bookingNotFound'), 'error');
      return;
    }
    
    // Stocker pour la sauvegarde
    editingBooking = booking;
    editingType = type;
    editingStepIdx = stepIdx;
    editingBookingId = bookingId;
    editNewType = booking.bookingType || type;
    editNewCategory = booking.category || 'hotel';
    
    // SÃ©lectionner le type (mini buttons)
    $('editTypeStep').classList.toggle('active', editNewType === 'step');
    $('editTypeTravel').classList.toggle('active', editNewType === 'travel');
    $('editStepSelectorWrap').style.display = editNewType === 'step' ? 'block' : 'none';
    
    // Remplir le select d'Ã©tapes
    populateEditStepSelector();
    
    // Initialiser les Ã©tapes sÃ©lectionnÃ©es
    editSelectedSteps = booking.stepIndexes ? [...booking.stepIndexes] : (type === 'step' ? [stepIdx] : []);
    renderSelectedSteps();
    
    // CatÃ©gorie (mini icons)
    document.querySelectorAll('#editCategorySelector .cat-mini').forEach(b => {
      b.classList.toggle('active', b.dataset.cat === editNewCategory);
    });
    
    // Champs
    $('editFieldName').value = booking.name || '';
    $('editFieldDateStart').value = booking.date_start || booking.dateStart || '';
    $('editFieldDateEnd').value = booking.date_end || booking.dateEnd || '';
    $('editFieldRef').value = booking.reference || '';
    $('editFieldPrice').value = booking.price ? (typeof booking.price === 'object' ? booking.price.amount : booking.price) : '';
    $('editFieldAddress').value = booking.address || '';
    $('editFieldNotes').value = booking.notes || '';
    
    // Afficher l'Ã©diteur spÃ©cifique si vol ou location voiture
    const previewBox = $('editPreviewBox');
    if (editNewCategory === 'flight' && booking.flights && booking.flights.length > 0) {
      previewBox.style.display = 'block';
      previewBox.innerHTML = generateFlightsEditor(booking.flights, booking.provider);
      parsedData = booking; // Pour avoir accÃ¨s aux donnÃ©es
    } else if (editNewCategory === 'car_rental' && booking.car_rental) {
      previewBox.style.display = 'block';
      previewBox.innerHTML = generateCarRentalEditor(booking.car_rental);
      parsedData = booking;
    } else {
      previewBox.style.display = 'none';
      parsedData = null;
    }
    
    // Mettre Ã  jour le prix par Ã©tape
    updatePricePerStep();
    
    // Afficher la modal
    $('editModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  };
  
  window.closeEditModal = function() {
    $('editModal').classList.remove('show');
    document.body.style.overflow = '';
    editingBooking = null;
    editingType = null;
    editingStepIdx = -1;
    editingBookingId = null;
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MODAL PARSING (rÃ©utilise editModal)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let editMode = 'edit'; // 'edit' ou 'parse'
  let parsedData = null; // DonnÃ©es parsÃ©es par l'IA (pour les flights, etc.)
  
  async function openParseModal(data, preview = null) {
    // VÃ©rifier si le disclaimer a Ã©tÃ© acceptÃ©
    if (!disclaimerAccepted) {
      const accepted = await checkDisclaimerAccepted();
      if (!accepted) {
        // Afficher le disclaimer puis ouvrir la modale
        showDisclaimerModal(() => doOpenParseModal(data, preview));
        return;
      }
    }
    doOpenParseModal(data, preview);
  }
  
  function doOpenParseModal(data, preview = null) {
    // Passer en mode parsing
    editMode = 'parse';
    parsedData = data; // Stocker les donnÃ©es complÃ¨tes (avec flights si vol)
    editingBooking = null;
    editingType = null;
    editingStepIdx = -1;
    editingBookingId = null;
    
    // Reprendre le type et l'Ã©tape sÃ©lectionnÃ©s dans le formulaire principal
    editNewType = bookingType;
    editNewCategory = data.category || 'hotel';
    editSelectedSteps = [];
    
    const mainStepIdx = parseInt($('stepSelector').value);
    if (editNewType === 'step' && !isNaN(mainStepIdx) && mainStepIdx >= 0) {
      editSelectedSteps = [mainStepIdx];
    }
    
    // Changer le header (vert + titre)
    const header = $('editModalHeader');
    header.style.background = '#16a34a';
    $('editModalTitle').innerHTML = 'âœ… ' + t('extractedInfo');
    
    // Afficher et remplir la preview avec champs Ã©ditables
    const previewBox = $('editPreviewBox');
    previewBox.style.display = 'block';
    
    // GÃ©nÃ©rer le contenu Ã©ditable selon le type
    if (data.category === 'flight' && data.flights && data.flights.length > 0) {
      // === VOLS Ã‰DITABLES ===
      previewBox.innerHTML = generateFlightsEditor(data.flights, data.provider);
    } else if (data.category === 'car_rental' && data.car_rental) {
      // === LOCATION VOITURE Ã‰DITABLE ===
      previewBox.innerHTML = generateCarRentalEditor(data.car_rental);
    } else if (preview && preview.fields) {
      // Autres catÃ©gories : preview classique
      previewBox.innerHTML = `
        <div class="parse-preview-header">
          <span class="parse-preview-icon">${preview.icon || 'ğŸ“‹'}</span>
          <div>
            <div class="parse-preview-title">${escHtml(preview.title)}</div>
            ${preview.subtitle ? `<div class="parse-preview-subtitle">${escHtml(preview.subtitle)}</div>` : ''}
          </div>
        </div>
        <div class="parse-preview-fields">
          ${preview.fields.map(f => {
            if (f.isHeader) {
              return `<div class="parse-preview-field" style="margin-top:8px;font-weight:700;color:#1e40af;border-top:1px solid #bbf7d0;padding-top:8px">${escHtml(f.value)}</div>`;
            }
            return `<div class="parse-preview-field"><span class="icon">${f.icon}</span><span class="value">${escHtml(f.value)}</span></div>`;
          }).join('')}
        </div>
      `;
    } else {
      previewBox.innerHTML = '';
    }
    
    // Type selector
    $('editTypeStep').classList.toggle('active', editNewType === 'step');
    $('editTypeTravel').classList.toggle('active', editNewType === 'travel');
    $('editStepSelectorWrap').style.display = editNewType === 'step' ? 'block' : 'none';
    
    // Remplir le select d'Ã©tapes
    populateEditStepSelector();
    renderSelectedSteps();
    
    // CatÃ©gorie
    document.querySelectorAll('#editCategorySelector .cat-mini').forEach(b => {
      b.classList.toggle('active', b.dataset.cat === editNewCategory);
    });
    
    // Champs
    $('editFieldName').value = data.name || '';
    $('editFieldDateStart').value = data.date_start || '';
    $('editFieldDateEnd').value = data.date_end || '';
    $('editFieldPrice').value = data.price || '';
    $('editFieldRef').value = data.reference || '';
    $('editFieldAddress').value = data.address || '';
    $('editFieldNotes').value = data.notes || '';
    
    // Ouvrir
    $('editModal').classList.add('show');
    document.body.style.overflow = 'hidden';
    
    updatePricePerStep();
  }
  
  // GÃ©nÃ©rer l'Ã©diteur de vols
  function generateFlightsEditor(flights, provider) {
    const inputStyle = 'padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;width:100%';
    const labelStyle = 'font-size:0.75rem;color:#6b7280;margin-bottom:2px;display:block';
    
    let html = `<div class="flights-editor" style="font-size:0.9rem">`;
    
    // Compagnie aÃ©rienne (global)
    html += `
      <div style="margin-bottom:12px">
        <label style="${labelStyle}">ğŸ¢ ${t('airline')}</label>
        <input type="text" id="flightProvider" value="${escHtml(provider || flights[0]?.airline || '')}" style="${inputStyle}" placeholder="${t('airline')}">
      </div>
    `;
    
    flights.forEach((flight, idx) => {
      const typeLabel = flight.type === 'outbound' ? t('flightOutbound') : (flight.type === 'return' ? t('flightReturn') : t('flightSegment') + ' ' + (idx + 1));
      const typeColor = flight.type === 'outbound' ? '#16a34a' : (flight.type === 'return' ? '#dc2626' : '#3b82f6');
      
      html += `
        <div class="flight-segment" data-idx="${idx}" style="background:#f8fafc;border:2px solid ${typeColor};border-radius:10px;padding:12px;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <span style="font-weight:700;color:${typeColor}">âœˆï¸ ${typeLabel}</span>
            <select id="flightType${idx}" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:0.8rem">
              <option value="outbound" ${flight.type === 'outbound' ? 'selected' : ''}>${t('flightOutbound')}</option>
              <option value="return" ${flight.type === 'return' ? 'selected' : ''}>${t('flightReturn')}</option>
            </select>
          </div>
          
          <!-- NÂ° vol -->
          <div style="margin-bottom:8px">
            <label style="${labelStyle}">ğŸ”¢ ${t('flightNumber')}</label>
            <input type="text" id="flightNumber${idx}" value="${escHtml(flight.flight_number || '')}" style="${inputStyle}" placeholder="ex: AF1234">
          </div>
          
          <!-- DÃ©part -->
          <div style="background:#e0f2fe;border-radius:8px;padding:10px;margin-bottom:8px">
            <div style="font-weight:600;color:#0369a1;margin-bottom:8px">ğŸ›« ${t('departure')}</div>
            <div style="display:grid;grid-template-columns:1fr 80px;gap:6px;margin-bottom:6px">
              <input type="text" id="flightDepCity${idx}" value="${escHtml(flight.departure_city || '')}" style="${inputStyle}" placeholder="${t('city')}">
              <input type="text" id="flightDepAirport${idx}" value="${escHtml(flight.departure_airport || '')}" style="${inputStyle}" placeholder="Code">
            </div>
            <div style="display:grid;grid-template-columns:1fr 90px;gap:6px">
              <input type="date" id="flightDepDate${idx}" value="${flight.departure_date || ''}" style="${inputStyle}">
              <input type="time" id="flightDepTime${idx}" value="${flight.departure_time || ''}" style="${inputStyle}">
            </div>
          </div>
          
          <!-- ArrivÃ©e -->
          <div style="background:#fef3c7;border-radius:8px;padding:10px;margin-bottom:8px">
            <div style="font-weight:600;color:#b45309;margin-bottom:8px">ğŸ›¬ ${t('arrival')}</div>
            <div style="display:grid;grid-template-columns:1fr 80px;gap:6px;margin-bottom:6px">
              <input type="text" id="flightArrCity${idx}" value="${escHtml(flight.arrival_city || '')}" style="${inputStyle}" placeholder="${t('city')}">
              <input type="text" id="flightArrAirport${idx}" value="${escHtml(flight.arrival_airport || '')}" style="${inputStyle}" placeholder="Code">
            </div>
            <div style="display:grid;grid-template-columns:1fr 90px;gap:6px">
              <input type="date" id="flightArrDate${idx}" value="${flight.arrival_date || ''}" style="${inputStyle}">
              <input type="time" id="flightArrTime${idx}" value="${flight.arrival_time || ''}" style="${inputStyle}">
            </div>
          </div>
          
          <!-- DurÃ©e -->
          <div style="display:grid;grid-template-columns:1fr;gap:6px">
            <div>
              <label style="${labelStyle}">â±ï¸ ${t('duration')}</label>
              <input type="text" id="flightDuration${idx}" value="${formatDurationFromMinutes(flight.duration_minutes)}" style="${inputStyle}" placeholder="${t('durationHint')}">
            </div>
          </div>
        </div>
      `;
    });
    
    // Bouton ajouter segment
    html += `
      <button type="button" onclick="addFlightSegment()" style="width:100%;padding:10px;border:2px dashed #9ca3af;border-radius:8px;background:none;color:#6b7280;cursor:pointer;font-size:0.9rem">
        ${t('addSegment')}
      </button>
    </div>`;
    
    return html;
  }
  
  // GÃ©nÃ©rer l'Ã©diteur de location voiture
  function generateCarRentalEditor(carRental) {
    const inputStyle = 'padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;width:100%';
    const labelStyle = 'font-size:0.75rem;color:#6b7280;margin-bottom:2px;display:block';
    const car = carRental || {};
    
    return `
      <div class="car-rental-editor" style="font-size:0.9rem">
        <!-- VÃ©hicule -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
          <div>
            <label style="${labelStyle}">ğŸš— ${t('vehicleType')}</label>
            <input type="text" id="carVehicleType" value="${escHtml(car.vehicle_type || '')}" style="${inputStyle}" placeholder="SUV, Berline...">
          </div>
          <div>
            <label style="${labelStyle}">${t('vehicleModel')}</label>
            <input type="text" id="carVehicleModel" value="${escHtml(car.vehicle_model || '')}" style="${inputStyle}" placeholder="Peugeot 208...">
          </div>
        </div>
        
        <!-- Prise en charge -->
        <div style="background:#dcfce7;border:2px solid #16a34a;border-radius:10px;padding:12px;margin-bottom:12px">
          <div style="font-weight:700;color:#16a34a;margin-bottom:10px">ğŸ“ ${t('carPickup')}</div>
          <div style="margin-bottom:8px">
            <label style="${labelStyle}">${t('address')}</label>
            <input type="text" id="carPickupLocation" value="${escHtml(car.pickup_location || '')}" style="${inputStyle}" placeholder="AÃ©roport, agence...">
          </div>
          <div style="display:grid;grid-template-columns:1fr 90px;gap:6px">
            <input type="date" id="carPickupDate" value="${car.pickup_date || ''}" style="${inputStyle}">
            <input type="time" id="carPickupTime" value="${car.pickup_time || ''}" style="${inputStyle}">
          </div>
        </div>
        
        <!-- Restitution -->
        <div style="background:#fef2f2;border:2px solid #dc2626;border-radius:10px;padding:12px;margin-bottom:12px">
          <div style="font-weight:700;color:#dc2626;margin-bottom:10px">ğŸ“ ${t('carDropoff')}</div>
          <div style="margin-bottom:8px">
            <label style="${labelStyle}">${t('address')}</label>
            <input type="text" id="carDropoffLocation" value="${escHtml(car.dropoff_location || '')}" style="${inputStyle}" placeholder="AÃ©roport, agence...">
          </div>
          <div style="display:grid;grid-template-columns:1fr 90px;gap:6px">
            <input type="date" id="carDropoffDate" value="${car.dropoff_date || ''}" style="${inputStyle}">
            <input type="time" id="carDropoffTime" value="${car.dropoff_time || ''}" style="${inputStyle}">
          </div>
        </div>
        
        <!-- Options -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label style="${labelStyle}">ğŸ›£ï¸ ${t('mileage')}</label>
            <input type="text" id="carMileage" value="${escHtml(car.included_km || '')}" style="${inputStyle}" placeholder="IllimitÃ©...">
          </div>
          <div>
            <label style="${labelStyle}">â›½ ${t('fuelPolicy')}</label>
            <input type="text" id="carFuelPolicy" value="${escHtml(car.fuel_policy || '')}" style="${inputStyle}" placeholder="Plein/Plein...">
          </div>
        </div>
      </div>
    `;
  }
  
  // Formater durÃ©e en minutes vers format lisible
  function formatDurationFromMinutes(minutes) {
    if (!minutes) return '';
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return m > 0 ? `${h}h${String(m).padStart(2, '0')}` : `${h}h`;
  }
  
  // Parser durÃ©e format "2h30" vers minutes
  function parseDurationToMinutes(str) {
    if (!str) return null;
    const match = str.match(/(\d+)\s*h\s*(\d*)/i);
    if (match) {
      const h = parseInt(match[1]) || 0;
      const m = parseInt(match[2]) || 0;
      return h * 60 + m;
    }
    // Essayer format nombre seul (minutes)
    const num = parseInt(str);
    return isNaN(num) ? null : num;
  }
  
  // Ajouter un segment de vol
  window.addFlightSegment = function() {
    const container = document.querySelector('.flights-editor');
    if (!container) return;
    
    const segments = container.querySelectorAll('.flight-segment');
    const newIdx = segments.length;
    
    // DÃ©terminer le type (alterner aller/retour)
    const lastType = segments.length > 0 ? (document.getElementById(`flightType${newIdx - 1}`)?.value || 'outbound') : 'outbound';
    const newType = lastType === 'outbound' ? 'return' : 'outbound';
    
    const inputStyle = 'padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;width:100%';
    const labelStyle = 'font-size:0.75rem;color:#6b7280;margin-bottom:2px;display:block';
    const typeColor = newType === 'outbound' ? '#16a34a' : '#dc2626';
    const typeLabel = newType === 'outbound' ? t('flightOutbound') : t('flightReturn');
    
    const html = `
      <div class="flight-segment" data-idx="${newIdx}" style="background:#f8fafc;border:2px solid ${typeColor};border-radius:10px;padding:12px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <span style="font-weight:700;color:${typeColor}">âœˆï¸ ${typeLabel}</span>
          <div style="display:flex;gap:6px;align-items:center">
            <select id="flightType${newIdx}" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:0.8rem">
              <option value="outbound" ${newType === 'outbound' ? 'selected' : ''}>${t('flightOutbound')}</option>
              <option value="return" ${newType === 'return' ? 'selected' : ''}>${t('flightReturn')}</option>
            </select>
            <button type="button" onclick="removeFlightSegment(${newIdx})" style="padding:4px 8px;background:#fee2e2;color:#dc2626;border:none;border-radius:4px;cursor:pointer;font-size:0.75rem">${t('removeSegment')}</button>
          </div>
        </div>
        <div style="margin-bottom:8px">
          <label style="${labelStyle}">ğŸ”¢ ${t('flightNumber')}</label>
          <input type="text" id="flightNumber${newIdx}" value="" style="${inputStyle}" placeholder="ex: AF1234">
        </div>
        <div style="background:#e0f2fe;border-radius:8px;padding:10px;margin-bottom:8px">
          <div style="font-weight:600;color:#0369a1;margin-bottom:8px">ğŸ›« ${t('departure')}</div>
          <div style="display:grid;grid-template-columns:1fr 80px;gap:6px;margin-bottom:6px">
            <input type="text" id="flightDepCity${newIdx}" value="" style="${inputStyle}" placeholder="${t('city')}">
            <input type="text" id="flightDepAirport${newIdx}" value="" style="${inputStyle}" placeholder="Code">
          </div>
          <div style="display:grid;grid-template-columns:1fr 90px;gap:6px">
            <input type="date" id="flightDepDate${newIdx}" value="" style="${inputStyle}">
            <input type="time" id="flightDepTime${newIdx}" value="" style="${inputStyle}">
          </div>
        </div>
        <div style="background:#fef3c7;border-radius:8px;padding:10px;margin-bottom:8px">
          <div style="font-weight:600;color:#b45309;margin-bottom:8px">ğŸ›¬ ${t('arrival')}</div>
          <div style="display:grid;grid-template-columns:1fr 80px;gap:6px;margin-bottom:6px">
            <input type="text" id="flightArrCity${newIdx}" value="" style="${inputStyle}" placeholder="${t('city')}">
            <input type="text" id="flightArrAirport${newIdx}" value="" style="${inputStyle}" placeholder="Code">
          </div>
          <div style="display:grid;grid-template-columns:1fr 90px;gap:6px">
            <input type="date" id="flightArrDate${newIdx}" value="" style="${inputStyle}">
            <input type="time" id="flightArrTime${newIdx}" value="" style="${inputStyle}">
          </div>
        </div>
        <div>
          <label style="${labelStyle}">â±ï¸ ${t('duration')}</label>
          <input type="text" id="flightDuration${newIdx}" value="" style="${inputStyle}" placeholder="${t('durationHint')}">
        </div>
      </div>
    `;
    
    // InsÃ©rer avant le bouton "ajouter"
    const addBtn = container.querySelector('button[onclick*="addFlightSegment"]');
    if (addBtn) {
      addBtn.insertAdjacentHTML('beforebegin', html);
    }
  };
  
  window.removeFlightSegment = function(idx) {
    const segment = document.querySelector(`.flight-segment[data-idx="${idx}"]`);
    if (segment) segment.remove();
  };
  
  // Collecter les donnÃ©es des vols depuis l'Ã©diteur
  function collectFlightsFromEditor() {
    const flights = [];
    const segments = document.querySelectorAll('.flight-segment');
    
    segments.forEach((segment, i) => {
      const idx = segment.dataset.idx;
      flights.push({
        type: document.getElementById(`flightType${idx}`)?.value || 'outbound',
        flight_number: document.getElementById(`flightNumber${idx}`)?.value || null,
        airline: document.getElementById('flightProvider')?.value || null,
        departure_city: document.getElementById(`flightDepCity${idx}`)?.value || null,
        departure_airport: document.getElementById(`flightDepAirport${idx}`)?.value || null,
        departure_date: document.getElementById(`flightDepDate${idx}`)?.value || null,
        departure_time: document.getElementById(`flightDepTime${idx}`)?.value || null,
        arrival_city: document.getElementById(`flightArrCity${idx}`)?.value || null,
        arrival_airport: document.getElementById(`flightArrAirport${idx}`)?.value || null,
        arrival_date: document.getElementById(`flightArrDate${idx}`)?.value || null,
        arrival_time: document.getElementById(`flightArrTime${idx}`)?.value || null,
        duration_minutes: parseDurationToMinutes(document.getElementById(`flightDuration${idx}`)?.value)
      });
    });
    
    return flights;
  }
  
  // Collecter les donnÃ©es de location depuis l'Ã©diteur
  function collectCarRentalFromEditor() {
    return {
      vehicle_type: document.getElementById('carVehicleType')?.value || null,
      vehicle_model: document.getElementById('carVehicleModel')?.value || null,
      pickup_location: document.getElementById('carPickupLocation')?.value || null,
      pickup_date: document.getElementById('carPickupDate')?.value || null,
      pickup_time: document.getElementById('carPickupTime')?.value || null,
      dropoff_location: document.getElementById('carDropoffLocation')?.value || null,
      dropoff_date: document.getElementById('carDropoffDate')?.value || null,
      dropoff_time: document.getElementById('carDropoffTime')?.value || null,
      included_km: document.getElementById('carMileage')?.value || null,
      fuel_policy: document.getElementById('carFuelPolicy')?.value || null
    };
  }

  function resetEditModalToEditMode() {
    // Remettre le header bleu
    const header = $('editModalHeader');
    header.style.background = '';
    $('editModalTitle').innerHTML = 'âœï¸ ' + t('editBooking');
    
    // Cacher la preview
    $('editPreviewBox').style.display = 'none';
    
    editMode = 'edit';
    parsedData = null;
  }
  
  // Modifier closeEditModal pour gÃ©rer les deux modes
  const originalCloseEditModal = window.closeEditModal;
  window.closeEditModal = function() {
    $('editModal').classList.remove('show');
    document.body.style.overflow = '';
    
    // Si c'Ã©tait un parsing, vider le textarea
    if (editMode === 'parse') {
      $('emailText').value = '';
    }
    
    // Reset
    resetEditModalToEditMode();
    editingBooking = null;
    editingType = null;
    editingStepIdx = -1;
    editingBookingId = null;
  };
  
  window.saveEditedBooking = async function() {
    const name = $('editFieldName').value.trim();
    if (!name) {
      showToast(t('enterName'), 'error');
      return;
    }
    
    // Validation selon le type
    if (editNewType === 'step' && editSelectedSteps.length === 0) {
      showToast(t('selectAtLeastOneStep'), 'error');
      return;
    }
    
    const totalPrice = $('editFieldPrice').value ? parseFloat($('editFieldPrice').value) : null;
    
    if (editMode === 'parse') {
      // Mode PARSING : crÃ©er une nouvelle rÃ©servation
      const booking = {
        id: `booking_${Date.now()}`,
        category: editNewCategory,
        name: name,
        date_start: $('editFieldDateStart').value || null,
        date_end: $('editFieldDateEnd').value || null,
        reference: $('editFieldRef').value.trim() || null,
        price: totalPrice,
        address: $('editFieldAddress').value.trim() || null,
        notes: $('editFieldNotes').value.trim() || null,
        addedAt: Date.now(),
        updatedAt: Date.now(),
        bookingType: editNewType
      };
      
      // Ajouter les infos de vol si c'est un vol (collecter depuis l'Ã©diteur)
      if (editNewCategory === 'flight') {
        const editorFlights = collectFlightsFromEditor();
        if (editorFlights.length > 0) {
          booking.flights = editorFlights;
          booking.provider = document.getElementById('flightProvider')?.value || null;
        } else if (parsedData?.flights) {
          booking.flights = parsedData.flights;
          booking.provider = parsedData.provider || null;
        }
      }
      
      // Ajouter les infos de location si c'est une voiture (collecter depuis l'Ã©diteur)
      if (editNewCategory === 'car_rental') {
        const editorCarRental = collectCarRentalFromEditor();
        if (editorCarRental.pickup_location || editorCarRental.dropoff_location) {
          booking.car_rental = editorCarRental;
        } else if (parsedData?.car_rental) {
          booking.car_rental = parsedData.car_rental;
        }
        booking.provider = parsedData?.provider || null;
      }
      
      // Multi-step
      if (editNewType === 'step' && editSelectedSteps.length > 0) {
        booking.stepIndexes = [...editSelectedSteps];
      }
      
      let success = false;
      
      if (window.ORT_TRIP_DATA) {
        if (editNewType === 'travel') {
          success = ORT_TRIP_DATA.addTravelBooking(booking);
        } else {
          // Ajouter Ã  TOUTES les Ã©tapes sÃ©lectionnÃ©es (mÃªme ID, mÃªme stepIndexes)
          // Ainsi la rÃ©sa apparaÃ®t dans chaque Ã©tape mais avec le prix divisÃ©
          for (const stepIdx of editSelectedSteps) {
            success = ORT_TRIP_DATA.addStepBooking(stepIdx, booking);
          }
        }
        
        if (success) {
          await ORT_TRIP_DATA.forceSave();
        }
      }
      
      if (success) {
        showToast(t('saved'));
        renderExistingBookings();
        closeEditModal();
      } else {
        showToast(t('errorSaving'), 'error');
      }
      
    } else {
      // Mode EDIT : modifier une rÃ©servation existante
      const updatedBooking = {
        id: editingBooking?.id || editingBookingId,
        category: editNewCategory,
        name: name,
        date_start: $('editFieldDateStart').value || null,
        date_end: $('editFieldDateEnd').value || null,
        reference: $('editFieldRef').value.trim() || null,
        price: totalPrice,
        address: $('editFieldAddress').value.trim() || null,
        notes: $('editFieldNotes').value.trim() || null,
        addedAt: editingBooking?.addedAt || Date.now(),
        updatedAt: Date.now(),
        bookingType: editNewType
      };
      
      // Collecter les vols depuis l'Ã©diteur si prÃ©sent
      if (editNewCategory === 'flight') {
        const editorFlights = collectFlightsFromEditor();
        if (editorFlights.length > 0) {
          updatedBooking.flights = editorFlights;
          updatedBooking.provider = document.getElementById('flightProvider')?.value || editingBooking?.provider || null;
        } else if (editingBooking?.flights) {
          updatedBooking.flights = editingBooking.flights;
          updatedBooking.provider = editingBooking.provider;
        }
      }
      
      // Collecter la location voiture depuis l'Ã©diteur si prÃ©sent
      if (editNewCategory === 'car_rental') {
        const editorCarRental = collectCarRentalFromEditor();
        if (editorCarRental.pickup_location || editorCarRental.dropoff_location) {
          updatedBooking.car_rental = editorCarRental;
        } else if (editingBooking?.car_rental) {
          updatedBooking.car_rental = editingBooking.car_rental;
        }
        updatedBooking.provider = editingBooking?.provider || null;
      }
      
      // Multi-step
      if (editNewType === 'step' && editSelectedSteps.length > 0) {
        updatedBooking.stepIndexes = [...editSelectedSteps];
      }
      
      try {
        // Supprimer l'ancienne de toutes les Ã©tapes oÃ¹ elle Ã©tait
        if (editingType === 'travel') {
          ORT_TRIP_DATA.removeTravelBooking(editingBookingId);
        } else {
          // Supprimer des anciennes Ã©tapes
          const oldStepIndexes = editingBooking?.stepIndexes || [editingStepIdx];
          for (const stepIdx of oldStepIndexes) {
            ORT_TRIP_DATA.removeStepBooking(stepIdx, editingBookingId);
          }
        }
        
        // Ajouter la nouvelle Ã  toutes les Ã©tapes sÃ©lectionnÃ©es
        let success = false;
        if (editNewType === 'travel') {
          success = ORT_TRIP_DATA.addTravelBooking(updatedBooking);
        } else {
          for (const stepIdx of editSelectedSteps) {
            success = ORT_TRIP_DATA.addStepBooking(stepIdx, updatedBooking);
          }
        }
        
        if (success) {
          await ORT_TRIP_DATA.forceSave();
          renderExistingBookings();
          closeEditModal();
          showToast(t('bookingUpdated'));
        } else {
          showToast(t('errorSaving'), 'error');
        }
      } catch (e) {
        console.error('[EDIT SAVE]', e);
        showToast(t('errorSaving'), 'error');
      }
    }
  };
  
  // Event listeners pour la modal d'Ã©dition
  document.addEventListener('DOMContentLoaded', () => {
    // Type selector mini dans modal
    $('editTypeStep')?.addEventListener('click', () => {
      editNewType = 'step';
      $('editTypeStep').classList.add('active');
      $('editTypeTravel').classList.remove('active');
      $('editStepSelectorWrap').style.display = 'block';
    });
    
    $('editTypeTravel')?.addEventListener('click', () => {
      editNewType = 'travel';
      $('editTypeTravel').classList.add('active');
      $('editTypeStep').classList.remove('active');
      $('editStepSelectorWrap').style.display = 'none';
    });
    
    // Category selector mini dans modal
    document.querySelectorAll('#editCategorySelector .cat-mini').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#editCategorySelector .cat-mini').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        editNewCategory = btn.dataset.cat;
      });
    });
    
    // Mettre Ã  jour le prix par Ã©tape quand on change le prix
    $('editFieldPrice')?.addEventListener('input', updatePricePerStep);
    
    // Fermer modal avec Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && $('editModal').classList.contains('show')) {
        closeEditModal();
      }
    });
    
    // Fermer modal en cliquant Ã  l'extÃ©rieur
    $('editModal')?.addEventListener('click', (e) => {
      if (e.target === $('editModal')) {
        closeEditModal();
      }
    });
  });
  
  window.toggleStepBookings = function(idx) {
    const header = document.querySelector(`.step-group:nth-child(${idx + 1}) .step-header`);
    const content = $('stepBookings' + idx);
    if (header && content) {
      header.classList.toggle('open');
      content.classList.toggle('open');
    }
  };
  
  window.deleteBooking = async function(type, stepIdx, bookingId) {
    if (!confirm(t('confirmDelete'))) return;
    
    let success = false;
    if (window.ORT_TRIP_DATA) {
      if (type === 'travel') {
        success = ORT_TRIP_DATA.removeTravelBooking(bookingId);
      } else {
        success = ORT_TRIP_DATA.removeStepBooking(stepIdx, bookingId);
      }
      if (success) {
        await ORT_TRIP_DATA.forceSave();
        renderExistingBookings();
        showToast(t('bookingDeleted'));
      }
    }
    
    if (!success) {
      showToast(t('deleteError'), 'error');
    }
  };
  
  function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
      const d = new Date(dateStr);
      return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
    } catch (e) {
      return dateStr;
    }
  }
  
  function escHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  
  async function waitForAuth() {
    return new Promise(resolve => {
      const check = () => {
        if (window.firebase?.auth) {
          firebase.auth().onAuthStateChanged(user => resolve(user));
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    });
  }
  
  async function checkTripSaved(uid, tripId) {
    if (!uid || !tripId) return false;
    try {
      const db = firebase.firestore();
      const doc = await db.collection('users').doc(uid).collection('trips').doc(tripId).get();
      return doc.exists;
    } catch (e) {
      return false;
    }
  }
  
  function showBlockingMessage(type) {
    loadingOverlay.style.display = 'none';
    const messages = {
      login: { title: t('loginRequired') || 'Connexion requise', msg: t('loginRequiredMsg') || 'Vous devez Ãªtre connectÃ©.', btn: t('goBack') || 'Retour' },
      tripNotSaved: { title: t('tripSaveRequired') || 'Voyage non sauvegardÃ©', msg: t('tripSaveRequiredMsg') || 'Sauvegardez d\'abord le voyage.', btn: t('goBack') || 'Retour' }
    };
    const m = messages[type] || messages.login;
    
    const container = document.createElement('div');
    container.style.cssText = 'position:fixed;inset:0;background:linear-gradient(135deg,#1e3a5f,#2d5a87);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
    container.innerHTML = `
      <div style="background:#fff;border-radius:16px;padding:32px;max-width:400px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="font-size:48px;margin-bottom:16px;">ğŸ”’</div>
        <h2 style="color:#1e3a5f;margin:0 0 12px;">${m.title}</h2>
        <p style="color:#64748b;margin:0 0 24px;">${m.msg}</p>
        <button onclick="history.back()" style="background:#3b82f6;color:#fff;border:none;padding:12px 32px;border-radius:8px;font-weight:600;cursor:pointer;">${m.btn}</button>
      </div>
    `;
    document.body.appendChild(container);
  }
  
  async function loadTrip() {
    const stored = localStorage.getItem(`ort_trip_${tripId}`);
    if (stored) {
      try {
        trip = JSON.parse(stored);
        $('tripName').textContent = trip.title || '';
        return;
      } catch (e) {}
    }
    
    const user = firebase.auth().currentUser;
    if (user) {
      try {
        const doc = await firebase.firestore().collection('users').doc(user.uid).collection('trips').doc(tripId).get();
        if (doc.exists) {
          trip = doc.data();
          $('tripName').textContent = trip.title || '';
        }
      } catch (e) {}
    }
  }
  
  function populateStepSelector() {
    const select = $('stepSelector');
    select.innerHTML = '<option value="">-- ' + t('selectStep') + ' --</option>';
    
    if (trip?.steps) {
      trip.steps.forEach((step, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${i + 1}. ${step.name || step.location || t('step') + ' ' + (i + 1)}`;
        select.appendChild(opt);
      });
    }
  }
  
  // Pour la modal d'Ã©dition - remplir le select
  function populateEditStepSelector() {
    const select = $('editStepSelector');
    select.innerHTML = '<option value="">-- ' + t('selectStep') + ' --</option>';
    
    if (trip?.steps) {
      trip.steps.forEach((step, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${i + 1}. ${step.name || step.location || t('step') + ' ' + (i + 1)}`;
        select.appendChild(opt);
      });
    }
  }
  
  // Variable pour l'Ã©dition multi-step
  let editSelectedSteps = [];
  
  // Ajouter une Ã©tape Ã  la sÃ©lection
  window.addStepToSelection = function() {
    const select = $('editStepSelector');
    const idx = parseInt(select.value);
    if (isNaN(idx) || idx < 0) return;
    
    // Ã‰viter les doublons
    if (editSelectedSteps.includes(idx)) return;
    
    editSelectedSteps.push(idx);
    editSelectedSteps.sort((a, b) => a - b);
    
    renderSelectedSteps();
    updatePricePerStep();
    
    // Reset le select
    select.value = '';
  };
  
  // Retirer une Ã©tape de la sÃ©lection
  window.removeStepFromSelection = function(idx) {
    editSelectedSteps = editSelectedSteps.filter(i => i !== idx);
    renderSelectedSteps();
    updatePricePerStep();
  };
  
  // Afficher les Ã©tapes sÃ©lectionnÃ©es
  function renderSelectedSteps() {
    const container = $('selectedStepsList');
    if (!container) return;
    
    if (editSelectedSteps.length === 0) {
      container.innerHTML = '<span style="color:#94a3b8;font-size:0.85rem">' + (t('noStepSelected') || 'Aucune Ã©tape sÃ©lectionnÃ©e') + '</span>';
      return;
    }
    
    container.innerHTML = editSelectedSteps.map(idx => {
      const step = trip?.steps?.[idx];
      const name = step?.name || step?.location || t('step') + ' ' + (idx + 1);
      return `
        <span style="display:inline-flex;align-items:center;gap:4px;padding:6px 10px;background:#dbeafe;color:#1e40af;border-radius:16px;font-size:0.85rem;font-weight:500">
          <span style="background:#3b82f6;color:#fff;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem">${idx + 1}</span>
          ${escHtml(name)}
          <button onclick="removeStepFromSelection(${idx})" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:1rem;padding:0;margin-left:2px">Ã—</button>
        </span>
      `;
    }).join('');
  }
  
  // Calculer et afficher le prix par Ã©tape
  function updatePricePerStep() {
    const priceInput = $('editFieldPrice');
    const infoEl = $('pricePerStepInfo');
    if (!infoEl) return;
    
    const totalPrice = parseFloat(priceInput?.value) || 0;
    const stepCount = editSelectedSteps.length;
    
    if (stepCount > 1 && totalPrice > 0) {
      const perStep = (totalPrice / stepCount).toFixed(2);
      infoEl.textContent = `ğŸ’° ${perStep} â‚¬ par Ã©tape (${stepCount} Ã©tapes)`;
    } else {
      infoEl.textContent = '';
    }
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EVENT LISTENERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function setupEventListeners() {
    // Type selector (formulaire principal)
    document.querySelectorAll('#cardType .type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#cardType .type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bookingType = btn.dataset.type;
        $('stepSelectorWrap').style.display = bookingType === 'step' ? 'block' : 'none';
      });
    });
    
    // Category selector
    document.querySelectorAll('.cat-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedCategory = btn.dataset.cat;
      });
    });
    
    // Analyze button
    $('btnAnalyze').addEventListener('click', analyzeEmail);
    
    // Manual button
    $('btnManual').addEventListener('click', showManualForm);
    
    // Save button
    $('btnSaveBooking').addEventListener('click', saveBooking);
    
    // Reset button
    $('btnReset').addEventListener('click', resetForm);
    
    // Back buttons
    $('btnBackToTrip').addEventListener('click', goBack);
    
    // Reset all button
    $('btnResetAll').addEventListener('click', resetAllBookings);
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ANALYZE EMAIL (SIMPLE EXTRACTION)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function analyzeEmail() {
    const text = $('emailText').value.trim();
    if (!text) {
      showToast(t('pasteEmailFirst'), 'error');
      return;
    }
    
    if (text.length < 50) {
      showToast(t('contentTooShort'), 'error');
      return;
    }
    
    $('analyzing').classList.add('show');
    $('btnAnalyze').disabled = true;
    
    try {
      // Appel Ã  l'API de parsing IA
      const user = firebase.auth().currentUser;
      if (!user) {
        showToast(t('loginRequired'), 'error');
        $('analyzing').classList.remove('show');
        $('btnAnalyze').disabled = false;
        return;
      }
      
      const token = await user.getIdToken();
      
      // En local, pas d'accÃ¨s Ã  l'API (CORS) â†’ utiliser le parsing local
      const host = location.hostname;
      const isLocal = /localhost|127\.0\.0\.1|0\.0\.0\.0/.test(host);
      
      if (isLocal) {
        console.log('[PARSE-BOOKING] Mode local â†’ parsing regex');
        $('analyzing').classList.remove('show');
        $('btnAnalyze').disabled = false;
        showToast('Mode local : analyse simplifiÃ©e (sans IA)', 'error');
        const extracted = extractFromText(text);
        if (extracted.name || extracted.date_start || extracted.reference) {
          showFormWithData(extracted);
        } else {
          showManualForm();
        }
        return;
      }
      
      const response = await fetch('/.netlify/functions/parse-booking', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ content: text })
      });
      
      const result = await response.json();
      
      $('analyzing').classList.remove('show');
      $('btnAnalyze').disabled = false;
      
      if (!response.ok || !result.success) {
        // Afficher le quota si dÃ©passÃ©
        if (response.status === 429) {
          showToast(t('quotaExceeded').replace('{n}', result.usage?.limit || 20), 'error');
        } else if (response.status >= 500) {
          // Erreur serveur / IA indisponible
          showToast(t('aiUnavailable'), 'error');
        } else {
          showToast(result.error || t('analysisError'), 'error');
        }
        // Fallback sur parsing regex
        const extracted = extractFromText(text);
        if (extracted.name || extracted.date_start || extracted.reference) {
          showFormWithData(extracted);
        } else {
          showManualForm();
        }
        return;
      }
      
      // SuccÃ¨s ! Afficher les donnÃ©es parsÃ©es par l'IA
      console.log('[PARSE-BOOKING] SuccÃ¨s:', result._meta?.model, result.data);
      
      // Afficher le quota restant
      if (result.usage) {
        showToast(t('analysisSuccess').replace('{n}', result.usage.remaining), 'success');
      }
      
      // Convertir le format API vers le format du formulaire
      const data = {
        category: result.data.category || 'other',
        name: result.data.name || '',
        date_start: result.data.date_start || '',
        date_end: result.data.date_end || '',
        reference: result.data.confirmation_number || '',
        price: result.data.price?.amount || null,
        address: [result.data.address, result.data.city, result.data.country].filter(Boolean).join(', '),
        notes: result.data.notes || '',
        // Garder les infos supplÃ©mentaires
        provider: result.data.provider,
        time_start: result.data.time_start,
        time_end: result.data.time_end,
        guests: result.data.guests,
        // Infos spÃ©cifiques
        flights: result.data.flights || null,
        car_rental: result.data.car_rental || null
      };
      
      showFormWithData(data, result.preview);
      
    } catch (e) {
      console.error('[PARSE-BOOKING] Erreur:', e);
      $('analyzing').classList.remove('show');
      $('btnAnalyze').disabled = false;
      
      // Fallback sur parsing regex local
      showToast(t('aiUnavailable'), 'error');
      const extracted = extractFromText(text);
      if (extracted.name || extracted.date_start || extracted.reference) {
        showFormWithData(extracted);
      } else {
        showManualForm();
      }
    }
  }
  
  // Parsing regex local (fallback)
  function extractFromText(text) {
    const result = {};
    
    // Extract dates (various formats)
    const dateRegex = /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/g;
    const dates = [...text.matchAll(dateRegex)].map(m => {
      const d = parseInt(m[1]), mo = parseInt(m[2]), y = parseInt(m[3]);
      const year = y < 100 ? 2000 + y : y;
      return `${year}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    });
    if (dates.length > 0) result.date_start = dates[0];
    if (dates.length > 1) result.date_end = dates[1];
    
    // Extract price
    const priceMatch = text.match(/(\d+[.,]?\d*)\s*[â‚¬$EUR]/i) || text.match(/[â‚¬$]\s*(\d+[.,]?\d*)/);
    if (priceMatch) result.price = parseFloat(priceMatch[1].replace(',', '.'));
    
    // Extract reference number
    const refMatch = text.match(/(?:rÃ©f|ref|confirmation|booking|rÃ©servation)[.:\s#]*([A-Z0-9]{6,})/i);
    if (refMatch) result.reference = refMatch[1];
    
    // Try to extract hotel/place name
    const hotelMatch = text.match(/(?:hÃ´tel|hotel|hÃ©bergement|accommodation)[:\s]*([^\n,]{5,50})/i);
    if (hotelMatch) result.name = hotelMatch[1].trim();
    
    // Detect category
    if (/vol|flight|avion|plane/i.test(text)) result.category = 'flight';
    else if (/voiture|car|rental|location/i.test(text)) result.category = 'car_rental';
    else if (/assurance|insurance/i.test(text)) result.category = 'insurance';
    else if (/hÃ´tel|hotel|hÃ©bergement|accommodation|booking\.com|airbnb/i.test(text)) result.category = 'hotel';
    else if (/activitÃ©|activity|visite|visit|tour|excursion/i.test(text)) result.category = 'activity';
    
    return result;
  }
  
  function showFormWithData(data, preview = null) {
    // Ouvrir la modale de parsing au lieu du formulaire en bas
    openParseModal(data, preview);
  }
  
  function showManualForm() {
    $('cardForm').style.display = 'block';
    $('resultPreview').classList.remove('show');
    $('fieldName').focus();
  }
  
  function resetForm() {
    $('cardForm').style.display = 'none';
    $('resultPreview').classList.remove('show');
    $('emailText').value = '';
    $('fieldName').value = '';
    $('fieldDateStart').value = '';
    $('fieldDateEnd').value = '';
    $('fieldRef').value = '';
    $('fieldPrice').value = '';
    $('fieldAddress').value = '';
    $('fieldNotes').value = '';
    selectedCategory = 'hotel';
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.cat === 'hotel'));
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SAVE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function saveBooking() {
    // Validation
    const selectedStep = parseInt($('stepSelector').value);
    if (bookingType === 'step' && (isNaN(selectedStep) || selectedStep < 0)) {
      showToast(t('selectStepFirst'), 'error');
      return;
    }
    
    const name = $('fieldName').value.trim();
    if (!name) {
      showToast(t('enterName'), 'error');
      $('fieldName').focus();
      return;
    }
    
    const totalPrice = $('fieldPrice').value ? parseFloat($('fieldPrice').value) : null;
    
    const booking = {
      id: `booking_${Date.now()}`,
      category: selectedCategory,
      name: name,
      date_start: $('fieldDateStart').value || null,
      date_end: $('fieldDateEnd').value || null,
      reference: $('fieldRef').value.trim() || null,
      price: totalPrice,
      address: $('fieldAddress').value.trim() || null,
      notes: $('fieldNotes').value.trim() || null,
      addedAt: Date.now(),
      updatedAt: Date.now(),
      bookingType: bookingType
    };
    
    let success = false;
    
    if (window.ORT_TRIP_DATA) {
      if (bookingType === 'travel') {
        success = ORT_TRIP_DATA.addTravelBooking(booking);
      } else {
        success = ORT_TRIP_DATA.addStepBooking(selectedStep, booking);
      }
      
      if (success) {
        await ORT_TRIP_DATA.forceSave();
      }
    }
    
    if (success) {
      showToast(t('saved'));
      renderExistingBookings();
      resetForm();
    } else {
      showToast(t('errorSaving'), 'error');
    }
  }
  
  function goBack(skipConfirm = false) {
    if (window.ORT_TRIPID) {
      ORT_TRIPID.navigateTo('roadtrip_detail.html', { cc, itin });
    } else {
      location.href = `roadtrip_detail.html?tripId=${tripId}&cc=${cc}&itin=${itin}`;
    }
  }
  
  async function resetAllBookings() {
    if (!confirm(t('confirmResetAll'))) return;
    
    if (!window.ORT_TRIP_DATA) {
      showToast(t('errorSaving'), 'error');
      return;
    }
    
    try {
      // Supprimer toutes les rÃ©servations voyage
      const travelBookings = ORT_TRIP_DATA.getTravelBookings() || [];
      for (const b of [...travelBookings]) {
        ORT_TRIP_DATA.removeTravelBooking(b.id);
      }
      
      // Supprimer toutes les rÃ©servations par Ã©tape
      if (trip?.steps) {
        trip.steps.forEach((step, idx) => {
          const stepBookings = ORT_TRIP_DATA.getStepBookings(idx) || [];
          for (const b of [...stepBookings]) {
            ORT_TRIP_DATA.removeStepBooking(idx, b.id);
          }
        });
      }
      
      // Sauvegarder
      await ORT_TRIP_DATA.forceSave();
      
      // RafraÃ®chir l'affichage
      renderExistingBookings();
      resetForm();
      
      showToast(t('allBookingsDeleted'));
    } catch (e) {
      console.error('[RESET ALL]', e);
      showToast(t('errorSaving'), 'error');
    }
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UTILS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function showToast(msg, type = 'success') {
    toast.textContent = msg;
    toast.className = 'toast show' + (type === 'error' ? ' error' : '');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }
  
  // Start
  init();
})();
</script>

<footer id="footer-legal"></footer>
<script src="/js/ort-footer.js"></script>

</body>
</html>
