<!DOCTYPE html>
<html lang="fr">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JK3QGQGDDL"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-JK3QGQGDDL');gtag('config','GT-WF83FMCX');</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OneRoadTrip - Importer une rÃ©servation</title>
<style>
:root{--bg:#113f7a;--card:#fff;--ink:#113f7a;--bd:#c3d6b6;--mut:#6b7a99;--ok:#22c55e;--warn:#f59e0b}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(rgba(17,63,122,0.85),rgba(17,63,122,0.85)),url("/assets/image_index.webp") center/cover fixed;background-color:#113f7a;color:#fff;font-family:system-ui,sans-serif;min-height:100vh}
header{background:rgba(17,63,122,0.95);border-bottom:2px solid rgba(255,255,255,0.2);padding:12px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100}
.brandlink{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
.brandlink img{width:36px;height:36px}
.brand{font-weight:800;font-size:1.1rem}
header .sp{flex:1}
.hdr-btn{padding:8px 14px;border-radius:8px;border:1px solid #fff;background:transparent;color:#fff;cursor:pointer;font-weight:600;transition:all .2s}
.hdr-btn:hover{background:rgba(255,255,255,0.15)}
.wrap{max-width:700px;margin:0 auto;padding:20px 16px}
h1{margin:0 0 8px;font-size:1.5rem;text-align:center}
.subtitle{text-align:center;opacity:0.8;margin-bottom:24px}

/* Card */
.card{background:var(--card);color:var(--ink);border-radius:16px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.2);margin-bottom:16px}
.card-title{font-size:1.1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* Type selector */
.type-selector{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.type-btn{padding:16px;border:2px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer;text-align:center;transition:all .2s}
.type-btn:hover{border-color:var(--bg);background:#eff6ff}
.type-btn.active{border-color:var(--bg);background:#dbeafe}
.type-btn .icon{font-size:2rem;margin-bottom:8px}
.type-btn .label{font-weight:600;font-size:0.95rem}
.type-btn .hint{font-size:0.75rem;color:var(--mut);margin-top:4px}

/* Step selector */
.step-selector{margin-bottom:20px}
.step-selector label{display:block;font-weight:600;margin-bottom:8px}
.step-selector select{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;background:#fff;cursor:pointer}
.step-selector select:focus{outline:none;border-color:var(--bg)}

/* Textarea */
.email-input{margin-bottom:20px}
.email-input label{display:block;font-weight:600;margin-bottom:8px}
.email-input textarea{width:100%;height:150px;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:0.9rem;font-family:inherit;resize:vertical}
.email-input textarea:focus{outline:none;border-color:var(--bg)}
.email-input .hint{font-size:0.8rem;color:var(--mut);margin-top:6px}

/* Buttons */
.btn-row{display:flex;gap:12px;flex-wrap:wrap}
.btn{padding:12px 24px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:1rem;transition:all .2s;display:flex;align-items:center;gap:8px}
.btn-primary{background:var(--bg);color:#fff}
.btn-primary:hover{background:#0d3166}
.btn-secondary{background:#e5e7eb;color:var(--ink)}
.btn-secondary:hover{background:#d1d5db}
.btn-success{background:var(--ok);color:#fff}
.btn-success:hover{background:#16a34a}
.btn:disabled{opacity:0.5;cursor:not-allowed}

/* Manual form */
.manual-form{display:none}
.manual-form.show{display:block}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-weight:600;margin-bottom:6px;font-size:0.9rem}
.form-group input, .form-group select{width:100%;padding:10px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:0.95rem}
.form-group input:focus, .form-group select:focus{outline:none;border-color:var(--bg)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Result preview */
.result-preview{display:none;background:#f0fdf4;border:2px solid #86efac;border-radius:12px;padding:16px;margin-bottom:16px}
.result-preview.show{display:block}
.result-preview.error{background:#fef2f2;border-color:#fca5a5}
.result-title{font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.result-field{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb}
.result-field:last-child{border-bottom:none}
.result-field .label{color:var(--mut);font-size:0.85rem}
.result-field .value{font-weight:600}

/* Category icons */
.category-selector{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.cat-btn{padding:12px 8px;border:2px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;text-align:center;transition:all .2s}
.cat-btn:hover{border-color:var(--bg)}
.cat-btn.active{border-color:var(--bg);background:#dbeafe}
.cat-btn .icon{font-size:1.5rem}
.cat-btn .label{font-size:0.7rem;margin-top:4px;display:block}

/* Footer actions */
.footer-actions{position:sticky;bottom:0;background:rgba(17,63,122,0.95);backdrop-filter:blur(8px);padding:16px;margin:20px -16px -20px;display:flex;gap:12px;justify-content:center;border-top:2px solid rgba(255,255,255,0.2)}
.btn-back{padding:14px 24px;background:transparent;color:#fff;border:2px solid #fff;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer}
.btn-back:hover{background:rgba(255,255,255,0.1)}

/* Toast */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#22c55e;color:#fff;padding:12px 24px;border-radius:8px;font-weight:600;z-index:2000;display:none}
.toast.show{display:block}
.toast.error{background:#dc2626}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:rgba(17,63,122,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000}
.loading-spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;font-size:1.1rem}

/* Analyzing */
.analyzing{display:none;text-align:center;padding:20px}
.analyzing.show{display:block}
.analyzing .spinner{width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:var(--bg);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}

@media(max-width:500px){
  .form-row{grid-template-columns:1fr}
  .category-selector{grid-template-columns:repeat(3,1fr)}
}
</style>
</head>
<body>

<header>
  <a href="index.html" class="brandlink">
    <img src="/assets/symbol.webp" alt="Logo">
    <span class="brand">OneRoadTrip</span>
  </a>
  <span class="sp"></span>
  <button class="hdr-btn" id="btnBackToTrip">â† <span data-i18n="backToTrip">Retour</span></button>
</header>

<div class="wrap">
  <h1 data-i18n="importBookingTitle">â• Importer une rÃ©servation</h1>
  <p class="subtitle" id="tripName"></p>
  
  <!-- Step 1: Type selection -->
  <div class="card" id="cardType">
    <div class="card-title">1ï¸âƒ£ <span data-i18n="selectType">Type de rÃ©servation</span></div>
    <div class="type-selector">
      <div class="type-btn active" data-type="step">
        <div class="icon">ğŸ“</div>
        <div class="label" data-i18n="typeStep">Ã‰tape</div>
        <div class="hint" data-i18n="typeStepHint">HÃ´tel, activitÃ©, visite</div>
      </div>
      <div class="type-btn" data-type="travel">
        <div class="icon">ğŸŒ</div>
        <div class="label" data-i18n="typeTravel">Voyage</div>
        <div class="hint" data-i18n="typeTravelHint">Vol, voiture, assurance</div>
      </div>
    </div>
    
    <!-- Step selector (only for step type) -->
    <div class="step-selector" id="stepSelectorWrap">
      <label data-i18n="selectStep">SÃ©lectionner l'Ã©tape</label>
      <select id="stepSelector">
        <option value="">-- Choisir --</option>
      </select>
    </div>
  </div>
  
  <!-- Step 2: Import method -->
  <div class="card" id="cardImport">
    <div class="card-title">2ï¸âƒ£ <span data-i18n="importMethod">MÃ©thode d'import</span></div>
    
    <!-- Email paste -->
    <div class="email-input" id="emailInputWrap">
      <label data-i18n="pasteEmail">Collez l'email de confirmation</label>
      <textarea id="emailText" placeholder="Copiez-collez ici le contenu de votre email de confirmation de rÃ©servation..."></textarea>
      <div class="hint" data-i18n="emailHint">Nous analyserons automatiquement les informations</div>
    </div>
    
    <div class="btn-row">
      <button class="btn btn-primary" id="btnAnalyze">
        âœ¨ <span data-i18n="analyze">Analyser</span>
      </button>
      <button class="btn btn-secondary" id="btnManual">
        âœï¸ <span data-i18n="manualEntry">Saisie manuelle</span>
      </button>
    </div>
    
    <!-- Analyzing spinner -->
    <div class="analyzing" id="analyzing">
      <div class="spinner"></div>
      <div data-i18n="analyzing">Analyse en cours...</div>
    </div>
  </div>
  
  <!-- Step 3: Manual form / Result -->
  <div class="card" id="cardForm" style="display:none">
    <div class="card-title">3ï¸âƒ£ <span data-i18n="bookingDetails">DÃ©tails de la rÃ©servation</span></div>
    
    <!-- Result preview -->
    <div class="result-preview" id="resultPreview">
      <div class="result-title">âœ… <span data-i18n="extractedInfo">Informations extraites</span></div>
      <div id="resultFields"></div>
    </div>
    
    <!-- Category selector -->
    <div class="form-group">
      <label data-i18n="category">CatÃ©gorie</label>
      <div class="category-selector" id="categorySelector">
        <div class="cat-btn" data-cat="hotel"><div class="icon">ğŸ¨</div><div class="label" data-i18n="catHotel">HÃ´tel</div></div>
        <div class="cat-btn" data-cat="activity"><div class="icon">ğŸ¯</div><div class="label" data-i18n="catActivity">ActivitÃ©</div></div>
        <div class="cat-btn" data-cat="flight"><div class="icon">âœˆï¸</div><div class="label" data-i18n="catFlight">Vol</div></div>
        <div class="cat-btn" data-cat="car_rental"><div class="icon">ğŸš—</div><div class="label" data-i18n="catCar">Voiture</div></div>
        <div class="cat-btn" data-cat="insurance"><div class="icon">ğŸ›¡ï¸</div><div class="label" data-i18n="catInsurance">Assurance</div></div>
        <div class="cat-btn" data-cat="visit"><div class="icon">ğŸ›ï¸</div><div class="label" data-i18n="catVisit">Visite</div></div>
        <div class="cat-btn" data-cat="show"><div class="icon">ğŸ­</div><div class="label" data-i18n="catShow">Spectacle</div></div>
        <div class="cat-btn" data-cat="other"><div class="icon">ğŸ“‹</div><div class="label" data-i18n="catOther">Autre</div></div>
      </div>
    </div>
    
    <!-- Form fields -->
    <div class="form-group">
      <label data-i18n="bookingName">Nom de la rÃ©servation</label>
      <input type="text" id="fieldName" placeholder="Ex: HÃ´tel Marriott Paris">
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label data-i18n="dateStart">Date dÃ©but</label>
        <input type="date" id="fieldDateStart">
      </div>
      <div class="form-group">
        <label data-i18n="dateEnd">Date fin</label>
        <input type="date" id="fieldDateEnd">
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label data-i18n="reference">RÃ©fÃ©rence</label>
        <input type="text" id="fieldRef" placeholder="NÂ° de confirmation">
      </div>
      <div class="form-group">
        <label data-i18n="price">Prix (â‚¬)</label>
        <input type="number" id="fieldPrice" placeholder="0.00" step="0.01">
      </div>
    </div>
    
    <div class="form-group">
      <label data-i18n="address">Adresse / Lieu</label>
      <input type="text" id="fieldAddress" placeholder="Adresse ou lieu">
    </div>
    
    <div class="form-group">
      <label data-i18n="notes">Notes</label>
      <input type="text" id="fieldNotes" placeholder="Informations supplÃ©mentaires">
    </div>
    
    <div class="btn-row" style="margin-top:20px">
      <button class="btn btn-success" id="btnSaveBooking">
        âœ… <span data-i18n="saveBooking">Enregistrer la rÃ©servation</span>
      </button>
      <button class="btn btn-secondary" id="btnReset">
        ğŸ”„ <span data-i18n="reset">Recommencer</span>
      </button>
    </div>
  </div>
  
  <!-- Footer -->
  <div class="footer-actions">
    <button class="btn-back" id="btnCancel">âŒ <span data-i18n="cancelAndReturn">Annuler</span></button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" data-i18n="loading">Chargement...</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="/js/ort-config.js"></script>
<script src="/js/ort-i18n.js"></script>
<script src="/js/ort-tripid.js"></script>
<script src="/js/ort-trip-data.js"></script>

<script>
// Init Firebase
(function(){
  const host = location.hostname;
  const isPreprod = /oneroadtrip-preprod|localhost|127\.0\.0\.1|0\.0\.0\.0/.test(host);
  const cfg = isPreprod ? (window.ORT_CONFIG?.PREPROD || {}) : (window.ORT_CONFIG?.PROD || {});
  const safe = (cfg && cfg.apiKey) ? cfg : (window.ORT_CONFIG?.PREPROD || {});
  if (safe && safe.apiKey && !firebase.apps.length) {
    firebase.initializeApp(safe);
    console.log('[RT-BOOKING-IMPORT] Firebase initialisÃ©');
  }
})();
</script>

<script>
(async function() {
  'use strict';
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // I18N
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const I18N_LOCAL = {
    importBookingTitle: { fr: 'â• Importer une rÃ©servation', en: 'â• Import a booking', es: 'â• Importar una reserva', it: 'â• Importa una prenotazione', pt: 'â• Importar uma reserva', ar: 'â• Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø­Ø¬Ø²' },
    selectType: { fr: 'Type de rÃ©servation', en: 'Booking type', es: 'Tipo de reserva', it: 'Tipo di prenotazione', pt: 'Tipo de reserva', ar: 'Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¬Ø²' },
    typeStep: { fr: 'Ã‰tape', en: 'Step', es: 'Etapa', it: 'Tappa', pt: 'Etapa', ar: 'Ù…Ø±Ø­Ù„Ø©' },
    typeStepHint: { fr: 'HÃ´tel, activitÃ©, visite', en: 'Hotel, activity, visit', es: 'Hotel, actividad, visita', it: 'Hotel, attivitÃ , visita', pt: 'Hotel, atividade, visita', ar: 'ÙÙ†Ø¯Ù‚ØŒ Ù†Ø´Ø§Ø·ØŒ Ø²ÙŠØ§Ø±Ø©' },
    typeTravel: { fr: 'Voyage', en: 'Travel', es: 'Viaje', it: 'Viaggio', pt: 'Viagem', ar: 'Ø³ÙØ±' },
    typeTravelHint: { fr: 'Vol, voiture, assurance', en: 'Flight, car, insurance', es: 'Vuelo, coche, seguro', it: 'Volo, auto, assicurazione', pt: 'Voo, carro, seguro', ar: 'Ø·ÙŠØ±Ø§Ù†ØŒ Ø³ÙŠØ§Ø±Ø©ØŒ ØªØ£Ù…ÙŠÙ†' },
    selectStep: { fr: 'SÃ©lectionner l\'Ã©tape', en: 'Select step', es: 'Seleccionar etapa', it: 'Seleziona tappa', pt: 'Selecionar etapa', ar: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©' },
    importMethod: { fr: 'MÃ©thode d\'import', en: 'Import method', es: 'MÃ©todo de importaciÃ³n', it: 'Metodo di importazione', pt: 'MÃ©todo de importaÃ§Ã£o', ar: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯' },
    pasteEmail: { fr: 'Collez l\'email de confirmation', en: 'Paste the confirmation email', es: 'Pegue el email de confirmaciÃ³n', it: 'Incolla l\'email di conferma', pt: 'Cole o email de confirmaÃ§Ã£o', ar: 'Ø§Ù„ØµÙ‚ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯' },
    emailHint: { fr: 'Nous analyserons automatiquement les informations', en: 'We will automatically analyze the information', es: 'Analizaremos automÃ¡ticamente la informaciÃ³n', it: 'Analizzeremo automaticamente le informazioni', pt: 'Analisaremos automaticamente as informaÃ§Ãµes', ar: 'Ø³Ù†Ø­Ù„Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹' },
    analyze: { fr: 'Analyser', en: 'Analyze', es: 'Analizar', it: 'Analizza', pt: 'Analisar', ar: 'ØªØ­Ù„ÙŠÙ„' },
    manualEntry: { fr: 'Saisie manuelle', en: 'Manual entry', es: 'Entrada manual', it: 'Inserimento manuale', pt: 'Entrada manual', ar: 'Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ' },
    analyzing: { fr: 'Analyse en cours...', en: 'Analyzing...', es: 'Analizando...', it: 'Analisi in corso...', pt: 'Analisando...', ar: 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„...' },
    bookingDetails: { fr: 'DÃ©tails de la rÃ©servation', en: 'Booking details', es: 'Detalles de la reserva', it: 'Dettagli prenotazione', pt: 'Detalhes da reserva', ar: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²' },
    extractedInfo: { fr: 'Informations extraites', en: 'Extracted information', es: 'InformaciÃ³n extraÃ­da', it: 'Informazioni estratte', pt: 'InformaÃ§Ãµes extraÃ­das', ar: 'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©' },
    category: { fr: 'CatÃ©gorie', en: 'Category', es: 'CategorÃ­a', it: 'Categoria', pt: 'Categoria', ar: 'Ø§Ù„ÙØ¦Ø©' },
    catHotel: { fr: 'HÃ´tel', en: 'Hotel', es: 'Hotel', it: 'Hotel', pt: 'Hotel', ar: 'ÙÙ†Ø¯Ù‚' },
    catActivity: { fr: 'ActivitÃ©', en: 'Activity', es: 'Actividad', it: 'AttivitÃ ', pt: 'Atividade', ar: 'Ù†Ø´Ø§Ø·' },
    catFlight: { fr: 'Vol', en: 'Flight', es: 'Vuelo', it: 'Volo', pt: 'Voo', ar: 'Ø·ÙŠØ±Ø§Ù†' },
    catCar: { fr: 'Voiture', en: 'Car', es: 'Coche', it: 'Auto', pt: 'Carro', ar: 'Ø³ÙŠØ§Ø±Ø©' },
    catInsurance: { fr: 'Assurance', en: 'Insurance', es: 'Seguro', it: 'Assicurazione', pt: 'Seguro', ar: 'ØªØ£Ù…ÙŠÙ†' },
    catVisit: { fr: 'Visite', en: 'Visit', es: 'Visita', it: 'Visita', pt: 'Visita', ar: 'Ø²ÙŠØ§Ø±Ø©' },
    catShow: { fr: 'Spectacle', en: 'Show', es: 'EspectÃ¡culo', it: 'Spettacolo', pt: 'EspetÃ¡culo', ar: 'Ø¹Ø±Ø¶' },
    catOther: { fr: 'Autre', en: 'Other', es: 'Otro', it: 'Altro', pt: 'Outro', ar: 'Ø¢Ø®Ø±' },
    bookingName: { fr: 'Nom de la rÃ©servation', en: 'Booking name', es: 'Nombre de la reserva', it: 'Nome prenotazione', pt: 'Nome da reserva', ar: 'Ø§Ø³Ù… Ø§Ù„Ø­Ø¬Ø²' },
    dateStart: { fr: 'Date dÃ©but', en: 'Start date', es: 'Fecha inicio', it: 'Data inizio', pt: 'Data inÃ­cio', ar: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡' },
    dateEnd: { fr: 'Date fin', en: 'End date', es: 'Fecha fin', it: 'Data fine', pt: 'Data fim', ar: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' },
    reference: { fr: 'RÃ©fÃ©rence', en: 'Reference', es: 'Referencia', it: 'Riferimento', pt: 'ReferÃªncia', ar: 'Ø§Ù„Ù…Ø±Ø¬Ø¹' },
    price: { fr: 'Prix (â‚¬)', en: 'Price (â‚¬)', es: 'Precio (â‚¬)', it: 'Prezzo (â‚¬)', pt: 'PreÃ§o (â‚¬)', ar: 'Ø§Ù„Ø³Ø¹Ø± (â‚¬)' },
    address: { fr: 'Adresse / Lieu', en: 'Address / Location', es: 'DirecciÃ³n / Lugar', it: 'Indirizzo / Luogo', pt: 'EndereÃ§o / Local', ar: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ù…ÙˆÙ‚Ø¹' },
    notes: { fr: 'Notes', en: 'Notes', es: 'Notas', it: 'Note', pt: 'Notas', ar: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª' },
    saveBooking: { fr: 'Enregistrer la rÃ©servation', en: 'Save booking', es: 'Guardar reserva', it: 'Salva prenotazione', pt: 'Salvar reserva', ar: 'Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø²' },
    reset: { fr: 'Recommencer', en: 'Reset', es: 'Reiniciar', it: 'Ricomincia', pt: 'RecomeÃ§ar', ar: 'Ø¥Ø¹Ø§Ø¯Ø©' },
    backToTrip: { fr: 'Retour', en: 'Back', es: 'Volver', it: 'Indietro', pt: 'Voltar', ar: 'Ø±Ø¬ÙˆØ¹' },
    cancelAndReturn: { fr: 'Annuler', en: 'Cancel', es: 'Cancelar', it: 'Annulla', pt: 'Cancelar', ar: 'Ø¥Ù„ØºØ§Ø¡' },
    loading: { fr: 'Chargement...', en: 'Loading...', es: 'Cargando...', it: 'Caricamento...', pt: 'Carregando...', ar: 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...' },
    saved: { fr: 'RÃ©servation enregistrÃ©e !', en: 'Booking saved!', es: 'Â¡Reserva guardada!', it: 'Prenotazione salvata!', pt: 'Reserva salva!', ar: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø²!' },
    errorSaving: { fr: 'Erreur lors de l\'enregistrement', en: 'Error saving', es: 'Error al guardar', it: 'Errore durante il salvataggio', pt: 'Erro ao salvar', ar: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸' },
    noTrip: { fr: 'Voyage non trouvÃ©', en: 'Trip not found', es: 'Viaje no encontrado', it: 'Viaggio non trovato', pt: 'Viagem nÃ£o encontrada', ar: 'Ø§Ù„Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' },
    selectStepFirst: { fr: 'SÃ©lectionnez une Ã©tape', en: 'Select a step first', es: 'Seleccione una etapa', it: 'Seleziona una tappa', pt: 'Selecione uma etapa', ar: 'Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹' },
    enterName: { fr: 'Entrez un nom', en: 'Enter a name', es: 'Ingrese un nombre', it: 'Inserisci un nome', pt: 'Digite um nome', ar: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ø§Ù‹' },
    pasteEmailFirst: { fr: 'Collez d\'abord un email', en: 'Paste an email first', es: 'Pegue un email primero', it: 'Incolla prima un\'email', pt: 'Cole um email primeiro', ar: 'Ø§Ù„ØµÙ‚ Ø¨Ø±ÙŠØ¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹' },
    analysisError: { fr: 'Erreur d\'analyse. Essayez la saisie manuelle.', en: 'Analysis error. Try manual entry.', es: 'Error de anÃ¡lisis. Pruebe la entrada manual.', it: 'Errore di analisi. Prova l\'inserimento manuale.', pt: 'Erro de anÃ¡lise. Tente entrada manual.', ar: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ø¬Ø±Ø¨ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ.' }
  };
  
  let lang = localStorage.getItem('ORT_LANG') || localStorage.getItem('lang')?.slice(0,2) || navigator.language?.slice(0,2) || 'fr';
  if (!['fr','en','es','it','pt','ar'].includes(lang)) lang = 'en';
  
  function t(key) {
    return window.ORT_I18N?.[key]?.[lang] || I18N_LOCAL[key]?.[lang] || I18N_LOCAL[key]?.fr || key;
  }
  
  function applyI18N() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const text = t(key);
      if (text && text !== key) el.textContent = text;
    });
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const params = new URLSearchParams(location.search);
  let tripId = params.get('tripId') || params.get('id');
  const cc = params.get('cc') || '';
  const itin = params.get('itin') || '';
  
  let trip = null;
  let bookingType = 'step'; // 'step' or 'travel'
  let selectedStep = -1;
  let selectedCategory = 'hotel';
  
  const $ = id => document.getElementById(id);
  const loadingOverlay = $('loadingOverlay');
  const toast = $('toast');
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function init() {
    console.log('[RT-BOOKING-IMPORT] Init...', { tripId, cc, itin });
    applyI18N();
    
    if (window.ORT_TRIPID) {
      tripId = ORT_TRIPID.init();
    }
    
    if (!tripId) {
      showToast(t('noTrip'), 'error');
      loadingOverlay.style.display = 'none';
      return;
    }
    
    const user = await waitForAuth();
    if (!user) {
      showBlockingMessage('login');
      return;
    }
    
    const tripSaved = await checkTripSaved(user.uid, tripId);
    if (!tripSaved) {
      showBlockingMessage('tripNotSaved');
      return;
    }
    
    await loadTrip();
    if (!trip) {
      showToast(t('noTrip'), 'error');
      loadingOverlay.style.display = 'none';
      return;
    }
    
    if (window.ORT_TRIP_DATA) {
      await ORT_TRIP_DATA.loadTrip(tripId);
    }
    
    populateStepSelector();
    setupEventListeners();
    
    loadingOverlay.style.display = 'none';
  }
  
  async function waitForAuth() {
    return new Promise(resolve => {
      const check = () => {
        if (window.firebase?.auth) {
          firebase.auth().onAuthStateChanged(user => resolve(user));
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    });
  }
  
  async function checkTripSaved(uid, tripId) {
    if (!uid || !tripId) return false;
    try {
      const db = firebase.firestore();
      const doc = await db.collection('users').doc(uid).collection('trips').doc(tripId).get();
      return doc.exists;
    } catch (e) {
      return false;
    }
  }
  
  function showBlockingMessage(type) {
    loadingOverlay.style.display = 'none';
    const messages = {
      login: { title: t('loginRequired') || 'Connexion requise', msg: t('loginRequiredMsg') || 'Vous devez Ãªtre connectÃ©.', btn: t('goBack') || 'Retour' },
      tripNotSaved: { title: t('tripSaveRequired') || 'Voyage non sauvegardÃ©', msg: t('tripSaveRequiredMsg') || 'Sauvegardez d\'abord le voyage.', btn: t('goBack') || 'Retour' }
    };
    const m = messages[type] || messages.login;
    
    const container = document.createElement('div');
    container.style.cssText = 'position:fixed;inset:0;background:linear-gradient(135deg,#1e3a5f,#2d5a87);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
    container.innerHTML = `
      <div style="background:#fff;border-radius:16px;padding:32px;max-width:400px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="font-size:48px;margin-bottom:16px;">ğŸ”’</div>
        <h2 style="color:#1e3a5f;margin:0 0 12px;">${m.title}</h2>
        <p style="color:#64748b;margin:0 0 24px;">${m.msg}</p>
        <button onclick="history.back()" style="background:#3b82f6;color:#fff;border:none;padding:12px 32px;border-radius:8px;font-weight:600;cursor:pointer;">${m.btn}</button>
      </div>
    `;
    document.body.appendChild(container);
  }
  
  async function loadTrip() {
    const stored = localStorage.getItem(`ort_trip_${tripId}`);
    if (stored) {
      try {
        trip = JSON.parse(stored);
        $('tripName').textContent = trip.title || '';
        return;
      } catch (e) {}
    }
    
    const user = firebase.auth().currentUser;
    if (user) {
      try {
        const doc = await firebase.firestore().collection('users').doc(user.uid).collection('trips').doc(tripId).get();
        if (doc.exists) {
          trip = doc.data();
          $('tripName').textContent = trip.title || '';
        }
      } catch (e) {}
    }
  }
  
  function populateStepSelector() {
    const select = $('stepSelector');
    select.innerHTML = '<option value="">-- ' + t('selectStep') + ' --</option>';
    
    if (trip?.steps) {
      trip.steps.forEach((step, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${i + 1}. ${step.name || step.location || 'Ã‰tape ' + (i + 1)}`;
        select.appendChild(opt);
      });
    }
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EVENT LISTENERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function setupEventListeners() {
    // Type selector
    document.querySelectorAll('.type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bookingType = btn.dataset.type;
        $('stepSelectorWrap').style.display = bookingType === 'step' ? 'block' : 'none';
      });
    });
    
    // Step selector
    $('stepSelector').addEventListener('change', e => {
      selectedStep = e.target.value !== '' ? parseInt(e.target.value) : -1;
    });
    
    // Category selector
    document.querySelectorAll('.cat-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedCategory = btn.dataset.cat;
      });
    });
    
    // Analyze button
    $('btnAnalyze').addEventListener('click', analyzeEmail);
    
    // Manual button
    $('btnManual').addEventListener('click', showManualForm);
    
    // Save button
    $('btnSaveBooking').addEventListener('click', saveBooking);
    
    // Reset button
    $('btnReset').addEventListener('click', resetForm);
    
    // Back buttons
    $('btnBackToTrip').addEventListener('click', goBack);
    $('btnCancel').addEventListener('click', goBack);
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ANALYZE EMAIL (SIMPLE EXTRACTION)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function analyzeEmail() {
    const text = $('emailText').value.trim();
    if (!text) {
      showToast(t('pasteEmailFirst'), 'error');
      return;
    }
    
    $('analyzing').classList.add('show');
    $('btnAnalyze').disabled = true;
    
    // Simple regex extraction (can be enhanced with AI parser)
    await new Promise(r => setTimeout(r, 1000)); // Simulate analysis
    
    const extracted = extractFromText(text);
    
    $('analyzing').classList.remove('show');
    $('btnAnalyze').disabled = false;
    
    if (extracted.name || extracted.date_start || extracted.reference) {
      showFormWithData(extracted);
    } else {
      showToast(t('analysisError'), 'error');
      showManualForm();
    }
  }
  
  function extractFromText(text) {
    const result = {};
    
    // Extract dates (various formats)
    const dateRegex = /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/g;
    const dates = [...text.matchAll(dateRegex)].map(m => {
      const d = parseInt(m[1]), mo = parseInt(m[2]), y = parseInt(m[3]);
      const year = y < 100 ? 2000 + y : y;
      return `${year}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    });
    if (dates.length > 0) result.date_start = dates[0];
    if (dates.length > 1) result.date_end = dates[1];
    
    // Extract price
    const priceMatch = text.match(/(\d+[.,]?\d*)\s*[â‚¬$EUR]/i) || text.match(/[â‚¬$]\s*(\d+[.,]?\d*)/);
    if (priceMatch) result.price = parseFloat(priceMatch[1].replace(',', '.'));
    
    // Extract reference number
    const refMatch = text.match(/(?:rÃ©f|ref|confirmation|booking|rÃ©servation)[.:\s#]*([A-Z0-9]{6,})/i);
    if (refMatch) result.reference = refMatch[1];
    
    // Try to extract hotel/place name
    const hotelMatch = text.match(/(?:hÃ´tel|hotel|hÃ©bergement|accommodation)[:\s]*([^\n,]{5,50})/i);
    if (hotelMatch) result.name = hotelMatch[1].trim();
    
    // Detect category
    if (/vol|flight|avion|plane/i.test(text)) result.category = 'flight';
    else if (/voiture|car|rental|location/i.test(text)) result.category = 'car_rental';
    else if (/assurance|insurance/i.test(text)) result.category = 'insurance';
    else if (/hÃ´tel|hotel|hÃ©bergement|accommodation|booking\.com|airbnb/i.test(text)) result.category = 'hotel';
    else if (/activitÃ©|activity|visite|visit|tour|excursion/i.test(text)) result.category = 'activity';
    
    return result;
  }
  
  function showFormWithData(data) {
    $('cardForm').style.display = 'block';
    $('resultPreview').classList.add('show');
    
    // Fill result preview
    const fields = $('resultFields');
    fields.innerHTML = '';
    const labels = { name: t('bookingName'), date_start: t('dateStart'), date_end: t('dateEnd'), price: t('price'), reference: t('reference') };
    for (const [key, val] of Object.entries(data)) {
      if (val && labels[key]) {
        fields.innerHTML += `<div class="result-field"><span class="label">${labels[key]}</span><span class="value">${val}</span></div>`;
      }
    }
    
    // Fill form
    if (data.name) $('fieldName').value = data.name;
    if (data.date_start) $('fieldDateStart').value = data.date_start;
    if (data.date_end) $('fieldDateEnd').value = data.date_end;
    if (data.price) $('fieldPrice').value = data.price;
    if (data.reference) $('fieldRef').value = data.reference;
    
    // Select category
    if (data.category) {
      selectedCategory = data.category;
      document.querySelectorAll('.cat-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.cat === data.category);
      });
    }
  }
  
  function showManualForm() {
    $('cardForm').style.display = 'block';
    $('resultPreview').classList.remove('show');
    $('fieldName').focus();
  }
  
  function resetForm() {
    $('cardForm').style.display = 'none';
    $('resultPreview').classList.remove('show');
    $('emailText').value = '';
    $('fieldName').value = '';
    $('fieldDateStart').value = '';
    $('fieldDateEnd').value = '';
    $('fieldRef').value = '';
    $('fieldPrice').value = '';
    $('fieldAddress').value = '';
    $('fieldNotes').value = '';
    selectedCategory = 'hotel';
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.cat === 'hotel'));
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SAVE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function saveBooking() {
    // Validation
    if (bookingType === 'step' && selectedStep < 0) {
      showToast(t('selectStepFirst'), 'error');
      return;
    }
    
    const name = $('fieldName').value.trim();
    if (!name) {
      showToast(t('enterName'), 'error');
      $('fieldName').focus();
      return;
    }
    
    const booking = {
      category: selectedCategory,
      name: name,
      date_start: $('fieldDateStart').value || null,
      date_end: $('fieldDateEnd').value || null,
      reference: $('fieldRef').value.trim() || null,
      price: $('fieldPrice').value ? parseFloat($('fieldPrice').value) : null,
      address: $('fieldAddress').value.trim() || null,
      notes: $('fieldNotes').value.trim() || null,
      addedAt: Date.now()
    };
    
    let success = false;
    
    if (window.ORT_TRIP_DATA) {
      if (bookingType === 'travel') {
        success = ORT_TRIP_DATA.addTravelBooking(booking);
      } else {
        success = ORT_TRIP_DATA.addStepBooking(selectedStep, booking);
      }
      
      if (success) {
        await ORT_TRIP_DATA.forceSave();
      }
    }
    
    if (success) {
      showToast(t('saved'));
      setTimeout(() => {
        // Option: go to bookings view or back to trip
        goBack(true);
      }, 1000);
    } else {
      showToast(t('errorSaving'), 'error');
    }
  }
  
  function goBack(skipConfirm = false) {
    if (window.ORT_TRIPID) {
      ORT_TRIPID.navigateTo('roadtrip_detail.html', { cc, itin });
    } else {
      location.href = `roadtrip_detail.html?tripId=${tripId}&cc=${cc}&itin=${itin}`;
    }
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UTILS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function showToast(msg, type = 'success') {
    toast.textContent = msg;
    toast.className = 'toast show' + (type === 'error' ? ' error' : '');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }
  
  // Start
  init();
})();
</script>

<footer id="footer-legal"></footer>
<script src="/js/ort-footer.js"></script>

</body>
</html>
