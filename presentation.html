<!doctype html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JK3QGQGDDL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  
  // Récupérer la langue de l'utilisateur
  const userLang = localStorage.getItem('lang') || 'fr';
  
  gtag('config', 'G-JK3QGQGDDL', {
    'user_properties': {
      'language': userLang
    }
  });
</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=5.0">
  <title>OneRoadTrip - Plan Your Dream Road Trip | 667+ Itineraries Worldwide</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Plan your perfect road trip with OneRoadTrip. 667+ curated itineraries across 82 countries, 4000+ stages, interactive maps, and booking links. Free to use.">
  <meta name="keywords" content="road trip, travel planner, itinerary, vacation planning, travel routes, road trip map, travel guide">
  <meta name="author" content="OneRoadTrip">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://www.oneroadtrip.com/presentation.html">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.oneroadtrip.com/presentation.html">
  <meta property="og:title" content="OneRoadTrip - Plan Your Dream Road Trip">
  <meta property="og:description" content="667+ curated road trip itineraries across 82 countries. Interactive maps, detailed stages, and booking links. 100% free.">
  <meta property="og:image" content="https://www.oneroadtrip.com/assets/og-image.webp">
  <meta property="og:locale" content="en_US">
  <meta property="og:locale:alternate" content="fr_FR">
  <meta property="og:locale:alternate" content="es_ES">
  <meta property="og:locale:alternate" content="it_IT">
  <meta property="og:locale:alternate" content="pt_PT">
  <meta property="og:locale:alternate" content="ar_SA">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@OneRoadTrip2025">
  <meta name="twitter:title" content="OneRoadTrip - Plan Your Dream Road Trip">
  <meta name="twitter:description" content="667+ curated road trip itineraries across 82 countries. Interactive maps and booking links.">
  <meta name="twitter:image" content="https://www.oneroadtrip.com/assets/og-image.webp">
  
  <!-- Hreflang for multilingual SEO -->
  <link rel="alternate" hreflang="fr" href="https://www.oneroadtrip.com/presentation.html?lang=fr">
  <link rel="alternate" hreflang="en" href="https://www.oneroadtrip.com/presentation.html?lang=en">
  <link rel="alternate" hreflang="es" href="https://www.oneroadtrip.com/presentation.html?lang=es">
  <link rel="alternate" hreflang="it" href="https://www.oneroadtrip.com/presentation.html?lang=it">
  <link rel="alternate" hreflang="pt" href="https://www.oneroadtrip.com/presentation.html?lang=pt">
  <link rel="alternate" hreflang="ar" href="https://www.oneroadtrip.com/presentation.html?lang=ar">
  <link rel="alternate" hreflang="x-default" href="https://www.oneroadtrip.com/presentation.html">
  
  <!-- Preconnect for performance -->
  <link rel="preconnect" href="https://oneroadtrip-prod.firebaseapp.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">
  <!-- Favicon inline pour éviter /favicon.ico 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23113f7a'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-family='Arial' font-size='28' fill='white'%3EOR%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
  <style>
    :root{ --bg:#f6f9fb; --ink:#113f7a; --acc:#113f7a; --card:#ffffff; --bd:#c3d6b6; --mut:#64748b; --warn:#eab308; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:url("/assets/image_index.webp") center/cover fixed #113f7a;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    [dir="rtl"] body{ text-align:right }
    [dir="rtl"] .noticeBar,[dir="rtl"] .cols,[dir="rtl"] .full,[dir="rtl"] .ctaRow,[dir="rtl"] .fullGrid{ direction:rtl }
    [dir="rtl"] .ctaRow{ justify-content:flex-end }

header{position:sticky;top:0;z-index:10000;background:url("/assets/image_index.webp") center/cover no-repeat #113f7a;color:#fff;padding:12px 16px;display:flex;flex-direction:column;gap:12px;border-bottom:2px solid rgba(255,255,255,0.2);box-shadow:0 2px 12px rgba(0,0,0,0.2)}

/* Lignes du header */
.header-row-1{display:flex;align-items:center;gap:12px;width:100%}
.header-row-2{display:flex;align-items:center;gap:12px;width:100%;flex-wrap:wrap}

.brandlink{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
.brandlink img{width:80px;height:80px}



    .brand{font-weight:800;font-size:20px}
    .langpick{appearance:none;background:#fff;border:1px solid #113f7a;border-radius:10px;padding:8px 10px;cursor:pointer;color:#113f7a;font-size:14px}
 .auth{position:relative}
.btn{padding:8px 12px;border-radius:10px;border:1px solid #ffffff80;background:#ffffff1a;color:#fff;cursor:pointer;font-size:14px}
.btn:hover{background:#ffffff2b}
.btn:disabled{opacity:.6;cursor:not-allowed}
/* Bouton header générique pour le lien Dashboard */
.hdr-btn{display:inline-block;padding:8px 12px;border-radius:10px;
  border:1px solid #113f7a;background:#fff;color:#113f7a;text-decoration:none;cursor:pointer;font-weight:600;font-size:14px}
.hdr-btn:hover{background:#e8f4fc}
.hdr-btn:focus-visible{outline:2px solid #c3d6b6;outline-offset:2px}

/* Badge mode */
.mode-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:13px;font-weight:700;margin-left:12px}
.mode-badge.simple{background:linear-gradient(135deg, #4a1d1d 0%, #cf8282 100%);color:#fff}
.mode-badge.expert{background:linear-gradient(135deg, #21476b 0%, #10b981 100%);color:#fff}

/* Responsive mobile header */
/* 4 Carrés principaux */
.ort-card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.25)}
.city-suggestions div{padding:10px 12px;cursor:pointer;border-bottom:1px solid #eee;font-size:14px}
.city-suggestions div:hover{background:#f0f7ff}
.city-suggestions div:last-child{border-bottom:none}
@media (max-width: 600px) {
  .ort-grid-4{grid-template-columns:1fr !important}
  .route-builder-form{grid-template-columns:1fr !important}
}
@media (max-width: 768px) {
  header{padding:8px 10px;gap:6px}
  .header-row-1{gap:8px}
  .header-row-2{gap:6px;justify-content:flex-start}
  .brandlink img{width:50px;height:50px}
  .brand{font-size:16px}
  .langpick{padding:5px 6px;font-size:12px}
  .btn,.hdr-btn{padding:5px 8px;font-size:12px}
  .mode-badge{display:none !important}
}

/* Desktop: une seule ligne */
@media (min-width: 769px) {
  header{flex-direction:row;align-items:center}
  .header-row-1,.header-row-2{width:auto}
  .header-row-1{flex:1}
}

/* Modal budget */
.budget-modal-overlay{display:none;position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.7);align-items:flex-start;justify-content:center;padding-top:5vh;overflow-y:auto}
.budget-modal-overlay.show{display:flex}
.budget-modal{background:#e8f4fc;border-radius:14px;max-width:600px;width:90%;padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:modalSlideIn .3s ease;border:2px solid #113f7a;margin-bottom:5vh;max-height:90vh;overflow-y:auto}
@keyframes modalSlideIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.budget-modal h3{margin:0 0 16px;color:#113f7a;font-size:22px;font-weight:800}
.budget-modal p{margin:0 0 20px;color:#113f7a;font-size:15px}
.budget-modal label{color:#113f7a}
.budget-modal .filter-input,.budget-modal .filter-select{border:1px solid #113f7a;background:#fff;color:#113f7a}
.budget-modal .filter-input:focus,.budget-modal .filter-select:focus{outline:2px solid #113f7a;outline-offset:2px}
.budget-chips{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:24px}
.budget-chip{padding:10px 16px;border:2px solid #113f7a;border-radius:999px;background:#fff;color:#113f7a;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s}
.budget-chip:hover{border-color:#113f7a;background:#d0e8f7}
.budget-chip.selected{background:#113f7a;color:#fff;border-color:#113f7a}
.budget-modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:20px}
.budget-modal-btn{padding:12px 24px;border-radius:8px;border:0;cursor:pointer;font-weight:700;font-size:15px;transition:all .2s}
.budget-modal-btn.primary{background:#113f7a;color:#fff}
.budget-modal-btn.primary:hover{background:#0d2f5a}
.budget-modal-btn.secondary{background:#fff;color:#113f7a;border:2px solid #113f7a}
.budget-modal-btn.secondary:hover{background:#e8f4fc}

/* Clusters personnalisés */
.marker-cluster{background:transparent !important}
.marker-cluster div{background:rgba(30,136,229,0.85);border-radius:50%;font-weight:600;color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.3);border:2px solid #fff}
.marker-cluster-small div{width:28px;height:28px;font-size:10px}
.marker-cluster-medium div{background:rgba(46,125,50,0.85);width:34px;height:34px;font-size:11px}
.marker-cluster-large div{background:rgba(255,152,0,0.9);width:40px;height:40px;font-size:12px}
/* Clusters plus grands sur mobile/tablette */
@media (max-width: 1024px) {
  .marker-cluster-small div{width:40px;height:40px;font-size:14px}
  .marker-cluster-medium div{width:48px;height:48px;font-size:15px}
  .marker-cluster-large div{width:56px;height:56px;font-size:16px}
}

/* Étoiles */
.star-marker{filter:drop-shadow(0 1px 3px rgba(0,0,0,0.4));transition:transform 0.15s ease}
.star-marker:hover{transform:scale(1.2)}
.star-marker.selected{filter:drop-shadow(0 2px 4px rgba(225,29,72,0.5))}

/* Légende carte */
.map-legend{position:absolute;bottom:30px;left:10px;background:rgba(255,255,255,0.95);border-radius:8px;padding:10px 12px;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:1000;font-size:12px;max-width:160px}
.map-legend-title{font-weight:700;color:#113f7a;margin-bottom:8px;font-size:13px}
.map-legend-item{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.map-legend-item:last-child{margin-bottom:0}
.legend-star{flex-shrink:0}
.legend-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;border:1.5px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,0.3)}
.legend-dot.incontournable{background:#1565C0}
.legend-dot.recommande{background:#43A047}
.legend-dot.decouvrir{background:#7CB342}
.legend-dot.standard{background:#78909C}
.legend-dot.selected{background:#e11d48}
.map-legend-label{color:#333;font-size:11px}

.auth-pop{position:absolute;right:0;top:44px;background:#fff;color:var(--ink);border:1px solid var(--bd);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:8px;display:none;min-width:260px;z-index:10001}
.auth-pop .btn{display:block;width:100%;margin:6px 0;background:var(--acc);border:1px solid var(--acc);color:#fff}
.auth-pop .btn.out{background:#fff;color:var(--acc)}

    main{max-width:1200px;margin:18px auto 40px;padding:0 16px}
    .intro{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:18px;margin-bottom:20px}
    .intro h1{margin:0 0 4px;font-size:26px}

    /* MAP EXPLORER SECTION */
    .map-explorer{background:var(--acc);border:2px solid var(--acc);border-radius:14px;padding:15px;margin-bottom:14px;cursor:pointer;transition:all .3s;min-height:60px;display:flex;align-items:center;justify-content:center}
    .map-explorer:hover{box-shadow:0 4px 16px rgba(17,63,122,.3);transform:translateY(-2px)}
    .map-explorer h2{margin:0;font-size:22px;color:#fff;text-align:center;line-height:1.4}
    
    /* Responsive mobile pour map-explorer */
    @media (max-width: 768px) {
      main{padding:0 12px;margin-bottom:60px}
      .intro h1{font-size:22px}
      .map-explorer{padding:12px;min-height:50px}
      .map-explorer h2{font-size:16px;line-height:1.3}
    }
    
    /* Lien "Devenir créateur" */
    .creator-link-wrap{margin-top:20px;text-align:center;margin-bottom:20px;padding:0 16px}
    .creator-link{color:#fff;text-decoration:none;font-size:18px;font-weight:700;display:inline-block;padding:14px 28px;transition:all .2s;text-shadow:0 1px 2px rgba(0,0,0,0.3);background:rgba(255,255,255,0.15);border-radius:8px;border:2px solid rgba(255,255,255,0.4)}
    .creator-link:hover{color:#fff;background:rgba(255,255,255,0.25);transform:scale(1.05);border-color:rgba(255,255,255,0.6)}
    @media (max-width: 768px) {
      .creator-link{font-size:16px;padding:12px 24px}
    }
    
    /* FULLSCREEN MAP MODE */
    .map-fullscreen{position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;padding:20px}
    .map-fullscreen.active{display:flex}
    .map-fullscreen-content{background:#fff;border-radius:14px;width:100%;max-width:1600px;height:90vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .map-fullscreen-header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 20px;border-bottom:2px solid var(--acc);background:var(--card)}
    .map-fullscreen-header h2{margin:0;color:var(--acc);font-size:20px}
    
    /* Compteur itinéraires visibles */
    .visible-itins-count{background:linear-gradient(135deg, #21476b 0%, #10b981 100%);color:#fff;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:700;white-space:nowrap}
    
    .map-fullscreen-close{background:var(--acc);color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;font-weight:700;font-size:14px}
    .map-fullscreen-close:hover{background:#0d2f5a}
    .map-fullscreen-main{display:flex;flex:1;overflow:hidden}
    .map-fullscreen-body{flex:1;position:relative;overflow:hidden}
    .map-fullscreen-sidebar{width:320px;background:#f8f9fa;border-left:1px solid var(--bd);overflow-y:auto;padding:20px;overflow-anchor:none}
    #mapContainerFull{width:100%;height:100%}
    
    /* Bouton toggle filtres mobile */
    .filters-toggle-mobile{display:none;position:absolute;top:10px;left:10px;z-index:1001;background:#113f7a;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;font-weight:700;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .filters-toggle-mobile:active{transform:scale(0.95)}
    
    /* Responsive mobile : masquer sidebar par défaut, afficher avec bouton */
    @media (max-width: 768px) {
      .map-fullscreen-sidebar{position:absolute;top:0;right:-100%;width:80%;max-width:300px;height:100%;z-index:1002;transition:right 0.3s ease;box-shadow:-2px 0 10px rgba(0,0,0,0.3)}
      .map-fullscreen-sidebar.show{right:0}
      .filters-toggle-mobile{display:block}
    }
    
    /* Aperçu itinéraire */
    /* Aperçu itinéraire — plein hauteur carte (colonne droite) */
    .itin-preview{
      position:absolute;
      top:8px;
      right:8px;
      bottom:8px;           /* ← prend toute la hauteur de la carte */
      left:auto;
      width:360px;
      max-width:360px;
      background:#fff;
      border-radius:12px;
      padding:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      z-index:1000;
      border:2px solid var(--acc);
      overflow-y:auto;      /* ← scroll interne si contenu long */
    }
    .itin-preview h3{margin:0 0 12px;color:var(--acc);font-size:18px;padding-right:30px}
    .itin-preview .preview-close{position:absolute;top:12px;right:12px;background:none;border:none;color:var(--mut);font-size:20px;cursor:pointer;padding:0;width:24px;height:24px;line-height:1}
    .itin-preview .preview-close:hover{color:var(--acc)}

/* Responsive mobile pour preview */
@media (max-width: 768px) {
  /* Aperçu en BAS de l'écran, au-dessus de la barre */
  .itin-preview{
    position:fixed !important;
    top:auto !important;
    left:0 !important;
    right:0 !important;
    bottom:70px !important; /* Aligné avec la hauteur de la barre (70px) */
    width:100% !important;
    max-width:100% !important;
    height:auto !important;
    max-height:55vh !important;
    z-index:1004 !important; /* SOUS la légende (1005) */
    overflow-y:auto !important;
    -webkit-overflow-scrolling:touch !important; /* Scroll fluide iOS */
    background:#fff !important;
    border-radius:16px 16px 0 0 !important;
    padding:20px !important;
    box-shadow:0 -4px 20px rgba(0,0,0,0.3) !important;
    border:none !important;
    border-top:3px solid var(--acc) !important;
    pointer-events:auto !important; /* Cliquable */
  }
  
  /* Masquer le bouton dans l'aperçu sur mobile */
  .itin-preview .btn-select {
    display:none !important;
  }
  
  /* Barre d'action mobile TOUJOURS visible en bas */
  .mobile-action-bar {
    display:flex !important;
    position:fixed !important;
    bottom:0 !important;
    left:0 !important;
    right:0 !important;
    background:#fff !important;
    padding:10px 16px 12px 16px !important;
    box-shadow:0 -2px 10px rgba(0,0,0,0.2) !important;
    z-index:1003 !important; /* SOUS la légende (1005) et l'aperçu (1004) */
    border-top:2px solid var(--acc) !important;
    height:70px !important; /* Hauteur fixe */
    pointer-events:auto !important;
  }
  
  .select-itin-btn-mobile {
    display:block !important;
    width:100% !important;
    padding:16px !important;
    background:var(--acc) !important;
    color:#fff !important;
    border:none;
    border-radius:8px;
    font-size:18px;
    font-weight:700;
    cursor:pointer;
    pointer-events:auto !important;
  }
  
  .select-itin-btn-mobile:active {
    background:#0d2f5a;
    transform:scale(0.98);
  }
  
  /* Légende carte - Ajuster position pour ne pas être cachée */
  .map-legend {
    bottom:80px !important; /* Au-dessus de la barre (70px + marge) */
    z-index:1005 !important; /* AU-DESSUS de tout */
    pointer-events:auto !important;
  }
  
  /* S'assurer que la carte reste interactive */
  #mapContainerFull {
    pointer-events:auto !important;
  }
  
  /* Bouton fermeture aperçu - toujours visible */
  .preview-close {
    position:sticky !important;
    top:0 !important;
    z-index:10 !important;
    pointer-events:auto !important;
  }
  
  /* Sidebar filtres AU-DESSUS de l'aperçu quand affichée */
  .map-fullscreen-sidebar {
    z-index:1007 !important; /* Au-dessus de tout */
  }
}

/* Barre action mobile - cachée par défaut sur desktop */
.mobile-action-bar {
  display:none;
}

.select-itin-btn-mobile {
  display:none;
}

/* Modale confirmation mobile */
.mobile-confirm-modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  z-index:10000;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.mobile-confirm-modal.show {
  display:flex;
}

.mobile-confirm-content {
  background:#fff;
  border-radius:12px;
  padding:24px;
  max-width:400px;
  width:100%;
  box-shadow:0 8px 32px rgba(0,0,0,0.3);
}

.mobile-confirm-content h3 {
  margin:0 0 16px 0;
  color:var(--acc);
  font-size:18px;
  line-height:1.4;
}

#mobileConfirmInfo {
  margin-bottom:24px;
  color:#555;
  font-size:14px;
  line-height:1.6;
}

.mobile-confirm-actions {
  display:flex;
  gap:12px;
}

.mobile-confirm-actions button {
  flex:1;
  padding:14px;
  border:none;
  border-radius:8px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
}

.mobile-btn-cancel {
  background:#e5e7eb;
  color:#374151;
}

.mobile-btn-cancel:active {
  background:#d1d5db;
}

.mobile-btn-validate {
  background:var(--acc);
  color:#fff;
}

.mobile-btn-validate:active {
  background:#0d2f5a;
}

/* Modale de sélection mobile - DÉSACTIVÉE */
.mobile-selection-modal{
  display:none !important;
}

/* NEW: grille photo du preview */
.itin-preview .preview-photos{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin:8px 0 12px;
}
.itin-preview .preview-photos img{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  border-radius:8px;
}

/* === Preview dans l’onglet Filtres === */
.itin-preview.in-sidebar{
  position:static;     /* plus d’absolu sur la carte */
  inset:auto;          /* annule top/right/bottom/left */
  width:auto;
  max-width:none;
  height:auto;
  margin:0 0 12px 0;   /* espace sous le bloc */
  overflow:visible;    /* laisse scroller la sidebar */
  box-shadow:none;     /* look panneau colonne */
}




       #previewInfo{margin-bottom:12px;color:var(--mut);font-size:14px}
    #previewInfo div{margin:4px 0}
    /* FULL HEIGHT: plus de tronquage à 120px, laisse le panneau gérer le scroll */
    #previewCities{
      margin-bottom:12px;
      padding:10px;
      background:#f8f9fa;
      border-radius:8px;
      font-size:13px;
      color:var(--ink);
      max-height:none;          /* ← supprimé */
      overflow:visible;         /* ← pas de scrollbar interne */
      white-space:normal;       /* ← retour à la ligne naturel */
      line-height:1.35;
      word-break:break-word;
    }
    .preview-path-simplified{margin-bottom:12px;padding:10px;background:#e8f4f8;border-radius:8px;border:1px solid #b3d9e8}

    .preview-path-simplified .path-title{font-weight:700;color:var(--acc);margin-bottom:6px;font-size:13px}
    .preview-path-simplified .path-flow{display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:12px}
    .preview-path-simplified .city-node{padding:4px 8px;background:#fff;border:1px solid var(--acc);border-radius:6px;color:var(--acc);font-weight:600}
    .preview-path-simplified .arrow{color:var(--mut);font-weight:700}
    .btn-select{width:100%;padding:10px;background:var(--acc);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px}
    .btn-select:hover{background:#0d2f5a}
    
    /* Amélioration mobile pour le bouton */
    @media (max-width: 768px) {
      .btn-select{padding:14px;font-size:16px;margin-top:12px}
    }
    
    /* Sidebar filters */
    .map-controls-vertical h3{margin:0 0 16px;color:var(--acc);font-size:18px;padding-bottom:12px;border-bottom:2px solid var(--acc)}
    .filter-group{margin-bottom:16px}
    .filter-group label{display:block;font-weight:600;margin-bottom:6px;color:var(--ink);font-size:14px}
    .filter-select,.filter-input{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:8px;background:#fff;font-size:14px}
    .filter-select:focus,.filter-input:focus{outline:2px solid var(--acc);outline-offset:2px}
    .btn-reset-full{width:100%;padding:10px;background:var(--acc);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-top:8px;font-size:14px}
    .btn-reset-full:hover{background:#0d2f5a}
    .filter-count-box{margin-top:20px;padding:12px;background:#fff;border:1px solid var(--bd);border-radius:8px;text-align:center}
    .filter-count-box span{font-weight:700;color:var(--acc);font-size:15px}
    
    /* Selection panel */
    .selection-panel{margin-top:24px;padding:16px;background:#fff;border:2px solid var(--acc);border-radius:10px}
    .selection-panel h4{margin:0 0 12px;color:var(--acc);font-size:16px;font-weight:700}
    #selectedList{margin-bottom:12px;max-height:300px;overflow-y:auto;min-height:50px;display:block;width:100%}
    .selected-item{display:flex;align-items:center;justify-content:space-between;padding:8px;margin-bottom:8px;background:#f8f9fa;border-radius:8px;font-size:13px;width:100%;box-sizing:border-box}
    .selected-item-title{flex:1;font-weight:600;color:var(--ink);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0}
    .selected-item-remove{background:none;border:none;color:#dc2626;cursor:pointer;font-size:18px;padding:0 4px;line-height:1;flex-shrink:0}
    .selected-item-remove:hover{color:#991b1b}
    .selected-item:last-child{margin-bottom:0}
    .btn-validate{width:100%;padding:10px;background:#22c55e;color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px}
    .btn-validate:hover{background:#16a34a}
    
    .leaflet-popup-content{min-width:200px}
    .leaflet-popup-content h3{margin:0 0 6px;color:var(--acc)}
    .leaflet-popup-content .itin-days{font-weight:600;color:var(--mut)}
    .leaflet-popup-content .itin-region{font-size:13px;color:var(--mut);margin:4px 0}
    .leaflet-popup-content .itin-link{display:inline-block;margin-top:8px;padding:6px 12px;background:var(--acc);color:#fff;text-decoration:none;border-radius:8px;font-size:14px}
    .leaflet-popup-content .itin-link:hover{background:#0d2f5a}
    
    @media (max-width:900px){
      .map-fullscreen-main{flex-direction:column}
      .map-fullscreen-sidebar{width:100%;max-height:300px;border-left:none;border-top:1px solid var(--bd)}
      .itin-preview{
        top:auto; bottom:8px; right:8px; left:8px;
        width:auto; max-width:none; max-height:60vh;  /* paneau large, hauteur raisonnable */
      }
    }@media (max-width:900px){
  .hdr-row{display:none}
  .langpick{max-width:80px}
}

    .cols{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
    @media (max-width:900px){ .cols{grid-template-columns:1fr} }

    /* Panels with equal height and aligned CTAs */
    .panel{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:14px;display:flex;flex-direction:column;min-height:340px}
    .panel h2{margin:0 0 12px;padding-bottom:8px;font-size:17px;color:var(--mut);border-bottom:2px solid var(--bd);font-weight:700}
    .panel .grow{flex:1}
    .panel ul{margin:6px 0 0 18px}
    .panel li{margin:6px 0}
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:auto} /* <- push CTAs to bottom */
    .cta{background:var(--acc);color:#fff;border:1px solid var(--acc);border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    
    /* Builder box (mode expert) */.builder-box{background:linear-gradient(135deg, #113f7a 0%, #5ba4d4 100%);border-radius:14px;padding:20px;box-shadow:0 4px 12px rgba(17,63,122,.3);cursor:pointer;transition:all .3s}
    .builder-content{text-align:center}
    .builder-box h2{margin:0 0 10px;font-size:22px;color:#fff;font-weight:800}
    .builder-box p{margin:0 0 16px;color:#fff;font-size:15px;opacity:.95}
   .builder-box .cta{background:#fff;color:#113f7a;border:2px solid #fff;font-size:15px;display:none}
    .builder-box .cta:hover{background:rgba(255,255,255,.9);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
    
    /* Coloration dynamique des boutons selon le mode */
    .mode-simple .cta{background:linear-gradient(135deg, #4a1d1d 0%, #cf8282 100%);border-color:#4a1d1d}
    .mode-simple .map-explorer{background:linear-gradient(135deg, #4a1d1d 0%, #cf8282 100%);border-color:#4a1d1d}
   
    .mode-simple .map-explorer:hover{box-shadow:0 4px 16px rgba(74,29,29,.3)}
    .mode-simple .budget-modal-btn.primary{background:#00b2ff}
    .mode-simple .budget-modal-btn.primary:hover{background:#0095d9}
    .mode-simple .btn-validate{background:#00b2ff}
    .mode-simple .btn-validate:hover{background:#0095d9}
    
    .mode-expert .cta{background:linear-gradient(135deg, #113f7a 0%, #5ba4d4 100%);border-color:#113f7a}
    .mode-expert .cta:hover{background:#0d2f5a}
    .mode-expert .map-explorer{background:linear-gradient(135deg, #113f7a 0%, #5ba4d4 100%);border-color:#113f7a}
    .mode-expert .map-explorer:hover{box-shadow:0 4px 16px rgba(17,63,122,.3)}
    .mode-expert .budget-modal-btn.primary{background:#21476b}
    .mode-expert .budget-modal-btn.primary:hover{background:#047857}
    .mode-expert .btn-validate{background:#21476b}
    .mode-expert .btn-validate:hover{background:#047857}

    .full{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:16px;margin-top:14px}
    .full h2{margin:0 0 8px;color:var(--acc);font-size:18px}
    .full ul{margin:6px 0 0 18px}
    .full li{margin:6px 0}
    .muted{color:var(--mut);font-size:14px}

    /* bottom panel layout with image on the right */
    .fullGrid{display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start}
    @media (max-width:900px){ .fullGrid{grid-template-columns:1fr} }
    .pilot{width:100%;max-width:520px;border-radius:12px;border:1px solid var(--bd);box-shadow:0 4px 16px rgba(0,0,0,.12)}

    .support{margin-top:14px;padding:12px;border:1px solid var(--warn);background:#fef9c3;border-radius:12px;color:#713f12;font-size:15px}

    footer{margin:26px 0 20px;text-align:center;font-size:14px;opacity:.9}
    footer a, footer button.link{color:var(--acc);text-decoration:none;background:none;border:0;cursor:pointer}
    footer a:hover, footer button.link:hover{text-decoration:underline}

    #cookieBanner{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;z-index:99999;display:none}
    #cookieBanner .panel{max-width:520px;background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:10px}
    #cookiePrefs{display:none;margin-top:6px;text-align:left}
    #cookiePrefs label{display:flex;align-items:center;gap:8px;margin:4px 0}
  #cookieBanner .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:8px}
#cookieBanner .btn{background:#fff;color:#113f7a;border:1px solid #113f7a}       /* ← boutons visibles sur fond blanc */
#cookieBanner #btnAccept{background:#113f7a;color:#fff;border-color:#113f7a}     /* ← bouton 'Tout accepter' en accent */


/* Email modal */
#emailModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:10000}
.modal-card{width:min(440px,92vw);background:#fff;border-radius:14px;border:1px solid #c3d6b6;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.16);color:var(--ink)}
.modal-card h3{margin:0 0 6px}
.input{width:100%;padding:10px 12px;border:1px solid #113f7a;border-radius:10px;margin:8px 0}
.muted{font-size:13px;color:#475569}
.links{display:flex;align-items:center;gap:10px}
.link{background:none;border:0;color:#113f7a;cursor:pointer;text-decoration:underline;padding:0}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
.btn-outline{background:#fff;color:var(--acc);border:1px solid var(--acc);border-radius:10px;padding:8px 12px;cursor:pointer}
.btn-primary{background:var(--acc);color:#fff;border:1px solid var(--acc);border-radius:10px;padding:8px 12px;cursor:pointer}
.alert{padding:12px;border-radius:8px;margin:8px 0;border:1px solid}
.alert-success{background:#f0fdf4;border-color:#bbf7d0;color:#166534}
.alert-error{background:#fef2f2;border-color:#fecaca;color:#dc2626}
.input-wrap{position:relative}
.eye-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;padding:6px;border-radius:8px}
.eye-btn:focus{outline:2px solid #c3d6b6;outline-offset:2px}
.eye-btn svg{width:20px;height:20px}

/* Filter badge counter */
.filter-badge{background:#ef4444;color:#fff;border-radius:12px;padding:2px 8px;font-size:12px;font-weight:700;margin-left:6px}

/* === TABLEAU TARIFS === */
.pricing-wrap{max-width:1200px;margin:32px auto 0;padding:0 16px}
.pricing-section{position:relative}
.pricing-toggle{display:none;align-items:center;gap:8px;background:#113f7a;color:#fff;padding:12px 16px;border-radius:8px;margin-bottom:16px;cursor:pointer;border:none;font-size:15px;font-weight:600}
.pricing-toggle svg{width:20px;height:20px;flex-shrink:0}
.pricing-table{width:100%;border-collapse:separate;border-spacing:0 10px}
.pricing-table thead th{background:#dfe8f4;color:#0d3159;padding:14px 12px;font-weight:700;text-align:center;font-size:14px}
.pricing-table thead th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px;text-align:left}
.pricing-table thead th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
.pricing-table tbody td{background:#fff;padding:14px 12px;border-top:1px solid #e6eef7;border-bottom:1px solid #e6eef7;font-size:14px}
.pricing-table tbody tr td:first-child{border-left:1px solid #e6eef7;border-top-left-radius:10px;border-bottom-left-radius:10px;font-weight:600}
.pricing-table tbody tr td:last-child{border-right:1px solid #e6eef7;border-top-right-radius:10px;border-bottom-right-radius:10px}
.price{font-weight:800;font-size:1.25rem}
.yes{color:#157347;font-weight:700}
.no{color:#9b1c1c;font-weight:700}
.plans-head{display:flex;gap:10px;align-items:center;justify-content:flex-end}
.badge{background:#0d3159;color:#fff;border-radius:999px;padding:4px 10px;font-size:.8rem}

/* Responsive mobile pour le tableau des prix */
@media (max-width: 768px) {
  .pricing-toggle{display:flex}
  .pricing-table{display:none}
  .pricing-table.show{display:table}
  .pricing-table{font-size:12px}
  .pricing-table thead th{padding:10px 6px;font-size:12px}
  .pricing-table tbody td{padding:10px 6px;font-size:11px}
  .pricing-table tbody tr td:first-child{font-size:12px}
  .price{font-size:1rem}
  .badge{font-size:.7rem;padding:3px 8px}
  .plans-head{flex-direction:column;gap:4px}
}

  </style>

  
</head>
<body>
<header>
  <div class="header-row-1">
    <a class="brandlink" id="homeLink" href="#">
      <img src="/assets/symbol.webp" alt="Logo"><div class="brand">OneRoadTrip</div>
    </a>

  </div>
  
  <div class="header-row-2">

    <button id="backToPresentation" class="hdr-btn" style="display:none">← <span id="backBtnText">Retour</span></button>
    <select id="langSel" class="langpick" aria-label="Langue">
      <option value="fr">Français</option>
      <option value="en">English</option>
    <option value="it">Italiano</option>
    <option value="es">Español</option>
    <option value="pt">Português</option>
    <option value="ar">العربية</option>
  </select>
  <div class="auth">
    <button id="openAuth" class="btn" type="button">
      <span>Se connecter</span>
    </button>
    <div id="authPop" class="auth-pop" role="dialog" aria-label="Connexion">
      <button id="btnGoogle" class="btn" type="button">Google</button>
      <button id="btnEmail" class="btn" type="button">E-mail</button>
      <button id="btnLogout" class="btn out" type="button" style="display:none">Déconnexion</button>
    </div>
  </div>
  </div>
</header>

<main>
  <div class="intro" style="display:none">
    <h1 id="title"></h1>
  </div>

  <!-- 4 CARRÉS + ROUTE BUILDER -->
  <div style="max-width:800px;margin:0 auto;padding:8px 16px;">
    
    <!-- Grille 2x2 -->
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px;">
      
      <!-- Carré 1: Choisir sur carte -->
      <div class="ort-card" id="mapExplorerPreview" style="background:#113f7a;border-radius:10px;padding:16px;cursor:pointer;text-align:center;">
        <h3 id="mapTitle" style="margin:0;font-size:15px;color:#fff;line-height:1.4;"></h3>
      </div>
      
      <!-- Carré 2: Construire de A à Z -->
      <div class="ort-card" id="buildFromScratch" style="background:#113f7a;border-radius:10px;padding:16px;cursor:pointer;text-align:center;">
        <h3 id="buildTitle" style="margin:0;font-size:15px;color:#fff;line-height:1.4;"></h3>
      </div>
      
      <!-- Carré 3: Trouver sur le web -->
      <div class="ort-card" id="importFromWeb" style="background:#113f7a;border-radius:10px;padding:16px;cursor:pointer;text-align:center;">
        <h3 id="importTitle" style="margin:0;font-size:15px;color:#fff;line-height:1.4;"></h3>
      </div>
      
      <!-- Carré 4: Itinéraires créateurs -->
      <div class="ort-card" id="creatorsSection" style="background:#113f7a;border-radius:10px;padding:16px;cursor:pointer;text-align:center;">
        <h3 id="creatorsTitle2" style="margin:0;font-size:15px;color:#fff;line-height:1.4;"></h3>
        <a id="becomeCreator" href="creator-terms.html" style="display:block;margin:6px 0 0;font-size:12px;color:rgba(255,255,255,0.8);text-decoration:underline;" onclick="event.stopPropagation();"></a>
      </div>
    </div>
    
    <!-- Route Builder compact -->
    <div style="background:rgba(17,63,122,0.9);border-radius:10px;padding:16px;backdrop-filter:blur(4px);">
      <h3 id="routeBuilderTitle" style="margin:0 0 12px;color:#fff;font-size:15px;text-align:center;"></h3>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <!-- Ville de départ -->
        <div class="rb-field" style="position:relative;">
          <label id="labelStartCity" style="display:block;color:#fff;font-size:12px;margin-bottom:4px;">Ville de départ</label>
          <input type="text" id="inputStartCity" autocomplete="off" style="width:100%;padding:8px 10px;border:1px solid #3b82f6;border-radius:6px;font-size:14px;box-sizing:border-box;">
          <div id="startCitySuggestions" class="city-suggestions" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;max-height:150px;overflow-y:auto;z-index:1000;"></div>
          <small id="warnStartCity" style="display:none;color:#fbbf24;font-size:11px;margin-top:2px;"></small>
        </div>
        
        <!-- Ville d'arrivée -->
        <div class="rb-field" style="position:relative;">
          <label id="labelEndCity" style="display:block;color:#fff;font-size:12px;margin-bottom:4px;">Ville d'arrivée</label>
          <input type="text" id="inputEndCity" autocomplete="off" style="width:100%;padding:8px 10px;border:1px solid #3b82f6;border-radius:6px;font-size:14px;box-sizing:border-box;">
          <div id="endCitySuggestions" class="city-suggestions" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;max-height:150px;overflow-y:auto;z-index:1000;"></div>
          <small id="warnEndCity" style="display:none;color:#fbbf24;font-size:11px;margin-top:2px;"></small>
        </div>
        
        <!-- Km max / Détour / Durée sur une ligne -->
        <div style="grid-column:span 2;display:flex;gap:10px;align-items:flex-end;">
          <div style="flex:1;">
            <label id="labelMaxKm" style="display:block;color:#fff;font-size:11px;margin-bottom:4px;">Km/étape</label>
            <select id="inputMaxKm" style="width:100%;padding:8px 6px;border:1px solid #3b82f6;border-radius:6px;font-size:13px;box-sizing:border-box;background:#fff;">
              <option value="20">20</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="150">150</option>
              <option value="200" selected>200</option>
              <option value="300">300</option>
              <option value="500">500</option>
            </select>
          </div>
          <div style="flex:1;">
            <label id="labelDetour" style="display:block;color:#fff;font-size:11px;margin-bottom:4px;">Détour</label>
            <select id="inputDetour" style="width:100%;padding:8px 6px;border:1px solid #3b82f6;border-radius:6px;font-size:13px;box-sizing:border-box;background:#fff;">
              <option value="0">0 km</option>
              <option value="20">20 km</option>
              <option value="50" selected>50 km</option>
              <option value="100">100 km</option>
            </select>
          </div>
          <div style="flex:1;">
            <label id="labelDuration" style="display:block;color:#fff;font-size:11px;margin-bottom:4px;">Durée</label>
            <div style="display:flex;align-items:center;gap:4px;">
              <input type="number" id="inputDuration" min="1" max="50" value="7" style="width:50px;padding:8px 4px;border:1px solid #3b82f6;border-radius:6px;font-size:13px;box-sizing:border-box;text-align:center;">
              <span id="labelDays" style="color:#fff;font-size:12px;">j</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Bouton -->
      <button id="btnGenerateRoute" style="display:block;width:100%;margin-top:12px;padding:10px;background:linear-gradient(135deg,#113f7a,#1e5a9e);color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;">
        <span id="generateBtnText">Générer mon itinéraire</span>
      </button>
    </div>
  </div>

  <!-- FULLSCREEN MAP MODAL -->
  <div id="mapFullscreen" class="map-fullscreen">
    <div class="map-fullscreen-content">
      <div class="map-fullscreen-header">
        <h2 id="mapTitleFull" style="text-align:center;flex:1"></h2>
        <span id="visibleItinsCount" class="visible-itins-count"></span>
        <button id="closeMapFull" class="map-fullscreen-close">✕ <span id="closeBtnText">Fermer</span></button>
      </div>
      <!-- Bandeau de sélection en haut -->
      <div id="selectionBanner" style="display:none;position:relative;z-index:1000;background:linear-gradient(135deg,#113f7a,#1e5a9e);padding:12px 20px;border-bottom:2px solid rgba(255,255,255,0.2);">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
          <div id="selectionBannerItems" style="display:flex;flex-wrap:wrap;gap:8px;flex:1;"></div>
          <button id="btnContinueSelection" onclick="validateAndContinue()" style="background:#10b981;color:#fff;border:none;padding:10px 24px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;white-space:nowrap;">Continuer →</button>
        </div>
      </div>
      <div class="map-fullscreen-main">
        <div class="map-fullscreen-body">
          <div id="mapContainerFull"></div>
          
          <!-- Bouton toggle filtres mobile -->
          <button id="toggleFiltersMobile" class="filters-toggle-mobile">
            <span id="filtersBtnText">Filtres</span>
          </button>
          
          <!-- Légende de la carte -->
          <div class="map-legend" id="mapLegend">
            <div class="map-legend-title" id="legendTitle">Itinéraires</div>
            <div class="map-legend-item">
              <svg class="legend-star" width="16" height="16" viewBox="0 0 24 24" fill="#1565C0" stroke="#fff" stroke-width="2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <span class="map-legend-label" id="legendIncontournable">Incontournable</span>
            </div>
            <div class="map-legend-item">
              <div class="legend-dot recommande"></div>
              <span class="map-legend-label" id="legendRecommande">Recommandé</span>
            </div>
            <div class="map-legend-item">
              <div class="legend-dot decouvrir"></div>
              <span class="map-legend-label" id="legendDecouvrir">À découvrir</span>
            </div>
            <div class="map-legend-item">
              <div class="legend-dot standard"></div>
              <span class="map-legend-label" id="legendStandard">Standard</span>
            </div>
            <div class="map-legend-item">
              <div class="legend-dot selected"></div>
              <span class="map-legend-label" id="legendSelected">Sélectionné</span>
            </div>
          </div>
          
          <!-- Aperçu au survol -->
<div id="itinPreview" class="itin-preview" style="display:none">
  <button onclick="closeItinPreview()" style="position:absolute;top:10px;right:10px;background:#e5e7eb;color:#333;border:none;padding:8px 12px;border-radius:6px;font-size:14px;cursor:pointer;z-index:10;">✕</button>
  <h3 id="previewTitle"></h3>

  <!-- NEW: conteneur des 4 photos liées aux lieux de l’itin -->
  <div class="preview-photos" id="previewPhotos"></div>
  <!-- … autres infos … -->

            <div id="previewInfo"></div>
            <div id="previewPathSimplified" class="preview-path-simplified" style="display:none">
              <div class="path-title">Parcours simplifié :</div>
              <div class="path-flow" id="previewPathFlow"></div>
            </div>
            <div id="previewCities"></div>
            <button id="previewSelectBtn" style="width:100%;margin-top:12px;background:#10b981;color:#fff;border:none;padding:12px 16px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;">+ Ajouter à ma sélection</button>
          </div>
        </div>
        
        <!-- Barre fixe bouton sélection (mobile uniquement) -->
        <div id="mobileActionBar" class="mobile-action-bar">
          <button id="mobileCancelBtn" class="mobile-btn-cancel">
            <span id="mobileCancelBtnText">Annuler</span>
          </button>
          <button id="selectItinBtnMobile" class="select-itin-btn-mobile">
            <span id="selectItinBtnMobileText">Valider</span>
          </button>
        </div>
        
        <!-- Modale confirmation simple mobile -->
        <div id="mobileConfirmModal" class="mobile-confirm-modal">
          <div class="mobile-confirm-content">
            <h3 id="mobileConfirmTitle"></h3>
            <div id="mobileConfirmInfo"></div>
            <div class="mobile-confirm-actions">
              <button id="mobileConfirmCancel" class="mobile-btn-cancel">
                <span id="mobileConfirmCancelText">Annuler</span>
              </button>
              <button id="mobileConfirmValidate" class="mobile-btn-validate">
                <span id="mobileConfirmValidateText">Valider</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Modale de sélection mobile uniquement -->
        <div id="mobileSelectionModal" class="mobile-selection-modal">
          <div class="mobile-selection-content" style="background:#fff;border-radius:12px;max-width:95vw;width:400px;max-height:85vh;overflow:hidden;">
            <div class="mobile-selection-header" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#113f7a;border-radius:12px 12px 0 0;">
              <button id="mobileModalSelect" style="background:#10b981;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;font-size:14px;">Sélectionner</button>
              <h3 id="mobileModalTitle" style="flex:1;text-align:center;color:#fff;margin:0 10px;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></h3>
              <button id="mobileModalCancel" style="background:rgba(255,255,255,0.2);border:none;color:#fff;font-size:20px;cursor:pointer;padding:0;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;">✕</button>
            </div>
            <div class="mobile-selection-body" style="padding:16px;max-height:calc(85vh - 60px);overflow-y:auto;">
              <div id="mobileModalInfo" style="margin-bottom:12px;"></div>
              <div id="mobileModalPhotos" style="margin:12px 0;"></div>
              <div id="mobileModalSteps" style="margin-top:16px;font-size:14px;border-top:1px solid #e5e7eb;padding-top:12px;"></div>
            </div>
          </div>
        </div>
        
        <div class="map-fullscreen-sidebar">
          <div class="map-controls-vertical">
            <h3 id="filterTitle"></h3>
            
            <div class="filter-group">
              <label for="filterDaysFull" id="labelDaysFull"></label>
              <select id="filterDaysFull" class="filter-select">
                <option value="">Tous</option>
                <option value="1-3">1-3 jours</option>
                <option value="4-7">4-7 jours</option>
                <option value="8-14">8-14 jours</option>
                <option value="15+">15+ jours</option>
              </select>
            </div>
            <div class="filter-group">
         <label for="filterDistanceFull" id="labelDistanceFull" style="display:none"></label>
<select id="filterDistanceFull" class="filter-select" style="display:none">
  <option value="">Toutes</option>
  <option value="0-500">0-500 km</option>
  <option value="501-1000">501-1000 km</option>
  <option value="1001-2000">1001-2000 km</option>
  <option value="2001+">2001+ km</option>
</select>

            </div>
            <div class="filter-group">
       <label for="filterCountryFull" id="labelCountryFull" style="display:none"></label>
<select id="filterCountryFull" class="filter-select" style="display:none">
  <option value="">Tous</option>
</select>

            </div>
            <div class="filter-group">
        <label for="filterRegionFull" id="labelRegionFull" style="display:none"></label>
<select id="filterRegionFull" class="filter-select" style="display:none">
  <option value="">Toutes</option>
</select>
    </div>
            <div class="filter-group">
              <label for="filterThemeFull" id="labelThemeFull"></label>
<select id="filterThemeFull" class="filter-select">
  <option value="">Tous</option>
  <!-- Options générées dynamiquement depuis themes.i18n.json -->
</select>
            </div>
            <div class="filter-group">
              <label for="searchItinFull" id="labelSearchFull"></label>
              <input type="text" id="searchItinFull" class="filter-input" placeholder="Mot-clé...">
            </div>
            <button id="btnResetFiltersFull" class="btn-reset-full"></button>
            <div class="filter-count-box">
              <span id="filterCountFull"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- TABLEAU COMPLET account.html -->
  <div class="full pricing-section" style="display:none;margin-top:24px">
    <!-- Bouton pour afficher/masquer les prix sur mobile -->
    <button class="pricing-toggle" id="pricingToggle">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4M12 8h.01"/>
      </svg>
      <span id="pricingToggleText">Voir les tarifs détaillés</span>
    </button>
    
    <table class="pricing-table" id="pricing-table">
      <thead>
        <tr>
          <th data-i18n="col.feature">Fonctionnalités</th>
          <th><div class="plans-head"><span data-i18n="plan.bronze">Bronze</span></div></th>
          <th><div class="plans-head"><span data-i18n="plan.silver">Silver</span><span class="badge" data-i18n="plan.popular">Le plus populaire</span></div></th>
          <th><div class="plans-head"><span data-i18n="plan.gold">Gold</span></div></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td data-i18n="row.price">Prix mensuel</td>
          <td class="price" data-i18n="pricing.bronze.price">Gratuit</td>
          <td class="price" data-i18n="pricing.silver.price">4,99 €/mois</td>
          <td class="price" data-i18n="pricing.gold.price">9,99 €/mois</td>
        </tr>
        <tr>
          <td data-i18n="row.core">Cœur d'ORT (itinéraires modifiables, détails d'étapes, points d'intérêts, liens de réservation)</td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
        </tr>
        <tr>
          <td data-i18n="row.stories">Stories publiques & partage</td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
        </tr>
        <tr>
          <td data-i18n="row.pdf">Export PDF complet du voyage</td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
        </tr>
        <tr>
          <td data-i18n="row.maps">Cartes interactives</td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
          <td><span class="yes" data-i18n="yes">Oui</span></td>
        </tr>
        <tr>
          <td data-i18n="row.rtlimit">Roadtrips pouvant être stockés dans le dashboard</td>
          <td data-i18n="pricing.bronze.rtlimit">3</td>
          <td data-i18n="pricing.silver.rtlimit">20</td>
          <td data-i18n="pricing.gold.rtlimit">50</td>
        </tr>
        <tr>
          <td data-i18n="row.photosday">Photos par jour pouvant être publiées dans votre story</td>
          <td data-i18n="pricing.bronze.photos">3</td>
          <td data-i18n="pricing.silver.photos">15</td>
          <td data-i18n="pricing.gold.photos">50</td>
        </tr>
        <tr>
          <td data-i18n="row.storage">Espace total photos</td>
          <td data-i18n="pricing.bronze.storage">1 Go</td>
          <td data-i18n="pricing.silver.storage">20 Go</td>
          <td data-i18n="pricing.gold.storage">100 Go</td>
        </tr>
        <tr>
          <td data-i18n="row.ai">Assistance IA (créations automatiques d'itinéraires et avis sur le voyage)</td>
          <td><span class="no" data-i18n="no">Non</span></td>
          <td data-i18n="pricing.silver.ia">10 actions par mois</td>
          <td data-i18n="pricing.gold.ia">30 actions par mois</td>
        </tr>
        <tr>
          <td data-i18n="row.backup">Sauvegarde Cloud (sécurité de vos données)</td>
          <td><span class="no" data-i18n="no">Non</span></td>
          <td data-i18n="pricing.silver.backup">Automatique</td>
          <td data-i18n="pricing.gold.backup">Automatique</td>
        </tr>
        <tr>
          <td data-i18n="row.family">Espace famille / amis (inviter des proches)</td>
          <td><span class="no" data-i18n="no">Non</span></td>
          <td data-i18n="pricing.silver.family">Jusqu'à 3 invités</td>
          <td data-i18n="pricing.gold.family">Jusqu'à 10 invités</td>
        </tr>
      </tbody>
    </table>
  </div>

</main>


<footer id="footer-legal"></footer>


<!-- Firebase compat est chargé dynamiquement par ensureFirebase() (v10.12.2) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
/* ===== I18N TRANSLATIONS ===== */
const T = {
  fr: {
    notice: "Sans inscription, vos itinéraires ne seront pas sauvegardés",
    title: "OneRoadTrip – Créez le voyage de vos rêves",
    
    // Mode Expert : Construisez de A à Z
    builder_title: "Construisez votre itinéraire de A à Z",
    builder_text: "Partez d'une page blanche et créez votre voyage étape par étape en sélectionnant des lieux sur une carte interactive du monde entier.",
    builder_btn: "Commencer la création",
    
    // Option simplifiée
    left_title: "Créez votre voyage en 5 questions simples",
    left_list: [
      "Quelle destination vous fait rêver ?",
      "Combien de jours partez-vous ?",
      "Quel style de voyage préférez-vous : aventure, détente, culture ?",
      "Comment vous déplacerez-vous sur place ?",
      "Quel est votre budget approximatif ?"
    ],
    btn_simple: "Je commence maintenant",
    
    // Option complète
// Option complète
right_title: "Trouvez sur le web un itinéraire ou une liste de lieux qui vous inspire et construisez le voyage de vos rêves",
creators_title: "Voir les itinéraires proposés par des créateurs de contenus",
become_creator: "Devenir créateur",
right_lead: "",
right_list: [
  "Copiez l'itinéraire* qui vous inspire depuis n'importe quel site web",
  "Utilisez un assistant IA pour l'optimiser selon nos instructions (ChatGPT, Claude...)",
  "Collez le résultat dans notre interface",
  "Obtenez instantanément un voyage 100% modifiable et personnalisable"
],
right_note: "*Important : Assurez-vous que le contenu copié est libre de droits",
    btn_full: "J'importe un voyage",
    
    // Résultats
    bottom_title: "Votre voyage clé en main comprend",
    bottom_list: [
      "Itinéraire détaillé jour par jour avec durées de trajet optimisées",
      "Carte interactive avec toutes vos étapes géolocalisées",
      "Modification illimitée de votre parcours en temps réel",
      "Réservation directe des vols et locations de véhicules",
      "Accès aux meilleurs hôtels via nos partenaires privilégiés",
      "Réservation d'activités et d'expériences uniques",
      "Options complètes d'assurance voyage"
    ],
    
    stage_hdr: "Pour chaque étape de votre voyage, découvrez :",
    stage_1: "Programme quotidien optimisé avec horaires suggérés",
    stage_2: "Points d'intérêt incontournables et vos ajouts personnalisés",
    stage_3: "Carte détaillée avec itinéraire de visite optimisé",
    stage_4: "Sélection d'hébergements adaptés à votre budget",
    
    doc_line: "Export en PDF ou PowerPoint • Accès mobile hors-ligne • Partage facile avec vos compagnons de voyage",
    support: "OneRoadTrip est 100% gratuit. Les réservations via nos liens partenaires nous aident à maintenir le service sans aucun surcoût pour vous. Merci pour votre soutien !",
    
    login: "Se connecter",
    badge_mode_simple: "Mode Simplifié",
    badge_mode_expert: "Mode Expert",
    cookie_text: "Nous utilisons des cookies essentiels pour votre connexion. Les cookies optionnels sont désactivés par défaut.",
    cookie_opt_a: "Statistiques d'utilisation",
    cookie_opt_m: "Marketing ciblé",
    cookie_btn_p: "Personnaliser",
    cookie_btn_r: "Tout refuser",
    cookie_btn_a: "Tout accepter",
    pricing_show: "Voir les tarifs détaillés",
    pricing_hide: "Masquer les tarifs",
    mapTitle:"Choisissez votre itinéraire sur une carte",
    buildTitle:"Construisez votre itinéraire de A à Z",
    importTitle:"Trouvez sur le web un itinéraire qui vous inspire",
    creatorsTitle:"Itinéraires proposés par les créateurs",
    becomeCreator:"Devenir créateur",
    routeBuilderTitle:"🚗 Laissez-nous construire votre itinéraire",
    labelStartCity:"Ville de départ",
    labelEndCity:"Ville d'arrivée",
    labelMaxKm:"Km/étape",
    labelDuration:"Durée",
    generateBtn:"🚀 Générer mon itinéraire",
    labelDetour:"Détour autorisé",
    labelDaysUnit:"jours",
    warnCityNotSelected:"⚠️ Ville non validée - résultat peut être inexact",
    generatingBtn:"⏳ Calcul en cours...",
    placeholderStart:"Paris, Lyon...",
    placeholderEnd:"Barcelone, Rome...",
    days:"jours",
    mapClickToOpen:"Cliquez pour ouvrir la carte interactive",
    filterTitle:"Filtres",
    filtersBtnText:"🔍 Filtres",
    labelDays:"Durée :",
    labelDistance:"Distance :",
    labelCountry:"Pays :",
    labelRegion:"Région :",
    labelTheme:"Thème :",
    labelSearch:"Recherche :",
    btnReset:"Réinitialiser",
    filterCount_single:"itinéraire trouvé",
    filterCount_plural:"itinéraires trouvés",
    popupDays:"jours",
    popupViewDetails:"Voir les détails",
    selectionTitle:"Sélection (max 3)",
    selectionTitleSimple:"Sélection (max 1)",
    selectionTitleExpert:"Sélection (max 3)",
    compareBtn:"Voir l'itinéraire",
    alertAlreadySelected:"Déjà sélectionné",
    alertMaxSelection:"Maximum 3 itinéraires",
    alertMaxSelectionSimple:"Maximum 1 itinéraire en mode simplifié",
    selectBtnText:"Sélectionner",
    mobileSelectText:"Sélectionner",
    mobileCancelText:"Annuler",
    mobileDays:"jours",
    mobileStops:"étapes",
    mobileCities:"Villes traversées :",
    closeBtnText:"Fermer",
    backBtnText:"Retour",
    homeBtnText:"← Retour",
    legend_title:"Itinéraires",
    legend_incontournable:"Incontournable",
    legend_recommande:"Recommandé",
    legend_decouvrir:"À découvrir",
    legend_standard:"Standard",
    legend_selected:"Sélectionné",
    visible_itins_single:"itinéraire visible",
    visible_itins_plural:"itinéraires visibles",
    budget_modal_title:"Budget hôtel",
    budget_modal_text:"Sélectionnez une ou plusieurs tranches (€/jour/personne) :",
    budget_confirm:"Valider",
    budget_cancel:"Annuler",
    budget_0_50:"0–50",
    budget_50_100:"50–100",
    budget_100_150:"100–150",
    budget_150_200:"150–200",
    budget_200_250:"200–250",
    budget_250_300:"250–300",
    budget_300_500:"300–500",
    budget_500plus:"Au-delà de 500",
    budget_cancel:"Annuler",
    pace_title:"Rythme :",
    pace_fast:"Rapide",
    pace_normal:"Normal",
    pace_slow:"Tranquille",
    modal_title:"Configurez votre voyage",
    modal_departure_date:"Date de départ :",
    modal_num_days:"Nombre de jours souhaités :",
    modal_max_hotels:"Changements d'hôtel maximum :",
    modal_budget_label:"Budget hôtel (€/jour/personne) :",
    filterAllDays:"Tous",
    filterAllDistances:"Toutes",
    filterAllCountries:"Tous",
    filterAllRegions:"Toutes",
    filterAllThemes:"Tous",
    searchPlaceholder:"Mot-clé...",
    // Options de filtres
    filter_days_1_3:"1-3 jours",
    filter_days_4_7:"4-7 jours",
    filter_days_8_14:"8-14 jours",
    filter_days_15plus:"15+ jours",
    filter_dist_0_500:"0-500 km",
    filter_dist_501_1000:"501-1000 km",
    filter_dist_1001_2000:"1001-2000 km",
    filter_dist_2001plus:"2001+ km",
  filter_theme_montagne:"Montagne",
filter_theme_mer_cotes:"Mer & Côtes",
filter_theme_ville_histoire:"Ville & Histoire",
filter_theme_nature:"Nature",
filter_theme_culture:"Culture",
filter_theme_gastronomie_vin:"Gastronomie & Vin",
filter_theme_aventure_outdoor:"Aventure & Outdoor",
filter_theme_route_exploration:"Route & Exploration",
filter_theme_insolite_hors_sentiers:"Insolite & Hors sentiers battus",
filter_theme_faune_vie_sauvage:"Faune & Vie sauvage",
filter_theme_spiritualite_religion:"Spiritualité & Religion",
filter_theme_bien_etre_detente:"Bien-être & Détente",
filter_theme_detente:"Détente",
filter_theme_tested_ort:"Testé & approuvé ORT",
  },

  en: {
    notice: "Without registration, your trips won't be saved",
    title: "OneRoadTrip – Design Your Dream Journey",
    
    // Expert Mode: Build from Scratch
    builder_title: "Build Your Itinerary from A to Z",
    builder_text: "Start from scratch and create your trip step by step by selecting places on an interactive world map.",
    builder_btn: "Start Building",
    
    left_title: "Build Your Trip in 5 Simple Questions",
    left_list: [
      "Which destination calls to you?",
      "How many days is your adventure?",
      "What's your travel style: adventure, relaxation, culture?",
      "How will you get around locally?",
      "What's your approximate budget?"
    ],
    btn_simple: "Start Building Now",
    
right_title: "Find an itinerary or list of places on the web that inspires you and build your dream trip",
creators_title: "View itineraries proposed by content creators",
become_creator: "Become a creator",
right_lead: "",
right_list: [
  "Copy the itinerary* that inspires you from any website",
  "Use an AI assistant to optimize it following our instructions (ChatGPT, Claude...)",
  "Paste the result into our interface",
  "Instantly get a 100% editable and customizable trip"
],
right_note: "*Important: Make sure the copied content is copyright-free",
    btn_full: "Import a Trip",
    
    bottom_title: "Your Complete Travel Package Includes",
    bottom_list: [
      "Day-by-day detailed itinerary with optimized travel times",
      "Interactive map with all your geolocated destinations",
      "Unlimited real-time modifications to your route",
      "Direct booking for flights and car rentals",
      "Access to top-rated accommodations via our partners",
      "Booking for unique activities and experiences",
      "Comprehensive travel insurance options"
    ],
    
    stage_hdr: "Each destination in your journey features:",
    stage_1: "Optimized daily schedule with suggested times",
    stage_2: "Must-see attractions plus your personal additions",
    stage_3: "Detailed map with optimized visit route",
    stage_4: "Curated accommodation selection for your budget",
    
    doc_line: "Export to PDF or PowerPoint • Offline mobile access • Easy sharing with travel companions",
    support: "OneRoadTrip is 100% free. Bookings through our partner links help us keep it that way—at no extra cost to you. Thank you!",
    
    login: "Sign In",
    badge_mode_simple: "Simple Mode",
    badge_mode_expert: "Expert Mode",
    cookie_text: "We use essential cookies for authentication. Optional cookies are off by default.",
    cookie_opt_a: "Usage Analytics",
    cookie_opt_m: "Targeted Marketing",
    cookie_btn_p: "Customize",
    cookie_btn_r: "Reject All",
    cookie_btn_a: "Accept All",
    pricing_show: "View detailed pricing",
    pricing_hide: "Hide pricing",
    mapTitle:"Choose your itinerary on a map",
    buildTitle:"Build your itinerary from A to Z",
    importTitle:"Find an itinerary on the web that inspires you",
    creatorsTitle:"Itineraries from creators",
    becomeCreator:"Become a creator",
    routeBuilderTitle:"🚗 Let us build your itinerary",
    labelStartCity:"Departure city",
    labelEndCity:"Arrival city",
    labelMaxKm:"Km/stop",
    labelDuration:"Duration",
    generateBtn:"🚀 Generate my itinerary",
    labelDetour:"Allowed detour",
    labelDaysUnit:"days",
    warnCityNotSelected:"⚠️ City not validated - result may be inaccurate",
    generatingBtn:"⏳ Calculating...",
    placeholderStart:"Paris, London...",
    placeholderEnd:"Barcelona, Rome...",
    days:"days",
    mapClickToOpen:"Click to open interactive map",
    filterTitle:"Filters",
    filtersBtnText:"🔍 Filters",
    labelDays:"Duration:",
    labelDistance:"Distance:",
    labelCountry:"Country:",
    labelRegion:"Region:",
    labelTheme:"Theme:",
    labelSearch:"Search:",
    btnReset:"Reset",
    filterCount_single:"itinerary found",
    filterCount_plural:"itineraries found",
    popupDays:"days",
    popupViewDetails:"View details",
    selectionTitle:"Selection (max 3)",
    selectionTitleSimple:"Selection (max 1)",
    selectionTitleExpert:"Selection (max 3)",
    compareBtn:"View itinerary",
    alertAlreadySelected:"Already selected",
    alertMaxSelection:"Maximum 3 itineraries",
    alertMaxSelectionSimple:"Maximum 1 itinerary in simple mode",
    selectBtnText:"Select",
    mobileSelectText:"Select",
    mobileCancelText:"Cancel",
    mobileDays:"days",
    mobileStops:"stops",
    mobileCities:"Cities:",
    closeBtnText:"Close",
    backBtnText:"Back",
    homeBtnText:"← Back",
    legend_title:"Itineraries",
    legend_incontournable:"Must-see",
    legend_recommande:"Recommended",
    legend_decouvrir:"Discover",
    legend_standard:"Standard",
    legend_selected:"Selected",
    visible_itins_single:"visible itinerary",
    visible_itins_plural:"visible itineraries",
    budget_modal_title:"Hotel Budget",
    budget_modal_text:"Select one or more ranges (€/day/person):",
    budget_confirm:"Validate",
    budget_cancel:"Cancel",
    budget_0_50:"0–50",
    budget_50_100:"50–100",
    budget_100_150:"100–150",
    budget_150_200:"150–200",
    budget_200_250:"200–250",
    budget_250_300:"250–300",
    budget_300_500:"300–500",
    budget_500plus:"500+",
    pace_title:"Pace:",
    pace_fast:"Fast",
    pace_normal:"Normal",
    pace_slow:"Relaxed",
    modal_title:"Configure your trip",
    modal_departure_date:"Departure date:",
    modal_num_days:"Number of days:",
    modal_max_hotels:"Maximum hotel changes:",
    modal_budget_label:"Hotel budget (€/day/person):",
    filterAllDays:"All",
    filterAllDistances:"All",
    filterAllCountries:"All",
    filterAllRegions:"All",
    filterAllThemes:"All",
    searchPlaceholder:"Keyword...",
    // Filter options
    filter_days_1_3:"1-3 days",
    filter_days_4_7:"4-7 days",
    filter_days_8_14:"8-14 days",
    filter_days_15plus:"15+ days",
    filter_dist_0_500:"0-500 km",
    filter_dist_501_1000:"501-1000 km",
    filter_dist_1001_2000:"1001-2000 km",
    filter_dist_2001plus:"2001+ km",
 filter_theme_montagne:"Mountain",
filter_theme_mer_cotes:"Sea & Coasts",
filter_theme_ville_histoire:"City & History",
filter_theme_nature:"Nature",
filter_theme_culture:"Culture",
filter_theme_gastronomie_vin:"Food & Wine",
filter_theme_aventure_outdoor:"Adventure & Outdoor",
filter_theme_route_exploration:"Road & Exploration",
filter_theme_insolite_hors_sentiers:"Unusual & Offbeat",
filter_theme_faune_vie_sauvage:"Wildlife",
filter_theme_spiritualite_religion:"Spirituality & Religion",
filter_theme_bien_etre_detente:"Wellness & Relax",
filter_theme_detente:"Relax",
filter_theme_tested_ort:"ORT tested & approved",
  },

  it: {
    notice: "Senza registrazione, i tuoi viaggi non verranno salvati",
    title: "OneRoadTrip – Progetta il Viaggio dei Tuoi Sogni",
    
    // Modalità Esperto: Costruisci da Zero
    builder_title: "Costruisci il Tuo Itinerario da A a Z",
    builder_text: "Parti da zero e crea il tuo viaggio passo dopo passo selezionando luoghi su una mappa interattiva del mondo.",
    builder_btn: "Inizia a Costruire",
    
    left_title: "Crea il Tuo Viaggio in 5 Semplici Domande",
    left_list: [
      "Quale destinazione ti attira?",
      "Quanti giorni dura la tua avventura?",
      "Qual è il tuo stile di viaggio: avventura, relax, cultura?",
      "Come ti sposterai sul posto?",
      "Qual è il tuo budget approssimativo?"
    ],
    btn_simple: "Inizia Subito",
    
 right_title: "Trova sul web un itinerario o una lista di luoghi che ti ispira e costruisci il viaggio dei tuoi sogni",
creators_title: "Visualizza itinerari proposti da creatori di contenuti",
become_creator: "Diventa creatore",
right_lead: "",
right_list: [
  "Copia l'itinerario* che ti ispira da qualsiasi sito web",
  "Usa un assistente IA per ottimizzarlo seguendo le nostre istruzioni (ChatGPT, Claude...)",
  "Incolla il risultato nella nostra interfaccia",
  "Ottieni subito un viaggio 100% modificabile e personalizzabile"
],
right_note: "*Importante: Assicurati che il contenuto copiato sia libero da copyright",

    btn_full: "Importa un Viaggio",
    
    bottom_title: "Il Tuo Pacchetto Viaggio Completo Include",
    bottom_list: [
      "Itinerario dettagliato giorno per giorno con tempi di percorrenza ottimizzati",
      "Mappa interattiva con tutte le tue tappe geolocalizzate",
      "Modifiche illimitate del percorso in tempo reale",
      "Prenotazione diretta di voli e noleggio auto",
      "Accesso ai migliori alloggi tramite i nostri partner",
      "Prenotazione di attività ed esperienze uniche",
      "Opzioni complete di assicurazione viaggio"
    ],
    
    stage_hdr: "Ogni tappa del tuo viaggio include:",
    stage_1: "Programma giornaliero ottimizzato con orari suggeriti",
    stage_2: "Attrazioni imperdibili più le tue aggiunte personali",
    stage_3: "Mappa dettagliata con percorso di visita ottimizzato",
    stage_4: "Selezione di alloggi adatti al tuo budget",
    
    doc_line: "Esporta in PDF o PowerPoint • Accesso mobile offline • Condivisione facile con i compagni di viaggio",
    support: "OneRoadTrip è 100% gratuito. Le prenotazioni tramite i nostri link partner ci aiutano a mantenerlo così—senza costi extra per te. Grazie!",
    
    login: "Accedi",
    badge_mode_simple: "Modalità Semplice",
    badge_mode_expert: "Modalità Esperto",
    cookie_text: "Usiamo cookie essenziali per l'autenticazione. I cookie opzionali sono disattivati di default.",
    cookie_opt_a: "Statistiche di utilizzo",
    cookie_opt_m: "Marketing mirato",
    cookie_btn_p: "Personalizza",
    cookie_btn_r: "Rifiuta Tutto",
    cookie_btn_a: "Accetta Tutto",
    pricing_show: "Visualizza tariffe dettagliate",
    pricing_hide: "Nascondi tariffe",
    mapTitle:"Scegli il tuo itinerario su una mappa",
    buildTitle:"Costruisci il tuo itinerario dalla A alla Z",
    importTitle:"Trova sul web un itinerario che ti ispira",
    creatorsTitle:"Itinerari dei creatori",
    becomeCreator:"Diventa creatore",
    routeBuilderTitle:"🚗 Lasciaci costruire il tuo itinerario",
    labelStartCity:"Città di partenza",
    labelEndCity:"Città di arrivo",
    labelMaxKm:"Km/tappa",
    labelDuration:"Durata",
    generateBtn:"🚀 Genera il mio itinerario",
    labelDetour:"Deviazione autorizzata",
    labelDaysUnit:"giorni",
    warnCityNotSelected:"⚠️ Città non convalidata - risultato potrebbe essere impreciso",
    generatingBtn:"⏳ Calcolo in corso...",
    placeholderStart:"Roma, Milano...",
    placeholderEnd:"Barcellona, Parigi...",
    days:"giorni",
    mapClickToOpen:"Clicca per aprire la mappa interattiva",
    filterTitle:"Filtri",
    filtersBtnText:"🔍 Filtri",
    labelDays:"Durata:",
    labelDistance:"Distanza:",
    labelCountry:"Paese:",
    labelRegion:"Regione:",
    labelTheme:"Tema:",
    labelSearch:"Ricerca:",
    btnReset:"Ripristina",
    filterCount_single:"itinerario trovato",
    filterCount_plural:"itinerari trovati",
    popupDays:"giorni",
    popupViewDetails:"Vedi dettagli",
    selectionTitle:"Selezione (max 3)",
    selectionTitleSimple:"Selezione (max 1)",
    selectionTitleExpert:"Selezione (max 3)",
    compareBtn:"Vedi itinerario",
    alertAlreadySelected:"Già selezionato",
    alertMaxSelection:"Massimo 3 itinerari",
    alertMaxSelectionSimple:"Massimo 1 itinerario in modalità semplice",
    selectBtnText:"Seleziona",
    mobileSelectText:"Seleziona",
    mobileCancelText:"Annulla",
    mobileDays:"giorni",
    mobileStops:"tappe",
    mobileCities:"Città:",
    closeBtnText:"Chiudi",
    backBtnText:"Indietro",
    homeBtnText:"← Indietro",
    legend_title:"Itinerari",
    legend_incontournable:"Imperdibile",
    legend_recommande:"Consigliato",
    legend_decouvrir:"Da scoprire",
    legend_standard:"Standard",
    legend_selected:"Selezionato",
    visible_itins_single:"itinerario visibile",
    visible_itins_plural:"itinerari visibili",
    budget_modal_title:"Budget hotel",
    budget_modal_text:"Seleziona una o più fasce (€/giorno/persona):",
    budget_confirm:"Conferma",
    budget_cancel:"Annulla",
    budget_0_50:"0–50",
    budget_50_100:"50–100",
    budget_100_150:"100–150",
    budget_150_200:"150–200",
    budget_200_250:"200–250",
    budget_250_300:"250–300",
    budget_300_500:"300–500",
    budget_500plus:"oltre 500",
    pace_title:"Ritmo:",
    pace_fast:"Veloce",
    pace_normal:"Normale",
    pace_slow:"Rilassato",
    modal_title:"Configura il tuo viaggio",
    modal_departure_date:"Data di partenza:",
    modal_num_days:"Numero di giorni:",
    modal_max_hotels:"Cambi hotel massimi:",
    modal_budget_label:"Budget hotel (€/giorno/persona):",
    filterAllDays:"Tutti",
    filterAllDistances:"Tutte",
    filterAllCountries:"Tutti",
    filterAllRegions:"Tutte",
    filterAllThemes:"Tutti",
    searchPlaceholder:"Parola chiave...",
    // Opzioni filtri
    filter_days_1_3:"1-3 giorni",
    filter_days_4_7:"4-7 giorni",
    filter_days_8_14:"8-14 giorni",
    filter_days_15plus:"15+ giorni",
    filter_dist_0_500:"0-500 km",
    filter_dist_501_1000:"501-1000 km",
    filter_dist_1001_2000:"1001-2000 km",
    filter_dist_2001plus:"2001+ km",
 filter_theme_montagne:"Montagna",
filter_theme_mer_cotes:"Mare & Coste",
filter_theme_ville_histoire:"Città & Storia",
filter_theme_nature:"Natura",
filter_theme_culture:"Cultura",
filter_theme_gastronomie_vin:"Gastronomia & Vino",
filter_theme_aventure_outdoor:"Avventura & Outdoor",
filter_theme_route_exploration:"Strada & Esplorazione",
filter_theme_insolite_hors_sentiers:"Insolito & Fuori pista",
filter_theme_faune_vie_sauvage:"Fauna selvatica",
filter_theme_spiritualite_religion:"Spiritualità & Religione",
filter_theme_bien_etre_detente:"Benessere & Relax",
filter_theme_detente:"Relax",
filter_theme_tested_ort:"Verificato & approvato da ORT",

  },

  es: {
    notice: "Sin registro, tus viajes no se guardarán",
    title: "OneRoadTrip – Diseña el Viaje de tus Sueños",
    
    // Modo Experto: Construye desde Cero
    builder_title: "Construye tu Itinerario de A a Z",
    builder_text: "Empieza desde cero y crea tu viaje paso a paso seleccionando lugares en un mapa interactivo del mundo.",
    builder_btn: "Comenzar a Construir",
    
    left_title: "Crea tu Viaje en 5 Preguntas Simples",
    left_list: [
      "¿Qué destino te llama?",
      "¿Cuántos días dura tu aventura?",
      "¿Cuál es tu estilo de viaje: aventura, relajación, cultura?",
      "¿Cómo te desplazarás localmente?",
      "¿Cuál es tu presupuesto aproximado?"
    ],
    btn_simple: "Empezar Ahora",
right_title: "Encuentra en la web un itinerario o una lista de lugares que te inspire y construye el viaje de tus sueños",
creators_title: "Ver itinerarios propuestos por creadores de contenido",
become_creator: "Convertirse en creador",
right_lead: "",
right_list: [
  "Copia el itinerario* que te inspire desde cualquier sitio web",
  "Usa un asistente de IA para optimizarlo siguiendo nuestras instrucciones (ChatGPT, Claude...)",
  "Pega el resultado en nuestra interfaz",
  "Obtén al instante un viaje 100% modificable y personalizable"
],
right_note: "*Importante: Asegúrate de que el contenido copiado esté libre de derechos",
    btn_full: "Importar un Viaje",
    
    bottom_title: "Tu Paquete de Viaje Completo Incluye",
    bottom_list: [
      "Itinerario detallado día a día con tiempos de viaje optimizados",
      "Mapa interactivo con todos tus destinos geolocalizados",
      "Modificaciones ilimitadas de tu ruta en tiempo real",
      "Reserva directa de vuelos y alquiler de coches",
      "Acceso a los mejores alojamientos a través de nuestros socios",
      "Reserva de actividades y experiencias únicas",
      "Opciones completas de seguro de viaje"
    ],
    
    stage_hdr: "Cada destino de tu viaje incluye:",
    stage_1: "Horario diario optimizado con horas sugeridas",
    stage_2: "Atracciones imprescindibles más tus adiciones personales",
    stage_3: "Mapa detallado con ruta de visita optimizada",
    stage_4: "Selección de alojamientos adaptados a tu presupuesto",
    
    doc_line: "Exporta a PDF o PowerPoint • Acceso móvil sin conexión • Compartir fácilmente con compañeros de viaje",
    support: "OneRoadTrip es 100% gratuito. Las reservas a través de nuestros enlaces afiliados nos ayudan a mantenerlo así—sin coste extra para ti. ¡Gracias!",
    
    login: "Iniciar Sesión",
    badge_mode_simple: "Modo Simple",
    badge_mode_expert: "Modo Experto",
    cookie_text: "Usamos cookies esenciales para la autenticación. Las cookies opcionales están desactivadas por defecto.",
    cookie_opt_a: "Estadísticas de uso",
    cookie_opt_m: "Marketing dirigido",
    cookie_btn_p: "Personalizar",
    cookie_btn_r: "Rechazar Todo",
    cookie_btn_a: "Aceptar Todo",
    pricing_show: "Ver tarifas detalladas",
    pricing_hide: "Ocultar tarifas",
    mapTitle:"Elige tu itinerario en un mapa",
    buildTitle:"Construye tu itinerario de la A a la Z",
    importTitle:"Encuentra en la web un itinerario que te inspire",
    creatorsTitle:"Itinerarios de los creadores",
    becomeCreator:"Ser creador",
    routeBuilderTitle:"🚗 Déjanos construir tu itinerario",
    labelStartCity:"Ciudad de salida",
    labelEndCity:"Ciudad de llegada",
    labelMaxKm:"Km/etapa",
    labelDuration:"Duración",
    generateBtn:"🚀 Generar mi itinerario",
    labelDetour:"Desvío permitido",
    labelDaysUnit:"días",
    warnCityNotSelected:"⚠️ Ciudad no validada - resultado puede ser inexacto",
    generatingBtn:"⏳ Calculando...",
    placeholderStart:"Madrid, Barcelona...",
    placeholderEnd:"París, Roma...",
    days:"días",
    mapClickToOpen:"Haz clic para abrir el mapa interactivo",
    filterTitle:"Filtros",
    filtersBtnText:"🔍 Filtros",
    labelDays:"Duración:",
    labelDistance:"Distancia:",
    labelCountry:"País:",
    labelRegion:"Región:",
    labelTheme:"Tema:",
    labelSearch:"Búsqueda:",
    btnReset:"Restablecer",
    filterCount_single:"itinerario encontrado",
    filterCount_plural:"itinerarios encontrados",
    popupDays:"días",
    popupViewDetails:"Ver detalles",
    selectionTitle:"Selección (máx 3)",
    selectionTitleSimple:"Selección (máx 1)",
    selectionTitleExpert:"Selección (máx 3)",
    compareBtn:"Ver itinerario",
    alertAlreadySelected:"Ya seleccionado",
    alertMaxSelection:"Máximo 3 itinerarios",
    alertMaxSelectionSimple:"Máximo 1 itinerario en modo simple",
    selectBtnText:"Seleccionar",
    mobileSelectText:"Seleccionar",
    mobileCancelText:"Cancelar",
    mobileDays:"días",
    mobileStops:"etapas",
    mobileCities:"Ciudades:",
    closeBtnText:"Cerrar",
    backBtnText:"Volver",
    homeBtnText:"← Volver",
    legend_title:"Itinerarios",
    legend_incontournable:"Imprescindible",
    legend_recommande:"Recomendado",
    legend_decouvrir:"Por descubrir",
    legend_standard:"Estándar",
    legend_selected:"Seleccionado",
    visible_itins_single:"itinerario visible",
    visible_itins_plural:"itinerarios visibles",
    budget_modal_title:"Presupuesto hotel",
    budget_modal_text:"Selecciona uno o varios rangos (€/día/persona):",
    budget_confirm:"Validar",
    budget_cancel:"Cancelar",
    budget_0_50:"0–50",
    budget_50_100:"50–100",
    budget_100_150:"100–150",
    budget_150_200:"150–200",
    budget_200_250:"200–250",
    budget_250_300:"250–300",
    budget_300_500:"300–500",
    budget_500plus:"más de 500",
    pace_title:"Ritmo:",
    pace_fast:"Rápido",
    pace_normal:"Normal",
    pace_slow:"Tranquilo",
    modal_title:"Configura tu viaje",
    modal_departure_date:"Fecha de salida:",
    modal_num_days:"Número de días deseados:",
    modal_max_hotels:"Cambios de hotel máximos:",
    modal_budget_label:"Presupuesto hotel (€/día/persona):",
    filterAllDays:"Todos",
    filterAllDistances:"Todas",
    filterAllCountries:"Todos",
    filterAllRegions:"Todas",
    filterAllThemes:"Todos",
    searchPlaceholder:"Palabra clave...",
    // Opciones de filtros
    filter_days_1_3:"1-3 días",
    filter_days_4_7:"4-7 días",
    filter_days_8_14:"8-14 días",
    filter_days_15plus:"15+ días",
    filter_dist_0_500:"0-500 km",
    filter_dist_501_1000:"501-1000 km",
    filter_dist_1001_2000:"1001-2000 km",
    filter_dist_2001plus:"2001+ km",
   filter_theme_montagne:"Montaña",
filter_theme_mer_cotes:"Mar & Costas",
filter_theme_ville_histoire:"Ciudad & Historia",
filter_theme_nature:"Naturaleza",
filter_theme_culture:"Cultura",
filter_theme_gastronomie_vin:"Gastronomía & Vino",
filter_theme_aventure_outdoor:"Aventura & Outdoor",
filter_theme_route_exploration:"Ruta & Exploración",
filter_theme_insolite_hors_sentiers:"Insólito & Alternativo",
filter_theme_faune_vie_sauvage:"Fauna & Vida salvaje",
filter_theme_spiritualite_religion:"Espiritualidad & Religión",
filter_theme_bien_etre_detente:"Bienestar & Relajación",
filter_theme_detente:"Relajación",
filter_theme_tested_ort:"Probado y aprobado por ORT",

  },

  pt: {
    notice: "Sem registo, as tuas viagens não serão guardadas",
    title: "OneRoadTrip – Cria a Viagem dos Teus Sonhos",
    
    // Modo Expert: Constrói do Zero
    builder_title: "Constrói o Teu Itinerário de A a Z",
    builder_text: "Começa do zero e cria a tua viagem passo a passo selecionando lugares num mapa interativo do mundo.",
    builder_btn: "Começar a Construir",
    
    left_title: "Cria a Tua Viagem em 5 Perguntas Simples",
    left_list: [
      "Que destino te chama?",
      "Quantos dias dura a tua aventura?",
      "Qual é o teu estilo de viagem: aventura, relaxamento, cultura?",
      "Como vais deslocar-te localmente?",
      "Qual é o teu orçamento aproximado?"
    ],
    btn_simple: "Começar Agora",
    
right_title: "Encontra na web um itinerário ou uma lista de locais que te inspire e constrói a viagem dos teus sonhos",
creators_title: "Ver itinerários propostos por criadores de conteúdo",
become_creator: "Tornar-se criador",
right_lead: "",
right_list: [
  "Copia o itinerário* que te inspira de qualquer site",
  "Usa um assistente de IA para o otimizar de acordo com as nossas instruções (ChatGPT, Claude...)",
  "Cola o resultado na nossa interface",
  "Obtém imediatamente uma viagem 100% modificável e personalizável"
],
right_note: "*Importante: Garante que o conteúdo copiado está livre de direitos de autor",
    btn_full: "Importar uma Viagem",
    
    bottom_title: "O Teu Pacote de Viagem Completo Inclui",
    bottom_list: [
      "Itinerário detalhado dia a dia com tempos de viagem otimizados",
      "Mapa interativo com todos os destinos geolocalizados",
      "Modificações ilimitadas do percurso em tempo real",
      "Reserva direta de voos e aluguer de carros",
      "Acesso aos melhores alojamentos através dos nossos parceiros",
      "Reserva de atividades e experiências únicas",
      "Opções completas de seguro de viagem"
    ],
    
    stage_hdr: "Cada destino da tua viagem inclui:",
    stage_1: "Agenda diária otimizada com horários sugeridos",
    stage_2: "Atrações imperdíveis mais as tuas adições pessoais",
    stage_3: "Mapa detalhado com rota de visita otimizada",
    stage_4: "Seleção de alojamentos adequados ao teu orçamento",
    
    doc_line: "Exporta para PDF ou PowerPoint • Acesso móvel offline • Partilha fácil com companheiros de viagem",
    support: "O OneRoadTrip é 100% gratuito. As reservas através dos nossos links parceiros ajudam-nos a mantê-lo assim—sem custo extra para ti. Obrigado!",
    
    login: "Iniciar Sessão",
    badge_mode_simple: "Modo Simples",
    badge_mode_expert: "Modo Expert",
    cookie_text: "Usamos cookies essenciais para autenticação. Os cookies opcionais estão desativados por defeito.",
    cookie_opt_a: "Estatísticas de uso",
    cookie_opt_m: "Marketing direcionado",
    cookie_btn_p: "Personalizar",
    cookie_btn_r: "Rejeitar Tudo",
    cookie_btn_a: "Aceitar Tudo",
    pricing_show: "Ver preços detalhados",
    pricing_hide: "Ocultar preços",
    mapTitle:"Escolha seu itinerário em um mapa",
    buildTitle:"Construa seu itinerário de A a Z",
    importTitle:"Encontre na web um itinerário que te inspire",
    creatorsTitle:"Itinerários dos criadores",
    becomeCreator:"Tornar-se criador",
    routeBuilderTitle:"🚗 Deixe-nos construir seu itinerário",
    labelStartCity:"Cidade de partida",
    labelEndCity:"Cidade de chegada",
    labelMaxKm:"Km/etapa",
    labelDuration:"Duração",
    generateBtn:"🚀 Gerar meu itinerário",
    labelDetour:"Desvio permitido",
    labelDaysUnit:"dias",
    warnCityNotSelected:"⚠️ Cidade não validada - resultado pode ser impreciso",
    generatingBtn:"⏳ Calculando...",
    placeholderStart:"Lisboa, Porto...",
    placeholderEnd:"Barcelona, Paris...",
    days:"dias",
    mapClickToOpen:"Clique para abrir o mapa interativo",
    filterTitle:"Filtros",
    filtersBtnText:"🔍 Filtros",
    labelDays:"Duração:",
    labelDistance:"Distância:",
    labelCountry:"País:",
    labelRegion:"Região:",
    labelTheme:"Tema:",
    labelSearch:"Pesquisa:",
    btnReset:"Redefinir",
    filterCount_single:"itinerário encontrado",
    filterCount_plural:"itinerários encontrados",
    popupDays:"dias",
    popupViewDetails:"Ver detalhes",
    selectionTitle:"Seleção (máx 3)",
    selectionTitleSimple:"Seleção (máx 1)",
    selectionTitleExpert:"Seleção (máx 3)",
    compareBtn:"Ver itinerário",
    alertAlreadySelected:"Já selecionado",
    alertMaxSelection:"Máximo 3 itinerários",
    alertMaxSelectionSimple:"Máximo 1 itinerário em modo simples",
    selectBtnText:"Selecionar",
    mobileSelectText:"Selecionar",
    mobileCancelText:"Cancelar",
    mobileDays:"dias",
    mobileStops:"etapas",
    mobileCities:"Cidades:",
    closeBtnText:"Fechar",
    backBtnText:"Voltar",
    homeBtnText:"← Voltar",
    legend_title:"Itinerários",
    legend_incontournable:"Imperdível",
    legend_recommande:"Recomendado",
    legend_decouvrir:"A descobrir",
    legend_standard:"Padrão",
    legend_selected:"Selecionado",
    visible_itins_single:"itinerário visível",
    visible_itins_plural:"itinerários visíveis",
    budget_modal_title:"Orçamento hotel",
    budget_modal_text:"Selecione uma ou várias faixas (€/dia/pessoa):",
    budget_confirm:"Validar",
    budget_cancel:"Cancelar",
    budget_0_50:"0–50",
    budget_50_100:"50–100",
    budget_100_150:"100–150",
    budget_150_200:"150–200",
    budget_200_250:"200–250",
    budget_250_300:"250–300",
    budget_300_500:"300–500",
    budget_500plus:"+500",
    pace_title:"Ritmo:",
    pace_fast:"Rápido",
    pace_normal:"Normal",
    pace_slow:"Relaxado",
    modal_title:"Configure a sua viagem",
    modal_departure_date:"Data de partida:",
    modal_num_days:"Número de dias:",
    modal_max_hotels:"Mudanças de hotel máximas:",
    modal_budget_label:"Orçamento hotel (€/dia/pessoa):",
    filterAllDays:"Todos",
    filterAllDistances:"Todas",
    filterAllCountries:"Todos",
    filterAllRegions:"Todas",
    filterAllThemes:"Todos",
    searchPlaceholder:"Palavra-chave...",
    // Opções de filtros
    filter_days_1_3:"1-3 dias",
    filter_days_4_7:"4-7 dias",
    filter_days_8_14:"8-14 dias",
    filter_days_15plus:"15+ dias",
    filter_dist_0_500:"0-500 km",
    filter_dist_501_1000:"501-1000 km",
    filter_dist_1001_2000:"1001-2000 km",
    filter_dist_2001plus:"2001+ km",
   filter_theme_montagne:"Montanha",
filter_theme_mer_cotes:"Mar & Costas",
filter_theme_ville_histoire:"Cidade & História",
filter_theme_nature:"Natureza",
filter_theme_culture:"Cultura",
filter_theme_gastronomie_vin:"Gastronomia & Vinho",
filter_theme_aventure_outdoor:"Aventura & Outdoor",
filter_theme_route_exploration:"Estrada & Exploração",
filter_theme_insolite_hors_sentiers:"Insólito & Alternativo",
filter_theme_faune_vie_sauvage:"Vida selvagem",
filter_theme_spiritualite_religion:"Espiritualidade & Religião",
filter_theme_bien_etre_detente:"Bem-estar & Relax",
filter_theme_detente:"Relax",
filter_theme_tested_ort:"Testado e aprovado pela ORT",

  },

  ar: {
    notice: "بدون تسجيل، لن يتم حفظ رحلاتك",
    title: "OneRoadTrip – صمم رحلة أحلامك",
    
    // الوضع الخبير: ابنِ من الصفر
    builder_title: "ابنِ مسارك من الألف إلى الياء",
    builder_text: "ابدأ من الصفر وأنشئ رحلتك خطوة بخطوة عبر اختيار الأماكن على خريطة تفاعلية للعالم.",
    builder_btn: "ابدأ البناء",
    
    left_title: "أنشئ رحلتك في 5 أسئلة بسيطة",
    left_list: [
      "أي وجهة تناديك؟",
      "كم يوماً تستمر مغامرتك؟",
      "ما هو أسلوب سفرك: المغامرة، الاسترخاء، الثقافة؟",
      "كيف ستتنقل محلياً؟",
      "ما هي ميزانيتك التقريبية؟"
    ],
    btn_simple: "ابدأ الآن",
    
  right_title: "ابحث على الإنترنت عن مسار أو قائمة أماكن تلهمك وابنِ رحلة أحلامك",
creators_title: "عرض مسارات مقترحة من منشئي المحتوى",
become_creator: "أصبح منشئ محتوى",
right_lead: "",
right_list: [
  "انسخ خط السير* الذي يلهمك من أي موقع ويب",
  "استخدم مساعد ذكاء اصطناعي لتحسينه وفقًا لتعليماتنا (ChatGPT، Claude...)",
  "الصق النتيجة في واجهتنا",
  "احصل فورًا على رحلة قابلة للتعديل والتخصيص بنسبة 100٪"
],
right_note: "*مهم: تأكد من أن المحتوى المنسوخ خالٍ من حقوق الطبع والنشر",

    btn_full: "استورد رحلة",
    
    bottom_title: "باقة رحلتك الكاملة تشمل",
    bottom_list: [
      "خط سير مفصل يومياً مع أوقات السفر المُحسّنة",
      "خريطة تفاعلية مع جميع وجهاتك المحددة جغرافياً",
      "تعديلات غير محدودة على مسارك في الوقت الفعلي",
      "حجز مباشر للرحلات الجوية واستئجار السيارات",
      "الوصول إلى أفضل أماكن الإقامة عبر شركائنا",
      "حجز الأنشطة والتجارب الفريدة",
      "خيارات تأمين سفر شاملة"
    ],
    
    stage_hdr: "كل وجهة في رحلتك تتضمن:",
    stage_1: "جدول يومي محسّن مع أوقات مقترحة",
    stage_2: "معالم لا تُفوّت بالإضافة إلى إضافاتك الشخصية",
    stage_3: "خريطة مفصلة مع مسار زيارة محسّن",
    stage_4: "مجموعة مختارة من أماكن الإقامة المناسبة لميزانيتك",
    
    doc_line: "تصدير إلى PDF أو PowerPoint • وصول محمول بلا إنترنت • مشاركة سهلة مع رفاق السفر",
    support: "OneRoadTrip مجاني 100٪. الحجوزات عبر روابط شركائنا تساعدنا في الحفاظ عليه كذلك—بدون تكلفة إضافية عليك. شكراً!",
    
    login: "تسجيل الدخول",
    badge_mode_simple: "الوضع البسيط",
    badge_mode_expert: "وضع الخبير",
    cookie_text: "نستخدم ملفات تعريف الارتباط الأساسية للمصادقة. ملفات تعريف الارتباط الاختيارية معطلة افتراضياً.",
    cookie_opt_a: "إحصاءات الاستخدام",
    cookie_opt_m: "التسويق الموجه",
    cookie_btn_p: "تخصيص",
    cookie_btn_r: "رفض الكل",
    cookie_btn_a: "قبول الكل",
    pricing_show: "عرض الأسعار التفصيلية",
    pricing_hide: "إخفاء الأسعار",
    mapTitle:"اختر خط سيرك على الخريطة",
    buildTitle:"قم ببناء خط سيرك من الألف إلى الياء",
    importTitle:"ابحث على الويب عن خط سير يلهمك",
    creatorsTitle:"خطوط سير المبدعين",
    becomeCreator:"كن مبدعًا",
    routeBuilderTitle:"🚗 دعنا نبني خط سيرك",
    labelStartCity:"مدينة الانطلاق",
    labelEndCity:"مدينة الوصول",
    labelMaxKm:"كم/محطة",
    labelDuration:"المدة",
    generateBtn:"🚀 إنشاء خط سيري",
    labelDetour:"انحراف مسموح",
    labelDaysUnit:"أيام",
    warnCityNotSelected:"⚠️ المدينة غير مؤكدة - قد تكون النتيجة غير دقيقة",
    generatingBtn:"⏳ جاري الحساب...",
    placeholderStart:"باريس، لندن...",
    placeholderEnd:"برشلونة، روما...",
    days:"أيام",
    mapClickToOpen:"انقر لفتح الخريطة التفاعلية",
    filterTitle:"الفلاتر",
    filtersBtnText:"🔍 الفلاتر",
    labelDays:"المدة:",
    labelDistance:"المسافة:",
    labelCountry:"البلد:",
    labelRegion:"المنطقة:",
    labelTheme:"الموضوع:",
    labelSearch:"البحث:",
    btnReset:"إعادة تعيين",
    filterCount_single:"تم العثور على خط سير",
    filterCount_plural:"تم العثور على خطوط سير",
    popupDays:"أيام",
    popupViewDetails:"عرض التفاصيل",
    selectionTitle:"الاختيار (بحد أقصى 3)",
    selectionTitleSimple:"الاختيار (بحد أقصى 1)",
    selectionTitleExpert:"الاختيار (بحد أقصى 3)",
    compareBtn:"عرض المسار",
    alertAlreadySelected:"تم اختياره بالفعل",
    alertMaxSelection:"بحد أقصى 3 خطوط سير",
    alertMaxSelectionSimple:"بحد أقصى مسار واحد في الوضع البسيط",
    alertMaxSelection:"بحد أقصى 3 خطوط سير",
    selectBtnText:"اختر",
    mobileSelectText:"اختر",
    mobileCancelText:"إلغاء",
    mobileDays:"أيام",
    mobileStops:"محطات",
    mobileCities:"المدن:",
    closeBtnText:"إغلاق",
    backBtnText:"رجوع",
    homeBtnText:"رجوع ←",
    legend_title:"خطوط السير",
    legend_incontournable:"لا يفوتك",
    legend_recommande:"موصى به",
    legend_decouvrir:"للاكتشاف",
    legend_standard:"عادي",
    legend_selected:"محدد",
    visible_itins_single:"مسار مرئي",
    visible_itins_plural:"مسارات مرئية",
    budget_modal_title:"ميزانية الفندق",
    budget_modal_text:"اختر فئة واحدة أو أكثر (€/يوم/شخص):",
    budget_confirm:"تأكيد",
    budget_cancel:"إلغاء",
    budget_0_50:"0–50",
    budget_50_100:"50–100",
    budget_100_150:"100–150",
    budget_150_200:"150–200",
    budget_200_250:"200–250",
    budget_250_300:"250–300",
    budget_300_500:"300–500",
    budget_500plus:"أكثر من 500",
    pace_title:"الوتيرة:",
    pace_fast:"سريع",
    pace_normal:"عادي",
    pace_slow:"مريح",
    modal_title:"قم بتكوين رحلتك",
    modal_departure_date:"تاريخ المغادرة:",
    modal_num_days:"عدد الأيام:",
    modal_max_hotels:"الحد الأقصى لتغييرات الفندق:",
    modal_budget_label:"ميزانية الفندق (€/يوم/شخص):",
    filterAllDays:"الكل",
    filterAllDistances:"الكل",
    filterAllCountries:"الكل",
    filterAllRegions:"الكل",
    filterAllThemes:"الكل",
    searchPlaceholder:"كلمة مفتاحية...",
    // خيارات الفلاتر
    filter_days_1_3:"1-3 أيام",
    filter_days_4_7:"4-7 أيام",
    filter_days_8_14:"8-14 يوماً",
    filter_days_15plus:"15+ يوماً",
    filter_dist_0_500:"0-500 كم",
    filter_dist_501_1000:"501-1000 كم",
    filter_dist_1001_2000:"1001-2000 كم",
    filter_dist_2001plus:"2001+ كم",
 filter_theme_montagne:"الجبال",
filter_theme_mer_cotes:"البحر والسواحل",
filter_theme_ville_histoire:"المدن والتاريخ",
filter_theme_nature:"الطبيعة",
filter_theme_culture:"الثقافة",
filter_theme_gastronomie_vin:"المأكولات والنبيذ",
filter_theme_aventure_outdoor:"المغامرة والهواء الطلق",
filter_theme_route_exploration:"الطرق والاستكشاف",
filter_theme_insolite_hors_sentiers:"غير المألوف وخارج المسار",
filter_theme_faune_vie_sauvage:"الحياة البرية",
filter_theme_spiritualite_religion:"الروحانية والدين",
filter_theme_bien_etre_detente:"العافية والاسترخاء",
filter_theme_detente:"استرخاء",
filter_theme_tested_ort:"مُختبَر ومُعتمد من ORT",

  }
};

</script>
<!-- Charge la config centralisée AVANT l’init Firebase -->
<script src="./js/ort-config.js"></script>
<script>
/* Aligne presentation.html sur quest_simple.html */
(function(){
  const host = location.hostname;
  const isPreprod = /oneroadtrip-preprod|localhost|127\.0\.0\.1/.test(host);
  const cfg = isPreprod ? (window.ORT_CONFIG?.PREPROD || {}) : (window.ORT_CONFIG?.PROD || {});
  const safe = (cfg && cfg.apiKey) ? cfg : (window.ORT_CONFIG?.PREPROD || {});
  window.__FIREBASE_CONFIG__ = safe;
})();

/* Chargeur Firebase compat + persistance LOCAL (même que quest_simple.html) */
function loadScript(src){
  return new Promise((ok,ko)=>{ const s=document.createElement('script'); s.src=src; s.onload=ok; s.onerror=()=>ko(new Error('load '+src)); document.head.appendChild(s); });
}
async function ensureFirebase(){
  if(window.firebase?.apps?.length) return window.firebase;
  await loadScript('https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js');
  await loadScript('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js');
  const cfg = window.__FIREBASE_CONFIG__ || {};
  if(!cfg.apiKey){
    alert('Config Firebase absente : ./js/ort-config.js introuvable ou vide.');
    throw new Error('Missing Firebase apiKey');
  }
  window.firebase.initializeApp(cfg);
  await window.firebase.auth().setPersistence(window.firebase.auth.Auth.Persistence.LOCAL);
  return window.firebase;
}
</script>


<script>
/* ===== MAP EXPLORER ===== */
/* ===== MAP EXPLORER ===== */

/* === SYSTÈME DE COULEURS PAR RATING === */
function ratingToStars(rating) {
  // Nouveaux seuils: 8.8/7.6/6.1/3.1 + TOUTES les étoiles agrandies
  if (rating >= 8.8) return { stars: 5, color: '#1565C0', textColor: '#fff', radius: 18, isStar: true };  // Étoile bleue ★★★★★
  if (rating >= 7.6) return { stars: 4, color: '#0D47A1', textColor: '#fff', radius: 16, isStar: true }; // Étoile bleu foncé ★★★★
  if (rating >= 6.1) return { stars: 3, color: '#43A047', textColor: '#fff', radius: 14, isStar: false }; // Vert ★★★
  if (rating >= 3.1) return { stars: 2, color: '#78909C', textColor: '#fff', radius: 12, isStar: false }; // Gris-bleu ★★
  if (rating >= 0.1) return { stars: 1, color: '#B0BEC5', textColor: '#333', radius: 10, isStar: false }; // Gris clair ★
  return { stars: 0, color: '#CFD8DC', textColor: '#fff', radius: 10, isStar: false }; // Gris très clair (taille min)
}

// Fonction pour créer une icône étoile
function createStarIcon(color, size, isSelected = false) {
  const finalColor = isSelected ? '#e11d48' : color;
  return L.divIcon({
    html: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="${finalColor}" stroke="#fff" stroke-width="2">
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
    </svg>`,
    className: 'star-marker' + (isSelected ? ' selected' : ''),
    iconSize: [size, size],
    iconAnchor: [size/2, size/2]
  });
}

// Index global des ratings des places (chargé depuis places_master.json)
let placesRatingIndex = {};

let allItineraries = [];
let photosData = {};
let placesPhotosIndex = null;   // NEW: index photos par lieu (photos_lieux.json)
let mapFull = null;
let markersLayerFull = null;    // Layer clusterisé pour les marqueurs principaux
let overlaysLayer = null;       // Layer NON clusterisé pour polylines et cityMarkers
let selectedItineraries = [];
let MAX_SELECTION = 3; // sera mis à jour selon le mode

// NEW: registre calques par itin_id
const itinLayers = new Map();
let hoverHideTimer = null; // ← NEW: timer de masquage survol


/* === AJOUT : état du pop-up itin === */
let previewPinned = false;          // reste ouvert si true
let previewLatLng = null;           // [lat,lng] du point d’ancrage courant

// --- NEW: fermer le preview et tout désurligner ---
window.closeItinPreview = function () {
  previewPinned = false;
  const preview = document.getElementById('itinPreview');
  
  if (preview) {
    // Animation de fermeture sur mobile
    if (window.innerWidth <= 1024) {
      preview.style.transition = 'all 0.3s ease-in';
      preview.style.opacity = '0';
      preview.style.transform = 'translateY(100%)';
      
      setTimeout(() => {
        preview.style.display = 'none';
        preview.style.transition = '';
        preview.style.transform = '';
      }, 300);
    } else {
      preview.style.display = 'none';
    }
  }
  
  // Les polylines et cityMarkers sont dans overlaysLayer
  if (typeof overlaysLayer !== 'undefined' && overlaysLayer) {
    overlaysLayer.eachLayer(l => {
      if (l instanceof L.Polyline) l.setStyle({ opacity: 0 });
      else if (l instanceof L.CircleMarker && l.options && l.options.radius === 5) {
        l.setStyle({ opacity: 0, fillOpacity: 0 });
      }
    });
  }
  
  // Masquer la barre mobile
  const mobileBar = document.getElementById('mobileActionBar');
  if (mobileBar && window.innerWidth <= 1024) {
    mobileBar.style.display = 'none';
  }
  
  updateSelectionStyles(); // NEW : réapplique le rouge sur les sélectionnés
};

// Fonction pour réinitialiser l'état de la preview proprement
function resetPreviewState() {
  previewPinned = false;
  const p = document.getElementById('itinPreview');
  if (p) {
    p.style.display = 'none';
    p.style.visibility = 'visible';
    p.style.opacity = '1';
    p.classList.add('in-sidebar');
  }
}
/* === FIN AJOUT === */


// Liste des codes pays à essayer (sera étendue automatiquement)
const COUNTRY_CODES_TO_TRY = [
  'CH', 'GR', 'HR', 'CN', 'ID', 'BE', 'FR', 'US', 'DE', 'IT', 'ES', 'PT', 'NL', 
  'AT', 'PL', 'CZ', 'HU', 'RO', 'BG', 'SI', 'SK', 'BA', 'RS', 'ME', 'MK', 'AL',
  'GB', 'IE', 'SE', 'NO', 'DK', 'FI', 'IS', 'EE', 'LV', 'LT',
  'AR', 'BR', 'CL', 'CO', 'PE', 'MX', 'CA',
  'AU', 'NZ', 'JP', 'KR', 'TH', 'VN', 'MY', 'SG', 'PH', 'IN',
  'ZA', 'EG', 'MA', 'TN', 'KE', 'TZ'
];

// Mapping des codes pays vers noms complets
const COUNTRY_NAMES = {
  'CH': { fr: 'Suisse', en: 'Switzerland', it: 'Svizzera', es: 'Suiza', pt: 'Suíça', ar: 'سويسرا' },
  'GR': { fr: 'Grèce', en: 'Greece', it: 'Grecia', es: 'Grecia', pt: 'Grécia', ar: 'اليونان' },
  'HR': { fr: 'Croatie', en: 'Croatia', it: 'Croazia', es: 'Croacia', pt: 'Croácia', ar: 'كرواتيا' },
  'CN': { fr: 'Chine', en: 'China', it: 'Cina', es: 'China', pt: 'China', ar: 'الصين' },
  'ID': { fr: 'Indonésie', en: 'Indonesia', it: 'Indonesia', es: 'Indonesia', pt: 'Indonésia', ar: 'إندونيسيا' },
  'BE': { fr: 'Belgique', en: 'Belgium', it: 'Belgio', es: 'Bélgica', pt: 'Bélgica', ar: 'بلجيكا' },
  'FR': { fr: 'France', en: 'France', it: 'Francia', es: 'Francia', pt: 'França', ar: 'فرنسا' },
  'US': { fr: 'États-Unis', en: 'United States', it: 'Stati Uniti', es: 'Estados Unidos', pt: 'Estados Unidos', ar: 'الولايات المتحدة' },
  'DE': { fr: 'Allemagne', en: 'Germany', it: 'Germania', es: 'Alemania', pt: 'Alemanha', ar: 'ألمانيا' },
  'IT': { fr: 'Italie', en: 'Italy', it: 'Italia', es: 'Italia', pt: 'Itália', ar: 'إيطاليا' },
  'ES': { fr: 'Espagne', en: 'Spain', it: 'Spagna', es: 'España', pt: 'Espanha', ar: 'إسبانيا' },
  'PT': { fr: 'Portugal', en: 'Portugal', it: 'Portogallo', es: 'Portugal', pt: 'Portugal', ar: 'البرتغال' },
  'GB': { fr: 'Royaume-Uni', en: 'United Kingdom', it: 'Regno Unito', es: 'Reino Unido', pt: 'Reino Unido', ar: 'المملكة المتحدة' },
  'AT': { fr: 'Autriche', en: 'Austria', it: 'Austria', es: 'Austria', pt: 'Áustria', ar: 'النمسا' },
  'NL': { fr: 'Pays-Bas', en: 'Netherlands', it: 'Paesi Bassi', es: 'Países Bajos', pt: 'Países Baixos', ar: 'هولندا' },
  'AR': { fr: 'Argentine', en: 'Argentina', it: 'Argentina', es: 'Argentina', pt: 'Argentina', ar: 'الأرجنتين' },
  'BR': { fr: 'Brésil', en: 'Brazil', it: 'Brasile', es: 'Brasil', pt: 'Brasil', ar: 'البرازيل' },
  'CA': { fr: 'Canada', en: 'Canada', it: 'Canada', es: 'Canadá', pt: 'Canadá', ar: 'كندا' },
  'MX': { fr: 'Mexique', en: 'Mexico', it: 'Messico', es: 'México', pt: 'México', ar: 'المكسيك' },
  'AU': { fr: 'Australie', en: 'Australia', it: 'Australia', es: 'Australia', pt: 'Austrália', ar: 'أستراليا' },
  'NZ': { fr: 'Nouvelle-Zélande', en: 'New Zealand', it: 'Nuova Zelanda', es: 'Nueva Zelanda', pt: 'Nova Zelândia', ar: 'نيوزيلندا' },
  'JP': { fr: 'Japon', en: 'Japan', it: 'Giappone', es: 'Japón', pt: 'Japão', ar: 'اليابان' },
  'TH': { fr: 'Thaïlande', en: 'Thailand', it: 'Tailandia', es: 'Tailandia', pt: 'Tailândia', ar: 'تايلاند' },
  'IN': { fr: 'Inde', en: 'India', it: 'India', es: 'India', pt: 'Índia', ar: 'الهند' },
  'ZA': { fr: 'Afrique du Sud', en: 'South Africa', it: 'Sudafrica', es: 'Sudáfrica', pt: 'África do Sul', ar: 'جنوب أفريقيا' },
  'MA': { fr: 'Maroc', en: 'Morocco', it: 'Marocco', es: 'Marruecos', pt: 'Marrocos', ar: 'المغرب' },
  'EG': { fr: 'Égypte', en: 'Egypt', it: 'Egitto', es: 'Egipto', pt: 'Egito', ar: 'مصر' }
};

// Ouvrir la carte en plein écran
document.getElementById('mapExplorerPreview')?.addEventListener('click', () => {
  document.getElementById('mapFullscreen').classList.add('active');
  document.body.style.overflow = 'hidden';
  document.getElementById('backToPresentation').style.display = ''; // Afficher bouton Retour

  /* Déplace l’aperçu dans l’onglet Filtres (sidebar) */
  (function movePreviewToSidebar(){
    const sidebar = document.querySelector('.map-fullscreen-sidebar .map-controls-vertical');
    const preview = document.getElementById('itinPreview');
    if (sidebar && preview && preview.parentElement !== sidebar){
      sidebar.insertBefore(preview, sidebar.firstChild);
      preview.classList.add('in-sidebar');
    }
  })();

if (!mapFull) {
  setTimeout(async () => {
    await loadThemes(); // ← CHARGER LES THÈMES EN PREMIER
    initMapFull();
    loadPhotosData();
    loadPlacesPhotosIndex(); // ← charge photos_lieux.json
    loadAllItineraries();
  }, 100);
} else {

    setTimeout(() => mapFull.invalidateSize(), 100);
  }
});

// Fermer la carte
document.getElementById('closeMapFull')?.addEventListener('click', () => {
  document.getElementById('mapFullscreen').classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('backToPresentation').style.display = 'none'; // Masquer bouton Retour
  if (typeof closeItinPreview === 'function') closeItinPreview();
  if (typeof resetPreviewState === 'function') resetPreviewState();
});

// Bouton Retour vers presentation.html
document.getElementById('backToPresentation')?.addEventListener('click', () => {
  document.getElementById('mapFullscreen').classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('backToPresentation').style.display = 'none'; // Masquer bouton Retour
  if (typeof closeItinPreview === 'function') closeItinPreview();
  if (typeof resetPreviewState === 'function') resetPreviewState();
});

document.getElementById('mapFullscreen')?.addEventListener('click', (e) => {
  if (e.target.id === 'mapFullscreen') {
    document.getElementById('mapFullscreen').classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('backToPresentation').style.display = 'none'; // Masquer bouton Retour
  }
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('mapFullscreen').classList.contains('active')) {
    document.getElementById('mapFullscreen').classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('backToPresentation').style.display = 'none'; // Masquer bouton Retour
  }
});

async function loadPhotosData() {
  try {
    let response = await fetch('data/photos-json/photos_rt.json');
    if (!response.ok) {
      response = await fetch('/mnt/user-data/uploads/photos_rt.json');
    }
    if (response.ok) {
      photosData = await response.json();
      console.log('✅ Photos chargées');
    }
  } catch (error) {
    console.warn('Photos non disponibles:', error);
  }
}

// NEW: charge l’index des photos par lieu (clé = CC::slug)
async function loadPlacesPhotosIndex() {
  try {
    let response = await fetch('data/photos-json/photos_lieux.json');
    if (!response.ok) {
      response = await fetch('/mnt/user-data/uploads/photos_lieux.json');
    }
    if (response.ok) {
      placesPhotosIndex = await response.json();
      console.log('✅ Photos lieux chargées');
    }
  } catch (e) {
    console.warn('Photos lieux non disponibles:', e);
  }
}

async function loadAllItineraries() {
  try {
    // Charger l'index des pays
    const indexPaths = [
      'data/Roadtripsprefabriques/countries/countries.index.json',
      './data/Roadtripsprefabriques/countries/countries.index.json'
    ];
    
    let countryList = [];
    for (const path of indexPaths) {
      try {
        const idxRes = await fetch(path);
        if (idxRes.ok) {
          const idxJson = await idxRes.json();
          countryList = Array.isArray(idxJson) ? idxJson : (idxJson.countries || []);
          console.log(`✅ Index chargé: ${countryList.length} pays trouvés`);
          break;
        }
      } catch (err) {
        console.warn(`Tentative ${path} échouée`);
      }
    }
    
    if (countryList.length === 0) {
      console.warn('⚠️ Pas d\'index trouvé, utilisation de la liste par défaut');
      countryList = COUNTRY_CODES_TO_TRY.map(cc => ({ cc: cc }));
    }
    
    // Détecter le pays de l'utilisateur
    let userCountry = null;
    try {
      const ipRes = await fetch('https://ipapi.co/json/');
      if (ipRes.ok) {
        const ipData = await ipRes.json();
        userCountry = ipData.country_code;
        console.log(`🌍 Pays détecté: ${userCountry}`);
      }
    } catch (e) { /* ignore */ }
    
    // Séparer pays user et autres pays
    const getCC = c => String(c.cc || c.code || c.id || c).toUpperCase();
    const userCountryList = userCountry ? countryList.filter(c => getCC(c) === userCountry) : [];
    const otherCountries = userCountry ? countryList.filter(c => getCC(c) !== userCountry) : countryList;
    
    // Fonction pour charger un pays
    async function loadCountry(countryObj) {
      const countryCode = getCC(countryObj);
      const countryLower = countryCode.toLowerCase();
      const lang = localStorage.getItem('lang') || 'fr';
      
      await loadPlacesRatings(countryCode);
      
      // Fallback langue: langue courante → en → fr (sauf si déjà dans la liste)
      const langFallback = lang !== 'en' && lang !== 'fr' ? [lang, 'en', 'fr'] : 
                           lang === 'en' ? ['en', 'fr'] : ['fr', 'en'];
      
      // Chemins insensibles à la casse : dossier et fichier en majuscules OU minuscules
      const paths = [];
      for (const fl of langFallback) {
        // Dossier MAJUSCULE + Fichier MAJUSCULE
        paths.push(`data/Roadtripsprefabriques/countries/${countryCode}/${countryCode}.itins.modules-${fl}.json`);
        paths.push(`./data/Roadtripsprefabriques/countries/${countryCode}/${countryCode}.itins.modules-${fl}.json`);
        // Dossier minuscule + Fichier MAJUSCULE
        paths.push(`data/Roadtripsprefabriques/countries/${countryLower}/${countryCode}.itins.modules-${fl}.json`);
        paths.push(`./data/Roadtripsprefabriques/countries/${countryLower}/${countryCode}.itins.modules-${fl}.json`);
        // Dossier minuscule + Fichier minuscule
        paths.push(`data/Roadtripsprefabriques/countries/${countryLower}/${countryLower}.itins.modules-${fl}.json`);
        paths.push(`./data/Roadtripsprefabriques/countries/${countryLower}/${countryLower}.itins.modules-${fl}.json`);
        // Dossier MAJUSCULE + Fichier minuscule
        paths.push(`data/Roadtripsprefabriques/countries/${countryCode}/${countryLower}.itins.modules-${fl}.json`);
        paths.push(`./data/Roadtripsprefabriques/countries/${countryCode}/${countryLower}.itins.modules-${fl}.json`);
      }
      // Ancien format sans suffixe langue (toutes variantes)
      paths.push(`data/Roadtripsprefabriques/countries/${countryCode}/${countryCode}.itins.modules.json`);
      paths.push(`./data/Roadtripsprefabriques/countries/${countryCode}/${countryCode}.itins.modules.json`);
      paths.push(`data/Roadtripsprefabriques/countries/${countryLower}/${countryCode}.itins.modules.json`);
      paths.push(`./data/Roadtripsprefabriques/countries/${countryLower}/${countryCode}.itins.modules.json`);
      paths.push(`data/Roadtripsprefabriques/countries/${countryLower}/${countryLower}.itins.modules.json`);
      paths.push(`./data/Roadtripsprefabriques/countries/${countryLower}/${countryLower}.itins.modules.json`);
      
      for (const path of paths) {
        try {
          const response = await fetch(path, { cache: 'no-store' });
          if (response.ok) {
            const data = await response.json();
            console.log(`✅ Chargé: ${countryCode} (${data.itineraries?.length || 0} itinéraires)`);
            const countryName = COUNTRY_NAMES[countryCode]?.[lang] || countryCode;
            return (data.itineraries || []).map(itin => ({
              ...itin,
              __id: itin.itin_id || itin.id || itin.slug || '',
              country: countryCode,
              countryName: countryName,
              days: itin.estimated_days_base || itin.days_plan?.length || 0,
              stops: countUniqueStops(itin),
              totalDistance: calculateTotalDistance(itin),
              lat: (computeItinCenter(itin).lat) || 0,
              lng: (computeItinCenter(itin).lng) || 0,
              cities: extractCities(itin),
              photos: getItinPhotos({ ...itin, country: countryCode, countryName }),
              avgRating: computeAvgRating(itin) || 5
            }));
          }
        } catch (err) { /* continue */ }
      }
      return [];
    }
    
    // ÉTAPE 1: Charger le pays de l'utilisateur EN PREMIER
    if (userCountryList.length > 0) {
      console.log(`🚀 Chargement prioritaire: ${userCountry}`);
      const userResults = await Promise.all(userCountryList.map(loadCountry));
      const userItins = userResults.flat().filter(itin => itin.__id);
      if (userItins.length > 0) {
        allItineraries = userItins;
        populateFilters();
        displayMarkers(allItineraries);
        console.log(`✅ ${userItins.length} itinéraires ${userCountry} affichés en premier`);
      }
    }
    
    // ÉTAPE 2: Charger les autres pays en arrière-plan
    console.log(`📦 Chargement des ${otherCountries.length} autres pays...`);
    const otherResults = await Promise.all(otherCountries.map(loadCountry));
    const otherItins = otherResults.flat().filter(itin => itin.__id);
    
    // Fusionner et réafficher
    allItineraries = [...allItineraries, ...otherItins];
    populateFilters();
    displayMarkers(allItineraries);
    
    console.log(`✅ ${allItineraries.length} itinéraires chargés au total`);
  } catch (error) {
    console.error('Erreur chargement:', error);
  }
}

function getItinPhotos(itin) {
  if (!photosData) return [];
  
  // Essayer plusieurs formats de clés possibles
  const possibleKeys = [
    itin.itin_id,
    itin.title,
    `${itin.country}::${itin.dept_name}`,
    `${itin.country}::${itin.title}`,
    itin.dept_name
  ];
  
  for (const key of possibleKeys) {
    if (photosData[key] && photosData[key].photos) {
      return photosData[key].photos.slice(0, 2);
    }
  }
  
  // Chercher par correspondance partielle dans les clés
  for (const key in photosData) {
    if (key.includes(itin.country) && 
        (key.toLowerCase().includes(itin.dept_name?.toLowerCase() || '') ||
         key.toLowerCase().includes(itin.title.toLowerCase().substring(0, 20)))) {
      return photosData[key].photos.slice(0, 2);
    }
  }
  
  return [];
}

function calculateTotalDistance(itin) {
  if (!itin.days_plan || !Array.isArray(itin.days_plan)) return 0;
  let total = 0;
  itin.days_plan.forEach(day => {
    if (day.to_next_leg && day.to_next_leg.distance_km) {
      total += day.to_next_leg.distance_km;
    }
  });
  return Math.round(total);
}

/* === Compte le nombre d'étapes/stops uniques === */
function countUniqueStops(itin) {
  if (!itin.days_plan || !Array.isArray(itin.days_plan)) return 0;
  const uniquePlaces = new Set();
  itin.days_plan.forEach(day => {
    if (day.night && day.night.place_id) {
      uniquePlaces.add(day.night.place_id);
    }
  });
  return uniquePlaces.size;
}

/* === Calcul du rating moyen de l'itinéraire via places_master === */
function computeAvgRating(itin) {
  if (!itin.days_plan || !Array.isArray(itin.days_plan)) return 5;
  let sum = 0, count = 0;
  const debugLog = [];
  
  // Parcourir TOUTES les places de l'itinéraire (jours + nuits)
  itin.days_plan.forEach((day, dayIdx) => {
    // Essayer plusieurs noms de champs possibles pour les places du jour
    const placesArrays = [
      day.places,
      day.stops,
      day.stop_places,
      day.locations,
      day.location_ids,
      day.pois,
      day.visits
    ].filter(Array.isArray);
    
    placesArrays.forEach(placesArray => {
      placesArray.forEach(item => {
        const place_id = item?.place_id || item;
        if (place_id) {
          const placeRating = placesRatingIndex[place_id];
          if (placeRating && typeof placeRating === 'number') {
            sum += placeRating;
            count++;
            debugLog.push(`Day ${dayIdx}: ${place_id} = ${placeRating}`);
          }
        }
      });
    });
    
    // Rating de la nuit (hébergement)
    if (day.night && day.night.place_id) {
      const placeRating = placesRatingIndex[day.night.place_id];
      if (placeRating && typeof placeRating === 'number') {
        sum += placeRating;
        count++;
        debugLog.push(`Night ${dayIdx}: ${day.night.place_id} = ${placeRating}`);
      }
    }
  });
  
  const result = count > 0 ? Math.round(sum / count * 10) / 10 : 5;
  
  if (debugLog.length > 0) {
    console.log(`📊 ${itin.title}: ${count} places trouvées, moyenne = ${result}`, debugLog);
  } else {
    console.warn(`⚠️ ${itin.title}: AUCUNE place trouvée dans placesRatingIndex (vide: ${Object.keys(placesRatingIndex).length === 0})`);
  }
  
  return result;
}

/* === Chargement des ratings depuis places_master.json === */
async function loadPlacesRatings(countryCode) {
  const cc = countryCode.toLowerCase();
  const CC = countryCode.toUpperCase();
  const lang = localStorage.getItem('lang') || 'fr';
  
  // Chercher {CC}.places.master-{lang}.json EN PREMIER
  // Puis fallback sur d'autres formats
  const paths = [
    // Format principal: CC.places.master-lang.json
    `data/Roadtripsprefabriques/countries/${CC}/${CC}.places.master-${lang}.json`,
    `./data/Roadtripsprefabriques/countries/${CC}/${CC}.places.master-${lang}.json`,
    `data/Roadtripsprefabriques/countries/${cc}/${CC}.places.master-${lang}.json`,
    `./data/Roadtripsprefabriques/countries/${cc}/${CC}.places.master-${lang}.json`,
    
    // Format avec underscore: cc_places_master-lang.json
    `data/Roadtripsprefabriques/countries/${CC}/${cc}_places_master-${lang}.json`,
    `./data/Roadtripsprefabriques/countries/${CC}/${cc}_places_master-${lang}.json`,
    `data/Roadtripsprefabriques/countries/${cc}/${cc}_places_master-${lang}.json`,
    `./data/Roadtripsprefabriques/countries/${cc}/${cc}_places_master-${lang}.json`,
    
    // Fallback: essayer d'autres langues (avec point)
    `data/Roadtripsprefabriques/countries/${CC}/${CC}.places.master-fr.json`,
    `./data/Roadtripsprefabriques/countries/${CC}/${CC}.places.master-fr.json`,
    `data/Roadtripsprefabriques/countries/${cc}/${CC}.places.master-fr.json`,
    `./data/Roadtripsprefabriques/countries/${cc}/${CC}.places.master-fr.json`,
    
    // Fallback: essayer d'autres langues (avec underscore)
    `data/Roadtripsprefabriques/countries/${CC}/${cc}_places_master-fr.json`,
    `./data/Roadtripsprefabriques/countries/${CC}/${cc}_places_master-fr.json`,
    `data/Roadtripsprefabriques/countries/${cc}/${cc}_places_master-fr.json`,
    `./data/Roadtripsprefabriques/countries/${cc}/${cc}_places_master-fr.json`,
    
    // Format ancien sans langue
    `data/Roadtripsprefabriques/countries/${CC}/${CC}.places.master.json`,
    `./data/Roadtripsprefabriques/countries/${CC}/${CC}.places.master.json`,
    `data/Roadtripsprefabriques/countries/${cc}/${CC}.places.master.json`,
    `./data/Roadtripsprefabriques/countries/${cc}/${CC}.places.master.json`,
  ];
  
  for (const path of paths) {
    try {
      const response = await fetch(path);
      if (response.ok) {
        const data = await response.json();
        if (data.places && Array.isArray(data.places)) {
          const beforeCount = Object.keys(placesRatingIndex).length;
          data.places.forEach(place => {
            if (place.place_id && typeof place.rating === 'number') {
              placesRatingIndex[place.place_id] = place.rating;
            }
          });
          const afterCount = Object.keys(placesRatingIndex).length;
          console.log(`📍 ${CC} places chargées: ${data.places.length} places, ${afterCount - beforeCount} avec ratings`);
        }
        return true;
      }
    } catch (err) {
      // Continuer avec le prochain chemin
    }
  }
  console.warn(`⚠️ ${CC} places.master.json non trouvé`);
  return false;
}

/* === AJOUT : centre moyen des nuits === */
function computeItinCenter(itin) {
  if (!itin || !Array.isArray(itin.days_plan) || itin.days_plan.length === 0) {
    return { lat: 0, lng: 0 };
  }
  let n = 0, sumLat = 0, sumLng = 0;
  itin.days_plan.forEach(day => {
    const c = day && day.night && Array.isArray(day.night.coords) ? day.night.coords : null;
    if (c && Number.isFinite(c[0]) && Number.isFinite(c[1])) {
      sumLat += c[0];
      sumLng += c[1];
      n++;
    }
  });
  return n > 0 ? { lat: sumLat / n, lng: sumLng / n } : { lat: 0, lng: 0 };
}
/* === FIN AJOUT === */

function extractCities(itin) {
  if (!itin.days_plan) return [];
  const cities = [];
  itin.days_plan.forEach(day => {
    if (day.night && day.night.place_id) {
      const cityName = (day.night.name_i18n && day.night.name_i18n[lang]) || (day.night.name_i18n && day.night.name_i18n['en']) || day.night.place_id.split('::').pop().replace(/-/g, ' ');
      const capitalized = cityName.charAt(0).toUpperCase() + cityName.slice(1);
      if (!cities.includes(capitalized)) cities.push(capitalized);
    }
  });
    return cities;
}

// NEW: retourne un tableau de clés lieux "CC::slug" à partir de l’itin
function getPlaceKeysFromItin(itin) {
  const keys = new Set();
  const days = Array.isArray(itin.days_plan) ? itin.days_plan : [];

  for (const d of days) {
    if (d?.night?.place_id) keys.add(d.night.place_id);

    if (Array.isArray(d?.visits)) {
      d.visits.forEach(v => { if (v?.place_id) keys.add(v.place_id); });
    }
    if (Array.isArray(d?.activities)) {
      d.activities.forEach(a => { if (a?.place_id) keys.add(a.place_id); });
    }
  }
  return Array.from(keys);
}

function populateFilters() {

  const lang = localStorage.getItem('lang') || 'fr';
  const L_TEXT = T[lang] || T.fr;
  
  const countries = [...new Set(allItineraries.map(i => i.countryName))].sort();
  const regions = [...new Set(allItineraries.map(i => i.dept_name).filter(Boolean))].sort();
  
  const countrySelect = document.getElementById('filterCountryFull');
  countrySelect.innerHTML = `<option value="">${L_TEXT.filterAllCountries}</option>`;
  countries.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    countrySelect.appendChild(opt);
  });
  
  const regionSelect = document.getElementById('filterRegionFull');
  regionSelect.innerHTML = `<option value="">${L_TEXT.filterAllRegions}</option>`;
  regions.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r;
    opt.textContent = r;
    regionSelect.appendChild(opt);
  });
}


// Coordonnées centrales des pays (lat, lng, zoom)
const COUNTRY_CENTERS = {
  FR: [46.6, 2.5, 5], DE: [51.1, 10.4, 5], IT: [42.5, 12.5, 5], ES: [40.0, -3.7, 5],
  GB: [54.0, -2.5, 5], PT: [39.5, -8.0, 6], BE: [50.5, 4.5, 7], NL: [52.2, 5.3, 7],
  CH: [46.8, 8.2, 7], AT: [47.5, 14.5, 6], GR: [39.0, 22.0, 6], PL: [52.0, 19.0, 5],
  US: [39.8, -98.5, 4], CA: [56.0, -106.0, 3], MX: [23.6, -102.5, 5],
  BR: [-14.2, -51.9, 4], AR: [-38.4, -63.6, 4], CL: [-35.7, -71.5, 4],
  AU: [-25.3, 133.8, 4], NZ: [-41.0, 174.0, 5], JP: [36.2, 138.2, 5],
  CN: [35.9, 104.2, 4], KR: [36.5, 127.5, 6], IN: [20.6, 78.9, 4],
  TH: [15.9, 100.9, 5], VN: [16.0, 108.0, 5], ID: [-2.5, 118.0, 4],
  MA: [31.8, -7.1, 5], ZA: [-30.6, 24.0, 5], EG: [26.8, 30.8, 5],
  AE: [24.0, 54.0, 6], SA: [24.0, 45.0, 5], TR: [39.0, 35.0, 5],
  RU: [61.5, 105.3, 3], SE: [62.0, 15.0, 4], NO: [64.0, 10.0, 4],
  DK: [56.0, 10.0, 6], FI: [64.0, 26.0, 4], IE: [53.4, -8.2, 6]
};

// Détecter le pays de l'utilisateur et centrer la carte
async function detectUserCountryAndCenter() {
  try {
    // Essayer via API IP (gratuit, pas de clé)
    const response = await fetch('https://ipapi.co/json/', { timeout: 3000 });
    if (response.ok) {
      const data = await response.json();
      const countryCode = data.country_code;
      if (countryCode && COUNTRY_CENTERS[countryCode]) {
        const [lat, lng, zoom] = COUNTRY_CENTERS[countryCode];
        mapFull.setView([lat, lng], zoom);
        console.log(`🌍 Carte centrée sur ${countryCode}`);
        return;
      }
    }
  } catch (e) {
    console.warn('Géolocalisation IP échouée, utilisation de la vue par défaut');
  }
}

function initMapFull() {
  mapFull = L.map('mapContainerFull').setView([46.0, 8.0], 4);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '© CARTO © OpenStreetMap',
    maxZoom: 20
  }).addTo(mapFull);

  // Essayer de centrer sur le pays de l'utilisateur
  detectUserCountryAndCenter();

  markersLayerFull = L.markerClusterGroup({
    maxClusterRadius: 50,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    disableClusteringAtZoom: 10,
    iconCreateFunction: function(cluster) {
      const count = cluster.getChildCount();
      let size = 'small';
      if (count > 50) size = 'large';
      else if (count > 20) size = 'medium';
      
      return L.divIcon({
        html: '<div>' + count + '</div>',
        className: 'marker-cluster marker-cluster-' + size,
        iconSize: L.point(40, 40)
      });
    }
  }).addTo(mapFull);

  // Layer séparé pour les overlays (polylines et cityMarkers) - PAS clusterisé
  overlaysLayer = L.layerGroup().addTo(mapFull);

  // --- NEW: clic sur la carte = fermer / nettoyer si on ne clique pas sur le preview
  mapFull.on('click', (e) => {
    const t = e.originalEvent?.target;
    if (!t || !t.closest || !t.closest('#itinPreview')) {
      closeItinPreview();
    }
  });

  // --- NEW: gestion du zoom pour affichage progressif des markers
  mapFull.on('zoomend', updateMarkersVisibility);
}

// Seuils de zoom pour l'affichage progressif des ITINÉRAIRES
// Moins restrictif que pour les places car il y en a moins (~700)
function getMinRatingForZoom(zoom) {
  if (zoom < 3) return 5.5;    // Zoom très global (monde): seulement 5★
  if (zoom < 4) return 4.5;    // Zoom continent/très large: 5★ + quelques 4★
  return 0;                     // Zoom >= 4 (pays/région): tous les itinéraires
}

function updateMarkersVisibility() {
  if (!mapFull || !itinLayers) return;
  const zoom = mapFull.getZoom();
  const minRating = getMinRatingForZoom(zoom);
  const bounds = mapFull.getBounds(); // Récupérer les limites visibles de la carte
  let visibleCount = 0;
  
  itinLayers.forEach(({ mainMarker, polyline, cityMarkers, avgRating }, id) => {
    // Ne pas mettre 5 par défaut - utiliser le rating réel ou null
    const rating = avgRating || 0;  // Si pas de rating, considérer comme bas
    const isSelected = selectedItineraries.some(i => i.itin_id === id);
    
    // Vérifier si le marqueur est dans les bounds visibles
    const markerLatLng = mainMarker ? mainMarker.getLatLng() : null;
    const isInBounds = markerLatLng ? bounds.contains(markerLatLng) : false;
    
    if (rating >= minRating || isSelected) {
      // Afficher le marker principal (dans le cluster)
      if (mainMarker && !markersLayerFull.hasLayer(mainMarker)) {
        markersLayerFull.addLayer(mainMarker);
      }
      // Compter seulement si dans les bounds visibles
      if (isInBounds) {
        visibleCount++;
      }
    } else {
      // Masquer le marker principal
      if (mainMarker && markersLayerFull.hasLayer(mainMarker)) {
        markersLayerFull.removeLayer(mainMarker);
      }
      // Masquer aussi la polyline et les cityMarkers (dans overlaysLayer)
      if (polyline && overlaysLayer.hasLayer(polyline)) {
        overlaysLayer.removeLayer(polyline);
      }
      cityMarkers.forEach(cm => {
        if (overlaysLayer.hasLayer(cm)) {
          overlaysLayer.removeLayer(cm);
        }
      });
    }
  });
  
  // Mettre à jour le compteur affiché
  console.log(`🔢 Visibles au zoom ${zoom} dans bounds: ${visibleCount} itinéraires`);
  updateFilterCount(visibleCount);
}

function displayMarkers(itineraries) {
  if (!markersLayerFull) return;
  markersLayerFull.clearLayers();
  if (overlaysLayer) overlaysLayer.clearLayers();;
  itinLayers.clear(); // NEW

  itineraries.forEach(itin => {
    let polyline = null;
    let cityMarkers = [];
    
    // Préparer le tracé mais ne pas l'afficher
    if (itin.days_plan && itin.days_plan.length > 1) {
      const routeCoords = [];
      
      itin.days_plan.forEach(day => {
        if (day.night && day.night.coords && Array.isArray(day.night.coords) && day.night.coords.length === 2) {
          routeCoords.push([day.night.coords[0], day.night.coords[1]]);
        }
      });
      
      // Debug: afficher les coordonnées du premier itin pour vérifier
      if (routeCoords.length >= 2 && Math.random() < 0.01) {
        console.log('🗺️ Itinéraire:', itin.title);
        console.log('📍 Coordonnées tracé:', routeCoords);
        console.log('📍 Premier point:', routeCoords[0], 'Dernier:', routeCoords[routeCoords.length-1]);
      }
      
      // Créer le tracé (mais invisible au départ, sera rendu interactif après)
      if (routeCoords.length >= 2) {
        polyline = L.polyline(routeCoords, {
          color: '#00bfff',
          weight: 3,
          opacity: 0,  // Invisible par défaut
          smoothFactor: 1,
          interactive: false  // Non-interactif au départ
        });
        
        // Créer les marqueurs de villes (invisibles au départ) - sur overlaysLayer PAS clusterisé
        routeCoords.forEach((coord, idx) => {
          const cityMarker = L.circleMarker(coord, {
            radius: 5,
            fillColor: '#ffd166',
            color: '#fff',
            weight: 1,
            opacity: 0,  // Invisible par défaut
            fillOpacity: 0
          });
          cityMarker.on('click', () => selectItinerary(itin));
          cityMarker.addTo(overlaysLayer);  // Ajouté à overlaysLayer, pas au cluster
          cityMarkers.push(cityMarker);
        });
        
        polyline.on('mouseover', () => {
  const isSel = selectedItineraries.some(i => i.itin_id === itin.itin_id);
  if (!isSel) {
    polyline.setStyle({ weight: 5, opacity: 0.9 });
    cityMarkers.forEach(cm => cm.setStyle({ opacity: 1, fillOpacity: 0.9 }));
  }
  if (!previewPinned) showPreview(itin);
});

polyline.on('mouseout', () => {
  const isSel = selectedItineraries.some(i => i.itin_id === itin.itin_id);
  polyline.setStyle({ weight: isSel ? 4 : 3, opacity: isSel ? 0.95 : 0 });
  if (!isSel) {
    cityMarkers.forEach(cm => cm.setStyle({ opacity: 0, fillOpacity: 0 }));
  }
});
polyline.on('click', () => {
  previewPinned = true;
  showPreview(itin);
  selectItinerary(itin);
});

        polyline.addTo(overlaysLayer);  // Ajouté à overlaysLayer, pas au cluster
      }
    }
    
    // Calcul du rating moyen de l'itinéraire
    const avgRating = itin.avgRating || 5; // Défaut à 5 si non défini
    const starInfo = ratingToStars(avgRating);
    
    // Marqueur principal au point de départ - étoile ou cercle selon rating
    let marker;
    if (starInfo.isStar) {
      // Étoile pour les incontournables (4★+)
      // Desktop: 52px, Mobile: 64px pour être vraiment visible et plus grand que les ronds
      marker = L.marker([itin.lat, itin.lng], {
        icon: createStarIcon(starInfo.color, window.innerWidth <= 1024 ? 64 : 52)
      });
    } else {
      // Cercle pour les autres
      // Sur mobile/tablette : doubler le radius pour être cliquable
      const isMobile = window.innerWidth <= 1024;
      const radius = isMobile ? starInfo.radius * 2 : starInfo.radius;
      
      marker = L.circleMarker([itin.lat, itin.lng], {
        radius: radius,
        fillColor: starInfo.color,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
      });
    }
    marker.starInfo = starInfo;
    
  marker.on('mouseover', () => {
  const isSel = selectedItineraries.some(i => i.itin_id === itin.itin_id);
  if (!isSel && polyline) {
    polyline.setStyle({ opacity: 0.7 });
    polyline.options.interactive = true;  // Rendre interactif quand visible
  }
  if (!isSel) cityMarkers.forEach(cm => cm.setStyle({ opacity: 1, fillOpacity: 0.9 }));
  if (!previewPinned) showPreview(itin);
});


marker.on('mouseout', () => {
  setTimeout(() => {
    const preview = document.getElementById('itinPreview');
    const isSel = selectedItineraries.some(i => i.itin_id === itin.itin_id);
    const sidebar = document.querySelector('.map-fullscreen-sidebar');
    const sidebarHovered = sidebar && sidebar.matches(':hover');
    // Si épinglé ou sidebar survolée, on ne cache pas
    if (!previewPinned && preview && !preview.matches(':hover') && !sidebarHovered) {
      preview.style.display = 'none';
    }
    if (!isSel) {
      if (polyline) {
        polyline.setStyle({ opacity: 0 });
        polyline.options.interactive = false;  // Désactiver l'interactivité quand invisible
      }
      cityMarkers.forEach(cm => cm.setStyle({ opacity: 0, fillOpacity: 0 }));
    }
  }, 250);
});

marker.on('click', () => {
  if (polyline) polyline.setStyle({ opacity: 0.7 });
  cityMarkers.forEach(cm => cm.setStyle({ opacity: 1, fillOpacity: 0.9 }));
  previewPinned = true;
  
  // Mobile/Tablette : afficher la modale de sélection
  if (window.innerWidth <= 1024) {
    showMobileSelectionModal(itin);
  } else {
    // Desktop : afficher le preview et sélectionner
    showPreview(itin);
    selectItinerary(itin);
  }
});

        marker.addTo(markersLayerFull);

    // NEW: mémoriser les calques pour cet itin (avec starInfo et avgRating pour le zoom progressif)
    itinLayers.set(itin.itin_id, { polyline, cityMarkers, mainMarker: marker, starInfo, avgRating });
  });
  
  updateFilterCount(itineraries.length);
  updateSelectionStyles(); // NEW: réappliquer le rouge après redraw
  
  // Appliquer la visibilité selon le zoom actuel
  updateMarkersVisibility();
}


/* === MAJ : pop-up collé à l'extrême droite + 4 photos des villes === */
// Fonction pour afficher la modale de confirmation mobile (simple)
function showMobileConfirmModal(itin) {
  const modal = document.getElementById('mobileConfirmModal');
  const lang = localStorage.getItem('lang') || 'fr';
  const L = T[lang] || T.fr;
  
  // Titre
  document.getElementById('mobileConfirmTitle').textContent = itin.title;
  
  // Infos courtes
  const starInfo = ratingToStars(itin.avgRating || 5);
  const starsDisplay = '★'.repeat(starInfo.stars) + '☆'.repeat(5 - starInfo.stars);
  
  document.getElementById('mobileConfirmInfo').innerHTML = `
    <div style="color:${starInfo.color};font-size:18px;margin-bottom:8px">${starsDisplay}</div>
    <div><strong>${itin.days}</strong> jours • <strong>${itin.totalDistance}</strong> km</div>
    <div style="margin-top:8px;color:#666">${itin.countryName || ''}</div>
  `;
  
  // Traductions boutons
  document.getElementById('mobileConfirmCancelText').textContent = L.mobileCancelText || 'Annuler';
  document.getElementById('mobileConfirmValidateText').textContent = L.mobileSelectText || 'Valider';
  
  // Afficher
  modal.classList.add('show');
  
  // Handlers
  document.getElementById('mobileConfirmCancel').onclick = () => {
    modal.classList.remove('show');
  };
  
  document.getElementById('mobileConfirmValidate').onclick = () => {
    selectItinerary(itin);
    modal.classList.remove('show');
  };
  
  // Fermer si clic sur fond
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.classList.remove('show');
    }
  };
}

function showMobileSelectionModal(itin) {
  const modal = document.getElementById('mobileSelectionModal');
  const lang = (localStorage.getItem('lang') || 'fr').toLowerCase();
  const L = T[lang] || T.fr;
  
  // Titre
  document.getElementById('mobileModalTitle').textContent = itin.title;
  
  // Rating et étoiles
  const avgRating = itin.avgRating || 5;
  const starInfo = ratingToStars(avgRating);
  const starsDisplay = '★'.repeat(starInfo.stars) + '☆'.repeat(5 - starInfo.stars);
  
  // Infos synthétiques
  const T_DAYS = { fr: 'jours', en: 'days', es: 'días', it: 'giorni', pt: 'dias', ar: 'أيام' };
  const T_STOPS = { fr: 'étapes', en: 'stops', es: 'etapas', it: 'tappe', pt: 'etapas', ar: 'محطات' };
  document.getElementById('mobileModalInfo').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span><strong>${itin.days}</strong> ${T_DAYS[lang] || 'jours'} • <strong>${itin.stops || 0}</strong> ${T_STOPS[lang] || 'étapes'} • <strong>${itin.totalDistance || 0}</strong> km</span>
      <span style="color:${starInfo.color};font-size:18px;">${starsDisplay}</span>
    </div>
  `;
  
  // Photo unique
  const photoList = [];
  const seen = new Set();
  try {
    if (placesPhotosIndex && typeof placesPhotosIndex === 'object') {
      const placeKeys = getPlaceKeysFromItin(itin) || [];
      for (const k of placeKeys) {
        const arr = placesPhotosIndex[k]?.photos;
        if (Array.isArray(arr) && arr[0] && !seen.has(arr[0])) {
          seen.add(arr[0]);
          photoList.push(arr[0]);
          break;
        }
      }
    }
  } catch (err) { }
  
  if (photoList.length < 1 && Array.isArray(itin.photos) && itin.photos[0]) {
    photoList.push(itin.photos[0]);
  }
  
  if (photoList.length > 0) {
    const proxyUrl = `https://wsrv.nl/?url=${encodeURIComponent(photoList[0])}&w=400&h=180&fit=cover&output=webp`;
    document.getElementById('mobileModalPhotos').innerHTML = `<img src="${proxyUrl}" style="width:100%;height:150px;object-fit:cover;border-radius:8px;" alt="Photo">`;
  } else {
    document.getElementById('mobileModalPhotos').innerHTML = '';
  }
  
  // Étapes du parcours
  let stepsHtml = '';
  const T_ROUTE = { fr: 'Parcours', en: 'Route', es: 'Ruta', it: 'Percorso', pt: 'Rota', ar: 'المسار' };
  
  if (Array.isArray(itin.days_plan) && itin.days_plan.length > 0) {
    const cities = [];
    itin.days_plan.forEach(day => {
      if (day?.night?.city && !cities.includes(day.night.city)) {
        cities.push(day.night.city);
      }
    });
    
    if (cities.length > 0) {
      stepsHtml = `<strong>${T_ROUTE[lang] || 'Parcours'}</strong><br>`;
      stepsHtml += `<div style="margin-top:8px;line-height:1.8;">`;
      stepsHtml += cities.map((city, i) => {
        const isLast = i === cities.length - 1;
        return `<span style="display:inline-block;padding:4px 10px;background:#f3f4f6;border-radius:12px;margin:2px 4px 2px 0;font-size:13px;">${city}</span>${isLast ? '' : '→'}`;
      }).join(' ');
      stepsHtml += `</div>`;
    }
  } else if (Array.isArray(itin.cities) && itin.cities.length > 0) {
    stepsHtml = `<strong>${T_ROUTE[lang] || 'Parcours'}</strong><br>`;
    stepsHtml += `<div style="margin-top:8px;line-height:1.8;">`;
    stepsHtml += itin.cities.map((city, i) => {
      const isLast = i === itin.cities.length - 1;
      return `<span style="display:inline-block;padding:4px 10px;background:#f3f4f6;border-radius:12px;margin:2px 4px 2px 0;font-size:13px;">${city}</span>${isLast ? '' : '→'}`;
    }).join(' ');
    stepsHtml += `</div>`;
  }
  
  document.getElementById('mobileModalSteps').innerHTML = stepsHtml;
  
  // Afficher la modale
  modal.classList.add('show');
  
  // Handlers
  document.getElementById('mobileModalSelect').onclick = () => {
    selectItinerary(itin);
    modal.classList.remove('show');
  };
  
  document.getElementById('mobileModalCancel').onclick = () => {
    modal.classList.remove('show');
  };
  
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.classList.remove('show');
    }
  };
}


function showPreview(itin) {
  const preview = document.getElementById('itinPreview');
  // Force le scroll de la sidebar en haut pour éviter le bug d'ancrage
  const sidebar = document.querySelector('.map-fullscreen-sidebar');
  if (sidebar) sidebar.scrollTop = 0;
  
  const lang = (localStorage.getItem('lang') || 'fr').toLowerCase();
  const T_MAP = {
    fr: { days: 'jours', km: 'km', cities: 'Villes traversées :' },
    en: { days: 'days', km: 'km', cities: 'Cities:' },
    it: { days: 'giorni', km: 'km', cities: 'Città:' },
    es: { days: 'días', km: 'km', cities: 'Ciudades:' },
    pt: { days: 'dias', km: 'km', cities: 'Cidades:' },
    ar: { days: 'أيام', km: 'كم', cities: 'المدن:' }
  };
  const t = T_MAP[lang] || T_MAP.fr;

  // Rating et étoiles
  const avgRating = itin.avgRating || 5;
  const starInfo = ratingToStars(avgRating);
  const starsDisplay = '★'.repeat(starInfo.stars) + '☆'.repeat(5 - starInfo.stars);

  // Labels traduits pour stops
  const T_STOPS = { fr: 'étapes', en: 'stops', it: 'tappe', es: 'etapas', pt: 'etapas', ar: 'محطات' };
  const stopsLabel = T_STOPS[lang] || T_STOPS.fr;

  // Titre + infos synthétiques
  document.getElementById('previewTitle').textContent = itin.title;
  document.getElementById('previewInfo').innerHTML = `
    <div><strong>${itin.days}</strong> ${t.days} • <strong>${itin.stops || 0}</strong> ${stopsLabel} • <strong>${itin.totalDistance}</strong> ${t.km}</div>
    <div>${itin.dept_name || itin.countryName}</div>
    <div style="color:${starInfo.color}; font-size:16px; font-weight:600; margin-top:4px">${starsDisplay}</div>
  `;


  // Photo : 1 seule pour chargement rapide
  let firstPhoto = null;
  try {
    if (placesPhotosIndex && typeof placesPhotosIndex === 'object') {
      const placeKeys = getPlaceKeysFromItin(itin) || [];
      for (const k of placeKeys) {
        const arr = placesPhotosIndex[k]?.photos;
        if (Array.isArray(arr) && arr[0]) { firstPhoto = arr[0]; break; }
      }
    }
  } catch (err) { console.warn('⚠️ Erreur photo:', err); }

  // Fallback
  if (!firstPhoto && Array.isArray(itin.photos) && itin.photos[0]) {
    firstPhoto = itin.photos[0];
  }

  // Bloc villes + photo unique
  let citiesHtml = `<strong>${t.cities}</strong><br>${(itin.cities||[]).join(' → ')}`;
  if (firstPhoto && typeof firstPhoto === 'string' && !firstPhoto.includes('${')) {
    const proxyUrl = `https://wsrv.nl/?url=${encodeURIComponent(firstPhoto)}&w=400&h=200&fit=cover&output=webp`;
    citiesHtml += `<div style="margin-top:10px;"><img src="${proxyUrl}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;" alt="Photo" loading="lazy"></div>`;
  }
  document.getElementById('previewCities').innerHTML = citiesHtml;


  // Parcours simplifié
  const pathSimplified = document.getElementById('previewPathSimplified');
  const pathFlow = document.getElementById('previewPathFlow');
  if (Array.isArray(itin.days_plan) && itin.days_plan.length > 1) {
    const simplifiedCities = [];
    itin.days_plan.forEach(day => { if (day?.night?.city) simplifiedCities.push(day.night.city); });
    if (simplifiedCities.length >= 2) {
      pathFlow.innerHTML = '';
      simplifiedCities.forEach((city, idx) => {
        const node = document.createElement('span');
        node.className = 'city-node';
        node.textContent = city;
        pathFlow.appendChild(node);
        if (idx < simplifiedCities.length - 1) {
          const arrow = document.createElement('span');
          arrow.className = 'arrow';
          arrow.textContent = '→';
          pathFlow.appendChild(arrow);
        }
      });
      pathSimplified.style.display = 'block';
    } else {
      pathSimplified.style.display = 'none';
    }
  } else {
    pathSimplified.style.display = 'none';
  }

  // Bouton "Sélectionner"
  document.getElementById('previewSelectBtn').onclick = () => { selectItinerary(itin); closeItinPreview(); };

  // Barre mobile : afficher et attacher les handlers
  const mobileBar = document.getElementById('mobileActionBar');
  const mobileBtnText = document.getElementById('selectItinBtnMobileText');
  const mobileCancelBtnText = document.getElementById('mobileCancelBtnText');
  
  if (mobileBar && window.innerWidth <= 1024) {
    // Mettre à jour les textes (i18n)
    const lang = localStorage.getItem('lang') || 'fr';
    const L = T[lang] || T.fr;
    if (mobileBtnText) mobileBtnText.textContent = L.selectBtnText || 'Valider';
    if (mobileCancelBtnText) mobileCancelBtnText.textContent = L.cancelBtnText || 'Annuler';
    
    // Afficher la barre
    mobileBar.style.display = 'flex';
    
    // Handler du bouton Valider
    const mobileBtn = document.getElementById('selectItinBtnMobile');
    if (mobileBtn) {
      mobileBtn.onclick = () => {
        selectItinerary(itin);
        mobileBar.style.display = 'none';
        closeItinPreview();
      };
    }
    
    // Handler du bouton Annuler
    const mobileCancelBtn = document.getElementById('mobileCancelBtn');
    if (mobileCancelBtn) {
      mobileCancelBtn.onclick = () => {
        mobileBar.style.display = 'none';
        closeItinPreview();
      };
    }
  }

  // Afficher dans la sidebar (géré par .in-sidebar)
  preview.style.display = 'block';
  
  // Animation d'apparition sur mobile
  if (window.innerWidth <= 1024) {
    preview.style.opacity = '0';
    preview.style.transform = 'translateY(100%)';
    setTimeout(() => {
      preview.style.transition = 'all 0.3s ease-out';
      preview.style.opacity = '1';
      preview.style.transform = 'translateY(0)';
    }, 10);
  }
}

/* === FIN MAJ === */

/* === FIN MAJ === */

// NEW: applique le style "sélectionné = rouge" sur la carte
function updateSelectionStyles(){
  const selIds = new Set(selectedItineraries.map(i => i.itin_id));
  itinLayers.forEach(({ polyline, cityMarkers = [], mainMarker, starInfo }, id) => {
    const isSel = selIds.has(id);
    // Couleur par défaut si starInfo absent
    const defaultColor = starInfo ? starInfo.color : '#94a3b8';
    const defaultRadius = starInfo ? starInfo.radius : 8;
    
    if (polyline) {
      polyline.setStyle({
        color:  isSel ? '#e11d48' : '#00bfff',
        weight: isSel ? 4 : 3,
        opacity:isSel ? 0.95 : 0
      });
    }
    (cityMarkers || []).forEach(cm => {
      if (!cm) return;
      cm.setStyle({
        color:'#fff',
        fillColor: isSel ? '#e11d48' : '#ffd166',
        weight:1,
        opacity:    isSel ? 1    : 0,
        fillOpacity:isSel ? 0.95 : 0
      });
    });
    // Gérer les marqueurs : étoile ou cercle
    if (mainMarker) {
      if (starInfo && starInfo.isStar) {
        // Pour les étoiles, changer l'icône
        mainMarker.setIcon(createStarIcon(isSel ? '#e11d48' : defaultColor, isSel ? 28 : 24, isSel));
      } else if (mainMarker.setStyle) {
        // Pour les cercles, utiliser setStyle
        mainMarker.setStyle({ 
          fillColor: isSel ? '#e11d48' : defaultColor,
          radius: isSel ? defaultRadius + 4 : defaultRadius  // Grossit si sélectionné
        });
      }
    }
  });
}


// Valider la sélection et passer à l'étape suivante (modale budget)
function validateAndContinue() {
  if (selectedItineraries.length === 0) {
    const lang = localStorage.getItem('lang') || 'fr';
    const L = T[lang] || T.fr;
    alert(L.alertNoSelection || 'Veuillez sélectionner au moins un itinéraire');
    return;
  }
  
  const lang = localStorage.getItem('lang') || 'fr';
  const mode = localStorage.getItem('tripMode') || 'expert';
  const totalDays = selectedItineraries.reduce((sum, itin) => sum + (itin.days || 7), 0);
  const firstTitle = selectedItineraries[0]?.title || 'Voyage';
  
  // Ouvrir la modale budget avec callback de redirection
  showBudgetModal((config) => {
    const budget = config.budget || '50-100';
    
    if (selectedItineraries.length === 1) {
      // 1 seul itinéraire
      const id = selectedItineraries[0].itin_id;
      const cc = (id.split('::')[0] || '').toUpperCase();
      window.location.href = `roadtrip_detail.html?cc=${cc}&itin=${encodeURIComponent(id)}&lang=${lang}&mode=${mode}&budget=${budget}`;
    } else {
      // 2-3 itinéraires -> fusion COMPOSED
      const ids = selectedItineraries.map(i => i.itin_id);
      const cc = (ids[0].split('::')[0] || '').toUpperCase();
      const composed = `COMPOSED::${ids.join('+')}`;
      window.location.href = `roadtrip_detail.html?cc=${cc}&itin=${encodeURIComponent(composed)}&lang=${lang}&mode=${mode}&budget=${budget}`;
    }
  }, totalDays, firstTitle);
}


// Ajouter un itinéraire complémentaire proche
function addMoreItinerary() {
  const lang = localStorage.getItem('lang') || 'fr';
  const L = T[lang] || T.fr;
  const mode = localStorage.getItem('tripMode') || 'expert';
  
  if (mode === 'simple') {
    alert(L.alertSimpleModeOneOnly || 'En mode simple, un seul itinéraire.');
    return;
  }
  
  if (selectedItineraries.length >= MAX_SELECTION) {
    alert(L.alertMaxSelection || 'Vous avez atteint le maximum de sélections.');
    return;
  }
  
  // Fermer le preview et laisser choisir un autre itin
  closeItinPreview();
  alert(L.alertSelectAnother || 'Choisissez un autre itinéraire sur la carte.');
}

function selectItinerary(itin) {

  const lang = localStorage.getItem('lang') || 'fr';
  const L_TEXT = T[lang] || T.fr;
  
  if (selectedItineraries.find(i => i.itin_id === itin.itin_id)) {
    alert(L_TEXT.alertAlreadySelected);
    return;
  }
  if (selectedItineraries.length >= MAX_SELECTION) {
    const mode = localStorage.getItem('tripMode') || 'expert';
    const alertMsg = (mode === 'simple') ? L_TEXT.alertMaxSelectionSimple : L_TEXT.alertMaxSelection;
    alert(alertMsg);
    return;
  }
   selectedItineraries.push(itin);
  updateSelectionPanel();
  updateSelectionStyles();
  // Ne pas cacher la preview - garder visible pour confirmer le choix
  previewPinned = true;
  const p = document.getElementById('itinPreview');
  if (p) {
    p.style.display = 'block';
    p.style.visibility = 'visible';
    p.style.opacity = '1';
  }
}


window.removeFromSelection = function(itinId) {
  selectedItineraries = selectedItineraries.filter(i => i.itin_id !== itinId);
  updateSelectionPanel();
  updateSelectionStyles();
  // Réinitialiser l'état de la preview pour permettre de nouveaux survols
  previewPinned = false;
  const preview = document.getElementById('itinPreview');
  if (preview) preview.style.display = 'none';
};

function updateSelectionPanel() {
  const banner = document.getElementById('selectionBanner');
  const items = document.getElementById('selectionBannerItems');
  const btnContinue = document.getElementById('btnContinueSelection');
  
  if (!banner || !items) return;
  
  if (selectedItineraries.length > 0) {
    banner.style.display = 'block';
    items.innerHTML = selectedItineraries.map(itin => {
      const shortTitle = itin.title.length > 25 ? itin.title.substring(0, 25) + '...' : itin.title;
      return `<div style="display:inline-flex;align-items:center;background:rgba(255,255,255,0.2);padding:6px 12px;border-radius:20px;color:#fff;font-size:13px;">
        <span>${shortTitle}</span>
        <button onclick="removeFromSelection('${itin.itin_id}')" style="background:none;border:none;color:#fff;margin-left:8px;cursor:pointer;font-size:14px;opacity:0.8;">✕</button>
      </div>`;
    }).join('');
    
    const lang = localStorage.getItem('lang') || 'fr';
    const L = T[lang] || T.fr;
    btnContinue.textContent = (L.continueBtn || 'Continuer') + ' →';
  } else {
    banner.style.display = 'none';
  }
}


// Fonction modal configuration voyage
function showBudgetModal(callback, itinDays, itinTitle) {
  const lang = localStorage.getItem('lang') || 'fr';
  const L = T[lang] || T.fr;
  const modal = document.getElementById('budgetModal');
  
  // Traductions
  document.getElementById('budgetModalTitle').textContent = L.modal_title || 'Configurez votre voyage';
  document.getElementById('labelDepartureDate').textContent = L.modal_departure_date || 'Date de départ :';
  document.getElementById('labelNumDays').textContent = L.modal_num_days || 'Nombre de jours souhaités :';
  document.getElementById('labelBudget').textContent = L.modal_budget_label || 'Budget hôtel (€/jour/personne) :';
  document.getElementById('budgetConfirm').textContent = L.budget_confirm || 'Valider';
  document.getElementById('budgetCancel').textContent = L.budget_cancel || 'Annuler';
  
  // Initialiser la date à aujourd'hui
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('inputDepartureDate').value = today;
  
  // Initialiser le nombre de jours (depuis l'itinéraire ou défaut 7)
  const numDaysInput = document.getElementById('inputNumDays');
  numDaysInput.value = itinDays || 7;
  
  // Générer les checkboxes budget (multichoix)
  const budgetCheckboxes = document.getElementById('budgetCheckboxes');
  const budgetRanges = ['0-50', '50-100', '100-150', '150-200', '200-250', '250-300', '300-500', '500+'];
  const budgetLabels = {
    '0-50': L.budget_0_50 || '0-50',
    '50-100': L.budget_50_100 || '50-100',
    '100-150': L.budget_100_150 || '100-150',
    '150-200': L.budget_150_200 || '150-200',
    '200-250': L.budget_200_250 || '200-250',
    '250-300': L.budget_250_300 || '250-300',
    '300-500': L.budget_300_500 || '300-500',
    '500+': L.budget_500plus || '500+'
  };
  
  budgetCheckboxes.innerHTML = '';
  budgetRanges.forEach((range, idx) => {
    const label = document.createElement('label');
    label.style.cssText = 'display:flex;align-items:center;gap:4px;cursor:pointer;background:#fff;padding:6px 10px;border-radius:6px;border:1px solid #113f7a;';
    label.innerHTML = `
      <input type="checkbox" name="budgetCheckbox" value="${range}" ${idx === 1 ? 'checked' : ''}>
      <span style="color:#113f7a;">${budgetLabels[range]}</span>
    `;
    budgetCheckboxes.appendChild(label);
  });
  
  // Afficher modal
  modal.classList.add('show');
  
  // Bouton Confirmer
  const confirmHandler = () => {
    modal.classList.remove('show');
    document.getElementById('budgetConfirm').removeEventListener('click', confirmHandler);
    document.getElementById('budgetCancel').removeEventListener('click', cancelHandler);
    modal.removeEventListener('click', overlayHandler);
    
    // Récupérer toutes les valeurs
    const departureDate = document.getElementById('inputDepartureDate').value;
    const numDays = document.getElementById('inputNumDays').value;
    
    // Récupérer tous les budgets cochés
    const checkedBudgets = Array.from(document.querySelectorAll('input[name="budgetCheckbox"]:checked'))
      .map(cb => cb.value);
    const budget = checkedBudgets.length > 0 ? checkedBudgets.join(',') : '50-100';
    
    callback({ departureDate, numDays, budget });
  };
  
  // Bouton Annuler
  const cancelHandler = () => {
    modal.classList.remove('show');
    document.getElementById('budgetConfirm').removeEventListener('click', confirmHandler);
    document.getElementById('budgetCancel').removeEventListener('click', cancelHandler);
    modal.removeEventListener('click', overlayHandler);
  };
  
  // Clic overlay
  const overlayHandler = (e) => {
    if (e.target === modal) cancelHandler();
  };
  
  document.getElementById('budgetConfirm').addEventListener('click', confirmHandler);
  document.getElementById('budgetCancel').addEventListener('click', cancelHandler);
  modal.addEventListener('click', overlayHandler);
}

document.getElementById('btnValidateSelection')?.addEventListener('click', () => {
  if (selectedItineraries.length === 0) return;
  const lang = (localStorage.getItem('lang') || 'fr').toLowerCase();
  const mode = localStorage.getItem('tripMode') || 'expert';

  // 1 seul RT → détail direct
  if (selectedItineraries.length === 1) {
    const itin = selectedItineraries[0];
    const id = itin.itin_id;
    const cc = (id.split('::')[0] || '').toUpperCase();
    const itinDays = itin.days || 7;
    const itinTitle = itin.title || '';
    
    // Afficher popup configuration
    showBudgetModal((config) => {
      const params = new URLSearchParams({
        cc: cc,
        itin: id,
        lang: lang,
        mode: mode,
        departure: config.departureDate,
        days: config.numDays,
        budget: config.budget
      });
      window.location.href = `roadtrip_detail.html?${params.toString()}`;
    }, itinDays, itinTitle);
    return;
  }

  // 2–3 RT → fusion COMPOSED
  const ids = selectedItineraries.map(i => i.itin_id);
  const titles = selectedItineraries.map(i => i.title).join(' + ');
  const cc  = (ids[0].split('::')[0] || '').toUpperCase();
  const composed = `COMPOSED::${ids.join('+')}`;
  const totalDays = selectedItineraries.reduce((sum, i) => sum + (i.days || 0), 0) || 7;
  
  // Afficher popup configuration
  showBudgetModal((config) => {
    const params = new URLSearchParams({
      cc: cc,
      itin: composed,
      lang: lang,
      mode: mode,
      departure: config.departureDate,
      days: config.numDays,
      budget: config.budget
    });
    window.location.href = `roadtrip_detail.html?${params.toString()}`;
  }, totalDays, titles);
});


function updateFilterCount(count) {
  const lang = localStorage.getItem('lang') || 'fr';
  const L_TEXT = T[lang] || T.fr;
  
  // Mise à jour du compteur dans la sidebar
  const text = count === 1 ? L_TEXT.filterCount_single : L_TEXT.filterCount_plural;
  document.getElementById('filterCountFull').textContent = `${count} ${text}`;
  
  // Mise à jour du compteur dans le header
  updateVisibleItinsCount(count);
}

/* ===== THEME REGISTRY (13 thèmes Excel + "tested-ort") =====
 /*
   THEMES_REG et THEMES_LABELS chargés dynamiquement depuis themes.i18n.json
   Ne plus éditer manuellement - utiliser l'outil admin pour gérer les thèmes
*/
let THEMES_REG = {};
let THEMES_LABELS = {};
let THEMES_DATA = null;

/* Charge themes.i18n.json et construit THEMES_REG dynamiquement */
async function loadThemes() {
  try {
    // Tenter plusieurs chemins possibles
const paths = [
  'data/Roadtripsprefabriques/countries/themes.i18n.json',
  './data/Roadtripsprefabriques/countries/themes.i18n.json',
  '/data/Roadtripsprefabriques/countries/themes.i18n.json',
  'Roadtripsprefabriques/countries/themes.i18n.json',
  '../Roadtripsprefabriques/countries/themes.i18n.json'
];

let response = null;
for (const path of paths) {
  try {
    const res = await fetch(path);
    if (res.ok) {
      response = res;
      console.log(`✅ themes.i18n.json trouvé: ${path}`);
      break;
    }
  } catch (err) {
    console.warn(`Tentative ${path} échouée`);
  }
}

if (!response) {
  console.warn('⚠️ themes.i18n.json non trouvé, utilisation du fallback hardcodé');
  return buildFallbackThemes();
}
    
 
    
    THEMES_DATA = await response.json();
    
    // Construction de THEMES_REG depuis le JSON
    THEMES_REG = {};
    THEMES_LABELS = {};
    
    for (const theme of THEMES_DATA.themes) {
      THEMES_REG[theme.key] = theme.synonyms || [];
      THEMES_LABELS[theme.key] = theme.label_fr;
    }
    
    console.log('✅ Thèmes chargés depuis themes.i18n.json:', Object.keys(THEMES_REG).length, 'thèmes');
    
    // Générer les options du select
    populateThemeSelect();
    
  } catch (error) {
    console.error('❌ Erreur chargement themes.i18n.json:', error);
    buildFallbackThemes();
  }
}

/* Génère les <option> du select depuis THEMES_DATA */
function populateThemeSelect(lang) {
  const select = document.getElementById('filterThemeFull');
  if (!select || !THEMES_DATA) return;
  
  const currentLang = lang || localStorage.getItem('lang') || document.documentElement.lang || 'fr';
  
  // Sauvegarder la valeur sélectionnée
  const currentValue = select.value;
  
// Garder l'option "Tous" avec traduction
select.innerHTML = '';
const allOption = document.createElement('option');
allOption.value = '';

// Utiliser les traductions i18n si disponibles
const translations = {
  fr: 'Tous',
  en: 'All', 
  it: 'Tutti',
  es: 'Todos',
  pt: 'Todos',
  ar: 'الكل'
};
allOption.textContent = translations[currentLang] || 'Tous';
select.appendChild(allOption);
  
  // Trier par ordre
  const sortedThemes = [...THEMES_DATA.themes].sort((a, b) => (a.order || 0) - (b.order || 0));
  
  for (const theme of sortedThemes) {
    const option = document.createElement('option');
    option.value = theme.key;
    option.textContent = theme.i18n[currentLang] || theme.label_fr;
    select.appendChild(option);
  }
  
  // Restaurer la valeur sélectionnée
  if (currentValue) select.value = currentValue;
}

/* Fallback si themes.i18n.json indisponible */
function buildFallbackThemes() {
  THEMES_REG = {
    "montagne": ["montagne","mountain","alp","alpes","massif","sommet","col"],
    "mer-cotes": ["mer","côte","cotes","côtes","coast","sea","plage","riviera","shore"],
    "ville-histoire": ["ville","city","cité","histoire","historic","heritage","old town","centro storico","casco antiguo"],
    "nature": ["nature","parc","réserve","reserve","forêt","foret","forest","lac","lake","cascade","waterfall","valley","canyon"],
    "culture": ["culture","musée","museum","monument","architecture","patrimoine","unesco","art"],
    "gastronomie-vin": ["gastronomie","vin","wine","food","culinaire","oenologie","œnologie","bodega","cantina"],
    "aventure-outdoor": ["aventure","adventure","trek","randonnée","randonnee","hike","trail","kayak","rafting","via ferrata","bivouac"],
    "route-exploration": ["route","roadtrip","exploration","panoramique","scenic","drive","col routier"],
    "insolite-hors-sentiers": ["insolite","hors sentiers","offbeat","unusual","secret","hidden","alternatif","alternativo"],
    "faune-vie-sauvage": ["faune","sauvage","wildlife","animaux","birdwatching","safari"],
    "spiritualite-religion": ["spiritualité","spiritualite","religion","sanctuaire","abbaye","monastère","temple","shrine","church","ermitage"],
    "bien-etre-detente": ["bien-être","bien etre","spa","thermal","onsen","wellness","relax","balnéo","balneario","terme"],
    "detente": ["détente","detente","relax","loisirs","plaisir"],
    "tested-ort": []
  };
  
  THEMES_LABELS = {
    "montagne":"Montagne","mer-cotes":"Mer & Côtes","ville-histoire":"Ville & Histoire",
    "nature":"Nature","culture":"Culture","gastronomie-vin":"Gastronomie & Vin",
    "aventure-outdoor":"Aventure & Outdoor","route-exploration":"Route & Exploration",
    "insolite-hors-sentiers":"Insolite & Hors sentiers battus","faune-vie-sauvage":"Faune & Vie sauvage",
    "spiritualite-religion":"Spiritualité & Religion","bien-etre-detente":"Bien-être & Détente",
    "detente":"Détente","tested-ort":"Testé & approuvé ORT"
  };
  
  console.log('⚠️ Utilisation du fallback hardcodé pour les thèmes');
}

/* Normalise des tokens "thème" depuis plusieurs champs d’un itin */
function getItinThemeTokens(i){
  const acc = new Set();
  const push = (v)=>{
    if(!v) return;
    if(Array.isArray(v)){ v.forEach(push); return; }
    String(v).split(/[|,;/]/).forEach(s=>{
      const t = s.trim().toLowerCase();
      if(t) acc.add(t);
    });
  };
  push(i.themes);
  push(i.tags);
  push(i.categories);
  push(i?.meta?.themes);
  if (i.title) {
    String(i.title).toLowerCase().split(/[^\p{L}\p{N}]+/u).forEach(w=>{
      if(w && w.length>=3) acc.add(w);
    });
  }
  return acc;
}

/* Correspondance sélecteur -> données itin */
/* Correspondance sélecteur -> données itin */
function matchesTheme(itin, themeKey){
  if (themeKey === "tested-ort") {
    return !!(itin.tested || itin.verifiedByORT || itin?.meta?.tested === true);
  }
  const tokens = getItinThemeTokens(itin);
  const syn = THEMES_REG[themeKey] || [];

  // 1) match exact (tokens)
  for (const s of syn) if (tokens.has(s)) return true;

  // 2) match "contains" souple
  for (const s of syn) for (const t of tokens) if (t.includes(s)) return true;

  // 3) si i.themes textuel contient le libellé FR (depuis THEMES_LABELS dynamique)
  if (itin.themes && typeof itin.themes === 'string') {
    const labelFR = THEMES_LABELS[themeKey];
    if (labelFR && itin.themes.toLowerCase().includes(labelFR.toLowerCase())) return true;
  }
  return false;
}

function applyFilters() {
 
  const daysFilter = document.getElementById('filterDaysFull').value;
  /* désactivation temporaire */
  const distanceFilter = '';
  const countryFilter  = '';
  const regionFilter   = '';
  /* -- */
  const themeFilter    = document.getElementById('filterThemeFull').value;
  const searchText     = document.getElementById('searchItinFull').value.toLowerCase();
  
  let filtered = allItineraries;
  
  if (daysFilter) {
    if (daysFilter === '1-3') filtered = filtered.filter(i => i.days >= 1 && i.days <= 3);
    else if (daysFilter === '4-7') filtered = filtered.filter(i => i.days >= 4 && i.days <= 7);
    else if (daysFilter === '8-14') filtered = filtered.filter(i => i.days >= 8 && i.days <= 14);
    else if (daysFilter === '15+') filtered = filtered.filter(i => i.days >= 15);
  }
  
  if (distanceFilter) {
    if (distanceFilter === '0-500') filtered = filtered.filter(i => i.totalDistance >= 0 && i.totalDistance <= 500);
    else if (distanceFilter === '501-1000') filtered = filtered.filter(i => i.totalDistance >= 501 && i.totalDistance <= 1000);
    else if (distanceFilter === '1001-2000') filtered = filtered.filter(i => i.totalDistance >= 1001 && i.totalDistance <= 2000);
    else if (distanceFilter === '2001+') filtered = filtered.filter(i => i.totalDistance >= 2001);
  }
  
  if (countryFilter) filtered = filtered.filter(i => i.countryName === countryFilter);
  if (regionFilter)  filtered = filtered.filter(i => i.dept_name === regionFilter);

  if (themeFilter) {
    const key = themeFilter.toLowerCase();
    const beforeFilter = filtered.length;
    filtered = filtered.filter(i => matchesTheme(i, key));
    console.log(`🔍 Filtre thème "${key}": ${beforeFilter} itins → ${filtered.length} itins matchent`);
  }

  if (searchText) {
    filtered = filtered.filter(i => 
      (i.title || '').toLowerCase().includes(searchText) ||
      (i.dept_name || '').toLowerCase().includes(searchText) ||
      i.cities.some(city => city.toLowerCase().includes(searchText))
    );
  }
  
  console.log(`📊 Total filtré: ${filtered.length} itinéraires`);
  displayMarkers(filtered);
  
  // Appliquer aussi la visibilité selon le zoom actuel
  // Cela mettra à jour le compteur avec le nombre réellement visible
  if (mapFull) {
    updateMarkersVisibility();
  }
  
  if (filtered.length > 0 && mapFull) {
    const bounds = L.latLngBounds(filtered.map(i => [i.lat, i.lng]));
    mapFull.fitBounds(bounds, { padding: [50, 50] });
  }
}

// Fonction pour mettre à jour le compteur d'itinéraires visibles
function updateVisibleItinsCount(count) {
  const countEl = document.getElementById('visibleItinsCount');
  if (!countEl) return;
  
  // Afficher seulement le nombre
  countEl.textContent = count;
}


document.getElementById('filterDaysFull')?.addEventListener('change', applyFilters);
/* désactivation temporaire
document.getElementById('filterDistanceFull')?.addEventListener('change', applyFilters);
document.getElementById('filterCountryFull')?.addEventListener('change', applyFilters);
document.getElementById('filterRegionFull')?.addEventListener('change', applyFilters);
*/
document.getElementById('filterThemeFull')?.addEventListener('change', applyFilters);
document.getElementById('searchItinFull')?.addEventListener('input',  applyFilters);

document.getElementById('btnResetFiltersFull')?.addEventListener('click', () => {
  document.getElementById('filterDaysFull').value = '';
  document.getElementById('filterDistanceFull').value = '';
  document.getElementById('filterCountryFull').value = '';
  document.getElementById('filterRegionFull').value = '';
  document.getElementById('filterThemeFull').value = '';
  document.getElementById('searchItinFull').value = '';
  displayMarkers(allItineraries);
  if (mapFull) mapFull.setView([46.0, 8.0], 4);
});



/* ===== Auto-lang (default EN) ===== */
(function(){
  const SUP=["fr","en","it","es","pt","ar"];
  let lang = new URLSearchParams(location.search).get('lang')
           || localStorage.getItem('lang')
           || (navigator.languages && navigator.languages[0]) || navigator.language || 'en';
  lang = (lang||'en').slice(0,2).toLowerCase();
  if(!SUP.includes(lang)) lang='en';
  localStorage.setItem('lang',lang);

  // Détection du mode (simple ou expert)
  const urlParams = new URLSearchParams(location.search);
  let mode = urlParams.get('mode') || localStorage.getItem('tripMode') || 'expert';
  if(mode !== 'simple' && mode !== 'expert') mode = 'expert';
  localStorage.setItem('tripMode', mode);

  document.documentElement.lang=lang;
  document.documentElement.dir=(lang==='ar')?'rtl':'ltr';
  document.body.classList.add(`mode-${mode}`);
  const L=T[lang]||T.en;

  // Header
  const openAuthEl = document.getElementById('openAuth'); if (openAuthEl) openAuthEl.textContent=L.login;
  const sel=document.getElementById('langSel'); sel.value=lang;
  document.getElementById('homeLink').addEventListener('click',e=>{
    e.preventDefault(); const u=new URL('index.html', location.href); u.searchParams.set('lang', lang); location.href=u.toString();
  });
  sel.addEventListener('change',e=>{
    const code=e.target.value; localStorage.setItem('lang',code);
    const u=new URL(location.href); u.searchParams.set('lang',code); location.replace(u.toString());
  });

  // Badge mode - insérer dans modeBadge existant
  const modeBadgeEl = document.getElementById('modeBadge');
  if (modeBadgeEl) {
    modeBadgeEl.className = 'mode-badge ' + mode;
    modeBadgeEl.textContent = (mode === 'simple') ? L.badge_mode_simple : L.badge_mode_expert;
    modeBadgeEl.style.display = 'inline-block';
  }

  // Helper pour setter le textContent en sécurité
  const setTextById = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
  const setPlaceholderById = (id, text) => { const el = document.getElementById(id); if (el) el.placeholder = text; };
  // Map section
  setTextById('mapTitle',L.mapTitle);
  setTextById('mapTitleFull',L.mapTitle);
  setTextById('closeBtnText',L.closeBtnText);
  setTextById('backBtnText',L.backBtnText);
  setTextById('filterTitle',L.filterTitle);
  setTextById('filtersBtnText',L.filtersBtnText);
  setTextById('labelDaysFull',L.labelDays);
  setTextById('labelDistanceFull',L.labelDistance);
  setTextById('labelCountryFull',L.labelCountry);
  setTextById('labelRegionFull',L.labelRegion);
  setTextById('labelThemeFull',L.labelTheme);
  setTextById('labelSearchFull',L.labelSearch);
  setPlaceholderById('searchItinFull', L.searchPlaceholder);
  setTextById('btnResetFiltersFull',L.btnReset);
  
  // Légende de la carte
  setTextById('legendTitle',L.legend_title || 'Itinéraires');
  setTextById('legendIncontournable',L.legend_incontournable || 'Incontournable');
  setTextById('legendRecommande',L.legend_recommande || 'Recommandé');
  setTextById('legendDecouvrir',L.legend_decouvrir || 'À découvrir');
  setTextById('legendStandard',L.legend_standard || 'Standard');
  setTextById('legendSelected',L.legend_selected || 'Sélectionné');
  
  // Mise à jour selon le mode
  MAX_SELECTION = (mode === 'simple') ? 1 : 3;
  setTextById('selectionTitle', (mode === 'simple') ? L.selectionTitleSimple : L.selectionTitleExpert);
  
  setTextById('btnValidateSelection',L.compareBtn);
  setTextById('previewSelectBtn',L.selectBtnText);
  
  // Mettre à jour les options des filtres
  const filterDays = document.getElementById('filterDaysFull');
  filterDays.options[0].text = L.filterAllDays;
  filterDays.options[1].text = L.filter_days_1_3;
  filterDays.options[2].text = L.filter_days_4_7;
  filterDays.options[3].text = L.filter_days_8_14;
  filterDays.options[4].text = L.filter_days_15plus;
  
  const filterDist = document.getElementById('filterDistanceFull');
  filterDist.options[0].text = L.filterAllDistances;
  filterDist.options[1].text = L.filter_dist_0_500;
  filterDist.options[2].text = L.filter_dist_501_1000;
  filterDist.options[3].text = L.filter_dist_1001_2000;
  filterDist.options[4].text = L.filter_dist_2001plus;
  
 // Les thèmes sont maintenant traduits automatiquement lors de populateThemeSelect()
// On traduit l'option "Tous" ET on régénère les thèmes avec la bonne langue
const filterTheme = document.getElementById('filterThemeFull');
if (filterTheme && filterTheme.options[0]) {
  filterTheme.options[0].text = L.filterAllThemes;
}

// Régénérer les options de thèmes avec la bonne langue
if (typeof populateThemeSelect === 'function' && typeof THEMES_DATA !== 'undefined' && THEMES_DATA) {
  populateThemeSelect(lang);
  // Re-traduire "Tous" après la régénération
  if (filterTheme && filterTheme.options[0]) {
    filterTheme.options[0].text = L.filterAllThemes;
  }
}

  // Toggle filtres mobile
  document.getElementById('toggleFiltersMobile')?.addEventListener('click', () => {
    const sidebar = document.querySelector('.map-fullscreen-sidebar');
    sidebar.classList.toggle('show');
  });

  // Fermer la sidebar si on clique sur la carte (mobile)
  document.getElementById('mapContainerFull')?.addEventListener('click', () => {
    if (window.innerWidth <= 1024) {
      const sidebar = document.querySelector('.map-fullscreen-sidebar');
      sidebar.classList.remove('show');
    }
  });

  // Titles & lists
  setTextById('title',L.title);

setTextById('leftTitle',L.left_title);
  setTextById('rightTitle',L.right_title);
  setTextById('creatorsTitle2',L.creatorsTitle);
  setTextById('becomeCreatorLink',L.become_creator);
  setTextById('becomeCreator',L.becomeCreator);
  setTextById('buildTitle',L.buildTitle);
  setTextById('importTitle',L.importTitle);
  setTextById('routeBuilderTitle',L.routeBuilderTitle);
  setTextById('labelStartCity',L.labelStartCity);
  setTextById('labelEndCity',L.labelEndCity);
  setTextById('labelMaxKm',L.labelMaxKm);
  setTextById('labelDuration',L.labelDuration);
  setTextById('generateBtnText',L.generateBtn);
  setTextById('labelDetour',L.labelDetour);
  setTextById('labelDays',L.labelDaysUnit);

  // Placeholders route builder
  const inputStart = document.getElementById('inputStartCity');
  const inputEnd = document.getElementById('inputEndCity');
  if (inputStart) inputStart.placeholder = L.placeholderStart || '';
  if (inputEnd) inputEnd.placeholder = L.placeholderEnd || '';
  // Options durée
  const selectDuration = document.getElementById('inputDuration');
  if (selectDuration && L.days) {
    selectDuration.innerHTML = [3,5,7,10,14].map(d => `<option value="${d}"${d===7?' selected':''} >${d} ${L.days}</option>`).join('');
  }

  // Toggle pour afficher/masquer les prix sur mobile
  document.getElementById('pricingToggle')?.addEventListener('click', function() {
    const table = document.getElementById('pricing-table');
    const text = document.getElementById('pricingToggleText');
    const isVisible = table.classList.contains('show');
    
    if (isVisible) {
      table.classList.remove('show');
      text.textContent = L.pricing_show || 'Voir les tarifs détaillés';
    } else {
      table.classList.add('show');
      text.textContent = L.pricing_hide || 'Masquer les tarifs';
    }
  });

  // Cookies i18n & init
  setTextById('cookieText',L.cookie_text);
  setTextById('cookieOptAnalytics',L.cookie_opt_a);
  setTextById('cookieOptMarketing',L.cookie_opt_m);
 setTextById('btnPrefs',L.cookie_btn_p);
setTextById('btnReject',L.cookie_btn_r);
setTextById('btnAccept',L.cookie_btn_a);

// Rouvrir la bannière depuis le footer "Préférences cookies"
const cookieManageBtn = document.getElementById('manageCookies');
if (cookieManageBtn) {
  cookieManageBtn.addEventListener('click', () => {
    const banner = document.getElementById('cookieBanner');
    const prefs  = document.getElementById('cookiePrefs');
    if (banner) banner.style.display = 'block';
    if (prefs)  prefs.style.display  = 'block';
  });
}

 /* === Bannière Cookies (auto-injection si absente, modèle quest_simple.html) ============== */
(function(){
  var KEY = 'cookieConsent.v1';

  function readConsent(){
    try { return JSON.parse(localStorage.getItem(KEY) || ''); }
    catch(e){ return null; }
  }
  function saveConsent(c){
    try { localStorage.setItem(KEY, JSON.stringify(c)); } catch(_) {}
    var b = document.getElementById('cookieBanner');
    if (b) b.style.display = 'none';
  }

  // Injecter la bannière si absente
  if (!document.getElementById('cookieBanner')) {
    var wrap = document.createElement('div');
    wrap.id = 'cookieBanner';
    wrap.setAttribute('role', 'dialog');
    wrap.setAttribute('aria-live', 'polite');
    wrap.setAttribute('aria-label', 'Bannière cookies');
    wrap.style.cssText = 'position:fixed;left:50%;transform:translateX(-50%);bottom:12px;z-index:99999;display:none';
    wrap.innerHTML = '' +
      '<div class="panel" style="max-width:520px;background:#fff;border:1px solid #c3d6b6;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:10px;color:#113f7a">' +
        '<div>Nous utilisons des cookies <em>nécessaires</em> (connexion). Les cookies <em>facultatifs</em> sont <strong>désactivés par défaut</strong>.</div>' +
        '<div id="cookiePrefs" style="display:none;margin-top:6px;text-align:left">' +
          '<label style="display:flex;align-items:center;gap:8px;margin:4px 0"><input type="checkbox" id="consent-analytics"> Mesure d’audience</label>' +
          '<label style="display:flex;align-items:center;gap:8px;margin:4px 0"><input type="checkbox" id="consent-marketing"> Marketing</label>' +
        '</div>' +
        '<div class="row" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:8px">' +
          '<button id="btnPrefs"  class="btn" type="button" style="background:#fff;color:#113f7a;border:1px solid #113f7a">Paramétrer</button>' +
          '<button id="btnReject" class="btn" type="button" style="background:#fff;color:#113f7a;border:1px solid #113f7a">Tout refuser</button>' +
          '<button id="btnAccept" class="btn" type="button" style="background:#113f7a;color:#fff;border:1px solid #113f7a">Tout accepter</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(wrap);
  }

  var banner = document.getElementById('cookieBanner');
  var prefs  = document.getElementById('cookiePrefs');
  var btnPrefs  = document.getElementById('btnPrefs');
  var btnAccept = document.getElementById('btnAccept');
  var btnReject = document.getElementById('btnReject');

  if (!readConsent()) {
    banner.style.display = 'block';
  }

  if (btnPrefs) {
    btnPrefs.addEventListener('click', function(){
      prefs.style.display = (prefs.style.display ? '' : 'block');
    });
  }
if (btnReject) {
    btnReject.addEventListener('click', function(){
      saveConsent({necessary:true, analytics:false, marketing:false, ts:Date.now()});
    });
  }
  if (btnAccept) {
    btnAccept.addEventListener('click', function(){
      saveConsent({necessary:true, analytics:true, marketing:true, ts:Date.now()});
    });
  }
})(); // ferme l'IIFE interne (cookies)
})(); // ferme l’IIFE externe "Auto-lang"
</script>

<script>
(function(){
  const pricingDict = {
    "fr": {
      "col.feature":"Fonctionnalités","plan.bronze":"Bronze","plan.silver":"Silver","plan.gold":"Gold","plan.popular":"Le plus populaire",
      "row.price":"Prix mensuel","row.core":"Cœur d'ORT (itinéraires modifiables, détails d'étapes, points d'intérêts, liens de réservation)",
      "row.stories":"Stories publiques & partage","row.pdf":"Export PDF complet du voyage","row.maps":"Cartes interactives",
      "row.rtlimit":"Roadtrips pouvant être stockés dans le dashboard","row.photosday":"Photos par jour pouvant être publiées dans votre story",
      "row.storage":"Espace total photos","row.ai":"Assistance IA (créations automatiques d'itinéraires et avis sur le voyage)",
      "row.backup":"Sauvegarde Cloud (sécurité de vos données)","row.family":"Espace famille / amis (inviter des proches)",
      "yes":"Oui","no":"Non","pricing.bronze.price":"Gratuit","pricing.silver.price":"4,99 €/mois","pricing.gold.price":"9,99 €/mois",
      "pricing.bronze.rtlimit":"3","pricing.silver.rtlimit":"20","pricing.gold.rtlimit":"50",
      "pricing.bronze.photos":"3","pricing.silver.photos":"15","pricing.gold.photos":"50",
      "pricing.bronze.storage":"1 Go","pricing.silver.storage":"20 Go","pricing.gold.storage":"100 Go",
      "pricing.silver.ia":"10 actions par mois","pricing.gold.ia":"30 actions par mois",
      "pricing.silver.backup":"Automatique","pricing.gold.backup":"Automatique",
      "pricing.silver.family":"Jusqu'à 3 invités","pricing.gold.family":"Jusqu'à 10 invités"
    },
    "en": {
      "col.feature":"Features","plan.bronze":"Bronze","plan.silver":"Silver","plan.gold":"Gold","plan.popular":"Most popular",
      "row.price":"Monthly price","row.core":"ORT core (editable itineraries, step details, points of interest, booking links)",
      "row.stories":"Public stories & sharing","row.pdf":"Full trip PDF export","row.maps":"Interactive maps",
      "row.rtlimit":"Trips you can store in your dashboard","row.photosday":"Photos per day you can publish in your story",
      "row.storage":"Total photo storage","row.ai":"AI assistance (automatic itinerary creations and trip reviews)",
      "row.backup":"Cloud backup (data safety)","row.family":"Family / Friends space (invite people)",
      "yes":"Yes","no":"No","pricing.bronze.price":"Free","pricing.silver.price":"€4.99 / month","pricing.gold.price":"€9.99 / month",
      "pricing.bronze.rtlimit":"3","pricing.silver.rtlimit":"20","pricing.gold.rtlimit":"50",
      "pricing.bronze.photos":"3","pricing.silver.photos":"15","pricing.gold.photos":"50",
      "pricing.bronze.storage":"1 GB","pricing.silver.storage":"20 GB","pricing.gold.storage":"100 GB",
      "pricing.silver.ia":"10 actions / month","pricing.gold.ia":"30 actions / month",
      "pricing.silver.backup":"Automatic","pricing.gold.backup":"Automatic",
      "pricing.silver.family":"Up to 3 guests","pricing.gold.family":"Up to 10 guests"
    },
    "it": {
      "col.feature":"Funzionalità","plan.bronze":"Bronzo","plan.silver":"Argento","plan.gold":"Oro","plan.popular":"Il più scelto",
      "row.price":"Prezzo mensile","row.core":"Cuore di ORT (itinerari modificabili, dettagli tappe, punti di interesse, link di prenotazione)",
      "row.stories":"Storie pubbliche e condivisione","row.pdf":"Esportazione PDF completa del viaggio","row.maps":"Mappe interattive",
      "row.rtlimit":"Roadtrip archiviabili nella dashboard","row.photosday":"Foto al giorno pubblicabili nella tua story",
      "row.storage":"Spazio totale foto","row.ai":"Assistenza IA (creazioni automatiche di itinerari e valutazioni del viaggio)",
      "row.backup":"Backup su cloud (sicurezza dati)","row.family":"Spazio Famiglia / Amici (inviti)",
      "yes":"Sì","no":"No","pricing.bronze.price":"Gratuito","pricing.silver.price":"4,99 € / mese","pricing.gold.price":"9,99 € / mese",
      "pricing.bronze.rtlimit":"3","pricing.silver.rtlimit":"20","pricing.gold.rtlimit":"50",
      "pricing.bronze.photos":"3","pricing.silver.photos":"15","pricing.gold.photos":"50",
      "pricing.bronze.storage":"1 GB","pricing.silver.storage":"20 GB","pricing.gold.storage":"100 GB",
      "pricing.silver.ia":"10 azioni / mese","pricing.gold.ia":"30 azioni / mese",
      "pricing.silver.backup":"Automatico","pricing.gold.backup":"Automatico",
      "pricing.silver.family":"Fino a 3 invitati","pricing.gold.family":"Fino a 10 invitati"
    },
    "es": {
      "col.feature":"Funciones","plan.bronze":"Bronce","plan.silver":"Plata","plan.gold":"Oro","plan.popular":"El más popular",
      "row.price":"Precio mensual","row.core":"Núcleo de ORT (itinerarios editables, detalles de etapas, puntos de interés, enlaces de reserva)",
      "row.stories":"Historias públicas y compartición","row.pdf":"Exportación completa en PDF del viaje","row.maps":"Mapas interactivos",
      "row.rtlimit":"Viajes que puedes guardar en el panel","row.photosday":"Fotos por día que puedes publicar en tu historia",
      "row.storage":"Almacenamiento total de fotos","row.ai":"Asistencia IA (creación automática de itinerarios y evaluación del viaje)",
      "row.backup":"Copia de seguridad en la nube (seguridad de datos)","row.family":"Espacio Familia / Amigos (invitaciones)",
      "yes":"Sí","no":"No","pricing.bronze.price":"Gratis","pricing.silver.price":"4,99 €/mes","pricing.gold.price":"9,99 €/mes",
      "pricing.bronze.rtlimit":"3","pricing.silver.rtlimit":"20","pricing.gold.rtlimit":"50",
      "pricing.bronze.photos":"3","pricing.silver.photos":"15","pricing.gold.photos":"50",
      "pricing.bronze.storage":"1 GB","pricing.silver.storage":"20 GB","pricing.gold.storage":"100 GB",
      "pricing.silver.ia":"10 acciones / mes","pricing.gold.ia":"30 acciones / mes",
      "pricing.silver.backup":"Automática","pricing.gold.backup":"Automática",
      "pricing.silver.family":"Hasta 3 invitados","pricing.gold.family":"Hasta 10 invitados"
    },
    "pt": {
      "col.feature":"Funcionalidades","plan.bronze":"Bronze","plan.silver":"Prata","plan.gold":"Ouro","plan.popular":"Mais popular",
      "row.price":"Preço mensal","row.core":"Núcleo do ORT (itinerários editáveis, detalhes de etapas, pontos de interesse, links de reserva)",
      "row.stories":"Stories públicas e partilha","row.pdf":"Exportação completa em PDF da viagem","row.maps":"Mapas interativos",
      "row.rtlimit":"Roadtrips que pode guardar no painel","row.photosday":"Fotos por dia que pode publicar na sua story",
      "row.storage":"Armazenamento total de fotos","row.ai":"Assistência IA (criações automáticas de itinerários e avaliação da viagem)",
      "row.backup":"Cópia de segurança na nuvem (segurança dos dados)","row.family":"Espaço Família / Amigos (convites)",
      "yes":"Sim","no":"Não","pricing.bronze.price":"Grátis","pricing.silver.price":"4,99 €/mês","pricing.gold.price":"9,99 €/mês",
      "pricing.bronze.rtlimit":"3","pricing.silver.rtlimit":"20","pricing.gold.rtlimit":"50",
      "pricing.bronze.photos":"3","pricing.silver.photos":"15","pricing.gold.photos":"50",
      "pricing.bronze.storage":"1 GB","pricing.silver.storage":"20 GB","pricing.gold.storage":"100 GB",
      "pricing.silver.ia":"10 ações / mês","pricing.gold.ia":"30 ações / mês",
      "pricing.silver.backup":"Automática","pricing.gold.backup":"Automática",
      "pricing.silver.family":"Até 3 convidados","pricing.gold.family":"Até 10 convidados"
    },
    "ar": {
      "col.feature":"الميزات","plan.bronze":"برونزي","plan.silver":"فضي","plan.gold":"ذهبي","plan.popular":"الأكثر شيوعًا",
      "row.price":"السعر الشهري","row.core":"جوهر ORT (مسارات قابلة للتعديل، تفاصيل المراحل، نقاط الاهتمام، روابط الحجز)",
      "row.stories":"قصص عامة ومشاركة","row.pdf":"تصدير كامل لملف PDF للرحلة","row.maps":"خرائط تفاعلية",
      "row.rtlimit":"الرحلات التي يمكن حفظها في لوحة التحكم","row.photosday":"الصور يوميًا التي يمكنك نشرها في قصتك",
      "row.storage":"إجمالي مساحة الصور","row.ai":"مساعدة الذكاء الاصطناعي (إنشاء تلقائي للمسارات وتقييم الرحلة)",
      "row.backup":"نسخة احتياطية سحابية (أمان البيانات)","row.family":"مساحة العائلة / الأصدقاء (دعوات)",
      "yes":"نعم","no":"لا","pricing.bronze.price":"مجاني","pricing.silver.price":"€4.99 / شهريًا","pricing.gold.price":"€9.99 / شهريًا",
      "pricing.bronze.rtlimit":"3","pricing.silver.rtlimit":"20","pricing.gold.rtlimit":"50",
      "pricing.bronze.photos":"3","pricing.silver.photos":"15","pricing.gold.photos":"50",
      "pricing.bronze.storage":"1 جيجابايت","pricing.silver.storage":"20 جيجابايت","pricing.gold.storage":"100 جيجابايت",
      "pricing.silver.ia":"10 إجراءات / شهر","pricing.gold.ia":"30 إجراءً / شهر",
      "pricing.silver.backup":"تلقائي","pricing.gold.backup":"تلقائي",
      "pricing.silver.family":"حتى 3 مدعوين","pricing.gold.family":"حتى 10 مدعوين"
    }
  };
  const lang = localStorage.getItem('lang') || 'fr';
  const t = pricingDict[lang] || pricingDict.fr;
  document.querySelectorAll('#pricing-table [data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    if (k && t[k]) el.textContent = t[k];
  });
})();
</script>

<!-- Modal Budget -->
<div id="budgetModal" class="budget-modal-overlay">
  <div class="budget-modal" style="max-width:450px;">
    <h3 id="budgetModalTitle">Configurez votre voyage</h3>
    
    <div style="margin-bottom:16px;">
      <label id="labelDepartureDate" style="display:block;font-weight:600;margin-bottom:6px;">Date de départ :</label>
      <input type="date" id="inputDepartureDate" class="filter-input" style="width:100%;">
    </div>
    
    <div style="margin-bottom:16px;">
      <label id="labelNumDays" style="display:block;font-weight:600;margin-bottom:6px;">Nombre de jours souhaités :</label>
      <input type="number" id="inputNumDays" class="filter-input" style="width:100%;" min="1" max="60" value="7">
    </div>
    
    <div style="margin-bottom:16px;">
      <label id="labelBudget" style="display:block;font-weight:600;margin-bottom:6px;">Budget hôtel (€/jour/personne) :</label>
      <div id="budgetCheckboxes" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
    </div>
    
    <div class="budget-modal-actions">
      <button class="budget-modal-btn secondary" id="budgetCancel">Annuler</button>
      <button class="budget-modal-btn primary" id="budgetConfirm">Valider</button>
    </div>
  </div>
</div>

<!-- ORT External Scripts -->
<script>

// ============================================
// ROUTE BUILDER - Autocomplétion et génération
// ============================================

// Config API Search - détection auto local/prod
const SEARCH_API = (() => {
  const host = window.location.hostname;
  if (host === 'localhost' || host === '127.0.0.1' || host.match(/^192\.168\./)) {
    return 'http://localhost:3031';
  }
  return '/.netlify/functions';  // ← NETLIFY FUNCTIONS
})();
console.log('[ROUTE-BUILDER] API:', SEARCH_API);

// État du formulaire
let startCity = null; // {name, lat, lon, countryCode}
let endCity = null;

// Debounce pour l'autocomplétion
function debounce(fn, ms) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), ms);
  };
}

// Recherche de villes via l'API
async function searchCities(query, lang = 'fr') {
  if (!query || query.length < 2) return [];
  const url = `${SEARCH_API}/citysearch?q=${encodeURIComponent(query)}&lang=${lang}&limit=8`;
  console.log('[ROUTE-BUILDER] Recherche:', url);
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    console.log('[ROUTE-BUILDER] Résultats:', data.items?.length || 0);
    return data.items || [];
  } catch (e) {
    console.warn('[ROUTE-BUILDER] Erreur recherche:', e);
    return [];
  }
}

// Afficher les suggestions
function showSuggestions(containerId, items, onSelect) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  if (!items.length) {
    container.style.display = 'none';
    return;
  }
  
  container.innerHTML = items.map((item, i) => `
    <div data-index="${i}" style="display:flex;justify-content:space-between;align-items:center;">
      <span>${item.name}</span>
      <span style="color:#666;font-size:12px;">${item.countryCode || ''}</span>
    </div>
  `).join('');
  
  container.style.display = 'block';
  
  container.querySelectorAll('div').forEach(div => {
    div.addEventListener('click', () => {
      const idx = parseInt(div.dataset.index);
      onSelect(items[idx]);
      container.style.display = 'none';
    });
  });
}

// Initialiser l'autocomplétion
function initRouteBuilderAutocomplete() {
  const lang = localStorage.getItem('lang') || 'fr';
  const L = T[lang] || T.fr;
  
  const inputStart = document.getElementById('inputStartCity');
  const inputEnd = document.getElementById('inputEndCity');
  const suggestionsStart = document.getElementById('startCitySuggestions');
  const suggestionsEnd = document.getElementById('endCitySuggestions');
  const warnStart = document.getElementById('warnStartCity');
  const warnEnd = document.getElementById('warnEndCity');
  
  if (!inputStart || !inputEnd) return;
  
  // Placeholders traduits
  inputStart.placeholder = L.placeholderStart || 'Paris, Lyon...';
  inputEnd.placeholder = L.placeholderEnd || 'Barcelone, Rome...';
  
  // Autocomplétion départ
  const searchStart = debounce(async (q) => {
    const items = await searchCities(q, lang);
    showSuggestions('startCitySuggestions', items, (city) => {
      startCity = city;
      inputStart.value = city.name;
      if (warnStart) warnStart.style.display = 'none';
    });
  }, 300);
  
  inputStart.addEventListener('input', (e) => {
    startCity = null; // Reset quand l'user tape
    if (warnStart && e.target.value.length >= 2) {
      warnStart.textContent = L.warnCityNotSelected || '⚠️ Ville non validée';
      warnStart.style.display = 'block';
    }
    searchStart(e.target.value);
  });
  inputStart.addEventListener('focus', () => {
    if (inputStart.value.length >= 2) searchStart(inputStart.value);
  });
  
  // Autocomplétion arrivée
  const searchEnd = debounce(async (q) => {
    const items = await searchCities(q, lang);
    showSuggestions('endCitySuggestions', items, (city) => {
      endCity = city;
      inputEnd.value = city.name;
      if (warnEnd) warnEnd.style.display = 'none';
    });
  }, 300);
  
  inputEnd.addEventListener('input', (e) => {
    endCity = null; // Reset quand l'user tape
    if (warnEnd && e.target.value.length >= 2) {
      warnEnd.textContent = L.warnCityNotSelected || '⚠️ Ville non validée';
      warnEnd.style.display = 'block';
    }
    searchEnd(e.target.value);
  });
  inputEnd.addEventListener('focus', () => {
    if (inputEnd.value.length >= 2) searchEnd(inputEnd.value);
  });
  
  // Fermer les suggestions si clic ailleurs
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.rb-field')) {
      suggestionsStart.style.display = 'none';
      suggestionsEnd.style.display = 'none';
    }
  });
}

// Générer l'itinéraire
function initRouteBuilderSubmit() {
  const btn = document.getElementById('btnGenerateRoute');
  if (!btn) return;
  
  btn.addEventListener('click', async () => {
    const lang = localStorage.getItem('lang') || 'fr';
    const L = T[lang] || T.fr;
    
    const inputStart = document.getElementById('inputStartCity');
    const inputEnd = document.getElementById('inputEndCity');
    const startText = inputStart?.value?.trim();
    const endText = inputEnd?.value?.trim();
    
    // Vérifier qu'on a au moins du texte
    if (!startText) {
      inputStart?.focus();
      return;
    }
    if (!endText) {
      inputEnd?.focus();
      return;
    }
    
    // Si ville non validée, faire une recherche rapide pour récupérer les coords
    let finalStart = startCity;
    let finalEnd = endCity;
    
    if (!finalStart || !finalStart.lat) {
      const results = await searchCities(startText, lang);
      if (results.length > 0) {
        finalStart = results[0];
      } else {
        finalStart = { name: startText, lat: null, lon: null };
      }
    }
    
    if (!finalEnd || !finalEnd.lat) {
      const results = await searchCities(endText, lang);
      if (results.length > 0) {
        finalEnd = results[0];
      } else {
        finalEnd = { name: endText, lat: null, lon: null };
      }
    }
    
    const maxKm = document.getElementById('inputMaxKm').value;
    const detour = document.getElementById('inputDetour').value;
    const duration = document.getElementById('inputDuration').value;
    
    // Construire l'URL de redirection
    const params = new URLSearchParams({
      from: 'builder',
      startName: finalStart.name,
      startLat: finalStart.lat || '',
      startLon: finalStart.lon || '',
      startCC: finalStart.countryCode || '',
      endName: finalEnd.name,
      endLat: finalEnd.lat || '',
      endLon: finalEnd.lon || '',
      endCC: finalEnd.countryCode || '',
      maxKm: maxKm,
      detour: detour,
      days: duration,
      lang: lang
    });
    
    // Changer le texte du bouton
    btn.innerHTML = `<span>${L.generatingBtn || '⏳ Calcul en cours...'}</span>`;
    btn.disabled = true;
    
    // Rediriger vers roadtrip_detail avec les paramètres
    setTimeout(() => {
      window.location.href = `roadtrip_detail.html?${params.toString()}`;
    }, 500);
  });
}

// Initialiser les handlers des 4 carrés
function initGridCards() {
  // Carré 2: Construire de A à Z
  document.getElementById('buildFromScratch')?.addEventListener('click', () => {
    const lang = localStorage.getItem('lang') || 'fr';
    const u = new URL('carte_builder.html', location.href); u.searchParams.set('lang', lang); u.searchParams.set('mode', 'expert'); window.location.href = u.toString();
  });
  
  // Carré 3: Importer du web
  document.getElementById('importFromWeb')?.addEventListener('click', () => {
    const lang = localStorage.getItem('lang') || 'fr';
    window.location.href = `import.html?lang=${lang}`;
  });
  
  // Carré 4: Créateurs
  // Carré 4: Itinéraires créateurs → ouvre la carte avec filtre creators
  document.getElementById('creatorsSection')?.addEventListener('click', async (e) => {
    // Ne pas déclencher si on clique sur le lien "Devenir créateur"
    if (e.target.id === 'becomeCreator') return;
    
    console.log('🎨 Bouton créateurs cliqué');
    document.getElementById('mapFullscreen').classList.add('active');
    
    if (!THEMES_DATA || Object.keys(THEMES_REG || {}).length === 0) {
      await loadThemes();
    }
    
    if (!mapFull) {
      setTimeout(async () => {
        initMapFull();
        loadPhotosData();
        loadPlacesPhotosIndex();
        await loadAllItineraries();
        setTimeout(() => {
          const themeFilter = document.getElementById('filterThemeFull');
          if (themeFilter) {
            themeFilter.value = 'creators';
            applyFilters();
          }
        }, 500);
      }, 100);
    } else {
      const themeFilter = document.getElementById('filterThemeFull');
      if (themeFilter) {
        themeFilter.value = 'creators';
        applyFilters();
      }
    }
  });
}

// Mettre à jour les textes traduits du route builder
function updateRouteBuilderTranslations() {
  const lang = localStorage.getItem('lang') || 'fr';
  const L = T[lang] || T.fr;
  
  const setTextById = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
  
  setTextById('buildTitle', L.buildTitle);
  setTextById('importTitle', L.importTitle);
  setTextById('creatorsTitle2', L.creatorsTitle);
  setTextById('becomeCreator', L.becomeCreator);
  setTextById('routeBuilderTitle', L.routeBuilderTitle);
  setTextById('labelStartCity', L.labelStartCity);
  setTextById('labelEndCity', L.labelEndCity);
  setTextById('labelMaxKm', L.labelMaxKm);
  setTextById('labelDetour', L.labelDetour);
  setTextById('labelDuration', L.labelDuration);
  setTextById('generateBtnText', L.generateBtn);
  
  // Placeholders
  const inputStart = document.getElementById('inputStartCity');
  const inputEnd = document.getElementById('inputEndCity');
  if (inputStart) inputStart.placeholder = L.placeholderStart || '';
  if (inputEnd) inputEnd.placeholder = L.placeholderEnd || '';
  
  // Options durée avec traduction "jours"
  const selectDuration = document.getElementById('inputDuration');
  if (selectDuration) {
    const days = L.days || 'jours';
    selectDuration.innerHTML = [3,5,7,10,14,21].map(d => 
      `<option value="${d}"${d===7?' selected':''}>${d} ${days}</option>`
    ).join('');
  }
}

// Init au chargement
document.addEventListener('DOMContentLoaded', () => {
  initRouteBuilderAutocomplete();
  initRouteBuilderSubmit();
  initGridCards();
  updateRouteBuilderTranslations();
});

// Re-traduire quand la langue change
window.addEventListener('langChange', updateRouteBuilderTranslations);
</script>


<script src="/js/ort-i18n-auth.js"></script>
<script src="/js/ort-header.js"></script>
<script src="js/ort-footer.js"></script>
</body>
</html>