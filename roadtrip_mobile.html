<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>OneRoadTrip</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JK3QGQGDDL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-JK3QGQGDDL');
</script>
<!-- üî¥ CHECK CATALOGUE: redirection imm√©diate si c'est un catalogue -->
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const tripId = qs.get('tripId') || qs.get('id');
  const cc = qs.get('cc');
  const itin = qs.get('itin');
  const from = qs.get('from');
  
  // Cas 1: tripId explicitement catalog:: ou custom::
  if (tripId && (tripId.startsWith('catalog::') || tripId.startsWith('custom::'))) {
    const sourceType = tripId.startsWith('catalog::') ? 'Catalogue' : 'Custom (Carte/Import)';
    console.log(`[INIT-EARLY] üìö ${sourceType} d√©tect√© (tripId), g√©n√©ration NEW tripId`);
    const newTripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    sessionStorage.setItem('ort_catalog_source', tripId);
    console.log('[INIT-EARLY] ‚úÖ Source sauvegard√©e:', tripId);
    
    // Remplacer tripId mais conserver tous les autres param√®tres
    qs.set('tripId', newTripId);
    const newUrl = `${location.pathname}?${qs.toString()}`;
    console.log('[INIT-EARLY] Redirect vers:', newUrl);
    window.location.href = newUrl;
    return;
  }
  
  // Cas 2: cc + itin (acc√®s catalogue via param√®tres s√©par√©s) - inclut COMPOSED::
  if (cc && itin && !tripId) {
    console.log('[INIT-EARLY] üìö Catalogue d√©tect√© (cc+itin), g√©n√©ration NEW tripId');
    const catalogId = `catalog::${cc.toUpperCase()}::${itin}`;
    const newTripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    sessionStorage.setItem('ort_catalog_source', catalogId);
    console.log('[INIT-EARLY] ‚úÖ Source catalogue sauvegard√©e:', catalogId);
    
    // Ajouter tripId mais conserver tous les autres param√®tres (cc, itin, days, depart, mode, etc.)
    qs.set('tripId', newTripId);
    const newUrl = `${location.pathname}?${qs.toString()}`;
    console.log('[INIT-EARLY] Redirect vers:', newUrl);
    window.location.href = newUrl;
    return;
  }
  
  // Cas 3: from=builder ou from=temp sans tripId valide (Route Builder, Carte Builder, Import IA)
  if ((from === 'builder' || from === 'temp') && (!tripId || !tripId.startsWith('trip_'))) {
    const sourceType = from === 'builder' ? 'Route Builder' : 'Carte/Import';
    console.log(`[INIT-EARLY] üõ†Ô∏è ${sourceType} d√©tect√© sans tripId, g√©n√©ration NEW tripId`);
    const newTripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // Sauvegarder la source si rtKey existe
    const rtKey = qs.get('rtKey');
    if (rtKey) {
      sessionStorage.setItem('ort_catalog_source', `custom::${rtKey}`);
      console.log('[INIT-EARLY] ‚úÖ Source custom sauvegard√©e:', `custom::${rtKey}`);
    }
    
    qs.set('tripId', newTripId);
    const newUrl = `${location.pathname}?${qs.toString()}`;
    console.log('[INIT-EARLY] Redirect vers:', newUrl);
    window.location.href = newUrl;
    return;
  }
})();
</script>
<!-- Clean redirect marker on mobile arrival -->
<script>
(function(){
  // Clear all redirect markers when arriving on mobile (successful redirect)
  for (let i = 0; i < 24; i++) {
    localStorage.removeItem('ort_redirect_in_progress_' + i);
  }
  console.log('[ORT-MOBILE] Redirect markers cleaned');
})();
</script>
<style>
:root {
  --ort-blue: #113f7a;
  --ort-green: #c3d6b6;
  --ort-light: #f8fafc;
  --ort-border: #e2e8f0;
  --tab-height: 56px;
  --header-height: 56px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { 
  height: 100%; 
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--ort-light);
  color: #1e293b;
}

/* === HEADER === */
.header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--header-height);
  background: var(--ort-blue);
  color: #fff;
  display: flex;
  align-items: center;
  padding: 0 12px;
  gap: 12px;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.header-back {
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: #fff;
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.header-title {
  flex: 1;
  font-weight: 700;
  font-size: 16px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.header-menu {
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: #fff;
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
}

/* === MAIN CONTENT === */
.main-content {
  position: fixed;
  top: var(--header-height);
  left: 0;
  right: 0;
  bottom: calc(var(--tab-height) + var(--safe-bottom));
  overflow: hidden;
}

.tab-panel {
  position: absolute;
  inset: 0;
  overflow-y: auto;
  display: none;
  -webkit-overflow-scrolling: touch;
}

.tab-panel.active {
  display: block;
}

/* === MAP TAB === */
#mapPanel { overflow: hidden; }
#map { width: 100%; height: 100%; }
.leaflet-container { font-family: inherit; }

/* === LIST TAB === */
#listPanel {
  padding: 12px;
  padding-bottom: 24px;
  background: var(--ort-light);
}

/* Summary card */
.summary-card {
  background: #fff;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.summary-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
  min-width: 70px;
}

.summary-stat .value {
  font-size: 22px;
  font-weight: 800;
  color: var(--ort-blue);
}

.summary-stat .label {
  font-size: 11px;
  color: #64748b;
  text-transform: uppercase;
}

/* Bookings styles */
#bookingsContainer {
  padding: 12px;
  overflow-y: auto;
  height: calc(100% - 12px);
}

.booking-day {
  margin-bottom: 16px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 10px;
  border-left: 4px solid #113f7a;
}

.booking-day-header {
  font-size: 14px;
  font-weight: 700;
  color: #113f7a;
  margin: 0 0 10px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #e2e8f0;
}

.booking-section {
  margin-bottom: 16px;
}
.booking-section-title {
  font-size: 14px;
  font-weight: 700;
  color: #113f7a;
  padding: 12px 16px 8px;
  border-bottom: 2px solid #113f7a;
  margin: 0 0 8px 0;
}

.booking-item {
  background: white;
  border-radius: 10px;
  padding: 12px;
  margin: 0 12px 8px 12px;
  border: 1px solid #e2e8f0;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.booking-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.booking-info {
  flex: 1;
  min-width: 0;
}

.booking-name {
  font-size: 14px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 2px;
}

.booking-detail {
  font-size: 12px;
  color: #6b7280;
  margin: 2px 0;
}

.booking-price {
  font-size: 14px;
  font-weight: 700;
  color: #16a34a;
  white-space: nowrap;
}

.booking-budget {
  background: linear-gradient(135deg, #113f7a 0%, #1e5090 100%);
  color: white;
  border-radius: 12px;
  margin: 16px 12px;
  padding: 16px;
  text-align: center;
}
.budget-label {
  font-size: 13px;
  opacity: 0.9;
  margin-bottom: 4px;
}
.budget-amount {
  font-size: 1.6rem;
  font-weight: 700;
}

/* Step cards */
.step-card {
  background: #fff;
  border-radius: 14px;
  margin-bottom: 10px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  display: flex;
  align-items: stretch;
  min-height: 90px;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.step-card:active {
  transform: scale(0.98);
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.step-card-num {
  width: 44px;
  background: var(--ort-blue);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 18px;
  flex-shrink: 0;
}

.step-card-photo {
  width: 80px;
  height: 90px;
  object-fit: cover;
  flex-shrink: 0;
  background: #e2e8f0;
}

.step-card-info {
  flex: 1;
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 0;
}

.step-card-name {
  font-weight: 700;
  font-size: 15px;
  color: var(--ort-blue);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.step-card-meta {
  font-size: 13px;
  color: #64748b;
  margin-top: 4px;
}

.step-card-nights {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: var(--ort-green);
  color: var(--ort-blue);
  padding: 3px 8px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 12px;
  margin-top: 6px;
  width: fit-content;
}

.step-card-booking {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: 8px;
  padding: 2px 8px;
  background: #dcfce7;
  border-radius: 12px;
  font-size: 14px;
  cursor: pointer;
}

.step-bookings-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.step-booking-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: #f8fafc;
  border-radius: 10px;
  border: 1px solid var(--ort-border);
}

.step-booking-icon {
  font-size: 20px;
  width: 32px;
  text-align: center;
}

.step-booking-info {
  flex: 1;
  min-width: 0;
}

.step-booking-name {
  font-weight: 600;
  color: var(--ort-blue);
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.step-booking-dates {
  font-size: 12px;
  color: #64748b;
}

.step-booking-price {
  font-weight: 600;
  color: #16a34a;
  font-size: 14px;
}

.step-card-chevron {
  width: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #94a3b8;
  font-size: 20px;
  flex-shrink: 0;
}

/* === TAB BAR === */
.tab-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: calc(var(--tab-height) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: #fff;
  border-top: 1px solid var(--ort-border);
  display: flex;
  z-index: 100;
}

.tab-btn {
  flex: 1;
  border: none;
  background: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  font-family: inherit;
  font-size: 10px;
  color: #64748b;
  cursor: pointer;
  transition: color 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.tab-btn.active {
  color: var(--ort-blue);
}

.tab-btn .tab-icon {
  font-size: 22px;
}

.tab-btn.active .tab-icon {
  transform: scale(1.1);
}

/* === BOTTOM SHEET === */
.sheet-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.25s, visibility 0.25s;
}

.sheet-overlay.show {
  opacity: 1;
  visibility: visible;
}

.bottom-sheet {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fff;
  border-radius: 20px 20px 0 0;
  z-index: 201;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  max-height: 85vh;
  display: flex;
  flex-direction: column;
}

.bottom-sheet.show {
  transform: translateY(0);
}

.sheet-handle {
  width: 40px;
  height: 5px;
  background: #d1d5db;
  border-radius: 3px;
  margin: 10px auto;
  flex-shrink: 0;
}

.sheet-header {
  padding: 0 16px 12px;
  border-bottom: 1px solid var(--ort-border);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sheet-header-center {
  flex: 1;
  text-align: center;
  min-width: 0;
}

.step-nav-btn {
  width: 40px;
  height: 40px;
  border: 2px solid var(--ort-border);
  background: #fff;
  border-radius: 50%;
  font-size: 24px;
  font-weight: 700;
  color: var(--ort-blue);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s;
}

.step-nav-btn:active {
  background: var(--ort-blue);
  color: #fff;
  border-color: var(--ort-blue);
}

.step-nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.sheet-title {
  font-size: 20px;
  font-weight: 800;
  color: var(--ort-blue);
}

.sheet-subtitle {
  font-size: 14px;
  color: #64748b;
  margin-top: 2px;
}

.sheet-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  -webkit-overflow-scrolling: touch;
}

.sheet-photo {
  width: 100%;
  aspect-ratio: 16/9;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 16px;
  background: #e2e8f0;
}

.sheet-section {
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.sheet-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.sheet-section-title {
  font-size: 12px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  margin-bottom: 12px;
  letter-spacing: 0.5px;
}

/* Nights control */
.nights-control {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 12px;
  background: var(--ort-light);
  border-radius: 12px;
}

.nights-btn {
  width: 48px;
  height: 48px;
  border: 2px solid var(--ort-blue);
  background: #fff;
  color: var(--ort-blue);
  border-radius: 12px;
  font-size: 24px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.nights-btn:active {
  background: var(--ort-blue);
  color: #fff;
}

.nights-value {
  font-size: 28px;
  font-weight: 800;
  color: var(--ort-blue);
  min-width: 80px;
  text-align: center;
}

.nights-label {
  font-size: 12px;
  color: #64748b;
}

/* Affiliate buttons - compact row at top */
.affiliate-buttons {
  display: flex;
  gap: 8px;
  margin: 12px 0 16px;
}

.affiliate-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 10px 8px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  text-align: center;
  transition: transform 0.15s;
}

.affiliate-btn:active {
  transform: scale(0.96);
}

.affiliate-gyg {
  background: linear-gradient(135deg, #ff5533 0%, #ff7744 100%);
  color: #fff;
}

.affiliate-tiqets {
  background: linear-gradient(135deg, #00a0e3 0%, #0077b6 100%);
  color: #fff;
}

.affiliate-hotel {
  background: var(--ort-green);
  color: var(--ort-blue);
}

/* Content buttons (Visites / Activit√©s) */
.content-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.content-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 16px;
  background: #f8fafc;
  border: 2px solid var(--ort-border);
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  color: var(--ort-blue);
  cursor: pointer;
  transition: all 0.2s;
}

.content-btn:active {
  background: var(--ort-light);
  border-color: var(--ort-blue);
}

.content-btn span:first-of-type {
  flex: 1;
  text-align: left;
}

.content-count {
  background: var(--ort-blue);
  color: #fff;
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
}

.content-count:empty,
.content-count[data-count="0"] {
  display: none;
}

/* Content Modal (Visites / Activit√©s) */
.content-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fff;
  z-index: 2000;
  display: none;
  flex-direction: column;
  overflow: hidden;
}

.content-modal.open {
  display: flex;
}

.content-modal-header {
  padding: 20px 16px;
  background: var(--ort-blue);
  color: #fff;
}

.content-modal-header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
}

.content-modal-step {
  font-size: 13px;
  opacity: 0.8;
  margin-top: 4px;
  display: block;
}

.content-modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  padding-bottom: 80px;
}

/* Content items inside modal */
.content-item {
  padding: 16px;
  margin-bottom: 12px;
  background: #f8fafc;
  border-radius: 12px;
  border-left: 4px solid var(--ort-blue);
}

.content-item-title {
  font-weight: 700;
  color: var(--ort-blue);
  font-size: 15px;
  margin-bottom: 8px;
}

.content-item-text {
  color: #475569;
  font-size: 14px;
  line-height: 1.6;
}

.content-empty {
  text-align: center;
  padding: 40px 20px;
  color: #94a3b8;
  font-size: 15px;
}

/* Floating back button */
.floating-back-btn {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  padding: 14px 32px;
  background: var(--ort-blue);
  color: #fff;
  border: none;
  border-radius: 30px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(26, 54, 93, 0.4);
  z-index: 2001;
  transition: transform 0.2s;
}

.floating-back-btn:active {
  transform: translateX(-50%) scale(0.96);
}

/* Share Modal Styles */
.share-options {
  padding: 8px 0;
}

.share-mode-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.share-mode-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: #f8fafc;
  border: 2px solid var(--ort-border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.share-mode-option:has(input:checked) {
  border-color: var(--ort-blue);
  background: #f0f7ff;
}

.share-mode-option input {
  width: 20px;
  height: 20px;
  accent-color: var(--ort-blue);
}

.share-mode-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.share-mode-icon {
  font-size: 24px;
}

.share-mode-info strong {
  display: block;
  color: var(--ort-blue);
  margin-bottom: 2px;
}

.share-mode-info p {
  margin: 0;
  font-size: 13px;
  color: #64748b;
}

.share-warning {
  background: #fef3c7;
  color: #92400e;
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 13px;
  margin-bottom: 20px;
  text-align: center;
}

.share-generate-btn {
  width: 100%;
  padding: 16px;
  background: var(--ort-blue);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 16px;
}

.share-generate-btn:active {
  opacity: 0.9;
}

.share-result {
  margin-bottom: 16px;
}

.share-url-input {
  width: 100%;
  padding: 14px;
  border: 2px solid var(--ort-border);
  border-radius: 10px;
  font-size: 14px;
  margin-bottom: 12px;
  background: #f8fafc;
}

.share-actions {
  display: flex;
  gap: 10px;
}

.share-action-btn {
  flex: 1;
  padding: 12px;
  border: 2px solid var(--ort-blue);
  background: #fff;
  color: var(--ort-blue);
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

.share-action-btn:active {
  background: var(--ort-blue);
  color: #fff;
}

.share-revoke-btn {
  width: 100%;
  padding: 14px;
  background: #fee2e2;
  color: #dc2626;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

/* Sheet actions */
.sheet-actions {
  padding: 12px 16px calc(12px + var(--safe-bottom));
  border-top: 1px solid var(--ort-border);
  display: flex;
  gap: 10px;
  flex-shrink: 0;
  background: #fff;
}

.sheet-btn {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  font-family: inherit;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

.sheet-btn-primary {
  background: var(--ort-blue);
  color: #fff;
}

.sheet-btn-danger {
  background: #fee2e2;
  color: #dc2626;
  flex: 0 0 auto;
  padding: 14px 18px;
}

/* === MENU SHEET === */
.menu-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--ort-border);
  font-size: 16px;
  color: #1e293b;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  text-decoration: none;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-item:active {
  background: var(--ort-light);
  margin: 0 -16px;
  padding-left: 16px;
  padding-right: 16px;
}

.menu-icon {
  font-size: 22px;
  width: 32px;
  text-align: center;
}

.menu-item.desktop-only {
  color: #94a3b8;
}

/* === SERVICES SHEET === */
.service-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.service-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px 12px;
  background: #fff;
  border-radius: 14px;
  border: 2px solid var(--ort-border);
  text-decoration: none;
  color: #1e293b;
  transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s;
}

.service-card:active {
  transform: scale(0.97);
  border-color: var(--ort-blue);
  box-shadow: 0 4px 12px rgba(17,63,122,0.15);
}

.service-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.service-name {
  font-size: 14px;
  font-weight: 600;
  text-align: center;
}

.service-desc {
  font-size: 11px;
  color: #64748b;
  text-align: center;
  margin-top: 4px;
}

/* === TOAST === */
.toast {
  position: fixed;
  bottom: calc(var(--tab-height) + var(--safe-bottom) + 16px);
  left: 16px;
  right: 16px;
  background: var(--ort-blue);
  color: #fff;
  padding: 14px 18px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  text-align: center;
  z-index: 300;
  transform: translateY(100px);
  opacity: 0;
  transition: transform 0.3s, opacity 0.3s;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.toast.show {
  transform: translateY(0);
  opacity: 1;
}

/* === LOADING === */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: var(--ort-blue);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 500;
  color: #fff;
}

.loading-overlay.hide {
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid rgba(255,255,255,0.2);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  margin-top: 16px;
  font-size: 16px;
}

/* === POPUP LEAFLET MOBILE === */
.leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; }
.leaflet-popup-content { margin: 0; width: 200px !important; }

.map-popup-mini {
  padding: 12px;
  text-align: center;
}

.map-popup-mini img {
  width: 100%;
  height: 100px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 8px;
}

.map-popup-mini .name {
  font-weight: 700;
  color: var(--ort-blue);
  font-size: 14px;
}

.map-popup-mini .btn-details {
  margin-top: 8px;
  padding: 8px 16px;
  background: var(--ort-blue);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
}

/* Step marker */
.step-marker {
  background: var(--ort-blue);
  color: #fff;
  border-radius: 50%;
  font-size: 13px;
  font-weight: bold;
  text-align: center;
  line-height: 26px;
  width: 26px;
  height: 26px;
  border: 2px solid #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* Scanner buttons */
.scan-btn {
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 0.95rem;
  border: none;
  cursor: pointer;
}
.scan-btn.primary {
  background: #113f7a;
  color: #fff;
}
.scan-btn.secondary {
  background: #e5e7eb;
  color: #333;
}
.scan-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Scan result card */
.scan-result-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}
.scan-result-row:last-child {
  border-bottom: none;
}
.scan-result-label {
  color: #666;
  font-size: 0.85rem;
}
.scan-result-value {
  font-weight: 600;
  color: #333;
}
</style>
<!-- Mode partage - masquer √©dition -->
<style>
  body.shared-view-only #btnSave,
  body.shared-view-only #btnAddStep,
  body.shared-view-only #btnAddMapRoute,
  body.shared-view-only .delete-btn,
  body.shared-view-only button.trash,
  body.shared-view-only [contenteditable="true"] {
    display: none !important;
  }
</style>
</head>
<body>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Chargement...</div>
</div>

<!-- Header -->
<header class="header">
  <button class="header-back" id="btnHome" aria-label="Dashboard" onclick="location.href='dashboard_user.html'">üè†</button>
  <button class="header-back" id="btnBack" aria-label="Retour">‚Üê</button>
  <div class="header-title" id="headerTitle">Roadtrip</div>
  <button class="header-expert" id="btnExpertMode" aria-label="Mode expert" title="Basculer en mode expert" style="background:#113f7a;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;">üéØ Expert</button>
  <button class="header-user" id="btnUser" aria-label="Profil utilisateur" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;margin-left:auto;">üë§</button>
  <button class="header-share" id="btnShare" aria-label="Partager" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;">üîó</button>
  <button class="header-menu" id="btnMenu" aria-label="Menu">‚ò∞</button>
</header>

<!-- Main Content -->
<main class="main-content">
  <!-- Map Panel -->
  <!-- Bookings Panel (NEW) -->
  <div class="tab-panel" id="bookingsPanel">
    <div id="bookingsContainer">
      <p style="padding: 20px; text-align: center; color: #999;">Aucune r√©servation</p>
    </div>
  </div>
  
  <!-- Map Panel -->
  <div class="tab-panel" id="mapPanel">
    <div id="map"></div>
  </div>
  
  <!-- List Panel -->
  <div class="tab-panel active" id="listPanel">
    <div class="summary-card" id="summaryCard">
      <div class="summary-stat">
        <div class="value" id="statSteps">-</div>
        <div class="label">√âtapes</div>
      </div>
      <div class="summary-stat">
        <div class="value" id="statNights">-</div>
        <div class="label">Nuits</div>
      </div>
      <div class="summary-stat">
        <div class="value" id="statKm">-</div>
        <div class="label">Km</div>
      </div>
    </div>
    <div id="stepsList"></div>
  </div>
</main>

<!-- Tab Bar -->
<nav class="tab-bar">
  <button class="tab-btn active" id="tabList" data-panel="listPanel">
    <span class="tab-icon">üìã</span>
    <span>Itin√©raire</span>
  </button>
  <button class="tab-btn" id="tabMap" data-panel="mapPanel">
    <span class="tab-icon">üó∫Ô∏è</span>
    <span>Carte</span>
  </button>
  <button class="tab-btn" id="tabBookings" data-panel="bookingsPanel">
    <span class="tab-icon">üè®</span>
    <span>R√©servations</span>
  </button>
  <button class="tab-btn" id="tabServices">
    <span class="tab-icon">üõéÔ∏è</span>
    <span>Services</span>
  </button>
</nav>

<!-- Sheet Overlay -->
<div class="sheet-overlay" id="sheetOverlay"></div>

<!-- Step Detail Bottom Sheet -->
<div class="bottom-sheet" id="stepSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <button class="step-nav-btn" id="btnPrevStep" onclick="navigateStep(-1)">‚Äπ</button>
    <div class="sheet-header-center">
      <div class="sheet-title" id="sheetStepName">-</div>
      <div class="sheet-subtitle" id="sheetStepMeta">-</div>
    </div>
    <button class="step-nav-btn" id="btnNextStep" onclick="navigateStep(1)">‚Ä∫</button>
  </div>
  <div class="sheet-body">
    <img class="sheet-photo" id="sheetStepPhoto" src="" alt="">
    
    <!-- Liens affili√©s EN HAUT -->
    <div class="affiliate-buttons">
      <a class="affiliate-btn affiliate-gyg" id="btnGyg" href="#" target="_blank" rel="noopener">
        üé´ Tours
      </a>
      <a class="affiliate-btn affiliate-tiqets" id="btnTiqets" href="#" target="_blank" rel="noopener">
        üéüÔ∏è Billets
      </a>
      <a class="affiliate-btn affiliate-hotel" id="btnHotel" href="#" target="_blank" rel="noopener">
        üè® H√¥tel
      </a>
    </div>
    
    <!-- Boutons vers modales Visites et Activit√©s -->
    <div class="sheet-section">
      <div class="content-buttons">
        <button class="content-btn" id="btnOpenVisits" onclick="openVisitsModal()">
          üìç <span>Voir les visites</span>
          <span class="content-count" id="visitsCount">0</span>
        </button>
        <button class="content-btn" id="btnOpenActivities" onclick="openActivitiesModal()">
          üéØ <span>Voir les activit√©s</span>
          <span class="content-count" id="activitiesCount">0</span>
        </button>
      </div>
    </div>
    
    <!-- Contr√¥le des nuits -->
    <div class="sheet-section">
      <div class="sheet-section-title">Nombre de nuits</div>
      <div class="nights-control">
        <button class="nights-btn" id="btnNightsMinus">‚àí</button>
        <div>
          <div class="nights-value" id="nightsValue">0</div>
          <div class="nights-label">nuit(s)</div>
        </div>
        <button class="nights-btn" id="btnNightsPlus">+</button>
      </div>
    </div>
    
    <!-- Section r√©servations de l'√©tape -->
    <div class="sheet-section" id="stepBookingsSection" style="display:none">
      <div class="sheet-section-title">Mes r√©servations</div>
      <div class="step-bookings-list" id="stepBookingsList"></div>
    </div>
  </div>
  <div class="sheet-actions">
    <button class="sheet-btn sheet-btn-danger" id="btnDeleteStep">üóëÔ∏è</button>
    <button class="sheet-btn sheet-btn-primary" id="btnCloseSheet">Fermer</button>
  </div>
</div>

<!-- Modale Visites -->
<div class="content-modal" id="visitsModal">
  <div class="content-modal-header">
    <h2>üìç Visites pr√©vues</h2>
    <span class="content-modal-step" id="visitsModalStep"></span>
  </div>
  <div class="content-modal-body" id="visitsModalBody">
    <!-- Contenu rempli dynamiquement -->
  </div>
  <button class="floating-back-btn" onclick="closeVisitsModal()">
    ‚Üê Retour
  </button>
</div>

<!-- Modale Activit√©s -->
<div class="content-modal" id="activitiesModal">
  <div class="content-modal-header">
    <h2>üéØ Activit√©s</h2>
    <span class="content-modal-step" id="activitiesModalStep"></span>
  </div>
  <div class="content-modal-body" id="activitiesModalBody">
    <!-- Contenu rempli dynamiquement -->
  </div>
  <button class="floating-back-btn" onclick="closeActivitiesModal()">
    ‚Üê Retour
  </button>
</div>

<!-- Modale Partage -->
<div class="content-modal" id="shareModal">
  <div class="content-modal-header">
    <h2>üîó Partager ce voyage</h2>
    <span class="content-modal-step" id="shareModalTitle"></span>
  </div>
  <div class="content-modal-body">
    <div class="share-options">
      <!-- Mode de partage -->
      <div class="share-mode-section">
        <label class="share-mode-option">
          <input type="radio" name="shareMode" value="viewer" checked>
          <div class="share-mode-info">
            <span class="share-mode-icon">üëÅÔ∏è</span>
            <div>
              <strong>Lecture seule</strong>
              <p>Peut voir le roadtrip mais pas le modifier</p>
            </div>
          </div>
        </label>
        <label class="share-mode-option">
          <input type="radio" name="shareMode" value="editor">
          <div class="share-mode-info">
            <span class="share-mode-icon">‚úèÔ∏è</span>
            <div>
              <strong>Modification</strong>
              <p>Peut modifier les dates, √©tapes, r√©servations</p>
            </div>
          </div>
        </label>
      </div>
      
      <!-- Avertissement -->
      <div class="share-warning">
        ‚ö†Ô∏è Toute personne avec ce lien pourra acc√©der au voyage
      </div>
      
      <!-- Bouton g√©n√©rer -->
      <button class="share-generate-btn" id="btnGenerateShare" onclick="generateShareLink()">
        üîó G√©n√©rer le lien
      </button>
      
      <!-- R√©sultat (cach√© par d√©faut) -->
      <div class="share-result" id="shareResult" style="display:none">
        <input type="text" class="share-url-input" id="shareUrlInput" readonly>
        <div class="share-actions">
          <button class="share-action-btn" onclick="copyShareLink()">üìã Copier</button>
          <button class="share-action-btn" onclick="nativeShare()">üì§ Partager</button>
        </div>
      </div>
      
      <!-- R√©voquer (cach√© par d√©faut) -->
      <button class="share-revoke-btn" id="btnRevokeShare" style="display:none" onclick="revokeShare()">
        üóëÔ∏è R√©voquer le lien
      </button>
    </div>
  </div>
  <button class="floating-back-btn" onclick="closeShareModal()">
    ‚Üê Retour
  </button>
</div>

<!-- Services Bottom Sheet -->
<div class="bottom-sheet" id="servicesSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">üõéÔ∏è Services voyage</div>
    <div class="sheet-subtitle">R√©servez tout pour votre roadtrip</div>
  </div>
  <div class="sheet-body">
    <div class="service-grid">
      <a class="service-card" href="https://ektatraveling.tpo.li/KrBrIrRc" target="_blank" rel="noopener">
        <span class="service-icon">üõ°Ô∏è</span>
        <span class="service-name">Assurance</span>
        <span class="service-desc">Voyage serein</span>
      </a>
      <a class="service-card" href="https://trip.tpo.li/ljpidUUf" target="_blank" rel="noopener">
        <span class="service-icon">‚úàÔ∏è</span>
        <span class="service-name">Vols</span>
        <span class="service-desc">Meilleurs prix</span>
      </a>
      <a class="service-card" href="https://qeeq.tpo.li/rMRoXmko" target="_blank" rel="noopener">
        <span class="service-icon">üöó</span>
        <span class="service-name">Location auto</span>
        <span class="service-desc">Comparer les offres</span>
      </a>
      <a class="service-card" href="https://gettransfer.tpo.li/NQ4bVvpZ" target="_blank" rel="noopener">
        <span class="service-icon">üöê</span>
        <span class="service-name">Transferts</span>
        <span class="service-desc">A√©roport & plus</span>
      </a>
      <div class="service-card" id="btnScanBooking">
        <span class="service-icon">üì∑</span>
        <span class="service-name">Scanner r√©sa</span>
        <span class="service-desc">Photo ‚Üí import</span>
      </div>
      <div class="service-card" id="btnScanDocument">
        <span class="service-icon">ü™™</span>
        <span class="service-name">Scanner doc</span>
        <span class="service-desc">Passeport, visa...</span>
      </div>
    </div>
  </div>
</div>

<!-- Menu Bottom Sheet -->
<div class="bottom-sheet" id="menuSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">Menu</div>
  </div>
  <div class="sheet-body">
    <div class="menu-item" id="menuSave">
      <span class="menu-icon">üíæ</span>
      <span>Sauvegarder</span>
    </div>
    <div class="menu-item" id="menuShare">
      <span class="menu-icon">üì§</span>
      <span>Partager</span>
    </div>
    <div class="menu-item" id="menuLang">
      <span class="menu-icon">üåê</span>
      <span>Langue</span>
    </div>
    <div class="menu-item" id="menuCenter">
      <span class="menu-icon">üéØ</span>
      <span>Centrer la carte</span>
    </div>
    <div class="menu-item desktop-only" id="menuDesktop">
      <span class="menu-icon">üíª</span>
      <span>√âdition avanc√©e (sur ordi)</span>
    </div>
  </div>
</div>

<!-- User Profile Bottom Sheet -->
<div class="bottom-sheet" id="userSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">Profil</div>
  </div>
  <div class="sheet-body">
    <div id="userInfoSection" style="padding:16px;text-align:center;border-bottom:1px solid #eee;">
      <div id="userEmail" style="font-weight:600;margin-bottom:8px;">Non connect√©</div>
      <div id="userStatus" style="font-size:12px;color:#666;"></div>
    </div>
    <div id="userAuthSection" style="padding:16px;">
      <button id="btnUserLogin" class="btn btn-primary" style="width:100%;margin-bottom:8px;display:none;">üîê Se connecter</button>
      <button id="btnUserLogout" class="btn btn-danger" style="width:100%;margin-bottom:8px;display:none;">üîì D√©connexion</button>
      <button id="btnUserEmail" class="btn" style="width:100%;margin-bottom:8px;display:none;">‚úâÔ∏è Changer email</button>
      <button id="btnUserPassword" class="btn" style="width:100%;margin-bottom:8px;display:none;">üîë Changer mot de passe</button>
      <button id="btnUserDelete" class="btn btn-danger" style="width:100%;display:none;opacity:0.5;">üóëÔ∏è Supprimer compte</button>
    </div>
  </div>
</div>
<div class="bottom-sheet" id="langSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">üåê Langue / Language</div>
  </div>
  <div class="sheet-body">
    <div class="service-grid">
      <div class="service-card lang-option" data-lang="fr">
        <span class="service-icon">üá´üá∑</span>
        <span class="service-name">Fran√ßais</span>
      </div>
      <div class="service-card lang-option" data-lang="en">
        <span class="service-icon">üá¨üáß</span>
        <span class="service-name">English</span>
      </div>
      <div class="service-card lang-option" data-lang="es">
        <span class="service-icon">üá™üá∏</span>
        <span class="service-name">Espa√±ol</span>
      </div>
      <div class="service-card lang-option" data-lang="it">
        <span class="service-icon">üáÆüáπ</span>
        <span class="service-name">Italiano</span>
      </div>
      <div class="service-card lang-option" data-lang="pt">
        <span class="service-icon">üáµüáπ</span>
        <span class="service-name">Portugu√™s</span>
      </div>
      <div class="service-card lang-option" data-lang="ar">
        <span class="service-icon">üá∏üá¶</span>
        <span class="service-name">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
      </div>
    </div>
  </div>
</div>

<!-- Scanner Bottom Sheet -->
<div class="bottom-sheet" id="scannerSheet" style="max-height:90vh;">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title" id="scannerTitle">üì∑ Scanner</div>
    <div class="sheet-subtitle" id="scannerSubtitle">Prenez une photo</div>
  </div>
  <div class="sheet-body" style="padding-bottom:20px;">
    <!-- √âtape 1: Capture -->
    <div id="scanStep1">
      <div style="text-align:center;padding:20px 0;">
        <label for="scannerInput" style="display:inline-flex;flex-direction:column;align-items:center;gap:12px;padding:30px 40px;background:#f0f4f8;border-radius:16px;border:2px dashed #113f7a;cursor:pointer;">
          <span style="font-size:3rem;">üì∑</span>
          <span style="font-weight:600;color:#113f7a;">Prendre une photo</span>
          <span style="font-size:0.85rem;color:#666;">ou choisir dans la galerie</span>
        </label>
        <input type="file" id="scannerInput" accept="image/*" capture="environment" style="display:none;">
      </div>
      <div id="scanPreview" style="display:none;text-align:center;margin-top:16px;">
        <img id="scanPreviewImg" style="max-width:100%;max-height:200px;border-radius:12px;border:1px solid #ddd;">
        <div style="margin-top:12px;display:flex;gap:10px;justify-content:center;">
          <button class="scan-btn secondary" id="btnScanRetake">üîÑ Reprendre</button>
          <button class="scan-btn primary" id="btnScanAnalyze">‚ú® Analyser</button>
        </div>
      </div>
    </div>
    <!-- √âtape 2: Loading -->
    <div id="scanStep2" style="display:none;text-align:center;padding:40px 20px;">
      <div style="font-size:3rem;animation:spin 1s linear infinite;">‚è≥</div>
      <div style="margin-top:16px;color:#666;">Analyse en cours...</div>
    </div>
    <!-- √âtape 3: R√©sultat -->
    <div id="scanStep3" style="display:none;">
      <div id="scanResult" style="background:#f8f9fa;border-radius:12px;padding:16px;margin-bottom:16px;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="scan-btn secondary" id="btnScanNew">üì∑ Nouveau scan</button>
        <button class="scan-btn primary" id="btnScanSave">üíæ Enregistrer</button>
      </div>
    </div>
    <!-- Erreur -->
    <div id="scanError" style="display:none;background:#fee;color:#c33;padding:12px;border-radius:8px;margin-top:16px;text-align:center;"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// Debug logger (console only)
window.debugLog = function(msg) {
  console.log('[MOBILE-DEBUG] ' + msg);
};
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="/js/ort-config.js"></script>
<script src="/js/ort-tripid.js"></script>
<script src="/js/ort-trip-data.js"></script>
<script src="./js/ort-share.js"></script>
<script src="/js/ort-state-manager.js"></script>
<script src="/js/ort-i18n.js"></script>
<script>
// === GLOBAL REDIRECT PROTECTION ===
// Intercept location.replace/assign to ensure desktop redirects include mobile=0
(function(){
  const originalReplace = window.location.replace.bind(window.location);
  const originalAssign = window.location.assign.bind(window.location);

  window.location.replace = function(url) {
    if (typeof url === 'string' && (url.includes('roadtrip_detail') || url.includes('route_builder'))) {
      if (!url.includes('mobile=0')) {
        const sep = url.includes('?') ? '&' : '?';
        url = url + sep + 'mobile=0';
        console.log('[ORT-MOBILE] Protected redirect with mobile=0:', url);
      }
    }
    return originalReplace(url);
  };

  window.location.assign = function(url) {
    if (typeof url === 'string' && (url.includes('roadtrip_detail') || url.includes('route_builder'))) {
      if (!url.includes('mobile=0')) {
        const sep = url.includes('?') ? '&' : '?';
        url = url + sep + 'mobile=0';
        console.log('[ORT-MOBILE] Protected assignment with mobile=0:', url);
      }
    }
    return originalAssign(url);
  };
})();

// === AFFILIATE LINKS ===
// Stay22 Config (align√© avec RT detail)
const STAY22_CONFIG = {
  AID: 'oneroadtrip',
  BASE_ALLEZ: 'https://www.stay22.com/allez/roam',
  MAINCOLOR: '113f7a'
};

const AFFILIATE = {
  // GetYourGuide (lien tpo.li)
  gyg: (city) => `https://getyourguide.tpo.li/YQ9RFXj5?q=${encodeURIComponent(city)}`,
  // Tiqets (lien tpo.li)
  tiqets: (city, lang) => `https://tiqets.tpo.li/L1uxd085?q=${encodeURIComponent(city)}&lang=${lang}`,
  // Stay22 Hotels - utilise allez/roam pour comparateur de prix
  hotel: (lat, lng, city, nights, checkIn, campaign) => {
    const params = new URLSearchParams({
      aid: STAY22_CONFIG.AID,
      campaign: campaign || 'oneroadtrip_mobile',
      lat: lat?.toFixed?.(6) || lat,
      lng: lng?.toFixed?.(6) || lng,
      address: city,
      checkin: checkIn,
      nights: nights
    });
    return `${STAY22_CONFIG.BASE_ALLEZ}?${params.toString()}`;
  }
};

// Placeholder image
const PLACEHOLDER_IMG = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZTJlOGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmaWxsPSIjOTRhM2I4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+8J+TtyBQaG90bzwvdGV4dD48L3N2Zz4=';

// Photo cache
let PHOTOS_CACHE = {};

// Convertir un nom en slug pour matcher les place_id
function toSlug(name) {
  if (!name) return '';
  return name
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // accents
    .replace(/['']/g, '-')
    .replace(/\s+/g, '-')
    .replace(/[^a-z0-9-]/g, '')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
}

// Trouver les photos pour un lieu (essaie plusieurs formats)
function findPhotosForPlace(name, cc) {
  if (!name || !PHOTOS_CACHE) return [];
  
  const slug = toSlug(name);
  const ccUp = (cc || '').toUpperCase();
  
  // Formats √† essayer
  const keys = [
    `${ccUp}::${slug}`,
    `${ccUp}::${name.toLowerCase()}`,
    slug,
    name.toLowerCase()
  ];
  
  for (const key of keys) {
    if (PHOTOS_CACHE[key]?.photos?.length) {
      return PHOTOS_CACHE[key].photos;
    }
  }
  
  // Recherche partielle par nom
  const found = Object.keys(PHOTOS_CACHE).find(k => {
    const kName = k.split('::').pop() || k;
    return kName === slug || kName.includes(slug) || slug.includes(kName);
  });
  
  if (found && PHOTOS_CACHE[found]?.photos?.length) {
    return PHOTOS_CACHE[found].photos;
  }
  
  return [];
}

async function loadPhotosCache() {
  try {
    // Essayer plusieurs chemins possibles
    const paths = [
      './data/photos-json/photos_lieux.json',
      '/data/photos-json/photos_lieux.json',
      '../data/photos-json/photos_lieux.json'
    ];
    for (const path of paths) {
      try {
        const r = await fetch(path, { cache: 'no-store' });
        if (r.ok) {
          PHOTOS_CACHE = await r.json() || {};
          console.log('[PHOTOS] Cache charg√©:', Object.keys(PHOTOS_CACHE).length, 'lieux');
          return;
        }
      } catch (e) { /* try next */ }
    }
    // Fallback localStorage
    const cached = localStorage.getItem('ort.photos_cache');
    if (cached) PHOTOS_CACHE = JSON.parse(cached) || {};
  } catch (e) {
    console.warn('[PHOTOS] Cache non disponible:', e);
  }
}

function getPhotosForPlace(placeId) {
  if (!placeId) return [];
  return (PHOTOS_CACHE[placeId]?.photos) || (PHOTOS_CACHE[placeId]?.images) || [];
}

// === STATE ===
let state = { title: 'Roadtrip', steps: [], cc: '', lang: 'fr', _originalItinId: null };
let map = null;
let markers = [];
let routeLayer = null;
let currentStepIndex = null;
let hasUnsavedChanges = false;
let totalRouteKm = 0;
let CITY_NAMES_INDEX = {};
let PLACES_INDEX = null;

/**
 * Retourne le nom de ville dans la langue demand√©e avec fallbacks
 */
function getCityDisplayName(place, lang) {
  if (!place) return '';
  const pid = place.place_id || place.placeId;
  
  // 1. Chercher dans CITY_NAMES_INDEX
  if (pid && CITY_NAMES_INDEX[pid]?.names) {
    const names = CITY_NAMES_INDEX[pid].names;
    if (names[lang]) return names[lang];
    if (names.en) return names.en;
    if (names.fr) return names.fr;
    if (names._default) return names._default;
  }
  
  // 2. Fallback: place.names
  if (place.names) {
    if (place.names[lang]) return place.names[lang];
    if (place.names.en) return place.names.en;
    if (place.names.fr) return place.names.fr;
  }
  
  // 3. Nom original
  return place.name || '';
}

// === FUNCTIONS POUR CHARGER PLACES ===
async function loadJSON(path){
  try{
    const r=await fetch(path,{cache:'no-store'});
    if(!r.ok) return null;
    const ct = r.headers.get('content-type')||'';
    if(!ct.includes('application/json')) {
      console.warn('[loadJSON] Not JSON:', path, 'content-type:', ct);
      return null;
    }
    return await r.json();
  }catch(e){console.error('[loadJSON] Error:',path,e);return null}
}

async function loadWithLangFallback(baseUrl, lang) {
  const langOrder = [lang, 'en', 'fr'].filter((v, i, a) => a.indexOf(v) === i);
  
  for (const tryLang of langOrder) {
    const url = baseUrl.replace('.json', `-${tryLang}.json`);
    const result = await loadJSON(url);
    if (result) {
      console.log(`[LOAD] ‚úÖ Charg√©: ${url}`);
      return { data: result, lang: tryLang };
    }
  }
  
  const result = await loadJSON(baseUrl);
  if (result) {
    console.log(`[LOAD] ‚ö†Ô∏è Fallback ancien format: ${baseUrl}`);
    return { data: result, lang: 'fr' };
  }
  
  return null;
}

async function ensurePlacesIndex(additionalCountries = []){
  const mainCC = (state.cc || state.country || '').toUpperCase();
  const lang = localStorage.getItem('lang') || 'fr';
  
  const countriesToLoad = new Set();
  if (mainCC) countriesToLoad.add(mainCC);
  
  if (state.steps && state.steps.length > 0) {
    state.steps.forEach(step => {
      if (step.cc) countriesToLoad.add(step.cc.toUpperCase());
    });
  }
  
  additionalCountries.forEach(cc => {
    if (cc) countriesToLoad.add(cc.toUpperCase());
  });
  
  PLACES_INDEX = {};
  
  for (const cc of countriesToLoad) {
    if (!cc) continue;
    const basePath = `./data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc.toLowerCase()}.places.master.json`;
    const result = await loadWithLangFallback(basePath, lang);
    
    if (result && result.data) {
      const obj = result.data;
      const arr = Array.isArray(obj) ? obj : (obj.places || []);
      let count = 0;
      arr.forEach(pl => {
        const pid = pl.place_id || pl.id;
        if (!pid) return;
        if (PLACES_INDEX[pid]) return;
        const visits = Array.isArray(pl.visits) ? pl.visits.map(v => (typeof v === 'string' ? {text:v} : v)) : [];
        const activities = Array.isArray(pl.activities) ? pl.activities.map(a => (typeof a === 'string' ? {text:a} : a)) : [];
        PLACES_INDEX[pid] = {
          lat: Number(pl.lat) || null,
          lon: Number(pl.lon) || Number(pl.lng) || null,
          name: pl.name || pl.title || '',
          rating: Number(pl.rating) || 0,
          suggested_days: Number(pl.suggested_days) || 1,
          visits,
          activities,
          cc: cc
        };
        count++;
      });
      if (count > 0) console.log(`[PLACES] ‚úÖ ${cc}: ${count} lieux charg√©s`);
    }
  }
  
  console.log(`[PLACES] Total: ${Object.keys(PLACES_INDEX).length} lieux dans l'index`);
  
  if (state.steps && state.steps.length > 0) {
    state.steps.forEach(step => {
      if (step.place_id && PLACES_INDEX[step.place_id]) {
        const masterData = PLACES_INDEX[step.place_id];
        if (!step.visits || step.visits.length === 0) {
          step.visits = masterData.visits || [];
        }
        if (!step.activities || step.activities.length === 0) {
          step.activities = masterData.activities || [];
        }
      }
    });
  }
}

// === DOM REFS ===
const $ = id => document.getElementById(id);

// === INIT ===
document.addEventListener('DOMContentLoaded', init);

setTimeout(() => {
  const overlay = $('loadingOverlay');
  if (overlay && !overlay.classList.contains('hide')) {
    overlay.classList.add('hide');
  }
}, 8000);

async function init() {
  console.log('[MOBILE] Init');
  
  // === INITIALISER FIREBASE ===
  try {
    // Attendre que les scripts Firebase soient charg√©s
    let waitCount = 0;
    while (typeof firebase === 'undefined') {
      await new Promise(r => setTimeout(r, 50));
      waitCount++;
      if (waitCount > 100) break; // 5s max
    }
    
    if (typeof firebase !== 'undefined' && firebase.apps && !firebase.apps.length) {
      const host = location.hostname;
      const isPreprod = /oneroadtrip-preprod|localhost|127\.0\.0\.1|0\.0\.0\.0|test-oneroadtrip/.test(host);
      const cfg = isPreprod ? (window.ORT_CONFIG?.PREPROD || {}) : (window.ORT_CONFIG?.PROD || {});
      const safe = (cfg && cfg.apiKey) ? cfg : (window.ORT_CONFIG?.PREPROD || {});
      
      if (safe && safe.apiKey) {
        firebase.initializeApp(safe);
        console.log('[MOBILE] ‚úÖ Firebase initialis√©');
      }
    }
  } catch (e) {
    console.warn('[MOBILE] ‚ö†Ô∏è Erreur init Firebase:', e);
  }
  
  // === INITIALISER ORT_STATE POUR SAUVEGARDE ===
  if (window.ORT_STATE) {
    try {
      // Attendre Firebase Auth
      await new Promise((resolve) => {
        if (typeof firebase !== 'undefined' && firebase.auth) {
          firebase.auth().onAuthStateChanged(user => {
            console.log('[MOBILE] Auth state:', user ? user.email : 'non connect√©');
            resolve(user);
          });
        } else {
          console.log('[MOBILE] Firebase Auth non disponible');
          resolve(null);
        }
      });
      
      const user = typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser;
      await window.ORT_STATE.init({ user: user, premium: false });
      
      if (user) {
        await window.ORT_STATE.updateUser(user);
      }
      console.log('[MOBILE] ‚úÖ ORT_STATE initialis√©');
    } catch (e) {
      console.error('[MOBILE] Erreur init ORT_STATE:', e);
    }
  }
  
  // Charger le cache de photos AVANT tout le reste
  await loadPhotosCache();
  
  const params = new URLSearchParams(location.search);
  const cc = params.get('cc')?.toUpperCase() || '';
  const itinId = params.get('itin') || '';
  const rtKey = params.get('rtKey') || '';
  const tripId = params.get('tripId') || params.get('id') || '';
  const lang = params.get('lang') || localStorage.getItem('ort_lang') || 'fr';
  const fromTemp = params.get('from') === 'temp';
  const builderMode = params.get('mode') === 'builder' || params.get('from') === 'builder';
  const fromBuilderResult = params.get('fromBuilder') === '1';
  const dashboardMode = tripId && tripId.startsWith('trip_');
  
  // === V√âRIFIER HANDOFF DEPUIS RT DETAIL ===
  // Si on vient d'une rotation depuis RT Detail, r√©cup√©rer le tripId du handoff
  const handoffTripId = localStorage.getItem('ORT_MOBILE_HANDOFF');
  const effectiveTripId = tripId || handoffTripId;
  const effectiveDashboardMode = effectiveTripId && (effectiveTripId.startsWith('trip_') || effectiveTripId.startsWith('user::'));
  
  debugLog('======= INIT MOBILE =======');
  debugLog('URL tripId: ' + tripId);
  debugLog('handoffTripId: ' + handoffTripId);
  debugLog('effectiveTripId: ' + effectiveTripId);
  debugLog('effectiveDashboardMode: ' + effectiveDashboardMode);
  debugLog('cc: ' + cc + ' / itinId: ' + itinId);
  debugLog('fromTemp: ' + fromTemp + ' / builderMode: ' + builderMode);
  
  if (handoffTripId) {
    console.log('[MOBILE] üîÑ Handoff d√©tect√© depuis RT Detail:', handoffTripId);
    localStorage.removeItem('ORT_MOBILE_HANDOFF'); // Nettoyer apr√®s utilisation
  }
  
  state.cc = cc;
  state.lang = lang;
  localStorage.setItem('ort_lang', lang);
  
  // INIT ORT_TRIPID - Source de v√©rit√© unique pour le tripId
  if (window.ORT_TRIPID) {
    state.tripId = window.ORT_TRIPID.init({ source: 'mobile' });
    console.log('[MOBILE] TripId initialis√©:', state.tripId);
  }
  
  setupTabs();
  setupEvents();
  
  try {
    debugLog('Mode s√©lectionn√©...');
    if (fromBuilderResult) {
      debugLog('‚Üí loadBuilderResult');
      await loadBuilderResult();
    } else if (builderMode) {
      debugLog('‚Üí initRouteBuilder');
      await initRouteBuilder(params);
    } else if (effectiveDashboardMode) {
      debugLog('‚Üí loadFromDashboard(' + effectiveTripId + ')');
      await loadFromDashboard(effectiveTripId);
    } else if (fromTemp && rtKey) {
      debugLog('‚Üí loadFromTemp');
      await loadFromTemp(rtKey);
    } else if (rtKey) {
      debugLog('‚Üí loadFromFirebase');
      await loadFromFirebase(rtKey);
    } else if (cc && itinId) {
      debugLog('‚Üí loadItinerary');
      await loadItinerary(cc, itinId, lang);
    } else {
      debugLog('‚ùå Aucun mode correspondant!');
      throw new Error('Aucun itin√©raire sp√©cifi√©');
    }
    
    // Charger les noms multilingues pour tous les pays des steps
    const countriesToLoad = new Set();
    if (state.cc) countriesToLoad.add(state.cc.toUpperCase());
    if (state.steps && state.steps.length > 0) {
      state.steps.forEach(step => {
        let stepCC = step.cc;
        if (!stepCC && (step.place_id || step.placeId)) {
          const pid = step.place_id || step.placeId;
          if (pid.includes('::')) stepCC = pid.split('::')[0];
        }
        if (stepCC) countriesToLoad.add(stepCC.toUpperCase());
      });
    }
    
    for (const cc of countriesToLoad) {
      const namesPaths = [
        `./data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc.toLowerCase()}_names.json`,
        `./data/Roadtripsprefabriques/countries/${cc.toUpperCase()}/${cc.toLowerCase()}_names.json`,
        `./data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc.toUpperCase()}_names.json`,
        `./data/Roadtripsprefabriques/countries/${cc.toUpperCase()}/${cc.toUpperCase()}_names.json`
      ];
      for (const namesPath of namesPaths) {
        try {
          const namesResp = await fetch(namesPath);
          if (namesResp.ok) {
            const namesData = await namesResp.json();
            for (const [pid, data] of Object.entries(namesData)) {
              if (!CITY_NAMES_INDEX[pid]) CITY_NAMES_INDEX[pid] = data;
            }
            console.log(`[NAMES] ‚úÖ ${cc}: ${Object.keys(namesData).length} noms charg√©s`);
            break;
          }
        } catch (e) { /* next path */ }
      }
    }
    
    debugLog('Chargement termin√©! state.steps=' + state.steps.length);
    debugLog('Appel renderList...');
    renderList();
    debugLog('Appel renderBookings...');
    renderBookings();
    debugLog('Appel updateSummary...');
    updateSummary();
    debugLog('Appel initMap...');
    initMap();
    $('headerTitle').textContent = state.title || 'Roadtrip';
    debugLog('‚úÖ RENDU TERMIN√â - ' + state.title);
    
  } catch (err) {
    debugLog('‚ùå ERREUR: ' + err.message);
    console.error('[MOBILE] Error:', err);
    if (err.message !== 'Redirection en cours...') {
      showToast('‚ùå ' + (err.message || 'Erreur'));
      // Afficher message d'erreur au lieu de d√©mo
      state.title = '‚ùå Erreur';
      state.steps = [];
      renderList();
      renderBookings();
      updateSummary();
      initMap();
    }
  }
  
  setTimeout(() => $('loadingOverlay')?.classList.add('hide'), 300);
}

// === LOAD FROM TEMP (localStorage) ===
async function loadFromTemp(rtKey) {
  console.log('[MOBILE] loadFromTemp:', rtKey);
  
  const rawItins = localStorage.getItem(`ORT_TEMP_TRIP_${rtKey}_itins`);
  const rawPlaces = localStorage.getItem(`ORT_TEMP_TRIP_${rtKey}_places`);
  
  if (!rawItins) throw new Error('Itin√©raire temporaire non trouv√©');
  
  let itinsObj, placesObj;
  try {
    itinsObj = JSON.parse(rawItins);
    placesObj = rawPlaces ? JSON.parse(rawPlaces) : {};
  } catch (e) {
    throw new Error('Donn√©es corrompues');
  }
  
  // Trouver l'itin√©raire √† utiliser
  let toUse = null;
  if (Array.isArray(itinsObj.days_plan) || Array.isArray(itinsObj.places)) {
    toUse = itinsObj;
  } else if (itinsObj.itineraries?.[0]) {
    toUse = itinsObj.itineraries[0];
  } else if (itinsObj.itins?.[0]) {
    toUse = itinsObj.itins[0];
  }
  
  if (!toUse) throw new Error('Structure itin√©raire invalide');
  
  // Extraire les √©tapes
  const rawSteps = toUse.days_plan || toUse.places || toUse.steps || [];
  state.title = toUse.title || toUse.name || 'Roadtrip';
  state.cc = toUse.itin_id ? toUse.itin_id.split('::')[0].toUpperCase() : (itinsObj.country || 'XX');
  state._originalItinId = rtKey;
  
  state.steps = rawSteps.map((s, idx) => {
    let photos = [];
    if (Array.isArray(s.images) && s.images.length) photos = s.images;
    else if (Array.isArray(s.photos) && s.photos.length) photos = s.photos;
    else if (s.image) photos = [s.image];
    else if (s.photo) photos = [s.photo];
    else if (s.placeId && placesObj[s.placeId]?.photos) photos = placesObj[s.placeId].photos;
    
    return {
      _idx: idx,
      name: s.name || s.place_name || `√âtape ${idx + 1}`,
      lat: s.lat || s.latitude,
      lng: s.lng || s.lon || s.longitude,
      nights: s.nights || s.adjustedDays || 0,
      description: s.description || s.desc || '',
      photos: photos,
      distance_km: s.distance_km || s.to_next_leg?.distance_km || 0,
      placeId: s.placeId || s.place_id || null
    };
  });
  
  console.log(`[MOBILE] Loaded ${state.steps.length} steps from temp`);
  
  // Charger les visites et activit√©s des places depuis le master
  if (state.cc) {
    await ensurePlacesIndex([state.cc]);
  }
}

// === LOAD FROM DASHBOARD (Firestore users/{uid}/trips/{tripId}) ===
async function loadFromDashboard(tripId) {
  debugLog('======= loadFromDashboard =======');
  debugLog('tripId: ' + tripId);
  debugLog('URL: ' + location.href);
  
  // === ESSAYER D'ABORD LOCALSTORAGE (rapide, fonctionne offline) ===
  const localKey = `ort_trip_${tripId}`;
  const localData = localStorage.getItem(localKey);
  debugLog('localStorage key: ' + localKey);
  debugLog('localStorage existe: ' + (!!localData));
  
  if (localData) {
    try {
      const tripData = JSON.parse(localData);
      debugLog('localStorage parsed: ' + tripData?.title + ' / ' + tripData?.steps?.length + ' √©tapes');
      if (tripData && tripData.steps && tripData.steps.length > 0) {
        debugLog('‚úÖ Charg√© depuis localStorage!');
        await applyTripDataToState(tripData);
        
        // IMPORTANT: Charger aussi ORT_TRIP_DATA pour les bookings (stock√©s s√©par√©ment)
        if (window.ORT_TRIP_DATA) {
          try {
            debugLog('üì• Chargement ORT_TRIP_DATA pour les bookings...');
            await window.ORT_TRIP_DATA.loadTrip(tripId);
            debugLog('‚úÖ ORT_TRIP_DATA charg√© (bookings disponibles)');
          } catch (e) {
            debugLog('‚ö†Ô∏è ORT_TRIP_DATA: ' + e.message);
          }
        }
        
        return; // Succ√®s !
      } else {
        debugLog('‚ö†Ô∏è localStorage steps vide/invalide');
      }
    } catch (e) {
      debugLog('‚ùå Erreur parsing localStorage: ' + e.message);
    }
  }
  
  // === SINON ESSAYER FIRESTORE ===
  debugLog('üì• Tentative Firestore...');
  debugLog('firebase d√©fini: ' + (typeof firebase !== 'undefined'));
  debugLog('ORT_CONFIG d√©fini: ' + (!!window.ORT_CONFIG));
  
  // Attendre que Firebase soit charg√© et initialis√©
  let waitCount = 0;
  while (typeof firebase === 'undefined' || !firebase.apps) {
    await new Promise(r => setTimeout(r, 100));
    waitCount++;
    if (waitCount > 50) {
      debugLog('‚ùå Firebase jamais charg√© apr√®s 5s');
      throw new Error('Firebase non disponible');
    }
  }
  debugLog('Firebase apps.length: ' + firebase.apps.length);
  
  // Initialiser Firebase si pas encore fait
  if (!firebase.apps.length) {
    const host = location.hostname;
    const isPreprod = /oneroadtrip-preprod|localhost|127\.0\.0\.1|0\.0\.0\.0|test-oneroadtrip/.test(host);
    debugLog('Host: ' + host + ' isPreprod: ' + isPreprod);
    
    const cfg = isPreprod ? (window.ORT_CONFIG?.PREPROD || {}) : (window.ORT_CONFIG?.PROD || {});
    const safe = (cfg && cfg.apiKey) ? cfg : (window.ORT_CONFIG?.PREPROD || {});
    debugLog('Config apiKey: ' + (!!safe?.apiKey));
    
    if (safe && safe.apiKey) {
      firebase.initializeApp(safe);
      debugLog('‚úÖ Firebase initialis√©');
    } else {
      debugLog('‚ùå Pas de config Firebase!');
      throw new Error('Config Firebase manquante');
    }
  }
  
  // Attendre firebase.auth
  debugLog('firebase.auth dispo: ' + (!!firebase.auth));
  waitCount = 0;
  while (!firebase.auth) {
    await new Promise(r => setTimeout(r, 100));
    waitCount++;
    if (waitCount > 30) {
      debugLog('‚ùå firebase.auth jamais dispo');
      throw new Error('Firebase Auth non disponible');
    }
  }
  
  // === ATTENDRE L'UTILISATEUR ===
  // L'auth est probablement d√©j√† faite dans l'init, v√©rifier d'abord currentUser
  let user = firebase.auth().currentUser;
  if (!user) {
    debugLog('‚è≥ Pas de currentUser, attente auth...');
    user = await new Promise((resolve) => {
      const unsubscribe = firebase.auth().onAuthStateChanged((u) => {
        debugLog('Auth re√ßu: ' + (u?.email || 'non connect√©'));
        unsubscribe();
        resolve(u);
      });
      setTimeout(() => {
        debugLog('‚ö†Ô∏è Timeout auth 3s');
        unsubscribe();
        resolve(null);
      }, 3000); // R√©duit √† 3s
    });
  } else {
    debugLog('‚úÖ currentUser d√©j√† pr√©sent: ' + user.email);
  }
  
  if (!user) {
    debugLog('‚ùå Non connect√©!');
    throw new Error('Connectez-vous pour voir ce voyage');
  }
  
  // === CHARGER DEPUIS FIRESTORE ===
  debugLog('üì• Firestore: users/' + user.uid + '/trips/' + tripId);
  
  try {
    // M√âTHODE 1: Utiliser ORT_STATE qui d√©s√©rialise correctement
    if (window.ORT_STATE) {
      debugLog('Tentative via ORT_STATE...');
      const trip = await window.ORT_STATE.getTrip(tripId);
      if (trip && trip.steps && trip.steps.length > 0) {
        debugLog('‚úÖ ORT_STATE: ' + trip.title + ' / ' + trip.steps.length + ' steps');
        await applyTripDataToState(trip);
        
        // Charger aussi ORT_TRIP_DATA pour les bookings
        if (window.ORT_TRIP_DATA) {
          try {
            await window.ORT_TRIP_DATA.loadTrip(tripId);
            debugLog('‚úÖ ORT_TRIP_DATA charg√©');
          } catch (e) {
            debugLog('‚ö†Ô∏è ORT_TRIP_DATA: ' + e.message);
          }
        }
        
        // Cache localStorage
        localStorage.setItem(localKey, JSON.stringify(trip));
        debugLog('üíæ Mis en cache localStorage');
        return;
      }
    }
    
    // M√âTHODE 2: Fallback direct Firestore avec d√©s√©rialisation manuelle
    debugLog('Fallback: lecture Firestore directe...');
    const db = firebase.firestore();
    const tripRef = db.collection('users').doc(user.uid).collection('trips').doc(tripId);
    const tripDoc = await tripRef.get();
    debugLog('Doc exists: ' + tripDoc.exists);
    
    if (!tripDoc.exists) {
      debugLog('‚ùå Doc non trouv√© dans Firestore');
      throw new Error('Voyage non trouv√©');
    }
    
    const tripData = tripDoc.data();
    debugLog('üìÑ Firestore brut: ' + tripData?.title);
    
    // D√©s√©rialiser les steps si c'est une string JSON
    if (tripData.steps && typeof tripData.steps === 'string') {
      try {
        tripData.steps = JSON.parse(tripData.steps);
        debugLog('üîì Steps d√©s√©rialis√©s: ' + tripData.steps.length);
      } catch (e) {
        debugLog('‚ùå Erreur d√©s√©rialisation steps');
      }
    }
    
    debugLog('Steps apr√®s d√©s√©rialisation: ' + (tripData.steps?.length || 0));
    await applyTripDataToState(tripData);
    
    // Charger ORT_TRIP_DATA pour les bookings
    if (window.ORT_TRIP_DATA) {
      try {
        await window.ORT_TRIP_DATA.loadTrip(tripId);
        debugLog('‚úÖ ORT_TRIP_DATA charg√©');
        // Debug: v√©rifier les bookings par √©tape
        state.steps.forEach((s, i) => {
          const bookings = ORT_TRIP_DATA.getStepBookings(i) || [];
          if (bookings.length > 0) {
            console.log(`[BOOKING-DEBUG] √âtape ${i+1} (${s.name}): ${bookings.length} r√©sa(s)`, bookings.map(b => b.name));
          }
        });
      } catch (e) {
        debugLog('‚ö†Ô∏è ORT_TRIP_DATA: ' + e.message);
      }
    }
    
    // Cache localStorage
    localStorage.setItem(localKey, JSON.stringify(tripData));
    debugLog('üíæ Mis en cache localStorage');
    
  } catch (e) {
    debugLog('‚ùå Erreur: ' + e.message);
    throw e;
  }
  
  debugLog('======= FIN loadFromDashboard =======');
}

// Applique les donn√©es du trip au state
async function applyTripDataToState(tripData) {
  debugLog('applyTripDataToState: ' + tripData?.title + ' / ' + tripData?.steps?.length + ' steps');
  
  state.title = tripData.title || tripData.name || 'Roadtrip';
  state.cc = tripData.country || tripData.cc || 'XX';
  state.tripId = tripData.id || tripData.tripId;
  state._originalItinId = tripData.itinId || tripData._originalItinId;
  state.startDateStr = tripData.startDateStr || tripData.startDate || '';
  
  // Convertir les steps
  const rawSteps = tripData.steps || [];
  state.steps = rawSteps.map((s, idx) => {
    // Photos
    let photos = [];
    if (Array.isArray(s.photos) && s.photos.length) photos = s.photos;
    else if (Array.isArray(s.images) && s.images.length) photos = s.images;
    else if (s.photo) photos = [s.photo];
    else if (s.image) photos = [s.image];
    
    return {
      _idx: idx,
      name: s.name || s.place_name || `√âtape ${idx + 1}`,
      lat: s.lat || s.latitude,
      lng: s.lng || s.lon || s.longitude,
      nights: Number(s.nights) || 0,
      description: s.description || s.desc || '',
      photos: photos,
      distance_km: s.distance_km || s.to_next_leg?.distance_km || s._distanceKmToNext || 0,
      drive_min: s.drive_min || s.to_next_leg?.drive_min || s._driveMinToNext || 0,
      placeId: s.placeId || s.place_id || null,
      visits: s.visits || s.pois || [],
      activities: s.activities || [],
    };
  });
  
  debugLog('‚úÖ state.steps = ' + state.steps.length);
  
  // Charger les visites et activit√©s des places depuis le master si vides
  if (state.cc) {
    await ensurePlacesIndex([state.cc]);
  }
  
  // Budget si pr√©sent
  if (tripData.totalBudget) {
    state.totalBudget = tripData.totalBudget;
  }
}

// === ROUTE BUILDER ===
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

async function initRouteBuilder(params) {
  console.log('[MOBILE-BUILDER] Redirection vers RT Detail pour calcul...');
  
  // Construire l'URL vers RT Detail avec returnTo=mobile
  const newParams = new URLSearchParams(params);
  newParams.set('returnTo', 'mobile');
  
  // Rediriger vers RT Detail qui fera le calcul
  const url = `roadtrip_detail.html?${newParams.toString()}`;
  console.log('[MOBILE-BUILDER] Redirect:', url);
  
  showToast('üîÑ Calcul de l\'itin√©raire...');
  
  // Petit d√©lai pour voir le toast
  setTimeout(() => {
    window.location.href = url;
  }, 500);
  
  // Ne jamais arriver ici, mais au cas o√π
  throw new Error('Redirection en cours...');
}

// Charger le r√©sultat du builder depuis localStorage
async function loadBuilderResult() {
  console.log('[MOBILE] Chargement r√©sultat builder...');
  
  const raw = localStorage.getItem('ORT_BUILDER_RESULT');
  if (!raw) throw new Error('R√©sultat builder non trouv√©');
  
  const data = JSON.parse(raw);
  if (!data || !data.steps?.length) throw new Error('Donn√©es builder invalides');
  
  state.title = data.title || 'Roadtrip';
  state.cc = data.cc || 'XX';
  state._fromBuilder = true;
  
  state.steps = data.steps.map((s, idx) => {
    // R√©cup√©rer photos
    let photos = s.images || s.photos || [];
    if (!photos.length && s.name) {
      photos = findPhotosForPlace(s.name, s.cc || state.cc);
    }
    
    return {
      _idx: idx,
      name: s.name,
      lat: s.lat,
      lng: s.lng || s.lon,
      nights: s.nights || 0,
      description: s.description || '',
      photos: photos,
      distance_km: s.distance_km || s.to_next_leg?.distance_km || 0,
      placeId: s.place_id || null,
      visits: s.visits || [],
      activities: s.activities || []
    };
  });
  
  // === RESTAURER LES R√âSERVATIONS ===
  if (data.bookings && typeof globalMobileBookingManager !== 'undefined' && globalMobileBookingManager) {
    state.bookings = data.bookings;
    
    // Charger dans le gestionnaire de r√©servations mobile
    Object.entries(data.bookings).forEach(([stepIdx, bookings]) => {
      if (Array.isArray(bookings)) {
        bookings.forEach(booking => {
          globalMobileBookingManager.addBooking(booking);
        });
      }
    });
    
    console.log('[MOBILE] ‚úÖ R√©servations restaur√©es:', Object.keys(data.bookings).length, '√©tapes');
  }
  
  console.log(`[MOBILE] Builder result: ${state.steps.length} √©tapes`);
  
  // Nettoyer localStorage
  localStorage.removeItem('ORT_BUILDER_RESULT');
}

async function calculateOSRMRoute(start, end) {
  const urlCoords = `${start.lon},${start.lat};${end.lon},${end.lat}`;
  const url = `https://router.project-osrm.org/route/v1/driving/${urlCoords}?overview=full&geometries=geojson`;
  
  try {
    const resp = await fetch(url, { signal: AbortSignal.timeout(10000) });
    const data = await resp.json();
    
    if (data.code === 'Ok' && data.routes?.[0]) {
      const route = data.routes[0];
      const rawCoords = route.geometry.coordinates; // [lon, lat]
      
      // Simplifier √† ~100 points et convertir en [lat, lon]
      const step = Math.max(1, Math.floor(rawCoords.length / 100));
      const routeCoords = [];
      for (let i = 0; i < rawCoords.length; i += step) {
        routeCoords.push([rawCoords[i][1], rawCoords[i][0]]);
      }
      if (routeCoords[routeCoords.length-1][0] !== rawCoords[rawCoords.length-1][1]) {
        routeCoords.push([rawCoords[rawCoords.length-1][1], rawCoords[rawCoords.length-1][0]]);
      }
      
      // Distances cumul√©es
      const cumDist = [0];
      for (let i = 1; i < routeCoords.length; i++) {
        cumDist.push(cumDist[i-1] + haversineDistance(routeCoords[i-1][0], routeCoords[i-1][1], routeCoords[i][0], routeCoords[i][1]));
      }
      
      return {
        coords: routeCoords,
        distance: Math.round(route.distance / 1000),
        cumDist,
        isReal: true
      };
    }
  } catch (e) {
    console.warn('[MOBILE-BUILDER] OSRM failed:', e);
  }
  
  // Fallback: ligne droite
  const totalDist = haversineDistance(start.lat, start.lon, end.lat, end.lon);
  const numPoints = Math.max(10, Math.ceil(totalDist / 50));
  const fallbackCoords = [];
  for (let i = 0; i <= numPoints; i++) {
    const t = i / numPoints;
    fallbackCoords.push([start.lat + t * (end.lat - start.lat), start.lon + t * (end.lon - start.lon)]);
  }
  const cumDist = [0];
  for (let i = 1; i < fallbackCoords.length; i++) {
    cumDist.push(cumDist[i-1] + haversineDistance(fallbackCoords[i-1][0], fallbackCoords[i-1][1], fallbackCoords[i][0], fallbackCoords[i][1]));
  }
  return { coords: fallbackCoords, distance: Math.round(totalDist), cumDist, isReal: false };
}

async function loadPlacesForRoute(config, routeData) {
  const SEARCH_RADIUS = 50; // km
  const countries = new Set();
  if (config.start.cc) countries.add(config.start.cc);
  if (config.end.cc) countries.add(config.end.cc);
  
  // D√©tecter pays travers√©s via bbox
  const COUNTRY_BBOX = {
    'FR': { minLat: 41, maxLat: 51.5, minLon: -5.5, maxLon: 10 },
    'ES': { minLat: 35.5, maxLat: 44, minLon: -10, maxLon: 5 },
    'PT': { minLat: 36.5, maxLat: 42.5, minLon: -10, maxLon: -6 },
    'IT': { minLat: 35.5, maxLat: 47.5, minLon: 6, maxLon: 19 },
    'CH': { minLat: 45.5, maxLat: 48, minLon: 5.5, maxLon: 10.5 },
    'DE': { minLat: 47, maxLat: 55.5, minLon: 5.5, maxLon: 15.5 },
    'BE': { minLat: 49.5, maxLat: 51.5, minLon: 2.5, maxLon: 6.5 },
    'NL': { minLat: 50.5, maxLat: 53.5, minLon: 3, maxLon: 7.5 },
    'AT': { minLat: 46.5, maxLat: 49, minLon: 9.5, maxLon: 17 },
    'PL': { minLat: 49, maxLat: 55, minLon: 14, maxLon: 24 }
  };
  
  for (const [lat, lon] of routeData.coords) {
    for (const [cc, bbox] of Object.entries(COUNTRY_BBOX)) {
      if (lat >= bbox.minLat && lat <= bbox.maxLat && lon >= bbox.minLon && lon <= bbox.maxLon) {
        countries.add(cc);
      }
    }
  }
  
  console.log('[MOBILE-BUILDER] Pays:', Array.from(countries).join(', '));
  
  // Charger les places de chaque pays
  const allPlaces = {};
  const lang = state.lang || 'fr';
  
  for (const cc of countries) {
    try {
      const url = `./data/places-json/${cc.toLowerCase()}.places-${lang}.json`;
      const resp = await fetch(url);
      if (!resp.ok) continue;
      const data = await resp.json();
      
      const placesArray = data.places || data;
      for (const p of placesArray) {
        if (!p.lat || !p.lng && !p.lon) continue;
        const plat = p.lat;
        const plon = p.lng || p.lon;
        
        // V√©rifier si proche de la route
        let minDist = Infinity;
        for (const [rlat, rlon] of routeData.coords) {
          const d = haversineDistance(plat, plon, rlat, rlon);
          if (d < minDist) minDist = d;
        }
        
        if (minDist <= SEARCH_RADIUS) {
          const slug = toSlug(p.name);
          const id = p.place_id || `${cc}::${slug}`;
          
          // R√©cup√©rer photos du cache
          let photos = p.photos || (p.photo ? [p.photo] : []);
          if (!photos.length) {
            photos = findPhotosForPlace(p.name, cc);
          }
          
          allPlaces[id] = { ...p, lat: plat, lng: plon, _distToRoute: minDist, cc, photos, placeId: id };
        }
      }
    } catch (e) {
      console.warn(`[MOBILE-BUILDER] Failed to load ${cc}:`, e);
    }
  }
  
  return allPlaces;
}

function selectStepsAlongRoute(config, routeData, places) {
  const totalDist = routeData.distance;
  const targetSteps = Math.max(2, Math.ceil(totalDist / config.maxKm));
  const stepDist = totalDist / targetSteps;
  
  console.log(`[MOBILE-BUILDER] Target: ${targetSteps} √©tapes, ~${Math.round(stepDist)}km entre chaque`);
  
  // Ajouter d√©part avec recherche de photos
  const startPhotos = findPhotosForPlace(config.start.name, config.start.cc);
  const steps = [{
    name: config.start.name,
    lat: config.start.lat,
    lng: config.start.lon,
    nights: 1,
    description: 'Point de d√©part',
    photos: startPhotos,
    placeId: `${config.start.cc}::${toSlug(config.start.name)}`,
    _progress: 0,
    _isEndpoint: true
  }];
  
  // Convertir places en array avec progress
  const placesList = Object.values(places).map(p => {
    // Calculer progress sur la route
    let bestProgress = 0;
    let minDist = Infinity;
    for (let i = 0; i < routeData.coords.length; i++) {
      const d = haversineDistance(p.lat, p.lng, routeData.coords[i][0], routeData.coords[i][1]);
      if (d < minDist) {
        minDist = d;
        bestProgress = routeData.cumDist[i] / totalDist;
      }
    }
    return { ...p, _progress: bestProgress };
  });
  
  // S√©lectionner √©tapes interm√©diaires
  for (let i = 1; i < targetSteps; i++) {
    const targetProgress = i / targetSteps;
    
    // Trouver le meilleur candidat
    let best = null;
    let bestScore = -Infinity;
    
    for (const p of placesList) {
      // D√©j√† utilis√© ?
      if (steps.some(s => s.name === p.name)) continue;
      
      const progressDiff = Math.abs(p._progress - targetProgress);
      if (progressDiff > 0.3) continue; // Trop loin du target
      
      // Score bas√© sur: proximit√© du target progress + rating + faible d√©tour
      const score = (1 - progressDiff * 3) * 50 + 
                    (p.global_rating || p.rating || 3) * 10 -
                    (p._distToRoute || 0) * 0.5;
      
      if (score > bestScore) {
        bestScore = score;
        best = p;
      }
    }
    
    if (best) {
      // R√©cup√©rer photos du cache
      const placeId = best.placeId || best.place_id || `${best.cc}::${toSlug(best.name)}`;
      let photos = best.photos || [];
      
      // Chercher dans PHOTOS_CACHE si pas de photos
      if (!photos.length) {
        photos = findPhotosForPlace(best.name, best.cc);
      }
      
      steps.push({
        name: best.name || best.place_name,
        lat: best.lat,
        lng: best.lng,
        nights: 1,
        description: best.description || best.desc || '',
        photos: photos,
        placeId: placeId,
        _progress: best._progress
      });
    }
  }
  
  // Ajouter arriv√©e avec recherche de photos
  const endPhotos = findPhotosForPlace(config.end.name, config.end.cc);
  steps.push({
    name: config.end.name,
    lat: config.end.lat,
    lng: config.end.lon,
    nights: 1,
    description: 'Point d\'arriv√©e',
    photos: endPhotos,
    placeId: `${config.end.cc}::${toSlug(config.end.name)}`,
    _progress: 1,
    _isEndpoint: true
  });
  
  // Trier par progress
  steps.sort((a, b) => a._progress - b._progress);
  
  // Calculer distances entre √©tapes
  for (let i = 0; i < steps.length - 1; i++) {
    steps[i].distance_km = Math.round(haversineDistance(
      steps[i].lat, steps[i].lng,
      steps[i+1].lat, steps[i+1].lng
    ));
  }
  steps[steps.length - 1].distance_km = 0;
  
  return steps;
}

function autoCalculateNights(totalDays) {
  if (!state.steps.length) return;
  
  const total = totalDays || 7;
  const perStep = Math.floor(total / state.steps.length);
  let remaining = total - perStep * state.steps.length;
  
  state.steps.forEach((s, i) => {
    s.nights = perStep + (i < remaining ? 1 : 0);
  });
  
  // Derni√®re √©tape = 0 nuit (fin du voyage)
  if (state.steps.length > 1) {
    state.steps[state.steps.length - 1].nights = 0;
  }
}

// === DATA LOADING ===
// === Fonctions pour supporter les itin√©raires compos√©s ===
function isComposedId(id) {
  return typeof id === 'string' && id.startsWith('COMPOSED::');
}

function parseComposedIds(id) {
  if (!isComposedId(id)) return [];
  return id.replace('COMPOSED::', '').split('+').map(decodeURIComponent).filter(Boolean);
}

async function loadItinerary(cc, itinId, lang) {
  const baseUrl = './data/Roadtripsprefabriques/countries';
  
  // === TRAITER COMPOSED ===
  if (isComposedId(itinId)) {
    const ids = parseComposedIds(itinId);
    const allSteps = [];
    const allTitles = [];
    
    // Charger chaque itin√©raire depuis son pays
    for (const id of ids) {
      try {
        // Parser l'ID pour extraire le pays si pr√©sent (format: CC::slug ou juste slug/id)
        let ccForItin = cc;
        let idToSearch = id;
        
        if (id.includes('::')) {
          const parts = id.split('::');
          ccForItin = parts[0];
          idToSearch = parts.slice(1).join('::');
        }
        
        const ccLower = ccForItin.toLowerCase();
        const url = `${baseUrl}/${ccLower}/${ccLower}.itins.modules-${lang}.json`;
        
        const resp = await fetch(url);
        if (!resp.ok) continue;
        
        const data = await resp.json();
        const itins = data.itins || data.itineraries || data || [];
        const itin = itins.find(i => {
          const checkId = i.id || i.itin_id || '';
          return checkId === idToSearch || checkId === id;
        });
        
        if (!itin) continue;
        
        allTitles.push(itin.title || itin.name || 'RT');
        
        const daysPlan = itin.days_plan || itin.steps || [];
        daysPlan.forEach((day, idx) => {
          const nightData = day.night || {};
          const placeId = nightData.place_id || day.place_id || '';
          const coords = nightData.coords || [];
          const suggestedDays = day.suggested_days || 1;
          const driveMin = day.to_next_leg?.drive_min || 0;
          const distanceKm = day.to_next_leg?.distance_km || 0;
          
          let transportBonus = driveMin > 300 ? 1.0 : driveMin > 180 ? 0.5 : 0;
          const nights = Math.max(0, Math.round(suggestedDays + transportBonus));
          
          let name = day.name || '';
          if (!name && placeId) {
            const parts = placeId.split('::');
            name = parts[parts.length - 1]?.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || `√âtape ${idx + 1}`;
          }
          
          const visits = Array.isArray(day.visits) ? day.visits : [];
          const description = visits.map(v => typeof v === 'string' ? v : v.text).filter(Boolean).join(' ');
          
          let photos = [];
          if (Array.isArray(day.photos) && day.photos.length) photos = day.photos;
          else if (Array.isArray(day.images) && day.images.length) photos = day.images;
          else if (typeof day.image === 'string' && day.image) photos = [day.image];
          else if (typeof day.photo === 'string' && day.photo) photos = [day.photo];
          else if (typeof day.thumb === 'string' && day.thumb) photos = [day.thumb];
          
          allSteps.push({
            _idx: allSteps.length,
            name: name || `√âtape ${idx + 1}`,
            lat: coords[0] || day.lat,
            lng: coords[1] || day.lng || day.lon,
            nights, description,
            photos: photos,
            distance_km: distanceKm,
            placeId: day.place_id || day.placeId || placeId
          });
        });
      } catch (e) {
        console.error(`[COMPOSED] Erreur chargement ${id}:`, e);
      }
    }
    
    if (allSteps.length === 0) throw new Error('Aucun itin√©raire compos√© n\'a pu √™tre charg√©');
    
    state.title = allTitles.join(' + ');
    state._originalItinId = itinId;
    state.cc = cc;
    state.steps = allSteps;
    return;
  }
  
  // === CAS NORMAL: UN SEUL ITIN√âRAIRE ===
  const ccLower = cc.toLowerCase();
  const url = `${baseUrl}/${ccLower}/${ccLower}.itins.modules-${lang}.json`;
  
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  
  const data = await resp.json();
  const itins = data.itins || data.itineraries || data || [];
  const itin = itins.find(i => (i.id || i.itin_id) === itinId);
  if (!itin) throw new Error('Itin√©raire non trouv√©');
  
  state.title = itin.title || itin.name || 'Roadtrip';
  state._originalItinId = itinId;
  state.cc = cc;
  
  const steps = [];
  const daysPlan = itin.days_plan || itin.steps || [];
  
  daysPlan.forEach((day, idx) => {
    const nightData = day.night || {};
    const placeId = nightData.place_id || day.place_id || '';
    const coords = nightData.coords || [];
    const suggestedDays = day.suggested_days || 1;
    const driveMin = day.to_next_leg?.drive_min || 0;
    const distanceKm = day.to_next_leg?.distance_km || 0;
    
    let transportBonus = driveMin > 300 ? 1.0 : driveMin > 180 ? 0.5 : 0;
    const nights = Math.max(0, Math.round(suggestedDays + transportBonus));
    
    let name = day.name || '';
    if (!name && placeId) {
      const parts = placeId.split('::');
      name = parts[parts.length - 1]?.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || `√âtape ${idx + 1}`;
    }
    
    const visits = Array.isArray(day.visits) ? day.visits : [];
    const description = visits.map(v => typeof v === 'string' ? v : v.text).filter(Boolean).join(' ');
    
    // R√©cup√©rer les photos avec plusieurs fallbacks
    let photos = [];
    if (Array.isArray(day.photos) && day.photos.length) photos = day.photos;
    else if (Array.isArray(day.images) && day.images.length) photos = day.images;
    else if (typeof day.image === 'string' && day.image) photos = [day.image];
    else if (typeof day.photo === 'string' && day.photo) photos = [day.photo];
    else if (typeof day.thumb === 'string' && day.thumb) photos = [day.thumb];
    
    steps.push({
      _idx: steps.length,
      name: name || `√âtape ${idx + 1}`,
      lat: coords[0] || day.lat,
      lng: coords[1] || day.lng || day.lon,
      nights, description,
      photos: photos,
      distance_km: distanceKm,
      placeId: day.place_id || day.placeId || placeId
    });
  });
  
  state.steps = steps;
}

async function loadFromFirebase(rtKey) {
  if (typeof firebase === 'undefined') {
    await new Promise(r => setTimeout(r, 1000));
    if (typeof firebase === 'undefined') throw new Error('Firebase non disponible');
  }
  
  const doc = await firebase.firestore().collection('trips').doc(rtKey).get();
  if (!doc.exists) throw new Error('Voyage non trouv√©');
  
  const data = doc.data();
  state.title = data.title || 'Roadtrip';
  state._originalItinId = rtKey;
  state.cc = data.cc || 'FR';
  state.steps = (data.steps || []).map((s, idx) => {
    // R√©cup√©rer les photos avec plusieurs fallbacks
    let photos = [];
    if (Array.isArray(s.images) && s.images.length) photos = s.images;
    else if (Array.isArray(s.photos) && s.photos.length) photos = s.photos;
    else if (typeof s.image === 'string' && s.image) photos = [s.image];
    else if (typeof s.photo === 'string' && s.photo) photos = [s.photo];
    else if (typeof s.thumb === 'string' && s.thumb) photos = [s.thumb];
    else if (typeof s.img === 'string' && s.img) photos = [s.img];
    // Fallback: chercher dans cachedPhotos si disponible
    else if (s.placeId && window._cachedPhotos?.[s.placeId]) {
      photos = [window._cachedPhotos[s.placeId]];
    }
    
    return {
      _idx: idx,
      name: s.name || `√âtape ${idx + 1}`,
      lat: s.lat, lng: s.lng || s.lon,
      nights: s.nights || s.adjustedDays || 0,
      description: s.description || '',
      photos: photos,
      distance_km: s.distance_km || 0,
      placeId: s.placeId || null
    };
  });
}

// === RENDER BOOKINGS (4e onglet) ===
function renderBookings() {
  const container = $('bookingsContainer');
  if (!container) return;
  
  let html = '';
  let totalBudget = 0;
  
  // Helper pour formater les dates
  function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString(state.lang || 'fr', { day: '2-digit', month: '2-digit', year: 'numeric' });
    } catch (e) {
      return dateStr;
    }
  }
  
  // Helper pour afficher la ligne de date
  function getDateLine(b, nights) {
    let dateParts = [];
    if (b.date_start) {
      dateParts.push(formatDate(b.date_start));
    }
    if (b.date_end && b.date_end !== b.date_start) {
      dateParts.push(formatDate(b.date_end));
    }
    
    let line = '';
    if (dateParts.length === 1) {
      line = `üìÖ ${dateParts[0]}`;
    } else if (dateParts.length === 2) {
      line = `üìÖ ${dateParts[0]} ‚Üí ${dateParts[1]}`;
    }
    
    // Ajouter les nuits si applicable (h√¥tels)
    if (nights && nights > 0) {
      line += line ? ` (${nights} nuit${nights > 1 ? 's' : ''})` : `üåô ${nights} nuit${nights > 1 ? 's' : ''}`;
    }
    
    return line;
  }
  
  // === R√âSERVATIONS VOYAGE (vols, voiture, assurance) ===
  let travelBookings = [];
  if (window.ORT_TRIP_DATA) {
    travelBookings = ORT_TRIP_DATA.getTravelBookings() || [];
  }
  
  if (travelBookings.length > 0) {
    html += `<div class="booking-section">
      <h3 class="booking-section-title">üåç R√©servations voyage</h3>`;
    
    travelBookings.forEach(b => {
      const icon = getCategoryIcon(b.category);
      const price = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : 0;
      totalBudget += parseFloat(price) || 0;
      const dateLine = getDateLine(b, b.nights);
      
      html += `
        <div class="booking-item" onclick="showBookingDetail(${JSON.stringify(b).replace(/"/g, '&quot;')})">
          <div class="booking-icon">${icon}</div>
          <div class="booking-info">
            <div class="booking-name">${b.name || 'R√©servation'}</div>
            ${dateLine ? `<div class="booking-detail">${dateLine}</div>` : ''}
            ${b.provider ? `<div class="booking-detail">üè¢ ${b.provider}</div>` : ''}
          </div>
          ${price ? `<div class="booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</div>` : ''}
        </div>
      `;
    });
    
    html += '</div>';
  }
  
  // === R√âSERVATIONS PAR √âTAPE (h√¥tels, activit√©s) ===
  const stepBookingsMap = new Map(); // Pour d√©dupliquer
  
  if (window.ORT_TRIP_DATA) {
    state.steps.forEach((step, stepIdx) => {
      const stepBookings = ORT_TRIP_DATA.getStepBookings(stepIdx) || [];
      stepBookings.forEach(b => {
        const bookingId = b.id || `${b.name}-${b.date_start || ''}-${b.category}`;
        if (!stepBookingsMap.has(bookingId)) {
          stepBookingsMap.set(bookingId, {
            booking: b,
            steps: [stepIdx],
            firstStepIndex: stepIdx
          });
        } else {
          const existing = stepBookingsMap.get(bookingId);
          if (!existing.steps.includes(stepIdx)) {
            existing.steps.push(stepIdx);
          }
        }
      });
    });
  } else if (state.bookings) {
    // Fallback: ancien format state.bookings
    Object.entries(state.bookings).forEach(([stepIdx, bookings]) => {
      bookings.forEach(b => {
        const bookingId = b.id || `${b.name}-${b.date_start || ''}-${b.category}`;
        if (!stepBookingsMap.has(bookingId)) {
          stepBookingsMap.set(bookingId, {
            booking: b,
            steps: [parseInt(stepIdx)],
            firstStepIndex: parseInt(stepIdx)
          });
        }
      });
    });
  }
  
  if (stepBookingsMap.size > 0) {
    // Grouper par premi√®re √©tape
    const byStep = new Map();
    stepBookingsMap.forEach((data, id) => {
      const firstStep = data.firstStepIndex;
      if (!byStep.has(firstStep)) byStep.set(firstStep, []);
      byStep.get(firstStep).push(data);
    });
    
    byStep.forEach((bookingsData, stepIdx) => {
      const step = state.steps[stepIdx];
      if (!step) return;
      
      html += `<div class="booking-section">
        <h3 class="booking-section-title">üìç ${step.name}</h3>`;
      
      bookingsData.forEach(data => {
        const b = data.booking;
        const icon = getCategoryIcon(b.category);
        const price = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : 0;
        totalBudget += parseFloat(price) || 0;
        
        // Calculer le nombre de nuits (pour h√¥tels)
        const nights = b.category === 'hotel' ? (b.nights || data.steps.length) : b.nights;
        const dateLine = getDateLine(b, nights);
        
        html += `
          <div class="booking-item">
            <div class="booking-icon">${icon}</div>
            <div class="booking-info">
              <div class="booking-name">${b.name || 'R√©servation'}</div>
              ${dateLine ? `<div class="booking-detail">${dateLine}</div>` : ''}
              ${b.address ? `<div class="booking-detail">üìç ${b.address}</div>` : ''}
              ${b.reference ? `<div class="booking-detail">üîñ ${b.reference}</div>` : ''}
            </div>
            ${price ? `<div class="booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</div>` : ''}
          </div>
        `;
      });
      
      html += '</div>';
    });
  }
  
  // V√©rifier s'il y a des r√©servations
  if (!html) {
    container.innerHTML = `
      <div style="padding: 40px 20px; text-align: center; color: #999;">
        <div style="font-size: 3rem; margin-bottom: 16px;">üìã</div>
        <div>Aucune r√©servation</div>
        <div style="font-size: 0.85rem; margin-top: 8px;">Ajoutez des r√©servations depuis RT Detail</div>
      </div>`;
    return;
  }
  
  // Budget total
  if (totalBudget > 0) {
    html += `
      <div class="booking-budget">
        <div class="budget-label">üí∞ Budget total</div>
        <div class="budget-amount">${totalBudget.toFixed(2)} ‚Ç¨</div>
      </div>
    `;
  }
  
  container.innerHTML = html;
}

function getCategoryIcon(category) {
  const icons = {
    lodging: 'üè®',
    hotel: 'üè®',
    flight: '‚úàÔ∏è',
    car: 'üöó',
    train: 'üöÜ',
    restaurant: 'üçΩÔ∏è',
    activity: 'üéØ',
    other: 'üìÑ'
  };
  return icons[category] || 'üìÑ';
}

function calculateDayNumber(dateStr, startDate) {
  // Simplifi√©: assume que c'est le jour calcul√© depuis la date de d√©part
  if (!startDate) return 1;
  const date = new Date(dateStr);
  const start = new Date(startDate);
  const diffTime = date - start;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return diffDays + 1;
}

// === TABS ===
function setupTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.id === 'tabServices') {
        openSheet($('servicesSheet'));
        return;
      }
      
      const panelId = btn.dataset.panel;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      $(panelId)?.classList.add('active');
      
      if (panelId === 'mapPanel' && map) {
        setTimeout(() => { map.invalidateSize(); fitMapBounds(); }, 100);
      }
    });
  });
}

// === EVENTS ===
function setupEvents() {
  $('btnBack').onclick = () => {
    if (hasUnsavedChanges && !confirm('Modifications non sauvegard√©es. Quitter ?')) return;
    history.back();
  };
  
  $('btnMenu').onclick = () => openSheet($('menuSheet'));
  
  // === SHARE BUTTON ===
  $('btnShare').onclick = () => {
    const u = currentUser();
    if(!u){ showLoginModalForSave(); return; }
    
    const tripId = state?.tripId;
    if (!tripId || tripId.startsWith('temp_') || tripId.startsWith('catalog::')) {
      showSaveBeforeShareModal();
      return;
    }
    
    if (typeof ORT_SHARE !== 'undefined' && ORT_SHARE.showModal) {
      const tripTitle = state?.title || 'Voyage';
      ORT_SHARE.showModal(tripId, tripTitle);
    } else {
      showToast('‚ùå Module de partage non disponible');
    }
  };
  
  // === USER PROFILE BUTTON ===
  $('btnUser').onclick = () => {
    updateUserUI();
    openSheet($('userSheet'));
  };
  $('sheetOverlay').onclick = closeAllSheets;
  
  $('btnNightsMinus').onclick = () => adjustNights(-1);
  $('btnNightsPlus').onclick = () => adjustNights(1);
  $('btnDeleteStep').onclick = deleteCurrentStep;
  $('btnCloseSheet').onclick = closeAllSheets;
  
  $('menuSave').onclick = saveTrip;
  $('menuShare').onclick = shareTrip;
  $('menuLang').onclick = () => { closeAllSheets(); openSheet($('langSheet')); };
  $('menuCenter').onclick = centerMap;
  
  // Handlers changement de langue
  document.querySelectorAll('.lang-option').forEach(opt => {
    opt.onclick = () => {
      const newLang = opt.dataset.lang;
      localStorage.setItem('lang', newLang);
      state.lang = newLang;
      closeAllSheets();
      showToast(`‚úÖ Langue: ${newLang.toUpperCase()}`);
      setTimeout(() => location.reload(), 500);
    };
  });
  $('menuDesktop').onclick = showDesktopMessage;
}

// === USER PROFILE MANAGEMENT ===
function updateUserUI() {
  try {
    const user = window.firebase?.auth?.()?.currentUser;
    const emailEl = $('userEmail');
    const statusEl = $('userStatus');
    const loginBtn = $('btnUserLogin');
    const logoutBtn = $('btnUserLogout');
    const emailBtn = $('btnUserEmail');
    const passBtn = $('btnUserPassword');
    const deleteBtn = $('btnUserDelete');
    
    if (user) {
      emailEl.textContent = user.email || 'Utilisateur';
      statusEl.textContent = `Connect√© depuis ${new Date(user.metadata.creationTime).toLocaleDateString('fr-FR')}`;
      
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'block';
      emailBtn.style.display = 'block';
      passBtn.style.display = 'block';
      deleteBtn.style.display = 'block';
    } else {
      emailEl.textContent = 'Non connect√©';
      statusEl.textContent = 'Connexion requise';
      
      loginBtn.style.display = 'block';
      logoutBtn.style.display = 'none';
      emailBtn.style.display = 'none';
      passBtn.style.display = 'none';
      deleteBtn.style.display = 'none';
    }
  } catch (e) {
    console.warn('[USER] Error updating UI:', e);
  }
}

// Gestion des boutons utilisateur
(function() {
  const $ = id => document.getElementById(id);
  
  $('btnUserLogin').onclick = () => {
    closeSheet($('userSheet'));
    if (window.openAuth) window.openAuth();
    else alert('Redirection vers la connexion...');
  };
  
  $('btnUserLogout').onclick = () => {
    if (confirm('Confirmer la d√©connexion?')) {
      window.firebase?.auth?.().signOut().then(() => {
        closeSheet($('userSheet'));
        updateUserUI();
        showToast('üëã D√©connect√©');
      });
    }
  };
  
  $('btnUserEmail').onclick = () => {
    const newEmail = prompt('Nouvel email:');
    if (newEmail && newEmail.trim()) {
      const user = window.firebase?.auth?.()?.currentUser;
      if (user) {
        user.verifyBeforeUpdateEmail(newEmail.trim()).then(() => {
          showToast('‚úÖ V√©rification envoy√©e √† ' + newEmail);
        }).catch(e => showToast('‚ùå ' + e.message));
      }
    }
  };
  
  $('btnUserPassword').onclick = () => {
    const user = window.firebase?.auth?.()?.currentUser;
    if (user && user.email) {
      window.firebase?.auth?.().sendPasswordResetEmail(user.email).then(() => {
        showToast('‚úÖ Email de r√©initialisation envoy√©');
      }).catch(e => showToast('‚ùå ' + e.message));
    }
  };
  
  $('btnUserDelete').onclick = () => {
    if (confirm('‚ö†Ô∏è Cette action est irr√©versible. Supprimer le compte?')) {
      if (confirm('√ätes-vous vraiment s√ªr?')) {
        const user = window.firebase?.auth?.()?.currentUser;
        if (user) {
          user.delete().then(() => {
            showToast('‚ùå Compte supprim√©');
            setTimeout(() => location.href = 'dashboard_user.html', 1000);
          }).catch(e => showToast('Erreur: ' + e.message));
        }
      }
    }
  };
})();

// === RENDERING ===

// Tracking des photos utilis√©es pour √©viter les doublons
const usedPhotos = new Set();

// R√©cup√©rer toutes les photos disponibles pour une √©tape (ordre de priorit√©)
function getAllStepPhotos(step) {
  const photos = [];
  
  // 1. PRIORIT√â: Photos sauvegard√©es dans Firestore (step.photos ou step.images)
  if (step.photos?.length) {
    photos.push(...step.photos.filter(p => p && typeof p === 'string'));
  }
  if (step.images?.length) {
    step.images.forEach(img => {
      const url = typeof img === 'string' ? img : img?.url;
      if (url && !photos.includes(url)) photos.push(url);
    });
  }
  if (step.image && !photos.includes(step.image)) photos.push(step.image);
  
  // 2. Photos du cache via placeId
  if (step.placeId) {
    const cached = getPhotosForPlace(step.placeId);
    cached.forEach(p => { if (!photos.includes(p)) photos.push(p); });
  }
  
  // 3. Chercher par nom avec la fonction smart
  const found = findPhotosForPlace(step.name, state.cc);
  found.forEach(p => { if (!photos.includes(p)) photos.push(p); });
  
  return photos;
}

// Choisir la meilleure photo pour une √©tape (√©vite les doublons)
function getStepPhoto(step, stepIdx = -1) {
  const allPhotos = getAllStepPhotos(step);
  
  // Trouver une photo pas encore utilis√©e
  for (const photo of allPhotos) {
    if (!usedPhotos.has(photo)) {
      if (stepIdx >= 0) usedPhotos.add(photo); // Marquer comme utilis√©e
      return photo;
    }
  }
  
  // Si toutes les photos sont utilis√©es, utiliser un index rotatif
  if (allPhotos.length > 0 && stepIdx >= 0) {
    // Utiliser l'index de l'√©tape pour choisir une photo diff√©rente
    const photoIndex = stepIdx % allPhotos.length;
    return allPhotos[photoIndex];
  }
  
  // Si toutes les photos sont utilis√©es, prendre la premi√®re disponible
  if (allPhotos.length > 0) {
    return allPhotos[0];
  }
  
  return PLACEHOLDER_IMG;
}

// Reset les photos utilis√©es (appel√© au chargement d'un nouveau trip)
function resetUsedPhotos() {
  usedPhotos.clear();
}

// Charger une image avec timeout et fallback
function loadImageWithFallback(imgElement, urls, timeoutMs = 3000) {
  if (!urls || urls.length === 0) {
    imgElement.src = PLACEHOLDER_IMG;
    return;
  }
  
  let currentIndex = 0;
  let timeoutId = null;
  
  function tryNext() {
    if (currentIndex >= urls.length) {
      imgElement.src = PLACEHOLDER_IMG;
      return;
    }
    
    const url = urls[currentIndex];
    currentIndex++;
    
    // Clear previous timeout
    if (timeoutId) clearTimeout(timeoutId);
    
    // Set timeout pour passer √† la suivante si trop lent
    timeoutId = setTimeout(() => {
      console.log(`[PHOTO] Timeout pour ${url.substring(0, 50)}..., essai suivant`);
      tryNext();
    }, timeoutMs);
    
    imgElement.onload = () => {
      if (timeoutId) clearTimeout(timeoutId);
    };
    
    imgElement.onerror = () => {
      if (timeoutId) clearTimeout(timeoutId);
      console.log(`[PHOTO] Erreur pour ${url.substring(0, 50)}..., essai suivant`);
      tryNext();
    };
    
    imgElement.src = url;
  }
  
  tryNext();
}

function renderList() {
  const list = $('stepsList');
  list.innerHTML = '';
  const lang = state.lang || 'fr';
  
  // Reset les photos utilis√©es pour ce rendu
  resetUsedPhotos();
  
  state.steps.forEach((step, idx) => {
    const card = document.createElement('div');
    card.className = 'step-card';
    card.onclick = () => openStepSheet(idx);
    
    // Utiliser getStepPhoto avec l'index pour √©viter les doublons
    const photoUrl = getStepPhoto(step, idx);
    const nightsText = step.nights > 0 ? `${step.nights} nuit${step.nights > 1 ? 's' : ''}` : '';
    const distText = step.distance_km ? `${Math.round(step.distance_km)} km` : '';
    const stepDisplayName = getCityDisplayName(step, lang) || step.name;
    
    // V√©rifier si l'√©tape a des r√©servations
    let bookingIndicator = '';
    if (window.ORT_TRIP_DATA) {
      const stepBookings = ORT_TRIP_DATA.getStepBookings(idx) || [];
      if (stepBookings.length > 0) {
        const hasHotel = stepBookings.some(b => b.category === 'hotel');
        const hasActivity = stepBookings.some(b => ['activity', 'visit', 'show'].includes(b.category));
        if (hasHotel || hasActivity) {
          bookingIndicator = `<span class="step-card-booking">${hasHotel ? 'üè®' : 'üé´'}</span>`;
        }
      }
    }
    
    card.innerHTML = `
      <div class="step-card-num">${idx + 1}</div>
      <img class="step-card-photo" data-step-idx="${idx}" src="${PLACEHOLDER_IMG}" alt="" loading="lazy">
      <div class="step-card-info">
        <div class="step-card-name">${stepDisplayName}</div>
        <div class="step-card-meta">${distText}</div>
        ${step.nights > 0 ? `<div class="step-card-nights">üåô ${nightsText}${bookingIndicator}</div>` : (bookingIndicator ? `<div class="step-card-nights">${bookingIndicator}</div>` : '')}
      </div>
      <div class="step-card-chevron">‚Ä∫</div>
    `;
    list.appendChild(card);
    
    // Charger l'image avec fallback et timeout
    const imgEl = card.querySelector('.step-card-photo');
    // Filtrer les photos d√©j√† utilis√©es par d'autres √©tapes
    const allPhotos = getAllStepPhotos(step);
    const availablePhotos = allPhotos.filter(p => !usedPhotos.has(p));
    // Utiliser les photos disponibles, ou toutes si aucune disponible
    const photosToUse = availablePhotos.length > 0 ? availablePhotos : allPhotos;
    if (photosToUse.length > 0) {
      // Marquer la premi√®re comme utilis√©e
      usedPhotos.add(photosToUse[0]);
      loadImageWithFallback(imgEl, photosToUse, 3000);
    } else {
      console.warn(`[PHOTO] Aucune photo pour √©tape ${idx + 1}: ${step.name}`);
    }
  });
}

function updateSummary() {
  const totalSteps = state.steps.length;
  const totalNights = state.steps.reduce((sum, s) => sum + (s.nights || 0), 0);
  const km = totalRouteKm || state.steps.reduce((sum, s) => sum + (s.distance_km || 0), 0);
  
  $('statSteps').textContent = totalSteps;
  $('statNights').textContent = totalNights;
  $('statKm').textContent = Math.round(km);
}

// === MAP ===
function initMap() {
  if (typeof L === 'undefined') { setTimeout(initMap, 100); return; }
  if (map) return;
  
  map = L.map('map', { zoomControl: true, attributionControl: false });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    maxZoom: 19, subdomains: 'abcd'
  }).addTo(map);
  
  renderMarkers();
  fetchAndDrawRoute();
  fitMapBounds();
}

function renderMarkers() {
  if (!map) return;
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  
  state.steps.forEach((step, idx) => {
    if (!step.lat || !step.lng) return;
    
    const icon = L.divIcon({
      className: 'step-marker',
      html: `${idx + 1}`,
      iconSize: [26, 26],
      iconAnchor: [13, 13]
    });
    
    const marker = L.marker([step.lat, step.lng], { icon });
    marker.on('click', () => {
      const currentStep = state.steps[idx];
      const photoUrl = getStepPhoto(currentStep);
      const popupName = getCityDisplayName(currentStep, state.lang || 'fr') || currentStep.name;
      marker.bindPopup(`
        <div class="map-popup-mini">
          <img src="${photoUrl}" onerror="this.src='${PLACEHOLDER_IMG}'">
          <div class="name">${popupName}</div>
          <button class="btn-details" onclick="openStepSheet(${idx})">Voir d√©tails</button>
        </div>
      `).openPopup();
    });
    marker.addTo(map);
    markers.push(marker);
  });
}

async function fetchAndDrawRoute() {
  if (!map) return;
  const coords = state.steps.filter(s => s.lat && s.lng).map(s => [s.lng, s.lat]);
  if (coords.length < 2) return;
  
  try {
    const coordsStr = coords.map(c => c.join(',')).join(';');
    const resp = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordsStr}?overview=full&geometries=geojson`, { signal: AbortSignal.timeout(10000) });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    
    const data = await resp.json();
    if (data.code !== 'Ok' || !data.routes?.[0]) throw new Error('No route');
    
    const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
    totalRouteKm = Math.round(data.routes[0].distance / 1000);
    
    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.polyline(routeCoords, { color: '#113f7a', weight: 4, opacity: 0.8 }).addTo(map);
    $('statKm').textContent = totalRouteKm;
  } catch (err) {
    console.warn('[ROUTE] Fallback:', err.message);
    const fallbackCoords = state.steps.filter(s => s.lat && s.lng).map(s => [s.lat, s.lng]);
    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.polyline(fallbackCoords, { color: '#113f7a', weight: 3, opacity: 0.7, dashArray: '8,8' }).addTo(map);
  }
}

function fitMapBounds() {
  if (!map) return;
  const coords = state.steps.filter(s => s.lat && s.lng).map(s => [s.lat, s.lng]);
  if (coords.length > 0) map.fitBounds(coords, { padding: [30, 30] });
}

function centerMap() {
  closeAllSheets();
  fitMapBounds();
  $('tabMap').click();
  showToast('üéØ Carte centr√©e');
}

// === SHEETS ===
function openSheet(sheet) {
  $('sheetOverlay').classList.add('show');
  sheet.classList.add('show');
}

function closeSheet(sheet) {
  $('sheetOverlay').classList.remove('show');
  sheet.classList.remove('show');
}

function closeAllSheets() {
  $('sheetOverlay').classList.remove('show');
  $('stepSheet').classList.remove('show');
  $('menuSheet').classList.remove('show');
  $('servicesSheet').classList.remove('show');
  $('langSheet').classList.remove('show');
  $('scannerSheet').classList.remove('show');
  $('userSheet').classList.remove('show');
  currentStepIndex = null;
}

// Variables pour stocker les visites/activit√©s de l'√©tape courante
let currentStepVisits = [];
let currentStepActivities = [];

function openStepSheet(idx) {
  currentStepIndex = idx;
  const step = state.steps[idx];
  const lang = state.lang || 'fr';
  
  $('sheetStepName').textContent = getCityDisplayName(step, lang) || step.name;
  $('sheetStepMeta').textContent = `√âtape ${idx + 1} sur ${state.steps.length}`;
  
  $('nightsValue').textContent = step.nights || 0;
  
  // Boutons de navigation
  $('btnPrevStep').disabled = idx === 0;
  $('btnNextStep').disabled = idx === state.steps.length - 1;
  
  // Stocker les visites et activit√©s
  currentStepVisits = Array.isArray(step.visits) ? step.visits : [];
  currentStepActivities = Array.isArray(step.activities) ? step.activities : [];
  
  // Si vides, chercher dans PLACES_INDEX (comme RT detail)
  if (step.place_id && PLACES_INDEX && PLACES_INDEX[step.place_id]) {
    const masterData = PLACES_INDEX[step.place_id];
    if (currentStepVisits.length === 0 && masterData.visits) {
      currentStepVisits = masterData.visits;
      step.visits = currentStepVisits;  // Mettre √† jour le step aussi
    }
    if (currentStepActivities.length === 0 && masterData.activities) {
      currentStepActivities = masterData.activities;
      step.activities = currentStepActivities;  // Mettre √† jour le step aussi
    }
  }
  
  // Mettre √† jour les compteurs
  const visitsCount = currentStepVisits.length;
  const activitiesCount = currentStepActivities.length;
  $('visitsCount').textContent = visitsCount || '';
  $('visitsCount').dataset.count = visitsCount;
  $('activitiesCount').textContent = activitiesCount || '';
  $('activitiesCount').dataset.count = activitiesCount;
  
  // Masquer les boutons si pas de contenu
  $('btnOpenVisits').style.display = visitsCount > 0 ? '' : 'none';
  $('btnOpenActivities').style.display = activitiesCount > 0 ? '' : 'none';
  
  // Charger la photo avec fallback et timeout
  const photoEl = $('sheetStepPhoto');
  const allPhotos = getAllStepPhotos(step);
  if (allPhotos.length > 0) {
    loadImageWithFallback(photoEl, allPhotos, 3000);
  } else {
    photoEl.src = PLACEHOLDER_IMG;
  }
  
  // Liens affili√©s pour cette √©tape
  const cityName = step.name || '';
  const checkIn = new Date().toISOString().split('T')[0];
  const nights = step.nights || 1;
  const campaign = `ort_mobile_step${idx + 1}`;
  
  $('btnGyg').href = AFFILIATE.gyg(cityName);
  $('btnTiqets').href = AFFILIATE.tiqets(cityName, state.lang);
  // Stay22 - toujours visible, utilise 1 nuit minimum pour le lien
  $('btnHotel').href = AFFILIATE.hotel(step.lat, step.lng, cityName, Math.max(1, nights), checkIn, campaign);
  $('btnHotel').style.display = ''; // Toujours visible
  
  // Afficher les r√©servations de cette √©tape
  const bookingsSection = $('stepBookingsSection');
  const bookingsList = $('stepBookingsList');
  
  if (window.ORT_TRIP_DATA) {
    const stepBookings = ORT_TRIP_DATA.getStepBookings(idx) || [];
    if (stepBookings.length > 0) {
      bookingsSection.style.display = '';
      bookingsList.innerHTML = stepBookings.map(b => {
        const icon = getCategoryIcon(b.category);
        const price = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : null;
        let dateStr = '';
        if (b.date_start) {
          const ds = new Date(b.date_start).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
          if (b.date_end && b.date_end !== b.date_start) {
            const de = new Date(b.date_end).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            const nights = Math.ceil((new Date(b.date_end) - new Date(b.date_start)) / 86400000);
            dateStr = `${ds} ‚Üí ${de}${nights > 0 ? ` (${nights} nuit${nights > 1 ? 's' : ''})` : ''}`;
          } else {
            dateStr = ds;
          }
        }
        return `
          <div class="step-booking-item">
            <div class="step-booking-icon">${icon}</div>
            <div class="step-booking-info">
              <div class="step-booking-name">${b.name || 'R√©servation'}</div>
              ${dateStr ? `<div class="step-booking-dates">üìÖ ${dateStr}</div>` : ''}
            </div>
            ${price ? `<div class="step-booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</div>` : ''}
          </div>
        `;
      }).join('');
    } else {
      bookingsSection.style.display = 'none';
    }
  } else {
    bookingsSection.style.display = 'none';
  }
  
  openSheet($('stepSheet'));
}

// Navigation entre √©tapes
function navigateStep(delta) {
  const newIdx = currentStepIndex + delta;
  if (newIdx >= 0 && newIdx < state.steps.length) {
    openStepSheet(newIdx);
  }
}

// === MODALES VISITES / ACTIVIT√âS ===

function openVisitsModal() {
  const step = state.steps[currentStepIndex];
  const stepName = getCityDisplayName(step, state.lang) || step.name;
  
  $('visitsModalStep').textContent = `${stepName} - √âtape ${currentStepIndex + 1}`;
  
  const body = $('visitsModalBody');
  if (currentStepVisits.length === 0) {
    body.innerHTML = '<div class="content-empty">Aucune visite pr√©vue pour cette √©tape</div>';
  } else {
    body.innerHTML = currentStepVisits.map((v, i) => {
      const text = typeof v === 'string' ? v : (v.text || v.description || v.name || '');
      const title = typeof v === 'object' && v.title ? v.title : `Visite ${i + 1}`;
      return `
        <div class="content-item">
          ${typeof v === 'object' && v.title ? `<div class="content-item-title">${title}</div>` : ''}
          <div class="content-item-text">${text}</div>
        </div>
      `;
    }).join('');
  }
  
  $('visitsModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeVisitsModal() {
  $('visitsModal').classList.remove('open');
  document.body.style.overflow = '';
}

function openActivitiesModal() {
  const step = state.steps[currentStepIndex];
  const stepName = getCityDisplayName(step, state.lang) || step.name;
  
  $('activitiesModalStep').textContent = `${stepName} - √âtape ${currentStepIndex + 1}`;
  
  const body = $('activitiesModalBody');
  if (currentStepActivities.length === 0) {
    body.innerHTML = '<div class="content-empty">Aucune activit√© pr√©vue pour cette √©tape</div>';
  } else {
    body.innerHTML = currentStepActivities.map((a, i) => {
      const text = typeof a === 'string' ? a : (a.text || a.description || a.name || '');
      const title = typeof a === 'object' && a.title ? a.title : `Activit√© ${i + 1}`;
      return `
        <div class="content-item">
          ${typeof a === 'object' && a.title ? `<div class="content-item-title">${title}</div>` : ''}
          <div class="content-item-text">${text}</div>
        </div>
      `;
    }).join('');
  }
  
  $('activitiesModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeActivitiesModal() {
  $('activitiesModal').classList.remove('open');
  document.body.style.overflow = '';
}

// === ACTIONS ===
function adjustNights(delta) {
  if (currentStepIndex === null) return;
  const step = state.steps[currentStepIndex];
  step.nights = Math.max(0, (step.nights || 0) + delta);
  $('nightsValue').textContent = step.nights;
  hasUnsavedChanges = true;
  
  // MAJ lien h√¥tel - toujours visible, utilise 1 nuit minimum
  const checkIn = new Date().toISOString().split('T')[0];
  const campaign = `ort_mobile_step${currentStepIndex + 1}`;
  $('btnHotel').href = AFFILIATE.hotel(step.lat, step.lng, step.name, Math.max(1, step.nights), checkIn, campaign);
  $('btnHotel').style.display = ''; // Toujours visible
  
  renderList();
  renderBookings();
  updateSummary();
}

function deleteCurrentStep() {
  if (currentStepIndex === null) return;
  const step = state.steps[currentStepIndex];
  if (!confirm(`Supprimer "${step.name}" ?`)) return;
  
  state.steps.splice(currentStepIndex, 1);
  hasUnsavedChanges = true;
  closeAllSheets();
  renderList();
  renderBookings();
  updateSummary();
  renderMarkers();
  fetchAndDrawRoute();
  showToast('üóëÔ∏è √âtape supprim√©e');
}

async function saveTrip() {
  closeAllSheets();
  try {
    // V√©rifier si Firebase est disponible et utilisateur connect√©
    const user = typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser;
    
    if (user && window.ORT_STATE) {
      // Utilise ORT_TRIPID pour garantir un tripId coh√©rent
      let tripId = window.ORT_TRIPID ? window.ORT_TRIPID.get() : null;
      if (!tripId) {
        tripId = state.tripId || state._originalItinId || `mobile::${Date.now()}`;
      }
      
      // üî¥ D√âTECTION CATALOGUE: Forcer g√©n√©ration NEW tripId si c'est un catalogue
      if (tripId && tripId.startsWith('catalog::')) {
        console.log('[SAVE] üìö D√©tection catalogue, g√©n√©ration NEW tripId');
        tripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        console.log('[SAVE] ‚úÖ NEW tripId g√©n√©r√©:', tripId);
      }
      
      if (window.ORT_TRIPID) window.ORT_TRIPID.store(tripId);
      
      const tripData = {
        id: tripId,
        title: state.title || 'Roadtrip',
        country: state.cc || 'XX',
        steps: state.steps.map(s => ({
          name: s.name,
          lat: s.lat,
          lon: s.lng || s.lon,
          lng: s.lng || s.lon,
          nights: s.nights || 0,
          place_id: s.place_id || s.placeId,
          photos: s.photos || [],
          description: s.description || ''
        })),
        nights: state.steps.reduce((sum, s) => sum + (s.nights || 0), 0),
        kms: state.totalKm || 0,
        saved: true,  // IMPORTANT: Pour appara√Ætre dans le Dashboard
        updatedAt: Date.now(),
        createdAt: state._createdAt || Date.now(),
        source: 'mobile'
      };
      
      // Sauvegarder via State Manager
      await window.ORT_STATE.saveTrip(tripData);
      
      // Mettre √† jour le tripId dans state pour les sauvegardes suivantes
      state.tripId = tripId;
      if (window.ORT_TRIPID) window.ORT_TRIPID.store(tripId);
      
      hasUnsavedChanges = false;
      showToast('‚úÖ Sauvegard√© dans votre Dashboard !');
      console.log('[SAVE] ‚úÖ Trip sauvegard√© via ORT_STATE:', tripId);
    } else if (user) {
      // Fallback Firestore direct si ORT_STATE non disponible
      console.warn('[SAVE] ORT_STATE non disponible, fallback Firestore direct');
      let tripId = state._originalItinId || `mobile_${Date.now()}`;
      
      // üî¥ D√âTECTION CATALOGUE: Forcer g√©n√©ration NEW tripId si c'est un catalogue
      if (tripId && tripId.startsWith('catalog::')) {
        console.log('[SAVE] üìö D√©tection catalogue (fallback), g√©n√©ration NEW tripId');
        tripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }
      
      const tripData = {
        title: state.title || 'Roadtrip',
        cc: state.cc || 'XX',
        steps: state.steps.map(s => ({
          name: s.name,
          lat: s.lat,
          lng: s.lng || s.lon,
          nights: s.nights || 0,
          place_id: s.place_id || s.placeId,
          photos: s.photos || [],
          description: s.description || ''
        })),
        saved: true,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        userId: user.uid,
        source: 'mobile'
      };
      
      // CORRECTION: Utiliser users/{uid}/trips au lieu de trips
      await firebase.firestore()
        .collection('users').doc(user.uid)
        .collection('trips').doc(tripId)
        .set(tripData, { merge: true });
      
      // Mettre √† jour le tripId dans state
      state.tripId = tripId;
      
      hasUnsavedChanges = false;
      showToast('‚úÖ Sauvegard√© dans votre Dashboard !');
    } else {
      // Fallback localStorage pour non-connect√©s
      let saveKey = state._originalItinId || Date.now();
      // üî¥ D√âTECTION CATALOGUE: Ne pas utiliser l'ID catalogue
      if (saveKey && String(saveKey).startsWith('catalog::')) {
        saveKey = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }
      localStorage.setItem(`ort_trip_${saveKey}`, JSON.stringify({ ...state, savedAt: new Date().toISOString() }));
      hasUnsavedChanges = false;
      showToast('‚úÖ Sauvegard√© localement (connectez-vous pour synchroniser)');
    }
  } catch (err) {
    console.error('[SAVE]', err);
    showToast('‚ùå Erreur de sauvegarde');
  }
}

function shareTrip() {
  closeAllSheets();
  
  // V√©rifier si connect√©
  const user = firebase.auth().currentUser;
  if (!user) {
    showToast('‚ùå Connectez-vous pour partager');
    return;
  }
  
  // V√©rifier si trip sauvegard√©
  if (!state.tripId) {
    showToast('‚ùå Sauvegardez d\'abord le voyage');
    return;
  }
  
  // Ouvrir la modale
  $('shareModalTitle').textContent = state.title || 'Mon roadtrip';
  $('shareResult').style.display = 'none';
  $('btnRevokeShare').style.display = 'none';
  $('btnGenerateShare').style.display = '';
  
  // Charger le lien existant si pr√©sent
  loadExistingShare();
  
  $('shareModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeShareModal() {
  $('shareModal').classList.remove('open');
  document.body.style.overflow = '';
}

async function loadExistingShare() {
  if (!window.ORT_SHARE) return;
  
  try {
    const existing = await ORT_SHARE.getShareInfo(state.tripId);
    if (existing && existing.url) {
      $('shareUrlInput').value = existing.url;
      $('shareResult').style.display = '';
      $('btnRevokeShare').style.display = '';
      $('btnGenerateShare').textContent = 'üîÑ R√©g√©n√©rer le lien';
      
      // Cocher le bon mode
      const modeRadio = document.querySelector(`input[name="shareMode"][value="${existing.mode || 'viewer'}"]`);
      if (modeRadio) modeRadio.checked = true;
    }
  } catch (e) {
    console.warn('[SHARE] Erreur chargement:', e);
  }
}

async function generateShareLink() {
  if (!window.ORT_SHARE) {
    showToast('‚ùå Module de partage non disponible');
    return;
  }
  
  const mode = document.querySelector('input[name="shareMode"]:checked')?.value || 'viewer';
  
  $('btnGenerateShare').textContent = '‚è≥ G√©n√©ration...';
  $('btnGenerateShare').disabled = true;
  
  try {
    const result = await ORT_SHARE.createShareLink(state, state.title || 'Voyage');
    
    if (result && result.shareUrl) {
      $('shareUrlInput').value = result.shareUrl;
      $('shareResult').style.display = '';
      $('btnRevokeShare').style.display = '';
      $('btnGenerateShare').textContent = 'üîÑ R√©g√©n√©rer le lien';
      showToast('‚úÖ Lien cr√©√© !');
    } else {
      showToast('‚ùå Erreur lors de la cr√©ation');
    }
  } catch (e) {
    console.error('[SHARE] Erreur:', e);
    showToast('‚ùå ' + (e.message || 'Erreur'));
  } finally {
    $('btnGenerateShare').disabled = false;
  }
}

function copyShareLink() {
  const url = $('shareUrlInput').value;
  if (url) {
    navigator.clipboard.writeText(url);
    showToast('üìã Lien copi√© !');
  }
}

function nativeShare() {
  const url = $('shareUrlInput').value;
  if (url && navigator.share) {
    navigator.share({
      title: state.title || 'Mon roadtrip',
      text: `D√©couvre mon roadtrip : ${state.title}`,
      url: url
    });
  } else {
    copyShareLink();
  }
}

async function revokeShare() {
  if (!window.ORT_SHARE) return;
  
  if (!confirm('R√©voquer le lien de partage ?')) return;
  
  try {
    await ORT_SHARE.revokeShareLink(state.tripId);
    $('shareResult').style.display = 'none';
    $('btnRevokeShare').style.display = 'none';
    $('btnGenerateShare').textContent = 'üîó G√©n√©rer le lien';
    showToast('‚úÖ Lien r√©voqu√©');
  } catch (e) {
    showToast('‚ùå Erreur: ' + e.message);
  }
}

function exportPdf() {
  closeAllSheets();
  showToast('üìÑ Ouverture version imprimable...');
  
  // Ouvre la version desktop avec trigger PDF
  // Note: utilise roadtrip_detail_simple.html car c'est le fichier d√©ploy√©
  const sep = location.search ? '&' : '?';
  let desktopUrl = location.href
    .replace('roadtrip_mobile.html', 'roadtrip_detail_simple.html')
    .replace('roadtrip_mobile', 'roadtrip_detail_simple');
  desktopUrl += sep + 'action=pdf&mobile=0';
  window.open(desktopUrl, '_blank');
}

function showDesktopMessage() {
  closeAllSheets();
  const url = location.href.replace('roadtrip_mobile.html', 'roadtrip_detail.html') + '&mobile=0';
  if (navigator.share) {
    navigator.share({ title: 'Continuer sur ordinateur', text: 'Ouvrez ce lien sur un √©cran plus grand', url });
  } else {
    navigator.clipboard.writeText(url);
    showToast('üìã Lien copi√© !');
  }
}

// === USER HELPER ===
function currentUser() { 
  try { 
    return (window.firebase && window.firebase.auth && window.firebase.auth().currentUser) || null; 
  } catch(_) { 
    return null; 
  } 
}

// === TOAST ===
function showToast(message, duration = 2500) {
  const toast = $('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

// ===== SCANNER MODULE =====
const SCANNER = {
  mode: null, // 'booking' ou 'document'
  photoBase64: null,
  result: null,
  
  API_BOOKING: '/.netlify/functions/parse-booking-photo',
  API_DOCUMENT: '/.netlify/functions/parse-document',
  
  async getToken() {
    if (window.firebase?.auth) {
      const user = firebase.auth().currentUser;
      if (user) return user.getIdToken();
    }
    return null;
  },
  
  open(mode) {
    this.mode = mode;
    this.photoBase64 = null;
    this.result = null;
    
    // Reset UI
    $('scanStep1').style.display = 'block';
    $('scanStep2').style.display = 'none';
    $('scanStep3').style.display = 'none';
    $('scanPreview').style.display = 'none';
    $('scanError').style.display = 'none';
    $('scannerInput').value = '';
    
    // Update titles
    if (mode === 'booking') {
      $('scannerTitle').textContent = 'üì∑ Scanner une r√©servation';
      $('scannerSubtitle').textContent = 'Photo de confirmation, email, PDF...';
    } else {
      $('scannerTitle').textContent = 'ü™™ Scanner un document';
      $('scannerSubtitle').textContent = 'Passeport, visa, permis...';
    }
    
    closeAllSheets();
    openSheet($('scannerSheet'));
  },
  
  handleFile(file) {
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      this.photoBase64 = e.target.result;
      $('scanPreviewImg').src = this.photoBase64;
      $('scanPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  },
  
  retake() {
    this.photoBase64 = null;
    $('scanPreview').style.display = 'none';
    $('scannerInput').value = '';
    $('scanError').style.display = 'none';
  },
  
  async analyze() {
    if (!this.photoBase64) return;
    
    const token = await this.getToken();
    if (!token) {
      this.showError('Connectez-vous pour utiliser le scanner');
      return;
    }
    
    // Show loading
    $('scanStep1').style.display = 'none';
    $('scanStep2').style.display = 'block';
    $('scanError').style.display = 'none';
    
    try {
      const url = this.mode === 'booking' ? this.API_BOOKING : this.API_DOCUMENT;
      const body = this.mode === 'booking' 
        ? { photo: this.photoBase64 }
        : { photo: this.photoBase64, save: false };
      
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(body)
      });
      
      const data = await res.json();
      
      if (!res.ok || !data.success) {
        throw new Error(data.error || 'Erreur analyse');
      }
      
      this.result = this.mode === 'booking' ? data.items?.[0] : data.data;
      this.renderResult();
      
    } catch (e) {
      console.error('[SCANNER]', e);
      $('scanStep2').style.display = 'none';
      $('scanStep1').style.display = 'block';
      this.showError(e.message);
    }
  },
  
  renderResult() {
    $('scanStep2').style.display = 'none';
    $('scanStep3').style.display = 'block';
    
    const r = this.result;
    let html = '';
    
    if (this.mode === 'booking') {
      const typeIcons = { hotel: 'üè®', flight: '‚úàÔ∏è', car: 'üöó', train: 'üöÜ', activity: 'üéØ', restaurant: 'üçΩÔ∏è' };
      html = `
        <div style="text-align:center;margin-bottom:12px;">
          <span style="font-size:2rem;">${typeIcons[r.type] || 'üìÑ'}</span>
          <div style="font-weight:700;font-size:1.1rem;margin-top:4px;">${r.name || 'R√©servation'}</div>
        </div>
        ${r.confirmation_number ? `<div class="scan-result-row"><span class="scan-result-label">N¬∞ confirmation</span><span class="scan-result-value">${r.confirmation_number}</span></div>` : ''}
        ${r.date_start ? `<div class="scan-result-row"><span class="scan-result-label">Date</span><span class="scan-result-value">${r.date_start}${r.date_end ? ' ‚Üí ' + r.date_end : ''}</span></div>` : ''}
        ${r.city ? `<div class="scan-result-row"><span class="scan-result-label">Lieu</span><span class="scan-result-value">${r.city}</span></div>` : ''}
        ${r.price?.amount ? `<div class="scan-result-row"><span class="scan-result-label">Prix</span><span class="scan-result-value">${r.price.amount} ${r.price.currency || ''}</span></div>` : ''}
      `;
    } else {
      const typeIcons = { passport: 'üõÇ', visa: 'üìë', id_card: 'ü™™', driving_license: 'üöó', health_card: 'üè•' };
      html = `
        <div style="text-align:center;margin-bottom:12px;">
          <span style="font-size:2rem;">${typeIcons[r.type] || 'üìÑ'}</span>
          <div style="font-weight:700;font-size:1.1rem;margin-top:4px;">${r.document_name || 'Document'}</div>
        </div>
        ${r.holder_name ? `<div class="scan-result-row"><span class="scan-result-label">Titulaire</span><span class="scan-result-value">${r.holder_name}</span></div>` : ''}
        ${r.document_number ? `<div class="scan-result-row"><span class="scan-result-label">Num√©ro</span><span class="scan-result-value">${r.document_number}</span></div>` : ''}
        ${r.expiry_date ? `<div class="scan-result-row"><span class="scan-result-label">Expiration</span><span class="scan-result-value">${r.expiry_date}</span></div>` : ''}
        ${r.country_code ? `<div class="scan-result-row"><span class="scan-result-label">Pays</span><span class="scan-result-value">${r.country_code}</span></div>` : ''}
      `;
    }
    
    $('scanResult').innerHTML = html;
  },
  
  showError(msg) {
    $('scanError').textContent = msg;
    $('scanError').style.display = 'block';
  },
  
  newScan() {
    this.photoBase64 = null;
    this.result = null;
    $('scanStep3').style.display = 'none';
    $('scanStep1').style.display = 'block';
    $('scanPreview').style.display = 'none';
    $('scannerInput').value = '';
    $('scanError').style.display = 'none';
  },
  
  async save() {
    if (!this.result) return;
    
    const token = await this.getToken();
    if (!token) {
      showToast('‚ùå Connexion requise');
      return;
    }
    
    try {
      if (this.mode === 'booking') {
        // Ajouter aux bookings du voyage
        if (!state.bookings) state.bookings = [];
        state.bookings.push(this.result);
        showToast('‚úÖ R√©servation ajout√©e !');
      } else {
        // Sauvegarder le document via API
        const res = await fetch(this.API_DOCUMENT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ photo: this.photoBase64, save: true })
        });
        
        const data = await res.json();
        if (!data.success) throw new Error(data.error);
        
        showToast('‚úÖ Document enregistr√© !');
      }
      
      closeAllSheets();
      
    } catch (e) {
      console.error('[SCANNER SAVE]', e);
      showToast('‚ùå ' + e.message);
    }
  }
};

// Scanner event handlers
$('btnScanBooking').onclick = () => SCANNER.open('booking');
$('btnScanDocument').onclick = () => SCANNER.open('document');
$('scannerInput').onchange = (e) => SCANNER.handleFile(e.target.files[0]);
$('btnScanRetake').onclick = () => SCANNER.retake();
$('btnScanAnalyze').onclick = () => SCANNER.analyze();
$('btnScanNew').onclick = () => SCANNER.newScan();
$('btnScanSave').onclick = () => SCANNER.save();

// Bouton Mode Expert - bascule vers roadtrip_detail.html avec alerte
$('btnExpertMode').onclick = function() {
  const LANG = (localStorage.getItem('lang') || 'fr').slice(0,2);
  const messages = {
    fr: 'Vous allez basculer en mode expert.\nIl est pr√©f√©rable de tester ce mode sur un √©cran plus large.',
    en: 'You are about to switch to expert mode.\nIt is recommended to use this mode on a larger screen.',
    es: 'Vas a cambiar al modo experto.\nSe recomienda usar este modo en una pantalla m√°s grande.',
    it: 'Stai per passare alla modalit√† esperto.\nSi consiglia di utilizzare questa modalit√† su uno schermo pi√π grande.',
    pt: 'Voc√™ vai mudar para o modo especialista.\nRecomenda-se usar este modo em uma tela maior.',
    ar: 'ÿ£ŸÜÿ™ ÿπŸÑŸâ Ÿàÿ¥ŸÉ ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ Ÿàÿ∂ÿπ ÿßŸÑÿÆÿ®Ÿäÿ±.\nŸäŸèŸÅÿ∂ŸÑ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿáÿ∞ÿß ÿßŸÑŸàÿ∂ÿπ ÿπŸÑŸâ ÿ¥ÿßÿ¥ÿ© ÿ£ŸÉÿ®ÿ±.'
  };
  const msg = messages[LANG] || messages.fr;
  
  if (confirm(msg)) {
    // Utilise ORT_TRIPID pour pr√©server le tripId
    if (window.ORT_TRIPID) {
      window.ORT_TRIPID.navigateTo('roadtrip_detail.html');
    } else {
      const newUrl = location.href.replace(/roadtrip_mobile\.html/, 'roadtrip_detail.html');
      window.location.href = newUrl;
    }
  }
};

// Expose
window.openStepSheet = openStepSheet;
window.navigateStep = navigateStep;
window.openVisitsModal = openVisitsModal;
window.closeVisitsModal = closeVisitsModal;
window.openActivitiesModal = openActivitiesModal;
window.closeActivitiesModal = closeActivitiesModal;
window.closeShareModal = closeShareModal;
window.generateShareLink = generateShareLink;
window.copyShareLink = copyShareLink;
window.nativeShare = nativeShare;
window.revokeShare = revokeShare;

// Rafra√Æchir les bookings quand on revient sur cette page
// (apr√®s avoir √©t√© sur rt-booking-import par exemple)
let lastVisibilityTime = Date.now();

document.addEventListener('visibilitychange', async function() {
  if (document.visibilityState === 'visible') {
    const timeSinceHidden = Date.now() - lastVisibilityTime;
    // Si on revient apr√®s plus de 2 secondes, rafra√Æchir les bookings
    if (timeSinceHidden > 2000 && window.ORT_TRIP_DATA) {
      console.log('[MOBILE] Retour sur la page, refresh des bookings...');
      try {
        // Recharger les donn√©es depuis Firestore
        const tripId = window.ORT_TRIPID?.get();
        if (tripId) {
          await ORT_TRIP_DATA.loadTrip(tripId);
          renderBookings();
          console.log('[MOBILE] ‚úÖ Bookings rafra√Æchis');
        }
      } catch (e) {
        console.warn('[MOBILE] Erreur refresh bookings:', e);
      }
    }
  } else {
    lastVisibilityTime = Date.now();
  }
});

// Aussi sur pageshow (pour les navigations back/forward)
window.addEventListener('pageshow', async function(event) {
  if (event.persisted && window.ORT_TRIP_DATA) {
    console.log('[MOBILE] Page restaur√©e depuis cache, refresh...');
    const tripId = window.ORT_TRIPID?.get();
    if (tripId) {
      try {
        await ORT_TRIP_DATA.loadTrip(tripId);
        renderBookings();
      } catch (e) {
        console.warn('[MOBILE] Erreur refresh pageshow:', e);
      }
    }
  }
});
</script>

<!-- Bouton flottant pour ajouter une r√©servation (visible sur l'onglet R√©servations) -->
<button id="btnAddBookingFab" style="position:fixed;bottom:100px;right:16px;width:56px;height:56px;border-radius:50%;background:#3b82f6;color:#fff;border:none;font-size:32px;font-weight:bold;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.4);z-index:200;display:none;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;" title="Ajouter une r√©servation">+</button>
<script>
(function() {
  const fab = document.getElementById('btnAddBookingFab');
  if (!fab) return;
  
  // Fonction pour naviguer vers l'import de r√©servations
  function goToBookingImport(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('[FAB] Clic d√©tect√©, navigation...');
    
    if (window.ORT_TRIPID) {
      window.ORT_TRIPID.navigateTo('rt-booking-import.html');
    } else {
      const tripId = new URLSearchParams(location.search).get('tripId') || '';
      window.location.href = 'rt-booking-import.html?tripId=' + encodeURIComponent(tripId);
    }
  }
  
  // √âcouter click ET touchend pour mobile
  fab.addEventListener('click', goToBookingImport);
  fab.addEventListener('touchend', function(e) {
    e.preventDefault();
    goToBookingImport(e);
  }, { passive: false });
  
  // Afficher/masquer le FAB selon l'onglet actif
  function updateFabVisibility() {
    const bookingsPanel = document.getElementById('bookingsPanel');
    if (fab && bookingsPanel) {
      const isActive = bookingsPanel.classList.contains('active');
      fab.style.display = isActive ? 'flex' : 'none';
      console.log('[FAB] Visibilit√© mise √† jour:', isActive ? 'visible' : 'masqu√©');
    }
  }
  
  // Observer les changements d'onglet
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      setTimeout(updateFabVisibility, 100);
    });
  });
  
  // V√©rifier au chargement et apr√®s un court d√©lai
  setTimeout(updateFabVisibility, 500);
  document.addEventListener('DOMContentLoaded', () => setTimeout(updateFabVisibility, 100));
})();
</script>
<script src="./js/ort-share.js"></script>
<script src="./js/ort-modals.js"></script>
<!-- === V√âRIFICATION MODE PARTAG√â === -->
<script>
(async function checkShareMode(){
  const shareToken = new URLSearchParams(location.search).get('share');
  if (!shareToken) return;
  
  console.log('[SHARE] Mode partag√© d√©tect√©');
  
  try {
    if (typeof ORT_SHARE !== 'undefined') {
      const sharedData = await ORT_SHARE.checkSharedAccess();
      if (sharedData) {
        console.log('[SHARE] ‚úÖ Voyage charg√© en lecture seule');
        
        window._sharedTripData = sharedData;
        document.body.classList.add('shared-view-only');
        
        if (sharedData.data) {
          state.title = sharedData.data.title;
          state.cc = sharedData.data.country;
          state.steps = sharedData.data.steps || [];
          renderList();
          updateSummary();
          initMap();
        }
        
        const banner = document.createElement('div');
        banner.style.cssText = `
          position: fixed; top: 0; left: 0; right: 0;
          background: #f59e0b; color: white; padding: 10px; 
          text-align: center; z-index: 9999; font-weight: 600;
        `;
        banner.textContent = 'üëÅÔ∏è Mode lecture seule';
        document.body.insertBefore(banner, document.body.firstChild);
        setTimeout(() => banner.remove(), 5000);
      }
    }
  } catch (error) {
    console.error('[SHARE] ‚ùå Erreur:', error);
  }
})();
</script>

</body>
</html>