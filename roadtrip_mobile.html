<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.json">
<title>OneRoadTrip</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JK3QGQGDDL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-JK3QGQGDDL');
</script>
<!-- üî¥ CHECK CATALOGUE: redirection imm√©diate si c'est un catalogue -->
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const tripId = qs.get('tripId') || qs.get('id');
  const cc = qs.get('cc');
  const itin = qs.get('itin');
  const from = qs.get('from');
  
  // Cas 1: tripId explicitement catalog:: ou custom::
  if (tripId && (tripId.startsWith('catalog::') || tripId.startsWith('custom::'))) {
    const sourceType = tripId.startsWith('catalog::') ? 'Catalogue' : 'Custom (Carte/Import)';
    console.log(`[INIT-EARLY] üìö ${sourceType} d√©tect√© (tripId), g√©n√©ration NEW tripId`);
    const newTripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    sessionStorage.setItem('ort_catalog_source', tripId);
    console.log('[INIT-EARLY] ‚úÖ Source sauvegard√©e:', tripId);
    
    // Remplacer tripId mais conserver tous les autres param√®tres
    qs.set('tripId', newTripId);
    const newUrl = `${location.pathname}?${qs.toString()}`;
    console.log('[INIT-EARLY] Redirect vers:', newUrl);
    window.location.href = newUrl;
    return;
  }
  
  // Cas 2: cc + itin (acc√®s catalogue via param√®tres s√©par√©s) - inclut COMPOSED::
  if (cc && itin && !tripId) {
    console.log('[INIT-EARLY] üìö Catalogue d√©tect√© (cc+itin), g√©n√©ration NEW tripId');
    const catalogId = `catalog::${cc.toUpperCase()}::${itin}`;
    const newTripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    sessionStorage.setItem('ort_catalog_source', catalogId);
    console.log('[INIT-EARLY] ‚úÖ Source catalogue sauvegard√©e:', catalogId);
    
    // Ajouter tripId mais conserver tous les autres param√®tres (cc, itin, days, depart, mode, etc.)
    qs.set('tripId', newTripId);
    const newUrl = `${location.pathname}?${qs.toString()}`;
    console.log('[INIT-EARLY] Redirect vers:', newUrl);
    window.location.href = newUrl;
    return;
  }
  
  // Cas 3: from=builder ou from=temp sans tripId valide (Route Builder, Carte Builder, Import IA)
  if ((from === 'builder' || from === 'temp') && (!tripId || !tripId.startsWith('trip_'))) {
    const sourceType = from === 'builder' ? 'Route Builder' : 'Carte/Import';
    console.log(`[INIT-EARLY] üõ†Ô∏è ${sourceType} d√©tect√© sans tripId, g√©n√©ration NEW tripId`);
    const newTripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // Sauvegarder la source si rtKey existe
    const rtKey = qs.get('rtKey');
    if (rtKey) {
      sessionStorage.setItem('ort_catalog_source', `custom::${rtKey}`);
      console.log('[INIT-EARLY] ‚úÖ Source custom sauvegard√©e:', `custom::${rtKey}`);
    }
    
    qs.set('tripId', newTripId);
    const newUrl = `${location.pathname}?${qs.toString()}`;
    console.log('[INIT-EARLY] Redirect vers:', newUrl);
    window.location.href = newUrl;
    return;
  }
})();
</script>
<!-- Clean redirect marker on mobile arrival -->
<script>
(function(){
  // Clear all redirect markers when arriving on mobile (successful redirect)
  for (let i = 0; i < 24; i++) {
    localStorage.removeItem('ort_redirect_in_progress_' + i);
  }
  console.log('[ORT-MOBILE] Redirect markers cleaned');
})();
</script>
<style>
:root {
  --ort-blue: #113f7a;
  --ort-green: #c3d6b6;
  --ort-light: #f8fafc;
  --ort-border: #e2e8f0;
  --tab-height: 56px;
  --header-height: 56px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { 
  height: 100%; 
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--ort-light);
  color: #1e293b;
}

/* === HEADER === */
.header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--header-height);
  background: var(--ort-blue);
  color: #fff;
  display: flex;
  align-items: center;
  padding: 0 12px;
  gap: 12px;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.header-back {
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: #fff;
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.header-title {
  flex: 1;
  font-weight: 700;
  font-size: 16px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.header-menu {
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: #fff;
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
}

/* === MAIN CONTENT === */
.main-content {
  position: fixed;
  top: var(--header-height);
  left: 0;
  right: 0;
  bottom: calc(var(--tab-height) + var(--safe-bottom));
  overflow: hidden;
}

.tab-panel {
  position: absolute;
  inset: 0;
  overflow-y: auto;
  display: none;
  -webkit-overflow-scrolling: touch;
}

.tab-panel.active {
  display: block;
}

/* === MAP TAB === */
#mapPanel { overflow: hidden; }
#map { width: 100%; height: 100%; }
.leaflet-container { font-family: inherit; }

/* === LIST TAB === */
#listPanel {
  padding: 12px;
  padding-bottom: 24px;
  background: var(--ort-light);
}

/* Summary card */
.summary-card {
  background: #fff;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.summary-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
  min-width: 70px;
}

.summary-stat .value {
  font-size: 22px;
  font-weight: 800;
  color: var(--ort-blue);
}

.summary-stat .label {
  font-size: 11px;
  color: #64748b;
  text-transform: uppercase;
}

/* Bookings styles */
#bookingsContainer {
  padding: 12px;
  overflow-y: auto;
  height: calc(100% - 12px);
}

.booking-day {
  margin-bottom: 16px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 10px;
  border-left: 4px solid #113f7a;
}

.booking-day-header {
  font-size: 14px;
  font-weight: 700;
  color: #113f7a;
  margin: 0 0 10px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #e2e8f0;
}

.booking-section {
  margin-bottom: 16px;
}
.booking-section-title {
  font-size: 14px;
  font-weight: 700;
  color: #113f7a;
  padding: 12px 16px 8px;
  border-bottom: 2px solid #113f7a;
  margin: 0 0 8px 0;
}

.booking-item {
  background: white;
  border-radius: 10px;
  padding: 12px;
  margin: 0 12px 8px 12px;
  border: 1px solid #e2e8f0;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  cursor: pointer;
  -webkit-tap-highlight-color: rgba(17,63,122,0.1);
}
.booking-item:active {
  background: #f0f4ff;
}

.booking-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.booking-info {
  flex: 1;
  min-width: 0;
}

.booking-name {
  font-size: 14px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 2px;
}

.booking-detail {
  font-size: 12px;
  color: #6b7280;
  margin: 2px 0;
}

.booking-price {
  font-size: 14px;
  font-weight: 700;
  color: #16a34a;
  white-space: nowrap;
}

.booking-budget {
  background: linear-gradient(135deg, #113f7a 0%, #1e5090 100%);
  color: white;
  border-radius: 12px;
  margin: 16px 12px;
  padding: 16px;
  text-align: center;
}
.budget-label {
  font-size: 13px;
  opacity: 0.9;
  margin-bottom: 4px;
}
.budget-amount {
  font-size: 1.6rem;
  font-weight: 700;
}

/* Step cards */
.step-card {
  background: #fff;
  border-radius: 14px;
  margin-bottom: 10px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  display: flex;
  align-items: stretch;
  min-height: 90px;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.step-card:active {
  transform: scale(0.98);
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.step-card-num {
  width: 44px;
  background: var(--ort-blue);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 18px;
  flex-shrink: 0;
}

.step-card-photo {
  width: 80px;
  height: 90px;
  object-fit: cover;
  flex-shrink: 0;
  background: #e2e8f0;
}

.step-card-info {
  flex: 1;
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 0;
}

.step-card-name {
  font-weight: 700;
  font-size: 15px;
  color: var(--ort-blue);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.step-card-meta {
  font-size: 13px;
  color: #64748b;
  margin-top: 4px;
}

.step-card-nights {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: var(--ort-green);
  color: var(--ort-blue);
  padding: 3px 8px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 12px;
  margin-top: 6px;
  width: fit-content;
}

.step-card-booking {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: 8px;
  padding: 2px 8px;
  background: #dcfce7;
  border-radius: 12px;
  font-size: 14px;
  cursor: pointer;
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}


.step-bookings-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.step-booking-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: #f8fafc;
  border-radius: 10px;
  border: 1px solid var(--ort-border);
  cursor: pointer;
  -webkit-tap-highlight-color: rgba(17,63,122,0.1);
}
.step-booking-item:active {
  background: #e8f0fe;
}

.step-booking-icon {
  font-size: 20px;
  width: 32px;
  text-align: center;
}

.step-booking-info {
  flex: 1;
  min-width: 0;
}

.step-booking-name {
  font-weight: 600;
  color: var(--ort-blue);
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.step-booking-dates {
  font-size: 12px;
  color: #64748b;
}

.step-booking-price {
  font-weight: 600;
  color: #16a34a;
  font-size: 14px;
}

.step-card-chevron {
  width: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #94a3b8;
  font-size: 20px;
  flex-shrink: 0;
}

/* === TAB BAR === */
.tab-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: calc(var(--tab-height) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: #fff;
  border-top: 1px solid var(--ort-border);
  display: flex;
  z-index: 100;
}

.tab-btn {
  flex: 1;
  border: none;
  background: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  font-family: inherit;
  font-size: 10px;
  color: #64748b;
  cursor: pointer;
  transition: color 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.tab-btn.active {
  color: var(--ort-blue);
}

.tab-btn .tab-icon {
  font-size: 22px;
}

.tab-btn.active .tab-icon {
  transform: scale(1.1);
}

/* === SUB-TABS (Visualisation) === */
.sub-tabs-container {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.sub-tabs-bar {
  display: flex;
  background: #fff;
  border-bottom: 2px solid var(--ort-border);
  flex-shrink: 0;
  position: sticky;
  top: 0;
  z-index: 10;
}

.sub-tab-btn {
  flex: 1;
  padding: 12px 8px;
  border: none;
  background: none;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  cursor: pointer;
  transition: all 0.2s;
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
}

.sub-tab-btn.active {
  color: var(--ort-blue);
  border-bottom-color: var(--ort-blue);
  background: rgba(17,63,122,0.05);
}

.sub-tab-btn .sub-tab-icon {
  display: block;
  font-size: 20px;
  margin-bottom: 4px;
}

.sub-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  flex-direction: column;
}

.sub-panel.active {
  display: flex;
}

/* Sub-panel √âtapes */
#subPanelSteps {
  padding: 0;
}

.viz-step-navigation {
  display: flex;
  align-items: center;
  padding: 12px;
  background: linear-gradient(135deg, var(--ort-blue) 0%, #1e5090 100%);
  color: #fff;
  gap: 12px;
}

.viz-nav-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.2);
  color: #fff;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}

.viz-nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.viz-nav-btn:not(:disabled):active {
  background: rgba(255,255,255,0.4);
  transform: scale(0.95);
}

.viz-step-header-info {
  flex: 1;
  text-align: center;
  min-width: 0;
}

.viz-step-counter {
  font-size: 12px;
  opacity: 0.8;
  margin-bottom: 4px;
}

.viz-step-name {
  font-weight: 700;
  font-size: 18px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.viz-step-nights {
  font-size: 13px;
  opacity: 0.9;
  margin-top: 4px;
}

.viz-step-scroll {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 16px;
  padding-bottom: 24px;
}

.viz-step-photo {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 16px;
  background: #e2e8f0;
}

.viz-section {
  margin-bottom: 20px;
}

.viz-section:last-child {
  margin-bottom: 0;
}

.viz-section-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--ort-blue);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--ort-green);
}

.viz-item {
  padding: 14px;
  background: #f8fafc;
  border-radius: 12px;
  margin-bottom: 10px;
  border-left: 4px solid var(--ort-green);
}

.viz-item:last-child {
  margin-bottom: 0;
}

.viz-item-title {
  font-weight: 600;
  color: #1e293b;
  font-size: 15px;
  margin-bottom: 6px;
}

.viz-item-desc {
  font-size: 14px;
  color: #64748b;
  line-height: 1.6;
}

.viz-item-info {
  font-size: 12px;
  color: #0369a1;
  margin-top: 8px;
  padding: 6px 10px;
  background: #e0f2fe;
  border-radius: 6px;
  line-height: 1.5;
}

/* R√©servations dans la visualisation */
.viz-section-bookings {
  background: #fef3c7;
  border: 1px solid #fcd34d;
  border-radius: 12px;
  padding: 12px;
  margin-top: 16px;
}

.viz-section-bookings .viz-section-title {
  color: #92400e;
}

.viz-booking-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  background: #fff;
  border-radius: 8px;
  margin-top: 8px;
  cursor: pointer;
  -webkit-tap-highlight-color: rgba(17,63,122,0.1);
}
.viz-booking-item:active {
  background: #fef3c7;
}

.viz-booking-icon {
  font-size: 20px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fef3c7;
  border-radius: 8px;
}

.viz-booking-info {
  flex: 1;
  min-width: 0;
}

.viz-booking-name {
  font-weight: 600;
  color: #1e293b;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.viz-booking-dates {
  font-size: 12px;
  color: #64748b;
  margin-top: 2px;
}

.viz-booking-price {
  font-weight: 700;
  color: #16a34a;
  font-size: 15px;
  white-space: nowrap;
}

.viz-empty {
  text-align: center;
  padding: 30px 20px;
  color: #94a3b8;
  font-size: 14px;
  font-style: italic;
  background: #f8fafc;
  border-radius: 12px;
}

.viz-no-steps {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #94a3b8;
  text-align: center;
  padding: 40px;
}

.viz-no-steps-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

/* Sub-panel Google Maps */
#subPanelMap {
  padding: 0;
}

.gmap-filters {
  display: flex;
  gap: 8px;
  padding: 10px 12px;
  background: #f8fafc;
  border-bottom: 1px solid var(--ort-border);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.gmap-filter-btn {
  padding: 8px 14px;
  border: 2px solid var(--ort-border);
  border-radius: 20px;
  background: #fff;
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}

.gmap-filter-btn.active {
  background: var(--ort-blue);
  border-color: var(--ort-blue);
  color: #fff;
}

.gmap-filter-btn:not(.active):active {
  background: #f1f5f9;
}

.gmap-iframe-wrapper {
  flex: 1;
  position: relative;
  min-height: 300px;
}

.gmap-iframe-wrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.gmap-placeholder {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #94a3b8;
  text-align: center;
  padding: 40px;
}

.gmap-placeholder-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

/* Sub-panel Hotels (Stay22) */
#subPanelHotels {
  padding: 0;
}

.hotels-widget-wrapper {
  flex: 1;
  position: relative;
  min-height: 400px;
  overflow: hidden;
}

.hotels-widget-wrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.hotels-placeholder {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #94a3b8;
  text-align: center;
  padding: 40px;
}

.hotels-placeholder-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

/* === BOTTOM SHEET === */
.sheet-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.25s, visibility 0.25s;
}

.sheet-overlay.show {
  opacity: 1;
  visibility: visible;
}

.bottom-sheet {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fff;
  border-radius: 20px 20px 0 0;
  z-index: 201;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  max-height: 85vh;
  display: flex;
  flex-direction: column;
}

.bottom-sheet.show {
  transform: translateY(0);
}

.sheet-handle {
  width: 40px;
  height: 5px;
  background: #d1d5db;
  border-radius: 3px;
  margin: 10px auto;
  flex-shrink: 0;
}

.sheet-header {
  padding: 0 16px 12px;
  border-bottom: 1px solid var(--ort-border);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
}

.sheet-header-center {
  flex: 1;
  text-align: center;
  min-width: 0;
}

.step-nav-btn {
  width: 40px;
  height: 40px;
  border: 2px solid var(--ort-border);
  background: #fff;
  border-radius: 50%;
  font-size: 24px;
  font-weight: 700;
  color: var(--ort-blue);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s;
}

.step-nav-btn:active {
  background: var(--ort-blue);
  color: #fff;
  border-color: var(--ort-blue);
}

.step-nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.sheet-title {
  font-size: 20px;
  font-weight: 800;
  color: var(--ort-blue);
}

.sheet-subtitle {
  font-size: 14px;
  color: #64748b;
  margin-top: 2px;
}

.sheet-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  -webkit-overflow-scrolling: touch;
}

.sheet-photo {
  width: 100%;
  aspect-ratio: 16/9;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 16px;
  background: #e2e8f0;
}

.sheet-section {
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.sheet-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.sheet-section-title {
  font-size: 12px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  margin-bottom: 12px;
  letter-spacing: 0.5px;
}

/* Nights control */
.nights-control {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 12px;
  background: var(--ort-light);
  border-radius: 12px;
}

.nights-btn {
  width: 48px;
  height: 48px;
  border: 2px solid var(--ort-blue);
  background: #fff;
  color: var(--ort-blue);
  border-radius: 12px;
  font-size: 24px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.nights-btn:active {
  background: var(--ort-blue);
  color: #fff;
}

.nights-value {
  font-size: 28px;
  font-weight: 800;
  color: var(--ort-blue);
  min-width: 80px;
  text-align: center;
}

.nights-label {
  font-size: 12px;
  color: #64748b;
}

/* Affiliate buttons - compact row at top */
.affiliate-buttons {
  display: flex;
  gap: 8px;
  margin: 12px 0 16px;
}

.affiliate-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 10px 8px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  text-align: center;
  transition: transform 0.15s;
}

.affiliate-btn:active {
  transform: scale(0.96);
}

.affiliate-gyg {
  background: linear-gradient(135deg, #ff5533 0%, #ff7744 100%);
  color: #fff;
}

.affiliate-tiqets {
  background: linear-gradient(135deg, #00a0e3 0%, #0077b6 100%);
  color: #fff;
}

.affiliate-hotel {
  background: var(--ort-green);
  color: var(--ort-blue);
}

/* Content buttons (Visites / Activit√©s) */
.content-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.content-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 16px;
  background: #f8fafc;
  border: 2px solid var(--ort-border);
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  color: var(--ort-blue);
  cursor: pointer;
  transition: all 0.2s;
}

.content-btn:active {
  background: var(--ort-light);
  border-color: var(--ort-blue);
}

.content-btn span:first-of-type {
  flex: 1;
  text-align: left;
}

.content-count {
  background: var(--ort-blue);
  color: #fff;
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
}

.content-count:empty,
.content-count[data-count="0"] {
  display: none;
}

/* Content Modal (Visites / Activit√©s) */
.content-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fff;
  z-index: 2000;
  display: none;
  flex-direction: column;
  overflow: hidden;
}

.content-modal.open {
  display: flex;
}

.content-modal-header {
  padding: 20px 16px;
  background: var(--ort-blue);
  color: #fff;
}

.content-modal-header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
}

.content-modal-step {
  font-size: 13px;
  opacity: 0.8;
  margin-top: 4px;
  display: block;
}

.content-modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  padding-bottom: 80px;
}

/* Content items inside modal */
.content-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px;
  margin-bottom: 10px;
  background: #f8fafc;
  border-radius: 12px;
  border-left: 4px solid var(--ort-blue);
}

.content-item-text {
  flex: 1;
  color: #475569;
  font-size: 14px;
  line-height: 1.5;
}

.content-item-actions {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
}

.content-item-btn {
  width: 32px;
  height: 32px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.content-item-btn.edit-btn {
  background: #e0f2fe;
  color: #0369a1;
}

.content-item-btn.delete-btn {
  background: #fee2e2;
  color: #dc2626;
}

.content-item-btn:active {
  transform: scale(0.95);
}

.content-empty {
  text-align: center;
  padding: 40px 20px;
  color: #94a3b8;
  font-size: 15px;
}

/* Bouton ajouter EN BAS de la liste */
.content-add-bottom {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  border: 2px dashed #cbd5e1;
  background: transparent;
  border-radius: 12px;
  color: #64748b;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

.content-add-bottom:active {
  background: #f1f5f9;
  border-color: #94a3b8;
}

/* Ancien bouton header - masqu√© */
.content-add-btn {
  display: none;
}

.content-modal-header {
  position: relative;
}

/* Mode √©dition */
.content-item.editing {
  background: #fff;
  border: 2px solid var(--ort-blue);
  padding-right: 16px;
}

.content-item-textarea {
  width: 100%;
  min-height: 80px;
  padding: 10px;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  line-height: 1.5;
  resize: vertical;
}

.content-item-save-btn {
  margin-top: 10px;
  padding: 10px 20px;
  background: var(--ort-blue);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
}

/* Floating back button */
.floating-back-btn {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  padding: 14px 32px;
  background: var(--ort-blue);
  color: #fff;
  border: none;
  border-radius: 30px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(26, 54, 93, 0.4);
  z-index: 2001;
  transition: transform 0.2s;
}

.floating-back-btn:active {
  transform: translateX(-50%) scale(0.96);
}

/* Share Modal Styles */
.share-options {
  padding: 8px 0;
}

.share-mode-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.share-mode-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: #f8fafc;
  border: 2px solid var(--ort-border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.share-mode-option:has(input:checked) {
  border-color: var(--ort-blue);
  background: #f0f7ff;
}

.share-mode-option input {
  width: 20px;
  height: 20px;
  accent-color: var(--ort-blue);
}

.share-mode-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.share-mode-icon {
  font-size: 24px;
}

.share-mode-info strong {
  display: block;
  color: var(--ort-blue);
  margin-bottom: 2px;
}

.share-mode-info p {
  margin: 0;
  font-size: 13px;
  color: #64748b;
}

.share-warning {
  background: #fef3c7;
  color: #92400e;
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 13px;
  margin-bottom: 20px;
  text-align: center;
}

.share-generate-btn {
  width: 100%;
  padding: 16px;
  background: var(--ort-blue);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 16px;
}

.share-generate-btn:active {
  opacity: 0.9;
}

.share-result {
  margin-bottom: 16px;
}

.share-url-input {
  width: 100%;
  padding: 14px;
  border: 2px solid var(--ort-border);
  border-radius: 10px;
  font-size: 14px;
  margin-bottom: 12px;
  background: #f8fafc;
}

.share-actions {
  display: flex;
  gap: 10px;
}

.share-action-btn {
  flex: 1;
  padding: 12px;
  border: 2px solid var(--ort-blue);
  background: #fff;
  color: var(--ort-blue);
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

.share-action-btn:active {
  background: var(--ort-blue);
  color: #fff;
}

.share-revoke-btn {
  width: 100%;
  padding: 14px;
  background: #fee2e2;
  color: #dc2626;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

/* Sheet actions */
.sheet-actions {
  padding: 12px 16px calc(12px + var(--safe-bottom));
  border-top: 1px solid var(--ort-border);
  display: flex;
  gap: 10px;
  flex-shrink: 0;
  background: #fff;
}

.sheet-btn {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  font-family: inherit;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

.sheet-btn-primary {
  background: var(--ort-blue);
  color: #fff;
}

.sheet-btn-danger {
  background: #fee2e2;
  color: #dc2626;
  flex: 0 0 auto;
  padding: 14px 18px;
}

/* === MENU SHEET === */
.menu-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--ort-border);
  font-size: 16px;
  color: #1e293b;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  text-decoration: none;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-item:active {
  background: var(--ort-light);
  margin: 0 -16px;
  padding-left: 16px;
  padding-right: 16px;
}

.menu-icon {
  font-size: 22px;
  width: 32px;
  text-align: center;
}

.menu-item.desktop-only {
  color: #94a3b8;
}

/* === SERVICES SHEET === */
.service-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.service-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px 12px;
  background: #fff;
  border-radius: 14px;
  border: 2px solid var(--ort-border);
  text-decoration: none;
  color: #1e293b;
  transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s;
}

.service-card:active {
  transform: scale(0.97);
  border-color: var(--ort-blue);
  box-shadow: 0 4px 12px rgba(17,63,122,0.15);
}

.service-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.service-name {
  font-size: 14px;
  font-weight: 600;
  text-align: center;
}

.service-desc {
  font-size: 11px;
  color: #64748b;
  text-align: center;
  margin-top: 4px;
}

/* === TOAST === */
.toast {
  position: fixed;
  bottom: calc(var(--tab-height) + var(--safe-bottom) + 16px);
  left: 16px;
  right: 16px;
  background: var(--ort-blue);
  color: #fff;
  padding: 14px 18px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  text-align: center;
  z-index: 300;
  transform: translateY(100px);
  opacity: 0;
  transition: transform 0.3s, opacity 0.3s;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.toast.show {
  transform: translateY(0);
  opacity: 1;
}

/* === LOADING === */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: var(--ort-blue);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 500;
  color: #fff;
}

.loading-overlay.hide {
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid rgba(255,255,255,0.2);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  margin-top: 16px;
  font-size: 16px;
}

/* === POPUP LEAFLET MOBILE === */
.leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; }
.leaflet-popup-content { margin: 0; width: 200px !important; }

.map-popup-mini {
  padding: 12px;
  text-align: center;
}

.map-popup-mini img {
  width: 100%;
  height: 100px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 8px;
}

.map-popup-mini .name {
  font-weight: 700;
  color: var(--ort-blue);
  font-size: 14px;
}

.map-popup-mini .btn-details {
  margin-top: 8px;
  padding: 8px 16px;
  background: var(--ort-blue);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
}

/* Step marker */
.step-marker {
  background: var(--ort-blue);
  color: #fff;
  border-radius: 50%;
  font-size: 13px;
  font-weight: bold;
  text-align: center;
  line-height: 26px;
  width: 26px;
  height: 26px;
  border: 2px solid #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* Scanner buttons */
.scan-btn {
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 0.95rem;
  border: none;
  cursor: pointer;
}
.scan-btn.primary {
  background: #113f7a;
  color: #fff;
}
.scan-btn.secondary {
  background: #e5e7eb;
  color: #333;
}
.scan-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Scan result card */
.scan-result-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}
.scan-result-row:last-child {
  border-bottom: none;
}
.scan-result-label {
  color: #666;
  font-size: 0.85rem;
}
.scan-result-value {
  font-weight: 600;
  color: #333;
}
</style>
<!-- Mode partage - masquer √©dition -->
<style>
  body.shared-view-only #btnSave,
  body.shared-view-only #btnAddStep,
  body.shared-view-only #btnAddMapRoute,
  body.shared-view-only .delete-btn,
  body.shared-view-only button.trash,
  body.shared-view-only [contenteditable="true"] {
    display: none !important;
  }
</style>
</head>
<body>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Chargement...</div>
</div>

<!-- Header -->
<header class="header">
  <button class="header-back" id="btnHome" aria-label="Dashboard" onclick="location.href='dashboard_user.html'">üè†</button>
  <button class="header-back" id="btnBack" aria-label="Retour">‚Üê</button>
  <div style="flex:1;"></div>
  <button class="header-btn" id="btnLangHeader" aria-label="Langue" style="background:none;border:none;font-size:18px;cursor:pointer;padding:6px 10px;color:#fff;">üåê</button>
  <button class="header-btn" id="btnSaveHeader" aria-label="Sauvegarder" style="background:none;border:none;font-size:18px;cursor:pointer;padding:6px 10px;color:#fff;">üíæ</button>
  <button class="header-btn" id="btnShareHeader" aria-label="Partager" style="background:none;border:none;font-size:18px;cursor:pointer;padding:6px 10px;color:#fff;">üîó</button>
  <button class="header-btn" id="btnUser" aria-label="Profil utilisateur" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;color:#fff;">üë§</button>
</header>

<!-- Main Content -->
<main class="main-content">
  <!-- Map Panel -->
  <!-- Bookings Panel (NEW) -->
  <div class="tab-panel" id="bookingsPanel">
    <div id="bookingsContainer">
      <p style="padding: 20px; text-align: center; color: #999;">Aucune r√©servation</p>
    </div>
  </div>
  
  <!-- Map Panel -->
  <div class="tab-panel" id="mapPanel">
    <div id="map"></div>
    <button id="btnCenterMap" aria-label="Centrer la carte" style="position:absolute;bottom:20px;right:16px;width:44px;height:44px;border-radius:50%;background:#fff;border:1px solid #e2e8f0;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:20px;cursor:pointer;z-index:500;display:flex;align-items:center;justify-content:center;">üéØ</button>
  </div>
  
  <!-- List Panel -->
  <div class="tab-panel active" id="listPanel">
    <div class="summary-card" id="summaryCard">
      <div class="summary-stat">
        <div class="value" id="statSteps">-</div>
        <div class="label" data-i18n="steps">√âtapes</div>
      </div>
      <div class="summary-stat">
        <div class="value" id="statNights">-</div>
        <div class="label" data-i18n="nights">Nuits</div>
      </div>
      <div class="summary-stat">
        <div class="value" id="statKm">-</div>
        <div class="label">Km</div>
      </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê R√âSUM√â IA ‚ïê‚ïê‚ïê -->
    <style>
    #aiSummaryBox{margin:12px 0;border:2px solid #e2e8f0;border-radius:14px;overflow:hidden;background:#fff}
    .ai-review-box{background:#f0fdf4;border:1px solid #86efac;border-radius:10px;padding:12px;margin-bottom:12px}
    .ai-review-line{margin-bottom:4px;font-size:12px;line-height:1.5;color:#1a3d1a}
    .ai-steps-grid{display:flex;flex-direction:column;gap:10px}
    .ai-step-card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:4px}
    .ai-step-day{font-weight:800;font-size:11px;color:#6366f1;text-transform:uppercase;letter-spacing:.5px}
    .ai-step-city{font-weight:700;font-size:13px;color:#1e3a5f}
    .ai-step-highlights{font-size:11px;line-height:1.5;color:#475569}
    .ai-step-next{font-size:10px;color:#6366f1;font-style:italic;margin-top:4px;padding-top:4px;border-top:1px dashed #e2e8f0}
    </style>
    <div id="aiSummaryBox">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(135deg,#f0f4ff,#e8f0fe);cursor:pointer;user-select:none;" onclick="toggleAiSummary()">
        <span id="aiSummaryTitleEl" style="font-weight:700;font-size:14px;color:#1e3a5f;">ü§ñ R√©sum√© IA</span>
        <span id="aiSummaryChevron" style="font-size:16px;transition:transform .2s;color:#64748b;">‚ñ∏</span>
      </div>
      <div id="aiSummaryContent" style="display:none;padding:14px;">
        <div id="aiSummaryPlaceholder" style="color:#64748b;font-size:12px;line-height:1.5;margin-bottom:12px;"></div>
        <div id="aiSummaryActions">
          <button id="btnAiSummary" type="button" onclick="generateAiSummary()" style="width:100%;padding:10px;border-radius:10px;border:2px solid #2563eb;background:#2563eb;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">‚ú® G√©n√©rer le r√©sum√© IA</button>
        </div>
        <div id="aiSummaryResult" style="display:none;margin-top:14px;">
          <div id="aiReviewContainer" class="ai-review-box" style="display:none"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span id="aiSummaryItineraryTitle" style="font-weight:700;color:#1e3a5f;font-size:13px;">üó∫Ô∏è R√©sum√©</span>
            <span id="aiSummaryCacheTag" style="display:none;font-size:10px;color:#94a3b8;font-style:italic;"></span>
          </div>
          <div id="aiStepsGrid" class="ai-steps-grid"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
            <button id="btnCopyAiSummary" type="button" onclick="copyAiSummary()" style="padding:8px 14px;border-radius:8px;border:1px solid #cbd5e1;background:#f8fafc;color:#475569;font-size:11px;cursor:pointer;font-weight:600;">üìã Copier</button>
            <button id="btnShareAiWhatsapp" type="button" onclick="shareAiSummary('whatsapp')" style="padding:8px 14px;border-radius:8px;border:1px solid #25d366;background:#25d366;color:#fff;font-size:11px;cursor:pointer;font-weight:700;">üí¨ WhatsApp</button>
            <button id="btnShareAiSms" type="button" onclick="shareAiSummary('sms')" style="padding:8px 14px;border-radius:8px;border:1px solid #3b82f6;background:#3b82f6;color:#fff;font-size:11px;cursor:pointer;font-weight:700;">üí¨ SMS</button>
            <button id="btnShareAiEmail" type="button" onclick="shareAiSummary('email')" style="padding:8px 14px;border-radius:8px;border:1px solid #6366f1;background:#6366f1;color:#fff;font-size:11px;cursor:pointer;font-weight:700;">‚úâÔ∏è Email</button>
            <button id="btnShareAiNative" type="button" onclick="shareAiSummary('native')" style="display:none;padding:8px 14px;border-radius:8px;border:1px solid #1e3a5f;background:#1e3a5f;color:#fff;font-size:11px;cursor:pointer;font-weight:700;" >üì§ <span id="btnShareAiNativeLabel">Partager</span></button>
          </div>
        </div>
      </div>
    </div>
    <div id="stepsList"></div>
  </div>
  
  <!-- Visualization Panel avec sous-onglets -->
  <div class="tab-panel" id="vizPanel">
    <div class="sub-tabs-container">
      <!-- Barre de sous-onglets -->
      <div class="sub-tabs-bar">
        <button class="sub-tab-btn active" data-subpanel="subPanelSteps">
          <span class="sub-tab-icon">üìç</span>
          √âtapes
        </button>
        <button class="sub-tab-btn" data-subpanel="subPanelMap">
          <span class="sub-tab-icon">üó∫Ô∏è</span>
          Google Map
        </button>
        <button class="sub-tab-btn" data-subpanel="subPanelHotels">
          <span class="sub-tab-icon">üè®</span>
          H√¥tels
        </button>
      </div>
      
      <!-- Sous-panel: √âtapes avec visites et activit√©s -->
      <div class="sub-panel active" id="subPanelSteps">
        <div class="viz-step-navigation">
          <button class="viz-nav-btn viz-nav-prev">‚Äπ</button>
          <div class="viz-step-header-info">
            <div class="viz-step-counter">√âtape 1 / 5</div>
            <div class="viz-step-name">-</div>
            <div class="viz-step-nights"></div>
          </div>
          <button class="viz-nav-btn viz-nav-next">‚Ä∫</button>
        </div>
        <div class="viz-step-scroll" id="vizStepContent">
          <!-- Contenu rempli dynamiquement -->
        </div>
      </div>
      
      <!-- Sous-panel: Google Map -->
      <div class="sub-panel" id="subPanelMap">
        <div class="viz-step-navigation">
          <button class="viz-nav-btn viz-nav-prev">‚Äπ</button>
          <div class="viz-step-header-info">
            <div class="viz-step-counter">√âtape 1 / 5</div>
            <div class="viz-step-name">-</div>
            <div class="viz-step-nights"></div>
          </div>
          <button class="viz-nav-btn viz-nav-next">‚Ä∫</button>
        </div>
        <div class="gmap-filters">
          <button class="gmap-filter-btn active" data-filter="">üìç Lieu</button>
          <button class="gmap-filter-btn" data-filter="visits">üó∫Ô∏è Visites</button>
          <button class="gmap-filter-btn" data-filter="restaurants">üçΩÔ∏è Restos</button>
          <button class="gmap-filter-btn" data-filter="monuments">üèõÔ∏è Monuments</button>
          <button class="gmap-filter-btn" data-filter="museums">üé® Mus√©es</button>
          <button class="gmap-filter-btn" data-filter="hotels">üè® H√¥tels</button>
          <button class="gmap-filter-btn" data-filter="supermarket">üõí Courses</button>
        </div>
        <div class="gmap-iframe-wrapper" id="gmapWrapper">
          <div class="gmap-placeholder">
            <div class="gmap-placeholder-icon">üó∫Ô∏è</div>
            <div>Chargement de la carte...</div>
          </div>
        </div>
      </div>
      
      <!-- Sous-panel: H√¥tels (Stay22) -->
      <div class="sub-panel" id="subPanelHotels">
        <div class="viz-step-navigation">
          <button class="viz-nav-btn viz-nav-prev">‚Äπ</button>
          <div class="viz-step-header-info">
            <div class="viz-step-counter">√âtape 1 / 5</div>
            <div class="viz-step-name">-</div>
            <div class="viz-step-nights"></div>
          </div>
          <button class="viz-nav-btn viz-nav-next">‚Ä∫</button>
        </div>
        <div class="hotels-widget-wrapper" id="hotelsWrapper">
          <div class="hotels-placeholder">
            <div class="hotels-placeholder-icon">üè®</div>
            <div>Chargement des h√¥tels...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Tab Bar -->
<nav class="tab-bar">
  <button class="tab-btn active" id="tabList" data-panel="listPanel">
    <span class="tab-icon">üìã</span>
    <span data-i18n="itinerary">Itin√©raire</span>
  </button>
  <button class="tab-btn" id="tabViz" data-panel="vizPanel">
    <span class="tab-icon">üëÅÔ∏è</span>
    <span data-i18n="visualization">Visualiser</span>
  </button>
  <button class="tab-btn" id="tabMap" data-panel="mapPanel">
    <span class="tab-icon">üó∫Ô∏è</span>
    <span data-i18n="map">Carte</span>
  </button>
  <button class="tab-btn" id="tabBookings" data-panel="bookingsPanel">
    <span class="tab-icon">üè®</span>
    <span data-i18n="bookings">R√©servations</span>
  </button>
  <button class="tab-btn" id="tabServices">
    <span class="tab-icon">üõéÔ∏è</span>
    <span data-i18n="services">Services</span>
  </button>
</nav>

<!-- Sheet Overlay -->
<div class="sheet-overlay" id="sheetOverlay"></div>

<!-- Step Detail Bottom Sheet -->
<div class="bottom-sheet" id="stepSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <button class="step-nav-btn" id="btnPrevStep" onclick="navigateStep(-1)">‚Äπ</button>
    <div class="sheet-header-center">
      <div class="sheet-title" id="sheetStepName">-</div>
      <div class="sheet-subtitle" id="sheetStepMeta">-</div>
    </div>
    <button class="step-nav-btn" id="btnNextStep" onclick="navigateStep(1)">‚Ä∫</button>
  </div>
  <div class="sheet-body">
    <img class="sheet-photo" id="sheetStepPhoto" src="" alt="">
    
    <!-- Liens affili√©s EN HAUT -->
    <div class="affiliate-buttons">
      <a class="affiliate-btn affiliate-gyg" id="btnGyg" href="#" target="_blank" rel="noopener">
        üé´ Tours
      </a>
      <a class="affiliate-btn affiliate-tiqets" id="btnTiqets" href="#" target="_blank" rel="noopener">
        üéüÔ∏è Billets
      </a>
      <a class="affiliate-btn affiliate-hotel" id="btnHotel" href="#" target="_blank" rel="noopener">
        üè® H√¥tel
      </a>
    </div>
    
    <!-- Boutons vers modales Visites et Activit√©s -->
    <div class="sheet-section">
      <div class="content-buttons">
        <button class="content-btn" id="btnOpenVisits" onclick="openVisitsModal()">
          üìç <span data-i18n="seeVisits">Voir les visites</span>
          <span class="content-count" id="visitsCount">0</span>
        </button>
        <button class="content-btn" id="btnOpenActivities" onclick="openActivitiesModal()">
          üéØ <span data-i18n="seeActivities">Voir les activit√©s</span>
          <span class="content-count" id="activitiesCount">0</span>
        </button>
      </div>
    </div>
    
    <!-- Contr√¥le des nuits -->
    <div class="sheet-section">
      <div class="sheet-section-title" data-i18n="numberOfNights">Nombre de nuits</div>
      <div class="nights-control">
        <button class="nights-btn" id="btnNightsMinus">‚àí</button>
        <div>
          <div class="nights-value" id="nightsValue">0</div>
          <div class="nights-label" data-i18n="nightPlural">nuits</div>
        </div>
        <button class="nights-btn" id="btnNightsPlus">+</button>
      </div>
    </div>
    
    <!-- Section r√©servations de l'√©tape -->
    <div class="sheet-section" id="stepBookingsSection" style="display:none">
      <div class="sheet-section-title" data-i18n="myBookings">Mes r√©servations</div>
      <div class="step-bookings-list" id="stepBookingsList"></div>
    </div>
  </div>
  <div class="sheet-actions">
    <button class="sheet-btn sheet-btn-danger" id="btnDeleteStep">üóëÔ∏è</button>
    <button class="sheet-btn sheet-btn-primary" id="btnCloseSheet" data-i18n="close">Fermer</button>
  </div>
</div>

<!-- Modale Visites -->
<div class="content-modal" id="visitsModal">
  <div class="content-modal-header">
    <h2 data-i18n="plannedVisits">üìç Visites pr√©vues</h2>
    <span class="content-modal-step" id="visitsModalStep"></span>
    <button class="content-add-btn" onclick="addVisit()" title="Ajouter une visite">Ôºã</button>
  </div>
  <div class="content-modal-body" id="visitsModalBody">
    <!-- Contenu rempli dynamiquement -->
  </div>
  <button class="floating-back-btn" onclick="closeVisitsModal()">
    <span data-i18n="back">‚Üê Retour</span>
  </button>
</div>

<!-- Modale Activit√©s -->
<div class="content-modal" id="activitiesModal">
  <div class="content-modal-header">
    <h2>üéØ <span data-i18n="activities">Activit√©s</span></h2>
    <span class="content-modal-step" id="activitiesModalStep"></span>
    <button class="content-add-btn" onclick="addActivity()" title="Ajouter une activit√©">Ôºã</button>
  </div>
  <div class="content-modal-body" id="activitiesModalBody">
    <!-- Contenu rempli dynamiquement -->
  </div>
  <button class="floating-back-btn" onclick="closeActivitiesModal()">
    <span data-i18n="back">‚Üê Retour</span>
  </button>
</div>

<!-- Modale Partage -->
<div class="content-modal" id="shareModal">
  <div class="content-modal-header">
    <h2 data-i18n="shareTitle">üîó Partager ce voyage</h2>
    <span class="content-modal-step" id="shareModalTitle"></span>
  </div>
  <div class="content-modal-body">
    <div class="share-options">
      <!-- Avertissement -->
      <div class="share-warning" data-i18n="shareWarning" style="margin-bottom:20px;">
        ‚ö†Ô∏è Toute personne avec ce lien pourra voir votre voyage
      </div>
      
      <!-- Bouton g√©n√©rer -->
      <button class="share-generate-btn" id="btnGenerateShare" onclick="generateShareLink()" style="width:100%;padding:14px;background:#113f7a;color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;">
        <span data-i18n="shareGenerate">üîó G√©n√©rer le lien</span>
      </button>
      
      <!-- R√©sultat (cach√© par d√©faut) -->
      <div class="share-result" id="shareResult" style="display:none;margin-top:16px;">
        <input type="text" class="share-url-input" id="shareUrlInput" readonly style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;margin-bottom:12px;">
        <div class="share-actions" style="display:flex;gap:10px;">
          <button class="share-action-btn" onclick="copyShareLink()" style="flex:1;padding:12px;background:#16a34a;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
            <span data-i18n="shareCopy">üìã Copier</span>
          </button>
          <button class="share-action-btn" onclick="nativeShare()" style="flex:1;padding:12px;background:#3b82f6;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
            <span data-i18n="shareNative">üì§ Partager</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <button class="floating-back-btn" onclick="closeShareModal()">
    <span data-i18n="back">‚Üê Retour</span>
  </button>
</div>

<!-- Modale Login Requis pour Partage -->
<div class="share-alert-modal" id="loginRequiredModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:10001;">
  <div style="width:min(340px,90vw);background:#fff;border-radius:16px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,.25);text-align:center;">
    <div style="font-size:48px;margin-bottom:16px;">üîê</div>
    <h3 data-i18n="loginRequired" style="margin:0 0 12px;color:#113f7a;font-size:1.2rem;">Connexion requise</h3>
    <p data-i18n="loginRequiredDesc" style="color:#666;margin:0 0 20px;font-size:0.95rem;">Connectez-vous pour partager ce voyage avec vos proches.</p>
    <button id="btnLoginRequiredLogin" style="width:100%;padding:14px;background:#113f7a;color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;margin-bottom:10px;">
      <span data-i18n="loginBtn">Se connecter</span>
    </button>
    <button id="btnLoginRequiredCancel" style="width:100%;padding:12px;background:#f5f5f5;color:#666;border:none;border-radius:10px;font-size:0.95rem;cursor:pointer;">
      <span data-i18n="cancelBtn">Annuler</span>
    </button>
  </div>
</div>

<!-- Modale Sauvegarde Requise pour Partage -->
<div class="share-alert-modal" id="saveRequiredModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:10001;">
  <div style="width:min(340px,90vw);background:#fff;border-radius:16px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,.25);text-align:center;">
    <div style="font-size:48px;margin-bottom:16px;">üíæ</div>
    <h3 data-i18n="saveRequired" style="margin:0 0 12px;color:#113f7a;font-size:1.2rem;">Sauvegarde requise</h3>
    <p data-i18n="saveRequiredDesc" style="color:#666;margin:0 0 20px;font-size:0.95rem;">Sauvegardez votre voyage avant de le partager.</p>
    <button id="btnSaveRequiredSave" style="width:100%;padding:14px;background:#113f7a;color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;margin-bottom:10px;">
      <span data-i18n="saveBtn">Sauvegarder</span>
    </button>
    <button id="btnSaveRequiredCancel" style="width:100%;padding:12px;background:#f5f5f5;color:#666;border:none;border-radius:10px;font-size:0.95rem;cursor:pointer;">
      <span data-i18n="cancelBtn">Annuler</span>
    </button>
  </div>
</div>

<!-- Services Bottom Sheet -->
<div class="bottom-sheet" id="servicesSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">üõéÔ∏è Services voyage</div>
    <div class="sheet-subtitle">R√©servez tout pour votre roadtrip</div>
  </div>
  <div class="sheet-body">
    <div class="service-grid">
      <a class="service-card" href="https://ektatraveling.tpo.li/KrBrIrRc" target="_blank" rel="noopener">
        <span class="service-icon">üõ°Ô∏è</span>
        <span class="service-name">Assurance</span>
        <span class="service-desc">Voyage serein</span>
      </a>
      <a class="service-card" href="https://trip.tpo.li/ljpidUUf" target="_blank" rel="noopener">
        <span class="service-icon">‚úàÔ∏è</span>
        <span class="service-name">Vols</span>
        <span class="service-desc">Meilleurs prix</span>
      </a>
      <a class="service-card" href="https://qeeq.tpo.li/rMRoXmko" target="_blank" rel="noopener">
        <span class="service-icon">üöó</span>
        <span class="service-name">Location auto</span>
        <span class="service-desc">Comparer les offres</span>
      </a>
      <a class="service-card" href="https://gettransfer.tpo.li/NQ4bVvpZ" target="_blank" rel="noopener">
        <span class="service-icon">üöê</span>
        <span class="service-name">Transferts</span>
        <span class="service-desc">A√©roport & plus</span>
      </a>
      <!-- Masqu√© temporairement - fonctionnalit√© en d√©veloppement -->
      <div class="service-card" id="btnScanBooking" style="display:none;">
        <span class="service-icon">üì∑</span>
        <span class="service-name">Scanner r√©sa</span>
        <span class="service-desc">Photo ‚Üí import</span>
      </div>
      <div class="service-card" id="btnScanDocument" style="display:none;">
        <span class="service-icon">ü™™</span>
        <span class="service-name">Scanner doc</span>
        <span class="service-desc">Passeport, visa...</span>
      </div>
    </div>
  </div>
</div>

<!-- Menu Bottom Sheet -->
<!-- User Profile Bottom Sheet -->
<div class="bottom-sheet" id="userSheet">
  <div class="sheet-handle" onclick="closeAllSheets()"></div>
  <div class="sheet-header">
    <div class="sheet-title" data-i18n="profile">Profil</div>
    <button class="sheet-close-btn" onclick="closeAllSheets()" style="position:absolute;right:16px;top:16px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;">‚úï</button>
  </div>
  <div class="sheet-body">
    <div id="userInfoSection" style="padding:16px;text-align:center;border-bottom:1px solid #eee;">
      <div id="userEmail" style="font-weight:600;margin-bottom:8px;" data-i18n="notConnected">Non connect√©</div>
      <div id="userStatus" style="font-size:12px;color:#666;"></div>
    </div>
    <div id="userAuthSection" style="padding:16px;">
      <button id="btnUserLogin" class="btn btn-primary" style="width:100%;margin-bottom:8px;display:none;" data-i18n="loginBtn">üîê Se connecter</button>
      <button id="btnUserLogout" class="btn btn-danger" style="width:100%;margin-bottom:8px;display:none;" data-i18n="logout">üîì D√©connexion</button>
      <button id="btnUserEmail" class="btn" style="width:100%;margin-bottom:8px;display:none;" data-i18n="changeEmail">‚úâÔ∏è Changer email</button>
      <button id="btnUserPassword" class="btn" style="width:100%;margin-bottom:8px;display:none;" data-i18n="changePassword">üîë Changer mot de passe</button>
      <button id="btnUserDelete" class="btn btn-danger" style="width:100%;display:none;opacity:0.5;" data-i18n="deleteAccount">üóëÔ∏è Supprimer compte</button>
    </div>
  </div>
</div>
<div class="bottom-sheet" id="langSheet">
  <div class="sheet-handle" onclick="closeAllSheets()"></div>
  <div class="sheet-header">
    <div class="sheet-title">üåê Langue / Language</div>
    <button class="sheet-close-btn" onclick="closeAllSheets()" style="position:absolute;right:16px;top:16px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;">‚úï</button>
  </div>
  <div class="sheet-body">
    <div class="service-grid">
      <div class="service-card lang-option" data-lang="fr">
        <span class="service-icon">üá´üá∑</span>
        <span class="service-name">Fran√ßais</span>
      </div>
      <div class="service-card lang-option" data-lang="en">
        <span class="service-icon">üá¨üáß</span>
        <span class="service-name">English</span>
      </div>
      <div class="service-card lang-option" data-lang="es">
        <span class="service-icon">üá™üá∏</span>
        <span class="service-name">Espa√±ol</span>
      </div>
      <div class="service-card lang-option" data-lang="it">
        <span class="service-icon">üáÆüáπ</span>
        <span class="service-name">Italiano</span>
      </div>
      <div class="service-card lang-option" data-lang="pt">
        <span class="service-icon">üáµüáπ</span>
        <span class="service-name">Portugu√™s</span>
      </div>
      <div class="service-card lang-option" data-lang="ar">
        <span class="service-icon">üá∏üá¶</span>
        <span class="service-name">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
      </div>
    </div>
  </div>
</div>

<!-- Scanner Bottom Sheet -->
<div class="bottom-sheet" id="scannerSheet" style="max-height:90vh;">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title" id="scannerTitle">üì∑ Scanner</div>
    <div class="sheet-subtitle" id="scannerSubtitle">Prenez une photo</div>
  </div>
  <div class="sheet-body" style="padding-bottom:20px;">
    <!-- √âtape 1: Capture -->
    <div id="scanStep1">
      <div style="text-align:center;padding:20px 0;">
        <label for="scannerInput" style="display:inline-flex;flex-direction:column;align-items:center;gap:12px;padding:30px 40px;background:#f0f4f8;border-radius:16px;border:2px dashed #113f7a;cursor:pointer;">
          <span style="font-size:3rem;">üì∑</span>
          <span style="font-weight:600;color:#113f7a;">Prendre une photo</span>
          <span style="font-size:0.85rem;color:#666;">ou choisir dans la galerie</span>
        </label>
        <input type="file" id="scannerInput" accept="image/*" capture="environment" style="display:none;">
      </div>
      <div id="scanPreview" style="display:none;text-align:center;margin-top:16px;">
        <img id="scanPreviewImg" style="max-width:100%;max-height:200px;border-radius:12px;border:1px solid #ddd;">
        <div style="margin-top:12px;display:flex;gap:10px;justify-content:center;">
          <button class="scan-btn secondary" id="btnScanRetake">üîÑ Reprendre</button>
          <button class="scan-btn primary" id="btnScanAnalyze">‚ú® Analyser</button>
        </div>
      </div>
    </div>
    <!-- √âtape 2: Loading -->
    <div id="scanStep2" style="display:none;text-align:center;padding:40px 20px;">
      <div style="font-size:3rem;animation:spin 1s linear infinite;">‚è≥</div>
      <div style="margin-top:16px;color:#666;">Analyse en cours...</div>
    </div>
    <!-- √âtape 3: R√©sultat -->
    <div id="scanStep3" style="display:none;">
      <div id="scanResult" style="background:#f8f9fa;border-radius:12px;padding:16px;margin-bottom:16px;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="scan-btn secondary" id="btnScanNew">üì∑ Nouveau scan</button>
        <button class="scan-btn primary" id="btnScanSave">üíæ Enregistrer</button>
      </div>
    </div>
    <!-- Erreur -->
    <div id="scanError" style="display:none;background:#fee;color:#c33;padding:12px;border-radius:8px;margin-top:16px;text-align:center;"></div>
  </div>
</div>

<!-- Booking Detail Bottom Sheet -->
<div class="bottom-sheet" id="bookingDetailSheet" style="max-height:85vh;">
  <div class="sheet-handle" onclick="closeAllSheets()"></div>
  <div class="sheet-header">
    <div class="sheet-title" id="bookingDetailTitle">üìã R√©servation</div>
    <button class="sheet-close-btn" onclick="closeAllSheets()" style="position:absolute;right:16px;top:16px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;">‚úï</button>
  </div>
  <div class="sheet-body" style="padding:16px;padding-bottom:120px;">
    <div id="bookingDetailContent"></div>
    <div style="display:flex;gap:12px;margin-top:20px;">
      <button id="btnEditBooking" style="flex:1;padding:14px;background:#113f7a;color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;">
        ‚úèÔ∏è Modifier
      </button>
      <button id="btnDeleteBooking" style="flex:1;padding:14px;background:#dc2626;color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;">
        üóëÔ∏è Supprimer
      </button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// Debug logger (console only)
window.debugLog = function(msg) {
  console.log('[MOBILE-DEBUG] ' + msg);
};
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="/js/ort-config.js"></script>
<script>
// Initialiser Firebase imm√©diatement apr√®s ort-config.js
(function() {
  // Attendre que ort-config soit pr√™t
  function initFb() {
    const cfg = window.ORT_CONFIG?.PROD || window.ORT_CONFIG?.PREPROD;
    if (cfg && cfg.apiKey && window.firebase && !firebase.apps.length) {
      firebase.initializeApp(cfg);
      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      console.log('[FIREBASE] ‚úÖ Initialis√© en statique');
    }
  }
  if (window.ORT_CONFIG) {
    initFb();
  } else {
    window.addEventListener('load', initFb);
  }
})();
</script>
<script src="/js/ort-partners.js"></script>
<script src="/js/ort-widgets.js"></script>
<script src="/js/ort-trip-calc.js"></script>
<script src="/js/ort-utils.js"></script>
<script src="/js/ort-data-loader.js"></script>
<script src="/js/ort-routing.js"></script>
<script src="/js/ort-tripid.js"></script>
<script src="/js/ort-trip-data.js"></script>
<script src="./js/ort-share.js"></script>
<script src="/js/ort-state-manager.js"></script>
<script src="/js/ort-i18n.js"></script>

<!-- ========== MODALE AUTH L√âG√àRE POUR MOBILE ========== -->
<script>
(function() {
  'use strict';
  
  const MODAL_ID = 'ortMobileAuthModal';
  let currentMode = 'login'; // 'login' | 'signup' | 'reset'
  
  // Traductions
  const T = {
    fr: {
      loginTitle: 'Se connecter',
      signupTitle: 'Cr√©er un compte',
      resetTitle: 'Mot de passe oubli√©',
      email: 'E-mail',
      password: 'Mot de passe',
      confirmPassword: 'Confirmer',
      login: 'Connexion',
      signup: 'Cr√©er',
      sendReset: 'Envoyer',
      cancel: 'Annuler',
      noAccount: 'Pas de compte ?',
      hasAccount: 'D√©j√† un compte ?',
      forgotPwd: 'Mot de passe oubli√© ?',
      orGoogle: 'ou avec Google',
      success: '‚úÖ Connect√© !',
      resetSent: '‚úÖ E-mail envoy√© !',
      accountCreated: '‚úÖ Compte cr√©√© ! V√©rifiez vos e-mails.',
      errFill: 'Remplissez tous les champs',
      errEmail: 'E-mail invalide',
      errPwdShort: 'Mot de passe trop court (min 6)',
      errPwdMatch: 'Mots de passe diff√©rents',
      errWrongPwd: 'Mot de passe incorrect',
      errNotFound: 'Compte inexistant',
      errExists: 'E-mail d√©j√† utilis√©',
      errGeneric: 'Erreur, r√©essayez'
    },
    en: {
      loginTitle: 'Sign in',
      signupTitle: 'Create account',
      resetTitle: 'Forgot password',
      email: 'E-mail',
      password: 'Password',
      confirmPassword: 'Confirm',
      login: 'Sign in',
      signup: 'Create',
      sendReset: 'Send',
      cancel: 'Cancel',
      noAccount: 'No account?',
      hasAccount: 'Have an account?',
      forgotPwd: 'Forgot password?',
      orGoogle: 'or with Google',
      success: '‚úÖ Signed in!',
      resetSent: '‚úÖ Email sent!',
      accountCreated: '‚úÖ Account created! Check your emails.',
      errFill: 'Fill all fields',
      errEmail: 'Invalid email',
      errPwdShort: 'Password too short (min 6)',
      errPwdMatch: 'Passwords don\'t match',
      errWrongPwd: 'Wrong password',
      errNotFound: 'Account not found',
      errExists: 'Email already used',
      errGeneric: 'Error, try again'
    }
  };
  
  function t(key) {
    const lang = localStorage.getItem('ort_lang') || 'fr';
    return T[lang]?.[key] || T.fr[key] || key;
  }
  
  function createModal() {
    let modal = document.getElementById(MODAL_ID);
    if (modal) return modal;
    
    modal = document.createElement('div');
    modal.id = MODAL_ID;
    modal.style.cssText = `
      display:none;position:fixed;inset:0;
      background:rgba(0,0,0,.6);
      align-items:center;justify-content:center;
      z-index:10000;
    `;
    modal.innerHTML = `
      <div style="
        width:min(360px,92vw);
        background:#fff;
        border-radius:16px;
        padding:20px;
        box-shadow:0 10px 40px rgba(0,0,0,.25);
      ">
        <h3 id="authModalTitle" style="margin:0 0 16px;color:#113f7a;font-size:1.3rem;text-align:center"></h3>
        
        <div id="authModalMsg" style="display:none;padding:10px;border-radius:8px;margin-bottom:12px;text-align:center;font-size:0.9rem"></div>
        
        <input id="authEmail" type="email" style="
          width:100%;padding:12px;border:1.5px solid #113f7a;border-radius:10px;
          margin-bottom:10px;font-size:1rem;
        ">
        
        <div style="position:relative">
          <input id="authPwd" type="password" style="
            width:100%;padding:12px;padding-right:40px;border:1.5px solid #113f7a;border-radius:10px;
            margin-bottom:10px;font-size:1rem;
          ">
          <button type="button" id="toggleAuthPwd" style="position:absolute;right:10px;top:12px;background:none;border:none;cursor:pointer;font-size:18px;">üëÅ</button>
        </div>
        
        <div id="authPwd2Wrap" style="display:none;position:relative">
          <input id="authPwd2" type="password" style="
            width:100%;padding:12px;padding-right:40px;border:1.5px solid #113f7a;border-radius:10px;
            margin-bottom:10px;font-size:1rem;
          ">
          <button type="button" id="toggleAuthPwd2" style="position:absolute;right:10px;top:12px;background:none;border:none;cursor:pointer;font-size:18px;">üëÅ</button>
        </div>
        
        <button id="authSubmit" style="
          width:100%;padding:14px;background:#113f7a;color:#fff;
          border:none;border-radius:10px;font-size:1rem;font-weight:600;
          cursor:pointer;margin-bottom:10px;
        "></button>
        
        <button id="authGoogle" style="
          width:100%;padding:12px;background:#fff;color:#333;
          border:1px solid #ddd;border-radius:10px;font-size:0.95rem;
          cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;
        ">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:20px;height:20px">
          <span id="authGoogleText"></span>
        </button>
        
        <div style="display:flex;justify-content:space-between;margin-top:14px;font-size:0.9rem">
          <button id="authToggle" style="background:none;border:none;color:#113f7a;text-decoration:underline;cursor:pointer"></button>
          <button id="authForgot" style="background:none;border:none;color:#666;cursor:pointer"></button>
        </div>
        
        <button id="authCancel" style="
          width:100%;padding:10px;background:#f5f5f5;color:#666;
          border:none;border-radius:10px;font-size:0.95rem;
          cursor:pointer;margin-top:12px;
        "></button>
      </div>
    `;
    document.body.appendChild(modal);
    
    // Events
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
    document.getElementById('authSubmit').onclick = handleSubmit;
    document.getElementById('authGoogle').onclick = handleGoogle;
    document.getElementById('authToggle').onclick = () => {
      currentMode = currentMode === 'login' ? 'signup' : 'login';
      updateModalUI();
    };
    document.getElementById('authForgot').onclick = () => {
      currentMode = 'reset';
      updateModalUI();
    };
    document.getElementById('authCancel').onclick = closeModal;
    
    // Toggle password visibility
    document.getElementById('toggleAuthPwd').onclick = function() {
      const pwd = document.getElementById('authPwd');
      pwd.type = pwd.type === 'password' ? 'text' : 'password';
      this.textContent = pwd.type === 'password' ? 'üëÅ' : 'üôà';
    };
    document.getElementById('toggleAuthPwd2').onclick = function() {
      const pwd2 = document.getElementById('authPwd2');
      pwd2.type = pwd2.type === 'password' ? 'text' : 'password';
      this.textContent = pwd2.type === 'password' ? 'üëÅ' : 'üôà';
    };
    
    // Enter key
    ['authEmail', 'authPwd', 'authPwd2'].forEach(id => {
      document.getElementById(id).onkeydown = e => { if (e.key === 'Enter') handleSubmit(); };
    });
    
    return modal;
  }
  
  function updateModalUI() {
    const title = document.getElementById('authModalTitle');
    const email = document.getElementById('authEmail');
    const pwd = document.getElementById('authPwd');
    const pwd2Wrap = document.getElementById('authPwd2Wrap');
    const submit = document.getElementById('authSubmit');
    const google = document.getElementById('authGoogle');
    const googleText = document.getElementById('authGoogleText');
    const toggle = document.getElementById('authToggle');
    const forgot = document.getElementById('authForgot');
    const cancel = document.getElementById('authCancel');
    const msg = document.getElementById('authModalMsg');
    
    msg.style.display = 'none';
    email.placeholder = t('email');
    document.getElementById('authPwd').placeholder = t('password');
    document.getElementById('authPwd2').placeholder = t('confirmPassword');
    cancel.textContent = t('cancel');
    googleText.textContent = t('orGoogle');
    
    if (currentMode === 'login') {
      title.textContent = t('loginTitle');
      pwd.parentElement.style.display = '';
      pwd2Wrap.style.display = 'none';
      google.style.display = '';
      submit.textContent = t('login');
      toggle.textContent = t('noAccount');
      forgot.textContent = t('forgotPwd');
      forgot.style.display = '';
    } else if (currentMode === 'signup') {
      title.textContent = t('signupTitle');
      pwd.parentElement.style.display = '';
      pwd2Wrap.style.display = 'block';
      google.style.display = '';
      submit.textContent = t('signup');
      toggle.textContent = t('hasAccount');
      forgot.style.display = 'none';
    } else if (currentMode === 'reset') {
      title.textContent = t('resetTitle');
      pwd.parentElement.style.display = 'none';
      pwd2Wrap.style.display = 'none';
      google.style.display = 'none';
      submit.textContent = t('sendReset');
      toggle.textContent = t('hasAccount');
      forgot.style.display = 'none';
    }
  }
  
  function showMsg(text, isError) {
    const msg = document.getElementById('authModalMsg');
    msg.textContent = text;
    msg.style.display = '';
    msg.style.background = isError ? '#fee' : '#efe';
    msg.style.color = isError ? '#c00' : '#060';
  }
  
  async function handleSubmit() {
    const email = document.getElementById('authEmail').value.trim().toLowerCase();
    const pwd = document.getElementById('authPwd').value;
    const pwd2 = document.getElementById('authPwd2').value;
    const submit = document.getElementById('authSubmit');
    
    if (!email || !email.includes('@')) {
      showMsg(t('errEmail'), true);
      return;
    }
    
    if (currentMode !== 'reset') {
      if (!pwd || pwd.length < 6) {
        showMsg(t('errPwdShort'), true);
        return;
      }
    }
    
    if (currentMode === 'signup' && pwd !== pwd2) {
      showMsg(t('errPwdMatch'), true);
      return;
    }
    
    const oldText = submit.textContent;
    submit.disabled = true;
    submit.textContent = '...';
    
    try {
      const auth = firebase.auth();
      
      if (currentMode === 'login') {
        await auth.signInWithEmailAndPassword(email, pwd);
        showMsg(t('success'), false);
        setTimeout(closeModal, 1000);
        
      } else if (currentMode === 'signup') {
        const result = await auth.createUserWithEmailAndPassword(email, pwd);
        await result.user.sendEmailVerification();
        showMsg(t('accountCreated'), false);
        setTimeout(() => { currentMode = 'login'; updateModalUI(); }, 2000);
        
      } else if (currentMode === 'reset') {
        await auth.sendPasswordResetEmail(email);
        showMsg(t('resetSent'), false);
        setTimeout(() => { currentMode = 'login'; updateModalUI(); }, 2000);
      }
      
    } catch (e) {
      let msg = t('errGeneric');
      if (e.code === 'auth/user-not-found') msg = t('errNotFound');
      else if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') msg = t('errWrongPwd');
      else if (e.code === 'auth/email-already-in-use') msg = t('errExists');
      showMsg(msg, true);
    } finally {
      submit.disabled = false;
      submit.textContent = oldText;
    }
  }
  
  async function handleGoogle() {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      await firebase.auth().signInWithPopup(provider);
      showMsg(t('success'), false);
      setTimeout(closeModal, 1000);
    } catch (e) {
      if (e.code !== 'auth/popup-closed-by-user') {
        showMsg(t('errGeneric'), true);
      }
    }
  }
  
  function closeModal() {
    const modal = document.getElementById(MODAL_ID);
    if (modal) modal.style.display = 'none';
  }
  
  // API publique
  window.openAuth = function(mode = 'login') {
    currentMode = mode;
    createModal();
    updateModalUI();
    document.getElementById(MODAL_ID).style.display = 'flex';
    document.getElementById('authEmail').value = '';
    document.getElementById('authPwd').value = '';
    document.getElementById('authPwd2').value = '';
    document.getElementById('authEmail').focus();
  };
  
  console.log('[ORT-MOBILE-AUTH] ‚úÖ Modale auth initialis√©e');
})();
</script>

<script>
// === GLOBAL REDIRECT PROTECTION ===
// Intercept location.replace/assign to ensure desktop redirects include mobile=0
(function(){
  const originalReplace = window.location.replace.bind(window.location);
  const originalAssign = window.location.assign.bind(window.location);

  window.location.replace = function(url) {
    if (typeof url === 'string' && (url.includes('roadtrip_detail') || url.includes('route_builder'))) {
      if (!url.includes('mobile=0')) {
        const sep = url.includes('?') ? '&' : '?';
        url = url + sep + 'mobile=0';
        console.log('[ORT-MOBILE] Protected redirect with mobile=0:', url);
      }
    }
    return originalReplace(url);
  };

  window.location.assign = function(url) {
    if (typeof url === 'string' && (url.includes('roadtrip_detail') || url.includes('route_builder'))) {
      if (!url.includes('mobile=0')) {
        const sep = url.includes('?') ? '&' : '?';
        url = url + sep + 'mobile=0';
        console.log('[ORT-MOBILE] Protected assignment with mobile=0:', url);
      }
    }
    return originalAssign(url);
  };
})();

// === AFFILIATE LINKS - Fourni par ort-partners.js ===
// Alias pour compatibilit√©
const STAY22_CONFIG = ORT_PARTNERS.STAY22_CONFIG;
const AFFILIATE = ORT_PARTNERS.AFFILIATE;

// Placeholder image
const PLACEHOLDER_IMG = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZTJlOGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmaWxsPSIjOTRhM2I4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+8J+TtyBQaG90bzwvdGV4dD48L3N2Zz4=';

// PHOTOS_CACHE est g√©r√© par ort-data-loader.js (window.PHOTOS_CACHE)
if (!window.PHOTOS_CACHE) window.PHOTOS_CACHE = {};
var PHOTOS_CACHE = window.PHOTOS_CACHE;

// toSlug() ‚Üí fourni par ort-utils.js
// findPhotosForPlace(), getPhotosForPlace(), loadPhotosCache() ‚Üí fournis par ort-data-loader.js

// === STATE ===
let state = { title: 'Roadtrip', steps: [], cc: '', lang: 'fr', _originalItinId: null };
let map = null;
let markers = [];
let routeLayer = null;
let currentStepIndex = null;
let hasUnsavedChanges = false;
let totalRouteKm = 0;
let CITY_NAMES_INDEX = {};
// PLACES_INDEX est g√©r√© par ort-data-loader.js (window.PLACES_INDEX)
if (!window.PLACES_INDEX) window.PLACES_INDEX = {};
// Alias local pour compatibilit√©
var PLACES_INDEX = window.PLACES_INDEX;

// === I18N GLOBAL ===
const I18N_MOBILE = {
  fr: {
    // Navigation
    steps: '√âtapes',
    nights: 'Nuits',
    night: 'nuit',
    nightPlural: 'nuits',
    itinerary: 'Itin√©raire',
    map: 'Carte',
    bookings: 'R√©servations',
    services: 'Services',
    noBookings: 'Aucune r√©servation',
    // Step sheet
    stepOf: '√âtape {0} sur {1}',
    numberOfNights: 'Nombre de nuits',
    myBookings: 'Mes r√©servations',
    close: 'Fermer',
    // Visites & Activit√©s
    visits: 'Visites',
    activities: 'Activit√©s',
    seeVisits: 'Voir les visites',
    seeActivities: 'Voir les activit√©s',
    plannedVisits: 'üìç Visites pr√©vues',
    noVisits: 'Aucune visite pr√©vue pour cette √©tape',
    noActivities: 'Aucune activit√© pr√©vue pour cette √©tape',
    visit: 'Visite',
    activity: 'Activit√©',
    // Partage
    shareTitle: 'üîó Partager ce voyage',
    shareWarning: '‚ö†Ô∏è Toute personne avec ce lien pourra voir votre voyage',
    shareGenerate: 'üîó G√©n√©rer le lien',
    shareRegenerate: 'üîÑ R√©g√©n√©rer le lien',
    shareGenerating: '‚è≥ G√©n√©ration...',
    shareCopy: 'üìã Copier',
    shareNative: 'üì§ Partager',
    back: '‚Üê Retour',
    // Auth
    loginRequired: 'üîê Connexion requise',
    loginRequiredDesc: 'Connectez-vous pour sauvegarder et partager ce voyage.',
    loginBtn: 'Se connecter',
    saveRequired: 'üíæ Sauvegarde requise',
    saveRequiredDesc: 'Sauvegardez votre voyage avant de le partager.',
    saveBtn: 'Sauvegarder',
    cancelBtn: 'Annuler',
    // User profile
    profile: 'Profil',
    notConnected: 'Non connect√©',
    connectionRequired: 'Connexion requise',
    connectedSince: 'Connect√© depuis',
    logout: 'üîì D√©connexion',
    changeEmail: '‚úâÔ∏è Changer email',
    changePassword: 'üîë Changer mot de passe',
    deleteAccount: 'üóëÔ∏è Supprimer compte',
    // Messages
    linkCreated: '‚úÖ Lien cr√©√© !',
    linkCopied: 'üìã Lien copi√© !',
    saved: '‚úÖ Sauvegard√© !',
    mapCentered: 'üéØ Carte centr√©e',
    noStepsToShare: '‚ùå Aucune √©tape √† partager',
    tripNotSaved: '‚ùå Voyage non sauvegard√©',
    unsavedChanges: 'Modifications non sauvegard√©es. Quitter ?'
  },
  en: {
    steps: 'Steps',
    nights: 'Nights',
    night: 'night',
    nightPlural: 'nights',
    itinerary: 'Itinerary',
    map: 'Map',
    bookings: 'Bookings',
    services: 'Services',
    noBookings: 'No bookings',
    stepOf: 'Step {0} of {1}',
    numberOfNights: 'Number of nights',
    myBookings: 'My bookings',
    close: 'Close',
    visits: 'Visits',
    activities: 'Activities',
    seeVisits: 'See visits',
    seeActivities: 'See activities',
    plannedVisits: 'üìç Planned visits',
    noVisits: 'No visits planned for this step',
    noActivities: 'No activities planned for this step',
    visit: 'Visit',
    activity: 'Activity',
    shareTitle: 'üîó Share this trip',
    shareWarning: '‚ö†Ô∏è Anyone with this link can view your trip',
    shareGenerate: 'üîó Generate link',
    shareRegenerate: 'üîÑ Regenerate link',
    shareGenerating: '‚è≥ Generating...',
    shareCopy: 'üìã Copy',
    shareNative: 'üì§ Share',
    back: '‚Üê Back',
    loginRequired: 'üîê Login required',
    loginRequiredDesc: 'Sign in to save and share this trip.',
    loginBtn: 'Sign in',
    saveRequired: 'üíæ Save required',
    saveRequiredDesc: 'Save your trip before sharing it.',
    saveBtn: 'Save',
    cancelBtn: 'Cancel',
    profile: 'Profile',
    notConnected: 'Not connected',
    connectionRequired: 'Login required',
    connectedSince: 'Connected since',
    logout: 'üîì Logout',
    changeEmail: '‚úâÔ∏è Change email',
    changePassword: 'üîë Change password',
    deleteAccount: 'üóëÔ∏è Delete account',
    linkCreated: '‚úÖ Link created!',
    linkCopied: 'üìã Link copied!',
    saved: '‚úÖ Saved!',
    mapCentered: 'üéØ Map centered',
    noStepsToShare: '‚ùå No steps to share',
    tripNotSaved: '‚ùå Trip not saved',
    unsavedChanges: 'Unsaved changes. Leave?'
  },
  es: {
    steps: 'Etapas',
    nights: 'Noches',
    night: 'noche',
    nightPlural: 'noches',
    itinerary: 'Itinerario',
    map: 'Mapa',
    bookings: 'Reservas',
    services: 'Servicios',
    noBookings: 'Sin reservas',
    stepOf: 'Etapa {0} de {1}',
    numberOfNights: 'N√∫mero de noches',
    myBookings: 'Mis reservas',
    close: 'Cerrar',
    visits: 'Visitas',
    activities: 'Actividades',
    seeVisits: 'Ver visitas',
    seeActivities: 'Ver actividades',
    plannedVisits: 'üìç Visitas previstas',
    noVisits: 'Sin visitas previstas para esta etapa',
    noActivities: 'Sin actividades previstas para esta etapa',
    visit: 'Visita',
    activity: 'Actividad',
    shareTitle: 'üîó Compartir este viaje',
    shareWarning: '‚ö†Ô∏è Cualquiera con este enlace podr√° ver tu viaje',
    shareGenerate: 'üîó Generar enlace',
    shareRegenerate: 'üîÑ Regenerar enlace',
    shareGenerating: '‚è≥ Generando...',
    shareCopy: 'üìã Copiar',
    shareNative: 'üì§ Compartir',
    back: '‚Üê Volver',
    loginRequired: 'üîê Inicio de sesi√≥n requerido',
    loginRequiredDesc: 'Inicia sesi√≥n para guardar y compartir este viaje.',
    loginBtn: 'Iniciar sesi√≥n',
    saveRequired: 'üíæ Guardado requerido',
    saveRequiredDesc: 'Guarda tu viaje antes de compartirlo.',
    saveBtn: 'Guardar',
    cancelBtn: 'Cancelar',
    profile: 'Perfil',
    notConnected: 'No conectado',
    connectionRequired: 'Inicio de sesi√≥n requerido',
    connectedSince: 'Conectado desde',
    logout: 'üîì Cerrar sesi√≥n',
    changeEmail: '‚úâÔ∏è Cambiar email',
    changePassword: 'üîë Cambiar contrase√±a',
    deleteAccount: 'üóëÔ∏è Eliminar cuenta',
    linkCreated: '‚úÖ ¬°Enlace creado!',
    linkCopied: 'üìã ¬°Enlace copiado!',
    saved: '‚úÖ ¬°Guardado!',
    mapCentered: 'üéØ Mapa centrado',
    noStepsToShare: '‚ùå Sin etapas para compartir',
    tripNotSaved: '‚ùå Viaje no guardado',
    unsavedChanges: 'Cambios no guardados. ¬øSalir?'
  },
  it: {
    steps: 'Tappe',
    nights: 'Notti',
    night: 'notte',
    nightPlural: 'notti',
    itinerary: 'Itinerario',
    map: 'Mappa',
    bookings: 'Prenotazioni',
    services: 'Servizi',
    noBookings: 'Nessuna prenotazione',
    stepOf: 'Tappa {0} di {1}',
    numberOfNights: 'Numero di notti',
    myBookings: 'Le mie prenotazioni',
    close: 'Chiudi',
    visits: 'Visite',
    activities: 'Attivit√†',
    seeVisits: 'Vedi visite',
    seeActivities: 'Vedi attivit√†',
    plannedVisits: 'üìç Visite previste',
    noVisits: 'Nessuna visita prevista per questa tappa',
    noActivities: 'Nessuna attivit√† prevista per questa tappa',
    visit: 'Visita',
    activity: 'Attivit√†',
    shareTitle: 'üîó Condividi questo viaggio',
    shareWarning: '‚ö†Ô∏è Chiunque con questo link potr√† vedere il tuo viaggio',
    shareGenerate: 'üîó Genera link',
    shareRegenerate: 'üîÑ Rigenera link',
    shareGenerating: '‚è≥ Generazione...',
    shareCopy: 'üìã Copia',
    shareNative: 'üì§ Condividi',
    back: '‚Üê Indietro',
    loginRequired: 'üîê Accesso richiesto',
    loginRequiredDesc: 'Accedi per salvare e condividere questo viaggio.',
    loginBtn: 'Accedi',
    saveRequired: 'üíæ Salvataggio richiesto',
    saveRequiredDesc: 'Salva il tuo viaggio prima di condividerlo.',
    saveBtn: 'Salva',
    cancelBtn: 'Annulla',
    profile: 'Profilo',
    notConnected: 'Non connesso',
    connectionRequired: 'Accesso richiesto',
    connectedSince: 'Connesso da',
    logout: 'üîì Esci',
    changeEmail: '‚úâÔ∏è Cambia email',
    changePassword: 'üîë Cambia password',
    deleteAccount: 'üóëÔ∏è Elimina account',
    linkCreated: '‚úÖ Link creato!',
    linkCopied: 'üìã Link copiato!',
    saved: '‚úÖ Salvato!',
    mapCentered: 'üéØ Mappa centrata',
    noStepsToShare: '‚ùå Nessuna tappa da condividere',
    tripNotSaved: '‚ùå Viaggio non salvato',
    unsavedChanges: 'Modifiche non salvate. Uscire?'
  },
  pt: {
    steps: 'Etapas',
    nights: 'Noites',
    night: 'noite',
    nightPlural: 'noites',
    itinerary: 'Itiner√°rio',
    map: 'Mapa',
    bookings: 'Reservas',
    services: 'Servi√ßos',
    noBookings: 'Sem reservas',
    stepOf: 'Etapa {0} de {1}',
    numberOfNights: 'N√∫mero de noites',
    myBookings: 'Minhas reservas',
    close: 'Fechar',
    visits: 'Visitas',
    activities: 'Atividades',
    seeVisits: 'Ver visitas',
    seeActivities: 'Ver atividades',
    plannedVisits: 'üìç Visitas previstas',
    noVisits: 'Nenhuma visita prevista para esta etapa',
    noActivities: 'Nenhuma atividade prevista para esta etapa',
    visit: 'Visita',
    activity: 'Atividade',
    shareTitle: 'üîó Partilhar esta viagem',
    shareWarning: '‚ö†Ô∏è Qualquer pessoa com este link poder√° ver a sua viagem',
    shareGenerate: 'üîó Gerar link',
    shareRegenerate: 'üîÑ Regenerar link',
    shareGenerating: '‚è≥ A gerar...',
    shareCopy: 'üìã Copiar',
    shareNative: 'üì§ Partilhar',
    back: '‚Üê Voltar',
    loginRequired: 'üîê Login necess√°rio',
    loginRequiredDesc: 'Entre para guardar e partilhar esta viagem.',
    loginBtn: 'Entrar',
    saveRequired: 'üíæ Guardar necess√°rio',
    saveRequiredDesc: 'Guarde a sua viagem antes de a partilhar.',
    saveBtn: 'Guardar',
    cancelBtn: 'Cancelar',
    profile: 'Perfil',
    notConnected: 'N√£o conectado',
    connectionRequired: 'Login necess√°rio',
    connectedSince: 'Conectado desde',
    logout: 'üîì Sair',
    changeEmail: '‚úâÔ∏è Alterar email',
    changePassword: 'üîë Alterar senha',
    deleteAccount: 'üóëÔ∏è Eliminar conta',
    linkCreated: '‚úÖ Link criado!',
    linkCopied: 'üìã Link copiado!',
    saved: '‚úÖ Guardado!',
    mapCentered: 'üéØ Mapa centrado',
    noStepsToShare: '‚ùå Sem etapas para partilhar',
    tripNotSaved: '‚ùå Viagem n√£o guardada',
    unsavedChanges: 'Altera√ß√µes n√£o guardadas. Sair?'
  },
  ar: {
    steps: 'ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ',
    nights: 'ÿßŸÑŸÑŸäÿßŸÑŸä',
    night: 'ŸÑŸäŸÑÿ©',
    nightPlural: 'ŸÑŸäÿßŸÑŸä',
    itinerary: 'ÿÆÿ∑ ÿßŸÑÿ≥Ÿäÿ±',
    map: 'ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©',
    bookings: 'ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™',
    services: 'ÿßŸÑÿÆÿØŸÖÿßÿ™',
    noBookings: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ÿ¨Ÿàÿ≤ÿßÿ™',
    stepOf: 'ŸÖÿ±ÿ≠ŸÑÿ© {0} ŸÖŸÜ {1}',
    numberOfNights: 'ÿπÿØÿØ ÿßŸÑŸÑŸäÿßŸÑŸä',
    myBookings: 'ÿ≠ÿ¨Ÿàÿ≤ÿßÿ™Ÿä',
    close: 'ÿ•ÿ∫ŸÑÿßŸÇ',
    visits: 'ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™',
    activities: 'ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©',
    seeVisits: 'ÿπÿ±ÿ∂ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™',
    seeActivities: 'ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©',
    plannedVisits: 'üìç ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿÆÿ∑ÿ∑ÿ©',
    noVisits: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≤Ÿäÿßÿ±ÿßÿ™ ŸÖÿÆÿ∑ÿ∑ÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©',
    noActivities: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÜÿ¥ÿ∑ÿ© ŸÖÿÆÿ∑ÿ∑ÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©',
    visit: 'ÿ≤Ÿäÿßÿ±ÿ©',
    activity: 'ŸÜÿ¥ÿßÿ∑',
    shareTitle: 'üîó ŸÖÿ¥ÿßÿ±ŸÉÿ© Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≠ŸÑÿ©',
    shareWarning: '‚ö†Ô∏è ÿ£Ÿä ÿ¥ÿÆÿµ ŸÑÿØŸäŸá Ÿáÿ∞ÿß ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸäŸÖŸÉŸÜŸá ÿ±ÿ§Ÿäÿ© ÿ±ÿ≠ŸÑÿ™ŸÉ',
    shareGenerate: 'üîó ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑',
    shareRegenerate: 'üîÑ ÿ•ÿπÿßÿØÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ±ÿßÿ®ÿ∑',
    shareGenerating: '‚è≥ ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°...',
    shareCopy: 'üìã ŸÜÿ≥ÿÆ',
    shareNative: 'üì§ ŸÖÿ¥ÿßÿ±ŸÉÿ©',
    back: '‚Üê ÿ±ÿ¨Ÿàÿπ',
    loginRequired: 'üîê ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ∑ŸÑŸàÿ®',
    loginRequiredDesc: 'ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑÿ≠ŸÅÿ∏ ŸàŸÖÿ¥ÿßÿ±ŸÉÿ© Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≠ŸÑÿ©.',
    loginBtn: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
    saveRequired: 'üíæ ÿßŸÑÿ≠ŸÅÿ∏ ŸÖÿ∑ŸÑŸàÿ®',
    saveRequiredDesc: 'ÿßÿ≠ŸÅÿ∏ ÿ±ÿ≠ŸÑÿ™ŸÉ ŸÇÿ®ŸÑ ŸÖÿ¥ÿßÿ±ŸÉÿ™Ÿáÿß.',
    saveBtn: 'ÿ≠ŸÅÿ∏',
    cancelBtn: 'ÿ•ŸÑÿ∫ÿßÿ°',
    profile: 'ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä',
    notConnected: 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ',
    connectionRequired: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ∑ŸÑŸàÿ®',
    connectedSince: 'ŸÖÿ™ÿµŸÑ ŸÖŸÜÿ∞',
    logout: 'üîì ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨',
    changeEmail: '‚úâÔ∏è ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ®ÿ±ŸäÿØ',
    changePassword: 'üîë ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
    deleteAccount: 'üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®',
    linkCreated: '‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ±ÿßÿ®ÿ∑!',
    linkCopied: 'üìã ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑!',
    saved: '‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏!',
    mapCentered: 'üéØ ÿ™ŸÖ ÿ™Ÿàÿ≥Ÿäÿ∑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©',
    noStepsToShare: '‚ùå ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ±ÿßÿ≠ŸÑ ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©',
    tripNotSaved: '‚ùå ÿßŸÑÿ±ÿ≠ŸÑÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ŸÅŸàÿ∏ÿ©',
    unsavedChanges: 'ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ≠ŸÅŸàÿ∏ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ∫ÿßÿØÿ±ÿ©ÿü'
  }
};

function i18n(key) {
  const lang = new URLSearchParams(location.search).get('lang') || localStorage.getItem('lang') || localStorage.getItem('ort_lang') || 'fr';
  // 1. Chercher dans I18N_MOBILE local
  if (I18N_MOBILE[lang]?.[key]) return I18N_MOBILE[lang][key];
  if (I18N_MOBILE.fr?.[key]) return I18N_MOBILE.fr[key];
  // 2. Chercher dans ORT_I18N global (ort-i18n.js)
  if (window.ORT_I18N?.[key]?.[lang]) return window.ORT_I18N[key][lang];
  if (window.ORT_I18N?.[key]?.fr) return window.ORT_I18N[key].fr;
  return key;
}

function applyI18n() {
  const lang = new URLSearchParams(location.search).get('lang') || localStorage.getItem('lang') || localStorage.getItem('ort_lang') || 'fr';
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const text = i18n(key);
    if (text && text !== key) el.textContent = text;
  });
}

/**
 * Retourne le nom de ville dans la langue demand√©e avec fallbacks
 */
function getCityDisplayName(place, lang) {
  if (!place) return '';
  const pid = place.place_id || place.placeId;
  
  // 1. Chercher dans CITY_NAMES_INDEX
  if (pid && CITY_NAMES_INDEX[pid]?.names) {
    const names = CITY_NAMES_INDEX[pid].names;
    if (names[lang]) return names[lang];
    if (names.en) return names.en;
    if (names.fr) return names.fr;
    if (names._default) return names._default;
  }
  
  // 2. Fallback: place.names
  if (place.names) {
    if (place.names[lang]) return place.names[lang];
    if (place.names.en) return place.names.en;
    if (place.names.fr) return place.names.fr;
  }
  
  // 3. Nom original
  return place.name || '';
}

// === FUNCTIONS POUR CHARGER PLACES ===
// loadJSON(), loadWithLangFallback(), ensurePlacesIndex() ‚Üí fournis par ort-data-loader.js

// === DOM REFS ===
const $ = id => document.getElementById(id);

// === INIT ===
document.addEventListener('DOMContentLoaded', init);

setTimeout(() => {
  const overlay = $('loadingOverlay');
  if (overlay && !overlay.classList.contains('hide')) {
    overlay.classList.add('hide');
  }
}, 8000);

async function init() {
  console.log('[LOG-CONTROLE][MOBILE] Init');
  
  // === FIREBASE D√âJ√Ä INITIALIS√â EN STATIQUE ===
  // V√©rifier juste qu'il est pr√™t
  try {
    if (typeof firebase !== 'undefined' && firebase.apps && !firebase.apps.length) {
      // Init de secours si pas encore fait
      const host = location.hostname;
      const isPreprod = /oneroadtrip-preprod|localhost|127\.0\.0\.1|0\.0\.0\.0|test-oneroadtrip/.test(host);
      const cfg = isPreprod ? (window.ORT_CONFIG?.PREPROD || {}) : (window.ORT_CONFIG?.PROD || {});
      const safe = (cfg && cfg.apiKey) ? cfg : (window.ORT_CONFIG?.PREPROD || {});
      
      if (safe && safe.apiKey) {
        firebase.initializeApp(safe);
        console.log('[LOG-CONTROLE][MOBILE] ‚úÖ Firebase initialis√© (fallback)');
      }
    }
  } catch (e) {
    console.warn('[MOBILE] ‚ö†Ô∏è Erreur init Firebase:', e);
  }
  
  // === INITIALISER ORT_STATE POUR SAUVEGARDE ===
  if (window.ORT_STATE) {
    try {
      // Attendre Firebase Auth
      await new Promise((resolve) => {
        if (typeof firebase !== 'undefined' && firebase.auth) {
          firebase.auth().onAuthStateChanged(user => {
            console.log('[LOG-CONTROLE][MOBILE] Auth state:', user ? user.email : 'non connect√©');
            resolve(user);
          });
        } else {
          console.log('[LOG-CONTROLE][MOBILE] Firebase Auth non disponible');
          resolve(null);
        }
      });
      
      const user = typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser;
      await window.ORT_STATE.init({ user: user, premium: false });
      
      if (user) {
        await window.ORT_STATE.updateUser(user);
      }
      console.log('[LOG-CONTROLE][MOBILE] ‚úÖ ORT_STATE initialis√©');
    } catch (e) {
      console.error('[MOBILE] Erreur init ORT_STATE:', e);
    }
  }
  
  // Charger le cache de photos AVANT tout le reste
  await loadPhotosCache();
  
  const params = new URLSearchParams(location.search);
  
  // ========== DEBUG LOGS - LOG-CONTROLE ==========
  console.log('%c[LOG-CONTROLE][MOBILE] ========== PARSING URL ==========', 'background: #ff6600; color: white; font-size: 14px; padding: 4px 8px;');
  console.log('[LOG-CONTROLE][MOBILE] URL compl√®te:', location.href);
  console.log('[LOG-CONTROLE][MOBILE] Search params:', location.search);
  console.log('[LOG-CONTROLE][MOBILE] Tous les params:');
  for (const [key, value] of params.entries()) {
    console.log(`[LOG-CONTROLE][MOBILE]   - ${key} = "${value}"`);
  }
  // ===============================================
  
  const shareToken = params.get('share'); // üî¥ Mode partage
  const cc = params.get('cc')?.toUpperCase() || '';
  const itinId = params.get('itin') || '';
  const rtKey = params.get('rtKey') || '';
  const tripId = params.get('tripId') || params.get('id') || '';
  const lang = params.get('lang') || localStorage.getItem('ort_lang') || 'fr';
  const fromTemp = params.get('from') === 'temp';
  const builderMode = params.get('mode') === 'builder' || params.get('from') === 'builder';
  const fromBuilderResult = params.get('fromBuilder') === '1';
  const dashboardMode = tripId && tripId.startsWith('trip_');
  
  // Params harmonis√©s (departDate, days)
  const departDate = params.get('departDate') || params.get('depart') || params.get('departure') || params.get('startDate') || '';
  const requestedDays = parseInt(params.get('days') || params.get('nbDays') || '0', 10);
  
  console.log('%c[LOG-CONTROLE][MOBILE] ========== PARAMS PARS√âS ==========', 'background: #0066ff; color: white; font-size: 14px; padding: 4px 8px;');
  console.log('[LOG-CONTROLE][MOBILE] cc:', cc);
  console.log('[LOG-CONTROLE][MOBILE] itinId:', itinId);
  console.log('[LOG-CONTROLE][MOBILE] tripId:', tripId);
  console.log('[LOG-CONTROLE][MOBILE] departDate:', departDate);
  console.log('[LOG-CONTROLE][MOBILE] requestedDays:', requestedDays);
  console.log('[LOG-CONTROLE][MOBILE] fromTemp:', fromTemp);
  console.log('[LOG-CONTROLE][MOBILE] builderMode:', builderMode);
  console.log('[LOG-CONTROLE][MOBILE] dashboardMode:', dashboardMode);
  
  // === V√âRIFIER HANDOFF DEPUIS RT DETAIL ===
  // Si on vient d'une rotation depuis RT Detail, r√©cup√©rer le tripId du handoff
  const handoffTripId = localStorage.getItem('ORT_MOBILE_HANDOFF');
  const effectiveTripId = tripId || handoffTripId;
  const effectiveDashboardMode = effectiveTripId && (effectiveTripId.startsWith('trip_') || effectiveTripId.startsWith('user::'));
  
  debugLog('======= INIT MOBILE =======');
  debugLog('URL tripId: ' + tripId);
  debugLog('handoffTripId: ' + handoffTripId);
  debugLog('effectiveTripId: ' + effectiveTripId);
  debugLog('effectiveDashboardMode: ' + effectiveDashboardMode);
  debugLog('cc: ' + cc + ' / itinId: ' + itinId);
  debugLog('fromTemp: ' + fromTemp + ' / builderMode: ' + builderMode);
  
  if (handoffTripId) {
    console.log('[LOG-CONTROLE][MOBILE] üîÑ Handoff d√©tect√© depuis RT Detail:', handoffTripId);
    localStorage.removeItem('ORT_MOBILE_HANDOFF'); // Nettoyer apr√®s utilisation
  }
  
  // üî¥ DETECT NEW TRIP: tripId avec source (pas encore dans Firestore)
  // Si on a un tripId trip_xxx MAIS aussi des param√®tres source (cc+itin, from+rtKey, etc.)
  // ‚Üí C'est un NOUVEAU voyage, pas un voyage existant dans Firestore
  const hasSourceParams = (cc && itinId) || (fromTemp && rtKey) || builderMode;
  const isNewTrip = effectiveTripId && effectiveTripId.startsWith('trip_') && hasSourceParams;
  if (isNewTrip) {
    debugLog('üÜï Nouveau voyage d√©tect√© (tripId + source params)');
  }
  
  state.cc = cc;
  state.lang = lang;
  state.targetNights = requestedDays || 0; // Nombre de jours demand√©s depuis l'URL
  state.startDateStr = departDate || null; // Date de d√©part
  localStorage.setItem('ort_lang', lang);
  
  // INIT ORT_TRIPID - Source de v√©rit√© unique pour le tripId
  if (window.ORT_TRIPID) {
    state.tripId = window.ORT_TRIPID.init({ source: 'mobile' });
    console.log('[LOG-CONTROLE][MOBILE] TripId initialis√©:', state.tripId);
  }
  
  setupTabs();
  setupEvents();
  applyI18n(); // Appliquer les traductions
  
  try {
    debugLog('Mode s√©lectionn√©...');
    
    // üî¥ MODE PARTAG√â - Priorit√© absolue
    if (shareToken) {
      debugLog('‚Üí loadFromShare(' + shareToken + ')');
      await loadFromShare(shareToken, lang);
    } else if (fromBuilderResult) {
      debugLog('‚Üí loadBuilderResult');
      await loadBuilderResult();
    } else if (builderMode) {
      debugLog('‚Üí initRouteBuilder');
      await initRouteBuilder(params);
    } else if (effectiveDashboardMode && !isNewTrip) {
      // üî¥ ONLY load from dashboard if NOT a new trip with source params
      debugLog('‚Üí loadFromDashboard(' + effectiveTripId + ')');
      await loadFromDashboard(effectiveTripId);
      // üîí Marquer comme trip dashboard pour pr√©server les nuits
      state._isFromDashboard = true;
    } else if (fromTemp && rtKey) {
      debugLog('‚Üí loadFromTemp');
      await loadFromTemp(rtKey);
    } else if (rtKey) {
      debugLog('‚Üí loadFromFirebase');
      await loadFromFirebase(rtKey);
    } else if (cc && itinId) {
      debugLog('‚Üí loadItinerary');
      await loadItinerary(cc, itinId, lang);
    } else {
      debugLog('‚ùå Aucun mode correspondant!');
      throw new Error('Aucun itin√©raire sp√©cifi√©');
    }
    
    // Charger les noms multilingues pour tous les pays des steps
    const countriesToLoad = new Set();
    if (state.cc) countriesToLoad.add(state.cc.toUpperCase());
    if (state.steps && state.steps.length > 0) {
      state.steps.forEach(step => {
        let stepCC = step.cc;
        if (!stepCC && (step.place_id || step.placeId)) {
          const pid = step.place_id || step.placeId;
          if (pid.includes('::')) stepCC = pid.split('::')[0];
        }
        if (stepCC) countriesToLoad.add(stepCC.toUpperCase());
      });
    }
    
    for (const cc of countriesToLoad) {
      const namesPaths = [
        `./data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc.toLowerCase()}_names.json`,
        `./data/Roadtripsprefabriques/countries/${cc.toUpperCase()}/${cc.toLowerCase()}_names.json`,
        `./data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc.toUpperCase()}_names.json`,
        `./data/Roadtripsprefabriques/countries/${cc.toUpperCase()}/${cc.toUpperCase()}_names.json`
      ];
      for (const namesPath of namesPaths) {
        try {
          const namesResp = await fetch(namesPath);
          if (namesResp.ok) {
            const namesData = await namesResp.json();
            for (const [pid, data] of Object.entries(namesData)) {
              if (!CITY_NAMES_INDEX[pid]) CITY_NAMES_INDEX[pid] = data;
            }
            console.log(`[NAMES] ‚úÖ ${cc}: ${Object.keys(namesData).length} noms charg√©s`);
            break;
          }
        } catch (e) { /* next path */ }
      }
    }
    
    debugLog('Chargement termin√©! state.steps=' + state.steps.length);
    
    // === CALCUL AUTOMATIQUE DES NUITS - D√âPLAC√â AVANT RENDERLIST ===
    // Le calcul est maintenant fait imm√©diatement avant le rendu
    console.log('[LOG-CONTROLE][MOBILE] ‚ÑπÔ∏è Calcul nuits d√©j√† fait avant rendu');
    
    // üî¥ S'assurer que state.tripId est d√©fini (n√©cessaire pour partage/sauvegarde)
    if (!state.tripId) {
      state.tripId = window.ORT_TRIPID?.get() || effectiveTripId;
      debugLog('tripId r√©cup√©r√© apr√®s chargement: ' + state.tripId);
    }
    
    // === REGROUPEMENT DES NUITS PAR LIEU (centralis√© dans ort-trip-calc.js) ‚Äî sauf dashboard ===
    if (state.steps.length > 0 && window.ORT_TRIP_CALC && !state._isFromDashboard) {
      console.log('[LOG-CONTROLE][MOBILE] Appel ORT_TRIP_CALC.groupNightsByPlace...');
      ORT_TRIP_CALC.groupNightsByPlace(state.steps);
    }
    
    /* >>> ANCIEN CODE INLINE - COMMENT√â - √Ä SUPPRIMER <<<
    // === REGROUPEMENT DES NUITS PAR LIEU (comme RT detail) ===
    // Si plusieurs jours cons√©cutifs au m√™me place_id ‚Üí fusionner sur la premi√®re √©tape
    if (state.steps.length > 0) {
      console.log('[LOG-CONTROLE][MOBILE] === REGROUPEMENT DES NUITS PAR LIEU ===');
      let currentPlaceId = null;
      let currentGroupStart = 0;
      let currentGroupCount = 0;
      
      for (let i = 0; i <= state.steps.length; i++) {
        const step = state.steps[i];
        const placeId = step?.place_id || step?.placeId || `step_${i}`;
        
        if (i === state.steps.length || placeId !== currentPlaceId) {
          // Fin du groupe pr√©c√©dent
          if (currentGroupCount > 1 && currentPlaceId !== null) {
            let totalNights = 0;
            for (let j = currentGroupStart; j < currentGroupStart + currentGroupCount; j++) {
              totalNights += state.steps[j].nights || 0;
            }
            state.steps[currentGroupStart].nights = totalNights;
            state.steps[currentGroupStart]._isGroupHead = true;
            for (let j = currentGroupStart + 1; j < currentGroupStart + currentGroupCount; j++) {
              state.steps[j].nights = 0;
              state.steps[j]._isGroupMember = true;
            }
            console.log(`[LOG-CONTROLE][MOBILE] Groupe: ${state.steps[currentGroupStart].name} (${currentGroupCount} jours) ‚Üí ${totalNights} nuit(s)`);
          }
          if (i < state.steps.length) {
            currentPlaceId = placeId;
            currentGroupStart = i;
            currentGroupCount = 1;
          }
        } else {
          currentGroupCount++;
        }
      }
    }
    FIN ANCIEN CODE */
    
    // === CALCUL DES NUITS IMM√âDIAT (avant rendu) ‚Äî sauf si trip dashboard ===
    if (state._isFromDashboard) {
      console.log('[LOG-CONTROLE][MOBILE] üîí Skip calcul nuits - trip dashboard (nuits pr√©serv√©es)');
    } else if (state.steps.length > 0 && window.ORT_TRIP_CALC) {
      const target = state.targetNights || state.steps.reduce((s, st) => s + (st._suggestedDays || 1), 0) || state.steps.length;
      console.log('[LOG-CONTROLE][MOBILE] üöÄ Calcul nuits imm√©diat, target:', target);
      console.log('[LOG-CONTROLE][MOBILE] state.steps.length:', state.steps.length);
      ORT_TRIP_CALC.autoCalculateNights(state, target);
      console.log('[LOG-CONTROLE][MOBILE] ‚úÖ Nuits calcul√©es avant rendu');
    } else {
      console.log('[LOG-CONTROLE][MOBILE] ‚ö†Ô∏è Skip calcul nuits - steps:', state.steps.length, ', ORT_TRIP_CALC:', !!window.ORT_TRIP_CALC);
    }
    
    debugLog('Appel renderList...');
    renderList();
    debugLog('Appel renderBookings...');
    renderBookings();
    debugLog('Appel updateSummary...');
    updateSummary();
    debugLog('Appel initMap...');
    initMap();
    debugLog('‚úÖ RENDU TERMIN√â - ' + state.title);
    // Expose state for AI summary script
    window._ortState = state;
    
  } catch (err) {
    debugLog('‚ùå ERREUR: ' + err.message);
    console.error('[MOBILE] Error:', err);
    if (err.message !== 'Redirection en cours...') {
      showToast('‚ùå ' + (err.message || 'Erreur'));
      // Afficher message d'erreur au lieu de d√©mo
      state.title = '‚ùå Erreur';
      state.steps = [];
      renderList();
      renderBookings();
      updateSummary();
      initMap();
    }
  }
  
  setTimeout(() => $('loadingOverlay')?.classList.add('hide'), 300);
}

// === LOAD FROM SHARE (voyage partag√©) ===
async function loadFromShare(shareToken, lang) {
  console.log('[LOG-CONTROLE][MOBILE] üîó loadFromShare:', shareToken);
  
  // Attendre que ORT_SHARE soit disponible
  let waitCount = 0;
  while (typeof ORT_SHARE === 'undefined' && waitCount < 50) {
    await new Promise(r => setTimeout(r, 100));
    waitCount++;
  }
  
  if (typeof ORT_SHARE === 'undefined') {
    throw new Error('Module de partage non disponible');
  }
  
  try {
    const sharedData = await ORT_SHARE.checkSharedAccess();
    
    if (!sharedData || !sharedData.data) {
      throw new Error('Voyage partag√© non trouv√© ou expir√©');
    }
    
    console.log('[LOG-CONTROLE][MOBILE] ‚úÖ Voyage partag√© charg√©:', sharedData);
    
    // Stocker pour r√©f√©rence
    window._sharedTripData = sharedData;
    
    // Mode lecture seule
    document.body.classList.add('shared-view-only');
    
    // Charger les donn√©es dans state
    const tripData = sharedData.data;
    state.title = tripData.title || 'Voyage partag√©';
    state.cc = tripData.country || tripData.cc || '';
    state.steps = tripData.steps || [];
    state.lang = lang;
    state._isShared = true; // Marquer comme partag√©
    state._shareToken = shareToken;
    
    // === Restaurer TOUTES les m√©tadonn√©es ===
    if (tripData.targetNights) state.targetNights = tripData.targetNights;
    if (tripData.initialNights) state.initialNights = tripData.initialNights;
    if (tripData.startDateStr) state.startDateStr = tripData.startDateStr;
    if (tripData._stepGroups) state._stepGroups = tripData._stepGroups;
    if (tripData._itinRef) state._itinRef = tripData._itinRef;
    if (tripData.travelBookings) state.travelBookings = tripData.travelBookings;
    
    // üîí BLOQUER tout recalcul auto
    window._autoCalcNightsDone = true;
    window._autoCalcDone = true;
    state._isFromDashboard = true;
    
    // Restaurer bookings dans globalBookingManager
    if (typeof globalBookingManager !== 'undefined' && globalBookingManager) {
      tripData.steps.forEach((step, idx) => {
        if (step.bookings && Array.isArray(step.bookings) && step.bookings.length > 0) {
          step.bookings.forEach(b => globalBookingManager.addBooking(idx, b));
        }
      });
    }
    
    console.log('[LOG-CONTROLE][MOBILE] ‚úÖ State complet restaur√©:', state.steps.length, '√©tapes,', state.targetNights, 'nuits');
    
    // Afficher banner de lecture seule
    const banner = document.createElement('div');
    banner.id = 'shareBanner';
    banner.style.cssText = `
      position: fixed; top: 56px; left: 0; right: 0;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
      color: white; padding: 10px 16px; 
      text-align: center; z-index: 99; font-weight: 600;
      font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    `;
    const ownerName = sharedData.ownerName || 'Un voyageur';
    banner.innerHTML = `üëÅÔ∏è Voyage partag√© par <strong>${ownerName}</strong> ‚Ä¢ Mode lecture seule`;
    document.body.appendChild(banner);
    
    // Ajuster le contenu principal
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
      mainContent.style.top = 'calc(var(--header-height) + 44px)';
    }
    
    console.log('[LOG-CONTROLE][MOBILE] ‚úÖ State charg√©:', state.steps.length, '√©tapes');
    
  } catch (error) {
    console.error('[MOBILE] ‚ùå Erreur chargement partage:', error);
    throw new Error('Impossible de charger le voyage partag√©: ' + error.message);
  }
}

// === LOAD FROM TEMP (localStorage) ===
async function loadFromTemp(rtKey) {
  console.log('%c[LOG-CONTROLE][MOBILE] ========== LOAD FROM TEMP ==========', 'background: #006699; color: white; font-size: 14px; padding: 4px 8px;');
  console.log('[LOG-CONTROLE][MOBILE] rtKey:', rtKey);
  
  const rawItins = localStorage.getItem(`ORT_TEMP_TRIP_${rtKey}_itins`);
  const rawPlaces = localStorage.getItem(`ORT_TEMP_TRIP_${rtKey}_places`);
  
  console.log('[LOG-CONTROLE][MOBILE] rawItins trouv√©:', !!rawItins, rawItins ? `(${rawItins.length} chars)` : '');
  console.log('[LOG-CONTROLE][MOBILE] rawPlaces trouv√©:', !!rawPlaces, rawPlaces ? `(${rawPlaces.length} chars)` : '');
  
  if (!rawItins) throw new Error('Itin√©raire temporaire non trouv√©');
  
  let itinsObj, placesObj;
  try {
    itinsObj = JSON.parse(rawItins);
    placesObj = rawPlaces ? JSON.parse(rawPlaces) : {};
  } catch (e) {
    throw new Error('Donn√©es corrompues');
  }
  
  // Trouver l'itin√©raire √† utiliser
  let toUse = null;
  if (Array.isArray(itinsObj.days_plan) || Array.isArray(itinsObj.places)) {
    toUse = itinsObj;
  } else if (itinsObj.itineraries?.[0]) {
    toUse = itinsObj.itineraries[0];
  } else if (itinsObj.itins?.[0]) {
    toUse = itinsObj.itins[0];
  }
  
  if (!toUse) throw new Error('Structure itin√©raire invalide');
  
  // Extraire les √©tapes
  const rawSteps = toUse.days_plan || toUse.places || toUse.steps || [];
  state.title = toUse.title || toUse.name || 'Roadtrip';
  state.cc = toUse.itin_id ? toUse.itin_id.split('::')[0].toUpperCase() : (itinsObj.country || 'XX');
  state._originalItinId = rtKey;
  
  state.steps = rawSteps.map((s, idx) => {
    let photos = [];
    if (Array.isArray(s.images) && s.images.length) photos = s.images;
    else if (Array.isArray(s.photos) && s.photos.length) photos = s.photos;
    else if (s.image) photos = [s.image];
    else if (s.photo) photos = [s.photo];
    else if (s.placeId && placesObj[s.placeId]?.photos) photos = placesObj[s.placeId].photos;
    
    // R√©cup√©rer visits et activities
    let visits = [];
    let activities = [];
    if (Array.isArray(s.visits)) {
      visits = s.visits.map(v => typeof v === 'string' ? {text: v} : v);
    }
    if (Array.isArray(s.activities)) {
      activities = s.activities.map(a => typeof a === 'string' ? {text: a} : a);
    }
    // Fallback depuis placesObj si disponible
    if (visits.length === 0 && s.placeId && placesObj[s.placeId]?.visits) {
      visits = placesObj[s.placeId].visits.map(v => typeof v === 'string' ? {text: v} : v);
    }
    if (activities.length === 0 && s.placeId && placesObj[s.placeId]?.activities) {
      activities = placesObj[s.placeId].activities.map(a => typeof a === 'string' ? {text: a} : a);
    }
    
    // Extraire les coordonn√©es (plusieurs formats possibles)
    let lat = s.lat || s.latitude;
    let lng = s.lng || s.lon || s.longitude;
    // Format itin√©raire ORT: night.coords = [lat, lon]
    if (!lat && !lng && s.night?.coords && Array.isArray(s.night.coords)) {
      lat = s.night.coords[0];
      lng = s.night.coords[1];
    }
    // Fallback depuis placesObj
    if (!lat && !lng && s.night?.place_id && placesObj[s.night.place_id]?.coords) {
      const pCoords = placesObj[s.night.place_id].coords;
      if (Array.isArray(pCoords)) {
        lat = pCoords[0];
        lng = pCoords[1];
      }
    }
    
    // Nom de l'√©tape : depuis night.place_id ou name
    let stepName = s.name || s.place_name;
    if (!stepName && s.night?.place_id) {
      // Extraire le nom du place_id (ex: "LA::luang_prabang" ‚Üí "Luang Prabang")
      const placeSlug = s.night.place_id.split('::').pop() || '';
      stepName = placeSlug.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }
    if (!stepName) stepName = `√âtape ${idx + 1}`;
    
    return {
      _idx: idx,
      name: stepName,
      lat: lat,
      lng: lng,
      nights: s.nights || s.suggested_days || s.adjustedDays || 0,
      description: s.description || s.desc || '',
      photos: photos,
      distance_km: s.distance_km || s.to_next_leg?.distance_km || 0,
      placeId: s.placeId || s.place_id || s.night?.place_id || null,
      place_id: s.place_id || s.placeId || s.night?.place_id || null,
      visits: visits,
      activities: activities,
      // Conserver les infos enrichies
      to_next_leg: s.to_next_leg || null,
      suggested_days: s.suggested_days || null,
      _mapKeywords: Array.isArray(s.night?.map_keywords) ? s.night.map_keywords : []
    };
  });
  
  console.log('[LOG-CONTROLE][MOBILE] ========== √âTAT APR√àS LOAD FROM TEMP ==========');
  console.log(`[LOG-CONTROLE][MOBILE] ${state.steps.length} √©tapes charg√©es`);
  console.log('[LOG-CONTROLE][MOBILE] state.title:', state.title);
  console.log('[LOG-CONTROLE][MOBILE] state.cc:', state.cc);
  console.log('[LOG-CONTROLE][MOBILE] state.targetNights:', state.targetNights);
  console.log('[LOG-CONTROLE][MOBILE] √âtapes:');
  state.steps.forEach((s, i) => {
    console.log(`[LOG-CONTROLE][MOBILE]   ${i}: ${s.name} - ${s.nights} nuit(s) - coords: [${s.lat}, ${s.lng}] - visits: ${s.visits?.length || 0} - activities: ${s.activities?.length || 0}`);
  });
  
  // Charger les visites et activit√©s des places depuis le master
  if (state.cc) {
    await ensurePlacesIndex([state.cc]);
  }
}

// === LOAD FROM DASHBOARD (Firestore users/{uid}/trips/{tripId}) ===
async function loadFromDashboard(tripId) {
  debugLog('======= loadFromDashboard =======');
  debugLog('tripId: ' + tripId);
  debugLog('URL: ' + location.href);
  
  // === ESSAYER D'ABORD LOCALSTORAGE (rapide, fonctionne offline) ===
  const localKey = `ort_trip_${tripId}`;
  const localData = localStorage.getItem(localKey);
  debugLog('localStorage key: ' + localKey);
  debugLog('localStorage existe: ' + (!!localData));
  
  if (localData) {
    try {
      const tripData = JSON.parse(localData);
      debugLog('localStorage parsed: ' + tripData?.title + ' / ' + tripData?.steps?.length + ' √©tapes');
      if (tripData && tripData.steps && tripData.steps.length > 0) {
        debugLog('‚úÖ Charg√© depuis localStorage!');
        await applyTripDataToState(tripData);
        
        // IMPORTANT: Charger aussi ORT_TRIP_DATA pour les bookings (stock√©s s√©par√©ment)
        if (window.ORT_TRIP_DATA) {
          try {
            debugLog('üì• Chargement ORT_TRIP_DATA pour les bookings...');
            await window.ORT_TRIP_DATA.loadTrip(tripId);
            debugLog('‚úÖ ORT_TRIP_DATA charg√© (bookings disponibles)');
          } catch (e) {
            debugLog('‚ö†Ô∏è ORT_TRIP_DATA: ' + e.message);
          }
        }
        
        return; // Succ√®s !
      } else {
        debugLog('‚ö†Ô∏è localStorage steps vide/invalide');
      }
    } catch (e) {
      debugLog('‚ùå Erreur parsing localStorage: ' + e.message);
    }
  }
  
  // === SINON ESSAYER FIRESTORE ===
  debugLog('üì• Tentative Firestore...');
  debugLog('firebase d√©fini: ' + (typeof firebase !== 'undefined'));
  debugLog('ORT_CONFIG d√©fini: ' + (!!window.ORT_CONFIG));
  
  // Attendre que Firebase soit charg√© et initialis√©
  let waitCount = 0;
  while (typeof firebase === 'undefined' || !firebase.apps) {
    await new Promise(r => setTimeout(r, 100));
    waitCount++;
    if (waitCount > 50) {
      debugLog('‚ùå Firebase jamais charg√© apr√®s 5s');
      throw new Error('Firebase non disponible');
    }
  }
  debugLog('Firebase apps.length: ' + firebase.apps.length);
  
  // Initialiser Firebase si pas encore fait
  if (!firebase.apps.length) {
    const host = location.hostname;
    const isPreprod = /oneroadtrip-preprod|localhost|127\.0\.0\.1|0\.0\.0\.0|test-oneroadtrip/.test(host);
    debugLog('Host: ' + host + ' isPreprod: ' + isPreprod);
    
    const cfg = isPreprod ? (window.ORT_CONFIG?.PREPROD || {}) : (window.ORT_CONFIG?.PROD || {});
    const safe = (cfg && cfg.apiKey) ? cfg : (window.ORT_CONFIG?.PREPROD || {});
    debugLog('Config apiKey: ' + (!!safe?.apiKey));
    
    if (safe && safe.apiKey) {
      firebase.initializeApp(safe);
      debugLog('‚úÖ Firebase initialis√©');
    } else {
      debugLog('‚ùå Pas de config Firebase!');
      throw new Error('Config Firebase manquante');
    }
  }
  
  // Attendre firebase.auth
  debugLog('firebase.auth dispo: ' + (!!firebase.auth));
  waitCount = 0;
  while (!firebase.auth) {
    await new Promise(r => setTimeout(r, 100));
    waitCount++;
    if (waitCount > 30) {
      debugLog('‚ùå firebase.auth jamais dispo');
      throw new Error('Firebase Auth non disponible');
    }
  }
  
  // === ATTENDRE L'UTILISATEUR ===
  // L'auth est probablement d√©j√† faite dans l'init, v√©rifier d'abord currentUser
  let user = firebase.auth().currentUser;
  if (!user) {
    debugLog('‚è≥ Pas de currentUser, attente auth...');
    user = await new Promise((resolve) => {
      const unsubscribe = firebase.auth().onAuthStateChanged((u) => {
        debugLog('Auth re√ßu: ' + (u?.email || 'non connect√©'));
        unsubscribe();
        resolve(u);
      });
      setTimeout(() => {
        debugLog('‚ö†Ô∏è Timeout auth 3s');
        unsubscribe();
        resolve(null);
      }, 3000); // R√©duit √† 3s
    });
  } else {
    debugLog('‚úÖ currentUser d√©j√† pr√©sent: ' + user.email);
  }
  
  if (!user) {
    debugLog('‚ùå Non connect√©!');
    throw new Error('Connectez-vous pour voir ce voyage');
  }
  
  // === CHARGER DEPUIS FIRESTORE ===
  debugLog('üì• Firestore: users/' + user.uid + '/trips/' + tripId);
  
  try {
    // M√âTHODE 1: Utiliser ORT_STATE qui d√©s√©rialise correctement
    if (window.ORT_STATE) {
      debugLog('Tentative via ORT_STATE...');
      const trip = await window.ORT_STATE.getTrip(tripId);
      if (trip && trip.steps && trip.steps.length > 0) {
        debugLog('‚úÖ ORT_STATE: ' + trip.title + ' / ' + trip.steps.length + ' steps');
        await applyTripDataToState(trip);
        
        // Charger aussi ORT_TRIP_DATA pour les bookings
        if (window.ORT_TRIP_DATA) {
          try {
            await window.ORT_TRIP_DATA.loadTrip(tripId);
            debugLog('‚úÖ ORT_TRIP_DATA charg√©');
          } catch (e) {
            debugLog('‚ö†Ô∏è ORT_TRIP_DATA: ' + e.message);
          }
        }
        
        // Cache localStorage
        localStorage.setItem(localKey, JSON.stringify(trip));
        debugLog('üíæ Mis en cache localStorage');
        return;
      }
    }
    
    // M√âTHODE 2: Fallback direct Firestore avec d√©s√©rialisation manuelle
    debugLog('Fallback: lecture Firestore directe...');
    const db = firebase.firestore();
    const tripRef = db.collection('users').doc(user.uid).collection('trips').doc(tripId);
    const tripDoc = await tripRef.get();
    debugLog('Doc exists: ' + tripDoc.exists);
    
    if (!tripDoc.exists) {
      debugLog('‚ùå Doc non trouv√© dans Firestore');
      throw new Error('Voyage non trouv√©');
    }
    
    const tripData = tripDoc.data();
    debugLog('üìÑ Firestore brut: ' + tripData?.title);
    
    // D√©s√©rialiser les steps si c'est une string JSON
    if (tripData.steps && typeof tripData.steps === 'string') {
      try {
        tripData.steps = JSON.parse(tripData.steps);
        debugLog('üîì Steps d√©s√©rialis√©s: ' + tripData.steps.length);
      } catch (e) {
        debugLog('‚ùå Erreur d√©s√©rialisation steps');
      }
    }
    
    debugLog('Steps apr√®s d√©s√©rialisation: ' + (tripData.steps?.length || 0));
    await applyTripDataToState(tripData);
    
    // Charger ORT_TRIP_DATA pour les bookings
    if (window.ORT_TRIP_DATA) {
      try {
        await window.ORT_TRIP_DATA.loadTrip(tripId);
        debugLog('‚úÖ ORT_TRIP_DATA charg√©');
        // Debug: v√©rifier les bookings par √©tape
        state.steps.forEach((s, i) => {
          const bookings = ORT_TRIP_DATA.getStepBookings(i) || [];
          if (bookings.length > 0) {
            console.log(`[BOOKING-DEBUG] √âtape ${i+1} (${s.name}): ${bookings.length} r√©sa(s)`, bookings.map(b => b.name));
          }
        });
      } catch (e) {
        debugLog('‚ö†Ô∏è ORT_TRIP_DATA: ' + e.message);
      }
    }
    
    // Cache localStorage
    localStorage.setItem(localKey, JSON.stringify(tripData));
    debugLog('üíæ Mis en cache localStorage');
    
  } catch (e) {
    debugLog('‚ùå Erreur: ' + e.message);
    throw e;
  }
  
  debugLog('======= FIN loadFromDashboard =======');
}

// Applique les donn√©es du trip au state
async function applyTripDataToState(tripData) {
  debugLog('applyTripDataToState: ' + tripData?.title + ' / ' + tripData?.steps?.length + ' steps');
  
  // DEBUG: Afficher les visites des steps bruts
  if (tripData?.steps) {
    tripData.steps.forEach((s, i) => {
      if (s.visits?.length || s.pois?.length) {
        debugLog(`Step ${i} (${s.name}): ${s.visits?.length || 0} visits, ${s.pois?.length || 0} pois`);
      }
    });
  }
  
  state.title = tripData.title || tripData.name || 'Roadtrip';
  state.cc = tripData.country || tripData.cc || 'XX';
  state.tripId = tripData.id || tripData.tripId;
  state._originalItinId = tripData.itinId || tripData._originalItinId;
  state.startDateStr = tripData.startDateStr || tripData.startDate || '';
  
  // Convertir les steps
  const rawSteps = tripData.steps || [];
  state.steps = rawSteps.map((s, idx) => {
    // Photos
    let photos = [];
    if (Array.isArray(s.photos) && s.photos.length) photos = s.photos;
    else if (Array.isArray(s.images) && s.images.length) photos = s.images;
    else if (s.photo) photos = [s.photo];
    else if (s.image) photos = [s.image];
    
    return {
      _idx: idx,
      name: s.name || s.place_name || `√âtape ${idx + 1}`,
      lat: s.lat || s.latitude,
      lng: s.lng || s.lon || s.longitude,
      nights: Number(s.nights) || 0,
      description: s.description || s.desc || '',
      photos: photos,
      distance_km: s.distance_km || s.to_next_leg?.distance_km || s._distanceKmToNext || 0,
      drive_min: s.drive_min || s.to_next_leg?.drive_min || s._driveMinToNext || 0,
      placeId: s.placeId || s.place_id || null,
      visits: s.visits || s.pois || [],
      activities: s.activities || [],
      _mapKeywords: Array.isArray(s._mapKeywords) ? s._mapKeywords : (Array.isArray(s.night?.map_keywords) ? s.night.map_keywords : [])
    };
  });
  
  debugLog('‚úÖ state.steps = ' + state.steps.length);
  
  // Charger les visites et activit√©s des places depuis le master si vides
  if (state.cc) {
    debugLog('üîÑ Chargement PLACES_INDEX pour ' + state.cc);
    await ensurePlacesIndex([state.cc]);
    debugLog('‚úÖ PLACES_INDEX charg√©: ' + Object.keys(PLACES_INDEX || {}).length + ' places');
  }
  
  // Budget si pr√©sent
  if (tripData.totalBudget) {
    state.totalBudget = tripData.totalBudget;
  }
}

// === ROUTE BUILDER ===
// haversineDistance() ‚Üí fourni par ort-utils.js

async function initRouteBuilder(params) {
  console.log('[MOBILE-BUILDER] Redirection vers RT Detail pour calcul...');
  
  // Construire l'URL vers RT Detail avec returnTo=mobile
  const newParams = new URLSearchParams(params);
  newParams.set('returnTo', 'mobile');
  
  // Rediriger vers RT Detail qui fera le calcul
  const url = `roadtrip_detail.html?${newParams.toString()}`;
  console.log('[MOBILE-BUILDER] Redirect:', url);
  
  showToast('üîÑ Calcul de l\'itin√©raire...');
  
  // Petit d√©lai pour voir le toast
  setTimeout(() => {
    window.location.href = url;
  }, 500);
  
  // Ne jamais arriver ici, mais au cas o√π
  throw new Error('Redirection en cours...');
}

// Charger le r√©sultat du builder depuis localStorage
async function loadBuilderResult() {
  console.log('[LOG-CONTROLE][MOBILE] Chargement r√©sultat builder...');
  
  const raw = localStorage.getItem('ORT_BUILDER_RESULT');
  if (!raw) throw new Error('R√©sultat builder non trouv√©');
  
  const data = JSON.parse(raw);
  if (!data || !data.steps?.length) throw new Error('Donn√©es builder invalides');
  
  state.title = data.title || 'Roadtrip';
  state.cc = data.cc || 'XX';
  state._fromBuilder = true;
  
  state.steps = data.steps.map((s, idx) => {
    // R√©cup√©rer photos
    let photos = s.images || s.photos || [];
    if (!photos.length && s.name) {
      photos = findPhotosForPlace(s.name, s.cc || state.cc);
    }
    
    return {
      _idx: idx,
      name: s.name,
      lat: s.lat,
      lng: s.lng || s.lon,
      nights: s.nights || 0,
      description: s.description || '',
      photos: photos,
      distance_km: s.distance_km || s.to_next_leg?.distance_km || 0,
      placeId: s.place_id || null,
      visits: s.visits || [],
      activities: s.activities || [],
      _mapKeywords: Array.isArray(s._mapKeywords) ? s._mapKeywords : (Array.isArray(s.night?.map_keywords) ? s.night.map_keywords : [])
    };
  });
  
  // === RESTAURER LES R√âSERVATIONS ===
  if (data.bookings && typeof globalMobileBookingManager !== 'undefined' && globalMobileBookingManager) {
    state.bookings = data.bookings;
    
    // Charger dans le gestionnaire de r√©servations mobile
    Object.entries(data.bookings).forEach(([stepIdx, bookings]) => {
      if (Array.isArray(bookings)) {
        bookings.forEach(booking => {
          globalMobileBookingManager.addBooking(booking);
        });
      }
    });
    
    console.log('[LOG-CONTROLE][MOBILE] ‚úÖ R√©servations restaur√©es:', Object.keys(data.bookings).length, '√©tapes');
  }
  
  console.log(`[LOG-CONTROLE][MOBILE] Builder result: ${state.steps.length} √©tapes`);
  
  // Nettoyer localStorage
  localStorage.removeItem('ORT_BUILDER_RESULT');
}

// calculateOSRMRoute() ‚Üí fourni par ort-routing.js
// Note: ort-routing.js accepte les deux formats: (waypoints, mode) et ({lat,lon}, {lat,lon})

async function loadPlacesForRoute(config, routeData) {
  const SEARCH_RADIUS = 50; // km
  const countries = new Set();
  if (config.start.cc) countries.add(config.start.cc);
  if (config.end.cc) countries.add(config.end.cc);
  
  // D√©tecter pays travers√©s via bbox
  const COUNTRY_BBOX = {
    'FR': { minLat: 41, maxLat: 51.5, minLon: -5.5, maxLon: 10 },
    'ES': { minLat: 35.5, maxLat: 44, minLon: -10, maxLon: 5 },
    'PT': { minLat: 36.5, maxLat: 42.5, minLon: -10, maxLon: -6 },
    'IT': { minLat: 35.5, maxLat: 47.5, minLon: 6, maxLon: 19 },
    'CH': { minLat: 45.5, maxLat: 48, minLon: 5.5, maxLon: 10.5 },
    'DE': { minLat: 47, maxLat: 55.5, minLon: 5.5, maxLon: 15.5 },
    'BE': { minLat: 49.5, maxLat: 51.5, minLon: 2.5, maxLon: 6.5 },
    'NL': { minLat: 50.5, maxLat: 53.5, minLon: 3, maxLon: 7.5 },
    'AT': { minLat: 46.5, maxLat: 49, minLon: 9.5, maxLon: 17 },
    'PL': { minLat: 49, maxLat: 55, minLon: 14, maxLon: 24 }
  };
  
  for (const [lat, lon] of routeData.coords) {
    for (const [cc, bbox] of Object.entries(COUNTRY_BBOX)) {
      if (lat >= bbox.minLat && lat <= bbox.maxLat && lon >= bbox.minLon && lon <= bbox.maxLon) {
        countries.add(cc);
      }
    }
  }
  
  console.log('[MOBILE-BUILDER] Pays:', Array.from(countries).join(', '));
  
  // Charger les places de chaque pays
  const allPlaces = {};
  const lang = state.lang || 'fr';
  
  for (const cc of countries) {
    try {
      const url = `./data/places-json/${cc.toLowerCase()}.places-${lang}.json`;
      const resp = await fetch(url);
      if (!resp.ok) continue;
      const data = await resp.json();
      
      const placesArray = data.places || data;
      for (const p of placesArray) {
        if (!p.lat || !p.lng && !p.lon) continue;
        const plat = p.lat;
        const plon = p.lng || p.lon;
        
        // V√©rifier si proche de la route
        let minDist = Infinity;
        for (const [rlat, rlon] of routeData.coords) {
          const d = haversineDistance(plat, plon, rlat, rlon);
          if (d < minDist) minDist = d;
        }
        
        if (minDist <= SEARCH_RADIUS) {
          const slug = toSlug(p.name);
          const id = p.place_id || `${cc}::${slug}`;
          
          // R√©cup√©rer photos du cache
          let photos = p.photos || (p.photo ? [p.photo] : []);
          if (!photos.length) {
            photos = findPhotosForPlace(p.name, cc);
          }
          
          allPlaces[id] = { ...p, lat: plat, lng: plon, _distToRoute: minDist, cc, photos, placeId: id };
        }
      }
    } catch (e) {
      console.warn(`[MOBILE-BUILDER] Failed to load ${cc}:`, e);
    }
  }
  
  return allPlaces;
}

function selectStepsAlongRoute(config, routeData, places) {
  const totalDist = routeData.distance;
  const targetSteps = Math.max(2, Math.ceil(totalDist / config.maxKm));
  const stepDist = totalDist / targetSteps;
  
  console.log(`[MOBILE-BUILDER] Target: ${targetSteps} √©tapes, ~${Math.round(stepDist)}km entre chaque`);
  
  // Ajouter d√©part avec recherche de photos
  const startPhotos = findPhotosForPlace(config.start.name, config.start.cc);
  const steps = [{
    name: config.start.name,
    lat: config.start.lat,
    lng: config.start.lon,
    nights: 1,
    description: 'Point de d√©part',
    photos: startPhotos,
    placeId: `${config.start.cc}::${toSlug(config.start.name)}`,
    _progress: 0,
    _isEndpoint: true
  }];
  
  // Convertir places en array avec progress
  const placesList = Object.values(places).map(p => {
    // Calculer progress sur la route
    let bestProgress = 0;
    let minDist = Infinity;
    for (let i = 0; i < routeData.coords.length; i++) {
      const d = haversineDistance(p.lat, p.lng, routeData.coords[i][0], routeData.coords[i][1]);
      if (d < minDist) {
        minDist = d;
        bestProgress = routeData.cumDist[i] / totalDist;
      }
    }
    return { ...p, _progress: bestProgress };
  });
  
  // S√©lectionner √©tapes interm√©diaires
  for (let i = 1; i < targetSteps; i++) {
    const targetProgress = i / targetSteps;
    
    // Trouver le meilleur candidat
    let best = null;
    let bestScore = -Infinity;
    
    for (const p of placesList) {
      // D√©j√† utilis√© ?
      if (steps.some(s => s.name === p.name)) continue;
      
      const progressDiff = Math.abs(p._progress - targetProgress);
      if (progressDiff > 0.3) continue; // Trop loin du target
      
      // Score bas√© sur: proximit√© du target progress + rating + faible d√©tour
      const score = (1 - progressDiff * 3) * 50 + 
                    (p.global_rating || p.rating || 3) * 10 -
                    (p._distToRoute || 0) * 0.5;
      
      if (score > bestScore) {
        bestScore = score;
        best = p;
      }
    }
    
    if (best) {
      // R√©cup√©rer photos du cache
      const placeId = best.placeId || best.place_id || `${best.cc}::${toSlug(best.name)}`;
      let photos = best.photos || [];
      
      // Chercher dans PHOTOS_CACHE si pas de photos
      if (!photos.length) {
        photos = findPhotosForPlace(best.name, best.cc);
      }
      
      steps.push({
        name: best.name || best.place_name,
        lat: best.lat,
        lng: best.lng,
        nights: 1,
        description: best.description || best.desc || '',
        photos: photos,
        placeId: placeId,
        _progress: best._progress
      });
    }
  }
  
  // Ajouter arriv√©e avec recherche de photos
  const endPhotos = findPhotosForPlace(config.end.name, config.end.cc);
  steps.push({
    name: config.end.name,
    lat: config.end.lat,
    lng: config.end.lon,
    nights: 1,
    description: 'Point d\'arriv√©e',
    photos: endPhotos,
    placeId: `${config.end.cc}::${toSlug(config.end.name)}`,
    _progress: 1,
    _isEndpoint: true
  });
  
  // Trier par progress
  steps.sort((a, b) => a._progress - b._progress);
  
  // Calculer distances entre √©tapes
  for (let i = 0; i < steps.length - 1; i++) {
    steps[i].distance_km = Math.round(haversineDistance(
      steps[i].lat, steps[i].lng,
      steps[i+1].lat, steps[i+1].lng
    ));
  }
  steps[steps.length - 1].distance_km = 0;
  
  return steps;
}

// >>> EXTERNALIS√â dans /js/ort-trip-calc.js <<<
/* ANCIEN CODE - COMMENT√â POUR RETOUR ARRI√àRE
function autoCalculateNights(totalDays) {
  if (!state.steps.length) return;
  
  const total = totalDays || 7;
  const perStep = Math.floor(total / state.steps.length);
  let remaining = total - perStep * state.steps.length;
  
  state.steps.forEach((s, i) => {
    s.nights = perStep + (i < remaining ? 1 : 0);
  });
  
  // Derni√®re √©tape = 0 nuit (fin du voyage)
  if (state.steps.length > 1) {
    state.steps[state.steps.length - 1].nights = 0;
  }
}
FIN autoCalculateNights */

// === DATA LOADING ===
// isComposedId() et parseComposedIds() ‚Üí fournis par ort-utils.js

// === LOAD ITINERARY - UTILISE ORT_DATA_LOADER CENTRALIS√â ===
async function loadItinerary(cc, itinId, lang) {
  console.log('[LOG-CONTROLE][MOBILE] === loadItinerary via ORT_DATA_LOADER ===');
  
  if (!window.ORT_DATA_LOADER) {
    throw new Error('ORT_DATA_LOADER non disponible');
  }
  
  const result = await ORT_DATA_LOADER.loadItinerary({ cc, itinId, lang });
  
  // Appliquer au state
  state.title = result.title;
  state.cc = result.cc;
  state._originalItinId = result.originalItinId;
  state.steps = result.steps;
  
  console.log(`[LOG-CONTROLE][MOBILE] ‚úÖ ${state.steps.length} √©tapes charg√©es via ORT_DATA_LOADER`);
  state.steps.forEach((s, i) => {
    console.log(`[LOG-CONTROLE][MOBILE]   ${i}: ${s.name} - ${s.nights} nuit(s)`);
  });
}

/* >>> ANCIEN CODE loadItinerary - COMMENT√â - √Ä SUPPRIMER <<<
async function loadItinerary_OLD(cc, itinId, lang) {
  console.log('%c[LOG-CONTROLE][MOBILE] ========== LOAD ITINERARY ==========', 'background: #006699; color: white; font-size: 14px; padding: 4px 8px;');
  console.log('[LOG-CONTROLE][MOBILE] cc:', cc);
  console.log('[LOG-CONTROLE][MOBILE] itinId:', itinId);
  console.log('[LOG-CONTROLE][MOBILE] lang:', lang);
  console.log('[LOG-CONTROLE][MOBILE] isComposedId:', isComposedId(itinId));
  
  const baseUrl = './data/Roadtripsprefabriques/countries';
  
  // === TRAITER COMPOSED ===
  if (isComposedId(itinId)) {
    const ids = parseComposedIds(itinId);
    const allSteps = [];
    const allTitles = [];
    
    // Charger chaque itin√©raire depuis son pays
    for (const id of ids) {
      try {
        // Parser l'ID pour extraire le pays si pr√©sent (format: CC::slug ou juste slug/id)
        let ccForItin = cc;
        let idToSearch = id;
        
        if (id.includes('::')) {
          const parts = id.split('::');
          ccForItin = parts[0];
          idToSearch = parts.slice(1).join('::');
        }
        
        const ccLower = ccForItin.toLowerCase();
        const url = `${baseUrl}/${ccLower}/${ccLower}.itins.modules-${lang}.json`;
        
        const resp = await fetch(url);
        if (!resp.ok) continue;
        
        const data = await resp.json();
        const itins = data.itins || data.itineraries || data || [];
        const itin = itins.find(i => {
          const checkId = i.id || i.itin_id || '';
          return checkId === idToSearch || checkId === id;
        });
        
        if (!itin) continue;
        
        allTitles.push(itin.title || itin.name || 'RT');
        
        const daysPlan = itin.days_plan || itin.steps || [];
        daysPlan.forEach((day, idx) => {
          const nightData = day.night || {};
          const placeId = nightData.place_id || day.place_id || '';
          const coords = nightData.coords || [];
          const suggestedDays = day.suggested_days || 1;
          const driveMin = day.to_next_leg?.drive_min || 0;
          const distanceKm = day.to_next_leg?.distance_km || 0;
          
          let transportBonus = driveMin > 300 ? 1.0 : driveMin > 180 ? 0.5 : 0;
          const nights = Math.max(0, Math.round(suggestedDays + transportBonus));
          
          let name = day.name || '';
          if (!name && placeId) {
            const parts = placeId.split('::');
            name = parts[parts.length - 1]?.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || `√âtape ${idx + 1}`;
          }
          
          const visits = Array.isArray(day.visits) ? day.visits.map(v => typeof v === 'string' ? {text: v} : v) : [];
          const activities = Array.isArray(day.activities) ? day.activities.map(a => typeof a === 'string' ? {text: a} : a) : [];
          const description = visits.map(v => v.text || v).filter(Boolean).join(' ');
          
          let photos = [];
          if (Array.isArray(day.photos) && day.photos.length) photos = day.photos;
          else if (Array.isArray(day.images) && day.images.length) photos = day.images;
          else if (typeof day.image === 'string' && day.image) photos = [day.image];
          else if (typeof day.photo === 'string' && day.photo) photos = [day.photo];
          else if (typeof day.thumb === 'string' && day.thumb) photos = [day.thumb];
          
          allSteps.push({
            _idx: allSteps.length,
            name: name || `√âtape ${idx + 1}`,
            lat: coords[0] || day.lat,
            lng: coords[1] || day.lng || day.lon,
            nights, description,
            photos: photos,
            distance_km: distanceKm,
            placeId: day.place_id || day.placeId || placeId,
            place_id: day.place_id || day.placeId || placeId,
            visits: visits,
            activities: activities,
            _mapKeywords: Array.isArray(nightData.map_keywords) ? nightData.map_keywords : []
          });
        });
      } catch (e) {
        console.error(`[COMPOSED] Erreur chargement ${id}:`, e);
      }
    }
    
    if (allSteps.length === 0) throw new Error('Aucun itin√©raire compos√© n\'a pu √™tre charg√©');
    
    state.title = allTitles.join(' + ');
    state._originalItinId = itinId;
    state.cc = cc;
    state.steps = allSteps;
    return;
  }
  
  // === CAS NORMAL: UN SEUL ITIN√âRAIRE ===
  const ccLower = cc.toLowerCase();
  const url = `${baseUrl}/${ccLower}/${ccLower}.itins.modules-${lang}.json`;
  
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  
  const data = await resp.json();
  const itins = data.itins || data.itineraries || data || [];
  const itin = itins.find(i => (i.id || i.itin_id) === itinId);
  if (!itin) throw new Error('Itin√©raire non trouv√©');
  
  state.title = itin.title || itin.name || 'Roadtrip';
  state._originalItinId = itinId;
  state.cc = cc;
  
  const steps = [];
  const daysPlan = itin.days_plan || itin.steps || [];
  
  daysPlan.forEach((day, idx) => {
    const nightData = day.night || {};
    const placeId = nightData.place_id || day.place_id || '';
    const coords = nightData.coords || [];
    const suggestedDays = day.suggested_days || 1;
    const driveMin = day.to_next_leg?.drive_min || 0;
    const distanceKm = day.to_next_leg?.distance_km || 0;
    
    let transportBonus = driveMin > 300 ? 1.0 : driveMin > 180 ? 0.5 : 0;
    const nights = Math.max(0, Math.round(suggestedDays + transportBonus));
    
    let name = day.name || '';
    if (!name && placeId) {
      const parts = placeId.split('::');
      name = parts[parts.length - 1]?.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || `√âtape ${idx + 1}`;
    }
    
    const visits = Array.isArray(day.visits) ? day.visits.map(v => typeof v === 'string' ? {text: v} : v) : [];
    const activities = Array.isArray(day.activities) ? day.activities.map(a => typeof a === 'string' ? {text: a} : a) : [];
    const description = visits.map(v => v.text || v).filter(Boolean).join(' ');
    
    // R√©cup√©rer les photos avec plusieurs fallbacks
    let photos = [];
    if (Array.isArray(day.photos) && day.photos.length) photos = day.photos;
    else if (Array.isArray(day.images) && day.images.length) photos = day.images;
    else if (typeof day.image === 'string' && day.image) photos = [day.image];
    else if (typeof day.photo === 'string' && day.photo) photos = [day.photo];
    else if (typeof day.thumb === 'string' && day.thumb) photos = [day.thumb];
    
    steps.push({
      _idx: steps.length,
      name: name || `√âtape ${idx + 1}`,
      lat: coords[0] || day.lat,
      lng: coords[1] || day.lng || day.lon,
      nights, description,
      photos: photos,
      distance_km: distanceKm,
      placeId: day.place_id || day.placeId || placeId,
      place_id: day.place_id || day.placeId || placeId,
      visits: visits,
      activities: activities,
      _mapKeywords: Array.isArray(nightData.map_keywords) ? nightData.map_keywords : []
    });
  });
  
  state.steps = steps;
  
  console.log('[LOG-CONTROLE][MOBILE] ========== √âTAT APR√àS LOAD ITINERARY ==========');
  console.log(`[LOG-CONTROLE][MOBILE] ${state.steps.length} √©tapes charg√©es`);
  console.log('[LOG-CONTROLE][MOBILE] state.title:', state.title);
  console.log('[LOG-CONTROLE][MOBILE] √âtapes:');
  state.steps.forEach((s, i) => {
    console.log(`[LOG-CONTROLE][MOBILE]   ${i}: ${s.name} - ${s.nights} nuit(s), lat=${s.lat}, lng=${s.lng}`);
  });
}
FIN ANCIEN CODE loadItinerary */

async function loadFromFirebase(rtKey) {
  if (typeof firebase === 'undefined') {
    await new Promise(r => setTimeout(r, 1000));
    if (typeof firebase === 'undefined') throw new Error('Firebase non disponible');
  }
  
  const doc = await firebase.firestore().collection('trips').doc(rtKey).get();
  if (!doc.exists) throw new Error('Voyage non trouv√©');
  
  const data = doc.data();
  state.title = data.title || 'Roadtrip';
  state._originalItinId = rtKey;
  state.cc = data.cc || 'FR';
  state.steps = (data.steps || []).map((s, idx) => {
    // R√©cup√©rer les photos avec plusieurs fallbacks
    let photos = [];
    if (Array.isArray(s.images) && s.images.length) photos = s.images;
    else if (Array.isArray(s.photos) && s.photos.length) photos = s.photos;
    else if (typeof s.image === 'string' && s.image) photos = [s.image];
    else if (typeof s.photo === 'string' && s.photo) photos = [s.photo];
    else if (typeof s.thumb === 'string' && s.thumb) photos = [s.thumb];
    else if (typeof s.img === 'string' && s.img) photos = [s.img];
    // Fallback: chercher dans cachedPhotos si disponible
    else if (s.placeId && window._cachedPhotos?.[s.placeId]) {
      photos = [window._cachedPhotos[s.placeId]];
    }
    
    // R√©cup√©rer visits et activities
    const visits = Array.isArray(s.visits) ? s.visits.map(v => typeof v === 'string' ? {text: v} : v) : [];
    const activities = Array.isArray(s.activities) ? s.activities.map(a => typeof a === 'string' ? {text: a} : a) : [];
    
    return {
      _idx: idx,
      name: s.name || `√âtape ${idx + 1}`,
      lat: s.lat, lng: s.lng || s.lon,
      nights: s.nights || s.adjustedDays || 0,
      description: s.description || '',
      photos: photos,
      distance_km: s.distance_km || 0,
      placeId: s.placeId || s.place_id || null,
      place_id: s.place_id || s.placeId || null,
      visits: visits,
      activities: activities,
      _mapKeywords: Array.isArray(s._mapKeywords) ? s._mapKeywords : (Array.isArray(s.night?.map_keywords) ? s.night.map_keywords : [])
    };
  });
}

// === RENDER BOOKINGS (4e onglet) ===
function renderBookings() {
  const container = $('bookingsContainer');
  if (!container) return;
  
  // R√©initialiser le cache de bookings
  window._bookingCache = [];
  
  let html = '';
  let totalBudget = 0;
  
  // Helper pour formater les dates
  function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString(state.lang || 'fr', { day: '2-digit', month: '2-digit', year: 'numeric' });
    } catch (e) {
      return dateStr;
    }
  }
  
  // Helper pour afficher la ligne de date
  function getDateLine(b, nights) {
    let dateParts = [];
    if (b.date_start) {
      dateParts.push(formatDate(b.date_start));
    }
    if (b.date_end && b.date_end !== b.date_start) {
      dateParts.push(formatDate(b.date_end));
    }
    
    let line = '';
    if (dateParts.length === 1) {
      line = `üìÖ ${dateParts[0]}`;
    } else if (dateParts.length === 2) {
      line = `üìÖ ${dateParts[0]} ‚Üí ${dateParts[1]}`;
    }
    
    // Ajouter les nuits si applicable (h√¥tels)
    if (nights && nights > 0) {
      line += line ? ` (${nights} nuit${nights > 1 ? 's' : ''})` : `üåô ${nights} nuit${nights > 1 ? 's' : ''}`;
    }
    
    return line;
  }
  
  // === R√âSERVATIONS VOYAGE (vols, voiture, assurance) ===
  let travelBookings = [];
  if (window.ORT_TRIP_DATA) {
    travelBookings = ORT_TRIP_DATA.getTravelBookings() || [];
  }
  // Fallback: state.travelBookings (mode partag√© ou donn√©es locales)
  if ((!travelBookings || travelBookings.length === 0) && state.travelBookings && state.travelBookings.length > 0) {
    travelBookings = state.travelBookings;
  }
  
  if (travelBookings.length > 0) {
    html += `<div class="booking-section">
      <h3 class="booking-section-title">üåç R√©servations voyage</h3>`;
    
    travelBookings.forEach(b => {
      const icon = getCategoryIcon(b.category);
      const price = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : 0;
      totalBudget += parseFloat(price) || 0;
      const dateLine = getDateLine(b, b.nights);
      
      html += `
        <div class="booking-item" onclick="showBookingByIdx(${cacheBooking(b)})">
          <div class="booking-icon">${icon}</div>
          <div class="booking-info">
            <div class="booking-name">${b.name || 'R√©servation'}</div>
            ${dateLine ? `<div class="booking-detail">${dateLine}</div>` : ''}
            ${b.provider ? `<div class="booking-detail">üè¢ ${b.provider}</div>` : ''}
          </div>
          ${price ? `<div class="booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</div>` : ''}
        </div>
      `;
    });
    
    html += '</div>';
  }
  
  // === R√âSERVATIONS PAR √âTAPE (h√¥tels, activit√©s) ===
  const stepBookingsMap = new Map(); // Pour d√©dupliquer
  
  if (window.ORT_TRIP_DATA) {
    state.steps.forEach((step, stepIdx) => {
      const stepBookings = ORT_TRIP_DATA.getStepBookings(stepIdx) || [];
      stepBookings.forEach(b => {
        const bookingId = b.id || `${b.name}-${b.date_start || ''}-${b.category}`;
        if (!stepBookingsMap.has(bookingId)) {
          stepBookingsMap.set(bookingId, {
            booking: b,
            steps: [stepIdx],
            firstStepIndex: stepIdx
          });
        } else {
          const existing = stepBookingsMap.get(bookingId);
          if (!existing.steps.includes(stepIdx)) {
            existing.steps.push(stepIdx);
          }
        }
      });
    });
  }
  
  // Fallback: step.bookings directement (mode partag√©) + globalBookingManager
  if (stepBookingsMap.size === 0) {
    state.steps.forEach((step, stepIdx) => {
      let stepBookings = [];
      // Source 1: step.bookings (donn√©es partag√©es inline)
      if (step.bookings && Array.isArray(step.bookings) && step.bookings.length > 0) {
        stepBookings = step.bookings;
      }
      // Source 2: globalBookingManager
      if (stepBookings.length === 0 && typeof globalBookingManager !== 'undefined' && globalBookingManager) {
        stepBookings = globalBookingManager.getBookings(stepIdx) || [];
      }
      stepBookings.forEach(b => {
        const bookingId = b.id || `${b.name}-${b.date_start || ''}-${b.category}`;
        if (!stepBookingsMap.has(bookingId)) {
          stepBookingsMap.set(bookingId, {
            booking: b,
            steps: [stepIdx],
            firstStepIndex: stepIdx
          });
        }
      });
    });
  }
  
  if (stepBookingsMap.size === 0 && state.bookings) {
    // Fallback: ancien format state.bookings
    Object.entries(state.bookings).forEach(([stepIdx, bookings]) => {
      bookings.forEach(b => {
        const bookingId = b.id || `${b.name}-${b.date_start || ''}-${b.category}`;
        if (!stepBookingsMap.has(bookingId)) {
          stepBookingsMap.set(bookingId, {
            booking: b,
            steps: [parseInt(stepIdx)],
            firstStepIndex: parseInt(stepIdx)
          });
        }
      });
    });
  }
  
  if (stepBookingsMap.size > 0) {
    // Grouper par premi√®re √©tape
    const byStep = new Map();
    stepBookingsMap.forEach((data, id) => {
      const firstStep = data.firstStepIndex;
      if (!byStep.has(firstStep)) byStep.set(firstStep, []);
      byStep.get(firstStep).push(data);
    });
    
    byStep.forEach((bookingsData, stepIdx) => {
      const step = state.steps[stepIdx];
      if (!step) return;
      
      html += `<div class="booking-section">
        <h3 class="booking-section-title">üìç ${step.name}</h3>`;
      
      bookingsData.forEach(data => {
        const b = data.booking;
        const icon = getCategoryIcon(b.category);
        const price = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : 0;
        totalBudget += parseFloat(price) || 0;
        
        // Calculer le nombre de nuits (pour h√¥tels)
        const nights = b.category === 'hotel' ? (b.nights || data.steps.length) : b.nights;
        const dateLine = getDateLine(b, nights);
        
        html += `
          <div class="booking-item" onclick="showBookingByIdx(${cacheBooking(Object.assign({}, b, {stepIndex: stepIdx}))})">
            <div class="booking-icon">${icon}</div>
            <div class="booking-info">
              <div class="booking-name">${b.name || 'R√©servation'}</div>
              ${dateLine ? `<div class="booking-detail">${dateLine}</div>` : ''}
              ${b.address ? `<div class="booking-detail">üìç ${b.address}</div>` : ''}
              ${b.reference ? `<div class="booking-detail">üîñ ${b.reference}</div>` : ''}
            </div>
            ${price ? `<div class="booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</div>` : ''}
          </div>
        `;
      });
      
      html += '</div>';
    });
  }
  
  // V√©rifier s'il y a des r√©servations
  if (!html) {
    container.innerHTML = `
      <div style="padding: 40px 20px; text-align: center; color: #999;">
        <div style="font-size: 3rem; margin-bottom: 16px;">üìã</div>
        <div>Aucune r√©servation</div>
        <div style="font-size: 0.85rem; margin-top: 8px;">Ajoutez des r√©servations depuis RT Detail</div>
      </div>`;
    return;
  }
  
  // Budget total
  if (totalBudget > 0) {
    html += `
      <div class="booking-budget">
        <div class="budget-label">üí∞ Budget total</div>
        <div class="budget-amount">${totalBudget.toFixed(2)} ‚Ç¨</div>
      </div>
    `;
  }
  
  container.innerHTML = html;
}

function getCategoryIcon(category) {
  const icons = {
    lodging: 'üè®',
    hotel: 'üè®',
    flight: '‚úàÔ∏è',
    car: 'üöó',
    train: 'üöÜ',
    restaurant: 'üçΩÔ∏è',
    activity: 'üéØ',
    other: 'üìÑ'
  };
  return icons[category] || 'üìÑ';
}

function calculateDayNumber(dateStr, startDate) {
  // Simplifi√©: assume que c'est le jour calcul√© depuis la date de d√©part
  if (!startDate) return 1;
  const date = new Date(dateStr);
  const start = new Date(startDate);
  const diffTime = date - start;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return diffDays + 1;
}

// === TABS ===
function setupTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.id === 'tabServices') {
        openSheet($('servicesSheet'));
        return;
      }
      
      const panelId = btn.dataset.panel;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      $(panelId)?.classList.add('active');
      
      if (panelId === 'mapPanel' && map) {
        setTimeout(() => { map.invalidateSize(); fitMapBounds(); }, 100);
      }
    });
  });
}

// === EVENTS ===
function setupEvents() {
  $('btnBack').onclick = () => {
    if (hasUnsavedChanges && !confirm('Modifications non sauvegard√©es. Quitter ?')) return;
    history.back();
  };
  
  // === NOUVEAUX BOUTONS HEADER ===
  $('btnSaveHeader').onclick = saveTrip;
  $('btnLangHeader').onclick = () => openSheet($('langSheet'));
  $('btnShareHeader').onclick = openShareModal;
  $('btnCenterMap').onclick = centerMap;
  
  // === USER PROFILE BUTTON ===
  $('btnUser').onclick = () => {
    updateUserUI();
    openSheet($('userSheet'));
  };
  $('sheetOverlay').onclick = closeAllSheets;
  
  $('btnNightsMinus').onclick = () => adjustNights(-1);
  $('btnNightsPlus').onclick = () => adjustNights(1);
  $('btnDeleteStep').onclick = deleteCurrentStep;
  $('btnCloseSheet').onclick = closeAllSheets;
  
  // Handlers changement de langue
  document.querySelectorAll('.lang-option').forEach(opt => {
    opt.onclick = () => {
      const newLang = opt.dataset.lang;
      localStorage.setItem('lang', newLang);
      localStorage.setItem('ort_lang', newLang); // Important pour RT Mobile
      
      // Nettoyer les caches de state MAIS PAS les itin√©raires temporaires (ORT_TEMP_TRIP_)
      // car ils contiennent les itin√©raires personnalis√©s de l'utilisateur
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith('ORT_TEMP_STATE_') || 
            k.startsWith('ort_trip_temp_') ||
            k.startsWith('ort_trip_')) {
          // Ne PAS supprimer ORT_TEMP_TRIP_ qui contient les itin√©raires custom
          console.log('[LANG] Suppression cache:', k);
          localStorage.removeItem(k);
        }
      });
      
      state.lang = newLang;
      closeAllSheets();
      showToast(`‚úÖ Langue: ${newLang.toUpperCase()}`);
      
      // Mettre √† jour l'URL avec la nouvelle langue puis reload
      const url = new URL(location.href);
      url.searchParams.set('lang', newLang);
      setTimeout(() => location.replace(url.toString()), 500);
    };
  });
}

// === USER PROFILE MANAGEMENT ===
function updateUserUI() {
  try {
    const user = window.firebase?.auth?.()?.currentUser;
    const emailEl = $('userEmail');
    const statusEl = $('userStatus');
    const loginBtn = $('btnUserLogin');
    const logoutBtn = $('btnUserLogout');
    const emailBtn = $('btnUserEmail');
    const passBtn = $('btnUserPassword');
    const deleteBtn = $('btnUserDelete');
    
    if (user) {
      emailEl.textContent = user.email || 'Utilisateur';
      statusEl.textContent = `Connect√© depuis ${new Date(user.metadata.creationTime).toLocaleDateString('fr-FR')}`;
      
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'block';
      emailBtn.style.display = 'block';
      passBtn.style.display = 'block';
      deleteBtn.style.display = 'block';
    } else {
      emailEl.textContent = 'Non connect√©';
      statusEl.textContent = 'Connexion requise';
      
      loginBtn.style.display = 'block';
      logoutBtn.style.display = 'none';
      emailBtn.style.display = 'none';
      passBtn.style.display = 'none';
      deleteBtn.style.display = 'none';
    }
  } catch (e) {
    console.warn('[USER] Error updating UI:', e);
  }
}

// Gestion des boutons utilisateur
(function() {
  const $ = id => document.getElementById(id);
  
  $('btnUserLogin').onclick = () => {
    closeSheet($('userSheet'));
    if (window.openAuth) window.openAuth();
    else alert('Redirection vers la connexion...');
  };
  
  $('btnUserLogout').onclick = () => {
    if (confirm('Confirmer la d√©connexion?')) {
      window.firebase?.auth?.().signOut().then(() => {
        closeSheet($('userSheet'));
        updateUserUI();
        showToast('üëã D√©connect√©');
      });
    }
  };
  
  $('btnUserEmail').onclick = () => {
    const newEmail = prompt('Nouvel email:');
    if (newEmail && newEmail.trim()) {
      const user = window.firebase?.auth?.()?.currentUser;
      if (user) {
        user.verifyBeforeUpdateEmail(newEmail.trim()).then(() => {
          showToast('‚úÖ V√©rification envoy√©e √† ' + newEmail);
        }).catch(e => showToast('‚ùå ' + e.message));
      }
    }
  };
  
  $('btnUserPassword').onclick = () => {
    const user = window.firebase?.auth?.()?.currentUser;
    if (user && user.email) {
      window.firebase?.auth?.().sendPasswordResetEmail(user.email).then(() => {
        showToast('‚úÖ Email de r√©initialisation envoy√©');
      }).catch(e => showToast('‚ùå ' + e.message));
    }
  };
  
  $('btnUserDelete').onclick = () => {
    if (confirm('‚ö†Ô∏è Cette action est irr√©versible. Supprimer le compte?')) {
      if (confirm('√ätes-vous vraiment s√ªr?')) {
        const user = window.firebase?.auth?.()?.currentUser;
        if (user) {
          user.delete().then(() => {
            showToast('‚ùå Compte supprim√©');
            setTimeout(() => location.href = 'dashboard_user.html', 1000);
          }).catch(e => showToast('Erreur: ' + e.message));
        }
      }
    }
  };
})();

// === RENDERING ===

// Tracking des photos utilis√©es pour √©viter les doublons
const usedPhotos = new Set();

// R√©cup√©rer toutes les photos disponibles pour une √©tape (ordre de priorit√©)
function getAllStepPhotos(step) {
  const photos = [];
  
  // 1. PRIORIT√â: Photos sauvegard√©es dans Firestore (step.photos ou step.images)
  if (step.photos?.length) {
    photos.push(...step.photos.filter(p => p && typeof p === 'string'));
  }
  if (step.images?.length) {
    step.images.forEach(img => {
      const url = typeof img === 'string' ? img : img?.url;
      if (url && !photos.includes(url)) photos.push(url);
    });
  }
  if (step.image && !photos.includes(step.image)) photos.push(step.image);
  
  // 2. Photos du cache via placeId
  if (step.placeId) {
    const cached = getPhotosForPlace(step.placeId);
    cached.forEach(p => { if (!photos.includes(p)) photos.push(p); });
  }
  
  // 3. Chercher par nom avec la fonction smart
  const found = findPhotosForPlace(step.name, state.cc);
  found.forEach(p => { if (!photos.includes(p)) photos.push(p); });
  
  return photos;
}

// Choisir la meilleure photo pour une √©tape (√©vite les doublons)
function getStepPhoto(step, stepIdx = -1) {
  const allPhotos = getAllStepPhotos(step);
  
  // Trouver une photo pas encore utilis√©e
  for (const photo of allPhotos) {
    if (!usedPhotos.has(photo)) {
      if (stepIdx >= 0) usedPhotos.add(photo); // Marquer comme utilis√©e
      return photo;
    }
  }
  
  // Si toutes les photos sont utilis√©es, utiliser un index rotatif
  if (allPhotos.length > 0 && stepIdx >= 0) {
    // Utiliser l'index de l'√©tape pour choisir une photo diff√©rente
    const photoIndex = stepIdx % allPhotos.length;
    return allPhotos[photoIndex];
  }
  
  // Si toutes les photos sont utilis√©es, prendre la premi√®re disponible
  if (allPhotos.length > 0) {
    return allPhotos[0];
  }
  
  return PLACEHOLDER_IMG;
}

// Reset les photos utilis√©es (appel√© au chargement d'un nouveau trip)
function resetUsedPhotos() {
  usedPhotos.clear();
}

// Charger une image avec timeout et fallback
function loadImageWithFallback(imgElement, urls, timeoutMs = 3000) {
  if (!urls || urls.length === 0) {
    imgElement.src = PLACEHOLDER_IMG;
    return;
  }
  
  let currentIndex = 0;
  let timeoutId = null;
  
  function tryNext() {
    if (currentIndex >= urls.length) {
      imgElement.src = PLACEHOLDER_IMG;
      return;
    }
    
    const url = urls[currentIndex];
    currentIndex++;
    
    // Clear previous timeout
    if (timeoutId) clearTimeout(timeoutId);
    
    // Set timeout pour passer √† la suivante si trop lent
    timeoutId = setTimeout(() => {
      console.log(`[PHOTO] Timeout pour ${url.substring(0, 50)}..., essai suivant`);
      tryNext();
    }, timeoutMs);
    
    imgElement.onload = () => {
      if (timeoutId) clearTimeout(timeoutId);
    };
    
    imgElement.onerror = () => {
      if (timeoutId) clearTimeout(timeoutId);
      console.log(`[PHOTO] Erreur pour ${url.substring(0, 50)}..., essai suivant`);
      tryNext();
    };
    
    imgElement.src = url;
  }
  
  tryNext();
}

function renderList() {
  const list = $('stepsList');
  list.innerHTML = '';
  const lang = state.lang || 'fr';
  
  // Reset les photos utilis√©es pour ce rendu
  resetUsedPhotos();
  
  state.steps.forEach((step, idx) => {
    const card = document.createElement('div');
    card.className = 'step-card';
    card.onclick = () => openStepSheet(idx);
    
    // Utiliser getStepPhoto avec l'index pour √©viter les doublons
    const photoUrl = getStepPhoto(step, idx);
    const nightsText = step.nights > 0 ? `${step.nights} nuit${step.nights > 1 ? 's' : ''}` : '';
    const distText = step.distance_km ? `${Math.round(step.distance_km)} km` : '';
    const stepDisplayName = getCityDisplayName(step, lang) || step.name;
    
    // V√©rifier si l'√©tape a des r√©servations (chercher dans TOUTES les sources)
    let bookingIndicator = '';
    let bookedHotelName = '';
    const isHotelCat = (b) => b && (b.category === 'hotel' || b.category === 'lodging' || b.category === 'accommodation');
    
    // Collecter les bookings de toutes les sources
    let allStepBookings = [];
    if (window.ORT_TRIP_DATA) {
      allStepBookings = ORT_TRIP_DATA.getStepBookings(idx) || [];
    }
    if (allStepBookings.length === 0 && step.bookings && Array.isArray(step.bookings)) {
      allStepBookings = step.bookings;
    }
    
    if (allStepBookings.length > 0) {
      const hotelBooking = allStepBookings.find(isHotelCat);
      const hasActivity = allStepBookings.some(b => ['activity', 'visit', 'show'].includes(b.category));
      if (hotelBooking) {
        bookedHotelName = hotelBooking.name || hotelBooking.title || '';
        const displayName = bookedHotelName.length > 22 ? bookedHotelName.substring(0, 20) + '‚Ä¶' : bookedHotelName;
        bookingIndicator = `<span class="step-card-booking" style="font-size:11px;gap:3px">üè® ${displayName || 'R√©serv√©'}</span>`;
      } else if (hasActivity) {
        bookingIndicator = `<span class="step-card-booking">üé´</span>`;
      }
    }
    
    card.innerHTML = `
      <div class="step-card-num">${idx + 1}</div>
      <img class="step-card-photo" data-step-idx="${idx}" src="${PLACEHOLDER_IMG}" alt="" loading="lazy">
      <div class="step-card-info">
        <div class="step-card-name">${stepDisplayName}</div>
        <div class="step-card-meta">${distText}</div>
        ${step.nights > 0 ? `<div class="step-card-nights">üåô ${nightsText}</div>` : ''}
        ${bookingIndicator ? `<div style="margin-top:3px">${bookingIndicator}</div>` : ''}
      </div>
      <div class="step-card-chevron">‚Ä∫</div>
    `;
    list.appendChild(card);
    
    // Charger l'image avec fallback et timeout
    const imgEl = card.querySelector('.step-card-photo');
    // Filtrer les photos d√©j√† utilis√©es par d'autres √©tapes
    const allPhotos = getAllStepPhotos(step);
    const availablePhotos = allPhotos.filter(p => !usedPhotos.has(p));
    // Utiliser les photos disponibles, ou toutes si aucune disponible
    const photosToUse = availablePhotos.length > 0 ? availablePhotos : allPhotos;
    if (photosToUse.length > 0) {
      // Marquer la premi√®re comme utilis√©e
      usedPhotos.add(photosToUse[0]);
      loadImageWithFallback(imgEl, photosToUse, 3000);
    } else {
      console.warn(`[PHOTO] Aucune photo pour √©tape ${idx + 1}: ${step.name}`);
    }
  });
}

function updateSummary() {
  const totalSteps = state.steps.length;
  const totalNights = state.steps.reduce((sum, s) => sum + (s.nights || 0), 0);
  const km = totalRouteKm || state.steps.reduce((sum, s) => sum + (s.distance_km || 0), 0);
  
  $('statSteps').textContent = totalSteps;
  $('statNights').textContent = totalNights;
  $('statKm').textContent = Math.round(km);
}

// === MAP ===
function initMap() {
  if (typeof L === 'undefined') { setTimeout(initMap, 100); return; }
  if (map) return;
  
  map = L.map('map', { zoomControl: true, attributionControl: false });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    maxZoom: 19, subdomains: 'abcd'
  }).addTo(map);
  
  renderMarkers();
  fetchAndDrawRoute();
  fitMapBounds();
}

function renderMarkers() {
  if (!map) return;
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  
  // Nettoyer les lignes de groupe pr√©c√©dentes
  if (window._hubLines) {
    window._hubLines.forEach(l => { try { map.removeLayer(l); } catch(_) {} });
  }
  window._hubLines = [];
  
  // === Regrouper les √©tapes par coordonn√©es (tol√©rance ~100m) ===
  console.log('[LOG-CONTROLE][MOBILE] ========== RENDER MARKERS ==========');
  console.log(`[LOG-CONTROLE][MOBILE] ${state.steps.length} √©tapes √† afficher`);
  
  const grouped = {};
  state.steps.forEach((step, idx) => {
    if (!step.lat || !step.lng) return;
    const key = `${step.lat.toFixed(3)},${step.lng.toFixed(3)}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(idx);
  });
  
  // === Cr√©er les marqueurs avec dispersion pour les groupes ===
  const groupCount = Object.keys(grouped).length;
  const multiGroups = Object.values(grouped).filter(g => g.length > 1).length;
  console.log(`[LOG-CONTROLE][MOBILE] ${groupCount} positions uniques, ${multiGroups} groupe(s) avec plusieurs √©tapes`);
  if (multiGroups > 0) {
    Object.entries(grouped).filter(([k, v]) => v.length > 1).forEach(([key, indices]) => {
      console.log(`[LOG-CONTROLE][MOBILE]   Groupe √† ${key}: √©tapes ${indices.map(i => i+1).join(', ')}`);
    });
  }
  
  Object.entries(grouped).forEach(([key, indices]) => {
    const [centerLat, centerLon] = key.split(',').map(Number);
    
    // Rayon de dispersion (plus grand pour √™tre visible)
    const radius = 0.006;
    
    indices.forEach((idx, subIndex) => {
      const step = state.steps[idx];
      
      // Calculer la position (dispers√©e si groupe > 1)
      let markerLat = step.lat;
      let markerLng = step.lng;
      
      if (indices.length > 1) {
        const angle = (subIndex / indices.length) * 2 * Math.PI - Math.PI / 2;
        markerLat = centerLat + (Math.sin(angle) * radius);
        markerLng = centerLon + (Math.cos(angle) * radius * 1.3);
        
        // === Ligne du centre vers le marqueur ===
        const hubLine = L.polyline(
          [[centerLat, centerLon], [markerLat, markerLng]], 
          { 
            color: '#666', 
            weight: 1.5, 
            opacity: 0.5, 
            dashArray: '4,4'
          }
        ).addTo(map);
        window._hubLines.push(hubLine);
      }
      
      const icon = L.divIcon({
        className: 'step-marker',
        html: `${idx + 1}`,
        iconSize: [26, 26],
        iconAnchor: [13, 13]
      });
      
      const marker = L.marker([markerLat, markerLng], { icon });
      marker.on('click', () => {
        const currentStep = state.steps[idx];
        const photoUrl = getStepPhoto(currentStep);
        const popupName = getCityDisplayName(currentStep, state.lang || 'fr') || currentStep.name;
        marker.bindPopup(`
          <div class="map-popup-mini">
            <img src="${photoUrl}" onerror="this.src='${PLACEHOLDER_IMG}'">
            <div class="name">${popupName}</div>
            <button class="btn-details" onclick="openStepSheet(${idx})">Voir d√©tails</button>
          </div>
        `).openPopup();
      });
      marker.addTo(map);
      markers.push(marker);
    });
  });
}

async function fetchAndDrawRoute() {
  if (!map) return;
  const coords = state.steps.filter(s => s.lat && s.lng).map(s => [s.lng, s.lat]);
  if (coords.length < 2) return;
  
  try {
    const coordsStr = coords.map(c => c.join(',')).join(';');
    const resp = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordsStr}?overview=full&geometries=geojson`, { signal: AbortSignal.timeout(10000) });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    
    const data = await resp.json();
    if (data.code !== 'Ok' || !data.routes?.[0]) throw new Error('No route');
    
    const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
    totalRouteKm = Math.round(data.routes[0].distance / 1000);
    
    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.polyline(routeCoords, { color: '#113f7a', weight: 4, opacity: 0.8 }).addTo(map);
    $('statKm').textContent = totalRouteKm;
  } catch (err) {
    console.warn('[ROUTE] Fallback:', err.message);
    const fallbackCoords = state.steps.filter(s => s.lat && s.lng).map(s => [s.lat, s.lng]);
    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.polyline(fallbackCoords, { color: '#113f7a', weight: 3, opacity: 0.7, dashArray: '8,8' }).addTo(map);
  }
}

function fitMapBounds() {
  if (!map) return;
  const coords = state.steps.filter(s => s.lat && s.lng).map(s => [s.lat, s.lng]);
  if (coords.length > 0) map.fitBounds(coords, { padding: [30, 30] });
}

function centerMap() {
  closeAllSheets();
  fitMapBounds();
  $('tabMap').click();
  showToast('üéØ Carte centr√©e');
}

// === SHEETS ===
function openSheet(sheet) {
  $('sheetOverlay').classList.add('show');
  sheet.classList.add('show');
}

function closeSheet(sheet) {
  $('sheetOverlay').classList.remove('show');
  sheet.classList.remove('show');
}

function closeAllSheets() {
  $('sheetOverlay').classList.remove('show');
  $('stepSheet').classList.remove('show');
  $('servicesSheet').classList.remove('show');
  $('langSheet').classList.remove('show');
  $('scannerSheet').classList.remove('show');
  $('userSheet').classList.remove('show');
  $('bookingDetailSheet')?.classList.remove('show');
  currentStepIndex = null;
}

// Variables pour stocker les visites/activit√©s de l'√©tape courante
let currentStepVisits = [];
let currentStepActivities = [];

function openStepSheet(idx) {
  currentStepIndex = idx;
  const step = state.steps[idx];
  const lang = state.lang || 'fr';
  
  $('sheetStepName').textContent = getCityDisplayName(step, lang) || step.name;
  
  // i18n pour "√âtape X sur Y"
  const stepOfText = i18n('stepOf').replace('{0}', idx + 1).replace('{1}', state.steps.length);
  $('sheetStepMeta').textContent = stepOfText;
  
  $('nightsValue').textContent = step.nights || 0;
  
  // Boutons de navigation
  $('btnPrevStep').disabled = idx === 0;
  $('btnNextStep').disabled = idx === state.steps.length - 1;
  
  // Stocker les visites et activit√©s
  currentStepVisits = Array.isArray(step.visits) ? step.visits : [];
  currentStepActivities = Array.isArray(step.activities) ? step.activities : [];
  
  // Si vides, chercher dans PLACES_INDEX (comme RT detail)
  const stepPlaceId = step.placeId || step.place_id;
  if (stepPlaceId && PLACES_INDEX && PLACES_INDEX[stepPlaceId]) {
    const masterData = PLACES_INDEX[stepPlaceId];
    if (currentStepVisits.length === 0 && masterData.visits) {
      currentStepVisits = masterData.visits;
      step.visits = currentStepVisits;  // Mettre √† jour le step aussi
    }
    if (currentStepActivities.length === 0 && masterData.activities) {
      currentStepActivities = masterData.activities;
      step.activities = currentStepActivities;  // Mettre √† jour le step aussi
    }
  }
  
  // Mettre √† jour les compteurs
  const visitsCount = currentStepVisits.length;
  const activitiesCount = currentStepActivities.length;
  $('visitsCount').textContent = visitsCount || '';
  $('visitsCount').dataset.count = visitsCount;
  $('activitiesCount').textContent = activitiesCount || '';
  $('activitiesCount').dataset.count = activitiesCount;
  
  // Toujours afficher les boutons (m√™me si vides - on montre un message dans la modale)
  $('btnOpenVisits').style.display = '';
  $('btnOpenActivities').style.display = '';
  
  // Charger la photo avec fallback et timeout
  const photoEl = $('sheetStepPhoto');
  const allPhotos = getAllStepPhotos(step);
  if (allPhotos.length > 0) {
    loadImageWithFallback(photoEl, allPhotos, 3000);
  } else {
    photoEl.src = PLACEHOLDER_IMG;
  }
  
  // Liens affili√©s pour cette √©tape
  const cityName = step.name || '';
  const checkIn = new Date().toISOString().split('T')[0];
  const nights = step.nights || 1;
  const campaign = `ort_mobile_step${idx + 1}`;
  
  $('btnGyg').href = AFFILIATE.gyg(cityName);
  $('btnTiqets').href = AFFILIATE.tiqets(cityName, state.lang);
  
  // H√¥tels - Ouvrir la modale au lieu de Stay22 direct
  const btnHotel = $('btnHotel');
  btnHotel.href = '#';
  btnHotel.style.display = '';
  btnHotel.onclick = (e) => {
    e.preventDefault();
    if (typeof openHotelsModal === 'function') {
      openHotelsModal(step, idx);
    } else {
      // Fallback vers Stay22 si modale non disponible
      const stay22Url = AFFILIATE.hotel(step.lat, step.lng, cityName, Math.max(1, nights), checkIn, campaign);
      window.open(stay22Url, '_blank');
    }
  };
  
  // Afficher les r√©servations de cette √©tape
  const bookingsSection = $('stepBookingsSection');
  const bookingsList = $('stepBookingsList');
  
  if (window.ORT_TRIP_DATA) {
    const stepBookings = ORT_TRIP_DATA.getStepBookings(idx) || [];
    if (stepBookings.length > 0) {
      bookingsSection.style.display = '';
      bookingsList.innerHTML = stepBookings.map(b => {
        const icon = getCategoryIcon(b.category);
        const price = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : null;
        let dateStr = '';
        if (b.date_start) {
          const ds = new Date(b.date_start).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
          if (b.date_end && b.date_end !== b.date_start) {
            const de = new Date(b.date_end).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            const nights = Math.ceil((new Date(b.date_end) - new Date(b.date_start)) / 86400000);
            dateStr = `${ds} ‚Üí ${de}${nights > 0 ? ` (${nights} nuit${nights > 1 ? 's' : ''})` : ''}`;
          } else {
            dateStr = ds;
          }
        }
        return `
          <div class="step-booking-item" onclick="showBookingByIdx(${cacheBooking(Object.assign({}, b, {stepIndex: idx}))})">
            <div class="step-booking-icon">${icon}</div>
            <div class="step-booking-info">
              <div class="step-booking-name">${b.name || 'R√©servation'}</div>
              ${dateStr ? `<div class="step-booking-dates">üìÖ ${dateStr}</div>` : ''}
            </div>
            ${price ? `<div class="step-booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</div>` : ''}
          </div>
        `;
      }).join('');
    } else {
      bookingsSection.style.display = 'none';
    }
  } else {
    bookingsSection.style.display = 'none';
  }
  
  // Appliquer les traductions i18n
  applyI18n();
  
  openSheet($('stepSheet'));
}

// Navigation entre √©tapes
function navigateStep(delta) {
  const newIdx = currentStepIndex + delta;
  if (newIdx >= 0 && newIdx < state.steps.length) {
    openStepSheet(newIdx);
  }
}

// === MODALES VISITES / ACTIVIT√âS ===

function openVisitsModal() {
  const step = state.steps[currentStepIndex];
  const stepName = getCityDisplayName(step, state.lang) || step.name;
  
  // i18n pour "√âtape X sur Y"
  const stepOfText = i18n('stepOf').replace('{0}', currentStepIndex + 1).replace('{1}', state.steps.length);
  $('visitsModalStep').textContent = `${stepName} - ${stepOfText}`;
  
  const body = $('visitsModalBody');
  if (currentStepVisits.length === 0) {
    body.innerHTML = `<div class="content-empty">${i18n('noVisits')}</div>
      <button class="content-add-bottom" onclick="addVisit()">Ôºã Ajouter une visite</button>`;
  } else {
    body.innerHTML = currentStepVisits.map((v, idx) => {
      const text = typeof v === 'string' ? v : (v.text || v.description || v.name || '');
      return `
        <div class="content-item" id="visit-item-${idx}">
          <div class="content-item-text">${text}</div>
          <div class="content-item-actions">
            <button class="content-item-btn edit-btn" onclick="editVisit(${idx})" title="Modifier">‚úèÔ∏è</button>
            <button class="content-item-btn delete-btn" onclick="deleteVisit(${idx})" title="Supprimer">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join('') + `<button class="content-add-bottom" onclick="addVisit()">Ôºã Ajouter une visite</button>`;
  }
  
  $('visitsModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeVisitsModal() {
  $('visitsModal').classList.remove('open');
  document.body.style.overflow = '';
}

function openActivitiesModal() {
  const step = state.steps[currentStepIndex];
  const stepName = getCityDisplayName(step, state.lang) || step.name;
  
  // i18n pour "√âtape X sur Y"
  const stepOfText = i18n('stepOf').replace('{0}', currentStepIndex + 1).replace('{1}', state.steps.length);
  $('activitiesModalStep').textContent = `${stepName} - ${stepOfText}`;
  
  const body = $('activitiesModalBody');
  if (currentStepActivities.length === 0) {
    body.innerHTML = `<div class="content-empty">${i18n('noActivities')}</div>
      <button class="content-add-bottom" onclick="addActivity()">Ôºã Ajouter une activit√©</button>`;
  } else {
    body.innerHTML = currentStepActivities.map((a, idx) => {
      const text = typeof a === 'string' ? a : (a.text || a.description || a.name || '');
      return `
        <div class="content-item" id="activity-item-${idx}">
          <div class="content-item-text">${text}</div>
          <div class="content-item-actions">
            <button class="content-item-btn edit-btn" onclick="editActivity(${idx})" title="Modifier">‚úèÔ∏è</button>
            <button class="content-item-btn delete-btn" onclick="deleteActivity(${idx})" title="Supprimer">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join('') + `<button class="content-add-bottom" onclick="addActivity()">Ôºã Ajouter une activit√©</button>`;
  }
  
  $('activitiesModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeActivitiesModal() {
  $('activitiesModal').classList.remove('open');
  document.body.style.overflow = '';
}

// === FONCTIONS D'√âDITION DES VISITES ===
function addVisit() {
  const step = state.steps[currentStepIndex];
  if (!step.visits) step.visits = [];
  step.visits.push({ text: '' });
  currentStepVisits = step.visits;
  hasUnsavedChanges = true;
  openVisitsModal(); // Refresh
  // Focus sur le dernier item en mode √©dition
  setTimeout(() => editVisit(step.visits.length - 1), 100);
}

function editVisit(idx) {
  const item = $(`visit-item-${idx}`);
  if (!item) return;
  
  const visit = currentStepVisits[idx];
  const text = typeof visit === 'string' ? visit : (visit.text || visit.description || '');
  
  item.classList.add('editing');
  item.innerHTML = `
    <textarea class="content-item-textarea" id="visit-textarea-${idx}" placeholder="D√©crivez cette visite...">${text}</textarea>
    <button class="content-item-save-btn" onclick="saveVisit(${idx})">‚úì Enregistrer</button>
  `;
  
  const textarea = $(`visit-textarea-${idx}`);
  textarea.focus();
  textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

function saveVisit(idx) {
  const textarea = $(`visit-textarea-${idx}`);
  if (!textarea) return;
  
  const newText = textarea.value.trim();
  if (newText) {
    const step = state.steps[currentStepIndex];
    if (typeof step.visits[idx] === 'string') {
      step.visits[idx] = newText;
    } else {
      step.visits[idx] = { ...step.visits[idx], text: newText };
    }
    currentStepVisits = step.visits;
    hasUnsavedChanges = true;
  }
  
  openVisitsModal(); // Refresh
  updateVisitsActivitiesCounts();
}

function deleteVisit(idx) {
  if (!confirm('Supprimer cette visite ?')) return;
  
  const step = state.steps[currentStepIndex];
  step.visits.splice(idx, 1);
  currentStepVisits = step.visits;
  hasUnsavedChanges = true;
  
  openVisitsModal(); // Refresh
  updateVisitsActivitiesCounts();
}

// === FONCTIONS D'√âDITION DES ACTIVIT√âS ===
function addActivity() {
  const step = state.steps[currentStepIndex];
  if (!step.activities) step.activities = [];
  step.activities.push({ text: '' });
  currentStepActivities = step.activities;
  hasUnsavedChanges = true;
  openActivitiesModal(); // Refresh
  // Focus sur le dernier item en mode √©dition
  setTimeout(() => editActivity(step.activities.length - 1), 100);
}

function editActivity(idx) {
  const item = $(`activity-item-${idx}`);
  if (!item) return;
  
  const activity = currentStepActivities[idx];
  const text = typeof activity === 'string' ? activity : (activity.text || activity.description || '');
  
  item.classList.add('editing');
  item.innerHTML = `
    <textarea class="content-item-textarea" id="activity-textarea-${idx}" placeholder="D√©crivez cette activit√©...">${text}</textarea>
    <button class="content-item-save-btn" onclick="saveActivity(${idx})">‚úì Enregistrer</button>
  `;
  
  const textarea = $(`activity-textarea-${idx}`);
  textarea.focus();
  textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

function saveActivity(idx) {
  const textarea = $(`activity-textarea-${idx}`);
  if (!textarea) return;
  
  const newText = textarea.value.trim();
  if (newText) {
    const step = state.steps[currentStepIndex];
    if (typeof step.activities[idx] === 'string') {
      step.activities[idx] = newText;
    } else {
      step.activities[idx] = { ...step.activities[idx], text: newText };
    }
    currentStepActivities = step.activities;
    hasUnsavedChanges = true;
  }
  
  openActivitiesModal(); // Refresh
  updateVisitsActivitiesCounts();
}

function deleteActivity(idx) {
  if (!confirm('Supprimer cette activit√© ?')) return;
  
  const step = state.steps[currentStepIndex];
  step.activities.splice(idx, 1);
  currentStepActivities = step.activities;
  hasUnsavedChanges = true;
  
  openActivitiesModal(); // Refresh
  updateVisitsActivitiesCounts();
}

function updateVisitsActivitiesCounts() {
  $('visitsCount').textContent = currentStepVisits.length;
  $('activitiesCount').textContent = currentStepActivities.length;
}

// === ACTIONS ===
function adjustNights(delta) {
  if (currentStepIndex === null) return;
  const step = state.steps[currentStepIndex];
  step.nights = Math.max(0, (step.nights || 0) + delta);
  $('nightsValue').textContent = step.nights;
  hasUnsavedChanges = true;
  
  // MAJ lien h√¥tel - Ouvrir modale au lieu de Stay22 direct
  const btnHotel = $('btnHotel');
  btnHotel.href = '#';
  btnHotel.onclick = (e) => {
    e.preventDefault();
    if (typeof openHotelsModal === 'function') {
      openHotelsModal(step, currentStepIndex);
    } else {
      const checkIn = new Date().toISOString().split('T')[0];
      const campaign = `ort_mobile_step${currentStepIndex + 1}`;
      const stay22Url = AFFILIATE.hotel(step.lat, step.lng, step.name, Math.max(1, step.nights), checkIn, campaign);
      window.open(stay22Url, '_blank');
    }
  };
  
  renderList();
  renderBookings();
  updateSummary();
}

function deleteCurrentStep() {
  if (currentStepIndex === null) return;
  const step = state.steps[currentStepIndex];
  if (!confirm(`Supprimer "${step.name}" ?`)) return;
  
  if (typeof globalBookingManager !== 'undefined' && globalBookingManager && globalBookingManager.reindexAfterDelete) {
    globalBookingManager.reindexAfterDelete(currentStepIndex);
  }
  if (window.ORT_TRIP_DATA && ORT_TRIP_DATA.reindexAfterDelete) {
    ORT_TRIP_DATA.reindexAfterDelete(currentStepIndex);
  }
  state.steps.splice(currentStepIndex, 1);
  hasUnsavedChanges = true;
  closeAllSheets();
  renderList();
  renderBookings();
  updateSummary();
  renderMarkers();
  fetchAndDrawRoute();
  showToast('üóëÔ∏è √âtape supprim√©e');
}

async function saveTrip() {
  closeAllSheets();
  try {
    // V√©rifier si Firebase est disponible et utilisateur connect√©
    const user = typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser;
    
    // üî¥ Si pas connect√©, afficher modale de login
    if (!user) {
      $('loginRequiredModal').style.display = 'flex';
      applyI18n();
      return;
    }
    
    if (user && window.ORT_STATE) {
      // Utilise ORT_TRIPID pour garantir un tripId coh√©rent
      let tripId = window.ORT_TRIPID ? window.ORT_TRIPID.get() : null;
      if (!tripId) {
        tripId = state.tripId || state._originalItinId || `mobile::${Date.now()}`;
      }
      
      // üî¥ D√âTECTION CATALOGUE: Forcer g√©n√©ration NEW tripId si c'est un catalogue
      if (tripId && tripId.startsWith('catalog::')) {
        console.log('[SAVE] üìö D√©tection catalogue, g√©n√©ration NEW tripId');
        tripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        console.log('[SAVE] ‚úÖ NEW tripId g√©n√©r√©:', tripId);
      }
      
      if (window.ORT_TRIPID) window.ORT_TRIPID.store(tripId);
      
      const tripData = {
        id: tripId,
        title: state.title || 'Roadtrip',
        country: state.cc || 'XX',
        steps: state.steps.map(s => ({
          name: s.name,
          lat: s.lat,
          lon: s.lng || s.lon,
          lng: s.lng || s.lon,
          nights: s.nights || 0,
          place_id: s.place_id || s.placeId,
          photos: s.photos || [],
          description: s.description || ''
        })),
        nights: state.steps.reduce((sum, s) => sum + (s.nights || 0), 0),
        kms: state.totalKm || 0,
        saved: true,  // IMPORTANT: Pour appara√Ætre dans le Dashboard
        updatedAt: Date.now(),
        createdAt: state._createdAt || Date.now(),
        source: 'mobile'
      };
      
      // Sauvegarder via State Manager
      await window.ORT_STATE.saveTrip(tripData);
      
      // Mettre √† jour le tripId dans state pour les sauvegardes suivantes
      state.tripId = tripId;
      if (window.ORT_TRIPID) window.ORT_TRIPID.store(tripId);
      
      hasUnsavedChanges = false;
      showToast('‚úÖ Sauvegard√© dans votre Dashboard !');
      console.log('[SAVE] ‚úÖ Trip sauvegard√© via ORT_STATE:', tripId);
    } else if (user) {
      // Fallback Firestore direct si ORT_STATE non disponible
      console.warn('[SAVE] ORT_STATE non disponible, fallback Firestore direct');
      let tripId = state._originalItinId || `mobile_${Date.now()}`;
      
      // üî¥ D√âTECTION CATALOGUE: Forcer g√©n√©ration NEW tripId si c'est un catalogue
      if (tripId && tripId.startsWith('catalog::')) {
        console.log('[SAVE] üìö D√©tection catalogue (fallback), g√©n√©ration NEW tripId');
        tripId = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }
      
      const tripData = {
        title: state.title || 'Roadtrip',
        cc: state.cc || 'XX',
        steps: state.steps.map(s => ({
          name: s.name,
          lat: s.lat,
          lng: s.lng || s.lon,
          nights: s.nights || 0,
          place_id: s.place_id || s.placeId,
          photos: s.photos || [],
          description: s.description || ''
        })),
        saved: true,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        userId: user.uid,
        source: 'mobile'
      };
      
      // CORRECTION: Utiliser users/{uid}/trips au lieu de trips
      await firebase.firestore()
        .collection('users').doc(user.uid)
        .collection('trips').doc(tripId)
        .set(tripData, { merge: true });
      
      // Mettre √† jour le tripId dans state
      state.tripId = tripId;
      
      hasUnsavedChanges = false;
      showToast('‚úÖ Sauvegard√© dans votre Dashboard !');
    } else {
      // Fallback localStorage pour non-connect√©s
      let saveKey = state._originalItinId || Date.now();
      // üî¥ D√âTECTION CATALOGUE: Ne pas utiliser l'ID catalogue
      if (saveKey && String(saveKey).startsWith('catalog::')) {
        saveKey = `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }
      localStorage.setItem(`ort_trip_${saveKey}`, JSON.stringify({ ...state, savedAt: new Date().toISOString() }));
      hasUnsavedChanges = false;
      showToast('‚úÖ Sauvegard√© localement (connectez-vous pour synchroniser)');
    }
  } catch (err) {
    console.error('[SAVE]', err);
    showToast('‚ùå Erreur de sauvegarde');
  }
}

function openShareModal() {
  // Appliquer les traductions
  applyI18n();
  
  // üî¥ 1) V√©rifier que l'utilisateur est connect√©
  const user = typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser;
  if (!user) {
    // Afficher modale "Connexion requise"
    $('loginRequiredModal').style.display = 'flex';
    return;
  }
  
  // üî¥ 2) V√©rifier que le voyage est sauvegard√©
  const tripId = window.ORT_TRIPID ? window.ORT_TRIPID.get() : state.tripId;
  const isSaved = tripId && !tripId.startsWith('catalog::') && !tripId.startsWith('custom::') && !tripId.startsWith('temp_');
  
  if (!isSaved) {
    // Afficher modale "Sauvegarde requise"
    $('saveRequiredModal').style.display = 'flex';
    return;
  }
  
  // üî¥ 3) Tout est OK, ouvrir la modale de partage
  openShareModalDirect();
}

function openShareModalDirect() {
  // Appliquer les traductions √† la modale
  applyI18n();
  
  // Mettre √† jour le titre avec le nom du voyage
  $('shareModalTitle').textContent = state.title || 'Mon roadtrip';
  
  // Reset √©tat
  $('shareResult').style.display = 'none';
  $('btnGenerateShare').innerHTML = `<span>${i18n('shareGenerate')}</span>`;
  $('btnGenerateShare').disabled = false;
  
  // Ouvrir la modale
  $('shareModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeLoginRequiredModal() {
  $('loginRequiredModal').style.display = 'none';
}

function closeSaveRequiredModal() {
  $('saveRequiredModal').style.display = 'none';
}

// Handlers pour les modales d'alerte
document.addEventListener('DOMContentLoaded', () => {
  // Login Required Modal
  const btnLoginRequiredLogin = document.getElementById('btnLoginRequiredLogin');
  const btnLoginRequiredCancel = document.getElementById('btnLoginRequiredCancel');
  const loginRequiredModal = document.getElementById('loginRequiredModal');
  
  if (btnLoginRequiredLogin) {
    btnLoginRequiredLogin.onclick = () => {
      closeLoginRequiredModal();
      if (window.openAuth) window.openAuth('login');
    };
  }
  if (btnLoginRequiredCancel) {
    btnLoginRequiredCancel.onclick = closeLoginRequiredModal;
  }
  if (loginRequiredModal) {
    loginRequiredModal.onclick = (e) => {
      if (e.target === loginRequiredModal) closeLoginRequiredModal();
    };
  }
  
  // Save Required Modal
  const btnSaveRequiredSave = document.getElementById('btnSaveRequiredSave');
  const btnSaveRequiredCancel = document.getElementById('btnSaveRequiredCancel');
  const saveRequiredModal = document.getElementById('saveRequiredModal');
  
  if (btnSaveRequiredSave) {
    btnSaveRequiredSave.onclick = async () => {
      closeSaveRequiredModal();
      await saveTrip();
      // Apr√®s sauvegarde, ouvrir la modale de partage
      setTimeout(() => openShareModal(), 500);
    };
  }
  if (btnSaveRequiredCancel) {
    btnSaveRequiredCancel.onclick = closeSaveRequiredModal;
  }
  if (saveRequiredModal) {
    saveRequiredModal.onclick = (e) => {
      if (e.target === saveRequiredModal) closeSaveRequiredModal();
    };
  }
});

function closeShareModal() {
  $('shareModal').classList.remove('open');
  document.body.style.overflow = '';
}

async function loadExistingShare() {
  // Plus besoin - on g√©n√®re le lien √† la vol√©e
}

async function generateShareLink() {
  // Les v√©rifications user/sauvegarde sont d√©j√† faites dans openShareModal
  
  $('btnGenerateShare').innerHTML = `<span>${i18n('shareGenerating')}</span>`;
  $('btnGenerateShare').disabled = true;
  
  try {
    const tripId = state.tripId || (window.ORT_TRIPID ? window.ORT_TRIPID.get() : null);
    
    if (!tripId) {
      showToast('‚ùå Voyage non sauvegard√©');
      $('btnGenerateShare').innerHTML = `<span>${i18n('shareGenerate')}</span>`;
      $('btnGenerateShare').disabled = false;
      return;
    }
    
    // V√©rifier que state.steps existe
    if (!state.steps || state.steps.length === 0) {
      showToast('‚ùå Aucune √©tape √† partager');
      $('btnGenerateShare').innerHTML = `<span>${i18n('shareGenerate')}</span>`;
      $('btnGenerateShare').disabled = false;
      return;
    }
    
    console.log('[SHARE] üì§ Partage de', state.steps.length, '√©tapes');
    console.log('[SHARE] Titre:', state.title, 'Pays:', state.cc);
    
    // Utiliser ORT_SHARE si disponible
    if (window.ORT_SHARE && typeof ORT_SHARE.createShareLink === 'function') {
      const result = await ORT_SHARE.createShareLink(state, state.title || 'Voyage');
      
      console.log('[SHARE] R√©sultat ORT_SHARE:', result ? '‚úÖ' : '‚ùå');
      
      if (result && result.shareUrl) {
        // Pointer vers roadtrip_detail.html
        let shareUrl = result.shareUrl
          .replace('roadtrip_mobile.html', 'roadtrip_detail.html')
          .replace(/roadtrip_mobile(\?|$)/, 'roadtrip_detail.html$1');
        
        $('shareUrlInput').value = shareUrl;
        $('shareResult').style.display = '';
        $('btnGenerateShare').innerHTML = `<span>${i18n('shareRegenerate')}</span>`;
        showToast(i18n('linkCreated'));
      } else {
        throw new Error('√âchec cr√©ation lien');
      }
    } else {
      // Fallback: lien simple (ne fonctionnera que si le destinataire est connect√© au m√™me compte)
      console.warn('[SHARE] ORT_SHARE non disponible, fallback lien simple');
      const baseUrl = location.origin + location.pathname.replace('roadtrip_mobile.html', 'roadtrip_detail.html');
      const shareUrl = `${baseUrl}?tripId=${encodeURIComponent(tripId)}`;
      
      $('shareUrlInput').value = shareUrl;
      $('shareResult').style.display = '';
      $('btnGenerateShare').innerHTML = `<span>${i18n('shareRegenerate')}</span>`;
      showToast(i18n('linkCreated'));
    }
    
  } catch (e) {
    console.error('[SHARE] Erreur:', e);
    showToast('‚ùå ' + (e.message || 'Erreur'));
    $('btnGenerateShare').innerHTML = `<span>${i18n('shareGenerate')}</span>`;
  } finally {
    $('btnGenerateShare').disabled = false;
  }
}

function copyShareLink() {
  const url = $('shareUrlInput').value;
  if (url) {
    navigator.clipboard.writeText(url);
    showToast(i18n('linkCopied'));
  }
}

function nativeShare() {
  const url = $('shareUrlInput').value;
  if (url && navigator.share) {
    navigator.share({
      title: state.title || 'Mon roadtrip',
      text: `D√©couvre mon roadtrip : ${state.title}`,
      url: url
    });
  } else {
    copyShareLink();
  }
}

function exportPdf() {
  closeAllSheets();
  showToast('üìÑ Ouverture version imprimable...');
  
  // Ouvre la version desktop avec trigger PDF
  // Note: utilise roadtrip_detail_simple.html car c'est le fichier d√©ploy√©
  const sep = location.search ? '&' : '?';
  let desktopUrl = location.href
    .replace('roadtrip_mobile.html', 'roadtrip_detail_simple.html')
    .replace('roadtrip_mobile', 'roadtrip_detail_simple');
  desktopUrl += sep + 'action=pdf&mobile=0';
  window.open(desktopUrl, '_blank');
}

// currentUser() ‚Üí fourni par ort-utils.js

// === TOAST ===
function showToast(message, duration = 2500) {
  const toast = $('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

// ===== SCANNER MODULE =====
const SCANNER = {
  mode: null, // 'booking' ou 'document'
  photoBase64: null,
  result: null,
  
  API_BOOKING: '/.netlify/functions/parse-booking-photo',
  API_DOCUMENT: '/.netlify/functions/parse-document',
  
  async getToken() {
    if (window.firebase?.auth) {
      const user = firebase.auth().currentUser;
      if (user) return user.getIdToken();
    }
    return null;
  },
  
  open(mode) {
    this.mode = mode;
    this.photoBase64 = null;
    this.result = null;
    
    // Reset UI
    $('scanStep1').style.display = 'block';
    $('scanStep2').style.display = 'none';
    $('scanStep3').style.display = 'none';
    $('scanPreview').style.display = 'none';
    $('scanError').style.display = 'none';
    $('scannerInput').value = '';
    
    // Update titles
    if (mode === 'booking') {
      $('scannerTitle').textContent = 'üì∑ Scanner une r√©servation';
      $('scannerSubtitle').textContent = 'Photo de confirmation, email, PDF...';
    } else {
      $('scannerTitle').textContent = 'ü™™ Scanner un document';
      $('scannerSubtitle').textContent = 'Passeport, visa, permis...';
    }
    
    closeAllSheets();
    openSheet($('scannerSheet'));
  },
  
  handleFile(file) {
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      this.photoBase64 = e.target.result;
      $('scanPreviewImg').src = this.photoBase64;
      $('scanPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  },
  
  retake() {
    this.photoBase64 = null;
    $('scanPreview').style.display = 'none';
    $('scannerInput').value = '';
    $('scanError').style.display = 'none';
  },
  
  async analyze() {
    if (!this.photoBase64) return;
    
    const token = await this.getToken();
    if (!token) {
      this.showError('Connectez-vous pour utiliser le scanner');
      return;
    }
    
    // Show loading
    $('scanStep1').style.display = 'none';
    $('scanStep2').style.display = 'block';
    $('scanError').style.display = 'none';
    
    try {
      const url = this.mode === 'booking' ? this.API_BOOKING : this.API_DOCUMENT;
      const body = this.mode === 'booking' 
        ? { photo: this.photoBase64 }
        : { photo: this.photoBase64, save: false };
      
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(body)
      });
      
      const data = await res.json();
      
      if (!res.ok || !data.success) {
        throw new Error(data.error || 'Erreur analyse');
      }
      
      this.result = this.mode === 'booking' ? data.items?.[0] : data.data;
      this.renderResult();
      
    } catch (e) {
      console.error('[SCANNER]', e);
      $('scanStep2').style.display = 'none';
      $('scanStep1').style.display = 'block';
      this.showError(e.message);
    }
  },
  
  renderResult() {
    $('scanStep2').style.display = 'none';
    $('scanStep3').style.display = 'block';
    
    const r = this.result;
    let html = '';
    
    if (this.mode === 'booking') {
      const typeIcons = { hotel: 'üè®', flight: '‚úàÔ∏è', car: 'üöó', train: 'üöÜ', activity: 'üéØ', restaurant: 'üçΩÔ∏è' };
      html = `
        <div style="text-align:center;margin-bottom:12px;">
          <span style="font-size:2rem;">${typeIcons[r.type] || 'üìÑ'}</span>
          <div style="font-weight:700;font-size:1.1rem;margin-top:4px;">${r.name || 'R√©servation'}</div>
        </div>
        ${r.confirmation_number ? `<div class="scan-result-row"><span class="scan-result-label">N¬∞ confirmation</span><span class="scan-result-value">${r.confirmation_number}</span></div>` : ''}
        ${r.date_start ? `<div class="scan-result-row"><span class="scan-result-label">Date</span><span class="scan-result-value">${r.date_start}${r.date_end ? ' ‚Üí ' + r.date_end : ''}</span></div>` : ''}
        ${r.city ? `<div class="scan-result-row"><span class="scan-result-label">Lieu</span><span class="scan-result-value">${r.city}</span></div>` : ''}
        ${r.price?.amount ? `<div class="scan-result-row"><span class="scan-result-label">Prix</span><span class="scan-result-value">${r.price.amount} ${r.price.currency || ''}</span></div>` : ''}
      `;
    } else {
      const typeIcons = { passport: 'üõÇ', visa: 'üìë', id_card: 'ü™™', driving_license: 'üöó', health_card: 'üè•' };
      html = `
        <div style="text-align:center;margin-bottom:12px;">
          <span style="font-size:2rem;">${typeIcons[r.type] || 'üìÑ'}</span>
          <div style="font-weight:700;font-size:1.1rem;margin-top:4px;">${r.document_name || 'Document'}</div>
        </div>
        ${r.holder_name ? `<div class="scan-result-row"><span class="scan-result-label">Titulaire</span><span class="scan-result-value">${r.holder_name}</span></div>` : ''}
        ${r.document_number ? `<div class="scan-result-row"><span class="scan-result-label">Num√©ro</span><span class="scan-result-value">${r.document_number}</span></div>` : ''}
        ${r.expiry_date ? `<div class="scan-result-row"><span class="scan-result-label">Expiration</span><span class="scan-result-value">${r.expiry_date}</span></div>` : ''}
        ${r.country_code ? `<div class="scan-result-row"><span class="scan-result-label">Pays</span><span class="scan-result-value">${r.country_code}</span></div>` : ''}
      `;
    }
    
    $('scanResult').innerHTML = html;
  },
  
  showError(msg) {
    $('scanError').textContent = msg;
    $('scanError').style.display = 'block';
  },
  
  newScan() {
    this.photoBase64 = null;
    this.result = null;
    $('scanStep3').style.display = 'none';
    $('scanStep1').style.display = 'block';
    $('scanPreview').style.display = 'none';
    $('scannerInput').value = '';
    $('scanError').style.display = 'none';
  },
  
  async save() {
    if (!this.result) return;
    
    const token = await this.getToken();
    if (!token) {
      showToast('‚ùå Connexion requise');
      return;
    }
    
    try {
      if (this.mode === 'booking') {
        // Ajouter aux bookings du voyage
        if (!state.bookings) state.bookings = [];
        state.bookings.push(this.result);
        showToast('‚úÖ R√©servation ajout√©e !');
      } else {
        // Sauvegarder le document via API
        const res = await fetch(this.API_DOCUMENT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ photo: this.photoBase64, save: true })
        });
        
        const data = await res.json();
        if (!data.success) throw new Error(data.error);
        
        showToast('‚úÖ Document enregistr√© !');
      }
      
      closeAllSheets();
      
    } catch (e) {
      console.error('[SCANNER SAVE]', e);
      showToast('‚ùå ' + e.message);
    }
  }
};

// === BOOKING DETAIL FUNCTIONS ===
let currentBookingData = null;
// Cache de bookings pour event delegation (√©vite JSON dans onclick)
window._bookingCache = [];

function cacheBooking(booking) {
  const idx = window._bookingCache.length;
  window._bookingCache.push(booking);
  return idx;
}

function showBookingByIdx(idx) {
  const b = window._bookingCache[idx];
  if (b) showBookingDetail(b);
}

function showBookingDetail(booking) {
  console.log('[BOOKING] Show detail:', booking);
  currentBookingData = booking;
  
  const content = $('bookingDetailContent');
  const title = $('bookingDetailTitle');
  
  const icon = getCategoryIcon(booking.category);
  title.textContent = `${icon} ${booking.name || 'R√©servation'}`;
  
  // Construire le contenu d√©taill√©
  let html = '<div style="background:#f8f9fa;border-radius:12px;padding:16px;">';
  
  if (booking.category) {
    const categoryLabels = {
      flight: '‚úàÔ∏è Vol', car_rental: 'üöó Location voiture', insurance: 'üõ°Ô∏è Assurance',
      hotel: 'üè® H√©bergement', activity: 'üéØ Activit√©', restaurant: 'üçΩÔ∏è Restaurant',
      transport: 'üöå Transport', ferry: '‚õ¥Ô∏è Ferry', train: 'üöÜ Train'
    };
    html += `<div style="margin-bottom:12px;"><strong>Cat√©gorie:</strong> ${categoryLabels[booking.category] || booking.category}</div>`;
  }
  
  if (booking.provider) {
    html += `<div style="margin-bottom:12px;"><strong>Prestataire:</strong> ${booking.provider}</div>`;
  }
  
  if (booking.date_start) {
    html += `<div style="margin-bottom:12px;"><strong>Date d√©but:</strong> ${formatDate(booking.date_start)}</div>`;
  }
  
  if (booking.date_end) {
    html += `<div style="margin-bottom:12px;"><strong>Date fin:</strong> ${formatDate(booking.date_end)}</div>`;
  }
  
  if (booking.nights) {
    html += `<div style="margin-bottom:12px;"><strong>Nuits:</strong> ${booking.nights}</div>`;
  }
  
  if (booking.confirmation_number) {
    html += `<div style="margin-bottom:12px;"><strong>N¬∞ confirmation:</strong> <span style="font-family:monospace;background:#e2e8f0;padding:2px 6px;border-radius:4px;">${booking.confirmation_number}</span></div>`;
  }
  
  if (booking.price) {
    const price = typeof booking.price === 'object' ? booking.price.amount : booking.price;
    const currency = typeof booking.price === 'object' ? (booking.price.currency || '‚Ç¨') : '‚Ç¨';
    html += `<div style="margin-bottom:12px;"><strong>Prix:</strong> <span style="color:#059669;font-weight:600;">${parseFloat(price).toFixed(2)} ${currency}</span></div>`;
  }
  
  if (booking.notes) {
    html += `<div style="margin-bottom:12px;"><strong>Notes:</strong><br><span style="color:#666;">${booking.notes}</span></div>`;
  }
  
  if (booking.link) {
    html += `<div style="margin-top:16px;"><a href="${booking.link}" target="_blank" style="display:inline-block;padding:10px 16px;background:#113f7a;color:white;border-radius:8px;text-decoration:none;font-weight:500;">üîó Voir la r√©servation</a></div>`;
  }
  
  html += '</div>';
  
  content.innerHTML = html;
  
  // Restaurer les boutons Modifier/Supprimer
  if ($('btnEditBooking')) $('btnEditBooking').style.display = '';
  if ($('btnDeleteBooking')) $('btnDeleteBooking').style.display = '';
  
  // Ouvrir la sheet
  // Si on vient d'une autre sheet (√©tape), attendre sa fermeture
  const wasSheetOpen = document.querySelector('.bottom-sheet.show') !== null;
  closeAllSheets();
  
  // Aussi fermer la bookingDetailSheet si d√©j√† ouverte
  $('bookingDetailSheet').classList.remove('show');
  
  if (wasSheetOpen) {
    setTimeout(() => {
      $('bookingDetailSheet').classList.add('show');
      $('sheetOverlay').classList.add('show');
    }, 300);
  } else {
    $('bookingDetailSheet').classList.add('show');
    $('sheetOverlay').classList.add('show');
  }
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
  } catch(e) {
    return dateStr;
  }
}

async function editBooking() {
  if (!currentBookingData) return;
  
  const content = $('bookingDetailContent');
  const b = currentBookingData;
  
  // D√©terminer les champs selon la cat√©gorie
  const isHotel = b.category === 'hotel';
  const isFlight = b.category === 'flight';
  const isCarRental = b.category === 'car_rental';
  
  const priceVal = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : '';
  
  content.innerHTML = `
    <div style="background:#f8f9fa;border-radius:12px;padding:16px;">
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:0.85rem;color:#555;">Nom</label>
        <input type="text" id="editBookingName" value="${(b.name || '').replace(/"/g, '&quot;')}" 
          style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;margin-top:4px;box-sizing:border-box;">
      </div>
      ${b.provider !== undefined || isFlight || isCarRental ? `
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:0.85rem;color:#555;">Prestataire</label>
        <input type="text" id="editBookingProvider" value="${(b.provider || '').replace(/"/g, '&quot;')}" 
          style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;margin-top:4px;box-sizing:border-box;">
      </div>` : ''}
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <div style="flex:1;">
          <label style="font-weight:600;font-size:0.85rem;color:#555;">Date d√©but</label>
          <input type="date" id="editBookingDateStart" value="${b.date_start || ''}" 
            style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;margin-top:4px;box-sizing:border-box;">
        </div>
        <div style="flex:1;">
          <label style="font-weight:600;font-size:0.85rem;color:#555;">Date fin</label>
          <input type="date" id="editBookingDateEnd" value="${b.date_end || ''}" 
            style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;margin-top:4px;box-sizing:border-box;">
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <div style="flex:1;">
          <label style="font-weight:600;font-size:0.85rem;color:#555;">Prix (‚Ç¨)</label>
          <input type="number" id="editBookingPrice" value="${priceVal}" step="0.01"
            style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;margin-top:4px;box-sizing:border-box;">
        </div>
        ${isHotel ? `
        <div style="flex:1;">
          <label style="font-weight:600;font-size:0.85rem;color:#555;">Nuits</label>
          <input type="number" id="editBookingNights" value="${b.nights || ''}" min="1"
            style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;margin-top:4px;box-sizing:border-box;">
        </div>` : ''}
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:0.85rem;color:#555;">N¬∞ confirmation</label>
        <input type="text" id="editBookingRef" value="${(b.confirmation_number || b.reference || '').replace(/"/g, '&quot;')}" 
          style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;margin-top:4px;box-sizing:border-box;">
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:0.85rem;color:#555;">Lien</label>
        <input type="url" id="editBookingLink" value="${(b.link || '').replace(/"/g, '&quot;')}" placeholder="https://..."
          style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;margin-top:4px;box-sizing:border-box;">
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:0.85rem;color:#555;">Notes</label>
        <textarea id="editBookingNotes" rows="2" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;margin-top:4px;box-sizing:border-box;resize:vertical;">${b.notes || ''}</textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button onclick="cancelEditBooking()" style="flex:1;padding:12px;border:1px solid #ddd;border-radius:8px;background:#f0f0f0;font-weight:600;cursor:pointer;">Annuler</button>
        <button onclick="saveEditBooking()" style="flex:1;padding:12px;border:none;border-radius:8px;background:#113f7a;color:white;font-weight:600;cursor:pointer;">‚úÖ Enregistrer</button>
      </div>
    </div>
  `;
  
  // Masquer les boutons Modifier/Supprimer pendant l'√©dition
  $('btnEditBooking').style.display = 'none';
  $('btnDeleteBooking').style.display = 'none';
}

function cancelEditBooking() {
  // R√©-afficher le d√©tail en lecture
  if (currentBookingData) showBookingDetail(currentBookingData);
  $('btnEditBooking').style.display = '';
  $('btnDeleteBooking').style.display = '';
}

async function saveEditBooking() {
  if (!currentBookingData) return;
  
  const updated = { ...currentBookingData };
  updated.name = $('editBookingName')?.value || updated.name;
  updated.date_start = $('editBookingDateStart')?.value || updated.date_start;
  updated.date_end = $('editBookingDateEnd')?.value || updated.date_end;
  updated.confirmation_number = $('editBookingRef')?.value || '';
  updated.reference = updated.confirmation_number;
  updated.link = $('editBookingLink')?.value || '';
  updated.notes = $('editBookingNotes')?.value || '';
  
  const priceInput = $('editBookingPrice')?.value;
  if (priceInput) {
    updated.price = typeof updated.price === 'object' 
      ? { ...updated.price, amount: parseFloat(priceInput) }
      : parseFloat(priceInput);
  }
  
  if ($('editBookingProvider')) updated.provider = $('editBookingProvider').value || '';
  if ($('editBookingNights')) updated.nights = parseInt($('editBookingNights').value) || updated.nights;
  
  try {
    const tripId = state.tripId || localStorage.getItem('ORT_CURRENT_TRIP_ID');
    const stepIdx = currentBookingData.stepIndex;
    
    // Sauvegarder via ORT_TRIP_DATA
    if (window.ORT_TRIP_DATA && tripId) {
      const isTravelBooking = ['flight', 'car_rental', 'insurance', 'guide'].includes(updated.category);
      if (isTravelBooking) {
        await ORT_TRIP_DATA.updateTravelBooking(updated.id, updated);
      } else if (stepIdx !== undefined) {
        await ORT_TRIP_DATA.updateStepBooking(stepIdx, updated.id, updated);
      }
    }
    
    // Mettre √† jour dans globalBookingManager aussi
    if (typeof globalBookingManager !== 'undefined' && globalBookingManager && stepIdx !== undefined) {
      if (typeof globalBookingManager.updateBooking === 'function') {
        globalBookingManager.updateBooking(stepIdx, updated.id, updated);
      } else {
        // Fallback: remove + add
        if (typeof globalBookingManager.removeBooking === 'function') globalBookingManager.removeBooking(stepIdx, updated.id);
        if (typeof globalBookingManager.addBooking === 'function') globalBookingManager.addBooking(stepIdx, updated);
      }
    }
    
    // Mettre √† jour dans state.steps.bookings
    if (stepIdx !== undefined && state.steps[stepIdx]) {
      const stepBookings = state.steps[stepIdx].bookings || [];
      const bIdx = stepBookings.findIndex(b => b.id === updated.id || b.name === currentBookingData.name);
      if (bIdx >= 0) {
        state.steps[stepIdx].bookings[bIdx] = updated;
      }
    }
    
    showToast('‚úÖ R√©servation modifi√©e');
    currentBookingData = updated;
    showBookingDetail(updated);
    $('btnEditBooking').style.display = '';
    $('btnDeleteBooking').style.display = '';
    
    // Rafra√Æchir l'onglet r√©servations
    setTimeout(() => renderBookings(), 300);
    
  } catch(e) {
    console.error('[BOOKING EDIT]', e);
    showToast('‚ùå Erreur: ' + e.message);
  }
}

window.cancelEditBooking = cancelEditBooking;
window.saveEditBooking = saveEditBooking;

async function deleteBooking() {
  if (!currentBookingData) return;
  
  const confirmDelete = confirm(`Supprimer la r√©servation "${currentBookingData.name || 'cette r√©servation'}" ?`);
  if (!confirmDelete) return;
  
  try {
    const tripId = state.tripId || localStorage.getItem('ORT_CURRENT_TRIP_ID');
    
    if (window.ORT_TRIP_DATA && tripId) {
      // Supprimer via ORT_TRIP_DATA
      const bookingId = currentBookingData.id;
      const stepIndex = currentBookingData.stepIndex;
      
      if (currentBookingData.category === 'flight' || currentBookingData.category === 'car_rental' || currentBookingData.category === 'insurance') {
        // R√©servation voyage (travelBookings)
        await ORT_TRIP_DATA.removeTravelBooking(bookingId);
      } else if (stepIndex !== undefined) {
        // R√©servation d'√©tape
        await ORT_TRIP_DATA.removeStepBooking(stepIndex, bookingId);
      }
      
      showToast('‚úÖ R√©servation supprim√©e');
      closeAllSheets();
      
      // Rafra√Æchir l'affichage
      setTimeout(() => {
        if (typeof renderBudgetSheet === 'function') {
          renderBudgetSheet();
        }
        location.reload();
      }, 500);
      
    } else {
      showToast('‚ùå Impossible de supprimer - connexion requise');
    }
  } catch(e) {
    console.error('[BOOKING DELETE]', e);
    showToast('‚ùå Erreur: ' + e.message);
  }
}

// Expose globally
window.showBookingDetail = showBookingDetail;

// Booking detail event handlers
$('btnEditBooking').onclick = editBooking;
$('btnDeleteBooking').onclick = deleteBooking;

// Scanner event handlers
$('btnScanBooking').onclick = () => SCANNER.open('booking');
$('btnScanDocument').onclick = () => SCANNER.open('document');
$('scannerInput').onchange = (e) => SCANNER.handleFile(e.target.files[0]);
$('btnScanRetake').onclick = () => SCANNER.retake();
$('btnScanAnalyze').onclick = () => SCANNER.analyze();
$('btnScanNew').onclick = () => SCANNER.newScan();
$('btnScanSave').onclick = () => SCANNER.save();

// Expose
window.openStepSheet = openStepSheet;
window.navigateStep = navigateStep;
window.openVisitsModal = openVisitsModal;
window.closeVisitsModal = closeVisitsModal;
window.openActivitiesModal = openActivitiesModal;
window.closeActivitiesModal = closeActivitiesModal;
window.closeShareModal = closeShareModal;
window.generateShareLink = generateShareLink;
window.copyShareLink = copyShareLink;
window.nativeShare = nativeShare;
// √âdition visites/activit√©s
window.addVisit = addVisit;
window.editVisit = editVisit;
window.saveVisit = saveVisit;
window.deleteVisit = deleteVisit;
window.addActivity = addActivity;
window.editActivity = editActivity;
window.saveActivity = saveActivity;
window.deleteActivity = deleteActivity;

// ===== VISUALIZATION SUB-TABS MODULE =====
(function() {
  console.log('[VIZ] Initialisation du module Visualisation');
  
  // Index de l'√©tape courante PARTAG√â entre les 3 sous-onglets
  let vizCurrentStep = 0;
  
  // Filtre POI actuel pour Google Maps
  let currentMapFilter = '';
  
  // Gestion des sous-onglets
  document.querySelectorAll('.sub-tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const targetPanel = this.dataset.subpanel;
      
      // D√©sactiver tous les boutons et panels
      document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
      
      // Activer le bouton et panel cliqu√©s
      this.classList.add('active');
      const panel = document.getElementById(targetPanel);
      if (panel) panel.classList.add('active');
      
      console.log('[VIZ] Sous-onglet activ√©:', targetPanel);
      
      // Rafra√Æchir le contenu du panel activ√© avec l'√©tape courante
      renderCurrentStep();
    });
  });
  
  // Navigation - toutes les fl√®ches partagent le m√™me index
  document.querySelectorAll('.viz-nav-prev').forEach(btn => {
    btn.addEventListener('click', function() {
      if (vizCurrentStep > 0) {
        vizCurrentStep--;
        renderCurrentStep();
      }
    });
  });
  
  document.querySelectorAll('.viz-nav-next').forEach(btn => {
    btn.addEventListener('click', function() {
      if (state.steps && vizCurrentStep < state.steps.length - 1) {
        vizCurrentStep++;
        renderCurrentStep();
      }
    });
  });
  
  // Gestion des filtres POI Google Maps
  document.querySelectorAll('.gmap-filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // D√©sactiver tous les boutons
      document.querySelectorAll('.gmap-filter-btn').forEach(b => b.classList.remove('active'));
      // Activer celui cliqu√©
      this.classList.add('active');
      // Mettre √† jour le filtre
      currentMapFilter = this.dataset.filter || '';
      // Recharger la carte
      renderGoogleMap();
    });
  });
  
  // Mettre √† jour les headers de tous les panels
  function updateAllHeaders() {
    const steps = state.steps || [];
    const step = steps[vizCurrentStep];
    
    if (!step || steps.length === 0) {
      document.querySelectorAll('.viz-step-counter').forEach(el => el.textContent = '');
      document.querySelectorAll('.viz-step-name').forEach(el => el.textContent = 'Aucune √©tape');
      document.querySelectorAll('.viz-step-nights').forEach(el => el.textContent = '');
      document.querySelectorAll('.viz-nav-prev').forEach(btn => btn.disabled = true);
      document.querySelectorAll('.viz-nav-next').forEach(btn => btn.disabled = true);
      return;
    }
    
    const stepName = (typeof getCityDisplayName === 'function' ? getCityDisplayName(step, state.lang) : null) || step.name || `√âtape ${vizCurrentStep + 1}`;
    const nights = step.nights || 0;
    const nightsText = nights > 0 ? `üåô ${nights} nuit${nights > 1 ? 's' : ''}` : '';
    
    document.querySelectorAll('.viz-step-counter').forEach(el => {
      el.textContent = `√âtape ${vizCurrentStep + 1} / ${steps.length}`;
    });
    document.querySelectorAll('.viz-step-name').forEach(el => {
      el.textContent = stepName;
    });
    document.querySelectorAll('.viz-step-nights').forEach(el => {
      el.textContent = nightsText;
    });
    
    // Boutons de navigation
    document.querySelectorAll('.viz-nav-prev').forEach(btn => {
      btn.disabled = vizCurrentStep === 0;
    });
    document.querySelectorAll('.viz-nav-next').forEach(btn => {
      btn.disabled = vizCurrentStep === steps.length - 1;
    });
  }
  
  // Rendre le contenu de l'√©tape courante selon le panel actif
  function renderCurrentStep() {
    updateAllHeaders();
    
    const activePanel = document.querySelector('.sub-panel.active');
    if (!activePanel) return;
    
    const panelId = activePanel.id;
    
    if (panelId === 'subPanelSteps') {
      renderVisitsActivities();
    } else if (panelId === 'subPanelMap') {
      renderGoogleMap();
    } else if (panelId === 'subPanelHotels') {
      renderStay22();
    }
  }
  
  // Rendre les visites et activit√©s
  function renderVisitsActivities() {
    const container = document.getElementById('vizStepContent');
    if (!container) return;
    
    const steps = state.steps || [];
    if (steps.length === 0) {
      container.innerHTML = `
        <div class="viz-no-steps">
          <div class="viz-no-steps-icon">üìç</div>
          <div>Aucune √©tape dans cet itin√©raire</div>
        </div>
      `;
      return;
    }
    
    const step = steps[vizCurrentStep];
    if (!step) return;
    
    // R√©cup√©rer visites et activit√©s (m√™me logique que openStepSheet)
    let visits = Array.isArray(step.visits) ? step.visits : [];
    let activities = Array.isArray(step.activities) ? step.activities : [];
    
    // Si vides, chercher dans PLACES_INDEX
    const stepPlaceId = step.placeId || step.place_id;
    if (stepPlaceId && typeof PLACES_INDEX !== 'undefined' && PLACES_INDEX && PLACES_INDEX[stepPlaceId]) {
      const masterData = PLACES_INDEX[stepPlaceId];
      if (visits.length === 0 && masterData.visits) {
        visits = masterData.visits;
      }
      if (activities.length === 0 && masterData.activities) {
        activities = masterData.activities;
      }
    }
    
    // Construire le HTML
    let html = '';
    
    // Photo
    const allPhotos = typeof getAllStepPhotos === 'function' ? getAllStepPhotos(step) : [];
    const photoUrl = allPhotos.length > 0 ? allPhotos[0] : (typeof PLACEHOLDER_IMG !== 'undefined' ? PLACEHOLDER_IMG : '');
    if (photoUrl) {
      html += `<img class="viz-step-photo" src="${photoUrl}" alt="${step.name || ''}" onerror="this.style.display='none'">`;
    }
    
    // Section Visites
    if (visits.length > 0) {
      html += `
        <div class="viz-section">
          <div class="viz-section-title">üìç Visites (${visits.length})</div>
      `;
      visits.forEach((v, i) => {
        const text = typeof v === 'string' ? v : (v.text || v.description || v.name || '');
        const title = typeof v === 'object' && v.title ? v.title : null;
        html += `
          <div class="viz-item">
            ${title ? '<div class="viz-item-title">' + title + '</div>' : ''}
            <div class="viz-item-desc">${text}</div>
          </div>
        `;
      });
      html += '</div>';
    }
    
    // Section Activit√©s
    if (activities.length > 0) {
      html += `
        <div class="viz-section">
          <div class="viz-section-title">üéØ Activit√©s (${activities.length})</div>
      `;
      activities.forEach((a, i) => {
        const text = typeof a === 'string' ? a : (a.text || a.description || a.name || '');
        const title = typeof a === 'object' && a.title ? a.title : null;
        // Afficher practical_info si pr√©sent
        const pInfo = typeof a === 'object' && a.practical_info ? a.practical_info : null;
        let infoHtml = '';
        if (pInfo) {
          const infoParts = [];
          if (pInfo.duration) infoParts.push(`‚è±Ô∏è ${pInfo.duration}`);
          if (pInfo.difficulty) infoParts.push(`üí™ ${pInfo.difficulty}`);
          if (pInfo.best_time) infoParts.push(`üåÖ ${pInfo.best_time}`);
          if (pInfo.tip) infoParts.push(`üí° ${pInfo.tip}`);
          if (infoParts.length > 0) {
            infoHtml = `<div class="viz-item-info">${infoParts.join(' ‚Ä¢ ')}</div>`;
          }
        }
        html += `
          <div class="viz-item">
            ${title ? '<div class="viz-item-title">' + title + '</div>' : ''}
            <div class="viz-item-desc">${text}</div>
            ${infoHtml}
          </div>
        `;
      });
      html += '</div>';
    }
    
    // Section R√©servations (si ORT_TRIP_DATA disponible)
    if (window.ORT_TRIP_DATA) {
      const stepBookings = ORT_TRIP_DATA.getStepBookings(vizCurrentStep) || [];
      if (stepBookings.length > 0) {
        html += `
          <div class="viz-section viz-section-bookings">
            <div class="viz-section-title">üìã Mes r√©servations (${stepBookings.length})</div>
        `;
        stepBookings.forEach(b => {
          const icon = typeof getCategoryIcon === 'function' ? getCategoryIcon(b.category) : 'üìã';
          const price = b.price ? (typeof b.price === 'object' ? b.price.amount : b.price) : null;
          let dateStr = '';
          if (b.date_start) {
            const ds = new Date(b.date_start).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            if (b.date_end && b.date_end !== b.date_start) {
              const de = new Date(b.date_end).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
              dateStr = `${ds} ‚Üí ${de}`;
            } else {
              dateStr = ds;
            }
          }
          html += `
            <div class="viz-booking-item" onclick="showBookingByIdx(${cacheBooking(Object.assign({}, b, {stepIndex: vizCurrentStep}))})">
              <div class="viz-booking-icon">${icon}</div>
              <div class="viz-booking-info">
                <div class="viz-booking-name">${b.name || 'R√©servation'}</div>
                ${dateStr ? `<div class="viz-booking-dates">üìÖ ${dateStr}</div>` : ''}
              </div>
              ${price ? `<div class="viz-booking-price">${parseFloat(price).toFixed(0)} ‚Ç¨</div>` : ''}
            </div>
          `;
        });
        html += '</div>';
      }
    }
    
    // Message si aucun contenu
    if (visits.length === 0 && activities.length === 0) {
      html += '<div class="viz-empty">Pas de visites ni d\'activit√©s pour cette √©tape</div>';
    }
    
    container.innerHTML = html;
    container.scrollTop = 0;
    
    console.log('[VIZ] Visites/Activit√©s rendues pour √©tape', vizCurrentStep + 1);
  }
  
  // Rendre Google Maps
  function renderGoogleMap() {
    const wrapper = document.getElementById('gmapWrapper');
    if (!wrapper) return;
    
    const steps = state.steps || [];
    if (steps.length === 0) {
      wrapper.innerHTML = `
        <div class="gmap-placeholder">
          <div class="gmap-placeholder-icon">üó∫Ô∏è</div>
          <div>Aucune √©tape √† afficher</div>
        </div>
      `;
      return;
    }
    
    const step = steps[vizCurrentStep];
    if (!step) return;
    
    const lat = step.lat || step.latitude;
    const lng = step.lng || step.lon || step.longitude;
    const name = encodeURIComponent(step.name || 'Lieu');
    
    let mapUrl = '';
    
    if (currentMapFilter === 'visits') {
      // Afficher les lieux √† visiter depuis map_keywords
      const kws = step._mapKeywords || [];
      if (kws.length > 0) {
        const searchQuery = encodeURIComponent(kws.join(' | '));
        mapUrl = `https://maps.google.com/maps?q=${searchQuery}&output=embed`;
      } else if (lat && lng) {
        // Fallback: attractions near step
        const searchQuery = encodeURIComponent(`tourist attractions near ${step.name || ''}`);
        mapUrl = `https://maps.google.com/maps?q=${searchQuery}&output=embed`;
      }
    } else if (currentMapFilter) {
      // Recherche par cat√©gorie de POI pr√®s du lieu
      const searchQuery = encodeURIComponent(`${currentMapFilter} near ${step.name || ''}`);
      mapUrl = `https://maps.google.com/maps?q=${searchQuery}&output=embed`;
    } else {
      // Affichage du lieu simple
      if (lat && lng) {
        mapUrl = `https://maps.google.com/maps?q=${lat},${lng}&z=14&output=embed`;
      } else if (step.name) {
        mapUrl = `https://maps.google.com/maps?q=${name}&output=embed`;
      }
    }
    
    if (mapUrl) {
      wrapper.innerHTML = `<iframe src="${mapUrl}" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
    } else {
      wrapper.innerHTML = `
        <div class="gmap-placeholder">
          <div class="gmap-placeholder-icon">‚ùå</div>
          <div>Coordonn√©es non disponibles</div>
        </div>
      `;
    }
    
    console.log('[VIZ] Google Map rendu pour √©tape', vizCurrentStep + 1, 'filtre:', currentMapFilter || 'aucun');
  }
  
  // Rendre Stay22
  function renderStay22() {
    const wrapper = document.getElementById('hotelsWrapper');
    if (!wrapper) return;
    
    const steps = state.steps || [];
    if (steps.length === 0) {
      wrapper.innerHTML = `
        <div class="hotels-placeholder">
          <div class="hotels-placeholder-icon">üè®</div>
          <div>Aucune √©tape √† afficher</div>
        </div>
      `;
      return;
    }
    
    const step = steps[vizCurrentStep];
    if (!step) return;
    
    const lat = step.lat || step.latitude;
    const lng = step.lng || step.lon || step.longitude;
    const name = encodeURIComponent(step.name || 'Lieu');
    
    let widgetUrl = '';
    if (lat && lng) {
      widgetUrl = `https://www.stay22.com/embed/gm?lat=${lat}&lng=${lng}&title=${name}&aid=oneroadtrip`;
    } else if (step.name) {
      widgetUrl = `https://www.stay22.com/embed/gm?address=${name}&aid=oneroadtrip`;
    }
    
    if (widgetUrl) {
      wrapper.innerHTML = `<iframe src="${widgetUrl}" frameborder="0" width="100%" height="100%" allowfullscreen></iframe>`;
    } else {
      wrapper.innerHTML = `
        <div class="hotels-placeholder">
          <div class="hotels-placeholder-icon">‚ùå</div>
          <div>Impossible de charger les h√¥tels</div>
        </div>
      `;
    }
    
    console.log('[VIZ] Stay22 rendu pour √©tape', vizCurrentStep + 1);
  }
  
  // Exposer pour appel externe
  window.renderVizCurrentStep = renderCurrentStep;
  
  // Observer l'activation de l'onglet Visualisation
  const vizTabBtn = document.getElementById('tabViz');
  if (vizTabBtn) {
    vizTabBtn.addEventListener('click', function() {
      setTimeout(renderCurrentStep, 100);
    });
  }
  
  console.log('[VIZ] Module initialis√©');
})();

// Rafra√Æchir les bookings quand on revient sur cette page
// (apr√®s avoir √©t√© sur rt-booking-import par exemple)
let lastVisibilityTime = Date.now();

document.addEventListener('visibilitychange', async function() {
  if (document.visibilityState === 'visible') {
    const timeSinceHidden = Date.now() - lastVisibilityTime;
    // Si on revient apr√®s plus de 2 secondes, rafra√Æchir les bookings
    if (timeSinceHidden > 2000 && window.ORT_TRIP_DATA) {
      console.log('[LOG-CONTROLE][MOBILE] Retour sur la page, refresh des bookings...');
      try {
        // Recharger les donn√©es depuis Firestore
        const tripId = window.ORT_TRIPID?.get();
        if (tripId) {
          await ORT_TRIP_DATA.loadTrip(tripId);
          renderBookings();
          console.log('[LOG-CONTROLE][MOBILE] ‚úÖ Bookings rafra√Æchis');
        }
      } catch (e) {
        console.warn('[MOBILE] Erreur refresh bookings:', e);
      }
    }
  } else {
    lastVisibilityTime = Date.now();
  }
});

// Aussi sur pageshow (pour les navigations back/forward)
window.addEventListener('pageshow', async function(event) {
  if (event.persisted && window.ORT_TRIP_DATA) {
    console.log('[LOG-CONTROLE][MOBILE] Page restaur√©e depuis cache, refresh...');
    const tripId = window.ORT_TRIPID?.get();
    if (tripId) {
      try {
        await ORT_TRIP_DATA.loadTrip(tripId);
        renderBookings();
      } catch (e) {
        console.warn('[MOBILE] Erreur refresh pageshow:', e);
      }
    }
  }
});
</script>

<!-- Bouton flottant pour ajouter une r√©servation (visible sur l'onglet R√©servations) -->
<button id="btnAddBookingFab" style="position:fixed;bottom:100px;right:16px;width:56px;height:56px;border-radius:50%;background:#3b82f6;color:#fff;border:none;font-size:32px;font-weight:bold;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.4);z-index:200;display:none;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;" title="Ajouter une r√©servation">+</button>
<script>
(function() {
  const fab = document.getElementById('btnAddBookingFab');
  if (!fab) return;
  
  // Fonction pour naviguer vers l'import de r√©servations
  function goToBookingImport(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('[FAB] Clic d√©tect√©, navigation...');
    
    if (window.ORT_TRIPID) {
      window.ORT_TRIPID.navigateTo('rt-booking-import.html');
    } else {
      const tripId = new URLSearchParams(location.search).get('tripId') || '';
      window.location.href = 'rt-booking-import.html?tripId=' + encodeURIComponent(tripId);
    }
  }
  
  // √âcouter click ET touchend pour mobile
  fab.addEventListener('click', goToBookingImport);
  fab.addEventListener('touchend', function(e) {
    e.preventDefault();
    goToBookingImport(e);
  }, { passive: false });
  
  // Afficher/masquer le FAB selon l'onglet actif
  function updateFabVisibility() {
    const bookingsPanel = document.getElementById('bookingsPanel');
    if (fab && bookingsPanel) {
      const isActive = bookingsPanel.classList.contains('active');
      fab.style.display = isActive ? 'flex' : 'none';
      console.log('[FAB] Visibilit√© mise √† jour:', isActive ? 'visible' : 'masqu√©');
    }
  }
  
  // Observer les changements d'onglet
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      setTimeout(updateFabVisibility, 100);
    });
  });
  
  // V√©rifier au chargement et apr√®s un court d√©lai
  setTimeout(updateFabVisibility, 500);
  document.addEventListener('DOMContentLoaded', () => setTimeout(updateFabVisibility, 100));
})();
</script>
<script src="./js/ort-modals.js"></script>

<!-- Auth obligatoire -->
<script src="/js/ort-i18n-auth.js"></script>
<script src="/js/ort-auth-modal.js"></script>
<!-- Bypass auth gate pour liens partag√©s -->
<script>
if (new URLSearchParams(location.search).get('share')) {
  window._ORT_AUTH_GATE_BYPASS = true;
  console.log('[AUTH] üîì Bypass auth gate - mode partage');
}
</script>
<script src="/js/ort-auth-gate.js"></script>

<!-- MODALE H√îTELS MOBILE -->
<div id="hotelsModal" class="ort-modal">
  <div class="hotels-modal-content">
    <div class="hotels-modal-header">
      <h3 id="hotelsModalTitle" class="hotels-modal-title">Meilleurs h√¥tels</h3>
      <button onclick="closeHotelsModal()" class="hotels-modal-close" aria-label="Fermer">√ó</button>
    </div>
    <div id="hotelsModalContainer" class="hotels-modal-body">
      <div class="hotels-modal-loading">Chargement...</div>
    </div>
    <div class="hotels-modal-footer">
      <a id="hotelsModalChooseMap" href="#" target="_blank" rel="noopener">
        <span>üó∫Ô∏è</span> <span>Choisir sur la carte</span>
      </a>
    </div>
  </div>
</div>

<script src="/js/ort-hotels.js"></script>
<link rel="stylesheet" href="/css/ort-hotels.css">

<!-- Service Worker pour mode offline -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(r => {
    console.log('[SW] ‚úÖ Enregistr√©, scope:', r.scope);
  }).catch(e => console.warn('[SW] √âchec:', e));
}
</script>

<!-- ‚ïê‚ïê‚ïê R√âSUM√â IA - SCRIPT ‚ïê‚ïê‚ïê -->
<script>
(function(){
  var AI_API = '/.netlify/functions/parse-summary';

  function tAi(key) {
    var lang = (localStorage.getItem('lang') || document.documentElement.lang || 'fr').slice(0,2);
    if (window.ORT_I18N && window.ORT_I18N[key]) return window.ORT_I18N[key][lang] || window.ORT_I18N[key]['en'] || window.ORT_I18N[key]['fr'] || '';
    return '';
  }
  function escH(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

  // Bridge: find the mobile state object
  // The mobile script uses top-level "let state" which is NOT on window.
  // We find it by looking at known exposures or DOM data.
  function getMobileState() {
    // 1. If someone exposed it
    if (window._ortState) return window._ortState;
    // 2. Try window.state (works in some engines with let)
    if (window.state && window.state.steps && window.state.steps.length > 0) return window.state;
    // 3. Read from ORT_TRIPID and localStorage
    var tripId = null;
    if (window.ORT_TRIPID && window.ORT_TRIPID.get) tripId = window.ORT_TRIPID.get();
    if (!tripId) {
      var p = new URLSearchParams(location.search);
      tripId = p.get('tripId') || p.get('id') || null;
    }
    if (tripId) {
      try {
        var stored = localStorage.getItem('ort_trip_' + tripId);
        if (stored) {
          var parsed = JSON.parse(stored);
          if (parsed && parsed.steps && parsed.steps.length > 0) {
            parsed.tripId = parsed.tripId || parsed.id || tripId;
            // Reconstruct _originalItinId if missing
            console.log('[AI-SUMMARY] LS raw keys:', Object.keys(parsed).join(', '));
            console.log('[AI-SUMMARY] LS _originalItinId:', parsed._originalItinId);
            console.log('[AI-SUMMARY] LS itinId:', parsed.itinId);
            console.log('[AI-SUMMARY] LS baseItinerary:', JSON.stringify(parsed.baseItinerary || null));
            console.log('[AI-SUMMARY] LS _itinRef:', JSON.stringify(parsed._itinRef || null));
            if (!parsed._originalItinId) {
              if (parsed._itinRef) {
                parsed._originalItinId = (typeof parsed._itinRef === 'string') ? parsed._itinRef : (parsed._itinRef.itin || null);
              }
              if (!parsed._originalItinId && parsed.baseItinerary) {
                parsed._originalItinId = (typeof parsed.baseItinerary === 'string') ? parsed.baseItinerary : (parsed.baseItinerary.itin || null);
              }
            }
            console.log('[AI-SUMMARY] LS FINAL _originalItinId:', parsed._originalItinId);
            return parsed;
          }
        }
      } catch(e) { console.log('[AI-SUMMARY] localStorage parse error:', e.message); }
    }
    return null;
  }

  function getCatalogId(st) {
    if (!st) return null;
    var id = st._originalItinId || st.itinId || st.originalItinId || null;
    if (id) { console.log('[AI-SUMMARY] getCatalogId from state:', id); return id; }
    var p = new URLSearchParams(location.search);
    var itin = p.get('itin');
    if (itin) { console.log('[AI-SUMMARY] getCatalogId from URL:', itin); return itin; }
    var src = sessionStorage.getItem('ort_catalog_source') || '';
    if (src && src.indexOf('catalog::') === 0) {
      id = src.replace('catalog::', '');
      console.log('[AI-SUMMARY] getCatalogId from session:', id);
      return id;
    }
    var tid = st.tripId || '';
    if (tid) {
      try {
        var stored = localStorage.getItem('ort_trip_' + tid);
        if (stored) {
          var parsed = JSON.parse(stored);
          id = parsed._originalItinId || parsed.itinId || null;
          if (!id && parsed.baseItinerary) {
            id = (typeof parsed.baseItinerary === 'string') ? parsed.baseItinerary : (parsed.baseItinerary.itin || null);
          }
          if (!id && parsed._itinRef) {
            id = (typeof parsed._itinRef === 'string') ? parsed._itinRef : (parsed._itinRef.itin || null);
          }
          if (id) { console.log('[AI-SUMMARY] getCatalogId from LS trip:', id); return id; }
        }
      } catch(e) {}
    }
    if (tid.indexOf('::') >= 0) { return tid; }
    console.log('[AI-SUMMARY] getCatalogId ‚Üí null. _originalItinId:', st._originalItinId, '| tripId:', tid);
    return null;
  }

  function initAiLabels() {
    var g = function(id) { return document.getElementById(id); };
    if (g('aiSummaryTitleEl'))        g('aiSummaryTitleEl').textContent = tAi('aiSummaryTitle');
    if (g('aiSummaryPlaceholder'))    g('aiSummaryPlaceholder').textContent = tAi('aiSummaryEmpty');
    if (g('btnAiSummary'))            g('btnAiSummary').textContent = tAi('aiSummaryGenerate');
    if (g('aiSummaryItineraryTitle')) g('aiSummaryItineraryTitle').textContent = tAi('aiSummaryItinerary');
    if (g('btnCopyAiSummary'))        g('btnCopyAiSummary').textContent = tAi('aiSummaryCopy');
    if (g('btnShareAiNativeLabel'))   g('btnShareAiNativeLabel').textContent = (tAi('aiSummaryShare') || '').replace(/\uD83D\uDCE4\s?/, '');
    if (navigator.share && g('btnShareAiNative')) g('btnShareAiNative').style.display = 'inline-block';
    console.log('[AI-SUMMARY] Labels init OK');
  }

  window.toggleAiSummary = function() {
    var c = document.getElementById('aiSummaryContent');
    var ch = document.getElementById('aiSummaryChevron');
    if (!c) return;
    var open = c.style.display !== 'none';
    c.style.display = open ? 'none' : 'block';
    if (ch) ch.style.transform = open ? 'rotate(0deg)' : 'rotate(90deg)';
  };

  function getAiToken() {
    if (window.firebase && window.firebase.auth) {
      var u = firebase.auth().currentUser;
      if (u) return u.getIdToken();
    }
    return Promise.resolve(null);
  }

  function showAiError(key) {
    var p = document.getElementById('aiSummaryPlaceholder');
    if (p) { p.textContent = tAi(key); p.style.color = '#dc2626'; p.style.display = 'block'; }
  }

  function renderAiSummary(review, steps, fromCache, alerts) {
    var actions = document.getElementById('aiSummaryActions');
    var result = document.getElementById('aiSummaryResult');
    var placeholder = document.getElementById('aiSummaryPlaceholder');
    var reviewBox = document.getElementById('aiReviewContainer');
    var grid = document.getElementById('aiStepsGrid');
    var cacheTag = document.getElementById('aiSummaryCacheTag');

    if (actions) actions.style.display = 'none';
    if (placeholder) placeholder.style.display = 'none';
    if (result) result.style.display = 'block';

    // Panel stays collapsed

    // Alerts
    if (reviewBox) reviewBox.style.display = 'block';
    if (reviewBox && Array.isArray(alerts) && alerts.length > 0) {
      var alertsHtml = '<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:8px 12px;margin-bottom:10px;">' +
        '<div style="font-weight:700;color:#92400e;margin-bottom:4px;font-size:12px;">' + (tAi('aiSummaryAlerts') || '\uD83D\uDD0D Points de vigilance') + '</div>' +
        alerts.map(function(a) { return '<div style="color:#78350f;font-size:11px;margin:2px 0;">' + escH(a) + '</div>'; }).join('') +
        '</div>';
      reviewBox.innerHTML = alertsHtml;
    } else if (reviewBox) {
      reviewBox.innerHTML = '<div style="background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:6px 12px;margin-bottom:10px;color:#166534;font-size:12px;font-weight:600;">' + (tAi('aiSummaryNoAlerts') || '\u2705 Pas d\u0027alertes majeures sur cet itin\u00e9raire') + '</div>';
    }

    // Review
    if (reviewBox && Array.isArray(review)) {
      var icons = ['\uD83D\uDCAA', '\u26A0\uFE0F', '\uD83D\uDCA1'];
      reviewBox.innerHTML += '<div style="font-weight:700;color:#166534;margin-bottom:6px;font-size:13px;">' + tAi('aiSummaryReview') + '</div>' +
        review.slice(0, 3).map(function(line, i) { return '<div class="ai-review-line">' + (icons[i] || '') + ' ' + escH(line) + '</div>'; }).join('');
    }
    if (grid && Array.isArray(steps)) {
      var dayLabel = tAi('day') || 'Jour';
      grid.innerHTML = steps.map(function(s) {
        return '<div class="ai-step-card">' +
          '<div class="ai-step-day">' + dayLabel + ' ' + (s.day || '?') + '</div>' +
          '<div class="ai-step-city">' + escH(s.city || '') + '</div>' +
          '<div class="ai-step-highlights">' + escH(s.highlights || '') + '</div>' +
          (s.next ? '<div class="ai-step-next">\u2192 ' + escH(s.next) + '</div>' : '') +
        '</div>';
      }).join('');
    }
    if (cacheTag && fromCache) { cacheTag.style.display = 'inline'; cacheTag.textContent = tAi('aiSummaryCached'); }
    console.log('[AI-SUMMARY] Rendered! fromCache:', fromCache, 'alerts:', (alerts || []).length);
  }

  // ===== GENERATE =====
  window.generateAiSummary = function() {
    var btn = document.getElementById('btnAiSummary');
    var placeholder = document.getElementById('aiSummaryPlaceholder');
    var st = getMobileState();
    if (!st) { showAiError('aiSummaryErrorGeneric'); return; }
    var user = (window.firebase && window.firebase.auth && window.firebase.auth().currentUser) || null;
    if (!user) { showAiError('aiSummaryErrorAuth'); return; }

    var catalogId = getCatalogId(st);
    var tripId = st.tripId || '';
    console.log('[AI-SUMMARY] Generate ‚Äî catalogId:', catalogId, '| tripId:', tripId);
    if (!catalogId && (!tripId || tripId.indexOf('temp_') === 0)) { showAiError('aiSummaryErrorSave'); return; }
    if (!st.steps || !st.steps.length) return;

    btn.disabled = true; btn.textContent = tAi('aiSummaryLoading'); btn.style.opacity = '0.6';
    if (placeholder) placeholder.style.display = 'none';

    getAiToken().then(function(token) {
      if (!token) throw new Error('auth_required');
      var lang = (localStorage.getItem('lang') || 'fr').slice(0,2);
      var stepsPayload = st.steps.map(function(s) {
        return {
          name: s.name || s.place_id || '', nights: s.nights || 0,
          visits: Array.isArray(s.visits) ? s.visits.map(function(v){ return typeof v==='string'?v:v.text; }).filter(Boolean) : [],
          activities: Array.isArray(s.activities) ? s.activities.map(function(a){ return typeof a==='string'?a:a.text; }).filter(Boolean) : [],
          description: s.description || ''
        };
      });
      return fetch(AI_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ catalogId: catalogId || '', tripId: tripId || '', title: st.title || 'Road Trip', steps: stepsPayload, language: lang })
      });
    }).then(function(res) { return res.json(); })
    .then(function(data) {
      if (!data.success) {
        if (data.error === 'monthly_quota') throw new Error('quota');
        if (data.error === 'auth_required') throw new Error('auth');
        if (data.error === 'ai_overloaded') throw new Error('overloaded');
        throw new Error(data.error || 'unknown');
      }
      renderAiSummary(data.data.review, data.data.steps, data.data.fromCache, data.data.alerts);
    }).catch(function(e) {
      console.error('[AI-SUMMARY]', e);
      if (e.message === 'quota') showAiError('aiSummaryErrorQuota');
      else if (e.message === 'overloaded') showAiError('aiSummaryErrorOverloaded');
      else if (e.message === 'auth' || e.message === 'auth_required') showAiError('aiSummaryErrorAuth');
      else showAiError('aiSummaryErrorGeneric');
    }).then(function() {
      btn.disabled = false; btn.textContent = tAi('aiSummaryGenerate'); btn.style.opacity = '1';
    });
  };

  window.copyAiSummary = function() {
    var st = getMobileState() || {};
    var r = document.getElementById('aiReviewContainer');
    var g = document.getElementById('aiStepsGrid');
    var txt = (st.title || 'Road Trip') + '\n\n' + (r ? r.innerText : '') + '\n\n' + (g ? g.innerText : '');
    navigator.clipboard.writeText(txt).then(function() {
      var btn = document.getElementById('btnCopyAiSummary');
      if (btn) { var o = btn.textContent; btn.textContent = tAi('aiSummaryCopied'); setTimeout(function(){ btn.textContent = o; }, 1500); }
    }).catch(function(){});
  };

  function getShareText() {
    var st = getMobileState() || {};
    var title = st.title || 'Road Trip';
    var r = document.getElementById('aiReviewContainer');
    var g = document.getElementById('aiStepsGrid');
    return { title: title, text: title + '\n\n' + (r ? r.innerText : '') + '\n\n' + (g ? g.innerText : '') + '\n\n' + location.href, url: location.href };
  }

  window.shareAiSummary = function(mode) {
    var d = getShareText();
    var subject = tAi('aiSummaryShareSubject') || d.title;
    var encoded = encodeURIComponent(d.text);
    if (mode === 'whatsapp') { window.open('https://wa.me/?text=' + encoded, '_blank'); }
    else if (mode === 'sms') { window.open('sms:?body=' + encoded, '_blank'); }
    else if (mode === 'email') { window.open('mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encoded, '_blank'); }
    else if (mode === 'native' && navigator.share) { navigator.share({ title: subject, text: d.text, url: d.url }).catch(function(){}); }
  };

  function waitAndInit() {
    if (window.ORT_I18N && window.ORT_I18N.aiSummaryTitle) initAiLabels();
    else setTimeout(waitAndInit, 300);
  }
  waitAndInit();

  // ===== AUTO-LOAD CACHE (NO AUTH) =====
  (function() {
    var att = 0;
    var ck = setInterval(function() {
      att++;
      if (att > 60) { clearInterval(ck); console.log('[AI-SUMMARY] Gave up after 60 attempts'); return; }
      var st = getMobileState();
      if (!st || !st.steps || !st.steps.length) {
        if (att <= 3) console.log('[AI-SUMMARY] tick #' + att + ' ‚Äî waiting for state...');
        return;
      }
      var catalogId = getCatalogId(st);
      var tripId = st.tripId || '';
      if (!catalogId && !tripId) {
        if (att <= 3) console.log('[AI-SUMMARY] tick #' + att + ' ‚Äî no catalogId/tripId');
        return;
      }
      clearInterval(ck);
      console.log('[AI-SUMMARY] Auto-load ‚Äî catalogId:', catalogId, '| tripId:', tripId);

      fetch(AI_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ catalogId: catalogId || '', tripId: tripId || '', steps: [{ name: 'x', nights: 1 }], cacheOnly: true })
      }).then(function(res) { return res.json(); })
      .then(function(data) {
        console.log('[AI-SUMMARY] Cache response:', JSON.stringify(data).substring(0, 200));
        if (data.success && data.data && data.data.fromCache) {
          console.log('[AI-SUMMARY] Cache loaded!');
          renderAiSummary(data.data.review, data.data.steps, true, data.data.alerts);
        } else {
          console.log('[AI-SUMMARY] No cache found');
        }
      }).catch(function(e) {
        console.log('[AI-SUMMARY] Cache error:', e.message);
      });
    }, 2000);
  })();

  console.log('[AI-SUMMARY] Script loaded OK');
})();
</script>

</body>
</html>
