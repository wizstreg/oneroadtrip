<!doctype html>
<html lang="fr">
<head>
<!-- Google Analytics (lazy load apr√®s le chargement) -->
<script>
  window.addEventListener('load', () => {
    setTimeout(() => {
      const script = document.createElement('script');
      script.async = true;
      script.src = 'https://www.googletagmanager.com/gtag/js?id=G-JK3QGQGDDL';
      document.head.appendChild(script);
      
      window.dataLayer = window.dataLayer || [];
      window.gtag = function(){window.dataLayer.push(arguments);};
      window.gtag('js', new Date());
      window.gtag('config', 'G-JK3QGQGDDL', {
        'allow_ad_personalization_signals': false,
        'allow_google_signals': false
      });
    }, 2000);
  });
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=5.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<!-- S√©curit√©: Content Security Policy -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://www.googletagmanager.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' https: data:; font-src 'self' https://unpkg.com; connect-src 'self' https: https://ipapi.co;">
<meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<title>Itin√©raires de Road Trip Cl√©s en Main | OneRoadTrip</title>
<meta name="description" content="D√©couvrez 639 itin√©raires de road trip cl√©s en main dans 82 pays. Plans d√©taill√©s jour par jour, cartes interactives et conseils pratiques pour votre voyage.">
<meta name="keywords" content="road trip, itin√©raire voyage, road trip france, voyage organis√©, itin√©raire d√©taill√©">
<meta name="author" content="OneRoadTrip">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://www.oneroadtrip.com/">
<meta property="og:title" content="Itin√©raires de Road Trip Cl√©s en Main | OneRoadTrip">
<meta property="og:description" content="639 itin√©raires de road trip dans 82 pays. Plans d√©taill√©s jour par jour avec cartes interactives.">
<meta property="og:image" content="https://www.oneroadtrip.com/assets/image_index.webp">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Itin√©raires de Road Trip Cl√©s en Main | OneRoadTrip">
<meta name="twitter:description" content="639 itin√©raires de road trip dans 82 pays. Plans d√©taill√©s jour par jour.">

<!-- Preconnect pour acc√©l√©rer les CDN -->
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="dns-prefetch" href="https://unpkg.com">

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23113f7a'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-family='Arial' font-size='28' fill='white'%3EOR%3C/text%3E%3C/svg%3E">

<!-- Preload CSS critique -->
<link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" media="print" onload="this.media='all'">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" media="print" onload="this.media='all'">
<noscript>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
</noscript>

<!-- Preload JS critique -->
<link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" as="script">
<link rel="preload" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" as="script">

<!-- JSON-LD pour le SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "OneRoadTrip",
  "description": "Plateforme d'itin√©raires de road trip cl√©s en main dans le monde entier",
  "url": "https://www.oneroadtrip.com",
  "applicationCategory": "TravelApplication",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "EUR"
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "reviewCount": "639"
  }
}
</script>

<style>
/* Accessibilit√©: zones tactiles minimum 48x48px (recommandation Google) */
button, a[role="button"], input[type="button"], input[type="submit"], input[type="reset"], 
.btn, .btn-validate, [role="link"] {
  min-height: 48px;
  min-width: 48px;
  padding: 12px 16px !important;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* Am√©lioration des images: lazy loading et taille optimale */
img {
  loading: lazy;
  max-width: 100%;
  height: auto;
}

:root{ --bg:#f6f9fb; --ink:#113f7a; --acc:#113f7a; --card:#ffffff; --bd:#c3d6b6; --mut:#64748b; }
*{box-sizing:border-box}
html,body{margin:0;padding:0;background-color:#113f7a;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
/* Image de fond charg√©e en lazy */
body{background:linear-gradient(rgba(17,63,122,0.85),rgba(17,63,122,0.85)),url("assets/image_index.webp") center/cover fixed}
[dir="rtl"] body{ text-align:right }

header{position:sticky;top:0;z-index:10;background-color:#113f7a;color:#fff;padding:8px 16px;display:flex;flex-direction:column;gap:4px;border-bottom:2px solid rgba(255,255,255,0.2);box-shadow:0 2px 12px rgba(0,0,0,0.2)}
/* Image header en lazy */
header{background:url("assets/image_index.webp") center/cover no-repeat #113f7a}
.header-row-1,.header-row-2{display:flex;align-items:center;gap:12px;width:100%}
.header-row-2{justify-content:flex-end}
.brandlink{display:flex;align-items:center;gap:8px;color:#fff;text-decoration:none}
.brandlink img{width:40px;height:40px}
.brand{font-weight:800;font-size:16px}
.spacer{flex:1}
.langpick{appearance:none;background:#fff;border:1px solid #113f7a;border-radius:8px;padding:6px 8px;cursor:pointer;color:#113f7a;font-size:13px}
.auth{position:relative}
.btn{padding:8px 12px;border-radius:10px;border:1px solid #ffffff80;background:#ffffff1a;color:#fff;cursor:pointer;font-size:14px}
.btn:hover{background:#ffffff2b}
.btn:disabled{opacity:.6;cursor:not-allowed}
.auth-pop{position:absolute;right:0;top:44px;background:#fff;color:#333;border:1px solid #ddd;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:8px;display:none;min-width:260px;z-index:10001}
.auth-pop .btn{display:block;width:100%;margin:6px 0;background:#113f7a;border:1px solid #113f7a;color:#fff}
.auth-pop .btn.out{background:#fff;color:#113f7a}

main{max-width:1400px;margin:18px auto 40px;padding:0 16px}

/* Selection panel at top */
.selection-top{background:var(--card);border:2px solid var(--acc);border-radius:14px;padding:12px 16px;margin-bottom:12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.selection-top h3{margin:0;color:var(--acc);font-size:16px}
#selectedList{display:flex;flex-wrap:wrap;gap:10px}
.selected-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#e8f4f8;border-radius:8px;font-size:14px;font-weight:600}
.selected-item-title{color:var(--ink)}
.selected-item-remove{background:none;border:none;color:#dc2626;cursor:pointer;font-size:16px;padding:0}
.btn-validate{padding:8px 16px;background:#22c55e;color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px}
.btn-validate:hover{background:#16a34a}
.btn-validate:disabled{background:#9ca3af;cursor:not-allowed}

/* Map container */
.map-section{background:var(--card);border:1px solid var(--bd);border-radius:14px;overflow:hidden}
.map-header{background:var(--acc);color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.map-header h2{margin:0;font-size:20px}
.map-main{display:flex;height:70vh;min-height:500px}
.map-body{flex:1;position:relative}
#mapContainer{width:100%;height:100%}
.map-sidebar{width:320px;background:#f8f9fa;border-left:1px solid var(--bd);overflow-y:auto;padding:20px;position:relative}

/* Filters */
.filter-group{margin-bottom:16px}
.filter-group label{display:block;font-weight:600;margin-bottom:6px;color:var(--ink);font-size:14px}
.filter-select,.filter-input{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:8px;background:#fff;font-size:14px}
.filter-select:focus,.filter-input:focus{outline:2px solid var(--acc);outline-offset:2px}
.btn-reset{width:100%;padding:10px;background:var(--acc);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-top:8px}
.btn-reset:hover{background:#0d2f5a}
.filter-count{margin-top:16px;padding:12px;background:#fff;border:1px solid var(--bd);border-radius:8px;text-align:center;font-weight:700;color:var(--acc)}

/* Preview panel - fixed at top right of page */
.itin-preview{position:fixed;top:80px;right:16px;width:350px;max-height:calc((var(--vh, 1vh) * 100) - 100px);background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:9000;border:2px solid var(--acc);overflow-y:auto;display:none}
.itin-preview h3{margin:0 0 12px;color:var(--acc);font-size:18px;padding-right:30px}
.itin-preview .preview-close{position:absolute;top:12px;right:12px;background:none;border:none;color:var(--mut);font-size:20px;cursor:pointer}
.preview-info{margin-bottom:12px;color:var(--mut);font-size:14px}
.preview-cities{margin-bottom:12px;padding:10px;background:#f8f9fa;border-radius:8px;font-size:13px;line-height:1.4}
.btn-select{width:100%;padding:10px;background:var(--acc);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer}
.btn-select:hover{background:#0d2f5a}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.7);align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal-content{background:#fff;border-radius:14px;max-width:650px;width:90%;padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:modalSlideIn .3s ease}
@keyframes modalSlideIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-content h3{margin:0 0 16px;color:var(--acc);font-size:22px;font-weight:800}
.modal-group{margin-bottom:20px}
.modal-group label{display:block;font-weight:600;margin-bottom:8px;color:var(--ink)}
.modal-group input,.modal-group select{width:100%;padding:12px;border:1px solid var(--bd);border-radius:8px;font-size:15px}
.budget-chips{display:flex;flex-wrap:wrap;gap:10px}
.budget-chip{padding:10px 16px;border:2px solid var(--bd);border-radius:999px;background:#fff;color:var(--ink);cursor:pointer;font-weight:600;font-size:14px;transition:all .2s}
.budget-chip:hover{border-color:var(--acc);background:#f0f9ff}
.budget-chip.selected{background:var(--acc);color:#fff;border-color:var(--acc)}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
.modal-btn{padding:12px 24px;border-radius:8px;border:0;cursor:pointer;font-weight:700;font-size:15px}
.modal-btn.primary{background:var(--acc);color:#fff}
.modal-btn.primary:hover{background:#0d2f5a}
.modal-btn.secondary{background:#e0e0e0;color:#333}
.modal-btn.secondary:hover{background:#d0d0d0}

/* Clusters personnalis√©s */
.marker-cluster{background:transparent !important}
.marker-cluster div{background:rgba(30,136,229,0.85);border-radius:50%;font-weight:600;color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.3);border:2px solid #fff}
.marker-cluster-small div{width:28px;height:28px;font-size:10px}
.marker-cluster-medium div{background:rgba(46,125,50,0.85);width:34px;height:34px;font-size:11px}
.marker-cluster-large div{background:rgba(255,152,0,0.9);width:40px;height:40px;font-size:12px}

/* √âtoiles */
.star-marker{filter:drop-shadow(0 1px 3px rgba(0,0,0,0.4));transition:transform 0.15s ease}
.star-marker:hover{transform:scale(1.2)}
.star-marker.selected{filter:drop-shadow(0 2px 4px rgba(225,29,72,0.5))}

/* L√©gende carte */
.map-legend{position:absolute;bottom:20px;left:20px;background:rgba(255,255,255,0.95);border-radius:10px;padding:12px 14px;box-shadow:0 2px 10px rgba(0,0,0,0.2);z-index:1000;font-size:13px}
.map-legend .legend-title{font-weight:700;color:#113f7a;margin-bottom:8px;font-size:14px}
.map-legend .legend-item{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.map-legend .legend-dot{width:12px;height:12px;border-radius:50%;border:1.5px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.3)}
.map-legend .legend-count{margin-top:10px;padding-top:8px;border-top:1px solid #e0e0e0;font-weight:600;color:#113f7a}

/* Bouton flottant filtres (masqu√© sur desktop) */
.btn-toggle-filters{display:none}
.sidebar-overlay{display:none}
.sidebar-header{display:none}
.mobile-preview{display:none !important} /* Cach√©e sur desktop */

@media (max-width:900px){
  /* Mode mobile ultra-simplifi√© */
  html,body{overflow-x:hidden !important;width:100vw;max-width:100%}
  main{padding:0;margin:0;max-width:none;width:100%}
  .map-section{border-radius:0;border:none;height:calc(var(--vh, 1vh) * 100) !important}
  .map-header{display:none}
  header{position:static !important}
  .map-main{height:100%;display:flex}
  .map-body{flex:1;position:relative}
  #mapContainer{position:absolute;inset:0;width:100%;height:100%}
  
  /* CACHER TOUS LES FILTRES */
  .map-sidebar{display:none !important}
  .sidebar-overlay{display:none !important}
  .btn-toggle-filters{display:none !important}
  .map-legend{display:none !important}
  #itinPreview{display:none !important}
  
  /* Mini preview mobile SIMPLIFI√â */
  .mobile-preview{
    display:none !important;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:#fff;
    border-radius:12px 12px 0 0;
    padding:16px;
    box-shadow:0 -4px 20px rgba(0,0,0,0.3);
    z-index:9999;
    border-top:2px solid var(--acc);
    max-height:45vh;
    overflow-y:auto;
  }
  .mobile-preview.show{
    display:block !important;
  }
  .mobile-preview h4{
    margin:0 0 12px 0;
    color:var(--acc);
    font-size:18px;
    font-weight:700;
  }
  .mobile-preview-info{
    font-size:14px;
    color:var(--ink);
    margin-bottom:12px;
    line-height:1.5;
  }
  .mobile-preview-actions{
    display:flex;
    gap:8px;
  }
  .mobile-preview-btn{
    flex:1;
    padding:12px;
    border:none;
    border-radius:8px;
    font-weight:700;
    font-size:15px;
    cursor:pointer;
  }
  .mobile-preview-btn.cancel{
    background:#e5e7eb;
    color:var(--ink);
  }
  .mobile-preview-btn.confirm{
    background:var(--acc);
    color:#fff;
  }
}

</style>
</head>
<body>
<!-- Header ORT -->
<header id="site-header"></header>

<main>
  <!-- Map section -->
  <div class="map-section">
    <div class="map-header">
      <h2 id="mapTitle">Choisissez votre itin√©raire sur la carte</h2>
      <span id="filterCount" style="color:rgba(255,255,255,0.8);font-size:14px"></span>
    </div>
    <div class="map-main">
      <div class="map-body">
        <div id="mapContainer"></div>
        
        <!-- Bouton flottant filtres (mobile uniquement) -->
        <button id="btnToggleFilters" class="btn-toggle-filters">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="6" x2="20" y2="6"></line>
            <line x1="4" y1="12" x2="20" y2="12"></line>
            <line x1="4" y1="18" x2="14" y2="18"></line>
          </svg>
          Filtres
        </button>
        
        <!-- L√©gende sur la carte -->
        <div class="map-legend" id="mapLegend">
          <div class="legend-title" id="legendTitle">Itin√©raires</div>
          <div class="legend-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="#1565C0" stroke="#fff" stroke-width="2">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <span id="legendMustSee">Incontournable</span>
          </div>
          <div class="legend-item"><span class="legend-dot" style="background:#43A047"></span> <span id="legendRecommended">Recommand√©</span></div>
          <div class="legend-item"><span class="legend-dot" style="background:#7CB342"></span> <span id="legendDiscover">√Ä d√©couvrir</span></div>
          <div class="legend-item"><span class="legend-dot" style="background:#78909C"></span> <span id="legendStandard">Standard</span></div>
          <div class="legend-item"><span class="legend-dot" style="background:#e11d48"></span> <span id="legendSelected">S√©lectionn√©</span></div>
          <div class="legend-count" id="visibleCount">0 itin√©raires visibles</div>
        </div>
      </div>
      
      <!-- Overlay pour fermer sidebar mobile -->
      <div id="sidebarOverlay" class="sidebar-overlay"></div>
      
      <div class="map-sidebar" id="mapSidebar">
        <!-- Header mobile avec bouton fermer -->
        <div class="sidebar-header">
          <h3 id="sidebarTitle">Filtres</h3>
          <button id="btnCloseSidebar" class="btn-close-sidebar">‚úï</button>
        </div>
        
        <!-- Country jump at top -->
        <div class="filter-group" style="margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--acc)">
          <label for="countryJump" id="labelCountryJump" style="font-size:15px;color:var(--acc)">Aller au pays :</label>
          <select id="countryJump" class="filter-select">
            <option value="">-- Choisir --</option>
          </select>
        </div>
        
        <!-- Filters -->
        <div id="filtersContainer">
          <div class="filter-group">
            <label for="filterDays" id="labelDays">Dur√©e :</label>
            <select id="filterDays" class="filter-select">
              <option value="">Toutes</option>
              <option value="1-3">1-3 jours</option>
              <option value="4-7">4-7 jours</option>
              <option value="8-14">8-14 jours</option>
              <option value="15+">15+ jours</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterTheme" id="labelTheme">Th√®me :</label>
            <select id="filterTheme" class="filter-select">
              <option value="">Tous</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterSearch" id="labelSearch">Mot-cl√© :</label>
            <input type="text" id="filterSearch" class="filter-input" placeholder="Rechercher...">
          </div>
          <button id="btnReset" class="btn-reset">R√©initialiser</button>
        </div>
        
        <!-- Preview panel removed from here, now at body level -->
      </div>
    </div>
  </div>
</main>

<!-- Mini preview mobile -->
<div id="mobilePreview" class="mobile-preview">
  <h4 id="mobilePreviewTitle"></h4>
  <div class="mobile-preview-info" id="mobilePreviewInfo"></div>
  <div class="mobile-preview-actions">
    <button class="mobile-preview-btn cancel" id="mobilePreviewCancel">Annuler</button>
    <button class="mobile-preview-btn confirm" id="mobilePreviewConfirm">Valider</button>
  </div>
</div>

<!-- Preview panel - fixed position at top right -->
<div id="itinPreview" class="itin-preview">
  <button class="preview-close" onclick="closePreview()">‚úï</button>
  <h3 id="previewTitle"></h3>
  <div id="previewInfo" class="preview-info"></div>
  <div id="previewCities" class="preview-cities"></div>
  <button id="previewSelectBtn" class="btn-select">S√©lectionner</button>
</div>

<!-- Modal for trip configuration -->
<div id="configModal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="modalTitle">Configurez votre voyage</h3>
    <div class="modal-group">
      <label id="labelDepartDate">Date de d√©part :</label>
      <input type="date" id="inputDepartDate">
    </div>
    <div class="modal-group">
      <label id="labelNbDays">Nombre de jours souhait√©s :</label>
      <input type="number" id="inputNbDays" min="1" max="90">
    </div>
    <div class="modal-group">
      <label id="labelBudget">Budget h√¥tel (‚Ç¨/jour/personne) :</label>
      <div id="budgetChips" class="budget-chips"></div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" id="modalCancel">Annuler</button>
      <button class="modal-btn primary" id="modalConfirm">Valider</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
/* ===== DEBUG FLAG ===== */
const DEBUG = false;  // Mettre en true pour voir les logs

/* ===== I18N ===== */
const T = {
  fr: {
    selectionTitle: "Votre s√©lection",
    labelCountryJump: "Aller au pays :",
    btnValidate: "Valider ma s√©lection",
    mapTitle: "Choisissez votre itin√©raire sur la carte",
    labelDays: "Dur√©e :",
    labelTheme: "Th√®me :",
    labelSearch: "Mot-cl√© :",
    searchPlaceholder: "Rechercher...",
    btnReset: "R√©initialiser",
    filterCount_single: "itin√©raire trouv√©",
    filterCount_plural: "itin√©raires trouv√©s",
    days: "jours",
    km: "km",
    cities: "Villes travers√©es :",
    selectBtn: "S√©lectionner",
    rating: "Note",
    zoomHint: "Zoomez pour voir plus d'itin√©raires et choisissez celui qui vous convient",
    alertAlreadySelected: "D√©j√† s√©lectionn√©",
    legendTitle: "Itin√©raires",
    legendMustSee: "Incontournable",
    legendRecommended: "Recommand√©",
    legendDiscover: "√Ä d√©couvrir",
    legendStandard: "Standard",
    legendSelected: "S√©lectionn√©",
    visibleCount: "itin√©raires visibles",
    sidebarTitle: "Filtres",
    alertMaxSelection: "Maximum 1 itin√©raire",
    modalTitle: "Configurez votre voyage",
    labelDepartDate: "Date de d√©part :",
    labelNbDays: "Nombre de jours souhait√©s :",
    labelRythme: "Rythme :",
    rythmeSlow: "Lent",
    rythmeNormal: "Normal",
    rythmeFast: "Rapide",
    labelMaxHotels: "Changements d'h√¥tel maximum :",
    labelBudget: "Budget h√¥tel (‚Ç¨/jour/personne) :",
    modalCancel: "Annuler",
    modalConfirm: "Valider",
    mobilePreviewCancel: "Annuler",
    mobilePreviewConfirm: "Valider",
    budget_0_50: "0‚Äì50", budget_50_100: "50‚Äì100", budget_100_150: "100‚Äì150",
    budget_150_200: "150‚Äì200", budget_200_250: "200‚Äì250", budget_250_300: "250‚Äì300",
    budget_300_500: "300‚Äì500", budget_500plus: "500+",
    filterAllDays: "Toutes", filterAllThemes: "Tous",
    filter_days_1_3: "1-3 jours", filter_days_4_7: "4-7 jours",
    filter_days_8_14: "8-14 jours", filter_days_15plus: "15+ jours"
  },
  en: {
    selectionTitle: "Your selection",
    labelCountryJump: "Go to country:",
    btnValidate: "Validate my selection",
    mapTitle: "Choose your itinerary on the map",
    labelDays: "Duration:",
    labelTheme: "Theme:",
    labelSearch: "Keyword:",
    searchPlaceholder: "Search...",
    btnReset: "Reset",
    filterCount_single: "itinerary found",
    filterCount_plural: "itineraries found",
    days: "days",
    km: "km",
    cities: "Cities:",
    selectBtn: "Select",
    rating: "Rating",
    zoomHint: "Zoom in to see more itineraries and choose the one that suits you",
    alertAlreadySelected: "Already selected",
    legendTitle: "Itineraries",
    legendMustSee: "Must see",
    legendRecommended: "Recommended",
    legendDiscover: "Discover",
    legendStandard: "Standard",
    legendSelected: "Selected",
    visibleCount: "itineraries visible",
    sidebarTitle: "Filters",
    alertMaxSelection: "Maximum 1 itinerary",
    modalTitle: "Configure your trip",
    labelDepartDate: "Departure date:",
    labelNbDays: "Number of days:",
    labelRythme: "Pace:",
    rythmeSlow: "Slow",
    rythmeNormal: "Normal",
    rythmeFast: "Fast",
    labelMaxHotels: "Maximum hotel changes:",
    labelBudget: "Hotel budget (‚Ç¨/day/person):",
    modalCancel: "Cancel",
    modalConfirm: "Validate",
    mobilePreviewCancel: "Cancel",
    mobilePreviewConfirm: "Validate",
    budget_0_50: "0‚Äì50", budget_50_100: "50‚Äì100", budget_100_150: "100‚Äì150",
    budget_150_200: "150‚Äì200", budget_200_250: "200‚Äì250", budget_250_300: "250‚Äì300",
    budget_300_500: "300‚Äì500", budget_500plus: "500+",
    filterAllDays: "All", filterAllThemes: "All",
    filter_days_1_3: "1-3 days", filter_days_4_7: "4-7 days",
    filter_days_8_14: "8-14 days", filter_days_15plus: "15+ days"
  },
  it: {
    selectionTitle: "La tua selezione",
    labelCountryJump: "Vai al paese:",
    btnValidate: "Conferma la selezione",
    mapTitle: "Scegli il tuo itinerario sulla mappa",
    labelDays: "Durata:",
    labelTheme: "Tema:",
    labelSearch: "Parola chiave:",
    searchPlaceholder: "Cerca...",
    btnReset: "Ripristina",
    filterCount_single: "itinerario trovato",
    filterCount_plural: "itinerari trovati",
    days: "giorni",
    km: "km",
    cities: "Citt√†:",
    selectBtn: "Seleziona",
    rating: "Valutazione",
    zoomHint: "Ingrandisci per vedere pi√π itinerari e scegli quello pi√π adatto a te",
    alertAlreadySelected: "Gi√† selezionato",
    legendTitle: "Itinerari",
    legendMustSee: "Imperdibile",
    legendRecommended: "Consigliato",
    legendDiscover: "Da scoprire",
    legendStandard: "Standard",
    legendSelected: "Selezionato",
    visibleCount: "itinerari visibili",
    sidebarTitle: "Filtri",
    alertMaxSelection: "Massimo 1 itinerario",
    modalTitle: "Configura il tuo viaggio",
    labelDepartDate: "Data di partenza:",
    labelNbDays: "Numero di giorni:",
    labelRythme: "Ritmo:",
    rythmeSlow: "Lento",
    rythmeNormal: "Normale",
    rythmeFast: "Veloce",
    labelMaxHotels: "Cambi hotel massimi:",
    labelBudget: "Budget hotel (‚Ç¨/giorno/persona):",
    modalCancel: "Annulla",
    modalConfirm: "Conferma",
    mobilePreviewCancel: "Annulla",
    mobilePreviewConfirm: "Conferma",
    budget_0_50: "0‚Äì50", budget_50_100: "50‚Äì100", budget_100_150: "100‚Äì150",
    budget_150_200: "150‚Äì200", budget_200_250: "200‚Äì250", budget_250_300: "250‚Äì300",
    budget_300_500: "300‚Äì500", budget_500plus: "oltre 500",
    filterAllDays: "Tutte", filterAllThemes: "Tutti",
    filter_days_1_3: "1-3 giorni", filter_days_4_7: "4-7 giorni",
    filter_days_8_14: "8-14 giorni", filter_days_15plus: "15+ giorni"
  },
  es: {
    selectionTitle: "Tu selecci√≥n",
    labelCountryJump: "Ir al pa√≠s:",
    btnValidate: "Validar mi selecci√≥n",
    mapTitle: "Elige tu itinerario en el mapa",
    labelDays: "Duraci√≥n:",
    labelTheme: "Tema:",
    labelSearch: "Palabra clave:",
    searchPlaceholder: "Buscar...",
    btnReset: "Restablecer",
    filterCount_single: "itinerario encontrado",
    filterCount_plural: "itinerarios encontrados",
    days: "d√≠as",
    km: "km",
    cities: "Ciudades:",
    selectBtn: "Seleccionar",
    rating: "Puntuaci√≥n",
    zoomHint: "Haz zoom para ver m√°s itinerarios y elige el que te convenga",
    alertAlreadySelected: "Ya seleccionado",
    legendTitle: "Itinerarios",
    legendMustSee: "Imprescindible",
    legendRecommended: "Recomendado",
    legendDiscover: "Por descubrir",
    legendStandard: "Est√°ndar",
    legendSelected: "Seleccionado",
    visibleCount: "itinerarios visibles",
    sidebarTitle: "Filtros",
    alertMaxSelection: "M√°ximo 1 itinerario",
    modalTitle: "Configura tu viaje",
    labelDepartDate: "Fecha de salida:",
    labelNbDays: "N√∫mero de d√≠as:",
    labelRythme: "Ritmo:",
    rythmeSlow: "Lento",
    rythmeNormal: "Normal",
    rythmeFast: "R√°pido",
    labelMaxHotels: "Cambios de hotel m√°ximos:",
    labelBudget: "Presupuesto hotel (‚Ç¨/d√≠a/persona):",
    modalCancel: "Cancelar",
    modalConfirm: "Validar",
    mobilePreviewCancel: "Cancelar",
    mobilePreviewConfirm: "Validar",
    budget_0_50: "0‚Äì50", budget_50_100: "50‚Äì100", budget_100_150: "100‚Äì150",
    budget_150_200: "150‚Äì200", budget_200_250: "200‚Äì250", budget_250_300: "250‚Äì300",
    budget_300_500: "300‚Äì500", budget_500plus: "m√°s de 500",
    filterAllDays: "Todas", filterAllThemes: "Todos",
    filter_days_1_3: "1-3 d√≠as", filter_days_4_7: "4-7 d√≠as",
    filter_days_8_14: "8-14 d√≠as", filter_days_15plus: "15+ d√≠as"
  },
  pt: {
    selectionTitle: "Sua sele√ß√£o",
    labelCountryJump: "Ir para o pa√≠s:",
    btnValidate: "Validar minha sele√ß√£o",
    mapTitle: "Escolha seu itiner√°rio no mapa",
    labelDays: "Dura√ß√£o:",
    labelTheme: "Tema:",
    labelSearch: "Palavra-chave:",
    searchPlaceholder: "Pesquisar...",
    btnReset: "Redefinir",
    filterCount_single: "itiner√°rio encontrado",
    filterCount_plural: "itiner√°rios encontrados",
    days: "dias",
    km: "km",
    cities: "Cidades:",
    selectBtn: "Selecionar",
    rating: "Avalia√ß√£o",
    zoomHint: "Amplie para ver mais itiner√°rios e escolha o que mais lhe conv√©m",
    alertAlreadySelected: "J√° selecionado",
    legendTitle: "Itiner√°rios",
    legendMustSee: "Imperd√≠vel",
    legendRecommended: "Recomendado",
    legendDiscover: "Para descobrir",
    legendStandard: "Padr√£o",
    legendSelected: "Selecionado",
    visibleCount: "itiner√°rios vis√≠veis",
    sidebarTitle: "Filtros",
    alertMaxSelection: "M√°ximo 1 itiner√°rio",
    modalTitle: "Configure sua viagem",
    labelDepartDate: "Data de partida:",
    labelNbDays: "N√∫mero de dias:",
    labelRythme: "Ritmo:",
    rythmeSlow: "Lento",
    rythmeNormal: "Normal",
    rythmeFast: "R√°pido",
    labelMaxHotels: "Mudan√ßas de hotel m√°ximas:",
    labelBudget: "Or√ßamento hotel (‚Ç¨/dia/pessoa):",
    modalCancel: "Cancelar",
    modalConfirm: "Validar",
    mobilePreviewCancel: "Cancelar",
    mobilePreviewConfirm: "Validar",
    budget_0_50: "0‚Äì50", budget_50_100: "50‚Äì100", budget_100_150: "100‚Äì150",
    budget_150_200: "150‚Äì200", budget_200_250: "200‚Äì250", budget_250_300: "250‚Äì300",
    budget_300_500: "300‚Äì500", budget_500plus: "mais de 500",
    filterAllDays: "Todas", filterAllThemes: "Todos",
    filter_days_1_3: "1-3 dias", filter_days_4_7: "4-7 dias",
    filter_days_8_14: "8-14 dias", filter_days_15plus: "15+ dias"
  },
  ar: {
    selectionTitle: "ÿßÿÆÿ™Ÿäÿßÿ±ŸÉ",
    labelCountryJump: "ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ ÿßŸÑÿ®ŸÑÿØ:",
    btnValidate: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±",
    mapTitle: "ÿßÿÆÿ™ÿ± ŸÖÿ≥ÿßÿ±ŸÉ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©",
    labelDays: "ÿßŸÑŸÖÿØÿ©:",
    labelTheme: "ÿßŸÑŸÖŸàÿ∂Ÿàÿπ:",
    labelSearch: "ŸÉŸÑŸÖÿ© ŸÖŸÅÿ™ÿßÿ≠Ÿäÿ©:",
    searchPlaceholder: "ÿ®ÿ≠ÿ´...",
    btnReset: "ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ",
    filterCount_single: "ŸÖÿ≥ÿßÿ± ŸÖŸàÿ¨ŸàÿØ",
    filterCount_plural: "ŸÖÿ≥ÿßÿ±ÿßÿ™ ŸÖŸàÿ¨ŸàÿØÿ©",
    days: "ÿ£ŸäÿßŸÖ",
    km: "ŸÉŸÖ",
    cities: "ÿßŸÑŸÖÿØŸÜ:",
    selectBtn: "ÿßÿÆÿ™Ÿäÿßÿ±",
    rating: "ÿ™ŸÇŸäŸäŸÖ",
    zoomHint: "ŸÇŸÖ ÿ®ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ŸÑÿ±ÿ§Ÿäÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿßÿ±ÿßÿ™ ŸàÿßÿÆÿ™ÿ± ŸÖÿß ŸäŸÜÿßÿ≥ÿ®ŸÉ",
    alertAlreadySelected: "ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ±Ÿá ÿ®ÿßŸÑŸÅÿπŸÑ",
    legendTitle: "ÿßŸÑŸÖÿ≥ÿßÿ±ÿßÿ™",
    legendMustSee: "ŸÑÿß ŸäŸÅŸàÿ™ŸÉ",
    legendRecommended: "ŸÖŸàÿµŸâ ÿ®Ÿá",
    legendDiscover: "ŸÑŸÑÿßŸÉÿ™ÿ¥ÿßŸÅ",
    legendStandard: "ÿπÿßÿØŸä",
    legendSelected: "ŸÖÿ≠ÿØÿØ",
    visibleCount: "ŸÖÿ≥ÿßÿ±ÿßÿ™ ŸÖÿ±ÿ¶Ÿäÿ©",
    sidebarTitle: "ÿßŸÑÿ™ÿµŸÅŸäÿ©",
    alertMaxSelection: "ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 1 ŸÖÿ≥ÿßÿ±",
    modalTitle: "ŸÇŸÖ ÿ®ÿ™ŸÉŸàŸäŸÜ ÿ±ÿ≠ŸÑÿ™ŸÉ",
    labelDepartDate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ∫ÿßÿØÿ±ÿ©:",
    labelNbDays: "ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ:",
    labelRythme: "ÿßŸÑÿ•ŸäŸÇÿßÿπ:",
    rythmeSlow: "ÿ®ÿ∑Ÿäÿ°",
    rythmeNormal: "ÿπÿßÿØŸä",
    rythmeFast: "ÿ≥ÿ±Ÿäÿπ",
    labelMaxHotels: "ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿßŸÑŸÅŸÜÿØŸÇ:",
    labelBudget: "ŸÖŸäÿ≤ÿßŸÜŸäÿ© ÿßŸÑŸÅŸÜÿØŸÇ (‚Ç¨/ŸäŸàŸÖ/ÿ¥ÿÆÿµ):",
    modalCancel: "ÿ•ŸÑÿ∫ÿßÿ°",
    modalConfirm: "ÿ™ÿ£ŸÉŸäÿØ",
    mobilePreviewCancel: "ÿ•ŸÑÿ∫ÿßÿ°",
    mobilePreviewConfirm: "ÿ™ÿ£ŸÉŸäÿØ",
    budget_0_50: "0‚Äì50", budget_50_100: "50‚Äì100", budget_100_150: "100‚Äì150",
    budget_150_200: "150‚Äì200", budget_200_250: "200‚Äì250", budget_250_300: "250‚Äì300",
    budget_300_500: "300‚Äì500", budget_500plus: "ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 500",
    filterAllDays: "ÿßŸÑŸÉŸÑ", filterAllThemes: "ÿßŸÑŸÉŸÑ",
    filter_days_1_3: "1-3 ÿ£ŸäÿßŸÖ", filter_days_4_7: "4-7 ÿ£ŸäÿßŸÖ",
    filter_days_8_14: "8-14 ŸäŸàŸÖ", filter_days_15plus: "15+ ŸäŸàŸÖ"
  }
};

/* ===== GLOBAL STATE ===== */
let lang = 'fr';
let L_TEXT = T.fr;
let map = null;
let markersLayer = null;
let polylinesLayer = null;
let allItineraries = [];
let selectedItinerary = null;
let THEMES_DATA = null;
let itinLayers = new Map();
let previewPinned = false;
let placesDataByCountry = {}; // Cache des places avec ratings
let topRatedThreshold = 0; // Seuil de rating pour les 20% meilleurs
let placesPhotosIndex = null; // Index photos par lieu
let placesPhotosLoadingPromise = null; // Promise pour √©viter les appels en double
let countriesIndex = null; // Index des pays avec noms i18n

const COUNTRY_CODES = ['FR','IT','ES','PT','CH','GR','HR','DE','AT','BE','NL','GB','US','CA','MX','AR','BR','AU','NZ','JP','TH','MA','AE','EG','IL','JO','LB','OM','QA','SA','TR','IS','NO','SE','FI','DK','PL','CZ','SK','HU','RO','BG','RS','BA','ME','AL','MK','SI','LT','LV','EE','UA','RU','GE','AM','AZ','KZ','UZ','TM','KG','TJ','IN','CN','KR','TW','HK','MO','MY','SG','ID','PH','VN','LA','KH','MM','BD','PK','LK','NP','BT','MV','AF','IR','IQ','SY','YE','KW','BH','ZA','KE','TZ','UG','RW','ET','MA','TN','DZ','LY','SD','EG','GH','NG','CM','SN','ML','CI','BF','NE','TD','CF','CG','CD','AO','ZM','ZW','BW','NA','MZ','MW','MG','MU','SC','RE','YT','KM'];

/* ===== INIT ===== */
(async function init() {
  // Language detection
  const params = new URLSearchParams(location.search);
  lang = params.get('lang') || localStorage.getItem('lang') || 'fr';
  if (!T[lang]) lang = 'fr';
  localStorage.setItem('lang', lang);
  document.documentElement.lang = lang;
  document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
  L_TEXT = T[lang];

  // Sync avec le header ORT si pr√©sent
  const langSel = document.getElementById('langSel');
  if (langSel) {
    langSel.value = lang;
    langSel.addEventListener('change', async (e) => {
      const newLang = e.target.value;
      localStorage.setItem('lang', newLang);
      // FIX: Attendre que les donn√©es se rechargent avant de changer de page
      const url = new URL(location.href);
      url.searchParams.set('lang', newLang);
      location.href = url.toString();
    });
  }

  // Auth popup toggle
  const openAuth = document.getElementById('openAuth');
  const authPop = document.getElementById('authPop');
  if (openAuth && authPop) {
    openAuth.addEventListener('click', (e) => {
      e.stopPropagation();
      authPop.style.display = authPop.style.display === 'block' ? 'none' : 'block';
    });
    
    // Fermer quand on clique ailleurs (sauf sur openAuth et authPop)
    document.addEventListener('click', (e) => {
      if (authPop && e.target !== openAuth && e.target !== authPop && !authPop.contains(e.target)) {
        authPop.style.display = 'none';
      }
    });
    
    authPop.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  }

  applyTranslations();
  initMap();
  await loadThemes();
  await loadItineraries();
  setupFilters();
  populateCountryJump();  // ‚Üê FIX: Charger le dropdown pays
  setupMobileFilters();
  setupValidation();
})();

function applyTranslations() {
  document.getElementById('mapTitle').textContent = L_TEXT.mapTitle;
  document.getElementById('labelDays').textContent = L_TEXT.labelDays;
  document.getElementById('labelTheme').textContent = L_TEXT.labelTheme;
  document.getElementById('labelSearch').textContent = L_TEXT.labelSearch;
  document.getElementById('filterSearch').placeholder = L_TEXT.searchPlaceholder;
  document.getElementById('btnReset').textContent = L_TEXT.btnReset;
  document.getElementById('previewSelectBtn').textContent = L_TEXT.selectBtn;
  document.getElementById('labelCountryJump').textContent = L_TEXT.labelCountryJump;

  // Modal
  document.getElementById('modalTitle').textContent = L_TEXT.modalTitle;
  document.getElementById('labelDepartDate').textContent = L_TEXT.labelDepartDate;
  document.getElementById('labelNbDays').textContent = L_TEXT.labelNbDays;
  document.getElementById('labelBudget').textContent = L_TEXT.labelBudget;
  document.getElementById('modalCancel').textContent = L_TEXT.modalCancel;
  document.getElementById('modalConfirm').textContent = L_TEXT.modalConfirm;

  // L√©gende
  document.getElementById('legendTitle').textContent = L_TEXT.legendTitle;
  document.getElementById('legendMustSee').textContent = L_TEXT.legendMustSee;
  document.getElementById('legendRecommended').textContent = L_TEXT.legendRecommended;
  document.getElementById('legendDiscover').textContent = L_TEXT.legendDiscover;
  document.getElementById('legendStandard').textContent = L_TEXT.legendStandard;
  document.getElementById('legendSelected').textContent = L_TEXT.legendSelected;
  
  // Sidebar mobile
  const sidebarTitle = document.getElementById('sidebarTitle');
  if (sidebarTitle) sidebarTitle.textContent = L_TEXT.sidebarTitle;

  // Filter options
  const filterDays = document.getElementById('filterDays');
  filterDays.options[0].text = L_TEXT.filterAllDays;
  filterDays.options[1].text = L_TEXT.filter_days_1_3;
  filterDays.options[2].text = L_TEXT.filter_days_4_7;
  filterDays.options[3].text = L_TEXT.filter_days_8_14;
  filterDays.options[4].text = L_TEXT.filter_days_15plus;
}

function initMap() {
  map = L.map('mapContainer').setView([46.0, 8.0], 4);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '¬© CARTO ¬© OpenStreetMap',
    maxZoom: 20
  }).addTo(map);
  
  // Layer pour les polylines et √©tapes (non clusteris√©)
  polylinesLayer = L.layerGroup().addTo(map);
  
  // Layer pour les markers principaux des itin√©raires (clusteris√©)
  markersLayer = L.markerClusterGroup({
    maxClusterRadius: 40,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    disableClusteringAtZoom: 7,
    iconCreateFunction: function(cluster) {
      const count = cluster.getChildCount();
      let size = 'small';
      if (count > 50) size = 'large';
      else if (count > 20) size = 'medium';
      return L.divIcon({
        html: '<div>' + count + '</div>',
        className: 'marker-cluster marker-cluster-' + size,
        iconSize: L.point(40, 40)
      });
    }
  }).addTo(map);

  map.on('click', (e) => {
    const t = e.originalEvent?.target;
    // Sur mobile, TOUJOURS fermer tout
    if (isMobile()) {
      hardCloseOverlays();
      return;
    }
    // Desktop: ne pas fermer si clic sur marker/polyline ou sur preview
    if (t?.classList?.contains('leaflet-interactive')) return;
    if (!t || !t.closest || !t.closest('#itinPreview')) {
      closePreview();
    }
  });

  map.on('zoomend', () => {
    updateMarkersVisibility();
    setTimeout(updateVisibleCount, 100);
  });

  map.on('moveend', () => {
    updateMarkersVisibility();
    setTimeout(updateVisibleCount, 100);
  });
  
  // Fermer preview sur mobile quand on zoome/d√©place
  map.on('zoomstart movestart', () => {
    if (isMobile()) closePreview();
  });
  
  // FIX CRITIQUE: Forcer Leaflet √† recalculer sa taille
  setTimeout(() => {
    map.invalidateSize();
    if (DEBUG) console.log('Map invalidateSize appel√©');
  }, 100);
  
  // Recalculer aussi au resize
  window.addEventListener('resize', () => {
    if (map) map.invalidateSize();
  });
}

async function loadThemes() {
  const paths = [
    'data/Roadtripsprefabriques/countries/themes.i18n.json',
    './data/Roadtripsprefabriques/countries/themes.i18n.json'
  ];
  for (const path of paths) {
    try {
      const res = await fetch(path);
      if (res.ok) {
        THEMES_DATA = await res.json();
        populateThemeSelect();
        return;
      }
    } catch (e) {}
  }
}

function populateThemeSelect() {
  const select = document.getElementById('filterTheme');
  if (!select || !THEMES_DATA) return;
  select.innerHTML = `<option value="">${L_TEXT.filterAllThemes}</option>`;
  const sorted = [...THEMES_DATA.themes].sort((a, b) => (a.order || 0) - (b.order || 0));
  sorted.forEach(theme => {
    const opt = document.createElement('option');
    opt.value = theme.key;
    opt.textContent = theme.i18n[lang] || theme.label_fr;
    select.appendChild(opt);
  });
}

async function loadItineraries() {
  let countryList = [];
  const indexPaths = [
    'data/Roadtripsprefabriques/countries/countries.index.json',
    './data/Roadtripsprefabriques/countries/countries.index.json'
  ];
  for (const path of indexPaths) {
    try {
      const res = await fetch(path);
      if (res.ok) {
        const json = await res.json();
        countriesIndex = json; // Store full index with names
        countryList = Array.isArray(json) ? json : (json.countries || []);
        console.log(`Index pays charg√© depuis: ${path}`);
        console.log(`Contenu brut:`, json);
        break;
      }
    } catch (e) {
      console.error(`Erreur chargement ${path}:`, e);
    }
  }
  console.log(`=== DEBUG PAYS ===`);
  console.log(`Nombre de pays √† charger: ${countryList.length}`);
  console.log(`Pays:`, countryList.map(c => c.cc || c.code || c).join(', '));

  // Build country names lookup from index
  const countryNamesMap = {};
  countryList.forEach(c => {
    if (c.cc && c.names) {
      countryNamesMap[c.cc] = c.names;
    }
  });

  // CHARGEMENT PROGRESSIF INTELLIGENT
  const loadedCountries = new Set();
  let isLoadingBackground = false;
  
  // Fonction pour d√©terminer quels pays sont visibles
  function getVisibleCountries() {
    if (!map) return [];
    const zoom = map.getZoom();
    
    // Seuil zoom : charger seulement si zoom ‚â• 4
    if (zoom < 4) {
      console.log(`Zoom ${zoom} < 4 : chargement diff√©r√©`);
      return [];
    }
    
    const bounds = map.getBounds();
    const visible = [];
    
    countryList.forEach(obj => {
      const cc = String(obj.cc || obj.code || obj).toUpperCase();
      if (loadedCountries.has(cc)) return; // D√©j√† charg√©
      
      // Approximation simple : v√©rifier si le pays a des coords dans bounds
      // Pour l'instant, charger pays d'Europe + proche si zoom < 6
      if (zoom < 6) {
        // Europe centrale visible au d√©part
        const europeanCountries = ['FR', 'ES', 'IT', 'DE', 'GB', 'CH', 'AT', 'NL', 'BE', 'PT'];
        if (europeanCountries.includes(cc)) {
          visible.push(obj);
        }
      } else {
        // Zoom √©lev√© : charger tous les pays visibles
        visible.push(obj);
      }
    });
    
    return visible;
  }

  // Fonction de chargement avec fallback langue
  async function loadCountryItinerariesWithFallback(cc, ccLower, targetLang) {
    const languages = [targetLang, 'en', 'fr']; // Ordre de fallback
    
    for (const lang of languages) {
      // Chemins insensibles √† la casse
      const paths = [
        // Dossier MAJUSCULE + Fichier MAJUSCULE
        `data/Roadtripsprefabriques/countries/${cc}/${cc}.itins.modules-${lang}.json`,
        `./data/Roadtripsprefabriques/countries/${cc}/${cc}.itins.modules-${lang}.json`,
        // Dossier minuscule + Fichier MAJUSCULE
        `data/Roadtripsprefabriques/countries/${ccLower}/${cc}.itins.modules-${lang}.json`,
        `./data/Roadtripsprefabriques/countries/${ccLower}/${cc}.itins.modules-${lang}.json`,
        // Dossier minuscule + Fichier minuscule
        `data/Roadtripsprefabriques/countries/${ccLower}/${ccLower}.itins.modules-${lang}.json`,
        `./data/Roadtripsprefabriques/countries/${ccLower}/${ccLower}.itins.modules-${lang}.json`,
        // Dossier MAJUSCULE + Fichier minuscule
        `data/Roadtripsprefabriques/countries/${cc}/${ccLower}.itins.modules-${lang}.json`,
        `./data/Roadtripsprefabriques/countries/${cc}/${ccLower}.itins.modules-${lang}.json`
      ];
      
      for (const path of paths) {
        try {
          const res = await fetch(path, { cache: 'default' });
          if (res.ok) {
            const data = await res.json();
            if (lang !== targetLang) {
              console.log(`${cc}: Fallback ${targetLang} ‚Üí ${lang}`);
            }
            return data;
          }
        } catch (err) {
          // Continue avec le path suivant
        }
      }
    }
    
    // Si aucun fichier trouv√©, essayer ancien format sans suffixe langue (toutes variantes)
    console.warn(`${cc}: Aucun fichier trouv√© pour ${targetLang}/en/fr, essai ancien format`);
    const oldPaths = [
      `data/Roadtripsprefabriques/countries/${cc}/${cc}.itins.modules.json`,
      `./data/Roadtripsprefabriques/countries/${cc}/${cc}.itins.modules.json`,
      `data/Roadtripsprefabriques/countries/${ccLower}/${cc}.itins.modules.json`,
      `./data/Roadtripsprefabriques/countries/${ccLower}/${cc}.itins.modules.json`,
      `data/Roadtripsprefabriques/countries/${ccLower}/${ccLower}.itins.modules.json`,
      `./data/Roadtripsprefabriques/countries/${ccLower}/${ccLower}.itins.modules.json`
    ];
    
    for (const path of oldPaths) {
      try {
        const res = await fetch(path, { cache: 'default' });
        if (res.ok) {
          return await res.json();
        }
      } catch (err) {
        // Continue
      }
    }
    
    throw new Error(`Impossible de charger ${cc}`);
  }
  
  // Fonction pour charger un batch de pays
  async function loadCountryBatch(countries, label = '') {
    if (countries.length === 0) return [];
    
    console.log(`üîÑ Chargement ${label}: ${countries.map(c => c.cc || c.code).join(', ')}`);
    
    const promises = countries.map(async (obj) => {
      const cc = String(obj.cc || obj.code || obj).toUpperCase();
      const ccLower = cc.toLowerCase();
      
      if (loadedCountries.has(cc)) return []; // D√©j√† charg√©
      
      try {
        const data = await loadCountryItinerariesWithFallback(cc, ccLower, lang);
        loadedCountries.add(cc); // Marquer comme charg√©
        
        const countryName = countryNamesMap[cc]?.[lang] || cc;
        const itins = (data.itineraries || []).map(itin => ({
          ...itin,
          __id: itin.itin_id || itin.id || '',
          country: cc,
          countryName: countryName,
          steps: itin.estimated_days_base || itin.days_plan?.length || 0,
          estimatedDays: itin.estimated_days_base || itin.days_plan?.length || 7,
          totalDistance: calculateTotalDistance(itin),
          lat: computeCenter(itin).lat,
          lng: computeCenter(itin).lng,
          cities: extractCities(itin),
          avgRating: calculateAvgRating(itin, cc)
        }));
        console.log(`${cc}: ${itins.length} itin√©raires charg√©s`);
        return itins;
      } catch (e) {
        console.error(`${cc}: Erreur chargement -`, e.message);
        loadedCountries.add(cc);
        return [];
      }
    });

    return (await Promise.allSettled(promises))
      .filter(r => r.status === 'fulfilled')
      .map(r => r.value)
      .flat();
  }

  // √âTAPE 1 : Charger pays visibles (Europe au d√©marrage)
  const visibleCountries = getVisibleCountries();
  
  // Charger les places SEULEMENT pour les pays visibles
  await loadPlacesData(visibleCountries);
  
  const newItins = await loadCountryBatch(visibleCountries, 'pays visibles');
  allItineraries = newItins.filter(i => i.__id);
  
  console.log(`=== CHARGEMENT INITIAL ===`);
  console.log(`Pays charg√©s: ${loadedCountries.size}/${countryList.length}`);
  console.log(`Itin√©raires visibles: ${allItineraries.length}`);
  
  // Calculate threshold
  if (allItineraries.length > 0) {
    const sortedRatings = allItineraries.map(i => i.avgRating).sort((a, b) => b - a);
    const top20Index = Math.floor(sortedRatings.length * 0.2);
    topRatedThreshold = sortedRatings[top20Index] || 0;
  }
  
  // Afficher imm√©diatement
  displayMarkers(allItineraries);
  updateFilterCount(allItineraries.length);
  populateCountryJump();
  setTimeout(updateVisibleCount, 200);
  
  // √âTAPE 2 : Charger le reste en arri√®re-plan
  setTimeout(async () => {
    if (isLoadingBackground) return;
    isLoadingBackground = true;
    
    console.log(`üîÑ Chargement arri√®re-plan...`);
    
    const remainingCountries = countryList.filter(obj => {
      const cc = String(obj.cc || obj.code || obj).toUpperCase();
      return !loadedCountries.has(cc);
    });
    
    // Batch de 10 pays
    const batchSize = 10;
    for (let i = 0; i < remainingCountries.length; i += batchSize) {
      const batch = remainingCountries.slice(i, i + batchSize);
      
      // Charger les places pour ce batch AVANT de calculer les ratings
      await loadPlacesData(batch);
      
      const batchItins = await loadCountryBatch(batch, `batch ${Math.floor(i/batchSize) + 1}`);
      
      allItineraries.push(...batchItins.filter(it => it.__id));
      
      // Rafra√Æchir tous les 2 batchs
      if (i % (batchSize * 2) === 0) {
        displayMarkers(allItineraries);
        updateFilterCount(allItineraries.length);
      }
      
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    displayMarkers(allItineraries);
    updateFilterCount(allItineraries.length);
    isLoadingBackground = false;
    
    console.log(`‚úÖ Arri√®re-plan termin√©: ${allItineraries.length} itin√©raires`);
  }, 2000);
  
  // √âTAPE 3 : Charger √† la demande au zoom/pan
  map.on('moveend zoomend', async () => {
    const newVisible = getVisibleCountries();
    if (newVisible.length > 0 && !isLoadingBackground) {
      // Charger les places pour les nouveaux pays visibles
      await loadPlacesData(newVisible);
      
      const freshItins = await loadCountryBatch(newVisible, 'nouveaux visibles');
      allItineraries.push(...freshItins.filter(i => i.__id));
      displayMarkers(allItineraries);
      updateFilterCount(allItineraries.length);
    }
  });
}

function populateCountryJump() {
  const select = document.getElementById('countryJump');
  if (!select) return;
  
  // Get unique countries from itineraries
  const countriesMap = new Map();
  allItineraries.forEach(itin => {
    if (!countriesMap.has(itin.country)) {
      countriesMap.set(itin.country, {
        code: itin.country,
        name: itin.countryName,
        lat: itin.lat,
        lng: itin.lng
      });
    }
  });
  
  // Sort by name
  const countries = Array.from(countriesMap.values()).sort((a, b) => a.name.localeCompare(b.name));
  
  select.innerHTML = '<option value="">-- ' + (lang === 'ar' ? 'ÿßÿÆÿ™ÿ±' : lang === 'fr' ? 'Choisir' : lang === 'en' ? 'Choose' : lang === 'it' ? 'Scegli' : lang === 'es' ? 'Elegir' : 'Escolher') + ' --</option>';
  countries.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.code;
    opt.textContent = c.name;
    opt.dataset.lat = c.lat;
    opt.dataset.lng = c.lng;
    select.appendChild(opt);
  });
  
  // Jump to country on selection
  select.addEventListener('change', () => {
    const selected = select.options[select.selectedIndex];
    if (selected && selected.value) {
      const lat = parseFloat(selected.dataset.lat);
      const lng = parseFloat(selected.dataset.lng);
      if (!isNaN(lat) && !isNaN(lng)) {
        map.setView([lat, lng], 7);
      }
    }
  });
}

async function loadPlacesData(countryList) {
  // Utiliser la variable globale lang
  const promises = countryList.map(async (obj) => {
    const cc = String(obj.cc || obj.code || obj).toUpperCase();
    const ccLower = cc.toLowerCase();
    
    // Essayer avec suffixe langue (nouveau format) - insensible √† la casse
    const languages = [lang, 'en', 'fr'];
    for (const l of languages) {
      const paths = [
        // Dossier MAJUSCULE + Fichier minuscule
        `data/Roadtripsprefabriques/countries/${cc}/${ccLower}.places.master-${l}.json`,
        `./data/Roadtripsprefabriques/countries/${cc}/${ccLower}.places.master-${l}.json`,
        // Dossier minuscule + Fichier minuscule
        `data/Roadtripsprefabriques/countries/${ccLower}/${ccLower}.places.master-${l}.json`,
        `./data/Roadtripsprefabriques/countries/${ccLower}/${ccLower}.places.master-${l}.json`,
        // Dossier MAJUSCULE + Fichier MAJUSCULE
        `data/Roadtripsprefabriques/countries/${cc}/${cc}.places.master-${l}.json`,
        `./data/Roadtripsprefabriques/countries/${cc}/${cc}.places.master-${l}.json`,
        // Dossier minuscule + Fichier MAJUSCULE
        `data/Roadtripsprefabriques/countries/${ccLower}/${cc}.places.master-${l}.json`,
        `./data/Roadtripsprefabriques/countries/${ccLower}/${cc}.places.master-${l}.json`
      ];
      
      for (const path of paths) {
        try {
          const res = await fetch(path);
          if (res.ok) {
            const data = await res.json();
            placesDataByCountry[cc] = {};
            (data.places || []).forEach(p => {
              placesDataByCountry[cc][p.place_id] = p.rating || 5;
            });
            return;
          }
        } catch (e) {}
      }
    }
    
    // Fallback ancien format sans suffixe (toutes variantes)
    const oldPaths = [
      `data/Roadtripsprefabriques/countries/${cc}/${cc}.places.master.json`,
      `./data/Roadtripsprefabriques/countries/${cc}/${cc}.places.master.json`,
      `data/Roadtripsprefabriques/countries/${ccLower}/${cc}.places.master.json`,
      `./data/Roadtripsprefabriques/countries/${ccLower}/${cc}.places.master.json`,
      `data/Roadtripsprefabriques/countries/${ccLower}/${ccLower}.places.master.json`,
      `./data/Roadtripsprefabriques/countries/${ccLower}/${ccLower}.places.master.json`
    ];
    for (const path of oldPaths) {
      try {
        const res = await fetch(path);
        if (res.ok) {
          const data = await res.json();
          placesDataByCountry[cc] = {};
          (data.places || []).forEach(p => {
            placesDataByCountry[cc][p.place_id] = p.rating || 5;
          });
          return;
        }
      } catch (e) {}
    }
  });
  await Promise.allSettled(promises);
}

async function loadPlacesPhotosIndex() {
  if (placesPhotosIndex) return; // D√©j√† charg√©
  if (placesPhotosLoadingPromise) return placesPhotosLoadingPromise; // D√©j√† en cours
  
  placesPhotosLoadingPromise = (async () => {
    const paths = [
      'data/photos-json/photos_lieux.json',
      './data/photos-json/photos_lieux.json'
    ];
    for (const path of paths) {
      try {
        const res = await fetch(path);
        if (res.ok) {
          placesPhotosIndex = await res.json();
          return;
        }
      } catch (e) {}
    }
  })();
  
  return placesPhotosLoadingPromise;
}

function calculateAvgRating(itin, cc) {
  if (!itin.days_plan || !placesDataByCountry[cc]) return 5;
  const ratings = [];
  itin.days_plan.forEach(day => {
    if (day.night && day.night.place_id) {
      const rating = placesDataByCountry[cc][day.night.place_id];
      if (rating !== undefined) ratings.push(rating);
    }
  });
  if (ratings.length === 0) return 5;
  return ratings.reduce((a, b) => a + b, 0) / ratings.length;
}

function getPlaceKeysFromItin(itin) {
  const keys = new Set();
  const days = Array.isArray(itin.days_plan) ? itin.days_plan : [];
  for (const d of days) {
    if (d?.night?.place_id) keys.add(d.night.place_id);
    if (Array.isArray(d?.visits)) {
      d.visits.forEach(v => { if (v?.place_id) keys.add(v.place_id); });
    }
  }
  return Array.from(keys);
}

function calculateTotalDistance(itin) {
  if (!itin.days_plan || !Array.isArray(itin.days_plan)) return 0;
  let total = 0;
  itin.days_plan.forEach(day => {
    if (day.to_next_leg && day.to_next_leg.distance_km) {
      total += day.to_next_leg.distance_km;
    }
  });
  // Recalculate if zero (fallback: estimate from coords)
  if (total === 0 && itin.days_plan.length > 1) {
    for (let i = 0; i < itin.days_plan.length - 1; i++) {
      const c1 = itin.days_plan[i]?.night?.coords;
      const c2 = itin.days_plan[i + 1]?.night?.coords;
      if (c1 && c2) {
        total += haversineDistance(c1[0], c1[1], c2[0], c2[1]);
      }
    }
  }
  return Math.round(total);
}

function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function computeCenter(itin) {
  if (!itin.days_plan || itin.days_plan.length === 0) return { lat: 0, lng: 0 };
  let n = 0, sumLat = 0, sumLng = 0;
  itin.days_plan.forEach(day => {
    const c = day?.night?.coords;
    if (c && c.length === 2) {
      sumLat += c[0];
      sumLng += c[1];
      n++;
    }
  });
  return n > 0 ? { lat: sumLat / n, lng: sumLng / n } : { lat: 0, lng: 0 };
}

function extractCities(itin) {
  if (!itin.days_plan) return [];
  const cities = [];
  itin.days_plan.forEach(day => {
    if (day.night) {
      const name = (day.night.name_i18n && day.night.name_i18n[lang]) || 
                   (day.night.name_i18n && day.night.name_i18n['en']) || 
                   (day.night.place_id || '').split('::').pop().replace(/-/g, ' ');
      const cap = name.charAt(0).toUpperCase() + name.slice(1);
      if (!cities.includes(cap)) cities.push(cap);
    }
  });
  return cities;
}

function ratingToStars(rating) {
  // Multiplicateur de taille : x2 sur mobile, x1.5 sur desktop
  const sizeMultiplier = isMobile() ? 2.5 : 1.8;
  
  if (rating >= 8.8) return { stars: 5, color: '#1565C0', textColor: '#fff', radius: 8 * sizeMultiplier, isStar: true };  // √âtoile bleue
  if (rating >= 7.6) return { stars: 4, color: '#43A047', textColor: '#fff', radius: 6 * sizeMultiplier, isStar: false }; // Vert
  if (rating >= 6.1) return { stars: 3, color: '#7CB342', textColor: '#fff', radius: 5 * sizeMultiplier, isStar: false }; // Vert clair
  if (rating >= 3.1) return { stars: 2, color: '#78909C', textColor: '#fff', radius: 4 * sizeMultiplier, isStar: false }; // Gris-bleu
  return { stars: 1, color: '#B0BEC5', textColor: '#333', radius: 3 * sizeMultiplier, isStar: false }; // Gris clair
}

function createStarIcon(color, size, isSelected = false) {
  const finalColor = isSelected ? '#e11d48' : color;
  // Agrandir l'√©toile SVG pour qu'elle soit bien visible
  const starSize = size * 1.2; // 20% plus grand que le cercle
  return L.divIcon({
    html: `<svg width="${starSize}" height="${starSize}" viewBox="0 0 24 24" fill="${finalColor}" stroke="#fff" stroke-width="2">
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
    </svg>`,
    className: 'star-marker' + (isSelected ? ' selected' : ''),
    iconSize: [starSize, starSize],
    iconAnchor: [starSize/2, starSize/2]
  });
}

function displayMarkers(itineraries) {
  console.log(`=== DEBUG DISPLAY ===`);
  console.log(`Nombre d'itin√©raires re√ßus: ${itineraries.length}`);
  
  markersLayer.clearLayers();
  polylinesLayer.clearLayers();
  itinLayers.clear();

  let skippedCount = 0;
  let markersCreated = 0;
  
  itineraries.forEach(itin => {
    // Skip if no valid coordinates
    if (!itin.lat || !itin.lng || (itin.lat === 0 && itin.lng === 0)) {
      skippedCount++;
      console.log(`Ignor√© (coords invalides): ${itin.title || itin.itin_id} - lat=${itin.lat}, lng=${itin.lng}`);
      return;
    }
    
    markersCreated++;
    let polyline = null;
    let cityMarkers = [];
    const starInfo = ratingToStars(itin.avgRating);

    if (itin.days_plan && itin.days_plan.length > 1) {
      const coords = [];
      itin.days_plan.forEach(day => {
        const c = day?.night?.coords;
        if (c && c.length === 2) coords.push([c[0], c[1]]);
      });

      if (coords.length >= 2) {
        polyline = L.polyline(coords, {
          color: '#00bfff',
          weight: 3,
          opacity: 0
        }).addTo(polylinesLayer);

        coords.forEach((coord) => {
          const cm = L.circleMarker(coord, {
            radius: 5,
            fillColor: '#ffd166',
            color: '#fff',
            weight: 1,
            opacity: 0,
            fillOpacity: 0
          }).addTo(polylinesLayer);
          cm.on('click', () => selectItinerary(itin));
          cityMarkers.push(cm);
        });

        polyline.on('mouseover', () => {
          if (isMobile()) return; // Pas de hover sur mobile
          if (!previewPinned) showPreview(itin);
        });
        polyline.on('mouseout', () => {
          if (!selectedItinerary || selectedItinerary.itin_id !== itin.itin_id) {
            polyline.setStyle({ opacity: 0, weight: 3 });
            cityMarkers.forEach(cm => cm.setStyle({ opacity: 0, fillOpacity: 0 }));
          }
        });
        polyline.on('click', (e) => {
          e.originalEvent?.stopPropagation();
          previewPinned = true;
          showPreview(itin);
        });
      }
    }

    let marker;
    if (starInfo.isStar) {
      marker = L.marker([itin.lat, itin.lng], {
        icon: createStarIcon(starInfo.color, 20)
      }).addTo(markersLayer);
    } else {
      marker = L.circleMarker([itin.lat, itin.lng], {
        radius: starInfo.radius,
        fillColor: starInfo.color,
        color: '#fff',
        weight: 1.5,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(markersLayer);
    }
    marker.starInfo = starInfo;

    marker.on('mouseover', () => {
      if (isMobile()) return; // Pas de hover sur mobile
      if (!previewPinned) showPreview(itin);
    });

    marker.on('mouseout', () => {
      setTimeout(() => {
        if (previewPinned) return;
        const preview = document.getElementById('itinPreview');
        if (preview && !preview.matches(':hover')) {
          closePreview();
        }
        if (!selectedItinerary || selectedItinerary.itin_id !== itin.itin_id) {
          if (polyline) polyline.setStyle({ opacity: 0 });
          cityMarkers.forEach(cm => cm.setStyle({ opacity: 0, fillOpacity: 0 }));
        }
      }, 100);
    });

    marker.on('click', (e) => {
      e.originalEvent?.stopPropagation();
      previewPinned = true;
      showPreview(itin);
    });

    itinLayers.set(itin.itin_id, { polyline, cityMarkers, mainMarker: marker, starInfo });
  });

  console.log(`Markers cr√©√©s: ${markersCreated}`);
  console.log(`Ignor√©s (coords invalides): ${skippedCount}`);
  console.log(`Total dans itinLayers: ${itinLayers.size}`);

  // Afficher le nombre d'itin√©raires avec markers cr√©√©s
  updateFilterCount(itineraries.length - skippedCount);
  updateSelectionStyles();
}

function updateMarkersVisibility() {
  if (!map) return;

  setTimeout(() => {
    itinLayers.forEach(({ mainMarker, starInfo }, id) => {
      if (!mainMarker) return;
      const isSel = selectedItinerary && selectedItinerary.itin_id === id;
      
      if (starInfo.isStar) {
        mainMarker.setIcon(createStarIcon(starInfo.color, 20, isSel));
      } else if (mainMarker.setStyle) {
        mainMarker.setStyle({ 
          opacity: 1, 
          fillOpacity: isSel ? 0.9 : 0.8,
          fillColor: isSel ? '#e11d48' : starInfo.color,
          radius: isSel ? starInfo.radius + 2 : starInfo.radius
        });
      }
    });
  }, 10);
}

function updateVisibleCount() {
  if (!map) return;
  const bounds = map.getBounds();
  let count = 0;
  itinLayers.forEach(({ mainMarker }) => {
    if (mainMarker) {
      const pos = mainMarker.getLatLng();
      if (bounds.contains(pos)) count++;
    }
  });
  const countEl = document.getElementById('visibleCount');
  if (countEl) {
    const text = L_TEXT.visibleCount || 'itin√©raires visibles';
    countEl.textContent = `${count} ${text}`;
  }
}

function isMobile() {
  return window.matchMedia("(max-width: 900px)").matches;
}

function showPreview(itin) {
  // Charger les photos si pas d√©j√† charg√©es
  if (!placesPhotosIndex && !placesPhotosLoadingPromise) {
    loadPlacesPhotosIndex().catch(e => console.warn('Erreur chargement photos:', e));
  }
  // Cacher tous les circuits pr√©c√©dents
  itinLayers.forEach(({ polyline, cityMarkers }, id) => {
    if (id !== itin.itin_id) { // Sauf celui qu'on va afficher
      if (polyline) polyline.setStyle({ opacity: 0 });
      if (cityMarkers) cityMarkers.forEach(cm => cm.setStyle({ opacity: 0, fillOpacity: 0 }));
    }
  });
  
  // Afficher le circuit de l'itin√©raire courant
  const currentLayer = itinLayers.get(itin.itin_id);
  if (currentLayer) {
    if (currentLayer.polyline) currentLayer.polyline.setStyle({ opacity: 0.7 });
    if (currentLayer.cityMarkers) currentLayer.cityMarkers.forEach(cm => cm.setStyle({ opacity: 1, fillOpacity: 0.9 }));
  }
  
  // Sur mobile, afficher mini preview au lieu de la modale directement
  if (isMobile()) {
    const mobilePreview = document.getElementById('mobilePreview');
    document.getElementById('mobilePreviewTitle').textContent = itin.title;
    
    const starInfo = ratingToStars(itin.avgRating);
    const starsDisplay = '‚òÖ'.repeat(starInfo.stars) + '‚òÜ'.repeat(5 - starInfo.stars);
    
    document.getElementById('mobilePreviewInfo').innerHTML = `
      <div><strong>${itin.steps}</strong> ${L_TEXT.days} ‚Ä¢ <strong>${itin.totalDistance}</strong> ${L_TEXT.km}</div>
      <div>${itin.dept_name || itin.countryName}</div>
      <div style="color:${starInfo.color};font-size:14px;margin-top:4px">${starsDisplay}</div>
    `;
    
    document.getElementById('mobilePreviewCancel').textContent = L_TEXT.mobilePreviewCancel;
    document.getElementById('mobilePreviewConfirm').textContent = L_TEXT.mobilePreviewConfirm;
    
    document.getElementById('mobilePreviewCancel').onclick = () => {
      mobilePreview.classList.remove('show');
    };
    
    document.getElementById('mobilePreviewConfirm').onclick = () => {
      mobilePreview.classList.remove('show');
      selectItinerary(itin);
    };
    
    mobilePreview.classList.add('show');
    return;
  }
  
  const preview = document.getElementById('itinPreview');
  document.getElementById('previewTitle').textContent = itin.title;
  
  const starInfo = ratingToStars(itin.avgRating);
  const starsDisplay = '‚òÖ'.repeat(starInfo.stars) + '‚òÜ'.repeat(5 - starInfo.stars);
  
  document.getElementById('previewInfo').innerHTML = `
    <div><strong>${itin.steps}</strong> ${L_TEXT.days} ‚Ä¢ <strong>${itin.totalDistance}</strong> ${L_TEXT.km}</div>
    <div>${itin.dept_name || itin.countryName}</div>
    <div style="color:${starInfo.color};font-size:16px;margin-top:4px;font-weight:600">${starsDisplay}</div>
  `;
  
  // Photo : 1 seule pour chargement rapide
  let firstPhoto = null;
  if (placesPhotosIndex) {
    const placeKeys = getPlaceKeysFromItin(itin);
    for (const k of placeKeys) {
      const arr = placesPhotosIndex[k]?.photos;
      if (Array.isArray(arr) && arr[0]) {
        firstPhoto = arr[0];
        break;
      }
    }
  }
  
  let citiesHtml = `<strong>${L_TEXT.cities}</strong><br>${(itin.cities || []).join(' ‚Üí ')}`;
  if (firstPhoto && typeof firstPhoto === 'string' && !firstPhoto.includes('${')) {
    const proxyUrl = `https://wsrv.nl/?url=${encodeURIComponent(firstPhoto)}&w=400&h=150&fit=cover&output=webp`;
    citiesHtml += `<div style="margin-top:10px;"><img src="${proxyUrl}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;" alt="Photo" loading="lazy"></div>`;
  }
  document.getElementById('previewCities').innerHTML = citiesHtml;
  
  document.getElementById('previewSelectBtn').onclick = () => selectItinerary(itin);
  preview.style.display = 'block';
  preview.style.visibility = 'visible'; // Force visible au cas o√π hardCloseOverlays l'aurait cach√©
}

window.closePreview = function() {
  previewPinned = false;
  const preview = document.getElementById('itinPreview');
  preview.style.display = 'none';
  
  // Fermer aussi la modale mobile si elle est ouverte
  const mobilePreview = document.getElementById('mobilePreview');
  if (mobilePreview) {
    mobilePreview.classList.remove('show');
  }
  
  polylinesLayer.eachLayer(l => {
    if (l instanceof L.Polyline && !(l instanceof L.CircleMarker)) {
      l.setStyle({ opacity: 0 });
    } else if (l instanceof L.CircleMarker && l.options.radius === 5) {
      l.setStyle({ opacity: 0, fillOpacity: 0 });
    }
  });
  updateSelectionStyles();
};

// Hide preview only on mouseout if not pinned
function hidePreviewIfNotPinned() {
  if (!previewPinned) {
    closePreview();
  }
}

function selectItinerary(itin) {
  selectedItinerary = itin;
  closePreview();
  previewPinned = false;
  
  // Ouvrir la modale de configuration
  document.getElementById('inputNbDays').value = itin.estimatedDays || 7;
  document.getElementById('configModal').classList.add('show');
}

function updateSelectionStyles() {
  const selId = selectedItinerary ? selectedItinerary.itin_id : null;
  itinLayers.forEach(({ polyline, cityMarkers, mainMarker, starInfo }, id) => {
    const isSel = id === selId;
    if (polyline) {
      polyline.setStyle({
        color: isSel ? '#e11d48' : '#00bfff',
        weight: isSel ? 4 : 3,
        opacity: isSel ? 0.95 : 0
      });
    }
    (cityMarkers || []).forEach(cm => {
      cm.setStyle({
        fillColor: isSel ? '#e11d48' : '#ffd166',
        opacity: isSel ? 1 : 0,
        fillOpacity: isSel ? 0.95 : 0
      });
    });
    if (mainMarker && starInfo) {
      if (starInfo.isStar) {
        const starSize = isSel ? 28 : 20; // Plus gros quand s√©lectionn√©
        mainMarker.setIcon(createStarIcon(starInfo.color, starSize, isSel));
      } else if (mainMarker.setStyle) {
        const bonusSize = isMobile() ? 4 : 3; // Plus gros sur mobile
        mainMarker.setStyle({ 
          fillColor: isSel ? '#e11d48' : starInfo.color,
          radius: isSel ? starInfo.radius + bonusSize : starInfo.radius
        });
      }
    }
  });
}

function setupFilters() {
  const filterDays = document.getElementById('filterDays');
  const filterTheme = document.getElementById('filterTheme');
  const filterSearch = document.getElementById('filterSearch');
  const btnReset = document.getElementById('btnReset');

  const applyFilters = () => {
    let filtered = allItineraries;
    const days = filterDays.value;
    const theme = filterTheme.value;
    const search = filterSearch.value.toLowerCase().trim();

    if (days) {
      if (days === '1-3') filtered = filtered.filter(i => i.steps >= 1 && i.steps <= 3);
      else if (days === '4-7') filtered = filtered.filter(i => i.steps >= 4 && i.steps <= 7);
      else if (days === '8-14') filtered = filtered.filter(i => i.steps >= 8 && i.steps <= 14);
      else if (days === '15+') filtered = filtered.filter(i => i.steps >= 15);
    }

    if (theme && THEMES_DATA) {
      filtered = filtered.filter(i => matchesTheme(i, theme));
    }

    if (search) {
      filtered = filtered.filter(i => {
        const txt = [i.title, i.countryName, i.dept_name, ...(i.cities || [])].join(' ').toLowerCase();
        return txt.includes(search);
      });
    }

    displayMarkers(filtered);
  };

  filterDays.addEventListener('change', applyFilters);
  filterTheme.addEventListener('change', applyFilters);
  filterSearch.addEventListener('input', applyFilters);
  btnReset.addEventListener('click', () => {
    filterDays.value = '';
    filterTheme.value = '';
    filterSearch.value = '';
    applyFilters();
  });
}

function matchesTheme(itin, themeKey) {
  if (!THEMES_DATA) return false;
  const themeObj = THEMES_DATA.themes.find(t => t.key === themeKey);
  if (!themeObj) return false;

  const synonyms = themeObj.synonyms || [];
  const tokens = new Set();

  // Collect tokens from itin
  const pushTokens = (v) => {
    if (!v) return;
    if (Array.isArray(v)) { v.forEach(pushTokens); return; }
    String(v).split(/[|,;/]/).forEach(s => {
      const t = s.trim().toLowerCase();
      if (t) tokens.add(t);
    });
  };
  pushTokens(itin.themes);
  pushTokens(itin.tags);
  pushTokens(itin.categories);
  if (itin.title) {
    itin.title.toLowerCase().split(/[^\p{L}\p{N}]+/u).forEach(w => {
      if (w && w.length >= 3) tokens.add(w);
    });
  }

  for (const s of synonyms) {
    if (tokens.has(s)) return true;
    for (const t of tokens) {
      if (t.includes(s)) return true;
    }
  }
  return false;
}

function updateFilterCount(count) {
  const text = count === 1 ? L_TEXT.filterCount_single : L_TEXT.filterCount_plural;
  document.getElementById('filterCount').textContent = `(${count} ${text})`;
}

// √âTAPE 3: Neutraliser TOUT overlay/preview fant√¥me
function hardCloseOverlays() {
  const preview = document.getElementById('itinPreview');
  const mobilePreview = document.getElementById('mobilePreview');
  const overlay = document.getElementById('sidebarOverlay');
  const sidebar = document.getElementById('mapSidebar');
  
  // Sur mobile, fermer la mobile preview
  if (isMobile() && mobilePreview) {
    mobilePreview.classList.remove('show');
  }
  
  if (preview) preview.style.display = 'none';
  if (overlay) overlay.style.display = 'none';
  if (sidebar) sidebar.style.display = 'none';
  
  previewPinned = false;
  document.body.style.overflow = '';
}

function setupMobileFilters() {
  // Sur mobile, on ne montre rien du tout - les filtres sont compl√®tement cach√©s
  if (isMobile()) {
    // Juste fermer les overlays si pr√©sents
    const overlay = document.getElementById('sidebarOverlay');
    const sidebar = document.getElementById('mapSidebar');
    if (overlay) overlay.style.display = 'none';
    if (sidebar) sidebar.style.display = 'none';
    return;
  }
  
  const btnToggle = document.getElementById('btnToggleFilters');
  const btnClose = document.getElementById('btnCloseSidebar');
  const sidebar = document.getElementById('mapSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (!btnToggle || !sidebar || !overlay) return;
  
  sidebar.classList.add('ready');
  
  const openSidebar = () => {
    sidebar.classList.add('open');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
  };
  
  const closeSidebar = () => {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  };
  
  btnToggle.addEventListener('click', openSidebar);
  btnClose?.addEventListener('click', closeSidebar);
  overlay.addEventListener('click', closeSidebar);
  
  document.getElementById('countryJump')?.addEventListener('change', () => {
    if (window.innerWidth <= 900) closeSidebar();
  });
}

function setupValidation() {
  const modal = document.getElementById('configModal');
  const btnCancel = document.getElementById('modalCancel');
  const btnConfirm = document.getElementById('modalConfirm');
  const chipsContainer = document.getElementById('budgetChips');

  // Set default date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('inputDepartDate').value = today;

  // Generate budget chips
  const budgetRanges = ['0-50', '50-100', '100-150', '150-200', '200-250', '250-300', '300-500', '500+'];
  const budgetLabels = {
    '0-50': L_TEXT.budget_0_50, '50-100': L_TEXT.budget_50_100,
    '100-150': L_TEXT.budget_100_150, '150-200': L_TEXT.budget_150_200,
    '200-250': L_TEXT.budget_200_250, '250-300': L_TEXT.budget_250_300,
    '300-500': L_TEXT.budget_300_500, '500+': L_TEXT.budget_500plus
  };

  let selectedBudgets = [];
  budgetRanges.forEach(range => {
    const chip = document.createElement('button');
    chip.type = 'button';
    chip.className = 'budget-chip';
    chip.textContent = budgetLabels[range];
    chip.dataset.value = range;
    chip.addEventListener('click', () => {
      chip.classList.toggle('selected');
      if (chip.classList.contains('selected')) {
        selectedBudgets.push(range);
      } else {
        selectedBudgets = selectedBudgets.filter(b => b !== range);
      }
    });
    chipsContainer.appendChild(chip);
  });

  btnCancel.addEventListener('click', () => {
    modal.classList.remove('show');
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.classList.remove('show');
  });

  btnConfirm.addEventListener('click', () => {
    if (!selectedItinerary) return;
    
    const departDate = document.getElementById('inputDepartDate').value;
    const nbDays = document.getElementById('inputNbDays').value;
    const budget = selectedBudgets.join(',') || 'all';

    const id = selectedItinerary.itin_id;
    const cc = (id.split('::')[0] || '').toUpperCase();

    const url = new URL('roadtrip_detail_simple.html', location.href);
    url.searchParams.set('cc', cc);
    url.searchParams.set('itin', id);
    url.searchParams.set('lang', lang);
    url.searchParams.set('mode', 'simple');
    url.searchParams.set('budget', budget);
    url.searchParams.set('depart', departDate);
    url.searchParams.set('days', nbDays);

    window.location.href = url.toString();
  });
}

// Fix viewport height iOS Safari
function setVhVar() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
window.addEventListener('resize', setVhVar);
window.addEventListener('orientationchange', setVhVar);
setVhVar();

// √âTAPE 3: Fermer tous les overlays au chargement et changement orientation
if (typeof hardCloseOverlays === 'function') {
  document.addEventListener('DOMContentLoaded', hardCloseOverlays);
  window.addEventListener('orientationchange', () => {
    if (isMobile()) hardCloseOverlays();
  });
}
</script>

<!-- Footer ORT -->
<footer id="footer-legal"></footer>

<!-- Scripts ORT modulaires -->
<script src="js/ort-config.js"></script>
<script src="js/ort-i18n-auth.js"></script>
<script src="js/ort-header.js"></script>
<script src="js/ort-footer.js"></script>

</body>
</html>