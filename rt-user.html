<!DOCTYPE html>
<html lang="fr">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JK3QGQGDDL"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-JK3QGQGDDL');gtag('config','GT-WF83FMCX');</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OneRoadTrip - Mes photos et r√©servations</title>
<style>
:root{--bg:#113f7a;--card:#fff;--ink:#113f7a;--bd:#c3d6b6;--mut:#6b7a99}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(rgba(17,63,122,0.85),rgba(17,63,122,0.85)),url("/assets/image_index.webp") center/cover fixed;background-color:#113f7a;color:#fff;font-family:system-ui,sans-serif;min-height:100vh}
header{background:rgba(17,63,122,0.95);border-bottom:2px solid rgba(255,255,255,0.2);padding:12px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100}
.brandlink{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
.brandlink img{width:36px;height:36px}
.brand{font-weight:800;font-size:1.1rem}
header .sp{flex:1}
.hdr-btn{padding:8px 14px;border-radius:8px;border:1px solid #fff;background:transparent;color:#fff;cursor:pointer;font-weight:600;transition:all .2s}
.hdr-btn:hover{background:rgba(255,255,255,0.15)}
.wrap{max-width:900px;margin:0 auto;padding:20px 16px}
h1{margin:0 0 8px;font-size:1.5rem;text-align:center}
.subtitle{text-align:center;opacity:0.8;margin-bottom:24px}

/* Carrousel */
.carousel-nav{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px}
.carousel-btn{width:44px;height:44px;border-radius:50%;border:2px solid #fff;background:rgba(255,255,255,0.1);color:#fff;font-size:20px;cursor:pointer;transition:all .2s}
.carousel-btn:hover{background:rgba(255,255,255,0.25)}
.carousel-btn:disabled{opacity:0.3;cursor:not-allowed}
.carousel-indicator{font-size:1.1rem;font-weight:700;min-width:120px;text-align:center}
.carousel-dots{display:flex;gap:8px;justify-content:center;margin-top:12px}
.carousel-dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.3);cursor:pointer;transition:all .2s}
.carousel-dot.active{background:#fff;transform:scale(1.2)}

/* Step card */
.step-card{background:var(--card);color:var(--ink);border-radius:16px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.2)}
.step-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #e5e7eb}
.step-num{width:40px;height:40px;background:var(--bg);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.1rem}
.step-title{font-size:1.2rem;font-weight:700;flex:1}
.step-date{font-size:0.85rem;color:var(--mut)}

/* Sections */
.section{margin-bottom:20px}
.section-title{font-size:0.95rem;font-weight:700;color:var(--ink);margin-bottom:12px;display:flex;align-items:center;gap:8px}

/* Photos */
.photos-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.photo-slot{aspect-ratio:4/3;border:2px dashed #cbd5e1;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;overflow:hidden;position:relative;background:#f8fafc}
.photo-slot:hover{border-color:var(--bg);background:#eff6ff}
.photo-slot.has-photo{border-style:solid;border-color:#22c55e}
.photo-slot img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
.photo-slot .placeholder{text-align:center;padding:8px}
.photo-slot .placeholder-icon{font-size:1.5rem;margin-bottom:4px}
.photo-slot .placeholder-text{font-size:0.75rem;color:var(--mut)}
.photo-slot .remove-btn{position:absolute;top:4px;right:4px;width:24px;height:24px;background:rgba(220,38,38,0.9);color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:14px;display:none;align-items:center;justify-content:center}
.photo-slot.has-photo:hover .remove-btn{display:flex}

/* URL Input Modal */
.url-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
.url-modal.show{display:flex}
.url-modal-box{background:#fff;border-radius:12px;padding:20px;max-width:450px;width:100%;color:var(--ink)}
.url-modal-title{font-size:1.1rem;font-weight:700;margin-bottom:12px}
.url-input{width:100%;padding:10px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;margin-bottom:8px}
.url-input:focus{outline:none;border-color:var(--bg)}
.url-preview{width:100%;height:120px;background:#f1f5f9;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.url-preview img{max-width:100%;max-height:100%;object-fit:contain}
.url-preview .loading{color:var(--mut)}
.url-error{color:#dc2626;font-size:0.85rem;margin-bottom:8px;display:none}
.url-error.show{display:block}
.url-actions{display:flex;gap:8px;justify-content:flex-end}
.btn{padding:10px 18px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:all .2s}
.btn-primary{background:var(--bg);color:#fff}
.btn-primary:hover{background:#0d3166}
.btn-secondary{background:#e5e7eb;color:var(--ink)}
.btn-secondary:hover{background:#d1d5db}

/* R√©servations */
.resas-list{display:flex;flex-direction:column;gap:10px}
.resa-item{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:12px;display:flex;align-items:center;gap:12px}
.resa-icon{font-size:1.5rem}
.resa-info{flex:1}
.resa-name{font-weight:600;font-size:0.95rem}
.resa-details{font-size:0.8rem;color:var(--mut)}
.resa-remove{width:28px;height:28px;background:#fee2e2;color:#dc2626;border:none;border-radius:6px;cursor:pointer;font-size:14px}
.btn-add-resa{width:100%;padding:12px;border:2px dashed #cbd5e1;border-radius:10px;background:transparent;color:var(--ink);cursor:pointer;font-weight:600;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-add-resa:hover{border-color:var(--bg);background:#eff6ff}

/* Section voyage */
.travel-section{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);border-radius:12px;padding:16px;margin-bottom:20px}
.travel-section .section-title{color:#92400e;margin-bottom:4px}
.travel-hint{font-size:0.8rem;color:#a16207;margin-bottom:12px}
.btn-add-travel{border-color:#d97706;color:#92400e}
.btn-add-travel:hover{background:#fef3c7;border-color:#b45309}

/* Footer actions */
.footer-actions{position:sticky;bottom:0;background:rgba(17,63,122,0.95);backdrop-filter:blur(8px);padding:16px;margin:20px -16px -20px;display:flex;gap:12px;justify-content:center;border-top:2px solid rgba(255,255,255,0.2)}
.btn-save{padding:14px 32px;background:#22c55e;color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s}
.btn-save:hover{background:#16a34a}
.btn-save:disabled{background:#9ca3af;cursor:not-allowed}
.btn-back{padding:14px 24px;background:transparent;color:#fff;border:2px solid #fff;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer}
.btn-back:hover{background:rgba(255,255,255,0.1)}

/* Toast */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#22c55e;color:#fff;padding:12px 24px;border-radius:8px;font-weight:600;z-index:2000;display:none}
.toast.show{display:block}
.toast.error{background:#dc2626}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:rgba(17,63,122,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000}
.loading-spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;font-size:1.1rem}

/* Mobile */
@media(max-width:600px){
  .photos-grid{grid-template-columns:repeat(2,1fr)}
  .carousel-btn{width:36px;height:36px;font-size:16px}
}
</style>
</head>
<body>

<header>
  <a href="index.html" class="brandlink">
    <img src="../assets/symbol.webp" alt="Logo">
    <span class="brand">OneRoadTrip</span>
  </a>
  <span class="sp"></span>
  <button class="hdr-btn" id="btnBackToTrip">‚Üê <span data-i18n="backToTrip">Retour</span></button>
</header>

<div class="wrap">
  <h1 id="pageTitle" data-i18n="userPageTitle">Mes photos et r√©servations</h1>
  <p class="subtitle" id="tripName"></p>
  
  <!-- R√©sas de voyage (globales) -->
  <div class="travel-section" id="travelSection">
    <div class="section-title">üß≥ <span data-i18n="travelBookings">R√©servations de voyage</span></div>
    <div class="travel-hint" data-i18n="travelHint">Avion, voiture, assurance...</div>
    <div class="resas-list" id="travelResasList"></div>
    <button class="btn-add-resa btn-add-travel" id="btnAddTravel">
      <span>+</span> <span data-i18n="addTravelBooking">Ajouter (avion, voiture...)</span>
    </button>
  </div>
  
  <!-- Carrousel navigation -->
  <div class="carousel-nav">
    <button class="carousel-btn" id="btnPrev">‚Äπ</button>
    <div class="carousel-indicator">
      <span id="currentDay">Jour 1</span> / <span id="totalDays">1</span>
    </div>
    <button class="carousel-btn" id="btnNext">‚Ä∫</button>
  </div>
  <div class="carousel-dots" id="carouselDots"></div>
  
  <!-- Step card -->
  <div class="step-card" id="stepCard">
    <div class="step-header">
      <div class="step-num" id="stepNum">1</div>
      <div class="step-title" id="stepTitle">Chargement...</div>
      <div class="step-date" id="stepDate"></div>
    </div>
    
    <!-- R√©servations section -->
    <div class="section">
      <div class="section-title">üìã <span data-i18n="myBookings">Mes r√©servations</span></div>
      <div class="resas-list" id="resasList"></div>
      <button class="btn-add-resa" id="btnAddResa">
        <span>+</span> <span data-i18n="addBooking">Ajouter une r√©servation</span>
      </button>
    </div>
    
    <!-- Photos section -->
    <div class="section">
      <div class="section-title">üì∑ <span data-i18n="myPhotos">Mes photos</span></div>
      <div class="photos-grid" id="photosGrid">
        <div class="photo-slot" data-index="0">
          <div class="placeholder">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text" data-i18n="addPhoto">Ajouter</div>
          </div>
          <button class="remove-btn">√ó</button>
        </div>
        <div class="photo-slot" data-index="1">
          <div class="placeholder">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text" data-i18n="addPhoto">Ajouter</div>
          </div>
          <button class="remove-btn">√ó</button>
        </div>
        <div class="photo-slot" data-index="2">
          <div class="placeholder">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text" data-i18n="addPhoto">Ajouter</div>
          </div>
          <button class="remove-btn">√ó</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer actions -->
  <div class="footer-actions">
    <button class="btn-back" id="btnCancel" data-i18n="cancel">Annuler</button>
    <button class="btn-save" id="btnSave">üíæ <span data-i18n="saveAll">Enregistrer tout</span></button>
  </div>
</div>

<!-- URL Modal -->
<div class="url-modal" id="urlModal">
  <div class="url-modal-box">
    <div class="url-modal-title" data-i18n="enterPhotoUrl">Entrez l'URL de la photo</div>
    <input type="url" class="url-input" id="urlInput" placeholder="https://...">
    <div class="url-preview" id="urlPreview">
      <span class="loading" data-i18n="previewHere">Aper√ßu ici</span>
    </div>
    <div class="url-error" id="urlError" data-i18n="invalidUrl">URL invalide ou image inaccessible</div>
    <div class="url-actions">
      <button class="btn btn-secondary" id="urlCancel" data-i18n="cancel">Annuler</button>
      <button class="btn btn-primary" id="urlConfirm" data-i18n="add">Ajouter</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" data-i18n="loading">Chargement...</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="/js/ort-config.js"></script>
<script src="/js/ort-i18n.js"></script>
<script>
// Init Firebase depuis ORT_CONFIG
(function(){
  const host = location.hostname;
  const isPreprod = /oneroadtrip-preprod|localhost|127\.0\.0\.1|0\.0\.0\.0/.test(host);
  const cfg = isPreprod ? (window.ORT_CONFIG?.PREPROD || {}) : (window.ORT_CONFIG?.PROD || {});
  const safe = (cfg && cfg.apiKey) ? cfg : (window.ORT_CONFIG?.PREPROD || {});
  if (safe && safe.apiKey && !firebase.apps.length) {
    firebase.initializeApp(safe);
    console.log('[RT-USER] Firebase initialis√©');
  }
})();
</script>

<!-- I18N -->
<script>
const I18N = {
  userPageTitle: { fr: 'Mes photos et r√©servations', en: 'My photos and bookings', es: 'Mis fotos y reservas', it: 'Le mie foto e prenotazioni', pt: 'Minhas fotos e reservas', ar: 'ÿµŸàÿ±Ÿä Ÿàÿ≠ÿ¨Ÿàÿ≤ÿßÿ™Ÿä' },
  backToTrip: { fr: 'Retour', en: 'Back', es: 'Volver', it: 'Indietro', pt: 'Voltar', ar: 'ÿ±ÿ¨Ÿàÿπ' },
  myPhotos: { fr: 'Mes photos', en: 'My photos', es: 'Mis fotos', it: 'Le mie foto', pt: 'Minhas fotos', ar: 'ÿµŸàÿ±Ÿä' },
  myBookings: { fr: 'Mes r√©servations', en: 'My bookings', es: 'Mis reservas', it: 'Le mie prenotazioni', pt: 'Minhas reservas', ar: 'ÿ≠ÿ¨Ÿàÿ≤ÿßÿ™Ÿä' },
  addPhoto: { fr: 'Ajouter', en: 'Add', es: 'A√±adir', it: 'Aggiungi', pt: 'Adicionar', ar: 'ÿ•ÿ∂ÿßŸÅÿ©' },
  addBooking: { fr: 'Ajouter une r√©servation', en: 'Add a booking', es: 'A√±adir una reserva', it: 'Aggiungi una prenotazione', pt: 'Adicionar uma reserva', ar: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿ¨ÿ≤' },
  travelBookings: { fr: 'R√©servations de voyage', en: 'Travel bookings', es: 'Reservas de viaje', it: 'Prenotazioni viaggio', pt: 'Reservas de viagem', ar: 'ÿ≠ÿ¨Ÿàÿ≤ÿßÿ™ ÿßŸÑÿ≥ŸÅÿ±' },
  travelHint: { fr: 'Avion, voiture, assurance...', en: 'Flight, car, insurance...', es: 'Avi√≥n, coche, seguro...', it: 'Aereo, auto, assicurazione...', pt: 'Avi√£o, carro, seguro...', ar: 'ÿ∑Ÿäÿ±ÿßŸÜÿå ÿ≥Ÿäÿßÿ±ÿ©ÿå ÿ™ÿ£ŸÖŸäŸÜ...' },
  addTravelBooking: { fr: 'Ajouter (avion, voiture...)', en: 'Add (flight, car...)', es: 'A√±adir (avi√≥n, coche...)', it: 'Aggiungi (aereo, auto...)', pt: 'Adicionar (avi√£o, carro...)', ar: 'ÿ•ÿ∂ÿßŸÅÿ© (ÿ∑Ÿäÿ±ÿßŸÜÿå ÿ≥Ÿäÿßÿ±ÿ©...)' },
  enterPhotoUrl: { fr: 'Entrez l\'URL de la photo', en: 'Enter photo URL', es: 'Ingrese la URL de la foto', it: 'Inserisci l\'URL della foto', pt: 'Digite a URL da foto', ar: 'ÿ£ÿØÿÆŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©' },
  previewHere: { fr: 'Aper√ßu ici', en: 'Preview here', es: 'Vista previa aqu√≠', it: 'Anteprima qui', pt: 'Visualiza√ß√£o aqui', ar: 'ŸÖÿπÿßŸäŸÜÿ© ŸáŸÜÿß' },
  invalidUrl: { fr: 'URL invalide ou image inaccessible', en: 'Invalid URL or image not accessible', es: 'URL inv√°lida o imagen inaccesible', it: 'URL non valido o immagine non accessibile', pt: 'URL inv√°lida ou imagem inacess√≠vel', ar: 'ÿ±ÿßÿ®ÿ∑ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ÿµŸàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ©' },
  cancel: { fr: 'Annuler', en: 'Cancel', es: 'Cancelar', it: 'Annulla', pt: 'Cancelar', ar: 'ÿ•ŸÑÿ∫ÿßÿ°' },
  add: { fr: 'Ajouter', en: 'Add', es: 'A√±adir', it: 'Aggiungi', pt: 'Adicionar', ar: 'ÿ•ÿ∂ÿßŸÅÿ©' },
  saveAll: { fr: 'Enregistrer tout', en: 'Save all', es: 'Guardar todo', it: 'Salva tutto', pt: 'Salvar tudo', ar: 'ÿ≠ŸÅÿ∏ ÿßŸÑŸÉŸÑ' },
  loading: { fr: 'Chargement...', en: 'Loading...', es: 'Cargando...', it: 'Caricamento...', pt: 'Carregando...', ar: 'ÿ¨ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...' },
  saving: { fr: 'Enregistrement...', en: 'Saving...', es: 'Guardando...', it: 'Salvataggio...', pt: 'Salvando...', ar: 'ÿ¨ÿßÿ± ÿßŸÑÿ≠ŸÅÿ∏...' },
  saved: { fr: 'Enregistr√© !', en: 'Saved!', es: '¬°Guardado!', it: 'Salvato!', pt: 'Salvo!', ar: 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏!' },
  errorSaving: { fr: 'Erreur lors de l\'enregistrement', en: 'Error saving', es: 'Error al guardar', it: 'Errore durante il salvataggio', pt: 'Erro ao salvar', ar: 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏' },
  loginRequired: { fr: 'Connexion requise', en: 'Login required', es: 'Inicio de sesi√≥n requerido', it: 'Accesso richiesto', pt: 'Login necess√°rio', ar: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ∑ŸÑŸàÿ®' },
  savedLocal: { fr: 'Enregistr√© localement ‚úì', en: 'Saved locally ‚úì', es: 'Guardado localmente ‚úì', it: 'Salvato localmente ‚úì', pt: 'Salvo localmente ‚úì', ar: 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäŸãÿß ‚úì' },
  cloudReminder: { fr: 'Pour retrouver vos photos et r√©servations sur un autre appareil, sauvegardez votre voyage dans le cloud via le Dashboard.', en: 'To access your photos and bookings on another device, save your trip to the cloud via the Dashboard.', es: 'Para acceder a sus fotos y reservas en otro dispositivo, guarde su viaje en la nube desde el Dashboard.', it: 'Per ritrovare foto e prenotazioni su un altro dispositivo, salva il viaggio nel cloud dal Dashboard.', pt: 'Para acessar suas fotos e reservas em outro dispositivo, salve sua viagem na nuvem pelo Dashboard.', ar: 'ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿµŸàÿ±ŸÉ Ÿàÿ≠ÿ¨Ÿàÿ≤ÿßÿ™ŸÉ ÿπŸÑŸâ ÿ¨Ÿáÿßÿ≤ ÿ¢ÿÆÿ±ÿå ÿßÿ≠ŸÅÿ∏ ÿ±ÿ≠ŸÑÿ™ŸÉ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿπÿ®ÿ± ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ.' },
  day: { fr: 'Jour', en: 'Day', es: 'D√≠a', it: 'Giorno', pt: 'Dia', ar: 'ŸäŸàŸÖ' },
  maxBookings: { fr: 'Limite de 30 r√©servations atteinte', en: 'Maximum 30 bookings reached', es: 'L√≠mite de 30 reservas alcanzado', it: 'Limite di 30 prenotazioni raggiunto', pt: 'Limite de 30 reservas atingido', ar: 'ÿ™ŸÖ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 30 ÿ≠ÿ¨ÿ≤Ÿãÿß' },
  noTrip: { fr: 'Voyage non trouv√©', en: 'Trip not found', es: 'Viaje no encontrado', it: 'Viaggio non trovato', pt: 'Viagem n√£o encontrada', ar: 'ÿßŸÑÿ±ÿ≠ŸÑÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©' },
  noSteps: { fr: 'Retournez sur la page du roadtrip et cliquez √† nouveau sur le bouton', en: 'Go back to the roadtrip page and click the button again', es: 'Vuelva a la p√°gina del roadtrip y haga clic en el bot√≥n de nuevo', it: 'Torna alla pagina del roadtrip e clicca di nuovo sul pulsante', pt: 'Volte √† p√°gina do roadtrip e clique no bot√£o novamente', ar: 'ÿπÿØ ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ≠ŸÑÿ© ŸàÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿ≤ÿ± ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ' }
};

let lang = localStorage.getItem('ort_lang') || navigator.language?.slice(0,2) || 'fr';
if (!['fr','en','es','it','pt','ar'].includes(lang)) lang = 'en';

function t(key) { return I18N[key]?.[lang] || I18N[key]?.fr || key; }

function applyI18N() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (I18N[key]) el.textContent = t(key);
  });
}
</script>

<!-- AI Parser -->
<script src="/js/ort-ai-parser.js"></script>

<!-- ORT Trip Data - Donn√©es centralis√©es -->
<script src="/js/ort-trip-data.js"></script>

<!-- Main Script -->
<script>
(async function() {
  'use strict';
  
  const CATEGORIES = {
    flight: '‚úàÔ∏è', car_rental: 'üöó', insurance: 'üõ°Ô∏è', hotel: 'üè®',
    activity: 'üéØ', visit: 'üèõÔ∏è', show: 'üé≠'
  };
  
  // State
  const params = new URLSearchParams(location.search);
  let tripId = params.get('id');
  let cc = params.get('cc');
  let itin = params.get('itin');
  
  console.log('[RT-USER] Params:', { tripId, cc, itin });
  
  let trip = null;
  let currentStep = 0;
  // userData remplac√© par ORT_TRIP_DATA (centralis√© dans le trip)
  let hasChanges = false;
  
  // DOM
  const $ = id => document.getElementById(id);
  const loadingOverlay = $('loadingOverlay');
  const stepCard = $('stepCard');
  const photosGrid = $('photosGrid');
  const resasList = $('resasList');
  const urlModal = $('urlModal');
  const toast = $('toast');
  
  // Init
  async function init() {
    console.log('[RT-USER] Init...');
    
    // Debug: lister toutes les cl√©s ort_trip_ dans localStorage
    const tripKeys = Object.keys(localStorage).filter(k => k.startsWith('ort_trip_'));
    console.log('[RT-USER] Cl√©s ort_trip_ dans localStorage:', tripKeys);
    
    applyI18N();
    
    if (!tripId && !itin) {
      console.error('[RT-USER] Pas de tripId ni itin');
      showToast(t('noTrip'), 'error');
      loadingOverlay.style.display = 'none';
      return;
    }
    
    // Wait for Firebase
    console.log('[RT-USER] Attente Firebase...');
    const user = await waitForAuth();
    console.log('[RT-USER] Firebase OK');
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // V√âRIFICATION 1 : Utilisateur connect√© ?
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (!user) {
      console.warn('[RT-USER] ‚ùå Utilisateur non connect√©');
      showBlockingMessage('login');
      return;
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // V√âRIFICATION 2 : Voyage sauvegard√© dans Firestore ?
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const tripSaved = await checkTripSavedInFirestore(user.uid, tripId);
    if (!tripSaved) {
      console.warn('[RT-USER] ‚ùå Voyage non sauvegard√© dans Firestore');
      showBlockingMessage('tripNotSaved');
      return;
    }
    
    // Load trip
    console.log('[RT-USER] Chargement trip...');
    await loadTrip();
    console.log('[RT-USER] Trip charg√©:', trip ? trip.title : 'NULL', 'steps:', trip?.steps?.length);
    
    // Si pas de steps, afficher un message
    if (!trip?.steps?.length) {
      console.error('[RT-USER] ‚ö†Ô∏è Aucune √©tape trouv√©e !');
      $('stepTitle').textContent = trip?.title || t('noTrip');
      $('stepDate').textContent = t('noSteps');
      loadingOverlay.style.display = 'none';
      return;
    }
    
    // Load user data
    await loadUserData();
    
    // Setup UI
    setupCarousel();
    renderStep();
    renderTravelBookings();
    setupEventListeners();
    
    loadingOverlay.style.display = 'none';
  }
  
  async function waitForAuth() {
    return new Promise(resolve => {
      const check = () => {
        if (window.firebase?.auth) {
          firebase.auth().onAuthStateChanged(user => {
            console.log('[RT-USER] Auth state:', user ? user.email : 'non connect√©');
            resolve(user);
          });
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    });
  }
  
  /**
   * V√©rifie si le voyage est sauvegard√© dans Firestore
   */
  async function checkTripSavedInFirestore(uid, tripId) {
    if (!uid || !tripId) return false;
    
    try {
      const db = firebase.firestore();
      const tripDoc = await db.collection('users').doc(uid).collection('trips').doc(tripId).get();
      const exists = tripDoc.exists;
      console.log('[RT-USER] Trip dans Firestore?', exists);
      return exists;
    } catch (e) {
      console.error('[RT-USER] Erreur v√©rification Firestore:', e);
      return false;
    }
  }
  
  /**
   * Affiche un message bloquant si conditions non remplies
   */
  function showBlockingMessage(type) {
    loadingOverlay.style.display = 'none';
    
    const lang = localStorage.getItem('lang')?.slice(0, 2) || 'fr';
    const i18n = window.ORT_I18N || {};
    
    const getText = (key) => i18n[key]?.[lang] || i18n[key]?.fr || key;
    
    let title, message, btnText, btnAction;
    
    if (type === 'login') {
      title = getText('loginRequired');
      message = getText('loginRequiredMsg');
      btnText = getText('goToLogin');
      btnAction = () => {
        // Retour √† RT Detail qui a le bouton de connexion
        window.history.back();
      };
    } else if (type === 'tripNotSaved') {
      title = getText('tripSaveRequired');
      message = getText('tripSaveRequiredMsg');
      btnText = getText('goBack');
      btnAction = () => {
        window.history.back();
      };
    }
    
    // Cr√©er le message bloquant
    const container = document.createElement('div');
    container.id = 'blockingMessage';
    container.style.cssText = `
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      text-align: center;
    `;
    
    container.innerHTML = `
      <div style="background: white; border-radius: 16px; padding: 32px; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>
        <h2 style="color: #1e3a5f; margin: 0 0 12px 0; font-size: 1.4rem;">${title}</h2>
        <p style="color: #64748b; margin: 0 0 24px 0; line-height: 1.5;">${message}</p>
        <button id="blockingBtn" style="
          background: #3b82f6;
          color: white;
          border: none;
          padding: 12px 32px;
          border-radius: 8px;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          transition: background 0.2s;
        ">${btnText}</button>
      </div>
    `;
    
    document.body.appendChild(container);
    document.getElementById('blockingBtn').addEventListener('click', btnAction);
  }
  
  async function loadTrip() {
    const user = firebase.auth().currentUser;
    
    // 1. Try localStorage FIRST (stock√© par RT DETAIL avec steps enrichis)
    if (tripId) {
      const lsKey = `ort_trip_${tripId}`;
      console.log('[RT-USER] Essai localStorage cl√©:', lsKey);
      const saved = localStorage.getItem(lsKey);
      console.log('[RT-USER] localStorage trouv√©?', !!saved, saved ? saved.length + ' chars' : '');
      if (saved) {
        try {
          trip = JSON.parse(saved);
          console.log('[RT-USER] ‚úÖ Trip charg√© depuis localStorage, steps:', trip.steps?.length);
          $('tripName').textContent = trip.title || '';
          if (trip.steps?.length) return; // OK si steps pr√©sents
        } catch (e) { console.warn('[RT-USER] Parse localStorage failed:', e); }
      }
    }
    
    // 2. Try Firestore (fallback si pas de steps en local)
    if (user && tripId) {
      console.log('[RT-USER] Essai Firestore:', tripId);
      try {
        const doc = await firebase.firestore()
          .collection('users').doc(user.uid)
          .collection('trips').doc(tripId).get();
        if (doc.exists) {
          const fsData = doc.data();
          // Fusionner: garder steps de localStorage si pr√©sents
          trip = { ...fsData, steps: trip?.steps || fsData.steps };
          $('tripName').textContent = trip.title || '';
          console.log('[RT-USER] ‚úÖ Trip Firestore, steps:', trip.steps?.length);
          if (trip.steps?.length) return;
        }
      } catch (e) { console.warn('[RT-USER] Firestore failed:', e); }
    }
    
    // 3. Load from JSON using cc/itin
    if (cc && itin) {
      // Parse itin to get the JSON filename
      // itin format: "FR::58::nievre" -> need to load FR.itins.modules-fr.json
      const itinParts = itin.split('::');
      const jsonPath = `/data/Roadtripsprefabriques/countries/${cc.toLowerCase()}/${cc}.itins.modules-${lang}.json`;
      console.log('[RT-USER] Essai JSON:', jsonPath, 'itin:', itin);
      
      try {
        const res = await fetch(jsonPath);
        if (res.ok) {
          const data = await res.json();
          console.log('[RT-USER] JSON charg√©, recherche itin:', itin);
          
          // Find the itinerary in the data
          // The data structure has itineraries array
          if (data.itineraries) {
            const found = data.itineraries.find(it => it.id === itin || it.slug === itin);
            if (found) {
              trip = found;
              console.log('[RT-USER] Structure found:', Object.keys(found));
              console.log('[RT-USER] days_plan?', !!found.days_plan, Array.isArray(found.days_plan), found.days_plan?.length);
              console.log('[RT-USER] places?', !!found.places, Array.isArray(found.places), found.places?.length);
              console.log('[RT-USER] steps?', !!found.steps, Array.isArray(found.steps), found.steps?.length);
              console.log('[RT-USER] First 3 keys of found:', JSON.stringify(Object.keys(found).slice(0,10)));
              
              // Map days_plan ou places ‚Üí steps
              if (!found.steps) {
                if (Array.isArray(found.days_plan) && found.days_plan.length) {
                  console.log('[RT-USER] Mapping days_plan ‚Üí steps');
                  trip.steps = found.days_plan.map(d => ({
                    name: d.night?.place_id?.split('::')[1]?.replace(/-/g,' ') || d.name || '',
                    place_id: d.night?.place_id || '',
                    lat: d.night?.coords?.[0],
                    lon: d.night?.coords?.[1],
                    visits: d.visits || [],
                    activities: d.activities || []
                  }));
                } else if (Array.isArray(found.places) && found.places.length) {
                  console.log('[RT-USER] Mapping places ‚Üí steps');
                  trip.steps = found.places.map(p => ({
                    name: p.name || p.title || '',
                    place_id: p.place_id || p.id || '',
                    lat: p.lat,
                    lon: p.lon,
                    visits: p.visits || [],
                    activities: p.activities || []
                  }));
                } else {
                  console.warn('[RT-USER] ‚ö†Ô∏è Ni days_plan ni places trouv√© !');
                }
              }
              $('tripName').textContent = trip.title || trip.name || '';
              console.log('[RT-USER] ‚úÖ Trip trouv√© dans itineraries:', trip.title, 'steps:', trip.steps?.length);
              return;
            }
          }
          
          // Maybe the data itself is the itinerary
          if (data.steps) {
            trip = data;
            $('tripName').textContent = trip.title || '';
            console.log('[RT-USER] ‚úÖ Trip = data directe');
            return;
          }
          
          console.warn('[RT-USER] Itin non trouv√© dans le JSON');
        }
      } catch (e) { console.warn('[RT-USER] JSON load failed:', e); }
    }
    
    // 4. Fallback: try direct itin JSON
    if (itin) {
      const directPath = `/data/Roadtripsprefabriques/countries/${cc?.toLowerCase() || 'fr'}/${itin.replace(/::/g, '-')}.json`;
      console.log('[RT-USER] Essai JSON direct:', directPath);
      try {
        const res = await fetch(directPath);
        if (res.ok) {
          trip = await res.json();
          $('tripName').textContent = trip.title || '';
          console.log('[RT-USER] ‚úÖ Trip charg√© depuis JSON direct');
          return;
        }
      } catch (e) { console.warn('[RT-USER] Direct JSON failed:', e); }
    }
    
    console.error('[RT-USER] ‚ùå Trip non trouv√© nulle part');
  }
  
  async function loadUserData() {
    // Charge les donn√©es via ORT_TRIP_DATA (qui migre auto les anciennes donn√©es)
    if (window.ORT_TRIP_DATA && tripId) {
      await ORT_TRIP_DATA.loadTrip(tripId);
      const stats = ORT_TRIP_DATA.getStats();
      console.log('[RT-USER] Donn√©es charg√©es via ORT_TRIP_DATA:', stats);
    } else {
      console.warn('[RT-USER] ORT_TRIP_DATA non disponible, fallback ancien syst√®me');
      // Fallback ancien syst√®me (sera migr√© au prochain chargement)
      const user = firebase.auth().currentUser;
      const localKey = `ort_user_content_${user?.uid || 'anon'}_${tripId}`;
      try {
        const local = localStorage.getItem(localKey);
        if (local) {
          console.log('[RT-USER] Donn√©es localStorage trouv√©es (seront migr√©es)');
        }
      } catch (e) { console.warn('localStorage parse failed:', e); }
    }
  }
  
  async function saveUserData() {
    // Sauvegarde via ORT_TRIP_DATA (Firestore si connect√©, sinon localStorage)
    if (window.ORT_TRIP_DATA) {
      const success = await ORT_TRIP_DATA.forceSave();
      if (success) {
        hasChanges = false;
        showToast(t('saved'));
        return true;
      } else {
        showToast(t('errorSaving') || 'Erreur sauvegarde', 'error');
        return false;
      }
    }
    
    // Fallback ancien syst√®me
    const user = firebase.auth().currentUser;
    const localKey = `ort_user_content_${user?.uid || 'anon'}_${tripId}`;
    localStorage.setItem(localKey, JSON.stringify({}));
    console.log('[RT-USER] Sauvegard√© localStorage (fallback):', localKey);
    hasChanges = false;
    showToast(t('savedLocal'));
    return true;
  }
  
  // Carousel
  function setupCarousel() {
    const totalSteps = trip?.steps?.length || 1;
    $('totalDays').textContent = totalSteps;
    
    // Dots
    const dotsContainer = $('carouselDots');
    dotsContainer.innerHTML = '';
    for (let i = 0; i < totalSteps; i++) {
      const dot = document.createElement('div');
      dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
      dot.addEventListener('click', () => goToStep(i));
      dotsContainer.appendChild(dot);
    }
    
    updateNavButtons();
  }
  
  function updateNavButtons() {
    const total = trip?.steps?.length || 1;
    $('btnPrev').disabled = currentStep === 0;
    $('btnNext').disabled = currentStep >= total - 1;
    $('currentDay').textContent = `${t('day')} ${currentStep + 1}`;
    
    // Update dots
    document.querySelectorAll('.carousel-dot').forEach((dot, i) => {
      dot.classList.toggle('active', i === currentStep);
    });
  }
  
  function goToStep(index) {
    const total = trip?.steps?.length || 1;
    if (index < 0 || index >= total) return;
    currentStep = index;
    updateNavButtons();
    renderStep();
  }
  
  // Render
  function renderStep() {
    const step = trip?.steps?.[currentStep];
    if (!step) return;
    
    $('stepNum').textContent = currentStep + 1;
    $('stepTitle').textContent = step.name || step.location || `${t('day')} ${currentStep + 1}`;
    $('stepDate').textContent = step.date || '';
    
    renderPhotos();
    renderBookings();
  }
  
  function renderPhotos() {
    // Via ORT_TRIP_DATA
    const photos = window.ORT_TRIP_DATA ? ORT_TRIP_DATA.getStepPhotos(currentStep) : [];
    
    const slots = photosGrid.querySelectorAll('.photo-slot');
    slots.forEach((slot, i) => {
      const photo = photos[i];
      const placeholder = slot.querySelector('.placeholder');
      let img = slot.querySelector('img');
      
      if (photo) {
        if (!img) {
          img = document.createElement('img');
          slot.appendChild(img);
        }
        img.src = photo;
        img.alt = `Photo ${i + 1}`;
        slot.classList.add('has-photo');
        placeholder.style.display = 'none';
      } else {
        if (img) img.remove();
        slot.classList.remove('has-photo');
        placeholder.style.display = '';
      }
    });
  }
  
  function renderBookings() {
    // Via ORT_TRIP_DATA
    const bookings = window.ORT_TRIP_DATA ? ORT_TRIP_DATA.getStepBookings(currentStep) : [];
    
    resasList.innerHTML = '';
    bookings.forEach((booking, i) => {
      const item = document.createElement('div');
      item.className = 'resa-item';
      item.innerHTML = `
        <span class="resa-icon">${CATEGORIES[booking.category] || 'üìã'}</span>
        <div class="resa-info">
          <div class="resa-name">${booking.name || 'R√©servation'}</div>
          <div class="resa-details">${booking.date_start || ''} ${booking.city ? '‚Ä¢ ' + booking.city : ''}</div>
        </div>
        <button class="resa-remove" data-id="${booking.id || ''}" data-index="${i}">√ó</button>
      `;
      resasList.appendChild(item);
    });
  }
  
  // Event Listeners
  function setupEventListeners() {
    // Navigation
    $('btnPrev').addEventListener('click', () => goToStep(currentStep - 1));
    $('btnNext').addEventListener('click', () => goToStep(currentStep + 1));
    
    // Back buttons
    const goBack = () => {
      // V√©rifie s'il y a des changements non sauvegard√©s
      const hasPending = window.ORT_TRIP_DATA ? ORT_TRIP_DATA.hasPendingChanges() : hasChanges;
      if (hasPending && !confirm(t('unsavedChanges') + '. ' + t('cancel') + ' ?')) return;
      // URL propre : tripId seulement si cc/itin sont null
      if (cc && cc !== 'null' && itin && itin !== 'null') {
        location.href = `roadtrip_detail.html?cc=${cc}&itin=${itin}&lang=${lang}`;
      } else {
        location.href = `roadtrip_detail.html?tripId=${tripId}&lang=${lang}`;
      }
    };
    $('btnBackToTrip').addEventListener('click', goBack);
    $('btnCancel').addEventListener('click', goBack);
    
    // Save
    $('btnSave').addEventListener('click', saveUserData);
    
    // Photo slots
    photosGrid.addEventListener('click', e => {
      const slot = e.target.closest('.photo-slot');
      if (!slot) return;
      
      const index = parseInt(slot.dataset.index);
      
      // Remove button clicked
      if (e.target.classList.contains('remove-btn')) {
        removePhoto(index);
        return;
      }
      
      // Open URL modal
      openUrlModal(index);
    });
    
    // Add booking
    $('btnAddResa').addEventListener('click', () => {
      if (window.ORT_AI_PARSER) {
        ORT_AI_PARSER.show(tripId, `day_${currentStep + 1}`);
      }
    });
    
    // Add travel booking (global)
    $('btnAddTravel').addEventListener('click', () => {
      if (window.ORT_AI_PARSER) {
        ORT_AI_PARSER.show(tripId, 'travel');
      }
    });
    
    // Listen for booking added
    window.addEventListener('ort:booking-added', e => {
      const booking = e.detail;
      // V√©rifier si c'est une r√©sa de voyage (stepId = 'travel')
      if (booking._stepId === 'travel') {
        addTravelBooking(booking);
      } else {
        addBooking(booking);
      }
    });
    
    // Remove booking
    resasList.addEventListener('click', e => {
      if (e.target.classList.contains('resa-remove')) {
        const index = parseInt(e.target.dataset.index);
        removeBooking(index);
      }
    });
    
    // Remove travel booking
    $('travelResasList').addEventListener('click', e => {
      if (e.target.classList.contains('resa-remove')) {
        const index = parseInt(e.target.dataset.index);
        removeTravelBooking(index);
      }
    });
    
    // URL Modal
    $('urlCancel').addEventListener('click', closeUrlModal);
    $('urlModal').addEventListener('click', e => {
      if (e.target === urlModal) closeUrlModal();
    });
    $('urlInput').addEventListener('input', debounce(previewUrl, 500));
    $('urlConfirm').addEventListener('click', confirmUrl);
  }
  
  // Photo management
  let currentPhotoIndex = 0;
  
  function openUrlModal(index) {
    currentPhotoIndex = index;
    $('urlInput').value = '';
    $('urlPreview').innerHTML = `<span class="loading">${t('previewHere')}</span>`;
    $('urlError').classList.remove('show');
    urlModal.classList.add('show');
    $('urlInput').focus();
  }
  
  function closeUrlModal() {
    urlModal.classList.remove('show');
  }
  
  function previewUrl() {
    const url = $('urlInput').value.trim();
    const preview = $('urlPreview');
    const error = $('urlError');
    
    error.classList.remove('show');
    
    if (!url) {
      preview.innerHTML = `<span class="loading">${t('previewHere')}</span>`;
      return;
    }
    
    preview.innerHTML = `<span class="loading">‚è≥</span>`;
    
    const img = new Image();
    img.onload = () => {
      preview.innerHTML = '';
      preview.appendChild(img);
    };
    img.onerror = () => {
      preview.innerHTML = `<span class="loading">‚ùå</span>`;
      error.classList.add('show');
    };
    img.src = url;
  }
  
  function confirmUrl() {
    const url = $('urlInput').value.trim();
    if (!url) return;
    
    // Verify image loaded
    const img = $('urlPreview').querySelector('img');
    if (!img) {
      $('urlError').classList.add('show');
      return;
    }
    
    addPhoto(currentPhotoIndex, url);
    closeUrlModal();
  }
  
  function addPhoto(index, url) {
    // Via ORT_TRIP_DATA
    if (window.ORT_TRIP_DATA) {
      const success = ORT_TRIP_DATA.addUserPhoto(currentStep, url, index);
      if (success) {
        hasChanges = true;
        renderPhotos();
      }
    }
  }
  
  function removePhoto(index) {
    // Via ORT_TRIP_DATA
    if (window.ORT_TRIP_DATA) {
      ORT_TRIP_DATA.removeUserPhoto(currentStep, index);
      hasChanges = true;
      renderPhotos();
    }
  }
  
  // Booking management
  function addBooking(booking) {
    // Via ORT_TRIP_DATA
    if (window.ORT_TRIP_DATA) {
      const success = ORT_TRIP_DATA.addStepBooking(currentStep, booking);
      if (success) {
        hasChanges = true;
        renderBookings();
      } else {
        showToast(t('maxBookings'), 'error');
      }
    }
  }
  
  function removeBooking(indexOrId) {
    // Via ORT_TRIP_DATA
    if (window.ORT_TRIP_DATA) {
      ORT_TRIP_DATA.removeStepBooking(currentStep, indexOrId);
      hasChanges = true;
      renderBookings();
    }
  }
  
  // Travel booking management (global)
  function addTravelBooking(booking) {
    // Via ORT_TRIP_DATA
    if (window.ORT_TRIP_DATA) {
      const success = ORT_TRIP_DATA.addTravelBooking(booking);
      if (success) {
        hasChanges = true;
        renderTravelBookings();
      } else {
        showToast(t('maxBookings'), 'error');
      }
    }
  }
  
  function removeTravelBooking(indexOrId) {
    // Via ORT_TRIP_DATA
    if (window.ORT_TRIP_DATA) {
      ORT_TRIP_DATA.removeTravelBooking(indexOrId);
      hasChanges = true;
      renderTravelBookings();
    }
  }
  
  function renderTravelBookings() {
    const travelResasList = $('travelResasList');
    // Via ORT_TRIP_DATA
    const bookings = window.ORT_TRIP_DATA ? ORT_TRIP_DATA.getTravelBookings() : [];
    const CATEGORIES = { travel: 'üß≥', flight: '‚úàÔ∏è', car_rental: 'üöó', insurance: 'üõ°Ô∏è', hotel: 'üè®', activity: 'üéØ', visit: 'üèõÔ∏è', show: 'üé≠' };
    
    travelResasList.innerHTML = '';
    bookings.forEach((booking, i) => {
      const item = document.createElement('div');
      item.className = 'resa-item';
      item.innerHTML = `
        <span class="resa-icon">${CATEGORIES[booking.category] || 'üìã'}</span>
        <div class="resa-info">
          <div class="resa-name">${booking.name || 'R√©servation'}</div>
          <div class="resa-details">${booking.date_start || ''} ${booking.city ? '‚Ä¢ ' + booking.city : ''}</div>
        </div>
        <button class="resa-remove" data-id="${booking.id || ''}" data-index="${i}">√ó</button>
      `;
      travelResasList.appendChild(item);
    });
  }
  
  // Utils
  function showToast(msg, type = 'success') {
    toast.textContent = msg;
    toast.className = 'toast show' + (type === 'error' ? ' error' : '');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }
  
  function debounce(fn, ms) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), ms);
    };
  }
  
  // Start
  init();
})();
</script>

<!-- Footer ORT -->
<footer id="footer-legal"></footer>
<script src="/js/ort-footer.js"></script>

</body>
</html>